<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planificador Académico – Matriz Integrada</title>

<!-- SheetJS (XLSX) from CDN -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#0b1220;
    --card:#121a2b;
    --card-2:#0f1727;
    --text:#e6ebff;
    --muted:#9fb0d3;
    --accent:#6ea8fe;
    --ok:#20c997;
    --warn:#ffc107;
    --bad:#ff6b6b;
    --grid:#1f2a44;
  }
  html,body{height:100%;}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;
    background:linear-gradient(180deg,var(--bg),#0a0f1c);
    color:var(--text);
  }
  header{
    position:sticky; top:0; z-index:5;
    background:rgba(11,18,32,.9);
    backdrop-filter: blur(6px);
    border-bottom:1px solid var(--grid);
  }
  .wrap{max-width:1400px; margin:0 auto; padding:16px;}
  h1{margin:0; font-weight:700; letter-spacing:.2px;}
  .muted{color:var(--muted); font-size:.95rem}
  .card{
    background:linear-gradient(180deg,var(--card),var(--card-2));
    border:1px solid var(--grid);
    border-radius:16px;
    padding:16px;
    box-shadow:0 8px 30px rgba(0,0,0,.25);
  }
  .row{display:flex; gap:16px; flex-wrap:wrap;}
  .col{flex:1 1 340px; min-width:300px}
  input[type="file"]{
    appearance:none; background:#0d1322; border:1px dashed var(--grid);
    padding:14px; width:100%; color:var(--text); border-radius:12px;
  }
  button{
    appearance:none; border:1px solid var(--accent); background:transparent;
    color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer;
  }
  button.primary{background:var(--accent); color:#0b1220; border-color:transparent; font-weight:600}
  button:disabled{opacity:.5; cursor:not-allowed}
  .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .pill{display:inline-flex; gap:8px; align-items:center; background:#0d1322; border:1px solid var(--grid); padding:10px 12px; border-radius:999px}
  .grid-wrap{margin-top:18px; border:1px solid var(--grid); border-radius:16px; overflow:auto; background:#0c1323}
  table{width:100%; border-collapse:separate; border-spacing:0; min-width:1400px}
  thead th{
    position:sticky; top:0; z-index:3; background:#0e1426; color:var(--text);
    text-align:left; padding:10px 8px; border-bottom:1px solid var(--grid);
    font-size:.9rem;
  }
  tbody td{
    border-bottom:1px solid #112038; padding:8px; vertical-align:top; font-size:.95rem;
  }
  tbody tr:hover{background:#0d162b;}
  .center-num{ text-align:center; font-variant-numeric: tabular-nums; }
  .badge{padding:2px 8px; border-radius:999px; font-size:.8rem; border:1px solid var(--grid); background:#10203a; color:var(--muted)}
  .ok{background:#0f2d25; color:#8ef1d5; border-color:#164a3d}
  .warn{background:#2c230b; color:#ffe08a; border-color:#4d3b11}
  .bad{background:#311114; color:#ff9ca6; border-color:#4f181d}
  .note{color:var(--muted); font-size:.9rem}
  .right{float:right}
  .small{font-size:.85rem}
  .sticky-footer{position:sticky; bottom:0; z-index:3; background:rgba(11,18,32,.9); border-top:1px solid var(--grid); backdrop-filter: blur(6px);}
  .footer-inner{max-width:1400px; margin:0 auto; padding:12px 16px; display:flex; gap:10px; align-items:center; justify-content:space-between}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#0d1322; border:1px solid var(--grid); padding:2px 6px; border-radius:6px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Matriz integrada: Mallas + Docentes</h1>
      <div class="muted">Carga <span class="kbd">Mallas.xlsx</span> y <span class="kbd">Docentes.xlsx</span>. El sistema combina, crea paralelos y agenda sin choques por ciclos adyacentes (L–V, 7–22 h, 3 h por franja), máx. 2 asignaturas/día por docente.</div>
    </div>
  </header>

  <main class="wrap">
    <div class="row">
      <div class="col">
        <div class="card">
          <h3>1) Cargar archivos</h3>
          <input id="mallas" type="file" accept=".xlsx,.xls" />
          <div class="note small">Se espera columnas típicas: <span class="mono">CARRERA, MALLA, CICLO, MATERIA, CODIGO, CODIGO ANTHOLOGY, HORAS TEÓRICAS, HORAS PRÁCTICAS, HORAS AUTÓNOMAS, CRÉDITOS, CAMPO DE FORMACIÓN, Nº ORDEN EN LA MALLA, PRE-REQUISITO</span>. Los nombres insensibles a mayúsculas.</div>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <h3>2) Cargar Docentes</h3>
          <input id="docentes" type="file" accept=".xlsx,.xls" />
          <div class="note small">Se aprecia (opcional) una hoja con <span class="mono">DOCENTE, TITULO ACADÉMICO, DEDICACIÓN</span> y otra con asignaciones <span class="mono">MATERIA, DOCENTE</span>. Si no existe, se deja sin asignar.</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="controls">
        <span class="pill">Franjas: 7–10, 10–13, 13–16, 16–19, 19–22</span>
        <span class="pill">Máx. 2 asignaturas/día por docente</span>
        <span class="pill">Sin choques entre ciclos adyacentes</span>
        <button id="btnProcesar" class="primary" disabled>Procesar y Agendar</button>
        <button id="btnExport" disabled>Exportar a Excel</button>
        <span class="right note small">Sugerencia: valide columnas y tildes; el emparejamiento de nombres es flexible.</span>
      </div>
      <div class="grid-wrap" id="gridWrap" style="display:none">
        <table id="tabla">
          <thead>
            <tr>
              <th>DOCENTE</th>
              <th>TITULO ACADÉMICO</th>
              <th>DEDICACIÓN</th>
              <th>MATERIA</th>
              <th>CÓDIGO ANTHOLOGY</th>
              <th>CARRERAS QUE COMPARTEN</th>
              <th>MALLA</th>
              <th>PRE-REQUISITO</th>
              <th>CODIGO</th>
              <th>HORAS TEÓRICAS</th>
              <th>HORAS PRÁCTICAS</th>
              <th>HORAS AUTÓNOMAS</th>
              <th>CREDITOS</th>
              <th>CAMPO DE FORMACIÓN</th>
              <th>CICLO MALLA</th>
              <th>Nº ORDEN EN LA MALLA</th>
              <th>PARALELO</th>
              <th>DIA</th>
              <th>HORA</th>
              <th>MODALIDAD</th>
              <th>Nro. HORAS</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <div class="sticky-footer">
    <div class="footer-inner">
      <div class="small muted">Consejo: si una misma asignatura aparece en varias carreras, los códigos/horas/CF/orden se listan por carrera separados con <b>/</b>.</div>
      <div class="small"><span class="kbd">Ctrl</span> + <span class="kbd">S</span> para guardar esta página.</div>
    </div>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const by = (obj, ...ks) => ks.reduce((acc,k)=> (acc && acc[k]!=null)?acc[k]:undefined, obj);

  const estado = {
    mallasRows: [],
    docentesRows: [],
    asignacionesRows: [],
    docentesBase: [],
    resultado: []
  };

  // Normaliza encabezados (quita tildes, espacios, a mayúsculas)
  function norm(s){
    if(!s && s!==0) return "";
    return String(s)
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/\s+/g,' ').trim().toUpperCase();
  }

  // Lee primera hoja a JSON
  async function leerExcel(file){
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, {type:"array"});
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    return XLSX.utils.sheet_to_json(ws, {defval:""});
  }

  // Map flexible de encabezados -> campo canónico
  const MAP_MALLAS = {
    "CARRERA":"CARRERA",
    "PROGRAMA":"CARRERA",
    "MALLA":"MALLA",
    "PLAN":"MALLA",
    "CICLO":"CICLO MALLA",
    "CICLO MALLA":"CICLO MALLA",
    "SEMESTRE":"CICLO MALLA",
    "MATERIA":"MATERIA",
    "ASIGNATURA":"MATERIA",
    "CODIGO":"CODIGO",
    "CÓDIGO":"CODIGO",
    "CODIGO ANTHOLOGY":"CÓDIGO ANTHOLOGY",
    "CÓDIGO ANTHOLOGY":"CÓDIGO ANTHOLOGY",
    "HORAS TEORICAS":"HORAS TEÓRICAS",
    "HORAS TEÓRICAS":"HORAS TEÓRICAS",
    "HORAS PRACTICAS":"HORAS PRÁCTICAS",
    "HORAS PRÁCTICAS":"HORAS PRÁCTICAS",
    "HORAS AUTONOMAS":"HORAS AUTÓNOMAS",
    "HORAS AUTÓNOMAS":"HORAS AUTÓNOMAS",
    "CREDITOS":"CREDITOS",
    "CRÉDITOS":"CREDITOS",
    "CAMPO DE FORMACION":"CAMPO DE FORMACIÓN",
    "CAMPO DE FORMACIÓN":"CAMPO DE FORMACIÓN",
    "Nº ORDEN EN LA MALLA":"Nº ORDEN EN LA MALLA",
    "NRO ORDEN EN LA MALLA":"Nº ORDEN EN LA MALLA",
    "PRE-REQUISITO":"PRE-REQUISITO",
    "PRERREQUISITO":"PRE-REQUISITO",
    "PRERREQUISITOS":"PRE-REQUISITO"
  };

  const MAP_DOC = {
    "DOCENTE":"DOCENTE",
    "NOMBRE DOCENTE":"DOCENTE",
    "TITULO ACADEMICO":"TITULO ACADÉMICO",
    "TÍTULO ACADÉMICO":"TITULO ACADÉMICO",
    "DEDICACION":"DEDICACIÓN",
    "DEDICACIÓN":"DEDICACIÓN",
    "MATERIA":"MATERIA", // en hoja de asignaciones
    "ASIGNATURA":"MATERIA"
  };

  function remapRow(row, MAP){
    const out = {};
    for(const [k,v] of Object.entries(row)){
      const nk = norm(k);
      let mapped = MAP[nk] || MAP[k] || null;
      if(!mapped){
        // intenta coincidencia relajada
        for(const key of Object.keys(MAP)){
          if(nk === norm(key)){ mapped = MAP[key]; break; }
        }
      }
      if(mapped){ out[mapped] = v; }
    }
    return out;
  }

  function combinarMallas(rows){
    // Agrupa por MATERIA a nivel global para armar "compartidas" y concatenar campos por carrera.
    const map = new Map();
    for(const r of rows){
      const clave = norm(r["MATERIA"]);
      if(!clave) continue;
      if(!map.has(clave)){
        map.set(clave, {
          MATERIA: r["MATERIA"],
          carreras: new Set(),
          mallas: new Set(),
          porCarrera: {},
          prereq: new Set()
        });
      }
      const it = map.get(clave);
      const carrera = String(r["CARRERA"]||"").trim();
      const malla = String(r["MALLA"]||"").trim();
      if(carrera) it.carreras.add(carrera);
      if(malla) it.mallas.add(malla);
      const k = carrera || "_";
      if(!it.porCarrera[k]) it.porCarrera[k] = [];
      it.porCarrera[k].push({
        CODIGO: r["CODIGO"]||"",
        "CÓDIGO ANTHOLOGY": r["CÓDIGO ANTHOLOGY"]||"",
        "HORAS TEÓRICAS": r["HORAS TEÓRICAS"]||0,
        "HORAS PRÁCTICAS": r["HORAS PRÁCTICAS"]||0,
        "HORAS AUTÓNOMAS": r["HORAS AUTÓNOMAS"]||0,
        "CREDITOS": r["CREDITOS"]||0,
        "CAMPO DE FORMACIÓN": r["CAMPO DE FORMACIÓN"]||"",
        "CICLO MALLA": r["CICLO MALLA"]||"",
        "Nº ORDEN EN LA MALLA": r["Nº ORDEN EN LA MALLA"]||"",
        "PRE-REQUISITO": r["PRE-REQUISITO"]||""
      });
      const pr = String(r["PRE-REQUISITO"]||"").trim();
      if(pr) it.prereq.add(pr);
    }

    const lista = [];
    for(const it of map.values()){
      // Ensambla campos separados por / según carrera
      const carreras = Array.from(it.carreras);
      const mallas = Array.from(it.mallas);

      // Unir por carrera
      function joinPorCarrera(field){
        const acc = [];
        for(const carrera of carreras){
          const items = by(it,"porCarrera",carrera) || [];
          const vals = items.map(x => x[field]).filter(x => x!=="" && x!=null);
          if(vals.length) acc.push(vals[0]); else acc.push("");
        }
        return acc.filter(v=>v!==undefined).join(" / ");
      }

      const fila = {
        "DOCENTE":"",
        "TITULO ACADÉMICO":"",
        "DEDICACIÓN":"",
        "MATERIA": it.MATERIA,
        "CÓDIGO ANTHOLOGY": joinPorCarrera("CÓDIGO ANTHOLOGY"),
        "CARRERAS QUE COMPARTEN": carreras.join(" / "),
        "MALLA": mallas.join(" / "),
        "PRE-REQUISITO": Array.from(it.prereq).join(" / "),
        "CODIGO": joinPorCarrera("CODIGO"),
        "HORAS TEÓRICAS": joinPorCarrera("HORAS TEÓRICAS"),
        "HORAS PRÁCTICAS": joinPorCarrera("HORAS PRÁCTICAS"),
        "HORAS AUTÓNOMAS": joinPorCarrera("HORAS AUTÓNOMAS"),
        "CREDITOS": joinPorCarrera("CREDITOS"),
        "CAMPO DE FORMACIÓN": joinPorCarrera("CAMPO DE FORMACIÓN"),
        "CICLO MALLA": joinPorCarrera("CICLO MALLA"),
        "Nº ORDEN EN LA MALLA": joinPorCarrera("Nº ORDEN EN LA MALLA"),
        "PARALELO":"P1",
        "DIA":"",
        "HORA":"",
        "MODALIDAD":"",
        "Nro. HORAS":""
      };
      lista.push(fila);
    }
    return lista;
  }

  function indexDocentes(baseRows){
    // Construye índices por nombre y asignaciones materia->docente si existen
    const docentes = [];
    const asignaciones = [];
    for(const r of baseRows){
      const hasDoc = r["DOCENTE"];
      const hasTitulo = r["TITULO ACADÉMICO"] || r["TITULO ACADEMICO"];
      const hasDed = r["DEDICACIÓN"] || r["DEDICACION"];
      const hasMateria = r["MATERIA"];
      const row = remapRow(r, MAP_DOC);
      if(row["DOCENTE"] && (row["TITULO ACADÉMICO"] || row["DEDICACIÓN"])) docentes.push(row);
      else if(hasMateria && hasDoc) asignaciones.push(row);
    }
    return {docentes, asignaciones};
  }

  // Agenda sin choques entre ciclos adyacentes y máx. 2/día por docente
  const DIAS = ["Lunes","Martes","Miércoles","Jueves","Viernes"];
  const FRANJAS = ["7:00–10:00","10:00–13:00","13:00–16:00","16:00–19:00","19:00–22:00"];

  function cicloVec(cicloStr){
    // Convierte "2", "II", "Segundo" a número aproximado si es posible
    const s = norm(cicloStr);
    if(!s) return NaN;
    const roman = {I:1,II:2,III:3,IV:4,V:5,VI:6,VII:7,VIII:8,IX:9,X:10};
    if(roman[s]) return roman[s];
    const mapWord = {"PRIMERO":1,"SEGUNDO":2,"TERCERO":3,"CUARTO":4,"QUINTO":5,"SEXTO":6,"SÉPTIMO":7,"SEPTIMO":7,"OCTAVO":8,"NOVENO":9,"DECIMO":10,"DÉCIMO":10};
    if(mapWord[s]!=null) return mapWord[s];
    const num = parseInt(s,10);
    return isFinite(num)?num:NaN;
  }

  function tryAsignarSlots(filas, asignMap, docentesIdx){
    // Estructuras de control: agenda[carrera][dia][franja] -> { ciclos:Set }
    const agendaCarrera = new Map();
    const cargaDocente = new Map(); // clave docente + día -> count
    function canPlace(carrera, cicloNum, dia, franja, docente){
      if(!agendaCarrera.has(carrera)) agendaCarrera.set(carrera, {});
      const A = agendaCarrera.get(carrera);
      if(!A[dia]) A[dia] = {};
      if(!A[dia][franja]) A[dia][franja] = new Set();
      const ciclosUsados = A[dia][franja];
      // Sin choques con adyacentes
      if(ciclosUsados.has(cicloNum) || ciclosUsados.has(cicloNum-1) || ciclosUsados.has(cicloNum+1)) return false;
      // Máx. 2 por día por docente
      if(docente){
        const key = docente + "|" + dia;
        const cnt = cargaDocente.get(key) || 0;
        if(cnt >= 2) return false;
      }
      return true;
    }
    function place(carrera, cicloNum, dia, franja, docente){
      const A = agendaCarrera.get(carrera);
      A[dia][franja].add(cicloNum);
      if(docente){
        const key = docente + "|" + dia;
        cargaDocente.set(key, (cargaDocente.get(key) || 0) + 1);
      }
    }

    for(const fila of filas){
      // Docente asignado por materia (si existe mapeo)
      const materia = String(fila["MATERIA"]||"").trim();
      const docAsign = asignMap.get(norm(materia)) || null;
      if(docAsign){
        fila["DOCENTE"] = docAsign.DOCENTE;
        fila["TITULO ACADÉMICO"] = docAsign["TITULO ACADÉMICO"] || "";
        fila["DEDICACIÓN"] = docAsign["DEDICACIÓN"] || "";
      }else{
        // Si no hay mapeo, se deja vacío para validación manual
      }

      // Datos para evitar choques
      const carreras = String(fila["CARRERAS QUE COMPARTEN"]||"").split("/").map(s=>s.trim()).filter(Boolean);
      const ciclosTxt = String(fila["CICLO MALLA"]||"");
      // si viene "2 / 3" por carreras, tome el primero numérico como proxy
      const cicloNum = cicloVec(ciclosTxt.split("/")[0] || "");

      // Asignar 1 slot (día, franja). Las demás en suspenso ("")
      let asignado = false;
      for(const dia of DIAS){
        for(const franja of FRANJAS){
          // Evaluar para la primera carrera listada (proxy de restricción)
          const carrera = carreras[0] || "_GEN";
          if(canPlace(carrera, cicloNum, dia, franja, fila["DOCENTE"])){
            fila["DIA"] = dia;
            fila["HORA"] = franja;
            // Nro. HORAS -> suma de teóricas + prácticas + autónomas (primer valor si vienen "/")
            const te = Number(String(fila["HORAS TEÓRICAS"]||"").split("/")[0].replace(",",".")) || 0;
            const pr = Number(String(fila["HORAS PRÁCTICAS"]||"").split("/")[0].replace(",",".")) || 0;
            const au = Number(String(fila["HORAS AUTÓNOMAS"]||"").split("/")[0].replace(",",".")) || 0;
            const total = te + pr + au;
            fila["Nro. HORAS"] = String(total);
            place(carrera, cicloNum, dia, franja, fila["DOCENTE"]);
            asignado = true;
            break;
          }
        }
        if(asignado) break;
      }
      if(!asignado){
        // Dejar en suspenso si no hay slot disponible según restricciones
        fila["DIA"] = "";
        fila["HORA"] = "";
        const te = Number(String(fila["HORAS TEÓRICAS"]||"").split("/")[0].replace(",",".")) || 0;
        const pr = Number(String(fila["HORAS PRÁCTICAS"]||"").split("/")[0].replace(",",".")) || 0;
        const au = Number(String(fila["HORAS AUTÓNOMAS"]||"").split("/")[0].replace(",",".")) || 0;
        fila["Nro. HORAS"] = String(te + pr + au);
      }
      // Modalidad queda para que se complete luego
      fila["MODALIDAD"] = fila["MODALIDAD"] || "";
    }

    return filas;
  }

  function renderTabla(rows){
    const tbody = $("#tabla tbody");
    tbody.innerHTML = "";
    const numCols = new Set(["HORAS TEÓRICAS","HORAS PRÁCTICAS","HORAS AUTÓNOMAS","CREDITOS","Nº ORDEN EN LA MALLA","Nro. HORAS"]);
    for(const r of rows){
      const tr = document.createElement("tr");
      const cols = ["DOCENTE","TITULO ACADÉMICO","DEDICACIÓN","MATERIA","CÓDIGO ANTHOLOGY","CARRERAS QUE COMPARTEN","MALLA","PRE-REQUISITO","CODIGO","HORAS TEÓRICAS","HORAS PRÁCTICAS","HORAS AUTÓNOMAS","CREDITOS","CAMPO DE FORMACIÓN","CICLO MALLA","Nº ORDEN EN LA MALLA","PARALELO","DIA","HORA","MODALIDAD","Nro. HORAS"];
      for(const c of cols){
        const td = document.createElement("td");
        const v = (r[c]!=null)? String(r[c]) : "";
        td.textContent = v;
        if(numCols.has(c)) td.classList.add("center-num");
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    $("#gridWrap").style.display = "block";
  }

  function habilitarProcesar(){
    $("#btnProcesar").disabled = !(estado.mallasRows.length && estado.docentesRows.length);
  }

  $("#mallas").addEventListener("change", async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const rows = await leerExcel(f);
    // remap de encabezados
    const mapped = rows.map(r=> remapRow(r, MAP_MALLAS));
    estado.mallasRows = mapped;
    habilitarProcesar();
  });

  $("#docentes").addEventListener("change", async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const rows = await leerExcel(f);
    const {docentes, asignaciones} = indexDocentes(rows);
    estado.docentesRows = docentes;
    estado.asignacionesRows = asignaciones;
    estado.docentesBase = rows.map(r=>remapRow(r, MAP_DOC));
    habilitarProcesar();
  });

  $("#btnProcesar").addEventListener("click", ()=>{
    // Combinar mallas
    const base = combinarMallas(estado.mallasRows);
    // Construir map de asignaciones por materia -> docente (toma el primero)
    const asignMap = new Map();
    for(const a of estado.asignacionesRows){
      const k = norm(a["MATERIA"]);
      if(!asignMap.has(k)){
        // Enriquecer con datos del catálogo de docentes si se encuentra
        let tit = "", ded = "";
        // Buscar fila de docente
        const found = estado.docentesRows.find(d => norm(d["DOCENTE"]) === norm(a["DOCENTE"]));
        if(found){ tit = found["TITULO ACADÉMICO"]||""; ded = found["DEDICACIÓN"]||""; }
        asignMap.set(k, {DOCENTE:a["DOCENTE"], "TITULO ACADÉMICO":tit, "DEDICACIÓN":ded});
      }
    }
    const filas = tryAsignarSlots(base, asignMap, estado.docentesRows);
    estado.resultado = filas;
    renderTabla(filas);
    $("#btnExport").disabled = false;
  });

  $("#btnExport").addEventListener("click", ()=>{
    const ws = XLSX.utils.json_to_sheet(estado.resultado);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Matriz");
    XLSX.writeFile(wb, "Matriz_Integrada.xlsx");
  });
})();
</script>
</body>
</html>
