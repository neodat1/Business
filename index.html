<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UIDE – Planificación Estudiante</title>

<!-- SheetJS (XLSX) para leer archivos Excel externos -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --azul:#04136C; --mostaza:#DE912E; --vino:#862B39; --celeste:#9CBEE3; --verde:#8A9520;
    --bg:#f7f8fb; --ink:#1b1f3a; --muted:#667085;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  header{
    background:#fff; border-bottom:4px solid var(--azul);
    display:flex; align-items:center; gap:16px; padding:12px 18px;
    position:sticky; top:0; z-index:5;
  }
  header img{height:44px; width:auto; object-fit:contain; image-rendering:-webkit-optimize-contrast}
  header .title{
    display:flex; flex-direction:column; line-height:1.1;
  }
  header .title h1{margin:0;font-size:18px;font-weight:800;color:var(--azul); letter-spacing:.2px}
  header .title span{font-size:12px;color:var(--muted)}
  .bar{
    display:flex; gap:12px; flex-wrap:wrap; align-items:center; padding:14px 18px;
  }
  .card{
    background:#fff; border:1px solid #e7e9f0; border-radius:14px; box-shadow:0 1px 3px rgba(4,19,108,.06);
  }
  .panel{padding:14px 16px}
  .hint{font-size:12px;color:var(--muted)}
  .btn{
    appearance:none; border:0; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer;
    background:var(--azul); color:#fff;
  }
  .btn.alt{background:var(--mostaza); color:#1b1b1b}
  .tag{display:inline-block; font-size:11px; padding:3px 8px; border-radius:999px; background:var(--celeste); color:#0d274f; font-weight:700}
  .grid{
    padding:16px 18px 24px;
  }
  table{width:100%; border-collapse:separate; border-spacing:0; font-size:14px}
  thead th{
    position:sticky; top:64px; z-index:2;
    background:#fff; color:var(--azul); font-weight:800; text-transform:uppercase; letter-spacing:.3px;
    border-bottom:2px solid var(--azul);
    padding:10px 8px; text-align:left;
  }
  tbody td{padding:10px 8px; border-bottom:1px solid #edf0f6}
  tbody tr:hover{background:#fafcff}
  .pill{font-weight:700; padding:4px 8px; border-radius:999px; display:inline-block}
  .p-azul{background:rgba(4,19,108,.08); color:var(--azul)}
  .p-vino{background:rgba(134,43,57,.10); color:var(--vino)}
  .p-mostaza{background:rgba(222,145,46,.18); color:#6a3f00}
  .p-verde{background:rgba(138,149,32,.14); color:#3a4a00}
  .p-celeste{background:rgba(156,190,227,.25); color:#0d274f}
  .status{font-size:12px;color:var(--muted)}
  .legend{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .legend .chip{display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#2b2f44}
  .legend .dot{width:10px; height:10px; border-radius:50%}
  .dot.azul{background:var(--azul)}
  .dot.mostaza{background:var(--mostaza)}
  .dot.vino{background:var(--vino)}
  .dot.celeste{background:var(--celeste)}
  .dot.verde{background:var(--verde)}
  .wrap{max-width:1240px; margin:0 auto}
  .error{color:#b00020; font-weight:700}
  .ok{color:#1a7f37; font-weight:700}
  .scroll{overflow:auto}
  @media (max-width:900px){
    header .title h1{font-size:16px}
    thead th{top:92px}
  }
</style>
</head>
<body>
  <header class="card">
    <img src="UIDE-Ecuador.png" alt="UIDE Ecuador" />
    <div class="title">
      <h1>Planificación Estudiante – Matriz de Asignación</h1>
      <span>Carga su(s) Excel y genere la planificación sin cruces. Encabezado con fondo blanco.</span>
    </div>
  </header>

  <div class="wrap">
    <div class="bar card panel">
      <input id="fileInput" type="file" accept=".xlsx,.xls" multiple />
      <button id="btnProcesar" class="btn">Procesar Excel</button>
      <span id="status" class="status">Listo para procesar.</span>
      <div class="legend" style="margin-left:auto">
        <span class="chip"><span class="dot azul"></span> Docente</span>
        <span class="chip"><span class="dot mostaza"></span> Materia</span>
        <span class="chip"><span class="dot vino"></span> Paralelo</span>
        <span class="chip"><span class="dot verde"></span> Día</span>
        <span class="chip"><span class="dot celeste"></span> Hora</span>
      </div>
    </div>

    <div class="grid card panel scroll">
      <div class="hint" style="margin-bottom:8px">
        Columnas esperadas (en el Excel): <b>DOCENTE, MATERIA, DIA DISPONIBLE, HORA DISPONIBLE, ESTUDIANTES</b>. Opcionales: <b>RESTRICCIONES</b> (por ej. <i>LUNES;MIÉRCOLES</i>), <b>CICLO</b>.
      </div>
      <table id="tabla">
        <thead>
          <tr>
            <th>DOCENTE</th>
            <th>MATERIA</th>
            <th>ESTUDIANTES</th>
            <th>PARALELO</th>
            <th>DÍA</th>
            <th>HORA</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="panel" style="opacity:.9">
      <span class="hint">Reglas: máximo 2 asignaturas/día por docente; evita cruces entre paralelos; si >26 estudiantes, se subdivide; respeta restricciones; bloques: 07–10, 10–13, 13–16, 16–19, 19–22.</span>
    </div>
  </div>

<script>
(() => {
  const SLOTS = [
    {label:"07:00-10:00", start:7, end:10},
    {label:"10:00-13:00", start:10, end:13},
    {label:"13:00-16:00", start:13, end:16},
    {label:"16:00-19:00", start:16, end:19},
    {label:"19:00-22:00", start:19, end:22},
  ];
  const DAYS = ["LUNES","MARTES","MIÉRCOLES","JUEVES","VIERNES"];

  const $ = sel => document.querySelector(sel);
  const status = msg => { const s=$("#status"); s.textContent=msg; };

  function parseHourLabelToSlot(label){
    if(!label) return null;
    const t = label.toString().trim().toUpperCase();
    // Formatos soportados:
    // "07:00 A 22:00" | "10:00-13:00" | "13:00" | "07:00 a 10:00"
    const mRange = t.match(/(\d{1,2}):?(\d{2})?\s*(?:A|-|–|—|A)\s*(\d{1,2}):?(\d{2})?/);
    if(mRange){
      const sh = parseInt(mRange[1],10);
      const eh = parseInt(mRange[3],10);
      // Si abarca todo el día, devolver todos los slots
      if(sh<=7 && eh>=22) return SLOTS.map(s=>s.label);
      // Si cruza varios, devolver los que caben en el rango
      return SLOTS.filter(s => s.start>=sh && s.end<=eh).map(s=>s.label);
    }
    const mSingle = t.match(/(\d{1,2}):?(\d{2})?/);
    if(mSingle){
      const h = parseInt(mSingle[1],10);
      const slot = SLOTS.find(s => h>=s.start && h<s.end);
      return slot ? [slot.label] : null;
    }
    // Palabras tipo "TODO" -> todos los slots
    if(/TODO|COMPLETO|CUALQUIER/.test(t)) return SLOTS.map(s=>s.label);
    return null;
  }

  function parseDays(text){
    if(!text) return [];
    let t = text.toString().toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu, "");
    // Soporta "LUNES A VIERNES", "MARTES Y JUEVES", "LUNES,MIERCOLES,VIERNES"
    if(/LUNES\s*A\s*VIERNES/.test(t)) return [...DAYS];
    t = t.replace(/Y/g,",").replace(/\s+/g,"");
    const parts = t.split(/[;,]/).filter(Boolean);
    const map = {"LUNES":"LUNES","MARTES":"MARTES","MIERCOLES":"MIÉRCOLES","MIERCOLES":"MIÉRCOLES","JUEVES":"JUEVES","VIERNES":"VIERNES"};
    const out=[];
    for(const p of parts){
      const key = p.replace("MIERCOLES","MIÉRCOLES");
      if(DAYS.includes(key)) out.push(key);
      else if(map[p]) out.push(map[p]);
    }
    // Quitar duplicados manteniendo orden original DAYS
    return DAYS.filter(d => out.includes(d));
  }

  function parseRestrictions(text){
    if(!text) return [];
    // ejemplo "LUNES;MIÉRCOLES"
    return parseDays(text);
  }

  function splitParallels(students){
    const n = parseInt(students||0,10);
    if(isNaN(n) || n<=26) return 1;
    return Math.ceil(n/26);
  }

  function neighborCyclesConflict(c1, c2){
    // Si no hay ciclos, no aplica
    if(!c1 || !c2) return false;
    const a = parseInt(c1,10), b = parseInt(c2,10);
    if(Number.isNaN(a) || Number.isNaN(b)) return false;
    // Conflictos entre (1 con 2 y 3), (2 con 3 y 4), etc.
    const neighbors = new Set([a+1,a+2,a-1,a-2]);
    return neighbors.has(b);
  }

  function normalizeRow(r){
    // Admite múltiples encabezados equivalentes
    const get = (keys) => {
      for(const k of keys){
        if(r[k]!==undefined && r[k]!==null) return String(r[k]).trim();
        // intentar sin acentos y mayúsculas
        const found = Object.keys(r).find(h => h.toString().toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,"") === k.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,""));
        if(found) return String(r[found]).trim();
      }
      return "";
    };
    const docente = get(["DOCENTE"]);
    const materia = get(["MATERIA"]);
    const diaDisp = get(["DIA DISPONIBLE","DÍA DISPONIBLE","DIA","DISPONIBILIDAD DIA"]);
    const horaDisp = get(["HORA DISPONIBLE","HORA","DISPONIBILIDAD HORA"]);
    const estudiantes = get(["ESTUDIANTES","N° ESTUDIANTES","NUM ESTUDIANTES"]);
    const restricciones = get(["RESTRICCIONES","DIAS NO DISPONIBLES","DÍAS NO DISPONIBLES"]);
    const ciclo = get(["CICLO","NIVEL"]);
    return {docente,materia,diaDisp,horaDisp,estudiantes,restricciones,ciclo};
  }

  function schedule(records){
    const result = [];
    const docenteDayCount = new Map(); // key: docente|día -> count
    const taken = new Set(); // key: día|slot|docente  y día|slot|materia|paralelo

    function canPlace(item, dia, slotLabel, paralelo){
      const docenteKey = `${item.docente}|${dia}|${slotLabel}`;
      const docenteDayKey = `${item.docente}|${dia}`;
      if(taken.has(docenteKey)) return false;
      const count = docenteDayCount.get(docenteDayKey)||0;
      if(count>=2) return false;

      const materiaKey = `${item.materia}|${dia}|${slotLabel}|${paralelo}`;
      if(taken.has(materiaKey)) return false;

      // Restricciones de días
      const restr = parseRestrictions(item.restricciones);
      if(restr.includes(dia)) return false;

      return true;
    }

    function place(item, dia, slotLabel, paralelo){
      taken.add(`${item.docente}|${dia}|${slotLabel}`);
      taken.add(`${item.materia}|${dia}|${slotLabel}|${paralelo}`);
      const k = `${item.docente}|${dia}`;
      docenteDayCount.set(k, (docenteDayCount.get(k)||0)+1);
      result.push({
        DOCENTE:item.docente,
        MATERIA:item.materia,
        ESTUDIANTES:item.estudiantes||"",
        PARALELO:`P${paralelo}`,
        DIA:dia,
        HORA:slotLabel
      });
    }

    // Orden simple: materias con menos opciones primero para mejorar el ajuste
    const tasks = [];
    for(const rec of records){
      const dias = parseDays(rec.diaDisp);
      const horas = parseHourLabelToSlot(rec.horaDisp) || SLOTS.map(s=>s.label);
      const options = dias.length*(horas.length||SLOTS.length);
      const paralelos = splitParallels(rec.estudiantes);
      tasks.push({rec, dias, horas, options, paralelos});
    }
    tasks.sort((a,b)=> a.options - b.options);

    for(const t of tasks){
      const {rec, dias, horas, paralelos} = t;
      // Si no hay días en el Excel, usar L-V
      const days = (dias && dias.length)? dias : [...DAYS];
      // Si no hay horas válidas, usar todos los slots
      const slots = (horas && horas.length)? horas : SLOTS.map(s=>s.label);

      // Intentar asignar cada paralelo
      let placedAll = true;
      for(let p=1; p<=paralelos; p++){
        let placed = false;
        // Heurística: rotar por días y slots para dispersar cargas
        for(const d of days){
          for(const sl of slots){
            if(canPlace(rec, d, sl, p)){
              place(rec, d, sl, p);
              placed = true;
              break;
            }
          }
          if(placed) break;
        }
        if(!placed){
          placedAll = false;
          // marcar como sin espacio
          result.push({
            DOCENTE:rec.docente,
            MATERIA:rec.materia,
            ESTUDIANTES:rec.estudiantes||"",
            PARALELO:`P${p}`,
            DIA:"SIN ESPACIO",
            HORA:"SIN ESPACIO"
          });
        }
      }
    }
    return result;
  }

  async function readFiles(files){
    const rows = [];
    for(const file of files){
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, {type:'array'});
      for(const sheetName of wb.SheetNames){
        const ws = wb.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(ws, {defval:""});
        for(const r of json) rows.push(normalizeRow(r));
      }
    }
    return rows.filter(r => r.docente && r.materia);
  }

  function renderTable(items){
    const tbody = $("#tbody");
    tbody.innerHTML = "";
    const frag = document.createDocumentFragment();
    for(const it of items){
      const tr = document.createElement("tr");

      const tdDoc = document.createElement("td");
      tdDoc.innerHTML = `<span class="pill p-azul">${escapeHtml(it.DOCENTE)}</span>`;
      tr.appendChild(tdDoc);

      const tdMat = document.createElement("td");
      tdMat.innerHTML = `<span class="pill p-mostaza">${escapeHtml(it.MATERIA)}</span>`;
      tr.appendChild(tdMat);

      const tdEst = document.createElement("td");
      tdEst.textContent = it.ESTUDIANTES||"";
      tr.appendChild(tdEst);

      const tdPar = document.createElement("td");
      tdPar.innerHTML = `<span class="pill p-vino">${escapeHtml(it.PARALELO)}</span>`;
      tr.appendChild(tdPar);

      const tdDia = document.createElement("td");
      tdDia.innerHTML = `<span class="pill p-verde">${escapeHtml(it.DIA)}</span>`;
      tr.appendChild(tdDia);

      const tdHora = document.createElement("td");
      tdHora.innerHTML = `<span class="pill p-celeste">${escapeHtml(it.HORA)}</span>`;
      tr.appendChild(tdHora);

      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
  }

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  $("#btnProcesar").addEventListener("click", async () => {
    try{
      const fi = $("#fileInput");
      if(!fi.files || fi.files.length===0){
        status("Adjunte al menos un Excel (.xlsx/.xls).");
        return;
      }
      status("Leyendo Excel...");
      const rows = await readFiles(fi.files);
      if(rows.length===0){
        status("No se encontraron filas válidas. Verifique encabezados.");
        return;
      }
      status(`Filas leídas: ${rows.length}. Programando...`);

      const items = schedule(rows);
      renderTable(items);
      const sinEspacio = items.filter(x=>x.DIA==="SIN ESPACIO").length;
      if(sinEspacio>0){
        status(`Programación completada con advertencias: ${sinEspacio} sin espacio.`);
        $("#status").className = "status error";
      }else{
        status("Programación completada sin conflictos.");
        $("#status").className = "status ok";
      }
    }catch(err){
      console.error(err);
      status("Error al procesar el/los archivo(s). Revise el formato.");
      $("#status").className = "status error";
    }
  });
})();
</script>
</body>
</html>
