<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planificación Académica – Generador de Matriz</title>
<style>
  :root{
    --bg:#f8f9fb;
    --ink:#1d2630;
    --muted:#6b7785;
    --accent:#0b5cff;
    --ok:#198754;
    --warn:#d39e00;
    --bad:#dc3545;
    --table-border:#e5e7eb;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif}
  header{padding:16px 20px;background:white;border-bottom:1px solid var(--table-border);position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:20px}
  .wrap{max-width:1300px;margin:0 auto;padding:18px}
  .card{background:white;border:1px solid var(--table-border);border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{font-weight:600;font-size:14px}
  input[type="file"]{display:block;font-size:14px}
  button{appearance:none;border:1px solid var(--ink);background:var(--ink);color:white;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  button.ghost{background:white;color:var(--ink)}
  button:disabled{opacity:.5;cursor:not-allowed}
  .hint{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#f3f4f6;z-index:5}
  th,td{border-bottom:1px solid var(--table-border);padding:8px 10px;font-size:13px;text-align:left;vertical-align:top}
  tbody tr:nth-child(odd){background:#fafbfc}
  .badge{display:inline-block;padding:.15rem .45rem;border-radius:6px;font-size:11px;border:1px solid var(--table-border);background:#fff;color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:.15rem .5rem;border-radius:999px;font-size:11px;border:1px solid var(--table-border);background:#fff;color:var(--muted)}
  .log{white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;font-size:12px;color:#374151;background:#f9fafb;border:1px dashed #e5e7eb;border-radius:10px;padding:10px;max-height:200px;overflow:auto}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between">
    <h1>Planificación Académica — Generador de Matriz</h1>
    <div class="controls">
      <button id="btnGenerar" disabled>Generar planificación</button>
      <button id="btnLimpiar" class="ghost">Limpiar</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <label for="fileMallas">Mallas.xlsx</label>
        <input type="file" id="fileMallas" accept=".xlsx,.xls" />
        <div class="hint">Contiene: CARRERA, MATERIA, CÓDIGO, PRE-REQUISITO, HORAS TEÓRICAS/PRÁCTICAS/AUTÓNOMAS, CRÉDITOS, CAMPO DE FORMACIÓN, CICLO, Nº ORDEN, PARALELO, MODALIDAD, CÓDIGO ANTHOLOGY (si aplica).</div>
      </div>
      <div>
        <label for="fileDocentes">Docentes.xlsx</label>
        <input type="file" id="fileDocentes" accept=".xlsx,.xls" />
        <div class="hint">Contiene: DOCENTE, TÍTULO ACADÉMICO, DEDICACIÓN, MATERIA/CÓDIGO, DISPONIBILIDAD (p. ej., “Lunes 7-10”, “Martes 10-13”, ...), CÓDIGO ANTHOLOGY (si aplica).</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <div style="font-weight:700;margin-bottom:6px">Parámetros</div>
        <div class="hint">Franja horaria fija: Lunes–Viernes en 7-10, 10-13, 13-16, 16-19, 19-22. &nbsp;•&nbsp; Máximo 2 asignaturas por docente por día. &nbsp;•&nbsp; No choques entre ciclos adyacentes (n con n-1 y n+1) dentro de la misma carrera. &nbsp;•&nbsp; Se asignan <b>solamente</b> horas de contacto (teóricas + prácticas).</div>
      </div>
      <div>
        <span class="pill"><span>Slots de 3 h</span></span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700">Matriz generada</div>
      <div class="hint">Las filas representan bloques asignados de 3 horas (o el remanente final).</div>
    </div>
    <div style="overflow:auto; border:1px solid var(--table-border);border-radius:10px;max-height:55vh">
      <table id="tbl">
        <thead>
          <tr>
            <th>DOCENTE</th>
            <th>TITULO ACADÉMICO</th>
            <th>DEDICACIÓN</th>
            <th>MATERIA</th>
            <th>CÓDIGO ANTHOLOGY</th>
            <th>CARRERAS QUE COMPARTEN</th>
            <th>PRE-REQUISITO</th>
            <th>CODIGO</th>
            <th>HORAS TEÓRICAS</th>
            <th>HORAS PRÁCTICAS</th>
            <th>HORAS AUTÓNOMAS</th>
            <th>CREDITOS</th>
            <th>CAMPO DE FORMACIÓN</th>
            <th>CICLO MALLA</th>
            <th>Nº ORDEN EN LA MALLA</th>
            <th>PARALELO</th>
            <th>DIA</th>
            <th>HORA</th>
            <th>MODALIDAD</th>
            <th>Nro. HORAS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="margin-top:10px">
      <div style="font-weight:700;margin-bottom:6px">Registro</div>
      <div id="log" class="log"></div>
    </div>
  </div>
</div>

<!-- SheetJS (XLSX) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
(() => {
  const btnGenerar = document.getElementById('btnGenerar');
  const btnLimpiar  = document.getElementById('btnLimpiar');
  const fileMallas  = document.getElementById('fileMallas');
  const fileDocentes= document.getElementById('fileDocentes');
  const tblBody     = document.querySelector('#tbl tbody');
  const logEl       = document.getElementById('log');

  const TIMESLOTS = [
    {day:'Lunes',   range:'7-10',  hours:3},
    {day:'Lunes',   range:'10-13', hours:3},
    {day:'Lunes',   range:'13-16', hours:3},
    {day:'Lunes',   range:'16-19', hours:3},
    {day:'Lunes',   range:'19-22', hours:3},
    {day:'Martes',  range:'7-10',  hours:3},
    {day:'Martes',  range:'10-13', hours:3},
    {day:'Martes',  range:'13-16', hours:3},
    {day:'Martes',  range:'16-19', hours:3},
    {day:'Martes',  range:'19-22', hours:3},
    {day:'Miércoles',range:'7-10', hours:3},
    {day:'Miércoles',range:'10-13',hours:3},
    {day:'Miércoles',range:'13-16',hours:3},
    {day:'Miércoles',range:'16-19',hours:3},
    {day:'Miércoles',range:'19-22',hours:3},
    {day:'Jueves',  range:'7-10',  hours:3},
    {day:'Jueves',  range:'10-13', hours:3},
    {day:'Jueves',  range:'13-16', hours:3},
    {day:'Jueves',  range:'16-19', hours:3},
    {day:'Jueves',  range:'19-22', hours:3},
    {day:'Viernes', range:'7-10',  hours:3},
    {day:'Viernes', range:'10-13', hours:3},
    {day:'Viernes', range:'13-16', hours:3},
    {day:'Viernes', range:'16-19', hours:3},
    {day:'Viernes', range:'19-22', hours:3},
  ];

  const FIELD_MAP = {
    carrera: ['CARRERA','CARRERAS','PROGRAMA','CARRERA/PROGRAMA'],
    materia: ['MATERIA','ASIGNATURA','NOMBRE ASIGNATURA','NOMBRE MATERIA'],
    codigo:  ['CODIGO','CÓDIGO','CÓDIGO MATERIA','COD MATERIA','CODIGO MATERIA'],
    codigoAnth: ['CÓDIGO ANTHOLOGY','CODIGO ANTHOLOGY','ANTHOLOGY'],
    prereq:  ['PRE-REQUISITO','PRERREQUISITO','PRERREQUISITOS','REQUISITOS'],
    horasTeo:['HORAS TEÓRICAS','HORAS TEORICAS','H TEORICAS','HT'],
    horasPra:['HORAS PRÁCTICAS','HORAS PRACTICAS','H PRACTICAS','HP'],
    horasAut:['HORAS AUTÓNOMAS','HORAS AUTONOMAS','H AUTONOMAS','HA'],
    creditos:['CREDITOS','CRÉDITOS','CR'],
    campoForm:['CAMPO DE FORMACIÓN','CAMPO FORMACION','CAMPO'],
    ciclo:   ['CICLO MALLA','CICLO','SEMESTRE','NIVEL'],
    ordenMalla:['Nº ORDEN EN LA MALLA','N ORDEN','ORDEN','N° ORDEN','NO. ORDEN'],
    paralelo:['PARALELO','PAR','SECCION','SECCIÓN'],
    modalidad:['MODALIDAD','MOD']
  };

  const DFIELD_MAP = {
    docente:['DOCENTE','PROFESOR','NOMBRE','NOMBRES','APELLIDOS Y NOMBRES'],
    titulo:['TITULO ACADÉMICO','TÍTULO ACADÉMICO','TITULO','TÍTULO'],
    dedicacion:['DEDICACIÓN','DEDICACION','JORNADA','TIPO DEDICACION','TIPO DEDICACIÓN'],
    materia:['MATERIA','ASIGNATURA','NOMBRE MATERIA','ASIGNATURA ASIGNADA','ASIG'],
    codigo:['CÓDIGO','CODIGO','CODIGO MATERIA','CÓDIGO MATERIA'],
    codigoAnth:['CÓDIGO ANTHOLOGY','CODIGO ANTHOLOGY','ANTHOLOGY'],
    carrera:['CARRERA','PROGRAMA']
  };

  const DAY_ALIASES = {
    'lunes':'Lunes','lun':'Lunes',
    'martes':'Martes','mar':'Martes',
    'miercoles':'Miércoles','miércoles':'Miércoles','mie':'Miércoles','mié':'Miércoles',
    'jueves':'Jueves','jue':'Jueves',
    'viernes':'Viernes','vie':'Viernes'
  };

  function log(msg){ logEl.textContent += (msg + "\n"); }

  function readWorkbook(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = e => {
        try{
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, {type:'array'});
          resolve(wb);
        }catch(err){ reject(err); }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  function sheetToJSONAllSheets(wb){
    const rows = [];
    wb.SheetNames.forEach(name => {
      const ws = wb.Sheets[name];
      if(!ws) return;
      const json = XLSX.utils.sheet_to_json(ws, {defval:'', raw:false});
      json.forEach(r => { r.__sheet = name; rows.push(r); });
    });
    return rows;
  }

  function normStr(v){ return (v==null? '': String(v)).trim(); }
  function num(v){ const n = parseFloat(String(v).replace(',','.')); return isNaN(n)?0:n; }
  function truthy(v){
    if(v===null || v===undefined) return false;
    const s = String(v).trim().toLowerCase();
    if(s==='' ) return false;
    return ['x','si','sí','disponible','ok','true','1','y','yes'].includes(s) || (!isNaN(parseFloat(s)) && parseFloat(s)>0);
  }

  function findCol(obj, keys){
    const cols = Object.keys(obj);
    for(const k of keys){
      for(const col of cols){
        if(normStr(col).toLowerCase() === normStr(k).toLowerCase()) return col;
      }
    }
    // softer match (includes)
    for(const k of keys){
      for(const col of cols){
        if(normStr(col).toLowerCase().includes(normStr(k).toLowerCase())) return col;
      }
    }
    return null;
  }

  function getField(obj, key){
    const keys = FIELD_MAP[key];
    const col = findCol(obj, keys);
    return col? obj[col] : '';
  }
  function getDField(obj, key){
    const keys = DFIELD_MAP[key];
    const col = findCol(obj, keys);
    return col? obj[col] : '';
  }

  function parseCycle(v){
    const s = normStr(v).toLowerCase();
    const map = {'primero':1,'segundo':2,'tercero':3,'cuarto':4,'quinto':5,'sexto':6,'séptimo':7,'septimo':7,'octavo':8,'noveno':9,'décimo':10,'decimo':10};
    if(map[s]) return map[s];
    const nn = parseInt(s,10);
    return isNaN(nn)? 0: nn;
  }

  function detectAvailabilityHeaders(sampleRow){
    const headers = Object.keys(sampleRow||{});
    const out = [];
    headers.forEach(h => {
      const hs = normStr(h).toLowerCase();
      for(const k in DAY_ALIASES){
        if(hs.includes(k)){
          // try to find ranges like 7-10, 10-13, etc.
          const m = hs.match(/(7\s*-\s*10|10\s*-\s*13|13\s*-\s*16|16\s*-\s*19|19\s*-\s*22)/);
          if(m){
            out.push({header:h, day:DAY_ALIASES[k], range:m[1].replace(/\s*/g,'')});
            break;
          }
        }
      }
    });
    // deduplicate
    const seen = new Set();
    return out.filter(x=>{
      const key = x.day+'|'+x.range;
      if(seen.has(key)) return false;
      seen.add(key); return true;
    });
  }

  function buildDocentes(rawDocRows){
    if(rawDocRows.length===0) return {list:[], byName:{}};

    // detect availability headers once
    const availHeaders = detectAvailabilityHeaders(rawDocRows[0]);
    const docentes = [];
    const byName = {};

    rawDocRows.forEach(r => {
      const nombre = normStr(getDField(r,'docente'));
      if(!nombre) return;

      const d = {
        docente: nombre,
        titulo: normStr(getDField(r,'titulo')),
        dedicacion: normStr(getDField(r,'dedicacion')),
        materia: normStr(getDField(r,'materia')),
        codigo: normStr(getDField(r,'codigo')),
        codigoAnth: normStr(getDField(r,'codigoAnth')),
        carrera: normStr(getDField(r,'carrera')),
        disponibilidad: new Set()
      };

      // availability
      availHeaders.forEach(h => {
        const v = r[h.header];
        if(truthy(v)){
          d.disponibilidad.add(h.day+'|'+h.range);
        }
      });

      docentes.push(d);
      if(!byName[nombre]) byName[nombre] = [];
      byName[nombre].push(d);
    });

    return {list: docentes, byName, availHeaders};
  }

  function keySubject(m){
    // prefer ANTHOLOGY or CODIGO; fallback to materia
    const k1 = normStr(m.codigoAnth);
    const k2 = normStr(m.codigo);
    const k3 = normStr(m.materia);
    return (k1 || k2 || k3 || '').toLowerCase();
  }

  function buildMaterias(rawMallas){
    const materias = [];
    rawMallas.forEach(r => {
      // if row does not look like a subject, skip
      const nombre = normStr(getField(r,'materia'));
      const carrera= normStr(getField(r,'carrera'));
      if(!nombre && !carrera) return;

      const m = {
        carrera,
        materia: nombre,
        codigoAnth: normStr(getField(r,'codigoAnth')),
        codigo: normStr(getField(r,'codigo')),
        prereq: normStr(getField(r,'prereq')),
        horasTeo: num(getField(r,'horasTeo')),
        horasPra: num(getField(r,'horasPra')),
        horasAut: num(getField(r,'horasAut')),
        creditos: num(getField(r,'creditos')),
        campoForm: normStr(getField(r,'campoForm')),
        ciclo: parseCycle(getField(r,'ciclo')),
        cicloRaw: normStr(getField(r,'ciclo')),
        ordenMalla: normStr(getField(r,'ordenMalla')),
        paralelo: normStr(getField(r,'paralelo')),
        modalidad: normStr(getField(r,'modalidad'))
      };
      materias.push(m);
    });

    // compartir carreras
    const byKey = {};
    materias.forEach(m => {
      const k = keySubject(m);
      if(!k) return;
      if(!byKey[k]) byKey[k] = [];
      byKey[k].push(m);
    });

    // columnas compartidas
    materias.forEach(m => {
      const k = keySubject(m);
      const group = byKey[k] || [m];
      const carreras = Array.from(new Set(group.map(x=>x.carrera).filter(Boolean)));
      const ordenes  = Array.from(new Set(group.map(x=>x.ordenMalla).filter(Boolean)));
      m.carrerasComparten = carreras.join(' / ');
      m.ordenJoined = ordenes.join(' / ');
    });

    return materias;
  }

  function matchDocenteParaMateria(m, docentes){
    // estrategia: buscar por códigoAnth, luego código, luego nombre de materia
    const kAnth = normStr(m.codigoAnth).toLowerCase();
    const kCod  = normStr(m.codigo).toLowerCase();
    const kNom  = normStr(m.materia).toLowerCase();

    let cand = docentes.list.filter(d => {
      const dm = normStr(d.materia).toLowerCase();
      const dc = normStr(d.codigo).toLowerCase();
      const da = normStr(d.codigoAnth).toLowerCase();
      return (kAnth && da===kAnth) || (kCod && dc===kCod) || (kNom && dm===kNom);
    });

    if(cand.length===0){
      // fallback: cualquiera con misma carrera (si viene)
      if(m.carrera){
        cand = docentes.list.filter(d => normStr(d.carrera).toLowerCase()===normStr(m.carrera).toLowerCase());
      }
    }

    // devolver el primero con algo de disponibilidad; sino cualquiera
    const withAvail = cand.find(d => d.disponibilidad && d.disponibilidad.size>0);
    return withAvail || cand[0] || null;
  }

  function schedule(materias, docentes){
    // estructuras de control
    const assignedRows = [];
    const ocupacionDoc = {}; // docente -> day -> [ranges]
    const perDayCount  = {}; // docente|day -> count (máx 2)
    const ocupacionCiclo = {}; // carrera|ciclo -> Set(day|range)

    function markDocente(dname, day, range){
      if(!ocupacionDoc[dname]) ocupacionDoc[dname] = {};
      if(!ocupacionDoc[dname][day]) ocupacionDoc[dname][day] = new Set();
      ocupacionDoc[dname][day].add(range);
      const key = dname+'|'+day;
      perDayCount[key] = (perDayCount[key]||0) + 1;
    }

    function docenteLibre(dname, day, range){
      if(!dname) return true;
      if(!ocupacionDoc[dname]) return true;
      if(!ocupacionDoc[dname][day]) return true;
      return !ocupacionDoc[dname][day].has(range);
    }

    function docenteTopeDia(dname, day){
      if(!dname) return false;
      const key = dname+'|'+day;
      return (perDayCount[key]||0) >= 2;
    }

    function cicloKey(carrera, ciclo){ return normStr(carrera)+'|'+String(ciclo||0); }

    function vecinoChoca(carrera, ciclo, day, range){
      // no choques de ciclo n con n-1 y n+1 en la MISMA carrera
      const ks = [cicloKey(carrera, (ciclo||0)-1), cicloKey(carrera, (ciclo||0)+1)];
      for(const k of ks){
        const set = ocupacionCiclo[k];
        if(set && set.has(day+'|'+range)) return true;
      }
      return false;
    }

    function marcarCiclo(carrera, ciclo, day, range){
      const k = cicloKey(carrera, ciclo);
      if(!ocupacionCiclo[k]) ocupacionCiclo[k] = new Set();
      ocupacionCiclo[k].add(day+'|'+range);
    }

    // ordenar materias por ciclo (podría ayudar a reducir choques)
    materias.sort((a,b)=> (a.carrera||'').localeCompare(b.carrera||'') || (a.ciclo||0)-(b.ciclo||0));

    materias.forEach(m => {
      const contacto = Math.max(0, (m.horasTeo||0) + (m.horasPra||0)); // solo contacto
      if(contacto<=0){
        log(`Sin horas de contacto para: ${m.carrera} – ${m.materia}. Se omite la asignación de slots.`);
        return;
      }
      let horasPend = contacto;
      const docente = matchDocenteParaMateria(m, docentes);
      const dname   = docente? docente.docente : '';

      if(!docente){
        log(`No se encontró docente asignado para: ${m.carrera} – ${m.materia}. Se intentará ubicar sin disponibilidad específica.`);
      }

      // candidato de slots en orden determinista
      const slotsOrden = TIMESLOTS.slice();

      // si hay docente y disponibilidad, priorizar sus slots disponibles
      let pref = [];
      if(docente && docente.disponibilidad && docente.disponibilidad.size>0){
        pref = slotsOrden.filter(s => docente.disponibilidad.has(s.day+'|'+s.range));
        // luego el resto
        const resto = slotsOrden.filter(s => !docente.disponibilidad.has(s.day+'|'+s.range));
        slotsOrden.length = 0;
        slotsOrden.push(...pref, ...resto);
      }

      for(const s of slotsOrden){
        if(horasPend<=0) break;

        // tope de 2 asignaturas por día (por docente)
        if(docenteTopeDia(dname, s.day)) continue;

        // disponibilidad del docente (si existe)
        if(docente && docente.disponibilidad && docente.disponibilidad.size>0){
          if(!docente.disponibilidad.has(s.day+'|'+s.range)) continue;
        }

        // docente libre en ese bloque
        if(!docenteLibre(dname, s.day, s.range)) continue;

        // no choque con ciclos vecinos
        if(vecinoChoca(m.carrera, m.ciclo, s.day, s.range)) continue;

        // asignar
        const horasEsteBloque = Math.min(s.hours, horasPend);
        assignedRows.push({
          docente: dname,
          titulo: docente? docente.titulo : '',
          dedicacion: docente? docente.dedicacion : '',
          materia: m.materia,
          codigoAnth: m.codigoAnth,
          carrerasComparten: m.carrerasComparten || m.carrera || '',
          prereq: m.prereq,
          codigo: m.codigo,
          horasTeo: m.horasTeo,
          horasPra: m.horasPra,
          horasAut: m.horasAut,
          creditos: m.creditos,
          campoForm: m.campoForm,
          ciclo: m.cicloRaw || m.ciclo,
          ordenMalla: m.ordenJoined || m.ordenMalla,
          paralelo: m.paralelo,
          dia: s.day,
          hora: s.range,
          modalidad: m.modalidad,
          nroHoras: horasEsteBloque
        });

        // marcar ocupaciones
        if(dname) markDocente(dname, s.day, s.range);
        marcarCiclo(m.carrera, m.ciclo, s.day, s.range);
        horasPend -= horasEsteBloque;
      }

      if(horasPend>0){
        log(`⚠️ Horas no asignadas (${horasPend}h) para: ${m.carrera} – ${m.materia}. Revise disponibilidad o conflictos.`);
      }
    });

    return assignedRows;
  }

  function render(rows){
    tblBody.innerHTML = '';
    const frag = document.createDocumentFragment();
    rows.forEach(r => {
      const tr = document.createElement('tr');
      const cells = [
        r.docente, r.titulo, r.dedicacion, r.materia, r.codigoAnth, r.carrerasComparten,
        r.prereq, r.codigo, r.horasTeo, r.horasPra, r.horasAut, r.creditos,
        r.campoForm, r.ciclo, r.ordenMalla, r.paralelo, r.dia, r.hora, r.modalidad, r.nroHoras
      ];
      cells.forEach(v => {
        const td = document.createElement('td');
        td.textContent = (v===undefined || v===null)? '': String(v);
        tr.appendChild(td);
      });
      frag.appendChild(tr);
    });
    tblBody.appendChild(frag);
  }

  let wbMallas = null, wbDocentes=null;
  fileMallas.addEventListener('change', ()=>{
    btnGenerar.disabled = !(fileMallas.files[0] && fileDocentes.files[0]);
  });
  fileDocentes.addEventListener('change', ()=>{
    btnGenerar.disabled = !(fileMallas.files[0] && fileDocentes.files[0]);
  });

  btnLimpiar.addEventListener('click', ()=>{
    tblBody.innerHTML = '';
    logEl.textContent = '';
    fileMallas.value = '';
    fileDocentes.value = '';
    btnGenerar.disabled = true;
  });

  btnGenerar.addEventListener('click', async ()=>{
    try{
      tblBody.innerHTML = '';
      logEl.textContent = 'Procesando archivos…\n';
      const [wb1, wb2] = await Promise.all([
        readWorkbook(fileMallas.files[0]),
        readWorkbook(fileDocentes.files[0])
      ]);
      log('Archivos leídos. Extrayendo datos…');

      const rawMallas   = sheetToJSONAllSheets(wb1);
      const rawDocentes = sheetToJSONAllSheets(wb2);

      if(rawMallas.length===0){ log('No se encontraron filas en Mallas.'); return; }
      if(rawDocentes.length===0){ log('No se encontraron filas en Docentes.'); }

      const materias = buildMaterias(rawMallas);
      const docentes = buildDocentes(rawDocentes);

      log(`Materias detectadas: ${materias.length}`);
      log(`Docentes detectados: ${docentes.list.length}`);
      if(docentes.availHeaders && docentes.availHeaders.length){
        const ah = docentes.availHeaders.map(a=>`${a.day} ${a.range}`).join(', ');
        log(`Cabeceras de disponibilidad detectadas: ${ah}`);
      }else{
        log('No se detectaron cabeceras de disponibilidad. Se intentará asignar sin restricciones de disponibilidad.');
      }

      const rows = schedule(materias, docentes);
      log(`Bloques asignados: ${rows.length}`);
      render(rows);
      log('Listo.');
    }catch(err){
      console.error(err);
      log('Error: ' + (err && err.message? err.message : String(err)));
    }
  });
})();
</script>
</body>
</html>
