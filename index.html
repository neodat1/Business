<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Combinación Docentes × Estudiantes (con cupos y paralelos)</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{--bd:#e2e8f0;--bg:#f7fafc;--pri:#2563eb;--tx:#0f172a}
  body{font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--tx);margin:0}
  .wrap{max-width:1200px;margin:auto;padding:20px}
  .card{background:#fff;border:1px solid var(--bd);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.04);padding:16px}
  h1{margin:0 0 10px;font-size:20px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 14px}
  input[type=file],button{padding:10px;border:1px solid var(--bd);border-radius:10px;background:#fff}
  button{background:var(--pri);color:#fff;border:none;cursor:pointer}
  button.secondary{background:#fff;color:#0f172a;border:1px solid var(--bd)}
  table{border-collapse:collapse;width:100%;margin-top:12px}
  th,td{border:1px solid var(--bd);padding:8px;vertical-align:top}
  th{background:#f1f5f9;text-align:left}
  .muted{color:#64748b;font-size:13px}
  .hidden{display:none}
  .grid{display:grid;gap:16px}
  @media(min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Combinación Docentes × Estudiantes</h1>
    <div class="row">
      <label><b>PLANIFICACIÓN - DOCENTES.xlsx</b><br><input id="fileDoc" type="file" accept=".xlsx,.xls"></label>
      <label><b>PLANIFICACIÓN - ESTUDIANTES.xlsx</b><br><input id="fileEst" type="file" accept=".xlsx,.xls"></label>
      <label><b>(Opcional) Mallas.xlsx</b><br><input id="fileMal" type="file" accept=".xlsx,.xls"></label>
    </div>
    <div class="row">
      <button id="btnRun">Procesar</button>
      <button id="btnDown" class="secondary hidden">Descargar (.xlsx)</button>
    </div>
    <p class="muted">
      Salidas:
      <br>• <b>MATRIZ_SECCIONES</b> (7 columnas): NOMBRE_DOCENTE, MATERIA, CANTIDAD DE ALUMNOS ESPERADOS, DIA, HORA, Modalidad, Paralelo.
      <br>• <b>COMBINACION</b>: las 7 anteriores + ESTUDIANTE.
      <br>• <b>RESUMEN_CARGA</b>: carga por docente (secciones, asignados, capacidad).
      <br>• <b>RESUMEN_MATERIA</b>: alumnos por materia/paralelo y ocupación (%).
      <br>• <b>NO_ASIGNADOS</b>: estudiante y materia cuando no hay cupo ni sección.
    </p>
  </div>

  <div class="grid" style="margin-top:16px">
    <div class="card">
      <h3>Previsualización — COMBINACION</h3>
      <div id="tblCombo"></div>
    </div>
    <div class="card">
      <h3>Resumen — Carga por Docente</h3>
      <div id="tblCarga"></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>No Asignados</h3>
    <div id="tblNo"></div>
  </div>
</div>

<script>
// ===================== Utilidades generales =====================
const TARGET7 = ["NOMBRE_DOCENTE","MATERIA","CANTIDAD DE ALUMNOS ESPERADOS","DIA","HORA","Modalidad","Paralelo"];
const COMBO8  = [...TARGET7,"ESTUDIANTE"];
const DAY_MAP = new Map(Object.entries({
  "lun":"LUNES","lunes":"LUNES","lun.":"LUNES",
  "mar":"MARTES","martes":"MARTES","mar.":"MARTES",
  "mie":"MIERCOLES","mié":"MIERCOLES","miercoles":"MIERCOLES","miércoles":"MIERCOLES","mie.":"MIERCOLES","mié.":"MIERCOLES",
  "jue":"JUEVES","jueves":"JUEVES","jue.":"JUEVES",
  "vie":"VIERNES","viernes":"VIERNES","vie.":"VIERNES",
  "sab":"SABADO","sáb":"SABADO","sabado":"SABADO","sábado":"SABADO","sab.":"SABADO",
  "dom":"DOMINGO","domingo":"DOMINGO","dom.":"DOMINGO"
}));
const canonDay = s=>{const t=String(s||"").toLowerCase(); if(DAY_MAP.has(t)) return DAY_MAP.get(t); for(const [k,v] of DAY_MAP.entries()){ if(t.includes(k)) return v;} return String(s||"").toUpperCase().trim();};
const esc = s=> String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
const numberToLetter = n => String.fromCharCode(65 + ((n-1)%26)); // 1->A

const readSheet = (file)=>new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=e=>{ const data=new Uint8Array(e.target.result); const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; res(XLSX.utils.sheet_to_json(ws,{defval:""})); }; fr.onerror=rej; fr.readAsArrayBuffer(file);});

function renderTable(el, headers, rows){ if(!rows.length){ el.innerHTML='<p class="muted">Sin datos.</p>'; return;} let html='<table><thead><tr>'+headers.map(h=>`<th>${esc(h)}</th>`).join('')+'</tr></thead><tbody>'; for(const r of rows){ html+='<tr>'+headers.map(h=>`<td>${esc(r[h]??'')}</td>`).join('')+'</tr>'; } html+='</tbody></table>'; el.innerHTML=html; }

// ===================== Normalización =====================
function normalizeDocentes(rows){
  return rows.map(r=>({
    "NOMBRE_DOCENTE": r["NOMBRE_DOCENTE"]||r["DOCENTE"]||r["Docente"]||r["Profesor"]||"",
    "MATERIA": r["MATERIA"]||r["ASIGNATURA"]||r["Materia"]||"",
    "CANTIDAD DE ALUMNOS ESPERADOS": Number(r["CANTIDAD DE ALUMNOS ESPERADOS"]||r["CAPACIDAD"]||r["CUPOS"]||40)||40,
    "DIA": canonDay(r["DIA"]||r["Dia"]||r["Día"]||r["DIA1"]||""),
    "HORA": r["HORA"]||r["Horario"]||"",
    "Modalidad": r["Modalidad"]||r["MODALIDAD"]||"",
    "Paralelo": String(r["Paralelo"]||r["PARALELO"]||r["Grupo"]||"").toUpperCase().trim()
  })).filter(x=>x.MATERIA && x.DIA && x.HORA);
}

function normalizeEstudiantes(rows){
  return rows.map(r=>({
    "ESTUDIANTE": r["ESTUDIANTE"]||r["NOMBRE_ESTUDIANTE"]||r["Nombre"]||"",
    "MATERIAS": String(r["MATERIAS"]||r["MATERIA"]||r["ASIGNATURAS"]||r["ASIGNATURA"]||"")
                  .split(/,|;|\n|\//).map(s=>s.trim()).filter(Boolean),
    "Paralelo": String(r["Paralelo"]||r["PARALELO"]||"").toUpperCase().trim()
  })).filter(x=>x.ESTUDIANTE && x.MATERIAS.length);
}

function normalizeMallas(rows){
  return rows.map(r=>({
    "MATERIA": r["MATERIA"]||r["ASIGNATURA"]||"",
    "DIA": canonDay(r["DIA"]||r["Dia"]||r["Día"]||""),
    "HORA": r["HORA"]||r["Horario"]||"",
    "Paralelo": String(r["Paralelo"]||r["PARALELO"]||"").toUpperCase().trim(),
    "CAPACIDAD": Number(r["CAPACIDAD"]||r["CUPOS"]||0)||0
  })).filter(x=>x.MATERIA && x.DIA && x.HORA);
}

// ===================== Lógica de secciones y asignación =====================
function construirSecciones(docentes, mallas){
  // Unificamos secciones; si faltan en mallas pero existen en docentes, se usan de docentes.
  const key = (m,d,h,p)=>`${m}¦${d}¦${h}¦${p||''}`;
  const secciones = new Map();
  // Desde mallas
  for(const m of mallas){
    const k=key(m.MATERIA,m.DIA,m.HORA,m.Paralelo);
    if(!secciones.has(k)) secciones.set(k,{
      MATERIA:m.MATERIA,DIA:m.DIA,HORA:m.HORA,Paralelo:m.Paralelo||"",
      NOMBRE_DOCENTE:"",Modalidad:"", CAP:m.CAPACIDAD||0, ASIGNADOS:0
    });
  }
  // Desde docentes
  for(const d of docentes){
    const k=key(d.MATERIA,d.DIA,d.HORA,d.Paralelo);
    const cap = d["CANTIDAD DE ALUMNOS ESPERADOS"]||40;
    if(!secciones.has(k)) secciones.set(k,{
      MATERIA:d.MATERIA,DIA:d.DIA,HORA:d.HORA,Paralelo:d.Paralelo||"",
      NOMBRE_DOCENTE:d.NOMBRE_DOCENTE,Modalidad:d.Modalidad||"", CAP:cap, ASIGNADOS:0
    });
    else{
      const s=secciones.get(k);
      s.NOMBRE_DOCENTE = s.NOMBRE_DOCENTE||d.NOMBRE_DOCENTE;
      s.Modalidad = s.Modalidad||d.Modalidad||"";
      s.CAP = Math.max(s.CAP||0, cap||0) || cap || 40;
    }
  }
  return Array.from(secciones.values());
}

function agruparPorMateria(secciones){
  const map=new Map();
  for(const s of secciones){
    if(!map.has(s.MATERIA)) map.set(s.MATERIA,[]);
    map.get(s.MATERIA).push(s);
  }
  return map;
}

function asignarEstudiantes(secciones, estudiantes){
  // Distribuye por materia priorizando: paralelo pedido -> más cupo libre -> orden estable.
  const idxPorMateria = agruparPorMateria(secciones);
  const asignaciones=[]; const noAsig=[];

  // Índice rápido para carga docente
  const kCarga=(d,m,par,h)=>`${d}¦${m}¦${par||''}¦${h}`;
  const carga=new Map();
  for(const s of secciones){
    const key=kCarga(s.NOMBRE_DOCENTE||"SIN_DOCENTE", s.MATERIA, s.Paralelo, s.HORA);
    if(!carga.has(key)) carga.set(key,{DOCENTE:s.NOMBRE_DOCENTE||"SIN_DOCENTE",MATERIA:s.MATERIA,Paralelo:s.Paralelo||"",DIA:s.DIA,HORA:s.HORA,ASIGNADOS:0,CAP:s.CAP||0});
  }

  for(const e of estudiantes){
    for(const mat of e.MATERIAS){
      const bucket = (idxPorMateria.get(mat)||[]).slice();
      if(!bucket.length){
        noAsig.push({ESTUDIANTE:e.ESTUDIANTE,MATERIA:mat,MOTIVO:"Sin secciones"});
        continue;
      }
      // Ordenar por preferencia de paralelo (si trae), luego mayor cupo disponible
      bucket.sort((a,b)=>{
        const pref = e.Paralelo||"";
        const hitA = pref && (a.Paralelo||"")===pref ? 1:0;
        const hitB = pref && (b.Paralelo||"")===pref ? 1:0;
        if(hitA!==hitB) return hitB-hitA; // primero el que coincide
        const freeA=(a.CAP||0)-(a.ASIGNADOS||0), freeB=(b.CAP||0)-(b.ASIGNADOS||0);
        if(freeA!==freeB) return freeB-freeA;
        // Tiebreak: paralelo alfabético
        return (a.Paralelo||"").localeCompare(b.Paralelo||"");
      });

      let placed=false;
      for(const s of bucket){
        const free=(s.CAP||0)-(s.ASIGNADOS||0);
        if(free<=0) continue; // lleno
        s.ASIGNADOS=(s.ASIGNADOS||0)+1; placed=true;
        asignaciones.push({
          ESTUDIANTE:e.ESTUDIANTE,
          NOMBRE_DOCENTE:s.NOMBRE_DOCENTE||"",
          MATERIA:s.MATERIA,
          "CANTIDAD DE ALUMNOS ESPERADOS": s.CAP||"",
          DIA:s.DIA,
          HORA:s.HORA,
          Modalidad:s.Modalidad||"",
          Paralelo:s.Paralelo||""
        });
        const key=kCarga(s.NOMBRE_DOCENTE||"SIN_DOCENTE", s.MATERIA, s.Paralelo, s.HORA); carga.get(key).ASIGNADOS++;
        break;
      }
      if(!placed){
        noAsig.push({ESTUDIANTE:e.ESTUDIANTE,MATERIA:mat,MOTIVO:"Sin cupo"});
      }
    }
  }

  // Resúmenes
  const cargaDocente = Array.from(carga.values()).sort((a,b)=> a.DOCENTE.localeCompare(b.DOCENTE)||a.MATERIA.localeCompare(b.MATERIA)||a.Paralelo.localeCompare(b.Paralelo));
  const resumenMateria = (()=>{
    const map=new Map();
    for(const s of secciones){
      const k=`${s.MATERIA}¦${s.Paralelo||''}`;
      if(!map.has(k)) map.set(k,{MATERIA:s.MATERIA,Paralelo:s.Paralelo||"",ASIGNADOS:0,CAP:0,OCUPACION:"0%"});
      const o=map.get(k); o.CAP+=(s.CAP||0); o.ASIGNADOS+=(s.ASIGNADOS||0);
    }
    return Array.from(map.values()).map(r=>{ const occ = (r.CAP? Math.round((r.ASIGNADOS/r.CAP)*100):0)+"%"; return {...r,OCUPACION:occ}; })
                 .sort((a,b)=> a.MATERIA.localeCompare(b.MATERIA)||a.Paralelo.localeCompare(b.Paralelo));
  })();

  return {asignaciones, noAsig, cargaDocente, resumenMateria, secciones};
}

// ===================== Interfaz =====================
let OUT_SECC=[], OUT_COMB=[], OUT_CARGA=[], OUT_RES_MAT=[], OUT_NO=[];

document.getElementById('btnRun').addEventListener('click', async ()=>{
  const fD=document.getElementById('fileDoc').files[0];
  const fE=document.getElementById('fileEst').files[0];
  const fM=document.getElementById('fileMal').files[0];
  if(!fD || !fE){ alert('Carga DOCENTES y ESTUDIANTES. Mallas es opcional.'); return; }

  const [rowsD, rowsE, rowsM] = await Promise.all([
    readSheet(fD), readSheet(fE), fM? readSheet(fM): Promise.resolve([])
  ]);

  const DOC = normalizeDocentes(rowsD);
  const EST = normalizeEstudiantes(rowsE);
  const MAL = normalizeMallas(rowsM);

  const secciones = construirSecciones(DOC, MAL);
  const {asignaciones, noAsig, cargaDocente, resumenMateria, secciones:seccFinal} = asignarEstudiantes(secciones, EST);

  // MATRIZ_SECCIONES (7 columnas exactas)
  OUT_SECC = seccFinal.map(s=>({
    "NOMBRE_DOCENTE": s.NOMBRE_DOCENTE||"",
    "MATERIA": s.MATERIA,
    "CANTIDAD DE ALUMNOS ESPERADOS": s.CAP||"",
    "DIA": s.DIA,
    "HORA": s.HORA,
    "Modalidad": s.Modalidad||"",
    "Paralelo": s.Paralelo||""
  }));

  // COMBINACION (8 columnas)
  OUT_COMB = asignaciones.map(a=>({
    "NOMBRE_DOCENTE": a.NOMBRE_DOCENTE,
    "MATERIA": a.MATERIA,
    "CANTIDAD DE ALUMNOS ESPERADOS": a["CANTIDAD DE ALUMNOS ESPERADOS"],
    "DIA": a.DIA,
    "HORA": a.HORA,
    "Modalidad": a.Modalidad,
    "Paralelo": a.Paralelo,
    "ESTUDIANTE": a.ESTUDIANTE
  }));

  OUT_NO = noAsig;
  OUT_CARGA = cargaDocente;
  OUT_RES_MAT = resumenMateria;

  renderTable(document.getElementById('tblCombo'), COMBO8, OUT_COMB.slice(0,200)); // muestra hasta 200
  renderTable(document.getElementById('tblCarga'), ["DOCENTE","MATERIA","Paralelo","DIA","HORA","ASIGNADOS","CAP"], OUT_CARGA);
  renderTable(document.getElementById('tblNo'), ["ESTUDIANTE","MATERIA","MOTIVO"], OUT_NO);

  document.getElementById('btnDown').classList.remove('hidden');
});

document.getElementById('btnDown').addEventListener('click', ()=>{
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_SECC), 'MATRIZ_SECCIONES');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_COMB), 'COMBINACION');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_CARGA), 'RESUMEN_CARGA');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_RES_MAT), 'RESUMEN_MATERIA');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_NO), 'NO_ASIGNADOS');
  XLSX.writeFile(wb, 'Combinacion_Cupos_Paralelos.xlsx');
});
</script>
</body>
</html>
