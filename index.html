<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Sistema de Planificación Académica</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root {
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --primary-light: #dbeafe;
    --secondary: #64748b;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #0f172a;
    --light: #f8fafc;
    --border: #e2e8f0;
    --radius: 12px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    background: #f1f5f9;
    color: var(--dark);
    line-height: 1.6;
    padding: 0;
  }
  
  .app-container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 20px;
  }
  
  /* Header Styles */
  .app-header {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 24px;
    margin-bottom: 24px;
    border-left: 4px solid var(--primary);
  }
  
  .app-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .app-subtitle {
    color: var(--secondary);
    font-size: 16px;
    margin-bottom: 20px;
  }
  
  /* Card Styles */
  .card {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 24px;
    margin-bottom: 24px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }
  
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  
  .card-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--dark);
  }
  
  /* File Upload Styles */
  .file-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  .file-input-container {
    position: relative;
  }
  
  .file-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--dark);
  }
  
  .file-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    background: var(--light);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .file-input:hover {
    border-color: var(--primary);
    background: #f0f7ff;
  }
  
  .file-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    font-size: 14px;
  }
  
  .status-icon {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  
  .status-pending {
    background-color: var(--warning);
  }
  
  .status-success {
    background-color: var(--success);
  }
  
  /* Button Styles */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: var(--radius);
    border: none;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--primary-dark);
  }
  
  .btn-secondary {
    background: white;
    color: var(--dark);
    border: 1px solid var(--border);
  }
  
  .btn-secondary:hover {
    background: var(--light);
  }
  
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .btn-group {
    display: flex;
    gap: 12px;
    margin: 20px 0;
  }
  
  /* Progress Bar */
  .progress-container {
    width: 100%;
    height: 8px;
    background-color: var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin: 16px 0;
    display: none;
  }
  
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
    width: 0%;
    transition: width 0.4s ease;
    border-radius: 4px;
  }
  
  /* Stats Cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }
  
  .stat-card {
    background: var(--light);
    border-radius: var(--radius);
    padding: 16px;
    text-align: center;
    border-left: 4px solid var(--primary);
  }
  
  .stat-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
  }
  
  .stat-label {
    font-size: 14px;
    color: var(--secondary);
  }
  
  /* Configuration Panel */
  .config-panel {
    background: var(--light);
    border-radius: var(--radius);
    padding: 20px;
    margin: 20px 0;
  }
  
  .config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
  }
  
  .config-item {
    margin-bottom: 12px;
  }
  
  .config-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--dark);
  }
  
  .config-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s ease;
  }
  
  .config-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }
  
  .time-slots {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }
  
  .time-slot {
    padding: 6px 12px;
    background: var(--primary-light);
    color: var(--primary);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
  }
  
  /* Table Styles */
  .table-container {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin: 16px 0;
    max-height: 400px;
    overflow: auto;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  
  th {
    background: #f8fafc;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: var(--dark);
    position: sticky;
    top: 0;
    border-bottom: 2px solid var(--border);
  }
  
  td {
    padding: 12px;
    border-bottom: 1px solid var(--border);
  }
  
  tr:hover {
    background: #f1f5f9;
  }
  
  /* Alert Styles */
  .alert {
    padding: 16px;
    border-radius: var(--radius);
    margin: 16px 0;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  
  .alert-error {
    background: #fef2f2;
    color: var(--danger);
    border-left: 4px solid var(--danger);
  }
  
  .alert-info {
    background: #eff6ff;
    color: var(--primary);
    border-left: 4px solid var(--primary);
  }
  
  .alert-success {
    background: #f0fdf4;
    color: var(--success);
    border-left: 4px solid var(--success);
  }
  
  .alert-icon {
    font-size: 20px;
    flex-shrink: 0;
  }
  
  /* Badges */
  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .badge-primary {
    background: var(--primary-light);
    color: var(--primary);
  }
  
  .badge-success {
    background: #d1fae5;
    color: var(--success);
  }
  
  .badge-warning {
    background: #fef3c7;
    color: var(--warning);
  }
  
  .badge-danger {
    background: #fee2e2;
    color: var(--danger);
  }
  
  /* Grid Layout */
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
  }
  
  @media (min-width: 992px) {
    .grid-2 {
      grid-template-columns: 1fr 1fr;
    }
  }
  
  /* Utilities */
  .text-muted {
    color: var(--secondary);
    font-size: 14px;
  }
  
  .text-center {
    text-align: center;
  }
  
  .hidden {
    display: none;
  }
  
  .loading {
    opacity: 0.7;
    pointer-events: none;
  }
  
  .mt-2 {
    margin-top: 16px;
  }
  
  .mb-2 {
    margin-bottom: 16px;
  }
  
  /* Animation */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .fade-in {
    animation: fadeIn 0.3s ease;
  }
  
  /* Tabs */
  .tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    margin-bottom: 16px;
  }
  
  .tab {
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
  }
  
  .tab.active {
    border-bottom-color: var(--primary);
    color: var(--primary);
    font-weight: 600;
  }
  
  .tab-content {
    display: none;
  }
  
  .tab-content.active {
    display: block;
  }
  
  /* Instructions */
  .instructions {
    background: #f0f9ff;
    border-left: 4px solid var(--primary);
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  
  .instructions h3 {
    margin-bottom: 10px;
    color: var(--primary);
  }
  
  .instructions ul {
    padding-left: 20px;
  }
  
  .instructions li {
    margin-bottom: 8px;
  }
  
  /* Matrix table */
  .matrix-container {
    overflow: auto;
    max-height: 600px;
    margin: 20px 0;
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }
  
  .matrix-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 2200px;
  }
  
  .matrix-table th {
    background: #e0f2fe;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .matrix-table th:nth-child(1),
  .matrix-table th:nth-child(2) {
    background: #bae6fd;
  }
  
  .matrix-table th:nth-child(-n+5) {
    background: #7dd3fc;
  }
  
  .matrix-table th:nth-child(-n+10) {
    background: #38bdf8;
  }
  
  .matrix-table th:nth-child(-n+15) {
    background: #0ea5e9;
  }
  
  .section-header {
    background: #f8fafc;
    font-weight: 600;
    color: var(--primary);
  }
</style>
</head>
<body>
<div class="app-container">
  <header class="app-header">
    <h1 class="app-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="13" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      Sistema de Planificación Académica
    </h1>
    <p class="app-subtitle">Asignación automatizada de estudiantes a materias y docentes</p>
  </header>

  <div class="instructions">
    <h3>Instrucciones de uso:</h3>
    <ul>
      <li>Cargue los archivos Excel con los formatos especificados</li>
      <li>El sistema asignará las materias según el <strong>ciclo al que va</strong> cada estudiante</li>
      <li>Se respetará la disponibilidad de días y horas de los docentes</li>
      <li>Máximo de materias por estudiante: 6</li>
      <li>Máximo de estudiantes por paralelo: 25</li>
      <li>Horarios disponibles: 7:00-10:00, 10:00-13:00, 13:00-16:00, 16:00-19:00, 19:00-22:00</li>
    </ul>
  </div>

  <div class="card">
    <div class="alert alert-info">
      <span class="alert-icon">💡</span>
      <div>
        <strong>Nota:</strong> El sistema organizará automáticamente los horarios evitando cruces entre materias del mismo ciclo.
        Las materias se asignarán según el ciclo al que va cada estudiante y la disponibilidad de los docentes.
      </div>
    </div>

    <div class="alert alert-error hidden" id="errorBox">
      <span class="alert-icon">⚠️</span>
      <div>
        <strong>Error:</strong> <span id="errorMessage"></span>
      </div>
    </div>

    <div class="config-panel">
      <h3 class="card-title">Configuración del Sistema</h3>
      <div class="config-grid">
        <div class="config-item">
          <label class="config-label">Bloques de Horario Disponibles</label>
          <div class="time-slots">
            <span class="time-slot">07:00-10:00</span>
            <span class="time-slot">10:00-13:00</span>
            <span class="time-slot">13:00-16:00</span>
            <span class="time-slot">16:00-19:00</span>
            <span class="time-slot">19:00-22:00</span>
          </div>
        </div>
        
        <div class="config-item">
          <label class="config-label" for="maxMaterias">Máximo de materias por estudiante</label>
          <input type="number" id="maxMaterias" class="config-input" value="6" min="1" max="10">
        </div>
        
        <div class="config-item">
          <label class="config-label" for="capacidadParalelo">Capacidad máxima por paralelo</label>
          <input type="number" id="capacidadParalelo" class="config-input" value="25" min="10" max="25">
        </div>
      </div>
    </div>

    <div class="file-section">
      <div class="file-input-container">
        <label class="file-label">DOCENTES.xlsx</label>
        <input id="fileDoc" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status" id="statusDoc">
          <span class="status-icon status-pending"></span>
          <span>Esperando archivo...</span>
        </div>
      </div>
      
      <div class="file-input-container">
        <label class="file-label">ESTUDIANTES.xlsx</label>
        <input id="fileEst" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status" id="statusEst">
          <span class="status-icon status-pending"></span>
          <span>Esperando archivo...</span>
        </div>
      </div>
      
      <div class="file-input-container">
        <label class="file-label">MALLA.xlsx</label>
        <input id="fileMal" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status" id="statusMal">
          <span class="status-icon status-pending"></span>
          <span>Esperando archivo...</span>
        </div>
      </div>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="btn-group">
      <button id="btnRun" class="btn btn-primary" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Procesar Asignación
      </button>
      <button id="btnDown" class="btn btn-secondary hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Descargar Planificación
      </button>
    </div>

    <div class="stats-grid" id="statsContainer" style="display: none;">
      <div class="stat-card">
        <div class="stat-value" id="statSecciones">0</div>
        <div class="stat-label">Secciones creadas</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statAsignaciones">0</div>
        <div class="stat-label">Asignaciones realizadas</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statNoAsignados">0</div>
        <div class="stat-label">Estudiantes no asignados</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statOcupacion">0%</div>
        <div class="stat-label">Ocupación promedio</div>
      </div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="asignaciones">Asignaciones</div>
    <div class="tab" data-tab="carga-docente">Carga Docente</div>
    <div class="tab" data-tab="resumen-materia">Resumen por Materia</div>
    <div class="tab" data-tab="no-asignados">No Asignados</div>
    <div class="tab" data-tab="matriz-completa">Matriz Completa</div>
  </div>

  <div class="tab-content active" id="asignaciones">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Asignaciones Realizadas</h3>
        <span class="badge badge-primary" id="asignacionesCount">0</span>
      </div>
      <div class="table-container">
        <div id="tblCombo"></div>
      </div>
    </div>
  </div>
  
  <div class="tab-content" id="carga-docente">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Carga por Docente</h3>
        <span class="badge badge-primary" id="docentesCount">0</span>
      </div>
      <div class="table-container">
        <div id="tblCarga"></div>
      </div>
    </div>
  </div>
  
  <div class="tab-content" id="resumen-materia">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Resumen por Materia</h3>
        <span class="badge badge-primary" id="materiasCount">0</span>
      </div>
      <div class="table-container">
        <div id="tblResumenMateria"></div>
      </div>
    </div>
  </div>
  
  <div class="tab-content" id="no-asignados">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">No Asignados</h3>
        <span class="badge badge-danger" id="noAsignadosCount">0</span>
      </div>
      <div class="table-container">
        <div id="tblNo"></div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="matriz-completa">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Matriz Completa de Asignación</h3>
        <span class="badge badge-primary" id="matrizCount">0</span>
      </div>
      <div class="matrix-container">
        <table class="matrix-table" id="tblMatriz">
          <thead>
            <tr>
              <th>DOCENTE</th>
              <th>DEDICACIÓN</th>
              <th>MATERIA</th>
              <th>CÓDIGO ANTHOLOGY</th>
              <th>CARRERAS QUE COMPARTEN</th>
              <th>PRE-REQUISITO</th>
              <th>CODIGO</th>
              <th>HORAS TEÓRICAS</th>
              <th>HORAS PRÁCTICAS</th>
              <th>HORAS AUTÓNOMAS</th>
              <th>CREDITOS</th>
              <th>CAMPO DE FORMACIÓN</th>
              <th>CICLO</th>
              <th>MALLA</th>
              <th>Nº ORDEN EN LA MALLA</th>
              <th>PARALELO</th>
              <th>DIA</th>
              <th>HORA</th>
              <th>Modalidad</th>
              <th>Nro. HORAS</th>
              <th>NOMBRE DEL ESTUDIANTE</th>
              <th>CARRERA DEL ESTUDIANTE</th>
              <th>CICLO DEL ESTUDIANTE</th>
              <th>NIVEL INGLES</th>
              <th>OBSERVACIONES</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="25" style="text-align: center; padding: 20px; color: var(--secondary);">
                Cargue los archivos y procese la asignación para ver la matriz completa
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// ===================== Constantes y Utilidades =====================
let __DOCENTE_SLOTS__ = new Map(); // Map<Docente, Map<DIA, Set<HORA>>>
const TARGET7 = ["NOMBRE_DOCENTE","MATERIA","CANTIDAD DE ALUMNOS ESPERADOS","DIA","HORA","Modalidad","Paralelo"];
const COMBO9  = [...TARGET7,"ESTUDIANTE","CICLO"];
const DAY_MAP = new Map(Object.entries({
  "lun":"LUNES","lunes":"LUNES","lun.":"LUNES",
  "mar":"MARTES","martes":"MARTES","mar.":"MARTES",
  "mie":"MIERCOLES","mié":"MIERCOLES","miercoles":"MIERCOLES","miércoles":"MIERCOLES","mie.":"MIERCOLES","mié.":"MIERCOLES",
  "jue":"JUEVES","jueves":"JUEVES","jue.":"JUEVES",
  "vie":"VIERNES","viernes":"VIERNES","vie.":"VIERNES",
  "sab":"SABADO","sáb":"SABADO","sabado":"SABADO","sábado":"SABADO","sab.":"SABADO",
  "dom":"DOMINGO","domingo":"DOMINGO","dom.":"DOMINGO"
}));

// Horarios predefinidos en bloques de 3 horas
const HORARIOS = [
  "07:00-10:00", "10:00-13:00", "13:00-16:00", 
  "16:00-19:00", "19:00-22:00"
];

// Función para convertir horarios a bloques de 3 horas
function normalizarHorario(horario) {
  if (!horario) return HORARIOS[0]; // Valor por defecto
  
  const horarioStr = String(horario).toUpperCase().trim();
  
  // Si ya es un horario válido, devolverlo
  if (HORARIOS.includes(horarioStr)) {
    return horarioStr;
  }
  
  // Intentar parsear horarios como "07:00-22:00" o "14:00-22:00"
  const match = horarioStr.match(/(\d{1,2}):(\d{2})\s*[-–a]+\s*(\d{1,2}):(\d{2})/);
  if (match) {
    const horaInicio = parseInt(match[1],10);
    for (const bloque of HORARIOS) {
      const bloqueMatch = bloque.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
      if (bloqueMatch) {
        const bloqueInicio = parseInt(bloqueMatch[1],10);
        if (horaInicio === bloqueInicio) return bloque;
      }
    }
  }
  // Si no se puede determinar, usar el primer bloque
  return HORARIOS[0];
}

// Utilidades mejoradas
const canonDay = s => {
  if (!s) return "";
  const t = String(s).toLowerCase().trim();
  if (DAY_MAP.has(t)) return DAY_MAP.get(t);
  for (const [k, v] of DAY_MAP.entries()) {
    if (t.includes(k)) return v;
  }
  return t.toUpperCase();
};

const esc = s => {
  if (s === null || s === undefined) return "";
  return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
};

// Función para mostrar errores
function showError(message) {
  const errorBox = document.getElementById('errorBox');
  const errorMessage = document.getElementById('errorMessage');
  errorMessage.textContent = message;
  errorBox.classList.remove('hidden');
  setTimeout(() => { errorBox.classList.add('hidden'); }, 8000);
}

// Función para mostrar éxito
function showSuccess(message) {
  const alertBox = document.createElement('div');
  alertBox.className = 'alert alert-success fade-in';
  alertBox.innerHTML = `
    <span class="alert-icon">✅</span>
    <div>${message}</div>
  `;
  document.querySelector('.card').prepend(alertBox);
  setTimeout(() => { alertBox.remove(); }, 5000);
}

// Función para actualizar la barra de progreso
function updateProgress(percent) {
  const progressBar = document.getElementById('progressBar');
  const progressContainer = document.getElementById('progressContainer');
  progressBar.style.width = percent + '%';
  progressContainer.style.display = 'block';
}

// Función para mostrar estadísticas
function updateStats(secciones, asignaciones, noAsig, resumenMateria) {
  document.getElementById('statsContainer').style.display = 'grid';
  document.getElementById('statSecciones').textContent = secciones.length;
  document.getElementById('statAsignaciones').textContent = asignaciones.length;
  document.getElementById('statNoAsignados').textContent = noAsig.length;
  
  // Actualizar contadores en los headers
  document.getElementById('asignacionesCount').textContent = asignaciones.length;
  document.getElementById('docentesCount').textContent = new Set(asignaciones.map(a => a.NOMBRE_DOCENTE)).size;
  document.getElementById('materiasCount').textContent = new Set(asignaciones.map(a => a.MATERIA)).size;
  document.getElementById('noAsignadosCount').textContent = noAsig.length;
  document.getElementById('matrizCount').textContent = asignaciones.length;
  
  // Calcular ocupación promedio
  let totalCap = 0;
  let totalAsig = 0;
  resumenMateria.forEach(m => { totalCap += m.CAP; totalAsig += m.ASIGNADOS; });
  const ocupacionPromedio = totalCap > 0 ? Math.round((totalAsig / totalCap) * 100) : 0;
  document.getElementById('statOcupacion').textContent = ocupacionPromedio + '%';
}

// Función para validar archivos
function validateFiles() {
  const fD = document.getElementById('fileDoc').files[0];
  const fE = document.getElementById('fileEst').files[0];
  const fM = document.getElementById('fileMal').files[0];
  const btnRun = document.getElementById('btnRun');
  btnRun.disabled = !(fD && fE && fM);
}

// Función para actualizar el estado de los archivos
function updateFileStatus(inputId, statusId, isRequired) {
  const input = document.getElementById(inputId);
  const status = document.getElementById(statusId);
  const icon = status.querySelector('.status-icon');
  input.addEventListener('change', function() {
    if (this.files.length > 0) {
      icon.className = 'status-icon status-success';
      status.querySelector('span:last-child').textContent = this.files[0].name;
    } else {
      icon.className = 'status-icon status-pending';
      status.querySelector('span:last-child').textContent = isRequired ? 
        'Esperando archivo...' : 'Opcional - Esperando archivo...';
    }
    validateFiles();
  });
}

// Función para renderizar tablas con mejoras
function renderTable(el, headers, rows, maxRows = 100) {
  if (!rows || !rows.length) {
    el.innerHTML = '<p class="text-muted text-center">No hay datos para mostrar.</p>';
    return;
  }
  const displayRows = rows.slice(0, maxRows);
  const hasMore = rows.length > maxRows;
  let html = `
    <table>
      <thead>
        <tr>${headers.map(h => `<th>${esc(h)}</th>`).join('')}</tr>
      </thead>
      <tbody>
  `;
  for (const r of displayRows) {
    html += `<tr>${headers.map(h => `<td>${esc(r[h] ?? '')}</td>`).join('')}</tr>`;
  }
  html += `</tbody></table>`;
  if (hasMore) {
    html += `<p class="text-muted text-center">Mostrando ${maxRows} de ${rows.length} registros. Descargue el archivo para ver todos.</p>`;
  }
  el.innerHTML = html;
}

// Función para renderizar la matriz completa
function renderMatrizTable(asignaciones) {
  const el = document.getElementById('tblMatriz');
  const tbody = el.querySelector('tbody');
  if (!asignaciones || !asignaciones.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="25" style="text-align: center; padding: 20px; color: var(--secondary);">
          No hay datos para mostrar
        </td>
      </tr>
    `;
    return;
  }
  let html = '';
  for (const r of asignaciones) {
    html += `
      <tr>
        <td>${esc(r.NOMBRE_DOCENTE || '')}</td>
        <td>${esc(r.DEDICACIÓN || '')}</td>
        <td>${esc(r.MATERIA || '')}</td>
        <td>${esc(r['CÓDIGO ANTHOLOGY'] || '')}</td>
        <td>${esc(r['CARRERAS QUE COMPARTEN'] || '')}</td>
        <td>${esc(r['PRE-REQUISITO'] || '')}</td>
        <td>${esc(r.CODIGO || '')}</td>
        <td>${esc(r['HORAS TEÓRICAS'] || '')}</td>
        <td>${esc(r['HORAS PRÁCTICAS'] || '')}</td>
        <td>${esc(r['HORAS AUTÓNOMAS'] || '')}</td>
        <td>${esc(r.CREDITOS || '')}</td>
        <td>${esc(r['CAMPO DE FORMACIÓN'] || '')}</td>
        <td>${esc(r.CICLO || '')}</td>
        <td>${esc(r.MALLA || '')}</td>
        <td>${esc(r['Nº ORDEN EN LA MALLA'] || '')}</td>
        <td>${esc(r.Paralelo || '')}</td>
        <td>${esc(r.DIA || '')}</td>
        <td>${esc(r.HORA || '')}</td>
        <td>${esc(r.Modalidad || '')}</td>
        <td>${esc(r['Nro. HORAS'] || '')}</td>
        <td>${esc(r.ESTUDIANTE || '')}</td>
        <td>${esc(r['CARRERA DEL ESTUDIANTE'] || '')}</td>
        <td>${esc(r['CICLO DEL ESTUDIANTE'] || '')}</td>
        <td>${esc(r['NIVEL INGLES'] || '')}</td>
        <td>${esc(r.OBSERVACIONES || '')}</td>
      </tr>
    `;
  }
  tbody.innerHTML = html;
}

// Leer archivo Excel con mejor manejo de errores
const readSheet = (file, fileName) => new Promise((resolve, reject) => {
  if (!file) { resolve([]); return; }
  const fr = new FileReader();
  fr.onload = e => {
    try {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      if (!wb.SheetNames || wb.SheetNames.length === 0) {
        reject(new Error(`El archivo ${fileName} no contiene hojas válidas.`));
        return;
      }
      const ws = wb.Sheets[wb.SheetNames[0]];
      if (!ws || !ws['!ref']) {
        reject(new Error(`La hoja del archivo ${fileName} está vacía.`));
        return;
      }
      const jsonData = XLSX.utils.sheet_to_json(ws, { defval: "" });
      if (!jsonData || jsonData.length === 0) {
        reject(new Error(`No se pudieron extraer datos del archivo ${fileName}. Verifique el formato.`));
        return;
      }
      console.log(`Datos leídos de ${fileName}:`, jsonData);
      resolve(jsonData);
    } catch (error) {
      console.error(`Error leyendo archivo ${fileName}:`, error);
      reject(new Error(`Error al leer el archivo ${fileName}: ${error.message}`));
    }
  };
  fr.onerror = () => { reject(new Error(`Error al leer el archivo ${fileName}.`)); };
  fr.readAsArrayBuffer(file);
});

// ===================== Normalización =====================
function normalizeDocentes(rows) {
  console.log("Normalizando docentes:", rows);
  if (!rows || !rows.length) {
    showError("El archivo de docentes está vacío o no tiene el formato correcto.");
    return [];
  }
  const result = rows.map(r => {
    let diasDisponibles = [];
    let horasDisponibles = [];
    if (r["DIA DISPONIBLE"] || r["DIA"]) {
      const textoDias = String(r["DIA DISPONIBLE"] || r["DIA"] || "").toUpperCase();
      if (textoDias.includes("LUNES A VIERNES")) ["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES"].forEach(d=>diasDisponibles.push(d));
      if (textoDias.includes("LUNES")) diasDisponibles.push("LUNES");
      if (textoDias.includes("MARTES")) diasDisponibles.push("MARTES");
      if (textoDias.includes("MIERCOLES") || textoDias.includes("MIÉRCOLES")) diasDisponibles.push("MIERCOLES");
      if (textoDias.includes("JUEVES")) diasDisponibles.push("JUEVES");
      if (textoDias.includes("VIERNES")) diasDisponibles.push("VIERNES");
      if (textoDias.includes("SABADO") || textoDias.includes("SÁBADO")) diasDisponibles.push("SABADO");
    }
    if (r["HORA DISPONIBLE"] || r["HORA"]) {
      const textoHoras = String(r["HORA DISPONIBLE"] || r["HORA"] || "").toUpperCase();
      const horaMatch = textoHoras.match(/(\d{1,2}):(\d{2})\s*[-–a]+\s*(\d{1,2}):(\d{2})/);
      if (horaMatch) {
        const rango = `${horaMatch[1].padStart(2,'0')}:${horaMatch[2]}-${horaMatch[3].padStart(2,'0')}:${horaMatch[4]}`;
        horasDisponibles.push(normalizarHorario(rango));
      } else if (textoHoras.includes("07:00") && textoHoras.includes("22:00")) {
        horasDisponibles = [...HORARIOS];
      } else {
        horasDisponibles = [...HORARIOS];
      }
    }
    if (diasDisponibles.length === 0) diasDisponibles = ["LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES"];
    return {
      "NOMBRE_DOCENTE": r["NOMBRE_DOCENTE"] || r["DOCENTE"] || "",
      "MATERIA": r["MATERIA"] || r["MATERIAS"] || "",
      "CANTIDAD DE ALUMNOS ESPERADOS": Number(r["CANTIDAD DE ALUMNOS ESPERADOS"] || r["CAPACIDAD"] || r["CUPOS"] || 25) || 25,
      "DIA_DISPONIBLE": diasDisponibles,
      "HORA_DISPONIBLE": horasDisponibles,
      "Modalidad": r["Modalidad"] || "PRESENCIAL",
      "Paralelo": String(r["Paralelo"] || "").toUpperCase().trim() || "A",
      "DEDICACIÓN": r["DEDICACIÓN"] || ""
    };
  }).filter(x => x.MATERIA && x.NOMBRE_DOCENTE);
  console.log("Docentes normalizados:", result);
  if (result.length === 0) showError("No se encontraron datos válidos en el archivo de docentes.");
  return result;
}

function normalizeEstudiantes(rows) {
  console.log("Normalizando estudiantes:", rows);
  if (!rows || !rows.length) {
    showError("El archivo de estudiantes está vacío o no tiene el formato correcto.");
    return [];
  }
  const result = rows.map(r => {
    const ciclo = Number(r["CICLO AL QUE VA"] || r["CICLO ACTUAL"] || r["CICLO"] || 1);
    return {
      "ESTUDIANTE": r["ESTUDIANTE"] || r["NOMBRE"] || r["NOMBRE DEL ESTUDIANTE"] || "",
      "CICLO": isNaN(ciclo) ? 1 : Math.max(1, Math.min(8, ciclo)),
      "CARRERA": r["CARRERA"] || r["CARRERA DEL ESTUDIANTE"] || "",
      "MALLA": r["MALLA"] || "",
      "NIVEL INGLES": r["NIVEL INGLES"] || ""
    };
  }).filter(x => x.ESTUDIANTE);
  console.log("Estudiantes normalizados:", result);
  if (result.length === 0) showError("No se encontraron datos válidos en el archivo de estudiantes.");
  return result;
}

function normalizeMallas(rows) {
  console.log("Normalizando mallas:", rows);
  if (!rows || !rows.length) {
    showError("El archivo de mallas está vacío o no tiene el formato correcto.");
    return [];
  }
  const result = rows.map(r => {
    const materia = r["MATERIA"] || r["MATERIAS"] || "";
    const codigo = r["CÓDIGO"] || r["CODIGO"] || r["CÓDIGO ANTHOLOGY"] || "";
    let ciclo = 1;
    if (codigo) {
      const partes = codigo.split('-');
      if (partes.length >= 2) {
        const numCiclo = parseInt(partes[1],10);
        if (!isNaN(numCiclo)) ciclo = numCiclo;
      }
    }
    if (isNaN(ciclo) || ciclo < 1) ciclo = Number(r["CICLO"] || 1);
    return {
      "MATERIA": materia,
      "CODIGO": codigo,
      "CICLO": Math.max(1, Math.min(8, ciclo)),
      "HORAS_TEORICAS": Number(r["HORAS TEÓRICAS"] || r["HORAS_TEORICAS"] || 0),
      "HORAS_PRACTICAS": Number(r["HORAS PRÁCTICAS"] || r["HORAS_PRACTICAS"] || 0),
      "HORAS AUTÓNOMAS": Number(r["HORAS AUTÓNOMAS"] || 0),
      "CREDITOS": Number(r["CREDITOS"] || 0),
      "CAMPO DE FORMACIÓN": r["CAMPO DE FORMACIÓN"] || "",
      "MALLA": r["MALLA"] || "",
      "Nº ORDEN EN LA MALLA": r["Nº ORDEN EN LA MALLA"] || "",
      "PRE-REQUISITO": r["PRE-REQUISITO"] || "",
      "CARRERAS QUE COMPARTEN": r["CARRERAS QUE COMPARTEN"] || ""
    };
  }).filter(x => x.MATERIA);
  console.log("Mallas normalizadas:", result);
  if (result.length === 0) showError("No se encontraron datos válidos en el archivo de mallas.");
  return result;
}

// ===================== Lógica de secciones y asignación =====================
function construirSecciones(docentes, mallas, estudiantes) {
  __DOCENTE_SLOTS__ = new Map(); // reset por corrida
  const secciones = [];
  const horariosOcupados = new Map(); // Map<ciclo, Map<dia, Set<hora>>>
  const capacidadPorParalelo = parseInt(document.getElementById('capacidadParalelo').value) || 25;

  // Inicializar estructura de horarios por ciclo
  for (let ciclo = 1; ciclo <= 8; ciclo++) {
    horariosOcupados.set(ciclo, new Map());
  }

  // Índices auxiliares
  const seccionesPorDocente = new Map();            // Map<docente, conteoDeSecciones>
  const correlativoParalelo = new Map();            // Map<`${materia}¦${ciclo}`, cantidadGenerada>

  // Agrupar estudiantes por ciclo
  const estudiantesPorCiclo = new Map();
  for (const e of estudiantes) {
    if (!estudiantesPorCiclo.has(e.CICLO)) estudiantesPorCiclo.set(e.CICLO, []);
    estudiantesPorCiclo.get(e.CICLO).push(e);
  }

  for (const materia of mallas) {
    const ciclo = materia.CICLO;
    const estudiantesCiclo = estudiantesPorCiclo.get(ciclo) || [];
    const numEstudiantes = estudiantesCiclo.length;
    if (numEstudiantes === 0) continue;

    const docentesMateria = docentes.filter(d => d.MATERIA === materia.MATERIA);
    if (docentesMateria.length === 0) { 
      console.warn(`Sin docentes para ${materia.MATERIA}`); 
      continue; 
    }

    const numParalelos = Math.ceil(numEstudiantes / capacidadPorParalelo);

    // Correlativo de paralelos por materia + ciclo (evita repetir "A")
    const kMat = `${materia.MATERIA}¦${ciclo}`;
    const baseIndex = correlativoParalelo.get(kMat) || 0;

    for (let i = 0; i < numParalelos; i++) {
      // Elegir docente con menos de 5 secciones
      let docente = null;
      for (let j = 0; j < docentesMateria.length; j++) {
        const cand = docentesMateria[(i + j) % docentesMateria.length];
        const cnt = seccionesPorDocente.get(cand.NOMBRE_DOCENTE) || 0;
        if (cnt < 5) { docente = cand; break; }
      }
      if (!docente) {
        console.warn(`Todos los docentes alcanzaron 5 materias para ${materia.MATERIA}. Se omite creación de sección.`);
        continue;
      }

      // Encontrar horario libre para ese docente en el ciclo
      const horario = encontrarHorarioDisponible(horariosOcupados.get(ciclo), docente);
      if (!horario) {
        console.warn(`Sin horario disponible para ${materia.MATERIA} - Ciclo ${ciclo} (docente: ${docente.NOMBRE_DOCENTE})`);
        continue;
      }

      const capacidad = Math.min(capacidadPorParalelo, Math.ceil(numEstudiantes / numParalelos));
      const paralelo = String.fromCharCode(65 + baseIndex + i); // A, B, C, ...

      secciones.push({
        MATERIA: materia.MATERIA,
        CODIGO: materia.CODIGO,
        CICLO: ciclo,
        NOMBRE_DOCENTE: docente.NOMBRE_DOCENTE,
        CAP: capacidad,
        ASIGNADOS: 0,
        DIA: horario.dia,
        HORA: horario.hora,
        Modalidad: docente.Modalidad,
        Paralelo: paralelo,
        DEDICACIÓN: docente.DEDICACIÓN || "",
        "HORAS TEÓRICAS": materia.HORAS_TEORICAS,
        "HORAS PRÁCTICAS": materia.HORAS_PRACTICAS,
        "HORAS AUTÓNOMAS": materia["HORAS AUTÓNOMAS"],
        "CREDITOS": materia.CREDITOS,
        "CAMPO DE FORMACIÓN": materia["CAMPO DE FORMACIÓN"],
        "MALLA": materia.MALLA,
        "Nº ORDEN EN LA MALLA": materia["Nº ORDEN EN LA MALLA"],
        "PRE-REQUISITO": materia["PRE-REQUISITO"],
        "CARRERAS QUE COMPARTEN": materia["CARRERAS QUE COMPARTEN"],
        "CÓDIGO ANTHOLOGY": materia.CODIGO
      });

      // Actualizar conteo por docente
      seccionesPorDocente.set(
        docente.NOMBRE_DOCENTE, 
        (seccionesPorDocente.get(docente.NOMBRE_DOCENTE) || 0) + 1
      );
    }

    // Avanzar el correlativo global de paralelos para esa materia+ciclo
    correlativoParalelo.set(kMat, baseIndex + numParalelos);
  }

  console.log("Secciones construidas:", secciones);
  return secciones;
}


// Encontrar horario disponible para un docente que no esté ocupado en el mismo ciclo
// Encontrar horario disponible sin cruces: por ciclo Y por docente
function encontrarHorarioDisponible(horariosOcupadosCiclo, docente) {
  // estructura por docente
  const nombreDoc = docente.NOMBRE_DOCENTE || "SIN_DOCENTE";
  const slotsDoc = __DOCENTE_SLOTS__.get(nombreDoc) || new Map();

  for (const dia of docente.DIA_DISPONIBLE) {
    const ocupadosDiaCiclo = horariosOcupadosCiclo.get(dia) || new Set(); // evita cruces dentro del ciclo
    const ocupadosDiaDoc = slotsDoc.get(dia) || new Set();                 // evita cruces del docente (todos los ciclos)

    for (const hora of docente.HORA_DISPONIBLE) {
      // libre en el ciclo y libre para el docente
      if (!ocupadosDiaCiclo.has(hora) && !ocupadosDiaDoc.has(hora)) {
        // marcar ocupación en ambas estructuras
        ocupadosDiaCiclo.add(hora);
        horariosOcupadosCiclo.set(dia, ocupadosDiaCiclo);

        ocupadosDiaDoc.add(hora);
        slotsDoc.set(dia, ocupadosDiaDoc);
        __DOCENTE_SLOTS__.set(nombreDoc, slotsDoc);

        return { dia, hora };
      }
    }
  }
  return null; // no hay slot compatible
}

function agruparPorMateria(secciones) {
  const map = new Map();
  for (const s of secciones) {
    if (!map.has(s.MATERIA)) map.set(s.MATERIA, []);
    map.get(s.MATERIA).push(s);
  }
  return map;
}

function asignarEstudiantes(secciones, estudiantes, mallas) {
  const idxPorMateria = agruparPorMateria(secciones);
  const asignaciones = [];
  const noAsig = [];
  const maxMaterias = parseInt(document.getElementById('maxMaterias').value) || 6;
  const kCarga = (d, m, par, h) => `${d}¦${m}¦${par || ''}¦${h}`;
  const carga = new Map();
  for (const s of secciones) {
    const key = kCarga(s.NOMBRE_DOCENTE || "SIN_DOCENTE", s.MATERIA, s.Paralelo, s.HORA);
    if (!carga.has(key)) {
      carga.set(key, {
        DOCENTE: s.NOMBRE_DOCENTE || "SIN_DOCENTE",
        MATERIA: s.MATERIA,
        Paralelo: s.Paralelo || "",
        DIA: s.DIA,
        HORA: s.HORA,
        ASIGNADOS: 0,
        CAP: s.CAP || 0
      });
    }
  }
  const estudiantesPorCiclo = new Map();
  for (const e of estudiantes) {
    if (!estudiantesPorCiclo.has(e.CICLO)) {
      estudiantesPorCiclo.set(e.CICLO, []);
    }
    estudiantesPorCiclo.get(e.CICLO).push(e);
  }
  for (const [ciclo, estudiantesCiclo] of estudiantesPorCiclo.entries()) {
    const materiasCiclo = mallas.filter(m => m.CICLO === ciclo).map(m => m.MATERIA);
    for (const e of estudiantesCiclo) {
      let materiasAsignadas = 0;
      for (const mat of materiasCiclo) {
        if (materiasAsignadas >= maxMaterias) {
          noAsig.push({ 
            ESTUDIANTE: e.ESTUDIANTE, 
            MATERIA: mat, 
            MOTIVO: "Límite de materias alcanzado", 
            CICLO: ciclo,
            "CARRERA DEL ESTUDIANTE": e.CARRERA,
            "NIVEL INGLES": e["NIVEL INGLES"] 
          });
          continue;
        }
        const bucket = (idxPorMateria.get(mat) || []).slice();
        if (!bucket.length) {
          noAsig.push({ 
            ESTUDIANTE: e.ESTUDIANTE, 
            MATERIA: mat, 
            MOTIVO: "Sin secciones", 
            CICLO: ciclo,
            "CARRERA DEL ESTUDIANTE": e.CARRERA,
            "NIVEL INGLES": e["NIVEL INGLES"] 
          });
          continue;
        }
        bucket.sort((a, b) => {
          const freeA = (a.CAP || 0) - (a.ASIGNADOS || 0);
          const freeB = (b.CAP || 0) - (b.ASIGNADOS || 0);
          if (freeA !== freeB) return freeB - freeA;
          return (a.Paralelo || "").localeCompare(b.Paralelo || "");
        });
        let placed = false;
        for (const s of bucket) {
          const free = (s.CAP || 0) - (s.ASIGNADOS || 0);
          if (free <= 0) continue;
          s.ASIGNADOS = (s.ASIGNADOS || 0) + 1;
          placed = true;
          materiasAsignadas++;
          const asignacion = {
            ESTUDIANTE: e.ESTUDIANTE,
            CICLO: ciclo,
            NOMBRE_DOCENTE: s.NOMBRE_DOCENTE || "",
            MATERIA: s.MATERIA,
            "CANTIDAD DE ALUMNOS ESPERADOS": s.CAP || "",
            DIA: s.DIA,
            HORA: s.HORA,
            Modalidad: s.Modalidad || "",
            Paralelo: s.Paralelo || "",
            DEDICACIÓN: s.DEDICACIÓN || "",
            "CÓDIGO ANTHOLOGY": s["CÓDIGO ANTHOLOGY"] || "",
            "CARRERAS QUE COMPARTEN": s["CARRERAS QUE COMPARTEN"] || "",
            "PRE-REQUISITO": s["PRE-REQUISITO"] || "",
            CODIGO: s.CODIGO || "",
            "HORAS TEÓRICAS": s["HORAS TEÓRICAS"] || "",
            "HORAS PRÁCTICAS": s["HORAS PRÁCTICAS"] || "",
            "HORAS AUTÓNOMAS": s["HORAS AUTÓNOMAS"] || "",
            CREDITOS: s.CREDITOS || "",
            "CAMPO DE FORMACIÓN": s["CAMPO DE FORMACIÓN"] || "",
            MALLA: s.MALLA || "",
            "Nº ORDEN EN LA MALLA": s["Nº ORDEN EN LA MALLA"] || "",
            "Nro. HORAS": (s["HORAS TEÓRICAS"] || 0) + (s["HORAS PRÁCTICAS"] || 0),
            "CARRERA DEL ESTUDIANTE": e.CARRERA || "",
            "CICLO DEL ESTUDIANTE": ciclo,
            "NIVEL INGLES": e["NIVEL INGLES"] || "",
            OBSERVACIONES: ""
          };
          asignaciones.push(asignacion);
          const key = kCarga(s.NOMBRE_DOCENTE || "SIN_DOCENTE", s.MATERIA, s.Paralelo, s.HORA);
          if (carga.has(key)) { carga.get(key).ASIGNADOS++; }
          break;
        }
        if (!placed) {
          noAsig.push({ 
            ESTUDIANTE: e.ESTUDIANTE, 
            MATERIA: mat, 
            MOTIVO: "Sin cupo", 
            CICLO: ciclo,
            "CARRERA DEL ESTUDIANTE": e.CARRERA,
            "NIVEL INGLES": e["NIVEL INGLES"] 
          });
        }
      }
    }
  }
  const cargaDocente = Array.from(carga.values()).sort((a, b) => 
    a.DOCENTE.localeCompare(b.DOCENTE) || 
    a.MATERIA.localeCompare(b.MATERIA) || 
    a.Paralelo.localeCompare(b.Paralelo)
  );
  const resumenMateria = (() => {
    const map = new Map();
    for (const s of secciones) {
      const k = `${s.MATERIA}¦${s.Paralelo || ''}`;
      if (!map.has(k)) {
        map.set(k, {
          MATERIA: s.MATERIA,
          Paralelo: s.Paralelo || "",
          ASIGNADOS: 0,
          CAP: 0,
          OCUPACION: "0%"
        });
      }
      const o = map.get(k);
      o.CAP += (s.CAP || 0);
      o.ASIGNADOS += (s.ASIGNADOS || 0);
  }
    return Array.from(map.values()).map(r => {
      const occ = r.CAP ? Math.round((r.ASIGNADOS / r.CAP) * 100) : 0;
      return { ...r, OCUPACION: occ + "%" };
    }).sort((a, b) => a.MATERIA.localeCompare(b.MATERIA) || a.Paralelo.localeCompare(b.Paralelo));
  })();
  console.log("Asignaciones realizadas:", asignaciones.length);
  console.log("No asignados:", noAsig.length);
  return { asignaciones, noAsig, cargaDocente, resumenMateria, secciones };
}

// ===================== Interfaz =====================
let OUT_SECC = [], OUT_COMB = [], OUT_CARGA = [], OUT_RES_MAT = [], OUT_NO = [];

document.addEventListener('DOMContentLoaded', function() {
  updateFileStatus('fileDoc', 'statusDoc', true);
  updateFileStatus('fileEst', 'statusEst', true);
  updateFileStatus('fileMal', 'statusMal', true);
  
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const tabId = tab.getAttribute('data-tab');
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(tc => tc.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tabId).classList.add('active');
    });
  });
  
  document.getElementById('btnRun').addEventListener('click', async () => {
    const fD = document.getElementById('fileDoc').files[0];
    const fE = document.getElementById('fileEst').files[0];
    const fM = document.getElementById('fileMal').files[0];
    if (!fD || !fE || !fM) { showError('Debe cargar los archivos de DOCENTES, ESTUDIANTES y MALLA.'); return; }
    document.body.classList.add('loading');
    updateProgress(10);
    try {
      const [rowsD, rowsE, rowsM] = await Promise.all([
        readSheet(fD, "DOCENTES"),
        readSheet(fE, "ESTUDIANTES"),
        readSheet(fM, "MALLA")
      ]);
      updateProgress(40);
      const DOC = normalizeDocentes(rowsD);
      const EST = normalizeEstudiantes(rowsE);
      const MAL = normalizeMallas(rowsM);
      if (DOC.length === 0 || EST.length === 0 || MAL.length === 0) {
        throw new Error("Datos insuficientes para procesar. Verifique el formato de los archivos.");
      }
      updateProgress(60);
      const secciones = construirSecciones(DOC, MAL, EST);
      updateProgress(80);
      const { asignaciones, noAsig, cargaDocente, resumenMateria, secciones: seccFinal } = asignarEstudiantes(secciones, EST, MAL);
      OUT_SECC = seccFinal.map(s => ({
        "NOMBRE_DOCENTE": s.NOMBRE_DOCENTE || "",
        "MATERIA": s.MATERIA,
        "CANTIDAD DE ALUMNOS ESPERADOS": s.CAP || "",
        "DIA": s.DIA,
        "HORA": s.HORA,
        "Modalidad": s.Modalidad || "",
        "Paralelo": s.Paralelo || ""
      }));
      OUT_COMB = asignaciones.map(a => ({
        "NOMBRE_DOCENTE": a.NOMBRE_DOCENTE,
        "MATERIA": a.MATERIA,
        "CANTIDAD DE ALUMNOS ESPERADOS": a["CANTIDAD DE ALUMNOS ESPERADOS"],
        "DIA": a.DIA,
        "HORA": a.HORA,
        "Modalidad": a.Modalidad,
        "Paralelo": a.Paralelo,
        "ESTUDIANTE": a.ESTUDIANTE,
        "CICLO": a.CICLO
      }));
      OUT_NO = noAsig;
      OUT_CARGA = cargaDocente;
      OUT_RES_MAT = resumenMateria;
      updateProgress(90);
      renderTable(document.getElementById('tblCombo'), COMBO9, OUT_COMB, 100);
      renderTable(document.getElementById('tblCarga'), 
                 ["DOCENTE", "MATERIA", "Paralelo", "DIA", "HORA", "ASIGNADOS", "CAP"], 
                 OUT_CARGA, 100);
      renderTable(document.getElementById('tblResumenMateria'), 
                 ["MATERIA", "Paralelo", "ASIGNADOS", "CAP", "OCUPACION"], 
                 OUT_RES_MAT, 100);
      renderTable(document.getElementById('tblNo'), 
                 ["ESTUDIANTE", "MATERIA", "CICLO", "MOTIVO"], 
                 OUT_NO, 100);
      renderMatrizTable(asignaciones);
      updateStats(OUT_SECC, OUT_COMB, OUT_NO, OUT_RES_MAT);
      document.getElementById('btnDown').classList.remove('hidden');
      updateProgress(100);
      setTimeout(() => {
        document.getElementById('progressContainer').style.display = 'none';
        document.body.classList.remove('loading');
        showSuccess(`Procesamiento completado. Se realizaron ${OUT_COMB.length} asignaciones.`);
      }, 1000);
    } catch (error) {
      console.error("Error procesando archivos:", error);
      showError(error.message);
      document.body.classList.remove('loading');
      document.getElementById('progressContainer').style.display = 'none';
    }
  });
  
  document.getElementById('btnDown').addEventListener('click', () => {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_SECC), 'MATRIZ_SECCIONES');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_COMB), 'COMBINACION');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_CARGA), 'RESUMEN_CARGA');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_RES_MAT), 'RESUMEN_MATERIA');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_NO), 'NO_ASIGNADOS');
    XLSX.writeFile(wb, 'Planificacion_Asignacion_Docente.xlsx');
    showSuccess('Archivo descargado correctamente.');
  });
});


/* ===========================
   PARCHE AÑADIDO (SIN BORRAR NADA)
   =========================== */

/* 1) Letra más pequeña por solicitud (sin tocar el CSS original) */
(function(){
  const st = document.createElement('style');
  st.textContent = `
    body, table, th, td, .config-input, .tab, .stat-label { font-size: 12px !important; }
    .matrix-table { font-size: 11px !important; }
  `;
  document.head.appendChild(st);
})();

/* 2) Inserta "DEDICACIÓN" en COMBO9 sin re-declararla */
try { if (!COMBO9.includes("DEDICACIÓN")) COMBO9.splice(7,0,"DEDICACIÓN"); } catch(e){}

/* 3) Utilidades nuevas para no repetir asignaciones y límites por día */
(function(){
  const HORAS = ["07:00-10:00","10:00-13:00","13:00-16:00","16:00-19:00","19:00-22:00"];
  const val = s => (s===null || s===undefined || s==="") ? "0" : s;

  // Expande 14:00-22:00 a bloques incluidos
  function expandToBlocks(rango){
    const m = String(rango||"").toUpperCase().match(/(\d{1,2}):(\d{2})\s*[-–A]+\s*(\d{1,2}):(\d{2})/);
    if(!m) return [];
    const sh=+m[1], sm=+m[2], eh=+m[3], em=+m[4];
    const start=sh*60+sm, end=eh*60+em;
    const out=[];
    for(const b of HORAS){
      const [b0,b1]=b.split('-'); const [h0,m0]=b0.split(':').map(Number); const [h1,m1]=b1.split(':').map(Number);
      const bs=h0*60+m0, be=h1*60+m1;
      if(bs>=start && be<=end) out.push(b);
    }
    return out.length?out:[HORAS[0]];
  }

  // Reescribe normalizarHorario para elegir el bloque más cercano cuando no es estándar
  window.normalizarHorario = function(horario){
    if(!horario) return HORAS[0];
    const s=String(horario).toUpperCase().trim();
    if(HORAS.includes(s)) return s;
    const m=s.match(/(\d{1,2}):(\d{2})\s*[-–A]+\s*(\d{1,2}):(\d{2})/);
    if(!m) return HORAS[0];
    const sh=+m[1], sm=+m[2]; const start=sh*60+sm;
    let best=HORAS[0], delta=1e9;
    for(const b of HORAS){
      const [b0]=b.split('-'); const [h0,m0]=b0.split(':').map(Number);
      const bs=h0*60+m0; const d=Math.abs(start-bs);
      if(d<delta){ delta=d; best=b; }
    }
    return best;
  };

  // Docente: no más de 2 materias por día
  let DOC_DAY = new Map(); // Map<docente, Map<dia,count>>
  function getDocDay(doc,dia){ return DOC_DAY.get(doc)?.get(dia)||0; }
  function incDocDay(doc,dia){ const m=DOC_DAY.get(doc)||new Map(); m.set(dia,(m.get(dia)||0)+1); DOC_DAY.set(doc,m); }

  // Estudiante: no más de 2 por día y sin solapar
  let EST_DAY = new Map();  // Map<est, Map<dia,count>>
  let EST_SLOTS = new Map();// Map<est, Set<"DIA¦HORA">>
  function canPlace(est,dia,hora){
    const c=EST_DAY.get(est)?.get(dia)||0;
    const s=EST_SLOTS.get(est)||new Set();
    return c<2 && !s.has(`${dia}¦${hora}`);
  }
  function markPlace(est,dia,hora){
    const m=EST_DAY.get(est)||new Map(); m.set(dia,(m.get(dia)||0)+1); EST_DAY.set(est,m);
    const s=EST_SLOTS.get(est)||new Set(); s.add(`${dia}¦${hora}`); EST_SLOTS.set(est,s);
  }

  // Evitar el mismo slot en el mismo ciclo
  function isCycleSlotFree(ciclo,dia,hora,secciones){
    return !secciones.some(s => Number(s.CICLO)===Number(ciclo) && s.DIA===dia && s.HORA===hora);
  }

  // Sobrescribe normalizeDocentes (sin borrar la original, solo sustituye)
  window.normalizeDocentes = function(rows){
    if(!rows||!rows.length){ showError("El archivo de docentes está vacío o no tiene el formato correcto."); return []; }
    return rows.map(r=>{
      let dias=[], horas=[];
      const dTxt=String(r["DIA DISPONIBLE"]||r["DIA"]||"").toUpperCase();
      if(dTxt.includes("LUNES A VIERNES")) dias=["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES"];
      if(dTxt.includes("LUNES")) dias.push("LUNES");
      if(dTxt.includes("MARTES")) dias.push("MARTES");
      if(dTxt.includes("MIERCOLES")||dTxt.includes("MIÉRCOLES")) dias.push("MIERCOLES");
      if(dTxt.includes("JUEVES")) dias.push("JUEVES");
      if(dTxt.includes("VIERNES")) dias.push("VIERNES");
      if(dTxt.includes("SABADO")||dTxt.includes("SÁBADO")) dias.push("SABADO");
      dias = Array.from(new Set(dias.length?dias:["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES"]));
      const hTxt=String(r["HORA DISPONIBLE"]||r["HORA"]||"").toUpperCase();
      const rangos=hTxt.match(/\d{1,2}:\d{2}\s*[-–A]+\s*\d{1,2}:\d{2}/g)||[];
      for(const rg of rangos) horas=horas.concat(expandToBlocks(rg));
      if(!horas.length) horas=[...HORAS];
      horas=Array.from(new Set(horas));
      return {
        "NOMBRE_DOCENTE": r["NOMBRE_DOCENTE"]||r["DOCENTE"]||"",
        "MATERIA": r["MATERIA"]||r["MATERIAS"]||"",
        "CANTIDAD DE ALUMNOS ESPERADOS": Number(r["CANTIDAD DE ALUMNOS ESPERADOS"]||r["CAPACIDAD"]||r["CUPOS"]||25)||25,
        "DIA_DISPONIBLE": dias,
        "HORA_DISPONIBLE": horas,
        "Modalidad": r["Modalidad"]||r["MODALIDAD"]||"PRESENCIAL",
        "Paralelo": String(r["Paralelo"]||r["PARALELO"]||"").toUpperCase().trim()||"A",
        "DEDICACIÓN": r["DEDICACIÓN"]||r["DEDICACION"]||""
      };
    }).filter(x=>x.MATERIA&&x.NOMBRE_DOCENTE);
  };

  // Excluye ciclo 9 (graduado)
  window.normalizeEstudiantes = function(rows){
    if(!rows||!rows.length){ showError("El archivo de estudiantes está vacío o no tiene el formato correcto."); return []; }
    return rows.map(r=>{
      const ciclo=Number(r["CICLO AL QUE VA"]||r["CICLO ACTUAL"]||r["CICLO"]||1);
      return {
        "ESTUDIANTE": r["ESTUDIANTE"]||r["NOMBRE"]||r["NOMBRE DEL ESTUDIANTE"]||"",
        "CICLO": isNaN(ciclo)?1:Math.max(1,Math.min(12,ciclo)),
        "CARRERA": r["CARRERA"]||r["CARRERA DEL ESTUDIANTE"]||"",
        "MALLA": r["MALLA"]||"",
        "NIVEL INGLES": r["NIVEL INGLES"]||""
      };
    }).filter(x=>x.ESTUDIANTE && Number(x.CICLO)!==9);
  };

  // Usa todas las filas de malla, acumula códigos/carreras/mallas
  window.normalizeMallas = function(rows){
    if(!rows||!rows.length){ showError("El archivo de mallas está vacío o no tiene el formato correcto."); return []; }
    const WORD2NUM={"PRIMERO":1,"SEGUNDO":2,"TERCERO":3,"CUARTO":4,"QUINTO":5,"SEXTO":6,"SEPTIMO":7,"SÉPTIMO":7,"OCTAVO":8,"NOVENO":9,"DECIMO":10,"DÉCIMO":10,"ONCE":11,"DOCE":12};
    const toCycle=v=>{ if(v===undefined||v===null||v==="") return NaN; const t=String(v).toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(); if(/^\d+$/.test(t)) return Number(t); return WORD2NUM[t]||NaN; };
    return rows.map(r=>{
      const materia=r["MATERIA"]||r["MATERIAS"]||"";
      const codigo=r["CÓDIGO"]||r["CODIGO"]||r["CÓDIGO ANTHOLOGY"]||"";
      let ciclo=toCycle(r["CICLO"]); if(isNaN(ciclo)) ciclo=Number(r["CICLO"]||1);
      return {
        "CARRERA": r["CARRERA"]||"",
        "MATERIA": materia,
        "CODIGO": String(codigo).trim(),
        "CICLO": Math.max(1,Math.min(12,Number(ciclo)||1)),
        "HORAS TEÓRICAS": Number(r["HORAS TEÓRICAS"]||r["HORAS_TEORICAS"]||r["HORAS TEORICAS"]||0)||0,
        "HORAS PRÁCTICAS": Number(r["HORAS PRÁCTICAS"]||r["HORAS_PRACTICAS"]||r["HORAS PRACTICAS"]||0)||0,
        "HORAS AUTÓNOMAS": Number(r["HORAS AUTÓNOMAS"]||r["HORAS AUTONOMAS"]||0)||0,
        "CREDITOS": Number(r["CREDITOS"]||0)||0,
        "CAMPO DE FORMACIÓN": r["CAMPO DE FORMACIÓN"]||r["CAMPO DE FORMACION"]||"",
        "MALLA": r["MALLA"]||"",
        "Nº ORDEN EN LA MALLA": r["Nº ORDEN EN LA MALLA"]||r["NRO ORDEN EN LA MALLA"]||0,
        "PRE-REQUISITO": r["PRE-REQUISITO"]||r["PREREQUISITO"]||"",
        "CARRERAS QUE COMPARTEN": r["CARRERAS QUE COMPARTEN"]||""
      };
    }).filter(x=>x.MATERIA);
  };

  // Docente: máximo 2 por día + sin choque con ciclo
  window.encontrarHorarioDisponible = function(horariosOcupadosCiclo, docente){
    const nombreDoc=docente.NOMBRE_DOCENTE||"SIN_DOCENTE";
    const slotsDoc = (window.__DOCENTE_SLOTS__ && __DOCENTE_SLOTS__.get(nombreDoc)) || new Map();
    for(const dia of docente.DIA_DISPONIBLE){
      if(getDocDay(nombreDoc,dia) >= 2) continue;
      const ocupadosDiaCiclo = horariosOcupadosCiclo.get(dia) || new Set();
      const ocupadosDiaDoc = slotsDoc.get(dia) || new Set();
      for(const hora of docente.HORA_DISPONIBLE){
        if(ocupadosDiaCiclo.has(hora) || ocupadosDiaDoc.has(hora)) continue;
        ocupadosDiaCiclo.add(hora); horariosOcupadosCiclo.set(dia,ocupadosDiaCiclo);
        ocupadosDiaDoc.add(hora); slotsDoc.set(dia,ocupadosDiaDoc); __DOCENTE_SLOTS__.set(nombreDoc,slotsDoc);
        incDocDay(nombreDoc,dia);
        return {dia,hora};
      }
    }
    return null;
  };

  // Crea sección extra si falta cupo/slot (con toda la info consolidada)
  function ensureExtraSection(ciclo, materia, docentes, mallas, secciones){
    const capacidad = parseInt(document.getElementById('capacidadParalelo').value)||25;
    const candidatos = docentes.filter(d => String(d.MATERIA).toUpperCase().trim() === String(materia).toUpperCase().trim());
    if(!candidatos.length) return null;

    const splitList = s => String(s||"").split(/[,;/]| Y | E /i).map(x=>x.trim()).filter(Boolean);
    const codigos=new Set(), carreras=new Set(), mallasSet=new Set();
    let hT=0,hP=0,hA=0, cred=0, campo="", orden=0, prereq="";
    for(const m of mallas){
      if(Number(m.CICLO)===Number(ciclo) && String(m.MATERIA).toUpperCase().trim()===String(materia).toUpperCase().trim()){
        if(m.CODIGO) codigos.add(String(m.CODIGO));
        if(m.CARRERA) carreras.add(String(m.CARRERA).toUpperCase());
        splitList(m["CARRERAS QUE COMPARTEN"]).forEach(c=>carreras.add(String(c).toUpperCase()));
        if(m.MALLA) mallasSet.add(String(m.MALLA));
        hT=Math.max(hT,Number(m["HORAS TEÓRICAS"]||0)); hP=Math.max(hP,Number(m["HORAS PRÁCTICAS"]||0)); hA=Math.max(hA,Number(m["HORAS AUTÓNOMAS"]||0));
        cred=Math.max(cred,Number(m.CREDITOS||0)); campo=campo||m["CAMPO DE FORMACIÓN"]||""; orden=Number(m["Nº ORDEN EN LA MALLA"]||orden); prereq=prereq||m["PRE-REQUISITO"]||"";
      }
    }
    const codStr=Array.from(codigos).filter(Boolean).join('/')||"0";
    const carStr=Array.from(carreras).filter(Boolean).join('/')||"0";
    const mallaStr=Array.from(mallasSet).filter(Boolean).join('/')||"0";

    for(const d of candidatos){
      const nombreDoc=d.NOMBRE_DOCENTE||"SIN_DOCENTE";
      const slotsDoc=(window.__DOCENTE_SLOTS__ && __DOCENTE_SLOTS__.get(nombreDoc)) || new Map();
      for(const dia of d.DIA_DISPONIBLE){
        if(getDocDay(nombreDoc,dia) >= 2) continue;
        const usadosDiaDoc=slotsDoc.get(dia)||new Set();
        for(const hora of d.HORA_DISPONIBLE){
          if(usadosDiaDoc.has(hora)) continue;
          if(!isCycleSlotFree(ciclo,dia,hora,secciones)) continue;
          usadosDiaDoc.add(hora); slotsDoc.set(dia,usadosDiaDoc); __DOCENTE_SLOTS__.set(nombreDoc,slotsDoc); incDocDay(nombreDoc,dia);
          const paralelo=String.fromCharCode(65 + (secciones.filter(s=>s.MATERIA===materia && Number(s.CICLO)===Number(ciclo)).length));
          const nueva={
            MATERIA:materia, CODIGO:codStr, "CÓDIGO ANTHOLOGY":codStr, CICLO:Number(ciclo),
            NOMBRE_DOCENTE:nombreDoc, CAP:capacidad, ASIGNADOS:0, DIA:dia, HORA:hora,
            Modalidad:d.Modalidad||"PRESENCIAL", Paralelo:paralelo, DEDICACIÓN:d.DEDICACIÓN||"",
            "HORAS TEÓRICAS":hT, "HORAS PRÁCTICAS":hP, "HORAS AUTÓNOMAS":hA, CREDITOS:cred,
            "CAMPO DE FORMACIÓN":campo||"0", MALLA:mallaStr, "Nº ORDEN EN LA MALLA":orden||0,
            "PRE-REQUISITO":prereq||"0", "CARRERAS QUE COMPARTEN":carStr
          };
          secciones.push(nueva);
          return nueva;
        }
      }
    }
    return null;
  }

  // Reescribe construirSecciones para usar toda la info y límites
  window.construirSecciones = function(docentes, mallas, estudiantes){
    DOC_DAY = new Map(); // reset
    window.__DOCENTE_SLOTS__ = new Map();
    const secciones=[]; const ocupados=new Map(); const cap = parseInt(document.getElementById('capacidadParalelo').value)||25;
    for(let c=1;c<=12;c++) ocupados.set(c,new Map());

    // agrupa alumnos por ciclo
    const estPorCiclo=new Map(); for(const e of estudiantes){ if(!estPorCiclo.has(e.CICLO)) estPorCiclo.set(e.CICLO,[]); estPorCiclo.get(e.CICLO).push(e); }

    // meta por ciclo+materia
    const meta = new Map();
    const splitList = s => String(s||"").split(/[,;/]| Y | E /i).map(x=>x.trim()).filter(Boolean);
    for(const m of mallas){
      const k=`${m.CICLO}¦${m.MATERIA}`;
      if(!meta.has(k)) meta.set(k,{cod:new Set(),car:new Set(),mal:new Set(),hT:0,hP:0,hA:0,cr:0,campo:m["CAMPO DE FORMACIÓN"]||"",ord:m["Nº ORDEN EN LA MALLA"]||0,pre:m["PRE-REQUISITO"]||""});
      const o=meta.get(k);
      if(m.CODIGO) o.cod.add(String(m.CODIGO));
      if(m.CARRERA) o.car.add(String(m.CARRERA).toUpperCase());
      splitList(m["CARRERAS QUE COMPARTEN"]).forEach(c=>o.car.add(String(c).toUpperCase()));
      if(m.MALLA) o.mal.add(String(m.MALLA));
      o.hT=Math.max(o.hT,Number(m["HORAS TEÓRICAS"]||0));
      o.hP=Math.max(o.hP,Number(m["HORAS PRÁCTICAS"]||0));
      o.hA=Math.max(o.hA,Number(m["HORAS AUTÓNOMAS"]||0));
      o.cr=Math.max(o.cr,Number(m.CREDITOS||0));
      o.campo=o.campo||m["CAMPO DE FORMACIÓN"]||"";
      o.pre=o.pre||m["PRE-REQUISITO"]||"";
    }

    const corr = new Map();
    for(const m of mallas){
      const ciclo=m.CICLO; const estC=estPorCiclo.get(ciclo)||[]; if(!estC.length) continue;
      const docentesMateria=docentes.filter(d=>String(d.MATERIA).toUpperCase().trim()===String(m.MATERIA).toUpperCase().trim());
      if(!docentesMateria.length) continue;

      const nPar = Math.max(1, Math.ceil(estC.length / cap));
      const key=`${m.MATERIA}¦${ciclo}`; const base= corr.get(key)||0;

      const info=meta.get(`${ciclo}¦${m.MATERIA}`)||{};
      const codStr=Array.from(info.cod||[]).filter(Boolean).join('/')||String(m.CODIGO||"0");
      const carStr=Array.from(info.car||[]).filter(Boolean).join('/')||String(m["CARRERAS QUE COMPARTEN"]||"0");
      const mallaStr=Array.from(info.mal||[]).filter(Boolean).join('/')||String(m.MALLA||"0");

      for(let i=0;i<nPar;i++){
        docentesMateria.sort((a,b)=>(a.__cnt||0)-(b.__cnt||0));
        let elegido=null, slot=null;
        for(const d of docentesMateria){
          const sl = window.encontrarHorarioDisponible(ocupados.get(ciclo), d);
          if(sl){ elegido=d; slot=sl; break; }
        }
        if(!elegido) continue;
        elegido.__cnt=(elegido.__cnt||0)+1;

        const paralelo=String.fromCharCode(65+base+i);
        secciones.push({
          MATERIA:m.MATERIA, CODIGO:codStr, "CÓDIGO ANTHOLOGY":codStr, CICLO:ciclo,
          NOMBRE_DOCENTE:elegido.NOMBRE_DOCENTE,
          CAP: Math.min(cap, Math.ceil(estC.length / nPar)), ASIGNADOS:0,
          DIA:slot.dia, HORA:slot.hora, Modalidad:elegido.Modalidad, Paralelo:paralelo,
          DEDICACIÓN:elegido.DEDICACIÓN||"",
          "HORAS TEÓRICAS":info.hT??m.HORAS_TEORICAS??0,
          "HORAS PRÁCTICAS":info.hP??m.HORAS_PRACTICAS??0,
          "HORAS AUTÓNOMAS":info.hA??m["HORAS AUTÓNOMAS"]??0,
          "CREDITOS":info.cr??m.CREDITOS??0,
          "CAMPO DE FORMACIÓN":info.campo??m["CAMPO DE FORMACIÓN"]??"",
          "MALLA":mallaStr, "Nº ORDEN EN LA MALLA":info.ord??m["Nº ORDEN EN LA MALLA"]??0,
          "PRE-REQUISITO":info.pre??m["PRE-REQUISITO"]??"",
          "CARRERAS QUE COMPARTEN":carStr
        });
      }
      corr.set(key, base+nPar);
    }
    return secciones;
  };

  // Reescribe asignarEstudiantes para usar 2 por día y crear secciones extra si hace falta
  window.asignarEstudiantes = function(secciones, estudiantes, mallas, docentes){
    EST_DAY = new Map(); EST_SLOTS = new Map();
    const idx=new Map(); for(const s of secciones){ const k=`${s.CICLO}¦${s.MATERIA}`; if(!idx.has(k)) idx.set(k,[]); idx.get(k).push(s); }
    const asignaciones=[], noAsig=[]; const maxMat = parseInt(document.getElementById('maxMaterias').value)||6;

    // materias por ciclo
    const matsPorCiclo=new Map(); for(const m of mallas){ if(!matsPorCiclo.has(m.CICLO)) matsPorCiclo.set(m.CICLO,new Set()); matsPorCiclo.get(m.CICLO).add(m.MATERIA); }

    const assignedKey=new Set();

    for(const e of estudiantes){
      const ciclo=e.CICLO; const mats=Array.from(matsPorCiclo.get(ciclo)||[]);
      let cnt=0; const ya=new Set();
      for(const mat of mats){
        if(cnt>=maxMat) break;
        if(ya.has(mat)) continue;
        const k=`${ciclo}¦${mat}`; let bucket=(idx.get(k)||[]).slice();
        bucket.sort((a,b)=>(((a.CAP||0)-(a.ASIGNADOS||0)) - ((b.CAP||0)-(b.ASIGNADOS||0)))).reverse();

        let placed=false;
        for(const s of bucket){
          const free=(s.CAP||0)-(s.ASIGNADOS||0);
          if(free<=0) continue;
          if(!canPlace(e.ESTUDIANTE,s.DIA,s.HORA)) continue;
          s.ASIGNADOS=(s.ASIGNADOS||0)+1; cnt++; ya.add(mat); placed=true; markPlace(e.ESTUDIANTE,s.DIA,s.HORA);
          asignaciones.push({
            ESTUDIANTE:e.ESTUDIANTE, CICLO:e.CICLO,
            NOMBRE_DOCENTE:s.NOMBRE_DOCENTE||"0", MATERIA:s.MATERIA, "CANTIDAD DE ALUMNOS ESPERADOS":s.CAP||0,
            DIA:s.DIA||"0", HORA:s.HORA||"0", Modalidad:s.Modalidad||"0", Paralelo:s.Paralelo||"0",
            DEDICACIÓN:s.DEDICACIÓN||"0", "CÓDIGO ANTHOLOGY":s.CODIGO||"0", "CARRERAS QUE COMPARTEN":s["CARRERAS QUE COMPARTEN"]||"0",
            "PRE-REQUISITO":s["PRE-REQUISITO"]||"0", CODIGO:s.CODIGO||"0",
            "HORAS TEÓRICAS":Number(s["HORAS TEÓRICAS"]||0), "HORAS PRÁCTICAS":Number(s["HORAS PRÁCTICAS"]||0),
            "HORAS AUTÓNOMAS":Number(s["HORAS AUTÓNOMAS"]||0), CREDITOS:Number(s.CREDITOS||0),
            "CAMPO DE FORMACIÓN":s["CAMPO DE FORMACIÓN"]||"0", MALLA:s.MALLA||"0",
            "Nº ORDEN EN LA MALLA":Number(s["Nº ORDEN EN LA MALLA"]||0), "Nro. HORAS": Number(s["HORAS TEÓRICAS"]||0)+Number(s["HORAS PRÁCTICAS"]||0),
            "CARRERA DEL ESTUDIANTE":e.CARRERA||"0", "CICLO DEL ESTUDIANTE":e.CICLO||0, "NIVEL INGLES":e["NIVEL INGLES"]||"0", OBSERVACIONES:"0"
          });
          assignedKey.add(`${e.ESTUDIANTE}¦${mat}`);
          break;
        }
        if(!placed){
          const extra = ensureExtraSection(ciclo, mat, docentes, mallas, secciones);
          if(extra && canPlace(e.ESTUDIANTE, extra.DIA, extra.HORA)){
            extra.ASIGNADOS=(extra.ASIGNADOS||0)+1; cnt++; ya.add(mat); markPlace(e.ESTUDIANTE, extra.DIA, extra.HORA);
            asignaciones.push({
              ESTUDIANTE:e.ESTUDIANTE, CICLO:e.CICLO,
              NOMBRE_DOCENTE:extra.NOMBRE_DOCENTE||"0", MATERIA:extra.MATERIA, "CANTIDAD DE ALUMNOS ESPERADOS":extra.CAP||0,
              DIA:extra.DIA||"0", HORA:extra.HORA||"0", Modalidad:extra.Modalidad||"0", Paralelo:extra.Paralelo||"0",
              DEDICACIÓN:extra.DEDICACIÓN||"0", "CÓDIGO ANTHOLOGY":extra.CODIGO||"0", "CARRERAS QUE COMPARTEN":extra["CARRERAS QUE COMPARTEN"]||"0",
              "PRE-REQUISITO":extra["PRE-REQUISITO"]||"0", CODIGO:extra.CODIGO||"0",
              "HORAS TEÓRICAS":Number(extra["HORAS TEÓRICAS"]||0), "HORAS PRÁCTICAS":Number(extra["HORAS PRÁCTICAS"]||0),
              "HORAS AUTÓNOMAS":Number(extra["HORAS AUTÓNOMAS"]||0), CREDITOS:Number(extra.CREDITOS||0),
              "CAMPO DE FORMACIÓN":extra["CAMPO DE FORMACIÓN"]||"0", MALLA:extra.MALLA||"0",
              "Nº ORDEN EN LA MALLA":Number(extra["Nº ORDEN EN LA MALLA"]||0), "Nro. HORAS": Number(extra["HORAS TEÓRICAS"]||0)+Number(extra["HORAS PRÁCTICAS"]||0),
              "CARRERA DEL ESTUDIANTE":e.CARRERA||"0", "CICLO DEL ESTUDIANTE":e.CICLO||0, "NIVEL INGLES":e["NIVEL INGLES"]||"0", OBSERVACIONES:"0"
            });
            assignedKey.add(`${e.ESTUDIANTE}¦${mat}`);
            const kk=`${ciclo}¦${mat}`; const arr=idx.get(kk)||[]; arr.push(extra); idx.set(kk,arr);
          }else{
            noAsig.push({ ESTUDIANTE:e.ESTUDIANTE, MATERIA:mat, CICLO:Number(e.CICLO)||0, MOTIVO:"Sin cupo/horario compatible",
              "CARRERA DEL ESTUDIANTE":e.CARRERA||"0", "NIVEL INGLES":e["NIVEL INGLES"]||"0" });
          }
        }
      }
    }

    const noAsigFiltrado=noAsig.filter(x=>!assignedKey.has(`${x.ESTUDIANTE}¦${x.MATERIA}`));

    const carga = secciones.map(s=>({
      DOCENTE: s.NOMBRE_DOCENTE||"0",
      DEDICACIÓN: s.DEDICACIÓN||"0",
      MATERIA: s.MATERIA, Paralelo: s.Paralelo||"", DIA: s.DIA||"0", HORA: s.HORA||"0",
      ASIGNADOS: Number(s.ASIGNADOS||0), CAP: Number(s.CAP||0)
    })).sort((a,b)=>a.DOCENTE.localeCompare(b.DOCENTE)||a.MATERIA.localeCompare(b.MATERIA)||String(a.Paralelo).localeCompare(String(b.Paralelo)));

    const resumen = (()=>{ const map=new Map();
      for(const s of secciones){ const k=`${s.MATERIA}¦${s.Paralelo||''}`; if(!map.has(k)) map.set(k,{MATERIA:s.MATERIA,Paralelo:s.Paralelo||"",ASIGNADOS:0,CAP:0,OCUPACION:"0%"}); const o=map.get(k); o.CAP+=(s.CAP||0); o.ASIGNADOS+=(s.ASIGNADOS||0); }
      return Array.from(map.values()).map(r=>({ ...r, OCUPACION: r.CAP? Math.round((r.ASIGNADOS/r.CAP)*100)+"%":"0%" }))
        .sort((a,b)=>a.MATERIA.localeCompare(b.MATERIA)||a.Paralelo.localeCompare(b.Paralelo));
    })();

    return { asignaciones, noAsig: noAsigFiltrado, cargaDocente: carga, resumenMateria: resumen, secciones };
  };

  // Render con ceros en vacíos (sin borrar el original)
  window.renderTable = function(el, headers, rows, maxRows=100){
    if(!rows||!rows.length){ el.innerHTML='<p class="text-muted text-center">No hay datos para mostrar.</p>'; return; }
    const display=rows.slice(0,maxRows); const more=rows.length>maxRows;
    let html=`<table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>`;
    for(const r of display){ html+=`<tr>${headers.map(h=>`<td>${esc(val(r[h]))}</td>`).join('')}</tr>`; }
    html+='</tbody></table>'; if(more) html+=`<p class="text-muted text-center">Mostrando ${maxRows} de ${rows.length} registros. Descargue el archivo para ver todos.</p>`;
    el.innerHTML=html;
  };

  // Matriz con ceros
  const _oldRenderMatriz = window.renderMatrizTable;
  window.renderMatrizTable = function(asigs){
    const v = s => (s===null||s===undefined||s==="") ? "0" : s;
    const el = document.getElementById('tblMatriz'); const tbody=el.querySelector('tbody');
    if(!asigs||!asigs.length){ tbody.innerHTML=`<tr><td colspan="25" style="text-align:center;padding:20px;color:var(--secondary);">No hay datos para mostrar</td></tr>`; return; }
    let h=''; for(const r of asigs){ h+=`
      <tr>
        <td>${esc(v(r.NOMBRE_DOCENTE))}</td><td>${esc(v(r.DEDICACIÓN))}</td><td>${esc(v(r.MATERIA))}</td>
        <td>${esc(v(r["CÓDIGO ANTHOLOGY"]))}</td><td>${esc(v(r["CARRERAS QUE COMPARTEN"]))}</td><td>${esc(v(r["PRE-REQUISITO"]))}</td>
        <td>${esc(v(r.CODIGO))}</td><td>${esc(v(r["HORAS TEÓRICAS"]))}</td><td>${esc(v(r["HORAS PRÁCTICAS"]))}</td>
        <td>${esc(v(r["HORAS AUTÓNOMAS"]))}</td><td>${esc(v(r.CREDITOS))}</td><td>${esc(v(r["CAMPO DE FORMACIÓN"]))}</td>
        <td>${esc(v(r.CICLO))}</td><td>${esc(v(r.MALLA))}</td><td>${esc(v(r["Nº ORDEN EN LA MALLA"]))}</td>
        <td>${esc(v(r.Paralelo))}</td><td>${esc(v(r.DIA))}</td><td>${esc(v(r.HORA))}</td><td>${esc(v(r.Modalidad))}</td>
        <td>${esc(v(r["Nro. HORAS"]))}</td><td>${esc(v(r.ESTUDIANTE))}</td><td>${esc(v(r["CARRERA DEL ESTUDIANTE"]))}</td>
        <td>${esc(v(r["CICLO DEL ESTUDIANTE"]))}</td><td>${esc(v(r["NIVEL INGLES"]))}</td><td>${esc(v(r.OBSERVACIONES))}</td>
      </tr>`; }
    tbody.innerHTML=h;
  };
})();
</script>
</body>
</html>
