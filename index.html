<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Planificación Académica</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --azul: #04136C;
            --mostaza: #DE912E;
            --vino: #862B39;
            --celeste: #9CBEE3;
            --verde: #8A9520;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--azul);
            color: white;
            padding: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            height: 50px;
            margin-right: 15px;
        }
        
        h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .tabs {
            display: flex;
            background-color: #e9e9e9;
            margin-bottom: 20px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background-color: #e9e9e9;
            transition: background-color 0.3s;
        }
        
        .tab.active {
            background-color: var(--mostaza);
            color: white;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-section {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .file-inputs {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .file-input {
            flex: 1;
        }
        
        button {
            background-color: var(--azul);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--vino);
        }
        
        .filters {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .filter-item {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--azul);
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-export {
            background-color: var(--verde);
        }
        
        .btn-save {
            background-color: var(--vino);
        }
        
        .highlight {
            background-color: rgba(222, 145, 46, 0.2);
        }
        
        .conflict {
            background-color: rgba(134, 43, 57, 0.2);
        }
        
        .restriction-form {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .form-field {
            flex: 1;
            min-width: 200px;
        }
        
        .notification {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .file-inputs {
                flex-direction: column;
            }
            
            .filter-group {
                flex-direction: column;
            }
            
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="UIDE-Ecuador.png" alt="UIDE Ecuador" class="logo" onerror="this.style.display='none'">
            <h1>Sistema de Planificación Académica</h1>
        </div>
    </header>

    <div class="container">
        <div class="upload-section">
            <h2>Cargar Archivos Excel</h2>
            <div class="file-inputs">
                <div class="file-input">
                    <label for="malla-file">Mallas Curriculares:</label>
                    <input type="file" id="malla-file" accept=".xlsx, .xls">
                </div>
                <div class="file-input">
                    <label for="docentes-file">Docentes:</label>
                    <input type="file" id="docentes-file" accept=".xlsx, .xls">
                </div>
                <div class="file-input">
                    <label for="estudiantes-file">Estudiantes:</label>
                    <input type="file" id="estudiantes-file" accept=".xlsx, .xls">
                </div>
            </div>
            <button id="load-data">Cargar Datos</button>
            <div id="upload-notification" class="notification"></div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="docente">Planificación Docente</div>
            <div class="tab" data-tab="estudiante">Planificación Estudiante</div>
            <div class="tab" data-tab="materias">Materias</div>
            <div class="tab" data-tab="restricciones">Restricciones</div>
        </div>

        <div class="tab-content active" id="docente-content">
            <div class="filters">
                <h3>Filtros</h3>
                <div class="filter-group">
                    <div class="filter-item">
                        <label for="filter-carrera-doc">Carrera:</label>
                        <select id="filter-carrera-doc">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-docente">Docente:</label>
                        <select id="filter-docente">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-modalidad">Modalidad:</label>
                        <select id="filter-modalidad">
                            <option value="">Todas</option>
                            <option value="PRESENCIAL">Presencial</option>
                            <option value="VIRTUAL">Virtual</option>
                        </select>
                    </div>
                </div>
                <button id="apply-filters-doc">Aplicar Filtros</button>
            </div>

            <div class="table-container">
                <table id="docente-table">
                    <thead>
                        <tr>
                            <th>DOCENTE</th>
                            <th>TÍTULO ACADÉMICO</th>
                            <th>DEDICACIÓN</th>
                            <th>MATERIA</th>
                            <th>CÓDIGO ANTHOLOGY</th>
                            <th>CARRERAS QUE COMPARTEN</th>
                            <th>PRE-REQUISITO</th>
                            <th>CODIGO</th>
                            <th>HORAS TEÓRICAS</th>
                            <th>HORAS PRÁCTICAS</th>
                            <th>HORAS AUTÓNOMAS</th>
                            <th>CRÉDITOS</th>
                            <th>CAMPO DE FORMACIÓN</th>
                            <th>CICLO MALLA</th>
                            <th>Nº ORDEN EN LA MALLA</th>
                            <th>PARALELO</th>
                            <th>DIA</th>
                            <th>HORA</th>
                            <th>MODALIDAD</th>
                            <th>Nro. HORAS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargarán aquí mediante JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="actions">
                <button class="btn-export" id="export-docente">Exportar a Excel</button>
                <button class="btn-save" id="save-docente">Guardar Cambios</button>
            </div>
        </div>

        <div class="tab-content" id="estudiante-content">
            <div class="filters">
                <h3>Filtros</h3>
                <div class="filter-group">
                    <div class="filter-item">
                        <label for="filter-carrera-est">Carrera:</label>
                        <select id="filter-carrera-est">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-ciclo-est">Ciclo:</label>
                        <select id="filter-ciclo-est">
                            <option value="">Todos</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-malla-est">Malla:</label>
                        <select id="filter-malla-est">
                            <option value="">Todas</option>
                            <option value="2019">2019</option>
                            <option value="2023">2023</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                </div>
                <button id="apply-filters-est">Aplicar Filtros</button>
            </div>

            <div class="table-container">
                <table id="estudiante-table">
                    <thead>
                        <tr>
                            <th>CARRERA</th>
                            <th>ESTUDIANTE</th>
                            <th>CICLO DEL ESTUDIANTE</th>
                            <th>MALLA</th>
                            <th>CICLO DE LA MATERIA EN LA MALLA</th>
                            <th>COMPARTIDA CON CARRERA</th>
                            <th>MATERIA</th>
                            <th>PARALELO</th>
                            <th>DIA</th>
                            <th>HORA</th>
                            <th>MODALIDAD</th>
                            <th>NIVEL INGLES</th>
                            <th>OBSERVACIONES</th>
                            <th>DOCENTE</th>
                            <th>ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargarán aquí mediante JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="actions">
                <button class="btn-export" id="export-estudiante">Exportar a Excel</button>
                <button class="btn-save" id="save-estudiante">Guardar Cambios</button>
            </div>
        </div>

        <div class="tab-content" id="materias-content">
            <div class="filters">
                <h3>Filtros</h3>
                <div class="filter-group">
                    <div class="filter-item">
                        <label for="filter-carrera-mat">Carrera:</label>
                        <select id="filter-carrera-mat">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-ciclo-mat">Ciclo:</label>
                        <select id="filter-ciclo-mat">
                            <option value="">Todos</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-malla-mat">Malla:</label>
                        <select id="filter-malla-mat">
                            <option value="">Todas</option>
                            <option value="2019">2019</option>
                            <option value="2023">2023</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                </div>
                <button id="apply-filters-mat">Aplicar Filtros</button>
            </div>

            <div class="table-container">
                <table id="materias-table">
                    <thead>
                        <tr>
                            <th>MALLA</th>
                            <th>CICLO DE LA MATERIA EN LA MALLA</th>
                            <th>COMPARTIDA CON CARRERA</th>
                            <th>MATERIA</th>
                            <th>PARALELO</th>
                            <th>DIA</th>
                            <th>HORA</th>
                            <th>Número de estudiantes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargarán aquí mediante JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="actions">
                <button class="btn-export" id="export-materias">Exportar a Excel</button>
            </div>
        </div>

        <div class="tab-content" id="restricciones-content">
            <h2>Gestión de Restricciones de Horario</h2>
            <div class="restriction-form">
                <h3>Agregar Restricción para Prácticas Comunitarias</h3>
                <div class="form-row">
                    <div class="form-field">
                        <label for="restriction-carrera">Carrera:</label>
                        <select id="restriction-carrera">
                            <option value="">Seleccionar carrera</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="restriction-ciclo">Ciclo:</label>
                        <select id="restriction-ciclo">
                            <option value="">Seleccionar ciclo</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="restriction-dia">Día:</label>
                        <select id="restriction-dia">
                            <option value="">Seleccionar día</option>
                            <option value="LUNES">Lunes</option>
                            <option value="MARTES">Martes</option>
                            <option value="MIÉRCOLES">Miércoles</option>
                            <option value="JUEVES">Jueves</option>
                            <option value="VIERNES">Viernes</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="restriction-hora">Hora:</label>
                        <select id="restriction-hora">
                            <option value="">Seleccionar horario</option>
                            <option value="07:00-10:00">07:00-10:00</option>
                            <option value="10:00-13:00">10:00-13:00</option>
                            <option value="13:00-16:00">13:00-16:00</option>
                            <option value="16:00-19:00">16:00-19:00</option>
                            <option value="19:00-22:00">19:00-22:00</option>
                        </select>
                    </div>
                </div>
                <button id="add-restriction">Agregar Restricción</button>
                <div id="restriction-notification" class="notification"></div>
            </div>

            <div class="table-container">
                <table id="restricciones-table">
                    <thead>
                        <tr>
                            <th>Carrera</th>
                            <th>Ciclo</th>
                            <th>Día</th>
                            <th>Hora</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Las restricciones se cargarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Variables globales para almacenar los datos
        let mallaData = [];
        let docentesData = [];
        let estudiantesData = [];
        let restricciones = [];
        let planificacionDocente = [];
        let planificacionEstudiante = [];
        let materiasData = [];

        // Función para cargar archivos Excel
        document.getElementById('load-data').addEventListener('click', function() {
            const mallaFile = document.getElementById('malla-file').files[0];
            const docentesFile = document.getElementById('docentes-file').files[0];
            const estudiantesFile = document.getElementById('estudiantes-file').files[0];
            
            if (!mallaFile || !docentesFile || !estudiantesFile) {
                showNotification('Por favor, seleccione los tres archivos Excel.', 'error');
                return;
            }
            
            const notification = document.getElementById('upload-notification');
            
            // Cargar archivo de Mallas
            const reader1 = new FileReader();
            reader1.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                mallaData = XLSX.utils.sheet_to_json(worksheet);
                
                // Cargar archivo de Docentes
                const reader2 = new FileReader();
                reader2.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    docentesData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // Cargar archivo de Estudiantes
                    const reader3 = new FileReader();
                    reader3.onload = function(e) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        estudiantesData = XLSX.utils.sheet_to_json(worksheet);
                        
                        // Procesar los datos
                        procesarDatos();
                        
                        showNotification('Datos cargados y procesados correctamente.', 'success');
                    };
                    reader3.readAsArrayBuffer(estudiantesFile);
                };
                reader2.readAsArrayBuffer(docentesFile);
            };
            reader1.readAsArrayBuffer(mallaFile);
        });

        // Función para procesar los datos cargados
        function procesarDatos() {
            // Normalizar datos de docentes (días y horas)
            docentesData.forEach(docente => {
                if (docente['DIA DISPONIBLE']) {
                    docente.diasDisponibles = docente['DIA DISPONIBLE'].split('\n').map(d => d.trim().toUpperCase());
                }
                
                if (docente['HORA DISPONIBLE']) {
                    docente.horasDisponibles = docente['HORA DISPONIBLE'].split('\n').map(h => h.trim());
                }
            });
            
            // Extraer carreras únicas
            const carreras = [...new Set(mallaData.map(item => item.CARRERA))];
            populateSelect('filter-carrera-doc', carreras);
            populateSelect('filter-carrera-est', carreras);
            populateSelect('filter-carrera-mat', carreras);
            populateSelect('restriction-carrera', carreras);
            
            // Extraer docentes únicos
            const docentes = [...new Set(docentesData.map(item => item.DOCENTE))];
            populateSelect('filter-docente', docentes);
            
            // Generar planificación docente
            generarPlanificacionDocente();
            
            // Generar planificación estudiante
            generarPlanificacionEstudiante();
            
            // Generar datos de materias
            generarDatosMaterias();
            
            // Mostrar datos en las tablas
            mostrarPlanificacionDocente();
            mostrarPlanificacionEstudiante();
            mostrarMaterias();
        }

        // Función para generar la planificación docente
        function generarPlanificacionDocente() {
            planificacionDocente = [];
            
            // Para cada materia en la malla, asignar un docente disponible
            mallaData.forEach(materia => {
                // Buscar docentes que enseñen esta materia
                const docentesMateria = docentesData.filter(docente => 
                    docente.MATERIA && docente.MATERIA.trim().toUpperCase() === materia.MATERIA.trim().toUpperCase()
                );
                
                if (docentesMateria.length > 0) {
                    // Seleccionar el primer docente disponible (en una implementación real, se usaría un algoritmo más complejo)
                    const docente = docentesMateria[0];
                    
                    // Determinar las carreras que comparten esta materia
                    const carrerasComparten = mallaData
                        .filter(m => m.MATERIA === materia.MATERIA)
                        .map(m => m.CARRERA)
                        .filter((v, i, a) => a.indexOf(v) === i) // Valores únicos
                        .join(' / ');
                    
                    // Calcular créditos si no están definidos
                    let creditos = materia.CRÉDITOS;
                    if (typeof creditos === 'string' && creditos.startsWith('=')) {
                        // Calcular créditos basados en la fórmula: =((G2*16)+(H2*16)+(I2*16))/48
                        const horasTeoricas = materia['HORAS TEÓRICAS'] || 0;
                        const horasPracticas = materia['HORAS PRÁCTICAS'] || 0;
                        const horasAutonomas = materia['HORAS AUTÓNOMAS'] || 0;
                        creditos = ((horasTeoricas * 16) + (horasPracticas * 16) + (horasAutonomas * 16)) / 48;
                    }
                    
                    // Asignar horario (en una implementación real, se usaría la disponibilidad del docente)
                    const dias = docente.diasDisponibles || ['LUNES'];
                    const horas = docente.horasDisponibles || ['07:00-10:00'];
                    
                    planificacionDocente.push({
                        docente: docente.DOCENTE,
                        titulo: docente['TITULO ACADÉMICO'] || 'MAGISTER',
                        dedicacion: docente.DEDICACION || 'TIEMPO COMPLETO',
                        materia: materia.MATERIA,
                        codigoAnthology: materia.CÓDIGO,
                        carrerasComparten: carrerasComparten,
                        prerequisito: materia.PRERREQUISITO || '',
                        codigo: materia.CÓDIGO,
                        horasTeoricas: materia['HORAS TEÓRICAS'] || 0,
                        horasPracticas: materia['HORAS PRÁCTICAS'] || 0,
                        horasAutonomas: materia['HORAS AUTÓNOMAS'] || 0,
                        creditos: creditos,
                        campoFormacion: materia['CAMPO DE FORMACIÓN'] || '',
                        cicloMalla: materia.CICLO,
                        ordenMalla: materia['NUMERO DE ORDEN EN LA MALLA'] || '',
                        paralelo: 'A', // Asignar paralelo por defecto
                        dia: dias[0],
                        hora: horas[0],
                        modalidad: docente.Modalidad || 'PRESENCIAL',
                        numHoras: (materia['HORAS TEÓRICAS'] || 0) + (materia['HORAS PRÁCTICAS'] || 0)
                    });
                }
            });
        }

        // Función para generar la planificación estudiante
        function generarPlanificacionEstudiante() {
            planificacionEstudiante = [];
            
            estudiantesData.forEach(estudiante => {
                // Obtener el ciclo al que va el estudiante
                const cicloEstudiante = estudiante['CICLO AL QUE VA'] || estudiante.CICLO;
                
                if (!cicloEstudiante) return;
                
                // Filtrar materias para este estudiante según su carrera, malla y ciclo
                const materiasEstudiante = mallaData.filter(materia => 
                    materia.CARRERA === estudiante.CARRERA && 
                    materia.MALLA == estudiante.MALLA && 
                    materia.CICLO == cicloEstudiante
                );
                
                // Limitar a 6 materias como máximo
                const materiasAsignar = materiasEstudiante.slice(0, 6);
                
                // Para cada materia, crear una entrada en la planificación
                materiasAsignar.forEach(materia => {
                    // Buscar la planificación docente para esta materia
                    const planDocente = planificacionDocente.find(p => 
                        p.materia === materia.MATERIA && 
                        p.carrerasComparten.includes(estudiante.CARRERA)
                    );
                    
                    if (planDocente) {
                        // Determinar las carreras que comparten esta materia
                        const carrerasComparten = mallaData
                            .filter(m => m.MATERIA === materia.MATERIA)
                            .map(m => m.CARRERA)
                            .filter((v, i, a) => a.indexOf(v) === i) // Valores únicos
                            .join(' / ');
                        
                        planificacionEstudiante.push({
                            carrera: estudiante.CARRERA,
                            estudiante: estudiante.ESTUDIANTE,
                            cicloEstudiante: estudiante.CICLO,
                            malla: estudiante.MALLA,
                            cicloMateria: materia.CICLO,
                            carrerasComparten: carrerasComparten,
                            materia: materia.MATERIA,
                            paralelo: planDocente.paralelo,
                            dia: planDocente.dia,
                            hora: planDocente.hora,
                            modalidad: planDocente.modalidad,
                            nivelIngles: estudiante['NIVEL DE INGLES'] || '',
                            observaciones: '',
                            docente: planDocente.docente
                        });
                    }
                });
            });
        }

        // Función para generar datos de materias
        function generarDatosMaterias() {
            materiasData = [];
            
            // Agrupar materias por nombre, malla y ciclo
            const materiasAgrupadas = {};
            
            planificacionDocente.forEach(plan => {
                const key = `${plan.materia}-${plan.cicloMalla}-${plan.malla}`;
                
                if (!materiasAgrupadas[key]) {
                    materiasAgrupadas[key] = {
                        malla: plan.malla,
                        cicloMateria: plan.cicloMalla,
                        carrerasComparten: plan.carrerasComparten,
                        materia: plan.materia,
                        paralelo: plan.paralelo,
                        dia: plan.dia,
                        hora: plan.hora,
                        numEstudiantes: 0
                    };
                }
                
                // Contar estudiantes para esta materia
                materiasAgrupadas[key].numEstudiantes += planificacionEstudiante.filter(est => 
                    est.materia === plan.materia && 
                    est.malla == plan.malla && 
                    est.cicloMateria == plan.cicloMalla
                ).length;
            });
            
            // Convertir el objeto a array
            for (const key in materiasAgrupadas) {
                materiasData.push(materiasAgrupadas[key]);
            }
        }

        // Función para mostrar la planificación docente en la tabla
        function mostrarPlanificacionDocente() {
            const tableBody = document.querySelector('#docente-table tbody');
            tableBody.innerHTML = '';
            
            const carreraFilter = document.getElementById('filter-carrera-doc').value;
            const docenteFilter = document.getElementById('filter-docente').value;
            const modalidadFilter = document.getElementById('filter-modalidad').value;
            
            const filteredData = planificacionDocente.filter(item => {
                return (!carreraFilter || item.carrerasComparten.includes(carreraFilter)) &&
                       (!docenteFilter || item.docente === docenteFilter) &&
                       (!modalidadFilter || item.modalidad === modalidadFilter);
            });
            
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.docente}</td>
                    <td>${item.titulo}</td>
                    <td>${item.dedicacion}</td>
                    <td>${item.materia}</td>
                    <td>${item.codigoAnthology}</td>
                    <td>${item.carrerasComparten}</td>
                    <td>${item.prerequisito}</td>
                    <td>${item.codigo}</td>
                    <td>${item.horasTeoricas}</td>
                    <td>${item.horasPracticas}</td>
                    <td>${item.horasAutonomas}</td>
                    <td>${item.creditos}</td>
                    <td>${item.campoFormacion}</td>
                    <td>${item.cicloMalla}</td>
                    <td>${item.ordenMalla}</td>
                    <td>${item.paralelo}</td>
                    <td>${item.dia}</td>
                    <td>${item.hora}</td>
                    <td>${item.modalidad}</td>
                    <td>${item.numHoras}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Función para mostrar la planificación estudiante en la tabla
        function mostrarPlanificacionEstudiante() {
            const tableBody = document.querySelector('#estudiante-table tbody');
            tableBody.innerHTML = '';
            
            const carreraFilter = document.getElementById('filter-carrera-est').value;
            const cicloFilter = document.getElementById('filter-ciclo-est').value;
            const mallaFilter = document.getElementById('filter-malla-est').value;
            
            const filteredData = planificacionEstudiante.filter(item => {
                return (!carreraFilter || item.carrera === carreraFilter) &&
                       (!cicloFilter || item.cicloEstudiante == cicloFilter) &&
                       (!mallaFilter || item.malla == mallaFilter);
            });
            
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.carrera}</td>
                    <td>${item.estudiante}</td>
                    <td>${item.cicloEstudiante}</td>
                    <td>${item.malla}</td>
                    <td>${item.cicloMateria}</td>
                    <td>${item.carrerasComparten}</td>
                    <td>${item.materia}</td>
                    <td>${item.paralelo}</td>
                    <td>${item.dia}</td>
                    <td>${item.hora}</td>
                    <td>${item.modalidad}</td>
                    <td>${item.nivelIngles}</td>
                    <td>${item.observaciones}</td>
                    <td>${item.docente}</td>
                    <td>
                        <button class="btn-cambiar" data-estudiante="${item.estudiante}" data-materia="${item.materia}">Cambiar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Agregar event listeners a los botones de cambiar
            document.querySelectorAll('.btn-cambiar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const estudiante = this.getAttribute('data-estudiante');
                    const materia = this.getAttribute('data-materia');
                    cambiarMateriaEstudiante(estudiante, materia);
                });
            });
        }

        // Función para mostrar las materias en la tabla
        function mostrarMaterias() {
            const tableBody = document.querySelector('#materias-table tbody');
            tableBody.innerHTML = '';
            
            const carreraFilter = document.getElementById('filter-carrera-mat').value;
            const cicloFilter = document.getElementById('filter-ciclo-mat').value;
            const mallaFilter = document.getElementById('filter-malla-mat').value;
            
            const filteredData = materiasData.filter(item => {
                return (!carreraFilter || item.carrerasComparten.includes(carreraFilter)) &&
                       (!cicloFilter || item.cicloMateria == cicloFilter) &&
                       (!mallaFilter || item.malla == mallaFilter);
            });
            
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.malla}</td>
                    <td>${item.cicloMateria}</td>
                    <td>${item.carrerasComparten}</td>
                    <td>${item.materia}</td>
                    <td>${item.paralelo}</td>
                    <td>${item.dia}</td>
                    <td>${item.hora}</td>
                    <td>${item.numEstudiantes}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Función para cambiar la materia de un estudiante
        function cambiarMateriaEstudiante(estudiante, materiaActual) {
            // Encontrar al estudiante en los datos
            const estudianteData = estudiantesData.find(e => e.ESTUDIANTE === estudiante);
            if (!estudianteData) return;
            
            // Encontrar la materia actual en la planificación
            const planIndex = planificacionEstudiante.findIndex(p => 
                p.estudiante === estudiante && p.materia === materiaActual
            );
            
            if (planIndex === -1) return;
            
            // Obtener ciclo del estudiante
            const cicloEstudiante = estudianteData['CICLO AL QUE VA'] || estudianteData.CICLO;
            
            // Obtener materias disponibles para este estudiante (que no estén ya asignadas)
            const materiasDisponibles = mallaData.filter(materia => 
                materia.CARRERA === estudianteData.CARRERA && 
                materia.MALLA == estudianteData.MALLA && 
                materia.CICLO == cicloEstudiante &&
                !planificacionEstudiante.some(p => 
                    p.estudiante === estudiante && p.materia === materia.MATERIA
                )
            );
            
            if (materiasDisponibles.length === 0) {
                alert('No hay materias disponibles para cambiar');
                return;
            }
            
            // Mostrar diálogo para seleccionar nueva materia
            const nuevaMateria = prompt(
                `Seleccione una nueva materia para ${estudiante}:\n` +
                materiasDisponibles.map((m, i) => `${i+1}. ${m.MATERIA}`).join('\n')
            );
            
            if (!nuevaMateria) return;
            
            const index = parseInt(nuevaMateria) - 1;
            if (isNaN(index) || index < 0 || index >= materiasDisponibles.length) {
                alert('Selección inválida');
                return;
            }
            
            const materiaSeleccionada = materiasDisponibles[index];
            
            // Buscar la planificación docente para la nueva materia
            const planDocente = planificacionDocente.find(p => 
                p.materia === materiaSeleccionada.MATERIA && 
                p.carrerasComparten.includes(estudianteData.CARRERA)
            );
            
            if (!planDocente) {
                alert('No hay horario disponible para esta materia');
                return;
            }
            
            // Verificar si hay conflicto de horario con otras materias del estudiante
            const tieneConflicto = planificacionEstudiante.some(p => 
                p.estudiante === estudiante && 
                p.materia !== materiaActual &&
                p.dia === planDocente.dia && 
                p.hora === planDocente.hora
            );
            
            if (tieneConflicto) {
                if (!confirm('¡CONFLICTO DE HORARIO! ¿Desea asignar de todas formas?')) {
                    return;
                }
            }
            
            // Actualizar la planificación del estudiante
            planificacionEstudiante[planIndex] = {
                ...planificacionEstudiante[planIndex],
                materia: materiaSeleccionada.MATERIA,
                cicloMateria: materiaSeleccionada.CICLO,
                carrerasComparten: planDocente.carrerasComparten,
                paralelo: planDocente.paralelo,
                dia: planDocente.dia,
                hora: planDocente.hora,
                modalidad: planDocente.modalidad,
                docente: planDocente.docente
            };
            
            // Actualizar la tabla
            mostrarPlanificacionEstudiante();
            
            alert('Materia cambiada exitosamente');
        }

        // Función para agregar una restricción
        document.getElementById('add-restriction').addEventListener('click', function() {
            const carrera = document.getElementById('restriction-carrera').value;
            const ciclo = document.getElementById('restriction-ciclo').value;
            const dia = document.getElementById('restriction-dia').value;
            const hora = document.getElementById('restriction-hora').value;
            
            if (!carrera || !ciclo || !dia || !hora) {
                showNotification('Por favor, complete todos los campos.', 'error', 'restriction');
                return;
            }
            
            // Verificar si ya existe esta restricción
            const existe = restricciones.some(r => 
                r.carrera === carrera && r.ciclo == ciclo && r.dia === dia && r.hora === hora
            );
            
            if (existe) {
                showNotification('Esta restricción ya existe.', 'error', 'restriction');
                return;
            }
            
            // Agregar la restricción
            restricciones.push({ carrera, ciclo, dia, hora });
            
            // Actualizar la tabla de restricciones
            mostrarRestricciones();
            
            // Limpiar el formulario
            document.getElementById('restriction-carrera').value = '';
            document.getElementById('restriction-ciclo').value = '';
            document.getElementById('restriction-dia').value = '';
            document.getElementById('restriction-hora').value = '';
            
            showNotification('Restricción agregada correctamente.', 'success', 'restriction');
        });

        // Función para mostrar las restricciones
        function mostrarRestricciones() {
            const tableBody = document.querySelector('#restricciones-table tbody');
            tableBody.innerHTML = '';
            
            restricciones.forEach((restriccion, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${restriccion.carrera}</td>
                    <td>${restriccion.ciclo}</td>
                    <td>${restriccion.dia}</td>
                    <td>${restriccion.hora}</td>
                    <td>
                        <button class="btn-eliminar" data-index="${index}">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Agregar event listeners a los botones de eliminar
            document.querySelectorAll('.btn-eliminar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    restricciones.splice(index, 1);
                    mostrarRestricciones();
                    showNotification('Restricción eliminada correctamente.', 'success', 'restriction');
                });
            });
        }

        // Funciones auxiliares
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            // Guardar la opción seleccionada actualmente
            const selectedValue = select.value;
            
            // Limpiar el select (manteniendo la primera opción)
            const firstOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            // Agregar las nuevas opciones
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            
            // Restaurar la selección anterior si todavía existe
            if (selectedValue && Array.from(select.options).some(opt => opt.value === selectedValue)) {
                select.value = selectedValue;
            }
        }

        function showNotification(message, type, context = 'upload') {
            const notification = document.getElementById(`${context}-notification`);
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Funciones para cambiar entre pestañas
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remover la clase active de todas las pestañas y contenidos
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Agregar la clase active a la pestaña clickeada
                this.classList.add('active');
                
                // Mostrar el contenido correspondiente
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-content`).classList.add('active');
            });
        });

        // Aplicar filtros
        document.getElementById('apply-filters-doc').addEventListener('click', mostrarPlanificacionDocente);
        document.getElementById('apply-filters-est').addEventListener('click', mostrarPlanificacionEstudiante);
        document.getElementById('apply-filters-mat').addEventListener('click', mostrarMaterias);

        // Exportar a Excel
        document.getElementById('export-docente').addEventListener('click', function() {
            exportToExcel(planificacionDocente, 'planificacion_docente');
        });
        
        document.getElementById('export-estudiante').addEventListener('click', function() {
            exportToExcel(planificacionEstudiante, 'planificacion_estudiante');
        });
        
        document.getElementById('export-materias').addEventListener('click', function() {
            exportToExcel(materiasData, 'materias');
        });

        function exportToExcel(data, fileName) {
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, fileName);
            XLSX.writeFile(workbook, `${fileName}.xlsx`);
        }

        // Guardar cambios
        document.getElementById('save-docente').addEventListener('click', function() {
            // En una implementación real, aquí se guardarían los cambios en una base de datos
            alert('Cambios en la planificación docente guardados correctamente.');
        });
        
        document.getElementById('save-estudiante').addEventListener('click', function() {
            // En una implementación real, aquí se guardarían los cambios en una base de datos
            alert('Cambios en la planificación estudiantil guardados correctamente.');
        });
    </script>
</body>
</html>
