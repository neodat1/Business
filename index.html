<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Combinación Docentes × Estudiantes (robusto)</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{--bd:#e2e8f0;--bg:#f7fafc;--pri:#2563eb;--tx:#0f172a;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444}
  body{font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--tx);margin:0}
  .wrap{max-width:1200px;margin:auto;padding:20px}
  .card{background:#fff;border:1px solid var(--bd);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.04);padding:16px;margin-bottom:16px}
  h1{margin:0 0 10px;font-size:22px;color:var(--pri)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input[type=file],button{padding:10px;border:1px solid var(--bd);border-radius:10px;background:#fff}
  button{background:var(--pri);color:#fff;border:none;cursor:pointer}
  button.secondary{background:#fff;color:var(--tx);border:1px solid var(--bd)}
  .grid{display:grid;gap:16px}
  @media(min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid var(--bd);padding:8px;vertical-align:top}
  th{background:#f1f5f9;text-align:left;position:sticky;top:0}
  .muted{color:#64748b;font-size:13px}
  .ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}
  .badge{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid var(--bd);font-size:12px;margin-left:6px}
  .small{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Combinación Docentes × Estudiantes</h1>
    <div class="row">
      <label><b>PLANIFICACIÓN - DOCENTES.xlsx</b><br><input id="fileDoc" type="file" accept=".xlsx,.xls"></label>
      <label><b>PLANIFICACIÓN - ESTUDIANTES.xlsx</b><br><input id="fileEst" type="file" accept=".xlsx,.xls"></label>
      <label><b>(Opcional) Mallas.xlsx</b><br><input id="fileMal" type="file" accept=".xlsx,.xls"></label>
    </div>
    <div class="row">
      <button id="btnRun">Procesar</button>
      <button id="btnDown" class="secondary" style="display:none">Descargar (.xlsx)</button>
      <span id="diagCount" class="badge">diag</span>
    </div>
    <div class="small" id="diag"></div>
    <p class="muted">
      Salidas: <b>MATRIZ_SECCIONES</b> (7 col.), <b>COMBINACION</b> (7 + ESTUDIANTE),
      <b>RESUMEN_CARGA</b>, <b>RESUMEN_MATERIA</b>, <b>NO_ASIGNADOS</b>.
    </p>
  </div>
  <div class="grid">
    <div class="card"><h3>COMBINACION</h3><div id="tblCombo"></div></div>
    <div class="card"><h3>Carga por Docente</h3><div id="tblCarga"></div></div>
  </div>
  <div class="grid">
    <div class="card"><h3>Resumen Materia</h3><div id="tblResMat"></div></div>
    <div class="card"><h3>No Asignados</h3><div id="tblNo"></div></div>
  </div>
</div>

<script>
// ---------- Utilidades ----------
const TARGET7=["NOMBRE_DOCENTE","MATERIA","CANTIDAD DE ALUMNOS ESPERADOS","DIA","HORA","Modalidad","Paralelo"]; const COMBO8=[...TARGET7,"ESTUDIANTE"]; const esc=s=>String(s??"").replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
const DAY_MAP=new Map(Object.entries({"lun":"LUNES","lunes":"LUNES","lun.":"LUNES","mar":"MARTES","martes":"MARTES","mar.":"MARTES","mie":"MIERCOLES","mié":"MIERCOLES","miercoles":"MIERCOLES","miércoles":"MIERCOLES","mie.":"MIERCOLES","mié.":"MIERCOLES","jue":"JUEVES","jueves":"JUEVES","jue.":"JUEVES","vie":"VIERNES","viernes":"VIERNES","vie.":"VIERNES","sab":"SABADO","sáb":"SABADO","sabado":"SABADO","sábado":"SABADO","sab.":"SABADO","dom":"DOMINGO","domingo":"DOMINGO","dom.":"DOMINGO"}));
const canonDay=s=>{const t=String(s||"").toLowerCase().trim(); if(DAY_MAP.has(t)) return DAY_MAP.get(t); for(const [k,v] of DAY_MAP) if(t.includes(k)) return v; return String(s||"").toUpperCase().trim();};
function render(el,headers,rows,max=200){ if(!rows.length){ el.innerHTML='<p class="muted">Sin datos.</p>'; return;} const view=rows.slice(0,max); let h='<table><thead><tr>'+headers.map(h=>'<th>'+esc(h)+'</th>').join('')+'</tr></thead><tbody>'; for(const r of view){ h+='<tr>'+headers.map(k=>'<td>'+esc(r[k]??"")+'</td>').join('')+'</tr>'; } h+='</tbody></table>'; if(rows.length>max) h+='<p class="muted">Mostrando '+max+' de '+rows.length+'.</p>'; el.innerHTML=h; }
function readAllSheets(file){return new Promise((res,rej)=>{const fr=new FileReader(); fr.onload=e=>{try{const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); const out=[]; for(const name of wb.SheetNames){ const ws=wb.Sheets[name]; const rows=XLSX.utils.sheet_to_json(ws,{defval:""}); rows.forEach(r=>r.__sheet=name); out.push(...rows);} res(out);}catch(err){rej(err)}}; fr.onerror=rej; fr.readAsArrayBuffer(file);});}

// ---------- Mapeo robusto de columnas ----------
const mapCols=(row)=>{ // crea un alias -> valor por fila
  const obj={}; for(const [k,v] of Object.entries(row)){ if(/^__EMPTY/i.test(k)) continue; const kk=k.toString().trim(); obj[kk]=v; obj[kk.toUpperCase()]=v; obj[kk.replaceAll(' ','_').toUpperCase()]=v; }
  const get=(...labels)=>{ for(const lab of labels){ for(const key of Object.keys(obj)){ if(key===lab) return obj[key]; if(key.replaceAll('.','').replaceAll('_','').replaceAll(' ','')===lab.replaceAll('_','').replaceAll(' ','')) return obj[key]; if(key.includes(lab)) return obj[key]; } } return ""; };
  return {
    docente: get('NOMBRE_DOCENTE','DOCENTE','PROFESOR','NOMBREDOCENTE','NOMBRE DEL DOCENTE'),
    materia: get('MATERIA','ASIGNATURA','NOMBRE_ASIGNATURA','CURSO'),
    cupo: get('CANTIDAD_DE_ALUMNOS_ESPERADOS','CANTIDAD DE ALUMNOS ESPERADOS','CAPACIDAD','CUPOS','CUPO'),
    dia: get('DIA','DÍA','DIA1'),
    hora: get('HORA','HORARIO','HORA_CLASE'),
    modalidad: get('MODALIDAD','TIPO','TIPO_MODALIDAD'),
    paralelo: get('PARALELO','GRUPO','SECCION','SECCIÓN'),
    estudiante: get('ESTUDIANTE','NOMBRE_ESTUDIANTE','ALUMNO','NOMBRE ALUMNO'),
    materiasList: get('MATERIAS','ASIGNATURAS','MATERIA_SOLICITADA')
  };
};

function normalizeDocentes(rows){ const out=[]; for(const r of rows){ const m=mapCols(r); const M=(m.materia||"").toString().trim(); const D=canonDay(m.dia); const H=(m.hora||"").toString().trim(); if(!M||!D||!H) continue; out.push({"NOMBRE_DOCENTE": (m.docente||"").toString().trim(), "MATERIA": M, "CANTIDAD DE ALUMNOS ESPERADOS": Number(m.cupo||40)||40, "DIA": D, "HORA": H, "Modalidad": (m.modalidad||"").toString().trim(), "Paralelo": (m.paralelo||"").toString().toUpperCase().trim()}); } return out; }

function normalizeEstudiantes(rows){ const out=[]; for(const r of rows){ const m=mapCols(r); let materias=[]; const base=(m.materiasList||"").toString(); if(base){ materias=base.split(/[,;\/\n]/).map(s=>s.trim()).filter(Boolean);} else { // intentar columnas MATERIA1..MATERIA6
      for(const [k,v] of Object.entries(r)){ const kk=k.toString().toUpperCase(); if(kk.startsWith('MATERIA')||kk.startsWith('ASIGNATURA')){ if(String(v).trim()) materias.push(String(v).trim()); } }
    }
    const est=(m.estudiante||"").toString().trim(); if(!est||!materias.length) continue; out.push({ESTUDIANTE:est, MATERIAS:materias, Paralelo: (m.paralelo||"").toString().toUpperCase().trim()}); }
  return out; }

function normalizeMallas(rows){ const out=[]; for(const r of rows){ const m=mapCols(r); const M=(m.materia||"").toString().trim(); const D=canonDay(m.dia); const H=(m.hora||"").toString().trim(); if(!M||!D||!H) continue; out.push({MATERIA:M,DIA:D,HORA:H,Paralelo:(m.paralelo||"").toString().toUpperCase().trim(),CAPACIDAD:Number(m.cupo||0)||0}); } return out; }

// ---------- Construcción secciones y asignación ----------
function construirSecciones(doc,mall,est){ const key=(m,d,h,p)=>`${m}¦${d}¦${h}¦${p||''}`; const map=new Map();
  for(const m of mall){ const k=key(m.MATERIA,m.DIA,m.HORA,m.Paralelo); map.set(k,{MATERIA:m.MATERIA,DIA:m.DIA,HORA:m.HORA,Paralelo:m.Paralelo||"",NOMBRE_DOCENTE:"",Modalidad:"",CAP:m.CAPACIDAD||0,ASIGNADOS:0}); }
  for(const d of doc){ const k=key(d.MATERIA,d.DIA,d.HORA,d.Paralelo); const cap=d["CANTIDAD DE ALUMNOS ESPERADOS"]||40; if(!map.has(k)) map.set(k,{MATERIA:d.MATERIA,DIA:d.DIA,HORA:d.HORA,Paralelo:d.Paralelo||"",NOMBRE_DOCENTE:d.NOMBRE_DOCENTE,Modalidad:d.Modalidad||"",CAP:cap,ASIGNADOS:0}); else { const s=map.get(k); s.NOMBRE_DOCENTE=s.NOMBRE_DOCENTE||d.NOMBRE_DOCENTE; s.Modalidad=s.Modalidad||d.Modalidad||""; s.CAP=Math.max(s.CAP||0,cap||0);} }
  // paralelos automáticos si hay muchos estudiantes
  const count=new Map(); for(const e of est){ for(const m of e.MATERIAS){ count.set(m,(count.get(m)||0)+1); }}
  for(const [materia,n] of count){ if(n>25){ const needed=Math.ceil(n/25); const existentes=[...map.values()].filter(s=>s.MATERIA===materia); const base=existentes[0]||{DIA:'LUNES',HORA:'08:00-10:00',NOMBRE_DOCENTE:'POR ASIGNAR',Modalidad:'PRESENCIAL'}; for(let i=0;i<needed;i++){ const par=String.fromCharCode(65+i); const k=key(materia,base.DIA,base.HORA,par); if(!map.has(k)) map.set(k,{MATERIA:materia,DIA:base.DIA,HORA:base.HORA,Paralelo:par,NOMBRE_DOCENTE:base.NOMBRE_DOCENTE,Modalidad:base.Modalidad,CAP:25,ASIGNADOS:0}); } } }
  return [...map.values()]; }

function agruparPorMateria(secc){ const m=new Map(); for(const s of secc){ if(!m.has(s.MATERIA)) m.set(s.MATERIA,[]); m.get(s.MATERIA).push(s);} return m; }

function asignar(secc, est){ const porMat=agruparPorMateria(secc); const comb=[], noAsig=[]; const carga=new Map(); const kC=(d,m,p,h)=>`${d||'SIN_DOCENTE'}¦${m}¦${p||''}¦${h}`;
  for(const s of secc){ const k=kC(s.NOMBRE_DOCENTE,s.MATERIA,s.Paralelo,s.HORA); carga.set(k,{DOCENTE:s.NOMBRE_DOCENTE||'SIN_DOCENTE',MATERIA:s.MATERIA,Paralelo:s.Paralelo||'',DIA:s.DIA,HORA:s.HORA,ASIGNADOS:0,CAP:s.CAP||0}); }
  for(const e of est){ for(const m of e.MATERIAS){ const cand=(porMat.get(m)||[]).slice(); if(!cand.length){ noAsig.push({ESTUDIANTE:e.ESTUDIANTE,MATERIA:m,MOTIVO:'Sin secciones'}); continue;} cand.sort((a,b)=>{ const pref=e.Paralelo||''; const ha=pref && (a.Paralelo||'')===pref?1:0; const hb=pref && (b.Paralelo||'')===pref?1:0; if(ha!==hb) return hb-ha; const fa=(a.CAP||0)-(a.ASIGNADOS||0), fb=(b.CAP||0)-(b.ASIGNADOS||0); if(fa!==fb) return fb-fa; return (a.Paralelo||'').localeCompare(b.Paralelo||''); }); let ok=false; for(const s of cand){ const free=(s.CAP||0)-(s.ASIGNADOS||0); if(free<=0) continue; s.ASIGNADOS=(s.ASIGNADOS||0)+1; comb.push({ESTUDIANTE:e.ESTUDIANTE, "NOMBRE_DOCENTE":s.NOMBRE_DOCENTE||'', MATERIA:s.MATERIA, "CANTIDAD DE ALUMNOS ESPERADOS":s.CAP||'', DIA:s.DIA, HORA:s.HORA, Modalidad:s.Modalidad||'', Paralelo:s.Paralelo||''}); const key=kC(s.NOMBRE_DOCENTE,s.MATERIA,s.Paralelo,s.HORA); carga.get(key).ASIGNADOS++; ok=true; break;} if(!ok) noAsig.push({ESTUDIANTE:e.ESTUDIANTE,MATERIA:m,MOTIVO:'Sin cupo'}); } }
  const cargaArr=[...carga.values()].sort((a,b)=>a.DOCENTE.localeCompare(b.DOCENTE)||a.MATERIA.localeCompare(b.MATERIA)||a.Paralelo.localeCompare(b.Paralelo));
  const resMat=(()=>{ const map=new Map(); for(const s of secc){ const k=`${s.MATERIA}¦${s.Paralelo||''}`; if(!map.has(k)) map.set(k,{MATERIA:s.MATERIA,Paralelo:s.Paralelo||'',ASIGNADOS:0,CAP:0,OCUPACION:'0%'}); const o=map.get(k); o.CAP+=(s.CAP||0); o.ASIGNADOS+=(s.ASIGNADOS||0);} return [...map.values()].map(r=>({...r,OCUPACION:(r.CAP?Math.round(r.ASIGNADOS/r.CAP*100):0)+'%'})).sort((a,b)=>a.MATERIA.localeCompare(b.MATERIA)||a.Paralelo.localeCompare(b.Paralelo)); })();
  return {comb,noAsig,cargaArr,resMat,secc}; }

// ---------- UI ----------
let OUT_SECC=[], OUT_COMB=[], OUT_CARGA=[], OUT_RES_MAT=[], OUT_NO=[]; const diag=[]; const addDiag=(t)=>{diag.push(t); document.getElementById('diag').innerHTML=diag.map(x=>`<div class="small">• ${esc(x)}</div>`).join(''); document.getElementById('diagCount').innerText=`${diag.length} mensajes`; };

function renderAll(){ render(document.getElementById('tblCombo'),COMBO8,OUT_COMB,150); render(document.getElementById('tblCarga'),['DOCENTE','MATERIA','Paralelo','DIA','HORA','ASIGNADOS','CAP'],OUT_CARGA,200); render(document.getElementById('tblResMat'),['MATERIA','Paralelo','ASIGNADOS','CAP','OCUPACION'],OUT_RES_MAT,200); render(document.getElementById('tblNo'),['ESTUDIANTE','MATERIA','MOTIVO'],OUT_NO,200); }

document.getElementById('btnRun').addEventListener('click', async ()=>{
  diag.length=0; addDiag('Iniciando procesamiento...');
  const fD=document.getElementById('fileDoc').files[0]; const fE=document.getElementById('fileEst').files[0]; const fM=document.getElementById('fileMal').files[0]; if(!fD||!fE){ addDiag('Faltan archivos requeridos.'); alert('Carga DOCENTES y ESTUDIANTES.'); return; }
  try{
    const [rawD, rawE, rawM] = await Promise.all([readAllSheets(fD), readAllSheets(fE), fM? readAllSheets(fM): Promise.resolve([])]);
    addDiag(`DOCENTES: ${rawD.length} filas (todas las hojas).`); addDiag(`ESTUDIANTES: ${rawE.length} filas.`); if(rawM.length) addDiag(`MALLAS: ${rawM.length} filas.`);
    const DOC=normalizeDocentes(rawD); const EST=normalizeEstudiantes(rawE); const MAL=normalizeMallas(rawM);
    addDiag(`Docentes normalizados: ${DOC.length}`); addDiag(`Estudiantes normalizados: ${EST.length}`);
    const secc=construirSecciones(DOC,MAL,EST); addDiag(`Secciones construidas: ${secc.length}`);
    const {comb,noAsig,cargaArr,resMat,secc:finalSecc}=asignar(secc,EST);
    OUT_SECC=finalSecc.map(s=>({"NOMBRE_DOCENTE":s.NOMBRE_DOCENTE||'',"MATERIA":s.MATERIA,"CANTIDAD DE ALUMNOS ESPERADOS":s.CAP||'',"DIA":s.DIA,"HORA":s.HORA,"Modalidad":s.Modalidad||'',"Paralelo":s.Paralelo||''}));
    OUT_COMB=comb; OUT_NO=noAsig; OUT_CARGA=cargaArr; OUT_RES_MAT=resMat; addDiag(`Asignaciones: ${OUT_COMB.length}. No asignados: ${OUT_NO.length}.`);
    renderAll(); document.getElementById('btnDown').style.display='inline-block';
  }catch(err){ console.error(err); addDiag('Error: '+err.message); alert('Error al procesar: '+err.message); }
});

document.getElementById('btnDown').addEventListener('click',()=>{ const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(OUT_SECC),'MATRIZ_SECCIONES'); XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(OUT_COMB),'COMBINACION'); XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(OUT_CARGA),'RESUMEN_CARGA'); XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(OUT_RES_MAT),'RESUMEN_MATERIA'); XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(OUT_NO),'NO_ASIGNADOS'); XLSX.writeFile(wb,'Combinacion_Robusta.xlsx'); });
</script>
</body>
</html>
