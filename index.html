<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador Académico UIDE</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --azul: #04136C;
            --mostaza: #DE912E;
            --vino: #862B39;
            --celeste: #9CBEE3;
            --verde: #8A9520;
            --gris-claro: #f5f5f5;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            width: 95%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--azul);
            color: white;
            padding: 15px 0;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            margin-right: 15px;
            background-color: white;
            border-radius: 50%;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-text {
            font-size: 24px;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            background-color: var(--celeste);
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background-color: var(--celeste);
            transition: background-color 0.3s;
            font-weight: bold;
        }
        
        .tab.active {
            background-color: var(--mostaza);
            color: white;
        }
        
        .tab:hover:not(.active) {
            background-color: #b0c9e9;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-section {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .upload-title {
            color: var(--azul);
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .file-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .file-input {
            flex: 1;
            min-width: 250px;
        }
        
        .file-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--vino);
        }
        
        .file-input input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: var(--azul);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #030d4d;
        }
        
        .btn-secondary {
            background-color: var(--mostaza);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #c57e1f;
        }
        
        .btn-danger {
            background-color: var(--vino);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #6c2230;
        }
        
        .results-section {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        th {
            background-color: var(--azul);
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .constraints-section {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .constraint-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group select, .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .alert {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .student-edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
        }
        
        .subject-list {
            margin-top: 10px;
        }
        
        .subject-item {
            padding: 8px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .subject-item:hover {
            background-color: #f0f0f0;
        }
        
        .subject-item.selected {
            background-color: var(--celeste);
            border-color: var(--azul);
        }
        
        .time-slot {
            display: inline-block;
            padding: 2px 5px;
            background-color: var(--celeste);
            border-radius: 3px;
            margin-right: 5px;
            font-size: 12px;
        }
        
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--mostaza);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-status {
            margin-top: 5px;
            font-size: 12px;
            color: var(--vino);
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <div class="logo">
                <img src="UIDE-Ecuador.png" alt="UIDE Logo" onerror="this.style.display='none'">
            </div>
            <div class="logo-text">Planificador Académico UIDE</div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="upload">Cargar Archivos</div>
            <div class="tab" data-tab="constraints">Restricciones</div>
            <div class="tab" data-tab="docente">Planificación Docente</div>
            <div class="tab" data-tab="estudiante">Planificación Estudiante</div>
            <div class="tab" data-tab="materias">Materias</div>
        </div>

        <div class="tab-content active" id="upload">
            <div class="upload-section">
                <h3 class="upload-title">Cargar archivos Excel</h3>
                <div class="file-inputs">
                    <div class="file-input">
                        <label for="malla-file">Archivo de Mallas Curriculares</label>
                        <input type="file" id="malla-file" accept=".xlsx, .xls">
                        <div class="file-status" id="malla-status"></div>
                    </div>
                    <div class="file-input">
                        <label for="docente-file">Archivo de Docentes</label>
                        <input type="file" id="docente-file" accept=".xlsx, .xls">
                        <div class="file-status" id="docente-status"></div>
                    </div>
                    <div class="file-input">
                        <label for="estudiante-file">Archivo de Estudiantes</label>
                        <input type="file" id="estudiante-file" accept=".xlsx, .xls">
                        <div class="file-status" id="estudiante-status"></div>
                    </div>
                </div>
                <button class="btn btn-primary" id="process-btn">Procesar Archivos</button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Procesando archivos, por favor espere...</p>
            </div>

            <div class="alert alert-warning" id="upload-alert">
                <strong>Nota:</strong> Asegúrese de cargar los tres archivos Excel antes de procesar.
            </div>

            <div class="alert alert-danger" id="error-alert" style="display: none;">
                <strong>Error:</strong> <span id="error-message"></span>
            </div>
        </div>

        <div class="tab-content" id="constraints">
            <div class="constraints-section">
                <h3 class="upload-title">Restricciones de Horario</h3>
                <p>Agregue restricciones para evitar cruces con Prácticas Comunitarias u otras actividades.</p>
                
                <div class="constraint-form">
                    <div class="form-group">
                        <label for="constraint-carrera">Carrera</label>
                        <select id="constraint-carrera">
                            <option value="">Seleccionar carrera</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="constraint-ciclo">Ciclo</label>
                        <select id="constraint-ciclo">
                            <option value="">Seleccionar ciclo</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="constraint-dia">Día</label>
                        <select id="constraint-dia">
                            <option value="">Seleccionar día</option>
                            <option value="Lunes">Lunes</option>
                            <option value="Martes">Martes</option>
                            <option value="Miércoles">Miércoles</option>
                            <option value="Jueves">Jueves</option>
                            <option value="Viernes">Viernes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="constraint-hora">Franja Horaria</label>
                        <select id="constraint-hora">
                            <option value="">Seleccionar franja</option>
                            <option value="7-10">7:00 - 10:00</option>
                            <option value="10-13">10:00 - 13:00</option>
                            <option value="13-16">13:00 - 16:00</option>
                            <option value="16-19">16:00 - 19:00</option>
                            <option value="19-22">19:00 - 22:00</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-secondary" id="add-constraint-btn">Agregar Restricción</button>
                
                <div class="results-section">
                    <h3>Restricciones Actuales</h3>
                    <table id="constraints-table">
                        <thead>
                            <tr>
                                <th>Carrera</th>
                                <th>Ciclo</th>
                                <th>Día</th>
                                <th>Franja Horaria</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Las restricciones se mostrarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-content" id="docente">
            <div class="results-section">
                <h3>Planificación Docente</h3>
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-docente">Filtrar por Docente</label>
                        <select id="filter-docente">
                            <option value="">Todos los docentes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-carrera-docente">Filtrar por Carrera</label>
                        <select id="filter-carrera-docente">
                            <option value="">Todas las carreras</option>
                        </select>
                    </div>
                </div>
                <table id="docente-table">
                    <thead>
                        <tr>
                            <th>DOCENTE</th>
                            <th>TITULO ACADÉMICO</th>
                            <th>DEDICACIÓN</th>
                            <th>MATERIA</th>
                            <th>CÓDIGO ANTHOLOGY</th>
                            <th>CARRERAS QUE COMPARTEN</th>
                            <th>PRE-REQUISITO</th>
                            <th>CODIGO</th>
                            <th>HORAS TEÓRICAS</th>
                            <th>HORAS PRÁCTICAS</th>
                            <th>HORAS AUTÓNOMAS</th>
                            <th>CREDITOS</th>
                            <th>CAMPO DE FORMACIÓN</th>
                            <th>CICLO MALLA</th>
                            <th>Nº ORDEN EN LA MALLA</th>
                            <th>PARALELO</th>
                            <th>DIA</th>
                            <th>HORA</th>
                            <th>MODALIDAD</th>
                            <th>Nro. HORAS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos de planificación docente se mostrarán aquí -->
                    </tbody>
                </table>
                <div class="actions">
                    <button class="btn btn-primary" id="export-docente-btn">Exportar a Excel</button>
                </div>
            </div>
        </div>

        <div class="tab-content" id="estudiante">
            <div class="results-section">
                <h3>Planificación Estudiantil</h3>
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-estudiante">Filtrar por Estudiante</label>
                        <select id="filter-estudiante">
                            <option value="">Todos los estudiantes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-carrera-est">Filtrar por Carrera</label>
                        <select id="filter-carrera-est">
                            <option value="">Todas las carreras</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-ciclo-est">Filtrar por Ciclo</label>
                        <select id="filter-ciclo-est">
                            <option value="">Todos los ciclos</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>
                <table id="estudiante-table">
                    <thead>
                        <tr>
                            <th>CARRERA</th>
                            <th>ESTUDIANTE</th>
                            <th>CICLO DEL ESTUDIANTE</th>
                            <th>MALLA</th>
                            <th>CICLO DE LA MATERIA EN LA MALLA</th>
                            <th>COMPARTIDA CON CARRERA</th>
                            <th>MATERIA</th>
                            <th>PARALELO</th>
                            <th>DIA</th>
                            <th>HORA</th>
                            <th>MODALIDAD</th>
                            <th>NIVEL INGLES</th>
                            <th>OBSERVACIONES</th>
                            <th>DOCENTE</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos de planificación estudiantil se mostrarán aquí -->
                    </tbody>
                </table>
                <div class="actions">
                    <button class="btn btn-primary" id="export-estudiante-btn">Exportar a Excel</button>
                </div>
            </div>
        </div>

        <div class="tab-content" id="materias">
            <div class="results-section">
                <h3>Materias</h3>
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-materia">Filtrar por Materia</label>
                        <select id="filter-materia">
                            <option value="">Todas las materias</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-carrera-mat">Filtrar por Carrera</label>
                        <select id="filter-carrera-mat">
                            <option value="">Todas las carreras</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-ciclo-mat">Filtrar por Ciclo</label>
                        <select id="filter-ciclo-mat">
                            <option value="">Todos los ciclos</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>
                <table id="materias-table">
                    <thead>
                        <tr>
                            <th>MALLA</th>
                            <th>CICLO DE LA MATERIA EN LA MALLA</th>
                            <th>COMPARTIDA CON CARRERA</th>
                            <th>MATERIA</th>
                            <th>PARALELO</th>
                            <th>DIA</th>
                            <th>HORA</th>
                            <th>Número de estudiantes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos de materias se mostrarán aquí -->
                    </tbody>
                </table>
                <div class="actions">
                    <button class="btn btn-primary" id="export-materias-btn">Exportar a Excel</button>
                </div>
            </div>
        </div>

        <div class="student-edit-modal" id="student-edit-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Modificar Asignación de Estudiante</h3>
                    <span class="close">&times;</span>
                </div>
                <div id="modal-student-info"></div>
                <div class="form-group">
                    <label for="new-subject">Seleccionar Nueva Materia</label>
                    <select id="new-subject">
                        <option value="">Seleccionar materia</option>
                    </select>
                </div>
                <div id="subject-schedule-info"></div>
                <div id="schedule-conflict-alert" class="alert alert-danger" style="display: none;">
                    ¡Conflicto de horario! Esta materia se cruza con otra ya asignada.
                </div>
                <button class="btn btn-primary" id="confirm-change-btn">Confirmar Cambio</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales para almacenar los datos
        let mallasData = [];
        let docentesData = [];
        let estudiantesData = [];
        let planificacionDocente = [];
        let planificacionEstudiante = [];
        let planificacionMaterias = [];
        let constraints = [];
        let currentStudentEdit = null;

        // Elementos DOM
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const processBtn = document.getElementById('process-btn');
        const loadingElement = document.getElementById('loading');
        const addConstraintBtn = document.getElementById('add-constraint-btn');
        const studentEditModal = document.getElementById('student-edit-modal');
        const closeModalBtn = document.querySelector('.close');
        const confirmChangeBtn = document.getElementById('confirm-change-btn');
        const errorAlert = document.getElementById('error-alert');
        const errorMessage = document.getElementById('error-message');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Navegación por pestañas
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    activateTab(tabId);
                });
            });

            // Procesar archivos
            processBtn.addEventListener('click', processFiles);

            // Agregar restricción
            addConstraintBtn.addEventListener('click', addConstraint);

            // Cerrar modal
            closeModalBtn.addEventListener('click', () => {
                studentEditModal.style.display = 'none';
            });

            // Confirmar cambio de materia
            confirmChangeBtn.addEventListener('click', confirmStudentChange);

            // Filtrar tablas
            setupFilters();

            // Mostrar nombre de archivos cargados
            setupFileInputListeners();
        });

        // Configurar listeners para mostrar nombres de archivos
        function setupFileInputListeners() {
            document.getElementById('malla-file').addEventListener('change', function(e) {
                document.getElementById('malla-status').textContent = e.target.files[0]?.name || '';
            });
            
            document.getElementById('docente-file').addEventListener('change', function(e) {
                document.getElementById('docente-status').textContent = e.target.files[0]?.name || '';
            });
            
            document.getElementById('estudiante-file').addEventListener('change', function(e) {
                document.getElementById('estudiante-status').textContent = e.target.files[0]?.name || '';
            });
        }

        // Funciones de la aplicación
        function activateTab(tabId) {
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        function processFiles() {
            const mallaFile = document.getElementById('malla-file').files[0];
            const docenteFile = document.getElementById('docente-file').files[0];
            const estudianteFile = document.getElementById('estudiante-file').files[0];

            if (!mallaFile || !docenteFile || !estudianteFile) {
                alert('Por favor, cargue los tres archivos Excel.');
                return;
            }

            loadingElement.style.display = 'block';
            errorAlert.style.display = 'none';

            // Leer y procesar los archivos Excel
            Promise.all([
                readExcelFile(mallaFile),
                readExcelFile(docenteFile),
                readExcelFile(estudianteFile)
            ]).then(([mallaData, docenteData, estudianteData]) => {
                mallasData = mallaData;
                docentesData = docenteData;
                estudiantesData = estudianteData;

                // Validar estructura de datos
                if (!validateDataStructure()) {
                    throw new Error('Estructura de datos incorrecta en los archivos');
                }

                // Procesar los datos y generar planificación
                generatePlanification();

                // Actualizar las tablas
                updateDocenteTable();
                updateEstudianteTable();
                updateMateriasTable();

                // Ocultar loading
                loadingElement.style.display = 'none';

                // Mostrar mensaje de éxito
                alert('Planificación generada exitosamente.');
            }).catch(error => {
                console.error('Error processing files:', error);
                loadingElement.style.display = 'none';
                
                // Mostrar error específico
                errorMessage.textContent = error.message;
                errorAlert.style.display = 'block';
                
                alert('Error al procesar los archivos: ' + error.message);
            });
        }

        function validateDataStructure() {
            // Validar estructura de datos de docentes
            for (let i = 0; i < docentesData.length; i++) {
                const docente = docentesData[i];
                
                // Verificar si existe la propiedad MATERIAS y es un string
                if (!docente.hasOwnProperty('MATERIAS') || typeof docente.MATERIAS !== 'string') {
                    throw new Error(`El docente en la fila ${i+1} no tiene la propiedad MATERIAS o no es un texto válido`);
                }
                
                // Verificar otras propiedades necesarias
                if (!docente.hasOwnProperty('NOMBRE') || !docente.NOMBRE) {
                    throw new Error(`El docente en la fila ${i+1} no tiene nombre válido`);
                }
            }
            
            // Validar estructura de datos de mallas
            for (let i = 0; i < mallasData.length; i++) {
                const malla = mallasData[i];
                
                if (!malla.hasOwnProperty('MATERIA') || !malla.MATERIA) {
                    throw new Error(`La malla en la fila ${i+1} no tiene materia válida`);
                }
                
                if (!malla.hasOwnProperty('CARRERA') || !malla.CARRERA) {
                    throw new Error(`La malla en la fila ${i+1} no tiene carrera válida`);
                }
            }
            
            // Validar estructura de datos de estudiantes
            for (let i = 0; i < estudiantesData.length; i++) {
                const estudiante = estudiantesData[i];
                
                if (!estudiante.hasOwnProperty('NOMBRE') || !estudiante.NOMBRE) {
                    throw new Error(`El estudiante en la fila ${i+1} no tiene nombre válido`);
                }
                
                if (!estudiante.hasOwnProperty('CARRERA') || !estudiante.CARRERA) {
                    throw new Error(`El estudiante en la fila ${i+1} no tiene carrera válida`);
                }
            }
            
            return true;
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function(error) {
                    reject(error);
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        function generatePlanification() {
            // Aquí se implementaría la lógica compleja para generar la planificación
            // considerando todas las restricciones y requisitos
            
            // Esta es una implementación simplificada para demostración
            planificacionDocente = [];
            planificacionEstudiante = [];
            planificacionMaterias = [];
            
            // Procesar mallas y docentes para generar planificación docente
            mallasData.forEach(malla => {
                const docente = findAvailableDocente(malla.MATERIA, malla.CARRERA);
                if (docente) {
                    const horario = generateHorario(docente, malla);
                    
                    planificacionDocente.push({
                        DOCENTE: docente.NOMBRE,
                        TITULO_ACADEMICO: docente.TITULO || '',
                        DEDICACIÓN: docente.DEDICACION || '',
                        MATERIA: malla.MATERIA,
                        CODIGO_ANTHOLOGY: malla.CODIGO_ANTHOLOGY || '',
                        CARRERAS_QUE_COMPARTEN: malla.CARRERAS_COMPARTIDAS || '',
                        PRE_REQUISITO: malla.PRE_REQUISITO || '',
                        CODIGO: malla.CODIGO || '',
                        HORAS_TEORICAS: malla.H_TEORICAS || 0,
                        HORAS_PRACTICAS: malla.H_PRACTICAS || 0,
                        HORAS_AUTONOMAS: malla.H_AUTONOMAS || 0,
                        CREDITOS: malla.CREDITOS || 0,
                        CAMPO_FORMACION: malla.CAMPO_FORMACION || '',
                        CICLO_MALLA: malla.CICLO || '',
                        ORDEN_MALLA: malla.ORDEN_MALLA || '',
                        PARALELO: horario.paralelo,
                        DIA: horario.dia,
                        HORA: horario.hora,
                        MODALIDAD: horario.modalidad,
                        TOTAL_HORAS: (parseInt(malla.H_TEORICAS || 0) + parseInt(malla.H_PRACTICAS || 0))
                    });
                    
                    // Registrar la materia
                    const materiaIndex = planificacionMaterias.findIndex(m => 
                        m.MATERIA === malla.MATERIA && m.PARALELO === horario.paralelo
                    );
                    
                    if (materiaIndex === -1) {
                        planificacionMaterias.push({
                            MALLA: malla.CARRERA,
                            CICLO_MATERIA: malla.CICLO,
                            CARRERAS_COMPARTIDAS: malla.CARRERAS_COMPARTIDAS || '',
                            MATERIA: malla.MATERIA,
                            PARALELO: horario.paralelo,
                            DIA: horario.dia,
                            HORA: horario.hora,
                            NUM_ESTUDIANTES: 0
                        });
                    }
                }
            });
            
            // Asignar materias a estudiantes
            estudiantesData.forEach(estudiante => {
                const materiasEstudiante = findMateriasForStudent(estudiante);
                
                materiasEstudiante.forEach(materia => {
                    planificacionEstudiante.push({
                        CARRERA: estudiante.CARRERA,
                        ESTUDIANTE: estudiante.NOMBRE,
                        CICLO_ESTUDIANTE: estudiante.CICLO,
                        MALLA: estudiante.MALLA || estudiante.CARRERA,
                        CICLO_MATERIA: materia.CICLO_MATERIA,
                        CARRERAS_COMPARTIDAS: materia.CARRERAS_COMPARTIDAS,
                        MATERIA: materia.MATERIA,
                        PARALELO: materia.PARALELO,
                        DIA: materia.DIA,
                        HORA: materia.HORA,
                        MODALIDAD: materia.MODALIDAD,
                        NIVEL_INGLES: estudiante.NIVEL_INGLES || '',
                        OBSERVACIONES: '',
                        DOCENTE: materia.DOCENTE
                    });
                    
                    // Actualizar conteo de estudiantes en la materia
                    const materiaIndex = planificacionMaterias.findIndex(m => 
                        m.MATERIA === materia.MATERIA && m.PARALELO === materia.PARALELO
                    );
                    
                    if (materiaIndex !== -1) {
                        planificacionMaterias[materiaIndex].NUM_ESTUDIANTES++;
                    }
                });
            });
        }

        function findAvailableDocente(materia, carrera) {
            // Lógica simplificada para encontrar docente disponible
            // CORRECCIÓN: Verificar que la propiedad MATERIAS existe y es un string
            return docentesData.find(docente => {
                if (!docente.MATERIAS || typeof docente.MATERIAS !== 'string') {
                    console.warn(`Docente ${docente.NOMBRE} no tiene propiedad MATERIAS válida`);
                    return false;
                }
                
                return docente.MATERIAS.includes(materia) && 
                       checkDocenteAvailability(docente, materia, carrera);
            });
        }

        function checkDocenteAvailability(docente, materia, carrera) {
            // Verificar disponibilidad del docente según sus restricciones
            // Esta es una implementación simplificada
            return true;
        }

        function generateHorario(docente, malla) {
            // Generar horario considerando disponibilidad del docente y restricciones
            // Esta es una implementación simplificada
            const dias = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
            const franjas = ['7-10', '10-13', '13-16', '16-19', '19-22'];
            
            return {
                paralelo: 'A',
                dia: dias[Math.floor(Math.random() * dias.length)],
                hora: franjas[Math.floor(Math.random() * franjas.length)],
                modalidad: 'Presencial'
            };
        }

        function findMateriasForStudent(estudiante) {
            // Encontrar materias apropiadas para el estudiante según su carrera y ciclo
            // Esta es una implementación simplificada
            const materias = [];
            const maxMaterias = 6;
            
            // Filtrar materias por carrera y ciclo
            const materiasDisponibles = planificacionDocente.filter(materia => {
                const carrerasCompartidas = materia.CARRERAS_QUE_COMPARTEN.split('/');
                return (materia.CICLO_MALLA == estudiante.CICLO) && 
                       (materia.MALLA === estudiante.CARRERA || carrerasCompartidas.includes(estudiante.CARRERA));
            });
            
            // Seleccionar hasta 6 materias sin conflictos de horario
            for (let i = 0; i < Math.min(maxMaterias, materiasDisponibles.length); i++) {
                if (i < materiasDisponibles.length) {
                    const materia = materiasDisponibles[i];
                    if (!hasScheduleConflict(materias, materia)) {
                        materias.push({
                            MATERIA: materia.MATERIA,
                            PARALELO: materia.PARALELO,
                            DIA: materia.DIA,
                            HORA: materia.HORA,
                            MODALIDAD: materia.MODALIDAD,
                            DOCENTE: materia.DOCENTE,
                            CICLO_MATERIA: materia.CICLO_MALLA,
                            CARRERAS_COMPARTIDAS: materia.CARRERAS_QUE_COMPARTEN
                        });
                    }
                }
            }
            
            return materias;
        }

        function hasScheduleConflict(materiasAsignadas, nuevaMateria) {
            // Verificar si la nueva materia tiene conflicto de horario con las ya asignadas
            for (const materia of materiasAsignadas) {
                if (materia.DIA === nuevaMateria.DIA && materia.HORA === nuevaMateria.HORA) {
                    return true;
                }
            }
            return false;
        }

        function updateDocenteTable() {
            const tableBody = document.getElementById('docente-table').querySelector('tbody');
            tableBody.innerHTML = '';
            
            const filterDocente = document.getElementById('filter-docente').value;
            const filterCarrera = document.getElementById('filter-carrera-docente').value;
            
            const filteredData = planificacionDocente.filter(item => {
                return (!filterDocente || item.DOCENTE === filterDocente) &&
                       (!filterCarrera || item.CARRERAS_QUE_COMPARTEN.includes(filterCarrera));
            });
            
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.DOCENTE}</td>
                    <td>${item.TITULO_ACADEMICO}</td>
                    <td>${item.DEDICACIÓN}</td>
                    <td>${item.MATERIA}</td>
                    <td>${item.CODIGO_ANTHOLOGY}</td>
                    <td>${item.CARRERAS_QUE_COMPARTEN}</td>
                    <td>${item.PRE_REQUISITO}</td>
                    <td>${item.CODIGO}</td>
                    <td>${item.HORAS_TEORICAS}</td>
                    <td>${item.HORAS_PRACTICAS}</td>
                    <td>${item.HORAS_AUTONOMAS}</td>
                    <td>${item.CREDITOS}</td>
                    <td>${item.CAMPO_FORMACION}</td>
                    <td>${item.CICLO_MALLA}</td>
                    <td>${item.ORDEN_MALLA}</td>
                    <td>${item.PARALELO}</td>
                    <td>${item.DIA}</td>
                    <td>${item.HORA}</td>
                    <td>${item.MODALIDAD}</td>
                    <td>${item.TOTAL_HORAS}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateEstudianteTable() {
            const tableBody = document.getElementById('estudiante-table').querySelector('tbody');
            tableBody.innerHTML = '';
            
            const filterEstudiante = document.getElementById('filter-estudiante').value;
            const filterCarrera = document.getElementById('filter-carrera-est').value;
            const filterCiclo = document.getElementById('filter-ciclo-est').value;
            
            const filteredData = planificacionEstudiante.filter(item => {
                return (!filterEstudiante || item.ESTUDIANTE === filterEstudiante) &&
                       (!filterCarrera || item.CARRERA === filterCarrera) &&
                       (!filterCiclo || item.CICLO_ESTUDIANTE == filterCiclo);
            });
            
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.CARRERA}</td>
                    <td>${item.ESTUDIANTE}</td>
                    <td>${item.CICLO_ESTUDIANTE}</td>
                    <td>${item.MALLA}</td>
                    <td>${item.CICLO_MATERIA}</td>
                    <td>${item.CARRERAS_COMPARTIDAS}</td>
                    <td>${item.MATERIA}</td>
                    <td>${item.PARALELO}</td>
                    <td>${item.DIA}</td>
                    <td>${item.HORA}</td>
                    <td>${item.MODALIDAD}</td>
                    <td>${item.NIVEL_INGLES}</td>
                    <td>${item.OBSERVACIONES}</td>
                    <td>${item.DOCENTE}</td>
                    <td>
                        <button class="btn btn-secondary btn-edit" data-student="${item.ESTUDIANTE}" data-materia="${item.MATERIA}">Editar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Agregar event listeners a los botones de edición
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentName = this.getAttribute('data-student');
                    const currentMateria = this.getAttribute('data-materia');
                    openEditModal(studentName, currentMateria);
                });
            });
        }

        function updateMateriasTable() {
            const tableBody = document.getElementById('materias-table').querySelector('tbody');
            tableBody.innerHTML = '';
            
            const filterMateria = document.getElementById('filter-materia').value;
            const filterCarrera = document.getElementById('filter-carrera-mat').value;
            const filterCiclo = document.getElementById('filter-ciclo-mat').value;
            
            const filteredData = planificacionMaterias.filter(item => {
                return (!filterMateria || item.MATERIA === filterMateria) &&
                       (!filterCarrera || item.MALLA === filterCarrera) &&
                       (!filterCiclo || item.CICLO_MATERIA == filterCiclo);
            });
            
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.MALLA}</td>
                    <td>${item.CICLO_MATERIA}</td>
                    <td>${item.CARRERAS_COMPARTIDAS}</td>
                    <td>${item.MATERIA}</td>
                    <td>${item.PARALELO}</td>
                    <td>${item.DIA}</td>
                    <td>${item.HORA}</td>
                    <td>${item.NUM_ESTUDIANTES}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function setupFilters() {
            // Configurar opciones de filtros (simplificado)
            // En una implementación real, se poblarían con datos reales
        }

        function addConstraint() {
            const carrera = document.getElementById('constraint-carrera').value;
            const ciclo = document.getElementById('constraint-ciclo').value;
            const dia = document.getElementById('constraint-dia').value;
            const hora = document.getElementById('constraint-hora').value;
            
            if (!carrera || !ciclo || !dia || !hora) {
                alert('Por favor, complete todos los campos de la restricción.');
                return;
            }
            
            constraints.push({
                carrera,
                ciclo,
                dia,
                hora
            });
            
            updateConstraintsTable();
            
            // Limpiar formulario
            document.getElementById('constraint-carrera').value = '';
            document.getElementById('constraint-ciclo').value = '';
            document.getElementById('constraint-dia').value = '';
            document.getElementById('constraint-hora').value = '';
        }

        function updateConstraintsTable() {
            const tableBody = document.querySelector('#constraints-table tbody');
            tableBody.innerHTML = '';
            
            constraints.forEach((constraint, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${constraint.carrera}</td>
                    <td>${constraint.ciclo}</td>
                    <td>${constraint.dia}</td>
                    <td>${constraint.hora}</td>
                    <td>
                        <button class="btn btn-danger btn-remove-constraint" data-index="${index}">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Agregar event listeners a los botones de eliminar
            document.querySelectorAll('.btn-remove-constraint').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    constraints.splice(index, 1);
                    updateConstraintsTable();
                });
            });
        }

        function openEditModal(studentName, currentMateria) {
            currentStudentEdit = { studentName, currentMateria };
            
            // Encontrar al estudiante y sus materias
            const student = estudiantesData.find(e => e.NOMBRE === studentName);
            const studentMaterias = planificacionEstudiante.filter(e => e.ESTUDIANTE === studentName);
            
            // Mostrar información del estudiante
            document.getElementById('modal-student-info').innerHTML = `
                <p><strong>Estudiante:</strong> ${studentName}</p>
                <p><strong>Carrera:</strong> ${student.CARRERA}</p>
                <p><strong>Ciclo:</strong> ${student.CICLO}</p>
                <p><strong>Materia actual:</strong> ${currentMateria}</p>
            `;
            
            // Encontrar materias disponibles para el estudiante
            const availableMaterias = planificacionDocente.filter(materia => {
                const carrerasCompartidas = materia.CARRERAS_QUE_COMPARTEN.split('/');
                return (materia.CICLO_MALLA == student.CICLO) && 
                       (materia.MALLA === student.CARRERA || carrerasCompartidas.includes(student.CARRERA));
            });
            
            // Poblar el selector de materias
            const subjectSelect = document.getElementById('new-subject');
            subjectSelect.innerHTML = '<option value="">Seleccionar materia</option>';
            
            availableMaterias.forEach(materia => {
                const option = document.createElement('option');
                option.value = materia.MATERIA;
                option.textContent = `${materia.MATERIA} (${materia.DIA} ${materia.HORA})`;
                option.setAttribute('data-dia', materia.DIA);
                option.setAttribute('data-hora', materia.HORA);
                subjectSelect.appendChild(option);
            });
            
            // Mostrar el modal
            studentEditModal.style.display = 'flex';
            
            // Event listener para cambio de materia seleccionada
            subjectSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const dia = selectedOption.getAttribute('data-dia');
                const hora = selectedOption.getAttribute('data-hora');
                
                if (dia && hora) {
                    document.getElementById('subject-schedule-info').innerHTML = `
                        <p><strong>Horario:</strong> ${dia} ${hora}</p>
                    `;
                    
                    // Verificar conflictos de horario
                    const hasConflict = checkStudentScheduleConflict(studentMaterias, dia, hora, currentMateria);
                    document.getElementById('schedule-conflict-alert').style.display = hasConflict ? 'block' : 'none';
                } else {
                    document.getElementById('subject-schedule-info').innerHTML = '';
                    document.getElementById('schedule-conflict-alert').style.display = 'none';
                }
            });
        }

        function checkStudentScheduleConflict(studentMaterias, newDia, newHora, currentMateria) {
            // Verificar si el nuevo horario conflictúa con otras materias del estudiante
            for (const materia of studentMaterias) {
                if (materia.MATERIA !== currentMateria && 
                    materia.DIA === newDia && 
                    materia.HORA === newHora) {
                    return true;
                }
            }
            return false;
        }

        function confirmStudentChange() {
            const newSubject = document.getElementById('new-subject').value;
            
            if (!newSubject) {
                alert('Por favor, seleccione una materia.');
                return;
            }
            
            const selectedOption = document.getElementById('new-subject').options[document.getElementById('new-subject').selectedIndex];
            const newDia = selectedOption.getAttribute('data-dia');
            const newHora = selectedOption.getAttribute('data-hora');
            
            // Encontrar la materia en planificación docente para obtener todos los datos
            const materiaDocente = planificacionDocente.find(m => m.MATERIA === newSubject && m.DIA === newDia && m.HORA === newHora);
            
            if (!materiaDocente) {
                alert('Error: No se encontró la información completa de la materia.');
                return;
            }
            
            // Actualizar la planificación del estudiante
            const studentIndex = planificacionEstudiante.findIndex(e => 
                e.ESTUDIANTE === currentStudentEdit.studentName && 
                e.MATERIA === currentStudentEdit.currentMateria
            );
            
            if (studentIndex !== -1) {
                planificacionEstudiante[studentIndex].MATERIA = newSubject;
                planificacionEstudiante[studentIndex].PARALELO = materiaDocente.PARALELO;
                planificacionEstudiante[studentIndex].DIA = newDia;
                planificacionEstudiante[studentIndex].HORA = newHora;
                planificacionEstudiante[studentIndex].MODALIDAD = materiaDocente.MODALIDAD;
                planificacionEstudiante[studentIndex].DOCENTE = materiaDocente.DOCENTE;
                planificacionEstudiante[studentIndex].CICLO_MATERIA = materiaDocente.CICLO_MALLA;
                planificacionEstudiante[studentIndex].CARRERAS_COMPARTIDAS = materiaDocente.CARRERAS_QUE_COMPARTEN;
                
                // Actualizar conteo de estudiantes en materias
                const oldMateriaIndex = planificacionMaterias.findIndex(m => 
                    m.MATERIA === currentStudentEdit.currentMateria && 
                    m.PARALELO === planificacionEstudiante[studentIndex].PARALELO
                );
                
                if (oldMateriaIndex !== -1) {
                    planificacionMaterias[oldMateriaIndex].NUM_ESTUDIANTES--;
                }
                
                const newMateriaIndex = planificacionMaterias.findIndex(m => 
                    m.MATERIA === newSubject && 
                    m.PARALELO === materiaDocente.PARALELO
                );
                
                if (newMateriaIndex !== -1) {
                    planificacionMaterias[newMateriaIndex].NUM_ESTUDIANTES++;
                }
                
                // Actualizar tablas
                updateEstudianteTable();
                updateMateriasTable();
                
                // Cerrar modal
                studentEditModal.style.display = 'none';
                
                alert('Materia actualizada exitosamente.');
            } else {
                alert('Error: No se encontró la asignación del estudiante.');
            }
        }

        // Funciones de exportación a Excel
        document.getElementById('export-docente-btn').addEventListener('click', function() {
            exportToExcel(planificacionDocente, 'planificacion_docente');
        });

        document.getElementById('export-estudiante-btn').addEventListener('click', function() {
            exportToExcel(planificacionEstudiante, 'planificacion_estudiante');
        });

        document.getElementById('export-materias-btn').addEventListener('click', function() {
            exportToExcel(planificacionMaterias, 'planificacion_materias');
        });

        function exportToExcel(data, fileName) {
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Datos');
            XLSX.writeFile(workbook, `${fileName}.xlsx`);
        }
    </script>
</body>
</html>
