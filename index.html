<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planificador Académico UIDE</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{
  /* Colores institucionales */
  --azul:#04136C; --mostaza:#DE912E; --vino:#862B39; --celeste:#9CBEE3; --verde:#8A9520;

  /* Tema claro */
  --bg:#f8fafc; --panel:#ffffff; --text:#0f172a; --text-dim:#334155;
  --chip:#e2e8f0; --stroke:rgba(2,6,23,.12); --shadow:0 10px 30px rgba(2,6,23,.08);
  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
header{padding:18px 16px;background:#fff;border-bottom:2px solid var(--azul)}
.brand{display:flex;align-items:center;gap:12px}
.brand h1{margin:0;font-size:18px;color:var(--azul);font-weight:800;letter-spacing:.2px}
.brand small{color:var(--vino);font-weight:700}
.container{max-width:1280px;margin:0 auto;padding:14px}
.row{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
.card{background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow)}
.section{padding:14px}
h2{margin:0 0 8px 0;font-size:15px;color:var(--azul)}
.pill{display:inline-flex;gap:8px;align-items:center;background:var(--chip);border:1px solid var(--stroke);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--text-dim)}
.legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.uploads{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.upl{padding:10px;background:#f1f5f9;border:1px dashed var(--stroke);border-radius:12px}
.upl label{display:block;font-size:12px;color:var(--text-dim);margin-bottom:6px}
.upl input[type=file]{width:100%}

.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
button{border:none;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer}
.btn{background:var(--azul);color:#fff}
.btn-sec{background:#fff;color:var(--azul);border:1px solid var(--azul)}
.btn-ok{background:var(--verde);color:#fff}
.btn-warn{background:var(--vino);color:#fff}
.btn:disabled,.btn-sec:disabled,.btn-ok:disabled{opacity:.55;cursor:not-allowed}
.small{font-size:12px;color:var(--text-dim)}

.tabs{display:flex;gap:6px;margin:8px 0}
.tab{padding:7px 10px;border-radius:999px;background:#eef2ff;color:#111827;border:1px solid var(--stroke);cursor:pointer;font-weight:700}
.tab.active{background:#fff;color:var(--azul);border-color:var(--azul)}

.grid{display:grid;grid-template-columns:140px repeat(5,1fr);border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
.grid .cell{border-bottom:1px solid var(--stroke);border-right:1px dashed var(--stroke);padding:8px;min-height:64px;background:#fff;font-size:12px}
.grid .header{background:var(--celeste);font-weight:800;color:var(--azul)}
.grid .slot{background:#f8fafc;font-weight:700}
.tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#eff6ff;color:#1d4ed8;margin:2px 2px 0 0;border:1px solid #bfdbfe}
.tag-block{background:#fff1f2;color:#b91c1c;border:1px solid #fecaca}

.table{width:100%;border-collapse:collapse;background:#fff;margin-top:8px;font-size:13px}
.table th,.table td{border-bottom:1px solid var(--stroke);padding:8px;text-align:left}
.table th{background:#f8fafc;color:#0f172a}
.table tr:hover{background:#f8fafc}

fieldset{border:1px solid var(--stroke);border-radius:12px;background:#fff}
legend{font-size:12px;color:var(--azul);padding:0 6px;font-weight:800}
.note{font-size:12px;color:var(--text-dim)}

.modal{position:fixed;inset:0;background:rgba(2,6,23,.35);display:none;align-items:center;justify-content:center;z-index:40}
.dialog{width:min(880px,92vw);background:#fff;border:1px solid var(--stroke);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.select,.input{width:100%;background:#fff;color:var(--text);border:1px solid var(--stroke);padding:8px;border-radius:8px}
.hr{height:1px;background:var(--stroke);margin:10px 0}
.bad{color:#b91c1c}.good{color:#065f46}.warnText{color:#92400e}
.export{display:flex;gap:6px;margin-top:6px}
.logo{height:40px}
.brandbar{height:4px;background:linear-gradient(90deg,var(--azul),var(--mostaza),var(--vino),var(--celeste),var(--verde))}
</style>
</head>
<body>
<header>
  <div class="container brand">
    <img src="UIDE-Ecuador.png" alt="UIDE" class="logo"/>
    <div>
      <h1>Planificador Académico • UIDE</h1>
      <small>HTML único • Sin servidor</small>
      <div class="legend" style="margin-top:6px">
        <span class="pill">Días: L–V</span>
        <span class="pill">Franjas: 7–10, 10–13, 13–16, 16–19, 19–22</span>
        <span class="pill">Máx. 2 por día (docentes y estudiantes)</span>
        <span class="pill">Máx. 6 por estudiante</span>
        <span class="pill">Ciclos adyacentes sin choque</span>
      </div>
    </div>
  </div>
  <div class="brandbar"></div>
</header>

<div class="container row">
  <!-- IZQUIERDA -->
  <section class="card section">
    <h2>Cargar Excel y ejecutar</h2>
    <div class="uploads">
      <div class="upl">
        <label for="fileMalla">Mallas.xlsx (obligatorio)</label>
        <input id="fileMalla" type="file" accept=".xlsx,.xls" />
        <div class="small">Debe incluir (con sinónimos válidos): <b>Carrera</b>, <b>Ciclo</b>, <b>Materia</b>. Opcionales: <i>Paralelos</i>, <i>Compartida con</i>, <i>Código</i>, <i>Código Anthology</i>, <i>Pre-requisito</i>, <i>Horas Teóricas/Prácticas/Autónomas</i>, <i>Créditos</i>, <i>Campo de Formación</i>, <i>Modalidad</i>, <i>N° Orden</i>.</div>
      </div>
      <div class="upl">
        <label for="fileDocentes">Docentes.xlsx (obligatorio)</label>
        <input id="fileDocentes" type="file" accept=".xlsx,.xls" />
        <div class="small">Debe incluir: <b>Docente</b>, <b>Carrera</b>, <b>Materia</b>. Opcionales: <i>Título Académico</i>, <i>Dedicación</i>, <i>Modalidad</i>, y <b>disponibilidad</b> por columnas tipo <i>Lunes 7-10</i> / campo <i>Disponibilidad</i> con “Lunes 7-10; …”.</div>
      </div>
      <div class="upl">
        <label for="fileEstudiantes">Estudiantes.xlsx (obligatorio)</label>
        <input id="fileEstudiantes" type="file" accept=".xlsx,.xls" />
        <div class="small">Debe incluir: <b>Estudiante</b>, <b>Carrera</b>, <b>Ciclo</b>. Opcionales: <i>Nivel Inglés</i>, <i>Prácticas</i>.</div>
      </div>
    </div>

    <div class="controls">
      <button id="btnAnalizar" class="btn">Validar & leer 100 %</button>
      <button id="btnConfig" class="btn-sec" disabled>Configurar bloqueos</button>
      <button id="btnAsignar" class="btn-ok" disabled>Generar planificación</button>
      <button id="btnLimpiar" class="btn-sec">Reiniciar</button>
      <span id="status" class="small"></span>
    </div>

    <hr class="hr"/>

    <div class="tabs">
      <div class="tab active" data-tab="estudiantes">Vista estudiantes</div>
      <div class="tab" data-tab="docentes">Vista docentes</div>
      <div class="tab" data-tab="listas">Listas de salida</div>
    </div>

    <!-- VISTA ESTUDIANTES -->
    <div id="view-estudiantes">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px">
        <select id="selEstudiante" class="select" disabled>
          <option value="">— Seleccione estudiante —</option>
        </select>
        <button id="btnEditar" class="btn-sec" disabled>Editar asignación (estudiante)</button>
        <span class="small">La edición valida choques y límites y solo aplica al estudiante.</span>
      </div>
      <div id="kpiEst" style="display:none" class="legend">
        <span class="pill">Materias: <b id="kTotal">0</b>/6</span>
        <span class="pill">Choques: <b id="kChoques">0</b></span>
        <span class="pill">Bloqueos activos: <b id="kBlocks">0</b></span>
      </div>
      <div class="grid" id="gridEstudiante"></div>
      <table class="table" id="tablaEst" style="display:none">
        <thead><tr><th>Materia</th><th>Paralelo</th><th>Día</th><th>Franja</th><th>Docente</th><th>Carrera</th><th>Ciclo</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- VISTA DOCENTES -->
    <div id="view-docentes" style="display:none">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px">
        <select id="selDocente" class="select" disabled><option value="">— Seleccione docente —</option></select>
      </div>
      <div class="grid" id="gridDocente"></div>
      <table class="table" id="tablaDoc" style="display:none">
        <thead><tr><th>Día</th><th>Franja</th><th>Materia</th><th>Paralelo</th><th>Carrera</th><th>Ciclo</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- LISTAS DE SALIDA -->
    <div id="view-listas" style="display:none">
      <div class="card section" style="margin-bottom:10px">
        <h2>Planificación docente</h2>
        <div class="export">
          <button id="expDocente" class="btn-sec">Exportar CSV</button>
        </div>
        <table class="table" id="listPlanDoc">
          <thead>
            <tr>
              <th>DOCENTE</th><th>TITULO ACADÉMICO</th><th>DEDICACIÓN</th><th>MATERIA</th><th>CÓDIGO ANTHOLOGY</th><th>CARRERAS QUE COMPARTEN</th><th>PRE-REQUISITO</th><th>CODIGO</th><th>HORAS TEÓRICAS</th><th>HORAS PRÁCTICAS</th><th>HORAS AUTÓNOMAS</th><th>CREDITOS</th><th>CAMPO DE FORMACIÓN</th><th>CICLO MALLA</th><th>Nº ORDEN EN LA MALLA</th><th>PARALELO</th><th>DIA</th><th>HORA</th><th>MODALIDAD</th><th>Nro. HORAS</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card section" style="margin-bottom:10px">
        <h2>Planificación estudiante</h2>
        <div class="export">
          <button id="expEst" class="btn-sec">Exportar CSV</button>
        </div>
        <table class="table" id="listPlanEst">
          <thead>
            <tr>
              <th>CARRERA</th><th>ESTUDIANTE</th><th>CICLO DEL ESTUDIANTE</th><th>MALLA</th><th>CICLO DE LA MATERIA EN LA MALLA</th><th>COMPARTIDA CON CARRERA</th><th>MATERIA</th><th>PARALELO</th><th>DIA</th><th>HORA</th><th>MODALIDAD</th><th>NIVEL INGLES</th><th>OBSERVACIONES</th><th>DOCENTE</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card section">
        <h2>Materias (secciones)</h2>
        <div class="export">
          <button id="expMat" class="btn-sec">Exportar CSV</button>
        </div>
        <table class="table" id="listMaterias">
          <thead>
            <tr>
              <th>MALLA</th><th>CICLO DE LA MATERIA EN LA MALLA</th><th>COMPARTIDA CON CARRERA</th><th>MATERIA</th><th>PARALELO</th><th>DIA</th><th>HORA</th><th>Número de estudiantes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- DERECHA: REGLAS y BLOQUEOS -->
  <aside class="card section">
    <h2>Reglas y estado</h2>
    <fieldset>
      <legend>Calendario</legend>
      <div class="legend">
        <span class="pill">Lunes–Viernes</span>
        <span class="pill">7–10</span><span class="pill">10–13</span><span class="pill">13–16</span><span class="pill">16–19</span><span class="pill">19–22</span>
      </div>
    </fieldset>
    <div style="height:8px"></div>
    <fieldset>
      <legend>Restricciones</legend>
      <div class="note">Prioridad: malla del estudiante → nivel de inglés → bloqueos de prácticas.</div>
      <div class="hr"></div>
      <label class="note"><input type="checkbox" id="chkIngles" disabled/> Aplicar bloqueos de Inglés si no hay datos en Excel</label><br/>
      <label class="note"><input type="checkbox" id="chkPracticas" disabled/> Aplicar bloqueos de “Prácticas comunitarias” si no hay datos en Excel</label>
      <div class="note">Use “Configurar bloqueos” para definir franjas por semestre.</div>
    </fieldset>
    <div style="height:8px"></div>
    <button id="btnConfig" class="btn-sec" disabled>Configurar bloqueos</button>
    <div style="height:8px"></div>
    <fieldset>
      <legend>Mensajes</legend>
      <div id="log" class="small" style="max-height:280px;overflow:auto;white-space:pre-wrap"></div>
    </fieldset>
  </aside>
</div>

<!-- MODAL BLOQUEOS -->
<div id="modalCfg" class="modal">
  <div class="dialog">
    <h2>Configuración de bloqueos</h2>
    <div class="note">Defina bloqueos por semestre para evitar cruces con “Prácticas comunitarias” y un bloqueo general de Inglés cuando no haya datos en Excel.</div>
    <div class="hr"></div>
    <div class="row2">
      <div>
        <h3>Bloqueos por semestre</h3>
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:8px">
          <input id="inCicloBloq" class="input" type="number" min="1" placeholder="Ciclo (ej. 2)" />
          <select id="inDiaBloq" class="select"><option value="">Día</option></select>
          <select id="inSlotBloq" class="select"><option value="">Franja</option></select>
          <button id="btnAddBloq" class="btn-sec">Agregar</button>
        </div>
        <div id="listBloq" class="small"></div>
      </div>
      <div>
        <h3>Bloqueo general de Inglés</h3>
        <label class="note"><input type="checkbox" id="inInglesAct"/> Activar bloqueo general</label>
        <div style="display:flex;gap:6px;align-items:center;margin:6px 0">
          <select id="inDiaIng" class="select"><option value="">Día</option></select>
          <select id="inSlotIng" class="select"><option value="">Franja</option></select>
          <button id="btnAddIng" class="btn-sec">Agregar</button>
        </div>
        <div id="listIng" class="small"></div>
      </div>
    </div>
    <div class="hr"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="btnCloseCfg" class="btn-sec">Cerrar</button>
      <button id="btnSaveCfg" class="btn-ok">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL EDICIÓN -->
<div id="modalEdit" class="modal">
  <div class="dialog">
    <h2>Edición por estudiante</h2>
    <div id="editInfo" class="note"></div>
    <div class="hr"></div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <select id="editMateria" class="select"></select>
      <select id="editDestino" class="select"></select>
      <button id="btnAplicarEdicion" class="btn-ok">Aplicar</button>
      <button id="btnCerrarEdicion" class="btn-sec">Cerrar</button>
    </div>
    <div class="hr"></div>
    <div id="editMsg" class="small"></div>
  </div>
</div>

<script>
/* ====== Constantes y estado ====== */
const DAYS=["Lunes","Martes","Miércoles","Jueves","Viernes"];
const SLOTS=["7-10","10-13","13-16","16-19","19-22"];
const SLOT_HOURS={"7-10":3,"10-13":3,"13-16":3,"16-19":3,"19-22":3};

const state={
  raw:{malla:null,docentes:null,estudiantes:null},
  data:{malla:[],docentes:[],estudiantes:[]},
  config:{bloqueosPorSemestre:[],ingles:{activo:false,items:[]}},
  sections:[], // {carrera,ciclo,materia,paralelo,dia,slot,docente,modalidad}
  assign:{byStudent:new Map()},
  index:{docentes:[],ordenMallaPorCarrera:{}},
  ui:{currentStudent:null,currentDocente:null}
};

/* ====== Utilidades ====== */
const $=s=>document.querySelector(s);
const $c=(t,c)=>{const e=document.createElement(t); if(c) e.className=c; return e;};
function log(msg,type="info"){const el=$("#log"); if(!el) return; const t=new Date().toLocaleTimeString(); const cls=type==="error"?"bad":type==="warn"?"warnText":"good"; el.innerHTML=`[${t}] <span class="${cls}">${msg}</span>\n`+el.innerHTML;}
const toKey=s=>String(s??"").trim();
const norm=s=>toKey(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().replace(/[^A-Z0-9]+/g,' ').replace(/\s+/g,' ').trim();

/* ====== Sinónimos de encabezados ====== */
const SYN={
  malla:{
    "CARRERA":["CARRERA","PROGRAMA","MALLA"],
    "CICLO":["CICLO","SEMESTRE","NIVEL"],
    "MATERIA":["MATERIA","ASIGNATURA","CURSO"],
    "PARALELOS":["PARALELOS","PARALELO","SECCIONES","GRUPOS"],
    "COMPARTIDA CON":["COMPARTIDA CON","COMPARTIDA","COMPARTIDA ENTRE CARRERAS","COMPARTIDACON"],
    "CODIGO":["CODIGO","CÓDIGO","CODIGO MATERIA","CODIGO INTERNO"],
    "CODIGO ANTHOLOGY":["CODIGO ANTHOLOGY","CÓDIGO ANTHOLOGY","ANTHOLOGY"],
    "PRE-REQUISITO":["PRE-REQUISITO","PREREQUISITO","PRE REQUISITO","REQ PREVIO"],
    "HORAS TEORICAS":["HORAS TEORICAS","H TEORICAS","HT","HORAS TEORICAS SEMANA"],
    "HORAS PRACTICAS":["HORAS PRACTICAS","H PRACTICAS","HP","HORAS PRACTICAS SEMANA"],
    "HORAS AUTONOMAS":["HORAS AUTONOMAS","H AUTONOMAS","HA"],
    "CREDITOS":["CREDITOS","CR","CRÉDITOS"],
    "CAMPO DE FORMACION":["CAMPO DE FORMACION","CAMPO FORMACION","CAMPO"],
    "MODALIDAD":["MODALIDAD","MOD"],
    "N ORDEN":["N ORDEN","N° ORDEN","NUMERO ORDEN","ORDEN"]
  },
  docentes:{
    "DOCENTE":["DOCENTE","PROFESOR","NOMBRE DOCENTE","NOMBRE"],
    "CARRERA":["CARRERA","PROGRAMA"],
    "MATERIA":["MATERIA","ASIGNATURA","CURSO"],
    "PARALELO":["PARALELO","SECCION","SECCIÓN","GRUPO"],
    "TITULO ACADEMICO":["TITULO ACADEMICO","TITULO","GRADO","FORMACION ACADEMICA"],
    "DEDICACION":["DEDICACION","DEDICACIÓN","JORNADA","TIEMPO"],
    "MODALIDAD":["MODALIDAD","MOD"],
    "DISPONIBILIDAD":["DISPONIBILIDAD","AVAILABILITY"]
  },
  estudiantes:{
    "ESTUDIANTE":["ESTUDIANTE","ALUMNO","NOMBRE ESTUDIANTE","NOMBRES Y APELLIDOS"],
    "CARRERA":["CARRERA","PROGRAMA"],
    "CICLO":["CICLO","SEMESTRE","NIVEL"],
    "NIVEL INGLES":["NIVEL INGLES","NIVEL DE INGLES","INGLES","ENGLISH LEVEL"],
    "PRACTICAS":["PRACTICAS","PRACTICAS COMUNITARIAS","PRÁCTICAS COMUNITARIAS","PRACTICA COMUNITARIA"]
  }
};

/* ====== Lectura Excel robusta (todas las hojas) ====== */
function readExcel(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=e=>{ try{ resolve(XLSX.read(new Uint8Array(e.target.result),{type:"array"})); }catch(err){reject(err);} };
    fr.onerror=reject;
    fr.readAsArrayBuffer(file);
  });
}

function parseWorkbookAll(wb, kind){
  const out=[]; const syn=SYN[kind]; const reports=[];
  for(const name of wb.SheetNames){
    const ws=wb.Sheets[name]; if(!ws) continue;
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
    if(!rows.length) continue;
    const reqCount=kind==="malla"?3:2;
    let hdrIdx=-1; let map={};
    for(let i=0;i<Math.min(rows.length,40);i++){
      const r=rows[i].map(norm); let hits=0; const local={};
      r.forEach((cell,ci)=>{
        for(const canon in syn){ if(syn[canon].some(l=>l===cell)){ if(!Object.values(local).includes(canon)){ local[ci]=canon; hits++; } } }
      });
      if(hits>=reqCount){ hdrIdx=i; map=local; break; }
    }
    if(hdrIdx===-1){ hdrIdx=0; const heads=rows[0].map(norm); heads.forEach((h,ci)=>{ for(const canon in syn){ if(syn[canon].some(l=>l===h)) map[ci]=canon; } }); }
    if(Object.keys(map).length===0){ log(`Hoja “${name}”: no se identificaron encabezados para ${kind}.`,"warn"); continue; }

    // Añadir encabezados de disponibilidad tipo "LUNES 7-10"
    const headerLine=rows[hdrIdx].map(norm);
    headerLine.forEach((h,ci)=>{
      const m=h.match(/(LUNES|MARTES|MIERCOLES|MIERCOLES|MIERCOLES|Miercoles|JUEVES|VIERNES).*(7-10|10-13|13-16|16-19|19-22)/i);
      if(m){ const day=norm(m[1]).replace("MIERCOLES","MIERCOLES"); const slot=(m[2]||"").replace(/\s/g,""); map[ci]=`AVAIL:${day}:${slot}`; }
    });

    const mapped=[];
    for(let r=hdrIdx+1;r<rows.length;r++){
      const row=rows[r]; if(!row || row.every(v=>String(v).trim()==="")) continue;
      const obj={};
      Object.entries(map).forEach(([ci,canon])=>{ obj[canon]=row[Number(ci)]; });
      mapped.push(obj);
      out.push(obj);
    }
    if(mapped.length){
      const names=Object.values(map).slice(0,12).join(", ");
      reports.push(`• ${name}: ${names}${Object.values(map).length>12?" …":""}`);
    }
  }
  if(reports.length) log(`Columnas detectadas en ${kind}:\n${reports.join("\n")}`);
  return out;
}

function ensureCanonical(rows, req){ if(!rows || !rows.length) return false; return req.every(k=>k in rows[0]); }

/* ====== Disponibilidad docente ====== */
function valueTruthy(v){
  const s=String(v??"").toUpperCase().trim();
  return ["SI","SÍ","X","1","TRUE","DISPONIBLE","OK"].includes(s) || s==="Y" || s==="YES";
}
function parseDisponibilidadFromRow(row){
  const avail=new Set();
  // 1) columnas AVAIL:DAY:SLOT
  Object.keys(row).forEach(k=>{
    if(k.startsWith("AVAIL:") && valueTruthy(row[k])){
      const [,day,slot]=k.split(":"); const dia=(day==="MIERCOLES"?"Miércoles":day.charAt(0)+day.slice(1).toLowerCase());
      avail.add(`${dia}__${slot}`);
    }
  });
  // 2) campo DISPONIBILIDAD como texto
  const disp=row["DISPONIBILIDAD"];
  if(disp){
    String(disp).split(/[;,/]+/).forEach(tok=>{
      const t=norm(tok);
      const day=(/LUNES|MARTES|MIERCOLES|JUEVES|VIERNES/.exec(t)||[])[0];
      const slot=(/7-10|10-13|13-16|16-19|19-22/.exec(t)||[])[0];
      if(day && slot){
        const dia = (day==="MIERCOLES")?"Miércoles":day.charAt(0)+day.slice(1).toLowerCase();
        avail.add(`${dia}__${slot}`);
      }
    });
  }
  return avail; // pares "Día__Slot"
}

/* ====== Bloqueos UI ====== */
function fillDaySlotSelects(){
  ["inDiaBloq","inDiaIng"].forEach(id=>{ const el=$("#"+id); el.innerHTML='<option value="">Día</option>'+DAYS.map(d=>`<option>${d}</option>`).join(""); });
  ["inSlotBloq","inSlotIng"].forEach(id=>{ const el=$("#"+id); el.innerHTML='<option value="">Franja</option>'+SLOTS.map(s=>`<option>${s}</option>`).join(""); });
}
function openCfg(){ $("#modalCfg").style.display="flex"; renderBloqLists(); }
function closeCfg(){ $("#modalCfg").style.display="none"; }
function renderBloqLists(){
  const L=$("#listBloq"), I=$("#listIng");
  L.innerHTML = state.config.bloqueosPorSemestre.length? state.config.bloqueosPorSemestre.map((b,i)=>`• Semestre ${b.ciclo}: ${b.dia} ${b.slot} <button data-rm-b="${i}" class="btn-sec" style="padding:2px 6px;font-size:11px">Quitar</button>`).join("<br>") : '<span class="note">Sin bloqueos por semestre.</span>';
  I.innerHTML = state.config.ingles.items.length? state.config.ingles.items.map((b,i)=>`• ${b.dia} ${b.slot} <button data-rm-i="${i}" class="btn-sec" style="padding:2px 6px;font-size:11px">Quitar</button>`).join("<br>") : '<span class="note">Sin bloqueos definidos.</span>';
}
function saveCfg(){ state.config.ingles.activo=$("#inInglesAct").checked; closeCfg(); log("Bloqueos guardados.","good"); }
function addBloq(){
  const ciclo=Number($("#inCicloBloq").value||0), dia=$("#inDiaBloq").value, slot=$("#inSlotBloq").value;
  if(!ciclo||!dia||!slot){ log("Complete ciclo, día y franja para agregar bloqueo.","warn"); return; }
  state.config.bloqueosPorSemestre.push({ciclo,dia,slot});
  $("#inCicloBloq").value=""; $("#inDiaBloq").value=""; $("#inSlotBloq").value=""; renderBloqLists();
}
function addIng(){
  const dia=$("#inDiaIng").value, slot=$("#inSlotIng").value;
  if(!dia||!slot){ log("Complete día y franja para agregar bloqueo de Inglés.","warn"); return; }
  state.config.ingles.items.push({dia,slot});
  $("#inDiaIng").value=""; $("#inSlotIng").value=""; renderBloqLists();
}
document.addEventListener("click",(e)=>{
  if(e.target?.dataset?.rmB!==undefined){ state.config.bloqueosPorSemestre.splice(Number(e.target.dataset.rmB),1); renderBloqLists(); }
  if(e.target?.dataset?.rmI!==undefined){ state.config.ingles.items.splice(Number(e.target.dataset.rmI),1); renderBloqLists(); }
});

/* ====== Lectura de archivos ====== */
async function handleAnalizar(){
  $("#status").textContent="Leyendo archivos…";
  state.sections=[]; state.assign.byStudent.clear(); state.index={docentes:[],ordenMallaPorCarrera:{}};
  const fM=$("#fileMalla").files[0], fD=$("#fileDocentes").files[0], fE=$("#fileEstudiantes").files[0];
  if(!fM||!fD||!fE){ log("Cargue Mallas.xlsx, Docentes.xlsx y Estudiantes.xlsx.","error"); $("#status").textContent="Faltan archivos."; return; }
  try{
    const [wbM,wbD,wbE]=await Promise.all([readExcel(fM),readExcel(fD),readExcel(fE)]);
    const rowsM=parseWorkbookAll(wbM,"malla");
    const rowsD=parseWorkbookAll(wbD,"docentes");
    const rowsE=parseWorkbookAll(wbE,"estudiantes");
    if(!ensureCanonical(rowsM,["CARRERA","CICLO","MATERIA"])){ log("Malla: faltan columnas mínimas.","error"); return; }
    if(!ensureCanonical(rowsD,["DOCENTE","CARRERA","MATERIA"])){ log("Docentes: faltan columnas mínimas.","error"); return; }
    if(!ensureCanonical(rowsE,["ESTUDIANTE","CARRERA","CICLO"])){ log("Estudiantes: faltan columnas mínimas.","error"); return; }

    state.data.malla = rowsM.map((r,i)=>({
      id:`m_${i+1}`,
      carrera:toKey(r["CARRERA"]), ciclo:Number(r["CICLO"])||0, materia:toKey(r["MATERIA"]),
      paralelos:Number(r["PARALELOS"]||1),
      compartidaCon:toKey(r["COMPARTIDA CON"]||""),
      codigo:toKey(r["CODIGO"]||""), codigoAnth:toKey(r["CODIGO ANTHOLOGY"]||""),
      prereq:toKey(r["PRE-REQUISITO"]||""), ht:Number(r["HORAS TEORICAS"]||0),
      hp:Number(r["HORAS PRACTICAS"]||0), ha:Number(r["HORAS AUTONOMAS"]||0),
      creditos:Number(r["CREDITOS"]||0), campo:toKey(r["CAMPO DE FORMACION"]||""),
      modalidad:toKey(r["MODALIDAD"]||""), norden:Number(r["N ORDEN"]||0)
    }));

    state.data.docentes = rowsD.map((r,i)=>({
      id:`d_${i+1}`, docente:toKey(r["DOCENTE"]), carrera:toKey(r["CARRERA"]),
      materia:toKey(r["MATERIA"]), paralelo:toKey(r["PARALELO"]||""),
      titulo:toKey(r["TITULO ACADEMICO"]||""), dedicacion:toKey(r["DEDICACION"]||""),
      modalidad:toKey(r["MODALIDAD"]||""), _avail:parseDisponibilidadFromRow(r)
    }));

    state.data.estudiantes = rowsE.map((r,i)=>({
      id:`e_${i+1}`, estudiante:toKey(r["ESTUDIANTE"]), carrera:toKey(r["CARRERA"]),
      ciclo:Number(r["CICLO"])||0, nivelIngles:toKey(r["NIVEL INGLES"]||""), practicas:toKey(r["PRACTICAS"]||"")
    }));

    // Índice de orden en la malla por carrera (si no hay N ORDEN, generarlo)
    const byCarrera={};
    for(const c of new Set(state.data.malla.map(m=>m.carrera))){
      const list=state.data.malla.filter(m=>m.carrera===c).slice().sort((a,b)=> (a.norden||0)-(b.norden||0) || a.ciclo-b.ciclo || a.materia.localeCompare(b.materia));
      let k=1;
      for(const m of list){ if(!m.norden){ m.norden=k; } k++; }
      byCarrera[c]=Object.fromEntries(list.map(x=>[x.materia,x.norden]));
    }
    state.index.ordenMallaPorCarrera=byCarrera;

    // Habilitar controles
    $("#btnConfig").disabled=false; $("#btnAsignar").disabled=false;
    $("#chkIngles").disabled=false; $("#chkPracticas").disabled=false;
    $("#status").textContent="Excel leídos (100 %). Configure bloqueos o genere la planificación.";
    log("Lectura completa de los Excel (todas las hojas).","good");
    fillDaySlotSelects();
  }catch(err){ console.error(err); log("Error al leer Excel: "+err.message,"error"); }
}

/* ====== Algoritmo de planificación ====== */
function docenteDailyCount(map,docente,dia){ return map.get(`${docente}__${dia}`)||0; }
function incDocenteDaily(map,docente,dia){ const k=`${docente}__${dia}`; map.set(k,(map.get(k)||0)+1); }
function slotBusyForAdjacency(carrera,ciclo,dia,slot){
  return state.sections.some(s=>s.carrera===carrera && Math.abs(s.ciclo-ciclo)===1 && s.dia===dia && s.slot===slot);
}
function findDocentesFor(carrera,materia){
  return state.data.docentes.filter(d=>d.carrera===carrera && d.materia===materia);
}
function findMalla(carrera,ciclo,materia){
  return state.data.malla.find(m=>m.carrera===carrera && m.ciclo===ciclo && m.materia===materia) ||
         state.data.malla.find(m=>m.carrera===carrera && m.materia===materia) || null;
}

function generarPlanificacion(){
  state.sections=[]; state.assign.byStudent.clear();
  const items=[...state.data.malla].sort((a,b)=> (a.carrera.localeCompare(b.carrera)) || (a.ciclo-b.ciclo) || a.materia.localeCompare(b.materia));
  const docenteDayMap=new Map();

  for(const item of items){
    const docentes=findDocentesFor(item.carrera,item.materia);
    const nPar=Math.max(1, Number(item.paralelos||1));
    for(let p=1;p<=nPar;p++){
      const d = docentes.length? docentes[(p-1)%docentes.length] : null;
      const docente = d? d.docente : "Por asignar";
      const disponibilidad = d? d._avail : new Set(); // Set de "Día__Slot" o vacío = sin restricciones explícitas

      let placed=false;
      for(const dia of DAYS){
        if(docente!=="Por asignar" && docenteDailyCount(docenteDayMap,docente,dia)>=2) continue;
        for(const slot of SLOTS){
          // Respetar disponibilidad si existe
          if(disponibilidad.size && !disponibilidad.has(`${dia}__${slot}`)) continue;
          if(slotBusyForAdjacency(item.carrera,item.ciclo,dia,slot)) continue;
          const docBusy=state.sections.find(s=>s.docente===docente && s.dia===dia && s.slot===slot);
          if(docente!=="Por asignar" && docBusy) continue;

          const prefMalla=findMalla(item.carrera,item.ciclo,item.materia);
          state.sections.push({
            carrera:item.carrera,ciclo:item.ciclo,materia:item.materia,paralelo:p,dia,slot,docente,
            modalidad: (prefMalla?.modalidad || d?.modalidad || "")
          });
          if(docente!=="Por asignar") incDocenteDaily(docenteDayMap,docente,dia);
          placed=true; break;
        }
        if(placed) break;
      }
      if(!placed){
        // Último recurso: ignorando disponibilidad pero manteniendo límites
        outer: for(const dia of DAYS){
          if(docente!=="Por asignar" && docenteDailyCount(docenteDayMap,docente,dia)>=2) continue;
          for(const slot of SLOTS){
            if(slotBusyForAdjacency(item.carrera,item.ciclo,dia,slot)) continue;
            const docBusy=state.sections.find(s=>s.docente===docente && s.dia===dia && s.slot===slot);
            if(docente!=="Por asignar" && docBusy) continue;
            const prefMalla=findMalla(item.carrera,item.ciclo,item.materia);
            state.sections.push({carrera:item.carrera,ciclo:item.ciclo,materia:item.materia,paralelo:p,dia,slot,docente,modalidad:(prefMalla?.modalidad||d?.modalidad||"")});
            if(docente!=="Por asignar") incDocenteDaily(docenteDayMap,docente,dia);
            break outer;
          }
        }
      }
    }
  }

  // Asignación a estudiantes (máx. 6; 2 por día; bloqueos)
  for(const est of state.data.estudiantes){
    const wanted=state.data.malla.filter(m=>m.carrera===est.carrera && m.ciclo===est.ciclo);
    const plan=[]; const dayCount=new Map();

    const blocksSem=state.config.bloqueosPorSemestre.filter(b=>Number(b.ciclo)===Number(est.ciclo));
    const hasIngles=!!toKey(est.nivelIngles);
    const applyInglesGlobal=state.config.ingles.activo && !hasIngles && $("#chkIngles").checked;
    const inglesBlocks=applyInglesGlobal? state.config.ingles.items : [];

    const blocked=(dia,slot)=>{
      if($("#chkPracticas").checked){ if(blocksSem.some(b=>b.dia===dia && b.slot===slot)) return true; }
      if(applyInglesGlobal){ if(inglesBlocks.some(b=>b.dia===dia && b.slot===slot)) return true; }
      return false;
    };

    for(const wm of wanted){
      if(plan.length>=6) break;
      const secs=state.sections.filter(s=>s.carrera===wm.carrera && s.ciclo===wm.ciclo && s.materia===wm.materia);
      for(const sec of secs){
        if(blocked(sec.dia,sec.slot)) continue;
        const cnt=dayCount.get(sec.dia)||0; if(cnt>=2) continue;
        if(plan.some(p=>p.dia===sec.dia && p.slot===sec.slot)) continue;
        plan.push({...sec});
        dayCount.set(sec.dia,cnt+1);
        break;
      }
    }
    state.assign.byStudent.set(est.id,plan);
  }

  fillUIAfterPlan();
  buildOutputLists(); // ← listas solicitadas
  log("Planificación generada.","good");
  $("#status").textContent="Planificación generada. Revise vistas y listas.";
}

/* ====== UI posterior ====== */
function fillUIAfterPlan(){
  const selEst=$("#selEstudiante");
  selEst.innerHTML='<option value="">— Seleccione estudiante —</option>'+state.data.estudiantes.map(e=>`<option value="${e.id}">${e.estudiante} — ${e.carrera} (C${e.ciclo})</option>`).join("");
  selEst.disabled=false;
  const selDoc=$("#selDocente");
  selDoc.innerHTML='<option value="">— Seleccione docente —</option>'+Array.from(new Set(state.sections.map(s=>s.docente))).filter(x=>x && x!=="Por asignar").sort().map(d=>`<option>${d}</option>`).join("");
  selDoc.disabled=false;
  renderGrid("#gridEstudiante",null,"estudiante");
  renderGrid("#gridDocente",null,"docente");
  $("#tablaEst").style.display="none"; $("#tablaDoc").style.display="none"; $("#btnEditar").disabled=true;
}

/* ====== Grillas ====== */
function baseGrid(){
  const frag=document.createDocumentFragment();
  const head0=$c("div","cell header"); head0.textContent="Franja / Día"; frag.appendChild(head0);
  for(const d of DAYS){ const h=$c("div","cell header"); h.textContent=d; frag.appendChild(h); }
  for(const sl of SLOTS){
    const l=$c("div","cell slot"); l.textContent=sl; frag.appendChild(l);
    for(const d of DAYS){ const cell=$c("div","cell"); cell.dataset.day=d; cell.dataset.slot=sl; frag.appendChild(cell); }
  }
  return frag;
}
function renderGrid(selector,entries,mode,contextInfo){
  const root=$(selector); root.innerHTML=""; root.appendChild(baseGrid());
  if(!entries) return;
  const cells=root.querySelectorAll(".cell");
  for(const it of entries){
    const cell=[...cells].find(c=>c.dataset?.day===it.dia && c.dataset?.slot===it.slot);
    if(!cell) continue;
    const tag=$c("div","tag"); tag.innerHTML=`<b>${it.materia}</b> <small>Par. ${it.paralelo}</small><small>• C${it.ciclo} • ${it.carrera}</small>${mode==="docente"?"":`<small>• ${it.docente||"Doc."}</small>`}`; cell.appendChild(tag);
  }
  if(mode==="estudiante" && contextInfo){
    for(const b of (contextInfo.blocks||[])){ const cell=[...cells].find(c=>c.dataset?.day===b.dia && c.dataset?.slot===b.slot); if(cell){ const t=$c("div","tag tag-block"); t.innerHTML=`<b>Bloqueado</b> <small>${b.motivo||""}</small>`; cell.appendChild(t);} }
  }
}

/* ====== Selecciones y tablas simples ====== */
function currentStudentBlocks(est){
  const blocks=[]; const sem=state.config.bloqueosPorSemestre.filter(b=>Number(b.ciclo)===Number(est.ciclo));
  for(const b of sem) blocks.push({dia:b.dia,slot:b.slot,motivo:"Prácticas / Semestre"});
  const hasIng=!!toKey(est.nivelIngles); const apply=state.config.ingles.activo && !hasIng && $("#chkIngles").checked;
  if(apply) for(const b of state.config.ingles.items) blocks.push({dia:b.dia,slot:b.slot,motivo:"Inglés (global)"});
  return blocks;
}
function onPickStudent(){
  const id=$("#selEstudiante").value; $("#btnEditar").disabled=!id;
  if(!id){ renderGrid("#gridEstudiante",null,"estudiante"); $("#tablaEst").style.display="none"; $("#kpiEst").style.display="none"; return; }
  state.ui.currentStudent=id;
  const est=state.data.estudiantes.find(e=>e.id===id);
  const plan=state.assign.byStudent.get(id)||[];
  renderGrid("#gridEstudiante",plan,"estudiante",{blocks:currentStudentBlocks(est)});
  $("#kpiEst").style.display=""; $("#kTotal").textContent=String(plan.length); $("#kBlocks").textContent=String(currentStudentBlocks(est).length); $("#kChoques").textContent="0";
  const tb=$("#tablaEst tbody"); tb.innerHTML=""; for(const p of plan){ const tr=$c("tr"); tr.innerHTML=`<td>${p.materia}</td><td>${p.paralelo}</td><td>${p.dia}</td><td>${p.slot}</td><td>${p.docente||""}</td><td>${p.carrera}</td><td>${p.ciclo}</td>`; tb.appendChild(tr); } $("#tablaEst").style.display="";
}
function onPickDocente(){
  const name=$("#selDocente").value; if(!name){ renderGrid("#gridDocente",null,"docente"); $("#tablaDoc").style.display="none"; return; }
  state.ui.currentDocente=name; const entries=state.sections.filter(s=>s.docente===name); renderGrid("#gridDocente",entries,"docente");
  const tb=$("#tablaDoc tbody"); tb.innerHTML=""; for(const e of entries){ const tr=$c("tr"); tr.innerHTML=`<td>${e.dia}</td><td>${e.slot}</td><td>${e.materia}</td><td>${e.paralelo}</td><td>${e.carrera}</td><td>${e.ciclo}</td>`; tb.appendChild(tr); } $("#tablaDoc").style.display="";
}

/* ====== Edición por estudiante ====== */
function openEdit(){
  const id=state.ui.currentStudent; if(!id) return;
  const est=state.data.estudiantes.find(e=>e.id===id); const plan=state.assign.byStudent.get(id)||[];
  $("#editMateria").innerHTML=plan.map(p=>`<option value="${p.materia}__${p.paralelo}">${p.materia} — Par. ${p.paralelo} (${p.dia} ${p.slot})</option>`).join("");
  $("#editDestino").innerHTML='<option value="">— Seleccione destino —</option>';
  $("#editMsg").innerHTML=""; $("#editInfo").textContent=`${est.estudiante} — ${est.carrera} (C${est.ciclo})`; $("#modalEdit").style.display="flex";
}
function closeEdit(){ $("#modalEdit").style.display="none"; }
$("#editMateria").addEventListener("change",()=>{
  const id=state.ui.currentStudent; if(!id) return; const est=state.data.estudiantes.find(e=>e.id===id);
  const [materia]=($("#editMateria").value||"").split("__");
  const dests=state.sections.filter(s=>s.materia===materia && s.carrera===est.carrera && s.ciclo===est.ciclo);
  $("#editDestino").innerHTML=dests.map(d=>`<option value="${d.dia}__${d.slot}__${d.paralelo}">${d.dia} • ${d.slot} • Par. ${d.paralelo} • Doc. ${d.docente||""}</option>`).join("");
});
function aplicarEdicion(){
  const id=state.ui.currentStudent; if(!id) return;
  const est=state.data.estudiantes.find(e=>e.id===id); const plan=state.assign.byStudent.get(id)||[];
  if(!plan.length){ $("#editMsg").innerHTML='<span class="bad">No hay asignaciones.</span>'; return; }
  const sel=$("#editMateria").value, dst=$("#editDestino").value; if(!sel||!dst){ $("#editMsg").innerHTML='<span class="warnText">Seleccione materia y destino.</span>'; return; }
  const [materia,parOrig]=sel.split("__"); const [diaN,slotN,parN]=dst.split("__");
  const idx=plan.findIndex(p=>p.materia===materia && String(p.paralelo)===String(parOrig)); if(idx<0){ $("#editMsg").innerHTML='<span class="bad">No se encontró la asignación original.</span>'; return; }
  const nuevo=state.sections.find(s=>s.materia===materia && s.carrera===est.carrera && s.ciclo===est.ciclo && s.dia===diaN && s.slot===slotN && String(s.paralelo)===String(parN));
  if(!nuevo){ $("#editMsg").innerHTML='<span class="bad">Destino no válido.</span>'; return; }
  const provisional=[...plan]; provisional[idx]={...nuevo};
  const dayCount=new Map(); for(const p of provisional){ dayCount.set(p.dia,(dayCount.get(p.dia)||0)+1); if(dayCount.get(p.dia)>2){ $("#editMsg").innerHTML='<span class="bad">No se permite más de 2 materias el mismo día.</span>'; return; } }
  for(let i=0;i<provisional.length;i++) for(let j=i+1;j<provisional.length;j++){ const a=provisional[i],b=provisional[j]; if(a.dia===b.dia && a.slot===b.slot){ $("#editMsg").innerHTML='<span class="bad">Choque de horario detectado.</span>'; return; } }
  const blocks=currentStudentBlocks(est); if(blocks.some(b=>b.dia===nuevo.dia && b.slot===nuevo.slot)){ $("#editMsg").innerHTML='<span class="bad">Franja bloqueada (Inglés/Prácticas).</span>'; return; }
  state.assign.byStudent.set(id,provisional); $("#editMsg").innerHTML='<span class="good">Cambio aplicado.</span>'; onPickStudent();
}

/* ====== Listas solicitadas (docente / estudiante / materias) ====== */
function normCompartida(str){ return toKey(str).replace(/[;,|]+/g,'/').replace(/\s*\/\s*/g,'/'); }
function buildOutputLists(){
  // 1) Planificación docente
  const tbDoc=$("#listPlanDoc tbody"); tbDoc.innerHTML="";
  const docentesMeta=Object.fromEntries(state.data.docentes.map(d=>[`${d.docente}__${d.carrera}__${d.materia}`,d]));
  for(const s of state.sections){
    const meta=findMalla(s.carrera,s.ciclo,s.materia) || {};
    const ordCarr1 = (state.index.ordenMallaPorCarrera[s.carrera]||{})[s.materia]||"";
    // Si la materia existe en otras carreras, juntar orden por carrera (separado con /)
    const carrerasMateria = Array.from(new Set(state.data.malla.filter(m=>m.materia===s.materia).map(m=>m.carrera)));
    const ordenJoin = carrerasMateria.map(c=> (state.index.ordenMallaPorCarrera[c]||{})[s.materia]).filter(x=>x!=null).join('/');
    const dKey=`${s.docente}__${s.carrera}__${s.materia}`; const dMeta=docentesMeta[dKey]||{};
    const tr=$c("tr");
    tr.innerHTML=[
      s.docente||"", dMeta.titulo||"", dMeta.dedicacion||"", s.materia||"", meta.codigoAnth||meta.codigoAnthology||meta.codigoAnth||"",
      normCompartida(meta.compartidaCon||""), meta.prereq||"", meta.codigo||"", meta.ht||"", meta.hp||"", meta.ha||"",
      meta.creditos||"", meta.campo||"", s.ciclo||"", ordenJoin||ordCarr1||"", s.paralelo||"", s.dia||"", s.slot||"",
      (meta.modalidad || s.modalidad || dMeta.modalidad || ""), SLOT_HOURS[s.slot]||""
    ].map(v=>`<td>${v??""}</td>`).join("");
    tbDoc.appendChild(tr);
  }

  // 2) Planificación estudiante
  const tbEst=$("#listPlanEst tbody"); tbEst.innerHTML="";
  for(const est of state.data.estudiantes){
    const plan=state.assign.byStudent.get(est.id)||[];
    for(const p of plan){
      const m=findMalla(p.carrera,p.ciclo,p.materia) || {};
      const tr=$c("tr");
      tr.innerHTML=[
        est.carrera, est.estudiante, est.ciclo, p.carrera, p.ciclo,
        normCompartida(m.compartidaCon||""), p.materia, p.paralelo, p.dia, p.slot,
        (m.modalidad || p.modalidad || ""), est.nivelIngles||"", "", p.docente||""
      ].map(v=>`<td>${v??""}</td>`).join("");
      tbEst.appendChild(tr);
    }
  }

  // 3) Materias (secciones con número de estudiantes)
  const tbMat=$("#listMaterias tbody"); tbMat.innerHTML="";
  const countBySec=new Map(); // key: carrera|ciclo|materia|par|dia|slot
  for(const [sid,plan] of state.assign.byStudent.entries()){
    for(const p of plan){
      const k=[p.carrera,p.ciclo,p.materia,p.paralelo,p.dia,p.slot].join("|");
      countBySec.set(k,(countBySec.get(k)||0)+1);
    }
  }
  for(const s of state.sections){
    const m=findMalla(s.carrera,s.ciclo,s.materia)||{};
    const k=[s.carrera,s.ciclo,s.materia,s.paralelo,s.dia,s.slot].join("|");
    const n=countBySec.get(k)||0;
    const tr=$c("tr");
    tr.innerHTML=[s.carrera,s.ciclo,normCompartida(m.compartidaCon||""),s.materia,s.paralelo,s.dia,s.slot,n].map(v=>`<td>${v??""}</td>`).join("");
    tbMat.appendChild(tr);
  }
}

/* ====== Exportación CSV ====== */
function tableToCSV(tbl){
  const rows=[...tbl.querySelectorAll("tr")];
  return rows.map(tr=>[...tr.children].map(td=>{
    const t=td.textContent.replace(/"/g,'""'); return `"${t}"`;
  }).join(",")).join("\n");
}
function downloadCSV(name,csv){
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const link=document.createElement("a");
  link.href=URL.createObjectURL(blob); link.download=name; document.body.appendChild(link); link.click(); document.body.removeChild(link);
}

/* ====== Pestañas y reinicio ====== */
function switchTab(tab){
  ["estudiantes","docentes","listas"].forEach(id=>{
    $("#view-"+id).style.display = (id===tab)?"":"none";
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelector(`.tab[data-tab="${tab}"]`).classList.add("active");
  });
}
function resetAll(){
  ["fileMalla","fileDocentes","fileEstudiantes"].forEach(id=>{$("#"+id).value="";});
  $("#status").textContent=""; $("#log").textContent="";
  $("#btnConfig").disabled=true; $("#btnAsignar").disabled=true;
  $("#chkIngles").checked=false; $("#chkIngles").disabled=true;
  $("#chkPracticas").checked=false; $("#chkPracticas").disabled=true;
  state.raw={malla:null,docentes:null,estudiantes:null};
  state.data={malla:[],docentes:[],estudiantes:[]};
  state.sections=[]; state.assign.byStudent.clear(); state.index={docentes:[],ordenMallaPorCarrera:{}};
  fillDaySlotSelects();
  renderGrid("#gridEstudiante",null,"estudiante"); renderGrid("#gridDocente",null,"docente");
  $("#selEstudiante").innerHTML='<option value="">— Seleccione estudiante —</option>'; $("#selEstudiante").disabled=true;
  $("#selDocente").innerHTML='<option value="">— Seleccione docente —</option>'; $("#selDocente").disabled=true;
  $("#tablaEst").style.display="none"; $("#tablaDoc").style.display="none"; $("#kpiEst").style.display="none"; $("#btnEditar").disabled=true;
}

/* ====== Listeners ====== */
$("#btnAnalizar").addEventListener("click",handleAnalizar);
document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click",()=>switchTab(t.dataset.tab)));
$("#btnAsignar").addEventListener("click",generarPlanificacion);
$("#btnLimpiar").addEventListener("click",resetAll);
$("#btnConfig").addEventListener("click",openCfg);
$("#btnCloseCfg").addEventListener("click",closeCfg);
$("#btnSaveCfg").addEventListener("click",saveCfg);
$("#btnAddBloq").addEventListener("click",addBloq);
$("#btnAddIng").addEventListener("click",addIng);
$("#selEstudiante").addEventListener("change",onPickStudent);
$("#selDocente").addEventListener("change",onPickDocente);
$("#btnEditar").addEventListener("click",openEdit);
$("#btnCerrarEdicion").addEventListener("click",closeEdit);
$("#btnAplicarEdicion").addEventListener("click",aplicarEdicion);
document.querySelectorAll(".modal").forEach(m=>m.addEventListener("click",(e)=>{ if(e.target===m) m.style.display="none"; }));

$("#expDocente").addEventListener("click",()=>downloadCSV("planificacion_docente.csv",tableToCSV($("#listPlanDoc"))));
$("#expEst").addEventListener("click",()=>downloadCSV("planificacion_estudiante.csv",tableToCSV($("#listPlanEst"))));
$("#expMat").addEventListener("click",()=>downloadCSV("materias.csv",tableToCSV($("#listMaterias"))));

/* Inicial */
fillDaySlotSelects();
renderGrid("#gridEstudiante",null,"estudiante");
renderGrid("#gridDocente",null,"docente");
</script>
</body>
</html>
