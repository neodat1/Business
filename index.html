<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planificador Académico — Matriz Consolidada (v2)</title>
  <style>
    :root{ --bg:#f8fafc; --fg:#0f172a; --muted:#475569; --accent:#0ea5e9; --border:#e2e8f0; --chip:#eef2ff; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial;}
    header{padding:18px 20px;border-bottom:1px solid var(--border);background:white;position:sticky;top:0;z-index:10}
    h1{font-size:1.15rem;margin:0}
    .sub{color:var(--muted);font-size:.9rem}
    main{padding:18px;max-width:1400px;margin:0 auto}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 3px 14px rgba(2,6,23,.04);padding:16px;margin-bottom:18px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:end}
    .col{display:flex;flex-direction:column;gap:8px}
    .col label{font-weight:600;font-size:.92rem}
    input[type="file"]{border:1px dashed var(--border);padding:10px;border-radius:10px;background:#f9fafb}
    button{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    button:disabled{opacity:.55;cursor:default}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:.82rem}
    table{width:100%;border-collapse:collapse;background:white;border-radius:14px;overflow:hidden;border:1px solid var(--border)}
    thead th{position:sticky;top:62px;background:#fafafa;border-bottom:1px solid var(--border);padding:8px 6px;font-size:.86rem}
    tbody td{border-bottom:1px solid var(--border);padding:8px 6px;vertical-align:top}
    tbody tr:nth-child(even){background:#fcfcff}
    .center{text-align:center}
    .mono{font-variant-numeric:tabular-nums}
    .small{font-size:.85rem;color:#334155}
    .note{font-size:.9rem;color:#334155;margin-top:10px}
    .right{margin-left:auto}
    .warning{color:#b45309;background:#fffbeb;border:1px solid #fde68a;padding:8px 10px;border-radius:10px}
    .ok{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:8px 10px;border-radius:10px}
  </style>
</head>
<body>
  <header>
    <h1>Planificador Académico — Matriz consolidada (v2)</h1>
    <div class="sub">Cargue <strong>Mallas.xlsx</strong> y <strong>Docentes.xlsx</strong>. Esta versión admite encabezados con tildes/variantes.</div>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <div class="col">
          <label>Archivo de Mallas (.xlsx)</label>
          <input id="mallasFile" type="file" accept=".xlsx,.xls" />
        </div>
        <div class="col">
          <label>Archivo de Docentes (.xlsx)</label>
          <input id="docentesFile" type="file" accept=".xlsx,.xls" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <div class="col">
          <label>Capacidad por paralelo</label>
          <input id="capParalelo" type="number" min="1" value="30" style="width:110px;padding:8px 10px;border:1px solid #e2e8f0;border-radius:8px" />
          <div class="small">Si total de estudiantes &gt; capacidad, se crean paralelos A,B,C…</div>
        </div>
        <div class="col">
          <label>Ciclo principal (prioridad de no choque)</label>
          <input id="cicloPrincipal" type="number" min="1" value="2" style="width:110px;padding:8px 10px;border:1px solid #e2e8f0;border-radius:8px" />
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <button id="generarBtn" disabled>Generar matriz</button>
          <span id="status" class="small" style="margin-left:8px">Cargue ambos archivos.</span>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="chips">
        <div class="chip">Lunes–Viernes</div>
        <div class="chip">07–10, 10–13, 13–16, 16–19, 19–22</div>
        <div class="chip">Máx. 2 asignaturas/día por ciclo</div>
        <div class="chip">Evitar choques entre ciclos contiguos</div>
        <div class="chip">Paralelos A, B, C… (round-robin por docente)</div>
      </div>
      <div id="warnings" class="note"></div>
    </section>

    <section class="card">
      <div class="row">
        <div class="small"><strong>Resultados</strong> — Orden: CICLO → MATERIA → PARALELO</div>
        <div class="right small"><span id="countRows">0</span> filas</div>
      </div>
      <div style="overflow:auto;margin-top:10px">
        <table id="tabla" class="mono">
          <thead>
            <tr>
              <th>DOCENTE</th>
              <th>TITULO ACADÉMICO</th>
              <th>DEDICACIÓN</th>
              <th>MATERIA</th>
              <th>CÓDIGO ANTHOLOGY</th>
              <th>CARRERAS QUE COMPARTEN</th>
              <th>MALLA</th>
              <th>PRE-REQUISITO</th>
              <th>CODIGO</th>
              <th class="center">HORAS TEÓRICAS</th>
              <th class="center">HORAS PRÁCTICAS</th>
              <th class="center">HORAS AUTÓNOMAS</th>
              <th class="center">CREDITOS</th>
              <th>CAMPO DE FORMACIÓN</th>
              <th class="center">CICLO MALLA</th>
              <th class="center">Nº ORDEN EN LA MALLA</th>
              <th class="center">PARALELO</th>
              <th>DIA</th>
              <th>HORA</th>
              <th>MODALIDAD</th>
              <th class="center">Nro. HORAS</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
  (function(){
    const DAYS = ["Lunes","Martes","Miércoles","Jueves","Viernes"];
    const SLOTS = [
      {label:"07:00–10:00", start:7, end:10},
      {label:"10:00–13:00", start:10, end:13},
      {label:"13:00–16:00", start:13, end:16},
      {label:"16:00–19:00", start:16, end:19},
      {label:"19:00–22:00", start:19, end:22},
    ];
    const PARALLELS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

    const mFile = document.getElementById('mallasFile');
    const dFile = document.getElementById('docentesFile');
    const btn  = document.getElementById('generarBtn');
    const status = document.getElementById('status');
    const warningsEl = document.getElementById('warnings');
    const tbody = document.getElementById('tbody');
    const countRowsEl = document.getElementById('countRows');
    const cicloPrincipalEl = document.getElementById('cicloPrincipal');
    const capParaleloEl = document.getElementById('capParalelo');

    function ready(){ btn.disabled = !(mFile.files.length && dFile.files.length); status.textContent = btn.disabled? 'Cargue ambos archivos.' : 'Listo.'; }
    mFile.addEventListener('change', ready); dFile.addEventListener('change', ready);

    // === Normalización de texto y llaves ===
    const normalize = s => String(s ?? '').normalize('NFD').replace(/[̀-ͯ]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
    const norm = s => String(s ?? '').trim();
    const toNum = v => { if(v==null||v==='') return 0; const n = Number(String(v).replace(',', '.')); return Number.isFinite(n)? n : 0; };

    // Mapeo flexible de encabezados
    const ALIAS = {
      carrera:["carrera","programa"],
      malla:["malla","plan","plan de estudios"],
      ciclo_malla:["ciclo malla","ciclo","semestre","nivel"],
      norden:["n orden en la malla","nro orden en la malla","no orden en la malla","n° orden en la malla","num orden en la malla","numero orden malla"],
      materia:["materia","asignatura","nombre","nombre asignatura"],
      prereq:["pre-requisito","prerequisito","pre requisito"],
      codigo:["codigo","código","code"],
      codigo_anth:["codigo anthology","código anthology","anthology","cod anthology","codigo anth"],
      horas_t:["horas teoricas","horas t","ht"],
      horas_p:["horas practicas","horas p","hp"],
      horas_a:["horas autonomas","horas a","ha"],
      creditos:["creditos","créditos","cr"],
      campo:["campo de formacion","campo formacion","area formacion","area de formacion"],
      modalidad:["modalidad","modalidad de estudio","mode"],
      estudiantes:["estudiantes","n estudiantes","nro estudiantes","nro. estudiantes","matriculados","inscritos"],

      d_docente:["docente","profesor","teacher","nombre docente"],
      d_titulo:["titulo academico","título academico","título académico","grado academico"],
      d_dedic:["dedicacion","dedicación","jornada","contrato"],
      d_materia:["materia","asignatura"],
    };

    function valueByAliases(row, aliases){
      const keys = Object.keys(row);
      for(const k of keys){
        const nk = normalize(k);
        for(const a of aliases){ if(nk === normalize(a)) return row[k]; }
      }
      // búsqueda contiene
      for(const k of keys){
        const nk = normalize(k);
        for(const a of aliases){ if(nk.includes(normalize(a))) return row[k]; }
      }
      return '';
    }

    function getMallaRow(row){
      return {
        CARRERA: norm(valueByAliases(row, ALIAS.carrera)),
        MALLA: norm(valueByAliases(row, ALIAS.malla)),
        CICLO: norm(valueByAliases(row, ALIAS.ciclo_malla)),
        NORDEN: norm(valueByAliases(row, ALIAS.norden)),
        MATERIA: norm(valueByAliases(row, ALIAS.materia)),
        PREREQ: norm(valueByAliases(row, ALIAS.prereq)),
        CODIGO: norm(valueByAliases(row, ALIAS.codigo)),
        ANTH: norm(valueByAliases(row, ALIAS.codigo_anth)),
        HT: toNum(valueByAliases(row, ALIAS.horas_t)),
        HP: toNum(valueByAliases(row, ALIAS.horas_p)),
        HA: toNum(valueByAliases(row, ALIAS.horas_a)),
        CREDITOS: norm(valueByAliases(row, ALIAS.creditos)),
        CAMPO: norm(valueByAliases(row, ALIAS.campo)),
        MODALIDAD: norm(valueByAliases(row, ALIAS.modalidad)),
        EST: toNum(valueByAliases(row, ALIAS.estudiantes)),
      };
    }

    function getDocenteRow(row){
      return {
        DOCENTE: norm(valueByAliases(row, ALIAS.d_docente)),
        TITULO: norm(valueByAliases(row, ALIAS.d_titulo)),
        DED: norm(valueByAliases(row, ALIAS.d_dedic)),
        MATERIA: norm(valueByAliases(row, ALIAS.d_materia)),
      };
    }

    // Lectura xlsx (todas las hojas)
    const readXlsx = file => new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = e => {
        try{
          const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
          let rows=[]; wb.SheetNames.forEach(n=>{ const ws=wb.Sheets[n]; rows=rows.concat(XLSX.utils.sheet_to_json(ws,{defval:''})); });
          resolve(rows);
        }catch(err){ reject(err); }
      };
      fr.onerror = reject;
      fr.readAsArrayBuffer(file);
    });

    function indexDocentes(docRows){
      const map = new Map(); // materia -> [docentes]
      const generics = [];
      for(const r of docRows){
        const d = getDocenteRow(r);
        const entry = {DOCENTE:d.DOCENTE, TITULO:d.TITULO, DED:d.DED};
        if(d.MATERIA){
          const key = d.MATERIA.toLowerCase();
          if(!map.has(key)) map.set(key, []);
          map.get(key).push(entry);
        } else if (d.DOCENTE){
          generics.push(entry);
        }
      }
      return {byMateria:map, generic:generics};
    }

    function groupMallas(mRows){
      const groups = new Map(); // key -> info
      const getKey = (r)=> r.ANTH ? 'ANTH|'+r.ANTH : 'MAT|'+r.MATERIA.toLowerCase();
      for(const raw of mRows){
        const r = getMallaRow(raw);
        if(!r.MATERIA) continue; // ignora filas inválidas
        const key = getKey(r);
        if(!groups.has(key)) groups.set(key, {
          materia:r.MATERIA,
          anth:r.ANTH,
          carreras:[], mallas:[], prereqs:[], codigos:[], ht:[], hp:[], ha:[], creditos:[], campo:[], ciclos:[], norden:[], modalidades:[],
          totalEst:0
        });
        const g = groups.get(key);
        g.carreras.push(r.CARRERA); g.mallas.push(r.MALLA); g.prereqs.push(r.PREREQ); g.codigos.push(r.CODIGO);
        g.ht.push(r.HT); g.hp.push(r.HP); g.ha.push(r.HA); g.creditos.push(r.CREDITOS); g.campo.push(r.CAMPO);
        g.ciclos.push(r.CICLO); g.norden.push(r.NORDEN); g.modalidades.push(r.MODALIDAD);
        g.totalEst += (r.EST>0? r.EST : 0);
      }
      return groups;
    }

    function schedule(items, cicloPrincipal){
      const usedByCycle = new Map(); // ciclo -> Set(day|slot)
      const perDayCountByCycle = new Map();
      const usedByDocente = new Map();
      const slotKey = (d,s)=> d+'|'+s;

      function isAvailable(ciclo, docente, d, s){
        const key = slotKey(d,s);
        if(usedByCycle.get(ciclo)?.has(key)) return false;
        if(usedByCycle.get(ciclo-1)?.has(key)) return false;
        if(usedByCycle.get(ciclo+1)?.has(key)) return false;
        const dm = perDayCountByCycle.get(ciclo) || new Map();
        if((dm.get(d)||0) >= 2) return false; // máx 2 por día
        if(docente && usedByDocente.get(docente)?.has(key)) return false;
        return true;
      }

      function place(ciclo, docente, hours){
        const blocks = Math.ceil(hours/3);
        const places=[];
        outer: for(let b=0;b<blocks;b++){
          for(let d=0; d<DAYS.length; d++){
            for(let s=0; s<SLOTS.length; s++){
              if(isAvailable(ciclo, docente, d, s)){
                const key = slotKey(d,s);
                if(!usedByCycle.has(ciclo)) usedByCycle.set(ciclo, new Set());
                usedByCycle.get(ciclo).add(key);
                const dm = perDayCountByCycle.get(ciclo) || new Map(); dm.set(d, (dm.get(d)||0)+1); perDayCountByCycle.set(ciclo, dm);
                if(docente){ if(!usedByDocente.has(docente)) usedByDocente.set(docente, new Set()); usedByDocente.get(docente).add(key); }
                places.push({d,s});
                continue outer;
              }
            }
          }
          return null; // sin hueco
        }
        return places;
      }

      const cycles = Array.from(new Set(items.map(i=>i.ciclo).filter(x=>x!==''))).map(x=>Number(x)).filter(n=>!isNaN(n)).sort((a,b)=>a-b);
      const cp = Number(cicloPrincipal);
      let order=[]; if(cycles.includes(cp)){ order=[cp]; let off=1; while(order.length<cycles.length){ const b=cp-off, a=cp+off; if(cycles.includes(b)) order.push(b); if(cycles.includes(a)) order.push(a); off++; } } else { order=cycles.slice(); }

      const byCycle = new Map(); items.forEach(it=>{ const c=Number(it.ciclo)||0; if(!byCycle.has(c)) byCycle.set(c,[]); byCycle.get(c).push(it); });
      const out=[]; const warns=[];

      for(const c of order){
        const list = (byCycle.get(c)||[]).sort((a,b)=> norm(a.materia).localeCompare(norm(b.materia)) || norm(a.paralelo).localeCompare(norm(b.paralelo)) );
        for(const it of list){
          const hours = it.hoursSchedule; // numérico
          if(hours<=0){ out.push({...it, dia:'', hora:'', nroHoras:0}); continue; }
          const placed = place(Number(it.ciclo)||0, it.docente, hours);
          if(!placed){
            warns.push(`Sin hueco: ${it.materia} (C${it.ciclo}, Paralelo ${it.paralelo}).`);
            out.push({...it, dia:'', hora:'', nroHoras:hours});
          } else {
            for(const p of placed){ out.push({...it, dia:DAYS[p.d], hora:SLOTS[p.s].label, nroHoras:3}); }
            const exceso = placed.length*3 - hours; if(exceso>0){ out[out.length-1].nroHoras = Math.max(1, 3-exceso); }
          }
        }
      }
      return {rowsOut:out, warnings:warns};
    }

    function render(rows){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      const c = v=>`<td>${v==null? '': String(v)}</td>`;
      const cn = v=>`<td class="center">${v==null? '': String(v)}</td>`;
      let html='';
      for(const r of rows){
        html += '<tr>' + c(r.docente)+c(r.titulo)+c(r.dedicacion)+c(r.materia)+c(r.codigoAnth)+c(r.carreras)+c(r.mallas)+c(r.prereq)+c(r.codigo)+cn(r.horasT)+cn(r.horasP)+cn(r.horasA)+cn(r.creditos)+c(r.campo)+cn(r.ciclo)+cn(r.norden)+cn(r.paralelo)+c(r.dia)+c(r.hora)+c(r.modalidad)+cn(r.nroHoras) + '</tr>';
      }
      tbody.innerHTML = html;
      document.getElementById('countRows').textContent = rows.length;
    }

    btn.addEventListener('click', async ()=>{
      warningsEl.innerHTML=''; tbody.innerHTML=''; countRowsEl.textContent='0'; btn.disabled=true; status.textContent='Procesando…';
      const cap = Math.max(1, Number(capParaleloEl.value||30)); const cicloP = Number(cicloPrincipalEl.value||2);
      try{
        const [mRaw, dRaw] = await Promise.all([readXlsx(mFile.files[0]), readXlsx(dFile.files[0])]);
        const docentesIdx = indexDocentes(dRaw);
        const groups = groupMallas(mRaw);

        // Construir items (una fila por paralelo, combinando carreras con '/')
        const items = [];
        for(const [k,g] of groups){
          const totalEst = g.totalEst>0? g.totalEst : cap; // si no hay dato, asuma 1 paralelo
          const nPar = Math.max(1, Math.ceil(totalEst / cap));
          // ciclo dominante (modo numérico)
          const cicloNums = g.ciclos.map(x=>Number(x)).filter(n=>!isNaN(n));
          const cycleCount = new Map(); cicloNums.forEach(n=> cycleCount.set(n,(cycleCount.get(n)||0)+1));
          const cicloDom = cicloNums.length? Array.from(cycleCount.entries()).sort((a,b)=>b[1]-a[1])[0][0] : 0;
          // horas para programar: use max de (HT+HP) entre carreras
          const toN = v=> (v==null||v==='')?0:Number(String(v).replace(',', '.'));
          const hoursMax = Math.max(0, ...g.ht.map((x,i)=> toN(x)+toN(g.hp[i])));
          // slash-joined
          const join = arr => arr.map(v=> (v==null||v==='')? '' : String(v)).join(' / ');

          // docentes para esta materia (round-robin)
          const keyMateria = g.materia.toLowerCase();
          const docs = docentesIdx.byMateria.get(keyMateria) || docentesIdx.generic;
          for(let p=0;p<nPar;p++){
            const doc = docs.length? docs[p % docs.length] : {DOCENTE:'', TITULO:'', DED:''};
            items.push({
              docente: doc.DOCENTE,
              titulo: doc.TITULO,
              dedicacion: doc.DED,
              materia: g.materia,
              codigoAnth: g.anth,
              carreras: join(g.carreras),
              mallas: join(g.mallas),
              prereq: join(g.prereqs),
              codigo: join(g.codigos),
              horasT: join(g.ht),
              horasP: join(g.hp),
              horasA: join(g.ha),
              creditos: join(g.creditos),
              campo: join(g.campo),
              ciclo: String(cicloDom||''),
              norden: join(g.norden),
              paralelo: PARALLELS[p] || ('P'+(p+1)),
              dia: '', hora: '', modalidad: join(g.modalidades),
              hoursSchedule: hoursMax // numérico
            });
          }
        }

        // ordenar y programar
        items.sort((a,b)=> (Number(a.ciclo)||0)-(Number(b.ciclo)||0) || norm(a.materia).localeCompare(norm(b.materia)) || norm(a.paralelo).localeCompare(norm(b.paralelo)) );
        const {rowsOut, warnings} = schedule(items, cicloP);
        warningsEl.innerHTML = warnings.length? `<div class="warning">${warnings.map(w=>`<div>• ${w}</div>`).join('')}</div>` : '<div class="ok">Programación generada sin conflictos entre ciclos contiguos.</div>';
        render(rowsOut);
        status.textContent='Completado.';
      }catch(err){
        console.error(err); status.textContent='Error procesando archivos.'; warningsEl.innerHTML = '<div class="warning">Revise que los encabezados existan (materia, ciclo, horas, etc.). Esta versión acepta variaciones y tildes.</div>';
      } finally{ btn.disabled=false; }
    });

    // Lectura
    const readXlsx = file => new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = e => { try{ const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'}); let rows=[]; wb.SheetNames.forEach(n=>{ const ws=wb.Sheets[n]; rows=rows.concat(XLSX.utils.sheet_to_json(ws,{defval:''})); }); resolve(rows); }catch(err){ reject(err); } };
      fr.onerror = reject; fr.readAsArrayBuffer(file);
    });

  })();
  </script>
</body>
</html>
