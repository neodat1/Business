<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matriz UIDE — Lector robusto (auto-mapeo exacto)</title>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --azul:#04136C; --mostaza:#DE912E; --vino:#862B39; --celeste:#9CBEE3; --verde:#8A9520;
    --borde:#E6E9F2; --gris:#F7F9FC;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;color:#101522}
  header{display:flex;gap:14px;align-items:center;padding:14px 18px;color:#fff;
    background:linear-gradient(90deg,var(--azul) 0%, #0a1f8d 45%, var(--celeste) 100%)}
  header img{height:56px}
  header h1{margin:0;font-size:20px}
  header small{opacity:.95}
  .toolbar{display:flex;gap:12px;flex-wrap:wrap;padding:12px 18px;background:var(--gris);border-bottom:1px solid var(--borde)}
  .card{background:#fff;border:1px solid var(--borde);border-radius:14px;padding:12px;min-width:280px}
  label{display:block;font-size:12px;font-weight:800;color:var(--azul);margin-bottom:6px}
  input[type=file]{width:100%;border:1px dashed var(--celeste);background:#fbfdff;border-radius:10px;padding:10px}
  button{border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn-1{background:var(--mostaza);color:#291600}
  .btn-2{background:var(--azul);color:#fff}
  .btn-3{background:#fff;color:var(--azul);border:1px solid var(--azul)}
  main{padding:16px 18px}
  .panel{background:#fff;border:1px solid var(--borde);border-radius:14px;padding:12px}
  .err{background:#fff3f3;border:1px solid #ffc9c9;color:#7a1b1b;padding:10px;border-radius:10px;margin-bottom:10px}
  .ok{background:#f3fff6;border:1px solid #b9f0c2;color:#0d6a2d;padding:8px;border-radius:10px;margin-bottom:10px}
  table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--borde);border-radius:14px;overflow:hidden}
  thead th{position:sticky;top:0;background:var(--azul);color:#fff;padding:10px 8px;font-size:12px;text-align:left}
  tbody td{border-top:1px solid #eef1f7;padding:8px;font-size:13px}
  tbody tr:nth-child(odd){background:#fbfcff}
  .chip{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:var(--celeste);font-weight:800;font-size:12px}
  .meta{font-size:12px;color:#5b6075}
</style>
</head>
<body>
<header>
  <img src="UIDE-Ecuador.png" alt="UIDE Ecuador" />
  <div>
    <h1>Matriz de Planificación Académica</h1>
    <small>Lectura robusta de columnas (auto-detección en todas las hojas)</small>
  </div>
</header>

<section class="toolbar">
  <div class="card" style="flex:1 1 360px">
    <label>1) Cargue <u>Mallas.xlsx</u></label>
    <input id="mallasFile" type="file" accept=".xlsx,.xls" />
    <div class="meta">Se detectan cabeceras con tolerancia a tildes, mayúsculas, guiones y espacios.</div>
  </div>
  <div class="card" style="flex:1 1 360px">
    <label>2) Cargue <u>Docentes.xlsx</u></label>
    <input id="docentesFile" type="file" accept=".xlsx,.xls" />
    <div class="meta">Admite múltiples días/horas separados por “/ , ; y”.</div>
  </div>
  <div class="card">
    <label>Acciones</label>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn-1" id="btnRun">Procesar y llenar matriz</button>
      <button class="btn-2" id="btnCsv">Descargar CSV</button>
      <button class="btn-3" id="btnClear">Limpiar</button>
    </div>
  </div>
</section>

<main>
  <div id="diag" class="panel"></div>

  <div class="panel" style="overflow:auto;margin-top:12px">
    <table id="matriz">
      <thead>
        <tr>
          <th>DOCENTE</th>
          <th>TITULO ACADÉMICO</th>
          <th>DEDICACIÓN</th>
          <th>MATERIA</th>
          <th>CÓDIGO ANTHOLOGY</th>
          <th>CARRERAS QUE COMPARTEN</th>
          <th>MALLA</th>
          <th>PRE-REQUISITO</th>
          <th>CODIGO</th>
          <th>HORAS TEÓRICAS</th>
          <th>HORAS PRÁCTICAS</th>
          <th>HORAS AUTÓNOMAS</th>
          <th>CREDITOS</th>
          <th>CAMPO DE FORMACIÓN</th>
          <th>CICLO MALLA</th>
          <th>Nº ORDEN EN LA MALLA</th>
          <th>PARALELO</th>
          <th>DIA</th>
          <th>HORA</th>
          <th>MODALIDAD</th>
          <th>Nro. HORAS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script>
/* =========================
   Normalización
   ========================= */
const deacc = s => s.normalize("NFD").replace(/[\u0300-\u036f]/g,"");
const NORM = s => deacc(String(s??"").toUpperCase().trim().replace(/\s+/g," ").replace(/[_\-–—]/g," "));
const normV = v => String(v??"").trim();

/* =========================
   Aliases “precisos” por campo
   ========================= */
// MALLAS
const M_ALIAS = {
  CARRERA: [/^CARRERA$/],
  MALLA: [/^MALLA$|^PLAN\b/],
  CICLO: [/^CICLO( MALLA)?$|^NIVEL$/],
  MATERIA: [/^ASIGNATURA$|^MATERIA$|^NOMBRE DE LA MATERIA$/],
  CODIGO: [/^CODIGO$|^CÓDIGO(\s+MATERIA)?$/],
  CAMPO: [/^CAMPO( DE)? FORMACION$|^CAMPO$/],
  HT: [/^HORAS TEORICAS$|^HT$/],
  HP: [/^HORAS PRACTICAS$|^HP$/],
  HA: [/^HORAS AUTONOMAS$|^HA$/],
  CREDITOS: [/^CREDITOS$|^N(Ú|U)MERO? (DE )?CR(É|E)DITOS$/],
  ORDEN: [/^(N(Ú|U)MERO|NO\.?) (DE )?ORDEN( EN LA MALLA)?$|^ORDEN MALLA$/],
  PREREQ: [/^PRER?REQUISITO(S)?$|^PRE REQUISITO(S)?$|^PRE\-REQUISITO(S)?$/],
  COD_ANTH: [/^CODIGO ANTHOLOGY$|^C(Ó|O)DIGO ANTHOLOGY$|^ANTHOLOGY$/],
  MODALIDAD: [/^MODALIDAD$|^TIPO DE CLASE$/],
  COMPARTEN: [/^CARRERAS QUE COMPARTEN$|^COMPARTIDA CON$|^CARRERAS COMPARTEN$/]
};
// DOCENTES
const D_ALIAS = {
  DOCENTE: [/^DOCENTE$|^PROFESOR$|^NOMBRE DOCENTE$/],
  TITULO: [/^T(Í|I)TULO ACADEMICO$|^T(Í|I)TULO$/],
  DEDIC: [/^DEDICACION$|^DEDICACI(Ó|O)N$|^TIPO DEDICACION$/],
  MATERIA: [/^MATERIA$|^ASIGNATURA$/],
  DIA: [/^DIA(S)? DISPONIBLE(S)?$|^DIA$|^D(Í|I)AS$/],
  HORA: [/^HORA(S)? DISPONIBLE(S)?$|^HORA(RIO)?$|^HORAS$/],
  MODALIDAD: [/^MODALIDAD$|^TIPO DE CLASE$/]
};

/* =========================
   Días y franjas
   ========================= */
const DIAS = ["Lunes","Martes","Miércoles","Jueves","Viernes"];
const FRANJAS = ["07:00–10:00","10:00–13:00","13:00–16:00","16:00–19:00","19:00–22:00"];
function normDia(x){
  const s = deacc(normV(x).toLowerCase());
  if(s.includes("lunes")) return "Lunes";
  if(s.includes("martes")) return "Martes";
  if(s.includes("miercoles")) return "Miércoles";
  if(s.includes("jueves")) return "Jueves";
  if(s.includes("viernes")) return "Viernes";
  return "";
}
function normFranja(x){
  const t = normV(x).replace(/-/g,"–");
  const m = t.match(/(\d{1,2})(?::?(\d{2}))?\s*–\s*(\d{1,2})(?::?(\d{2}))?/);
  if(!m) return "";
  const p=(h,mm)=>`${String(h).padStart(2,"0")}:${String(mm||"00").padStart(2,"0")}`;
  const out = `${p(m[1],m[2])}–${p(m[3],m[4])}`;
  return FRANJAS.includes(out) ? out : "";
}

/* =========================
   Excel helpers
   ========================= */
async function readWB(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = e=>{
      try{ res(XLSX.read(new Uint8Array(e.target.result), {type:"array"})); }
      catch(err){ rej(err); }
    };
    fr.onerror = rej; fr.readAsArrayBuffer(file);
  });
}

// devuelve objetos con claves CANÓNICAS usando alias
function parseAllSheets(wb, aliasMap){
  const rows = [];
  const diagnostics = [];
  for(const name of wb.SheetNames){
    const ws = wb.Sheets[name];
    const data = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
    if(!data.length) continue;
    const headers = data[0].map(NORM);
    // mapear índice -> campo canónico
    const h2key = new Array(headers.length).fill(null);
    Object.entries(aliasMap).forEach(([canon, regexList])=>{
      for(let i=0;i<headers.length;i++){
        const h = headers[i];
        if(h2key[i]) continue;
        if(regexList.some(rx=>rx.test(h))) { h2key[i]=canon; break; }
      }
    });
    diagnostics.push({sheet:name, headers: data[0], mapped: h2key});
    // construir filas
    for(let r=1;r<data.length;r++){
      const arr = data[r];
      const obj = {};
      for(let c=0;c<h2key.length;c++){
        const key = h2key[c];
        if(!key) continue;
        obj[key] = (obj[key] || arr[c]); // primera coincidencia manda
      }
      // ignorar filas totalmente vacías
      if(Object.values(obj).some(v=>String(v).trim()!=="")) rows.push(obj);
    }
  }
  return {rows, diagnostics};
}

/* =========================
   Validación requerida
   ========================= */
const REQ_M = ["CARRERA","MALLA","CICLO","MATERIA","CODIGO","CAMPO","HT","HP","HA","CREDITOS","ORDEN","PREREQ"];
const REQ_D = ["DOCENTE","TITULO","DEDIC","MATERIA"];

function missing(objArr, req){
  const present = new Set();
  objArr.forEach(o=>Object.keys(o).forEach(k=>present.add(k)));
  return req.filter(k=>!present.has(k));
}

/* =========================
   Construcción académica
   ========================= */
function toInt(x){ const n=parseInt(String(x??"").replace(/[^0-9-]/g,""),10); return Number.isFinite(n)?n:0; }

// paralelos por carrera/ciclo/materia
function buildSecciones(m){
  const key = x=>[normV(x.CARRERA).toUpperCase(), normV(x.CICLO).toUpperCase(), normV(x.MATERIA).toUpperCase()].join("|");
  const g = new Map();
  m.forEach(r=>{ const k=key(r); if(!g.has(k)) g.set(k,[]); g.get(k).push(r); });
  const out=[];
  g.forEach(list=>{
    list.sort((a,b)=>String(a.ORDEN).localeCompare(String(b.ORDEN),"es"));
    list.forEach((it,i)=>out.push({...it, PARALELO:String.fromCharCode(65+i)}));
  });
  return out;
}

// índice de docentes por materia
function indexDocentes(dd){
  const idx=new Map();
  dd.forEach(d=>{
    const k = normV(d.MATERIA).toUpperCase();
    if(!idx.has(k)) idx.set(k,[]);
    // parse disponibilidad
    const days = String(d.DIA||"").split(/[\/,;]| y /i).map(normDia).filter(Boolean);
    const hours = String(d.HORA||"").split(/[\/,;]| y /i).map(normFranja).filter(Boolean);
    const slots=new Set();
    if(days.length && hours.length) for(const di of days) for(const ho of hours) slots.add(`${di}@@${ho}`);
    idx.get(k).push({
      DOCENTE:normV(d.DOCENTE), TITULO:normV(d.TITULO), DEDIC:normV(d.DEDIC),
      MODALIDAD:normV(d.MODALIDAD), SLOTS:slots
    });
  });
  return idx;
}

// compartir por materia+ciclo
function shareIndex(m){
  const idx=new Map();
  m.forEach(r=>{
    const k=[normV(r.MATERIA).toUpperCase(), normV(r.CICLO).toUpperCase()].join("|");
    if(!idx.has(k)) idx.set(k,{carr:new Set(), mallas:new Set(), cods:new Set(), hts:new Set(), hps:new Set(), has:new Set(), creds:new Set(), campos:new Set(), anth:new Set()});
    const o=idx.get(k);
    o.carr.add(normV(r.CARRERA));
    o.mallas.add(normV(r.MALLA));
    if(r.CODIGO) o.cods.add(normV(r.CODIGO));
    if(r.HT!=null) o.hts.add(String(toInt(r.HT)));
    if(r.HP!=null) o.hps.add(String(toInt(r.HP)));
    if(r.HA!=null) o.has.add(String(toInt(r.HA)));
    if(r.CREDITOS!=null) o.creds.add(String(toInt(r.CREDITOS)));
    if(r.CAMPO) o.campos.add(normV(r.CAMPO));
    if(r.COD_ANTH) o.anth.add(normV(r.COD_ANTH));
  });
  return idx;
}

// asignación de slots (reglas: máx 2 por día; evitar adyacentes por carrera)
function asignar(secciones, idxDoc){
  const cupoCicloDia=new Map(); // carrera|ciclo|dia -> count
  const cupoDocDia=new Map();   // docente|dia -> count
  const ocupado=new Map();      // dia||hora -> {doc:Set, carrCiclo:Set}
  const rr=new Map();           // round robin por materia

  const ady = c=>{ const n=parseInt(c,10); return Number.isFinite(n)?[String(n-1),String(n+1)]:[]; };

  for(const s of secciones){
    const mat = normV(s.MATERIA).toUpperCase();
    const cand = idxDoc.get(mat)||[];
    let choose = null;
    if(cand.length){ const i=rr.get(mat)||0; choose=cand[i % cand.length]; rr.set(mat,i+1); }

    s.DOCENTE=choose?.DOCENTE||""; s.TITULO=choose?.TITULO||""; s.DEDIC=choose?.DEDIC||""; s.MODALIDAD=choose?.MODALIDAD||"";

    const pref = choose ? Array.from(choose.SLOTS) : [];
    const order=[];
    for(const pf of pref){ const [d,h]=pf.split("@@"); if(DIAS.includes(d)&&FRANJAS.includes(h)) order.push({d,h}); }
    for(const d of DIAS) for(const h of FRANJAS){ if(!order.find(o=>o.d===d&&o.h===h)) order.push({d,h}); }

    for(const o of order){
      const kOH=`${o.d}||${o.h}`;
      if(!ocupado.has(kOH)) ocupado.set(kOH,{doc:new Set(), carrCiclo:new Set()});
      const kCD=`${s.CARRERA}|${s.CICLO}|${o.d}`;
      const kDD=`${s.DOCENTE}|${o.d}`;

      if((cupoCicloDia.get(kCD)||0)>=2) continue;
      if(s.DOCENTE && (cupoDocDia.get(kDD)||0)>=2) continue;

      // evitar adyacentes
      let choc=false;
      for(const tag of ocupado.get(kOH).carrCiclo){
        const [car,ci]=tag.split("|");
        if(car!==s.CARRERA) continue;
        if(ci===s.CICLO || ady(s.CICLO).includes(ci)) {choc=true; break;}
      }
      if(choc) continue;
      if(s.DOCENTE && ocupado.get(kOH).doc.has(s.DOCENTE)) continue;

      s.DIA=o.d; s.HORA=o.h;
      cupoCicloDia.set(kCD,(cupoCicloDia.get(kCD)||0)+1);
      if(s.DOCENTE) cupoDocDia.set(kDD,(cupoDocDia.get(kDD)||0)+1);
      ocupado.get(kOH).carrCiclo.add(`${s.CARRERA}|${s.CICLO}`);
      if(s.DOCENTE) ocupado.get(kOH).doc.add(s.DOCENTE);
      break;
    }
    s.DIA=s.DIA||""; s.HORA=s.HORA||"";
  }
  return secciones;
}

/* =========================
   Render / CSV
   ========================= */
function render(filas){
  const tb=document.querySelector("#matriz tbody"); tb.innerHTML="";
  filas.sort((a,b)=>{
    const ka=[a.CARRERA, parseInt(a.CICLO)||0, a.ORDEN, a.MATERIA, a.PARALELO].join("|");
    const kb=[b.CARRERA, parseInt(b.CICLO)||0, b.ORDEN, b.MATERIA, b.PARALELO].join("|");
    return ka.localeCompare(kb,"es");
  });
  for(const f of filas){
    const tr=document.createElement("tr");
    const cells=[
      f.DOCENTE, f.TITULO, f.DEDIC, f.MATERIA, f.ANTH_JOIN||"",
      f.CARR_JOIN, f.MALLA_JOIN, f.PREREQ||"", f.COD_JOIN, f.HT_JOIN, f.HP_JOIN, f.HA_JOIN,
      f.CRED_JOIN, f.CAMPO_JOIN, f.CICLO, f.ORDEN, f.PARALELO, f.DIA, f.HORA, f.MODALIDAD, ""
    ];
    cells.forEach((v,i)=>{
      const td=document.createElement("td");
      if(i===16) td.innerHTML=`<span class="chip">${v||"—"}</span>`;
      else if(i===3) td.innerHTML=`<strong>${v}</strong>`;
      else td.textContent=v;
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  }
}
function csvEsc(s){ return `"${String(s??"").replaceAll(`"`,`""`)}"`; }
function descargaCSV(){
  const ths=Array.from(document.querySelectorAll("#matriz thead th")).map(th=>th.textContent.trim());
  const rows=Array.from(document.querySelectorAll("#matriz tbody tr")).map(tr=>Array.from(tr.children).map(td=>td.textContent.trim()));
  const csv=[ths.map(csvEsc).join(",")].concat(rows.map(r=>r.map(csvEsc).join(","))).join("\r\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download="Matriz_UIDE.csv"; document.body.appendChild(a); a.click(); a.remove();
}

/* =========================
   UI / Flujo
   ========================= */
function diagHTML(title, list){
  const h = [
    `<div class="ok"><strong>${title}</strong></div>`,
    ...list.map(x=>`<div class="meta">• Hoja: <b>${x.sheet}</b><br><span style="opacity:.9">Cabeceras detectadas:</span> ${x.headers.map(h=>`<code>${h}</code>`).join(", ")}</div>`)
  ];
  return h.join("");
}

document.getElementById("btnRun").addEventListener("click", async ()=>{
  const fM=document.getElementById("mallasFile").files[0];
  const fD=document.getElementById("docentesFile").files[0];
  const diag=document.getElementById("diag");
  diag.innerHTML="";

  if(!fM||!fD){ diag.innerHTML=`<div class="err"><strong>Error:</strong> cargue ambos archivos.</div>`; return; }

  try{
    const [wbM, wbD] = await Promise.all([readWB(fM), readWB(fD)]);
    const {rows:rawM, diagnostics:dm} = parseAllSheets(wbM, M_ALIAS);
    const {rows:rawD, diagnostics:dd} = parseAllSheets(wbD, D_ALIAS);

    const missM = missing(rawM, REQ_M);
    const missD = missing(rawD, REQ_D);
    if(missM.length || missD.length){
      let html = "";
      if(missM.length) html += `<div class="err"><strong>Mallas.xlsx</strong> — faltan columnas: <b>${missM.join(", ")}</b></div>`;
      if(missD.length) html += `<div class="err"><strong>Docentes.xlsx</strong> — faltan columnas: <b>${missD.join(", ")}</b></div>`;
      html += diagHTML("Diagnóstico de cabeceras detectadas", dm.concat(dd));
      diag.innerHTML = html;
      return;
    }

    // tipar numéricos
    rawM.forEach(r=>{
      r.HT = toInt(r.HT); r.HP=toInt(r.HP); r.HA=toInt(r.HA); r.CREDITOS=toInt(r.CREDITOS);
    });

    // secciones (paralelos)
    const secciones = buildSecciones(rawM);

    // índices para compartir y docentes
    const idxShare = shareIndex(rawM);
    const idxDoc   = indexDocentes(rawD);

    // completar campos “join” por materia+ciclo
    secciones.forEach(s=>{
      const k=[normV(s.MATERIA).toUpperCase(), normV(s.CICLO).toUpperCase()].join("|");
      const o=idxShare.get(k)||{carr:new Set(), mallas:new Set(), cods:new Set(), hts:new Set(), hps:new Set(), has:new Set(), creds:new Set(), campos:new Set(), anth:new Set()};
      s.CARR_JOIN  = [...o.carr].join(" / ");
      s.MALLA_JOIN = [...o.mallas].join(" / ");
      s.COD_JOIN   = [...o.cods].join(" / ");
      s.HT_JOIN    = [...o.hts].join(" / ");
      s.HP_JOIN    = [...o.hps].join(" / ");
      s.HA_JOIN    = [...o.has].join(" / ");
      s.CRED_JOIN  = [...o.creds].join(" / ");
      s.CAMPO_JOIN = [...o.campos].join(" / ");
      s.ANTH_JOIN  = [...o.anth].join(" / ");
    });

    // asignación de días/horas
    asignar(secciones, idxDoc);

    render(secciones);

    diag.innerHTML = diagHTML("Archivos procesados correctamente", dm.concat(dd));
  }catch(e){
    console.error(e);
    document.getElementById("diag").innerHTML = `<div class="err"><strong>Error:</strong> no se pudo procesar el contenido del Excel.</div>`;
  }
});

document.getElementById("btnCsv").addEventListener("click", descargaCSV);
document.getElementById("btnClear").addEventListener("click", ()=>{
  document.querySelector("#matriz tbody").innerHTML="";
  document.getElementById("diag").innerHTML="";
  document.getElementById("mallasFile").value="";
  document.getElementById("docentesFile").value="";
});
</script>
</body>
</html>
