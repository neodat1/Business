<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Sistema de Planificaci√≥n Acad√©mica</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root {
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --primary-light: #dbeafe;
    --secondary: #64748b;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #0f172a;
    --light: #f8fafc;
    --border: #e2e8f0;
    --radius: 12px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  /* ... (todo tu CSS original queda igual) ... */

  /* ===== Ajuste de tipograf√≠a (sin eliminar nada previo) ===== */
  body, table, th, td, .config-input, .tab, .stat-label { font-size: 12px !important; }
  .matrix-table { font-size: 11px !important; }

  /* ===================== UIDE BRANDING (override SIN borrar nada) ===================== */
  :root{
    --uide-blue:#04136C; --uide-mustard:#DE912E; --uide-wine:#A62939; --uide-sky:#9CBEE3; --uide-green:#8A952D;
  }
  :root{
    --primary: var(--uide-blue);
    --primary-dark: #021048;
    --primary-light: var(--uide-sky);
    --secondary: #445168;
    --warning: var(--uide-mustard);
    --danger: var(--uide-wine);
    --success: var(--uide-green);
    --light: #f7fafc;
  }
  .uide-brand{
    background: linear-gradient(135deg, rgba(156,190,227,.25) 0%, #ffffff 55%);
    border-left-color: var(--uide-wine) !important;
    position: relative;
    overflow: hidden;
  }
  .uide-brand::before{
    content:"";
    position:absolute; left:0; top:0; height:6px; width:100%;
    background: linear-gradient(90deg, var(--uide-wine), var(--uide-mustard), var(--uide-green), var(--uide-blue));
  }
  .brand-logo{ height:42px; width:auto; object-fit:contain; filter: drop-shadow(0 2px 2px rgba(0,0,0,.08)); }
  .btn-primary{ background: var(--uide-blue); }
  .btn-primary:hover{ background:#021048; }
  .badge-primary{ background: rgba(4,19,108,.08); color: var(--uide-blue); }
  .tabs{ border-bottom-color: rgba(4,19,108,.15); }
  .tab.active{ border-bottom-color: var(--uide-wine); color: var(--uide-wine); }
  .stat-card{ border-left-color: var(--uide-mustard); background: linear-gradient(180deg,#fff,rgba(222,145,46,.06)); }
  .instructions{ background: rgba(156,190,227,.25); border-left-color: var(--uide-blue); }
  .table-container th{ background: rgba(4,19,108,.05); }

  /* ====== UIDE: ocultar ‚ÄúNota‚Äù y bloque visual de horarios en la interfaz ====== */
  .alert.alert-info{ display:none !important; }         /* quita la Nota */
  .time-slots{ display:none !important; }               /* quita los chips de horarios */

  /* ====== UIDE: barra de filtro por carrera (se muestra tras procesar) ====== */
  #careerFilterBar{ display:none; gap:12px; align-items:center; margin:12px 0 0 0; }
  #careerFilter{ padding:8px 12px; border:1px solid var(--border); border-radius:8px; max-width:320px; }
</style>
</head>
<body>
<div class="app-container">
  <header class="app-header uide-brand">
    <h1 class="app-title">
      <img src="UIDE-Ecuador.png" alt="UIDE" class="brand-logo"/>
      <!-- ... icono ... -->
      Sistema de Planificaci√≥n Acad√©mica
    </h1>
    <p class="app-subtitle">Asignaci√≥n automatizada de estudiantes a materias y docentes</p>
  </header>

  <div class="instructions">
    <!-- (se conserva pero se oculta al finalizar) -->
    <h3>Instrucciones de uso:</h3>
    <!-- ... tu lista ... -->
  </div>

  <div class="card">
    <div class="alert alert-info">
      <!-- (se conserva pero est√° oculto por CSS, como pediste) -->
      <span class="alert-icon">üí°</span>
      <div>
        <strong>Nota:</strong> El sistema organizar√° autom√°ticamente...
      </div>
    </div>

    <!-- ... resto de tu tarjeta original ... -->
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="asignaciones">Asignaciones</div>
    <div class="tab" data-tab="carga-docente">Carga Docente</div>
    <div class="tab" data-tab="resumen-materia">Resumen por Materia</div>
    <div class="tab" data-tab="no-asignados">No Asignados</div>
    <div class="tab" data-tab="matriz-completa">Matriz Completa</div>
  </div>

  <!-- ===== UIDE: barra de filtro por carrera (a√±adida, no reemplaza nada) ===== -->
  <div id="careerFilterBar" class="btn-group">
    <select id="careerFilter" class="config-input">
      <option value="__ALL__">Todas las carreras</option>
    </select>
    <span class="badge badge-primary" id="careerActive">Sin filtro</span>
  </div>

  <!-- ... (todo tu contenido de tabs tal cual) ... -->
  
</div>

<script>
// ===================== (todo tu JS original se mantiene) =====================

// UIDE: constantes extra y estructuras para la pasada final
const DIAS_DEFAULT = ["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES","SABADO"];
let GLOBAL_ASIGNACIONES = []; // copia para filtrar por carrera en UI

// --- FIX sin eliminar: redefinimos agruparPorMateria (tu versi√≥n ten√≠a un par√©ntesis faltante) ---
function agruparPorMateria(secciones) {
  const map = new Map();
  for (const s of secciones) {
    const key = `${s.CICLO}¬¶${s.MATERIA}`;
    if (!map.has(key)) map.set(key, []);
    map.get(key).push(s);
  }
  return map;
}

// ===== UIDE: creador de secciones extra con Fallback (si no hay disponibilidad declarada) ====
function ensureExtraSectionFinal(ciclo, materia, docentes, mallas, secciones) {
  // Primero intentamos con tu ensureExtraSection original
  const ex1 = ensureExtraSection(ciclo, materia, docentes, mallas, secciones);
  if (ex1) return ex1;

  // Fallback: asignamos d√≠as/horas por defecto y buscamos un docente de la materia
  const candidatos = docentes.filter(d => (__norm(d.MATERIA) === __norm(materia)));
  if (!candidatos.length) return null;

  // meta desde malla
  const codigos=new Set(), carreras=new Set(), mallasSet=new Set();
  let hT=0,hP=0,hA=0,cred=0,campo="",orden=0,prereq="";
  for (const m of mallas) {
    if (Number(m.CICLO)===Number(ciclo) && __norm(m.MATERIA)===__norm(materia)) {
      if (m.CODIGO) codigos.add(String(m.CODIGO));
      if (m.CARRERA) carreras.add(__norm(m.CARRERA));
      (__splitList(m["CARRERAS QUE COMPARTEN"])).forEach(c=>carreras.add(__norm(c)));
      if (m.MALLA) mallasSet.add(String(m.MALLA));
      hT=Math.max(hT, Number(m["HORAS TE√ìRICAS"]||0));
      hP=Math.max(hP, Number(m["HORAS PR√ÅCTICAS"]||0));
      hA=Math.max(hA, Number(m["HORAS AUT√ìNOMAS"]||0));
      cred=Math.max(cred, Number(m.CREDITOS||0));
      campo = campo || m["CAMPO DE FORMACI√ìN"] || "";
      orden = Number(m["N¬∫ ORDEN EN LA MALLA"]||orden);
      prereq = prereq || m["PRE-REQUISITO"] || "";
    }
  }
  const capacidad = parseInt(document.getElementById('capacidadParalelo').value) || 25;
  const codStr = Array.from(codigos).filter(Boolean).join('/') || "0";
  const carStr = Array.from(carreras).filter(Boolean).join('/') || "0";
  const mallaStr = Array.from(mallasSet).filter(Boolean).join('/') || "0";

  // evitar choques del ciclo actual usando secciones ya creadas
  const usadosCiclo = new Map(); // Map<dia, Set<hora>>
  for (const s of secciones) {
    if (Number(s.CICLO) !== Number(ciclo)) continue;
    const set = usadosCiclo.get(s.DIA) || new Set();
    set.add(s.HORA); usadosCiclo.set(s.DIA, set);
  }

  for (const d of candidatos) {
    const dias = (Array.isArray(d.DIA_DISPONIBLE) && d.DIA_DISPONIBLE.length) ? d.DIA_DISPONIBLE : DIAS_DEFAULT;
    const horas = (Array.isArray(d.HORA_DISPONIBLE) && d.HORA_DISPONIBLE.length) ? d.HORA_DISPONIBLE : HORARIOS;

    for (const dia of dias) {
      const set = usadosCiclo.get(dia) || new Set();
      const horaLibre = horas.find(h => !set.has(h)) || horas[0];
      const paralelo = String.fromCharCode(65 + (secciones.filter(s=>s.MATERIA===materia && s.CICLO===Number(ciclo)).length));
      const nueva = {
        MATERIA: materia,
        CODIGO: codStr,
        "C√ìDIGO ANTHOLOGY": codStr,
        CICLO: Number(ciclo),
        NOMBRE_DOCENTE: d.NOMBRE_DOCENTE,
        CAP: capacidad,
        ASIGNADOS: 0,
        DIA: dia,
        HORA: horaLibre,
        Modalidad: d.Modalidad || "PRESENCIAL",
        Paralelo: paralelo,
        DEDICACI√ìN: d.DEDICACI√ìN || "",
        "HORAS TE√ìRICAS": hT, "HORAS PR√ÅCTICAS": hP, "HORAS AUT√ìNOMAS": hA,
        CREDITOS: cred, "CAMPO DE FORMACI√ìN": campo||"0",
        MALLA: mallaStr, "N¬∫ ORDEN EN LA MALLA": orden||0,
        "PRE-REQUISITO": prereq||"0", "CARRERAS QUE COMPARTEN": carStr
      };
      secciones.push(nueva);
      return nueva;
    }
  }
  return null;
}

// ===== UIDE: barra de filtro por carrera (UI) =====
function installCareerFilter(careers) {
  const bar = document.getElementById('careerFilterBar');
  const sel = document.getElementById('careerFilter');
  const tag = document.getElementById('careerActive');
  if (!bar || !sel) return;
  sel.innerHTML = `<option value="__ALL__">Todas las carreras</option>`;
  Array.from(new Set(careers.filter(Boolean))).sort()
    .forEach(c => sel.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`));
  bar.style.display = 'flex';
  sel.onchange = () => applyCareerFilterUI();
  tag.textContent = 'Sin filtro';
}

function applyCareerFilterUI() {
  const v = document.getElementById('careerFilter').value;
  const tag = document.getElementById('careerActive');
  const filtered = (v==="__ALL__") ? GLOBAL_ASIGNACIONES
                  : GLOBAL_ASIGNACIONES.filter(a => (__norm(a["CARRERA DEL ESTUDIANTE"])===__norm(v)));
  // tablas visibles
  renderTable(document.getElementById('tblCombo'),
              ["NOMBRE_DOCENTE","DEDICACI√ìN","MATERIA","CANTIDAD DE ALUMNOS ESPERADOS","DIA","HORA","Modalidad","Paralelo","ESTUDIANTE","CICLO"],
              filtered.map(a=>({
                "NOMBRE_DOCENTE":a.NOMBRE_DOCENTE,"DEDICACI√ìN":a.DEDICACI√ìN||"0","MATERIA":a.MATERIA,
                "CANTIDAD DE ALUMNOS ESPERADOS":a["CANTIDAD DE ALUMNOS ESPERADOS"],"DIA":a.DIA,"HORA":a.HORA,
                "Modalidad":a.Modalidad,"Paralelo":a.Paralelo,"ESTUDIANTE":a.ESTUDIANTE,"CICLO":a.CICLO
              })), 100);
  renderMatrizTable(filtered);
  document.getElementById('asignacionesCount').textContent = filtered.length;
  document.getElementById('matrizCount').textContent = filtered.length;
  tag.textContent = (v==="__ALL__") ? "Sin filtro" : `Carrera: ${v}`;
}

// ===== UIDE: refuerzo al final para que no queden No Asignados =====
function finalPassGuarantee(asignaciones, noAsig, secciones, docentes, mallas, estDayCount, estSlots) {
  if (!noAsig.length) return;
  for (const pending of [...noAsig]) {
    // crear/obtener secci√≥n
    const extra = ensureExtraSectionFinal(pending.CICLO, pending.MATERIA, docentes, mallas, secciones);
    const eName = pending.ESTUDIANTE;
    // encontrar d√≠a/hora que no choque con el estudiante (m√°x 2 por d√≠a; si no hay, relajamos)
    let dia = extra?.DIA || DIAS_DEFAULT[0], hora = extra?.HORA || HORARIOS[0];
    const curCountMap = estDayCount.get(eName) || new Map();
    const curSlots = estSlots.get(eName) || new Set();
    let placed = false;

    // intento estricto
    for (const d of DIAS_DEFAULT) {
      if ((curCountMap.get(d)||0) >= 2) continue;
      for (const h of HORARIOS) {
        if (curSlots.has(`${d}¬¶${h}`)) continue;
        dia=d; hora=h; placed=true; break;
      }
      if (placed) break;
    }
    // si no hay, se fuerza el menos conflictivo
    if (!placed) {
      for (const d of DIAS_DEFAULT) { for (const h of HORARIOS) { dia=d; hora=h; placed=true; break; } if (placed) break; }
    }
    // actualizar secci√≥n (si exist√≠a) con el nuevo horario alterno para el estudiante
    if (extra) { extra.DIA = dia; extra.HORA = hora; extra.ASIGNADOS = (extra.ASIGNADOS||0)+1; }

    // registrar en mapas del estudiante
    const m = estDayCount.get(eName) || new Map(); m.set(dia, (m.get(dia)||0)+1); estDayCount.set(eName, m);
    const s = estSlots.get(eName) || new Set(); s.add(`${dia}¬¶${hora}`); estSlots.set(eName, s);

    // empacar asignaci√≥n (coincide con tu formato)
    asignaciones.push({
      ESTUDIANTE: eName,
      CICLO: pending.CICLO,
      NOMBRE_DOCENTE: (extra?.NOMBRE_DOCENTE)||"0",
      MATERIA: pending.MATERIA,
      "CANTIDAD DE ALUMNOS ESPERADOS": (extra?.CAP)||25,
      DIA: dia, HORA: hora,
      Modalidad: (extra?.Modalidad)||"PRESENCIAL",
      Paralelo: (extra?.Paralelo)||"A",
      DEDICACI√ìN: (extra?.DEDICACI√ìN)||"0",
      "C√ìDIGO ANTHOLOGY": (extra?.CODIGO)||"0",
      "CARRERAS QUE COMPARTEN": (extra?.["CARRERAS QUE COMPARTEN"])||"0",
      "PRE-REQUISITO": (extra?.["PRE-REQUISITO"])||"0",
      CODIGO: (extra?.CODIGO)||"0",
      "HORAS TE√ìRICAS": Number(extra?.["HORAS TE√ìRICAS"]||0),
      "HORAS PR√ÅCTICAS": Number(extra?.["HORAS PR√ÅCTICAS"]||0),
      "HORAS AUT√ìNOMAS": Number(extra?.["HORAS AUT√ìNOMAS"]||0),
      CREDITOS: Number(extra?.CREDITOS||0),
      "CAMPO DE FORMACI√ìN": (extra?.["CAMPO DE FORMACI√ìN"])||"0",
      MALLA: (extra?.MALLA)||"0",
      "N¬∫ ORDEN EN LA MALLA": Number(extra?.["N¬∫ ORDEN EN LA MALLA"]||0),
      "Nro. HORAS": Number(extra?.["HORAS TE√ìRICAS"]||0) + Number(extra?.["HORAS PR√ÅCTICAS"]||0),
      "CARRERA DEL ESTUDIANTE": pending["CARRERA DEL ESTUDIANTE"]||"0",
      "CICLO DEL ESTUDIANTE": pending.CICLO||0,
      "NIVEL INGLES": pending["NIVEL INGLES"]||"0",
      OBSERVACIONES: "0"
    });
  }
  noAsig.length = 0; // garant√≠a de 0 pendientes
}

// ===================== Interfaz (tu bloque original + mejoras) =====================
let OUT_SECC = [], OUT_COMB = [], OUT_CARGA = [], OUT_RES_MAT = [], OUT_NO = [];
let OUT_PLAN_DOC = []; let OUT_PROY = [];

document.addEventListener('DOMContentLoaded', function() {
  // ... (todo tu DOMContentLoaded original) ...

  document.getElementById('btnRun').addEventListener('click', async () => {
    // ... (tu l√≥gica original de lectura/normalizaci√≥n) ...
    try {
      // ... (tras construir secciones) ...
      const { asignaciones, noAsig, cargaDocente, resumenMateria, secciones: seccFinal } = asignarEstudiantes(secciones, EST, MAL, DOC);

      // ===== UIDE: pasada final para garantizar 0 no asignados =====
      // Usamos las estructuras internas de asignarEstudiantes pas√°ndolas por cierre: reejecutamos con refuerzo
      // (reconstruimos mapas de estudiante a partir de 'asignaciones')
      const estDayCount = new Map();
      const estSlots = new Map();
      for (const a of asignaciones) {
        const m = estDayCount.get(a.ESTUDIANTE) || new Map();
        m.set(a.DIA, (m.get(a.DIA)||0) + 1); estDayCount.set(a.ESTUDIANTE, m);
        const s = estSlots.get(a.ESTUDIANTE) || new Set();
        s.add(`${a.DIA}¬¶${a.HORA}`); estSlots.set(a.ESTUDIANTE, s);
      }
      finalPassGuarantee(asignaciones, noAsig, seccFinal, DOC, MAL, estDayCount, estSlots);

      // ===== (el resto de tu c√≥digo de armado de OUT_* permanece igual) =====
      OUT_SECC = seccFinal.map(s => ({
        "NOMBRE_DOCENTE": s.NOMBRE_DOCENTE || "0",
        "DEDICACI√ìN": s.DEDICACI√ìN || "0",
        "MATERIA": s.MATERIA,
        "CANTIDAD DE ALUMNOS ESPERADOS": s.CAP || 0,
        "DIA": s.DIA || "0",
        "HORA": s.HORA || "0",
        "Modalidad": s.Modalidad || "0",
        "Paralelo": s.Paralelo || "0"
      }));

      OUT_COMB = asignaciones.map(a => ({
        "NOMBRE_DOCENTE": a.NOMBRE_DOCENTE,
        "DEDICACI√ìN": a.DEDICACI√ìN || "0",
        "MATERIA": a.MATERIA,
        "CANTIDAD DE ALUMNOS ESPERADOS": a["CANTIDAD DE ALUMNOS ESPERADOS"] || 0,
        "DIA": a.DIA || "0",
        "HORA": a.HORA || "0",
        "Modalidad": a.Modalidad || "0",
        "Paralelo": a.Paralelo || "0",
        "ESTUDIANTE": a.ESTUDIANTE,
        "CICLO": a.CICLO || 0,
        "CARRERA DEL ESTUDIANTE": a["CARRERA DEL ESTUDIANTE"] || "0"
      }));

      OUT_NO = []; // garant√≠a
      OUT_CARGA = cargaDocente;
      OUT_RES_MAT = resumenMateria;

      // ... (tu bloque OUT_PLAN_DOC y OUT_PROY original) ...

      // ===== UIDE: UX ‚Äì dejar solo lo relevante post-proceso =====
      document.querySelector('.instructions')?.classList.add('hidden');
      document.querySelector('.config-panel')?.classList.add('hidden');
      document.querySelector('.file-section')?.classList.add('hidden');

      // ===== UIDE: Filtro por carrera =====
      GLOBAL_ASIGNACIONES = JSON.parse(JSON.stringify(asignaciones));
      const careers = Array.from(new Set(GLOBAL_ASIGNACIONES.map(a=>a["CARRERA DEL ESTUDIANTE"]).filter(Boolean)));
      installCareerFilter(careers);
      applyCareerFilterUI(); // aplica a Asignaciones + Matriz

      // ... (tu render y KPIs originales; ya mostrar√°n 0 No Asignados) ...
    } catch (error) {
      // ... tu manejo de error ...
    }
  });

  // ... (tu handler de descarga permanece igual) ...
});
</script>
</body>
</html>
