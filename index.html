<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Sistema de Planificaci√≥n Acad√©mica</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root {
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --primary-light: #dbeafe;
    --secondary: #64748b;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #0f172a;
    --light: #f8fafc;
    --border: #e2e8f0;
    --radius: 12px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    background: #f1f5f9;
    color: var(--dark);
    line-height: 1.6;
    padding: 0;
  }
  
  .app-container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 20px;
  }
  
  /* Header Styles */
  .app-header {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 24px;
    margin-bottom: 24px;
    border-left: 4px solid var(--primary);
  }
  
  .app-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .app-subtitle {
    color: var(--secondary);
    font-size: 16px;
    margin-bottom: 20px;
  }
  
  /* Card Styles */
  .card {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 24px;
    margin-bottom: 24px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }
  
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  
  .card-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--dark);
  }
  
  /* File Upload Styles */
  .file-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  .file-input-container {
    position: relative;
  }
  
  .file-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--dark);
  }
  
  .file-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    background: var(--light);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .file-input:hover {
    border-color: var(--primary);
    background: #f0f7ff;
  }
  
  .file-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    font-size: 14px;
  }
  
  .status-icon {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  
  .status-pending {
    background-color: var(--warning);
  }
  
  .status-success {
    background-color: var(--success);
  }
  
  /* Button Styles */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: var(--radius);
    border: none;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--primary-dark);
  }
  
  .btn-secondary {
    background: white;
    color: var(--dark);
    border: 1px solid var(--border);
  }
  
  .btn-secondary:hover {
    background: var(--light);
  }
  
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .btn-group {
    display: flex;
    gap: 12px;
    margin: 20px 0;
  }
  
  /* Progress Bar */
  .progress-container {
    width: 100%;
    height: 8px;
    background-color: var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin: 16px 0;
    display: none;
  }
  
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
    width: 0%;
    transition: width 0.4s ease;
    border-radius: 4px;
  }
  
  /* Stats Cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }
  
  .stat-card {
    background: var(--light);
    border-radius: var(--radius);
    padding: 16px;
    text-align: center;
    border-left: 4px solid var(--primary);
  }
  
  .stat-value {
    font-size: 24px;   /* m√°s peque√±o */
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
  }
  
  .stat-label {
    font-size: 12px;   /* m√°s peque√±o */
    color: var(--secondary);
  }
  
  /* Configuration Panel */
  .config-panel {
    background: var(--light);
    border-radius: var(--radius);
    padding: 20px;
    margin: 20px 0;
  }
  
  .config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
  }
  
  .config-item {
    margin-bottom: 12px;
  }
  
  .config-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--dark);
  }
  
  .config-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 12px;   /* m√°s peque√±o */
    transition: border-color 0.2s ease;
  }
  
  .config-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }
  
  .time-slots {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }
  
  .time-slot {
    padding: 6px 12px;
    background: var(--primary-light);
    color: var(--primary);
    border-radius: 20px;
    font-size: 10px;   /* m√°s peque√±o */
    font-weight: 500;
  }
  
  /* Table Styles */
  .table-container {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin: 16px 0;
    max-height: 400px;
    overflow: auto;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;   /* m√°s peque√±o */
  }
  
  th {
    background: #f8fafc;
    padding: 10px;     /* m√°s peque√±o */
    text-align: left;
    font-weight: 600;
    color: var(--dark);
    position: sticky;
    top: 0;
    border-bottom: 2px solid var(--border);
  }
  
  td {
    padding: 10px;     /* m√°s peque√±o */
    border-bottom: 1px solid var(--border);
  }
  
  tr:hover {
    background: #f1f5f9;
  }
  
  /* Alert Styles */
  .alert {
    padding: 16px;
    border-radius: var(--radius);
    margin: 16px 0;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  
  .alert-error {
    background: #fef2f2;
    color: var(--danger);
    border-left: 4px solid var(--danger);
  }
  
  .alert-info {
    background: #eff6ff;
    color: var(--primary);
    border-left: 4px solid var(--primary);
  }
  
  .alert-success {
    background: #f0fdf4;
    color: var(--success);
    border-left: 4px solid var(--success);
  }
  
  .alert-icon {
    font-size: 20px;
    flex-shrink: 0;
  }
  
  /* Badges */
  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 10px;   /* m√°s peque√±o */
    font-weight: 600;
  }
  
  .badge-primary {
    background: var(--primary-light);
    color: var(--primary);
  }
  
  .badge-success {
    background: #d1fae5;
    color: var(--success);
  }
  
  .badge-warning {
    background: #fef3c7;
    color: var(--warning);
  }
  
  .badge-danger {
    background: #fee2e2;
    color: var(--danger);
  }
  
  /* Grid Layout */
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
  }
  
  @media (min-width: 992px) {
    .grid-2 {
      grid-template-columns: 1fr 1fr;
    }
  }
  
  /* Utilities */
  .text-muted {
    color: var(--secondary);
    font-size: 12px;   /* m√°s peque√±o */
  }
  
  .text-center {
    text-align: center;
  }
  
  .hidden {
    display: none;
  }
  
  .loading {
    opacity: 0.7;
    pointer-events: none;
  }
  
  .mt-2 { margin-top: 16px; }
  .mb-2 { margin-bottom: 16px; }
  
  /* Animation */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .fade-in {
    animation: fadeIn 0.3s ease;
  }
  
  /* Tabs */
  .tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    margin-bottom: 16px;
  }
  
  .tab {
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
    font-size: 12px;   /* m√°s peque√±o */
  }
  
  .tab.active {
    border-bottom-color: var(--primary);
    color: var(--primary);
    font-weight: 600;
  }
  
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  
  /* Instructions */
  .instructions {
    background: #f0f9ff;
    border-left: 4px solid var(--primary);
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  .instructions h3 { margin-bottom: 10px; color: var(--primary); }
  .instructions ul { padding-left: 20px; }
  .instructions li { margin-bottom: 8px; }
  
  /* Matrix table */
  .matrix-container {
    overflow: auto;
    max-height: 600px;
    margin: 20px 0;
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }
  
  .matrix-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 2200px;
    font-size: 11px;   /* m√°s peque√±o */
  }
  
  .matrix-table th {
    background: #e0f2fe;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .matrix-table th:nth-child(1),
  .matrix-table th:nth-child(2) { background: #bae6fd; }
  .matrix-table th:nth-child(-n+5) { background: #7dd3fc; }
  .matrix-table th:nth-child(-n+10) { background: #38bdf8; }
  .matrix-table th:nth-child(-n+15) { background: #0ea5e9; }
  
  .section-header {
    background: #f8fafc;
    font-weight: 600;
    color: var(--primary);
  }
</style>
</head>
<body>
<div class="app-container">
  <header class="app-header">
    <h1 class="app-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="13" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      Sistema de Planificaci√≥n Acad√©mica
    </h1>
    <p class="app-subtitle">Asignaci√≥n automatizada de estudiantes a materias y docentes</p>
  </header>

  <div class="instructions">
    <h3>Instrucciones de uso:</h3>
    <ul>
      <li>Cargue los archivos Excel con los formatos especificados</li>
      <li>El sistema asignar√° las materias seg√∫n el <strong>ciclo y carrera</strong> de cada estudiante</li>
      <li>Docentes: solo sus materias; se respetan d√≠as y horas disponibles</li>
      <li>M√°ximo de materias por estudiante: 6; m√°ximo 2 por d√≠a</li>
      <li>M√°ximo de estudiantes por paralelo: 25</li>
      <li>Horarios disponibles: 7:00-10:00, 10:00-13:00, 13:00-16:00, 16:00-19:00, 19:00-22:00</li>
    </ul>
  </div>

  <div class="card">
    <div class="alert alert-info">
      <span class="alert-icon">üí°</span>
      <div>
        <strong>Nota:</strong> El sistema organizar√° autom√°ticamente los horarios evitando cruces entre materias del mismo ciclo. Se generan los paralelos necesarios para no dejar estudiantes sin asignaci√≥n.
      </div>
    </div>

    <div class="alert alert-error hidden" id="errorBox">
      <span class="alert-icon">‚ö†Ô∏è</span>
      <div>
        <strong>Error:</strong> <span id="errorMessage"></span>
      </div>
    </div>

    <div class="config-panel">
      <h3 class="card-title">Configuraci√≥n del Sistema</h3>
      <div class="config-grid">
        <div class="config-item">
          <label class="config-label">Bloques de Horario Disponibles</label>
          <div class="time-slots">
            <span class="time-slot">07:00-10:00</span>
            <span class="time-slot">10:00-13:00</span>
            <span class="time-slot">13:00-16:00</span>
            <span class="time-slot">16:00-19:00</span>
            <span class="time-slot">19:00-22:00</span>
          </div>
        </div>
        
        <div class="config-item">
          <label class="config-label" for="maxMaterias">M√°ximo de materias por estudiante</label>
          <input type="number" id="maxMaterias" class="config-input" value="6" min="1" max="10">
        </div>
        
        <div class="config-item">
          <label class="config-label" for="capacidadParalelo">Capacidad m√°xima por paralelo</label>
          <input type="number" id="capacidadParalelo" class="config-input" value="25" min="10" max="25">
        </div>
      </div>
    </div>

    <div class="file-section">
      <div class="file-input-container">
        <label class="file-label">DOCENTES.xlsx</label>
        <input id="fileDoc" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status" id="statusDoc">
          <span class="status-icon status-pending"></span>
          <span>Esperando archivo...</span>
        </div>
      </div>
      
      <div class="file-input-container">
        <label class="file-label">ESTUDIANTES.xlsx</label>
        <input id="fileEst" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status" id="statusEst">
          <span class="status-icon status-pending"></span>
          <span>Esperando archivo...</span>
        </div>
      </div>
      
      <div class="file-input-container">
        <label class="file-label">MALLA.xlsx</label>
        <input id="fileMal" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status" id="statusMal">
          <span class="status-icon status-pending"></span>
          <span>Esperando archivo...</span>
        </div>
      </div>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="btn-group">
      <button id="btnRun" class="btn btn-primary" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Procesar Asignaci√≥n
      </button>
      <button id="btnDown" class="btn btn-secondary hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Descargar Planificaci√≥n
      </button>
    </div>

    <div class="stats-grid" id="statsContainer" style="display: none;">
      <div class="stat-card">
        <div class="stat-value" id="statSecciones">0</div>
        <div class="stat-label">Secciones creadas</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statAsignaciones">0</div>
        <div class="stat-label">Asignaciones realizadas</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statNoAsignados">0</div>
        <div class="stat-label">Estudiantes no asignados</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statOcupacion">0%</div>
        <div class="stat-label">Ocupaci√≥n promedio</div>
      </div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="asignaciones">Asignaciones</div>
    <div class="tab" data-tab="carga-docente">Carga Docente</div>
    <div class="tab" data-tab="resumen-materia">Resumen por Materia</div>
    <div class="tab" data-tab="no-asignados">No Asignados</div>
    <div class="tab" data-tab="matriz-completa">Matriz Completa</div>
  </div>

  <div class="tab-content active" id="asignaciones">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Asignaciones Realizadas</h3>
        <span class="badge badge-primary" id="asignacionesCount">0</span>
      </div>
      <div class="table-container">
        <div id="tblCombo"></div>
      </div>
    </div>
  </div>
  
  <div class="tab-content" id="carga-docente">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Carga por Docente</h3>
        <span class="badge badge-primary" id="docentesCount">0</span>
      </div>
      <div class="table-container">
        <div id="tblCarga"></div>
      </div>
    </div>
  </div>
  
  <div class="tab-content" id="resumen-materia">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Resumen por Materia</h3>
        <span class="badge badge-primary" id="materiasCount">0</span>
      </div>
      <div class="table-container">
        <div id="tblResumenMateria"></div>
      </div>
    </div>
  </div>
  
  <div class="tab-content" id="no-asignados">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">No Asignados</h3>
        <span class="badge badge-danger" id="noAsignadosCount">0</span>
      </div>
      <div class="table-container">
        <div id="tblNo"></div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="matriz-completa">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Matriz Completa de Asignaci√≥n</h3>
        <span class="badge badge-primary" id="matrizCount">0</span>
      </div>
      <div class="matrix-container">
        <table class="matrix-table" id="tblMatriz">
          <thead>
            <tr>
              <th>DOCENTE</th>
              <th>DEDICACI√ìN</th>
              <th>MATERIA</th>
              <th>C√ìDIGO ANTHOLOGY</th>
              <th>CARRERAS QUE COMPARTEN</th>
              <th>PRE-REQUISITO</th>
              <th>CODIGO</th>
              <th>HORAS TE√ìRICAS</th>
              <th>HORAS PR√ÅCTICAS</th>
              <th>HORAS AUT√ìNOMAS</th>
              <th>CREDITOS</th>
              <th>CAMPO DE FORMACI√ìN</th>
              <th>CICLO</th>
              <th>MALLA</th>
              <th>N¬∫ ORDEN EN LA MALLA</th>
              <th>PARALELO</th>
              <th>DIA</th>
              <th>HORA</th>
              <th>Modalidad</th>
              <th>Nro. HORAS</th>
              <th>NOMBRE DEL ESTUDIANTE</th>
              <th>CARRERA DEL ESTUDIANTE</th>
              <th>CICLO DEL ESTUDIANTE</th>
              <th>NIVEL INGLES</th>
              <th>OBSERVACIONES</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="25" style="text-align: center; padding: 20px; color: var(--secondary);">
                Cargue los archivos y procese la asignaci√≥n para ver la matriz completa
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// ===================== Constantes y Utilidades =====================
let __DOCENTE_SLOTS__ = new Map(); // Map<Docente, Map<DIA, Set<HORA>>>
const TARGET7 = ["NOMBRE_DOCENTE","MATERIA","CANTIDAD DE ALUMNOS ESPERADOS","DIA","HORA","Modalidad","Paralelo"];
const COMBO9  = [...TARGET7,"ESTUDIANTE","CICLO"];
const DAY_MAP = new Map(Object.entries({
  "lun":"LUNES","lunes":"LUNES","lun.":"LUNES",
  "mar":"MARTES","martes":"MARTES","mar.":"MARTES",
  "mie":"MIERCOLES","mi√©":"MIERCOLES","miercoles":"MIERCOLES","mi√©rcoles":"MIERCOLES","mie.":"MIERCOLES","mi√©.":"MIERCOLES",
  "jue":"JUEVES","jueves":"JUEVES","jue.":"JUEVES",
  "vie":"VIERNES","viernes":"VIERNES","vie.":"VIERNES",
  "sab":"SABADO","s√°b":"SABADO","sabado":"SABADO","s√°bado":"SABADO","sab.":"SABADO",
  "dom":"DOMINGO","domingo":"DOMINGO","dom.":"DOMINGO"
}));

// Horarios predefinidos en bloques de 3 horas
const HORARIOS = [
  "07:00-10:00", "10:00-13:00", "13:00-16:00", 
  "16:00-19:00", "19:00-22:00"
];

const __norm = s => String(s ?? "").toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
const __splitList = s => String(s ?? "").split(/[,;/]| Y | E /i).map(x=>x.trim()).filter(Boolean);

// Funci√≥n para convertir horarios a bloques de 3 horas
function normalizarHorario(horario) {
  if (!horario) return HORARIOS[0]; // Valor por defecto
  const horarioStr = String(horario).toUpperCase().trim();
  if (HORARIOS.includes(horarioStr)) return horarioStr;
  const blocks = horarioStr.match(/\d{1,2}:\d{2}\s*[-‚Äìa]+\s*\d{1,2}:\d{2}/g);
  if (blocks?.length) return HORARIOS.find(b=>b.startsWith(blocks[0].slice(0,2))) || HORARIOS[0];
  return HORARIOS[0];
}

// Utilidades
const canonDay = s => {
  if (!s) return "";
  const t = String(s).toLowerCase().trim();
  if (DAY_MAP.has(t)) return DAY_MAP.get(t);
  for (const [k, v] of DAY_MAP.entries()) { if (t.includes(k)) return v; }
  return t.toUpperCase();
};

const esc = s => {
  if (s === null || s === undefined || s === "") return "0";
  return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
};

function showError(message) {
  const errorBox = document.getElementById('errorBox');
  const errorMessage = document.getElementById('errorMessage');
  errorMessage.textContent = message;
  errorBox.classList.remove('hidden');
  setTimeout(() => { errorBox.classList.add('hidden'); }, 8000);
}
function showSuccess(message) {
  const alertBox = document.createElement('div');
  alertBox.className = 'alert alert-success fade-in';
  alertBox.innerHTML = `<span class="alert-icon">‚úÖ</span><div>${message}</div>`;
  document.querySelector('.card').prepend(alertBox);
  setTimeout(() => { alertBox.remove(); }, 5000);
}
function updateProgress(percent) {
  const progressBar = document.getElementById('progressBar');
  const progressContainer = document.getElementById('progressContainer');
  progressBar.style.width = percent + '%';
  progressContainer.style.display = 'block';
}
function updateStats(secciones, asignaciones, noAsig, resumenMateria) {
  document.getElementById('statsContainer').style.display = 'grid';
  document.getElementById('statSecciones').textContent = secciones.length;
  document.getElementById('statAsignaciones').textContent = asignaciones.length;
  document.getElementById('statNoAsignados').textContent = noAsig.length;
  document.getElementById('asignacionesCount').textContent = asignaciones.length;
  document.getElementById('docentesCount').textContent = new Set(asignaciones.map(a => a.NOMBRE_DOCENTE)).size;
  document.getElementById('materiasCount').textContent = new Set(asignaciones.map(a => a.MATERIA)).size;
  document.getElementById('noAsignadosCount').textContent = noAsig.length;
  document.getElementById('matrizCount').textContent = asignaciones.length;
  let totalCap = 0, totalAsig = 0;
  resumenMateria.forEach(m => { totalCap += (m.CAP||0); totalAsig += (m.ASIGNADOS||0); });
  const ocupacionPromedio = totalCap > 0 ? Math.round((totalAsig / totalCap) * 100) : 0;
  document.getElementById('statOcupacion').textContent = ocupacionPromedio + '%';
}
function validateFiles() {
  const fD = document.getElementById('fileDoc').files[0];
  const fE = document.getElementById('fileEst').files[0];
  const fM = document.getElementById('fileMal').files[0];
  const btnRun = document.getElementById('btnRun');
  btnRun.disabled = !(fD && fE && fM);
}
function updateFileStatus(inputId, statusId) {
  const input = document.getElementById(inputId);
  const status = document.getElementById(statusId);
  const icon = status.querySelector('.status-icon');
  input.addEventListener('change', function() {
    if (this.files.length > 0) {
      icon.className = 'status-icon status-success';
      status.querySelector('span:last-child').textContent = this.files[0].name;
    } else {
      icon.className = 'status-icon status-pending';
      status.querySelector('span:last-child').textContent = 'Esperando archivo...';
    }
    validateFiles();
  });
}

// Renderizado
function renderTable(el, headers, rows, maxRows = 100) {
  if (!rows || !rows.length) {
    el.innerHTML = '<p class="text-muted text-center">No hay datos para mostrar.</p>';
    return;
  }
  const displayRows = rows.slice(0, maxRows);
  const hasMore = rows.length > maxRows;
  let html = `<table><thead><tr>${headers.map(h => `<th>${esc(h)}</th>`).join('')}</tr></thead><tbody>`;
  for (const r of displayRows) {
    html += `<tr>${headers.map(h => `<td>${esc(r[h] ?? 0)}</td>`).join('')}</tr>`;
  }
  html += `</tbody></table>`;
  if (hasMore) html += `<p class="text-muted text-center">Mostrando ${maxRows} de ${rows.length} registros. Descargue el archivo para ver todos.</p>`;
  el.innerHTML = html;
}
function renderMatrizTable(asignaciones) {
  const el = document.getElementById('tblMatriz');
  const tbody = el.querySelector('tbody');
  if (!asignaciones || !asignaciones.length) {
    tbody.innerHTML = `<tr><td colspan="25" style="text-align: center; padding: 20px; color: var(--secondary);">No hay datos para mostrar</td></tr>`;
    return;
  }
  let html = '';
  for (const r of asignaciones) {
    html += `
      <tr>
        <td>${esc(r.NOMBRE_DOCENTE)}</td>
        <td>${esc(r.DEDICACI√ìN)}</td>
        <td>${esc(r.MATERIA)}</td>
        <td>${esc(r['C√ìDIGO ANTHOLOGY'])}</td>
        <td>${esc(r['CARRERAS QUE COMPARTEN'])}</td>
        <td>${esc(r['PRE-REQUISITO'])}</td>
        <td>${esc(r.CODIGO)}</td>
        <td>${esc(r['HORAS TE√ìRICAS'])}</td>
        <td>${esc(r['HORAS PR√ÅCTICAS'])}</td>
        <td>${esc(r['HORAS AUT√ìNOMAS'])}</td>
        <td>${esc(r.CREDITOS)}</td>
        <td>${esc(r['CAMPO DE FORMACI√ìN'])}</td>
        <td>${esc(r.CICLO)}</td>
        <td>${esc(r.MALLA)}</td>
        <td>${esc(r['N¬∫ ORDEN EN LA MALLA'])}</td>
        <td>${esc(r.Paralelo)}</td>
        <td>${esc(r.DIA)}</td>
        <td>${esc(r.HORA)}</td>
        <td>${esc(r.Modalidad)}</td>
        <td>${esc(r['Nro. HORAS'])}</td>
        <td>${esc(r.ESTUDIANTE)}</td>
        <td>${esc(r['CARRERA DEL ESTUDIANTE'])}</td>
        <td>${esc(r['CICLO DEL ESTUDIANTE'])}</td>
        <td>${esc(r['NIVEL INGLES'])}</td>
        <td>${esc(r.OBSERVACIONES)}</td>
      </tr>
    `;
  }
  tbody.innerHTML = html;
}

// Leer archivo Excel
const readSheet = (file, fileName) => new Promise((resolve, reject) => {
  if (!file) { resolve([]); return; }
  const fr = new FileReader();
  fr.onload = e => {
    try {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      if (!ws || !ws['!ref']) return reject(new Error(`La hoja del archivo ${fileName} est√° vac√≠a.`));
      const jsonData = XLSX.utils.sheet_to_json(ws, { defval: "" });
      resolve(jsonData);
    } catch (error) { reject(new Error(`Error al leer el archivo ${fileName}: ${error.message}`)); }
  };
  fr.onerror = () => reject(new Error(`Error al leer el archivo ${fileName}.`));
  fr.readAsArrayBuffer(file);
});

// ===================== Normalizaci√≥n =====================
function normalizeDocentes(rows) {
  if (!rows || !rows.length) { showError("El archivo de docentes est√° vac√≠o o no tiene el formato correcto."); return []; }
  return rows.map(r => {
    // D√≠as
    const diasDisponibles = (() => {
      const texto = String(r["DIA DISPONIBLE"] || r["DIA"] || "").toUpperCase();
      const set = new Set();
      if (texto.includes("LUNES A VIERNES")) ["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES"].forEach(d=>set.add(d));
      for (const [k,v] of DAY_MAP.entries()) { if (texto.toLowerCase().includes(k)) set.add(v); }
      if (!set.size) ["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES"].forEach(d=>set.add(d));
      return Array.from(set);
    })();
    // Horas (todas las franjas que haya en la celda)
    const horasDisponibles = (() => {
      const texto = String(r["HORA DISPONIBLE"] || r["HORA"] || "").toUpperCase();
      const matches = texto.match(/\d{1,2}:\d{2}\s*[-‚Äìa]+\s*\d{1,2}:\d{2}/g) || [];
      const bloques = matches.map(normalizarHorario);
      return (bloques.length ? Array.from(new Set(bloques)) : [...HORARIOS]);
    })();

    return {
      "NOMBRE_DOCENTE": r["NOMBRE_DOCENTE"] || r["DOCENTE"] || "",
      "MATERIA": r["MATERIA"] || r["MATERIAS"] || "",
      "CANTIDAD DE ALUMNOS ESPERADOS": Number(r["CANTIDAD DE ALUMNOS ESPERADOS"] || r["CAPACIDAD"] || r["CUPOS"] || 25) || 25,
      "DIA_DISPONIBLE": diasDisponibles,
      "HORA_DISPONIBLE": horasDisponibles,
      "Modalidad": r["Modalidad"] || "PRESENCIAL",
      "Paralelo": String(r["Paralelo"] || "").toUpperCase().trim() || "A",
      "DEDICACI√ìN": r["DEDICACI√ìN"] || ""
    };
  }).filter(x => x.MATERIA && x.NOMBRE_DOCENTE);
}

function normalizeEstudiantes(rows) {
  if (!rows || !rows.length) { showError("El archivo de estudiantes est√° vac√≠o o no tiene el formato correcto."); return []; }
  return rows.map(r => {
    const ciclo = Number(r["CICLO AL QUE VA"] || r["CICLO ACTUAL"] || r["CICLO"] || 1);
    return {
      "ESTUDIANTE": r["ESTUDIANTE"] || r["NOMBRE"] || r["NOMBRE DEL ESTUDIANTE"] || "",
      "CICLO": isNaN(ciclo) ? 1 : Math.max(1, Math.min(12, ciclo)),
      "CARRERA": r["CARRERA"] || r["CARRERA DEL ESTUDIANTE"] || "",
      "MALLA": String(r["MALLA"] || r["A√ëO"] || "").trim(),
      "NIVEL INGLES": r["NIVEL INGLES"] || "0"
    };
  }).filter(x => x.ESTUDIANTE);
}

function normalizeMallas(rows) {
  if (!rows || !rows.length) { showError("El archivo de mallas est√° vac√≠o o no tiene el formato correcto."); return []; }
  const WORD2NUM={"PRIMERO":1,"SEGUNDO":2,"TERCERO":3,"CUARTO":4,"QUINTO":5,"SEXTO":6,"SEPTIMO":7,"S√âPTIMO":7,"OCTAVO":8,"NOVENO":9,"DECIMO":10,"D√âCIMO":10,"ONCE":11,"DOCE":12};
  const toCycle=v=>{
    if(v===undefined||v===null||v==="") return NaN;
    const t=String(v).toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
    if(/^\d+$/.test(t)) return Number(t);
    return WORD2NUM[t]||NaN;
  };
  return rows.map(r => {
    let ciclo = toCycle(r["CICLO"]); if (isNaN(ciclo)) ciclo = Number(r["CICLO"] || 1);
    return {
      "CARRERA": r["CARRERA"] || "",
      "MATERIA": r["MATERIA"] || r["MATERIAS"] || "",
      "CODIGO": String(r["C√ìDIGO"] || r["CODIGO"] || r["C√ìDIGO ANTHOLOGY"] || "").trim(),
      "CICLO": Math.max(1, Math.min(12, Number(ciclo)||1)),
      "HORAS TE√ìRICAS": Number(r["HORAS TE√ìRICAS"] || r["HORAS_TEORICAS"] || 0) || 0,
      "HORAS PR√ÅCTICAS": Number(r["HORAS PR√ÅCTICAS"] || r["HORAS_PRACTICAS"] || 0) || 0,
      "HORAS AUT√ìNOMAS": Number(r["HORAS AUT√ìNOMAS"] || 0) || 0,
      "CREDITOS": Number(r["CREDITOS"] || 0) || 0,
      "CAMPO DE FORMACI√ìN": r["CAMPO DE FORMACI√ìN"] || "",
      "MALLA": String(r["MALLA"] || r["A√ëO"] || "").trim(),
      "N¬∫ ORDEN EN LA MALLA": r["N¬∫ ORDEN EN LA MALLA"] || 0,
      "PRE-REQUISITO": r["PRE-REQUISITO"] || "",
      "CARRERAS QUE COMPARTEN": r["CARRERAS QUE COMPARTEN"] || ""
    };
  }).filter(x => x.MATERIA && x.MALLA);
}

// ===================== L√≥gica de secciones y asignaci√≥n =====================
// Agrega c√≥digos y carreras combinando (/) por CICLO+MATERIA y mezcla de carreras.
function construirSecciones(docentes, mallas, estudiantes) {
  __DOCENTE_SLOTS__ = new Map(); // reset por corrida
  const capacidadPorParalelo = parseInt(document.getElementById('capacidadParalelo').value) || 25;

  // √çndice de docentes por materia exacta
  const docentesPorMateria = new Map();
  for (const d of docentes) {
    const key = __norm(d.MATERIA);
    if (!docentesPorMateria.has(key)) docentesPorMateria.set(key, []);
    docentesPorMateria.get(key).push(d);
  }

  // Materias requeridas por estudiante (seg√∫n malla y carrera)
  const materiasPorEstudiante = new Map();
  for (const e of estudiantes) {
    const set = new Set();
    for (const m of mallas) {
      if (String(m.MALLA)===String(e.MALLA) && Number(m.CICLO)===Number(e.CICLO)) {
        // Carreras que comparten: si est√° vac√≠a, se asume que la materia es de la carrera indicada
        const comp = (__splitList(m["CARRERAS QUE COMPARTEN"]).map(__norm));
        const valido = comp.length ? comp.includes(__norm(e.CARRERA)) : __norm(m.CARRERA)===__norm(e.CARRERA);
        if (valido) set.add(m.MATERIA);
      }
    }
    materiasPorEstudiante.set(e.ESTUDIANTE, Array.from(set));
  }

  // Demanda por (ciclo, materia): cu√°ntos estudiantes la requieren
  const demanda = new Map();
  for (const e of estudiantes) {
    const mats = materiasPorEstudiante.get(e.ESTUDIANTE) || [];
    for (const mat of mats) {
      const k = `${e.CICLO}¬¶${mat}`;
      if (!demanda.has(k)) demanda.set(k, new Set());
      demanda.get(k).add(e.ESTUDIANTE);
    }
  }

  // Informaci√≥n combinada por (ciclo, materia)
  const meta = new Map();
  for (const m of mallas) {
    const k = `${m.CICLO}¬¶${m.MATERIA}`;
    if (!meta.has(k)) {
      meta.set(k, {
        MATERIA: m.MATERIA,
        CICLO: m.CICLO,
        CODIGOS: new Set(),
        CARRERAS: new Set(),
        MALLAS: new Set(),
        "HORAS TE√ìRICAS": 0,
        "HORAS PR√ÅCTICAS": 0,
        "HORAS AUT√ìNOMAS": 0,
        CREDITOS: 0,
        "CAMPO DE FORMACI√ìN": m["CAMPO DE FORMACI√ìN"] || "",
        "N¬∫ ORDEN EN LA MALLA": m["N¬∫ ORDEN EN LA MALLA"] || 0,
        "PRE-REQUISITO": m["PRE-REQUISITO"] || ""
      });
    }
    const o = meta.get(k);
    if (m.CODIGO) o.CODIGOS.add(String(m.CODIGO));
    o.CARRERAS.add(__norm(m.CARRERA));
    __splitList(m["CARRERAS QUE COMPARTEN"]).forEach(c=>o.CARRERAS.add(__norm(c)));
    if (m.MALLA) o.MALLAS.add(String(m.MALLA));
    o["HORAS TE√ìRICAS"] = Math.max(o["HORAS TE√ìRICAS"], Number(m["HORAS TE√ìRICAS"]||0));
    o["HORAS PR√ÅCTICAS"] = Math.max(o["HORAS PR√ÅCTICAS"], Number(m["HORAS PR√ÅCTICAS"]||0));
    o["HORAS AUT√ìNOMAS"] = Math.max(o["HORAS AUT√ìNOMAS"], Number(m["HORAS AUT√ìNOMAS"]||0));
    o.CREDITOS = Math.max(o.CREDITOS, Number(m.CREDITOS||0));
  }

  // Control m√°x 2 materias por d√≠a por docente + evitar choques d√≠a+hora por docente
  const docDayCount = new Map(); // Map<docente, Map<dia,count>>
  const getDocDayCnt = (doc,dia)=> (docDayCount.get(doc)?.get(dia))||0;
  const incDocDayCnt = (doc,dia)=>{ const m=docDayCount.get(doc)||new Map(); m.set(dia,(m.get(dia)||0)+1); docDayCount.set(doc,m); };

  const secciones = [];
  for (const [k, estSet] of demanda.entries()) {
    const [ciclo, materia] = k.split('¬¶');
    const need = estSet.size;
    const numParalelos = Math.max(1, Math.ceil(need / capacidadPorParalelo));

    const dList = (docentesPorMateria.get(__norm(materia)) || []).slice();
    if (!dList.length) { console.warn(`Sin docentes para ${materia}`); continue; }

    const info = meta.get(k);
    const codStr = Array.from(info?.CODIGOS||[]).filter(Boolean).join('/') || "0";
    const carStr = Array.from(info?.CARRERAS||[]).filter(Boolean).join('/') || "0";
    const mallaStr = Array.from(info?.MALLAS||[]).filter(Boolean).join('/') || "0";

    for (let i=0;i<numParalelos;i++) {
      // Elegir horario v√°lido con m√°x 2 clases por d√≠a para el docente
      let elegido=null, diaSel=null, horaSel=null;

      // Ordene docentes por menor uso de slots (balanceo simple)
      dList.sort((a,b)=>{
        const sa = (__DOCENTE_SLOTS__.get(a.NOMBRE_DOCENTE)?.size)||0;
        const sb = (__DOCENTE_SLOTS__.get(b.NOMBRE_DOCENTE)?.size)||0;
        return sa-sb;
      });

      for (const d of dList) {
        const slotsDoc = __DOCENTE_SLOTS__.get(d.NOMBRE_DOCENTE) || new Map();
        for (const dia of d.DIA_DISPONIBLE) {
          if (getDocDayCnt(d.NOMBRE_DOCENTE, dia) >= 2) continue; // m√°x 2 por d√≠a
          const usadosDia = slotsDoc.get(dia) || new Set();
          for (const hora of d.HORA_DISPONIBLE) {
            if (usadosDia.has(hora)) continue; // no choque docente
            elegido = d; diaSel = dia; horaSel = hora;
            usadosDia.add(hora); slotsDoc.set(dia, usadosDia); __DOCENTE_SLOTS__.set(d.NOMBRE_DOCENTE, slotsDoc);
            incDocDayCnt(d.NOMBRE_DOCENTE, dia);
            break;
          }
          if (elegido) break;
        }
        if (elegido) break;
      }
      if (!elegido) { console.warn(`Sin slot disponible para ${materia} - Ciclo ${ciclo}`); continue; }

      secciones.push({
        MATERIA: materia,
        CODIGO: codStr,                 // agregado como combinaci√≥n
        "C√ìDIGO ANTHOLOGY": codStr,     // mismo string combinado
        CICLO: Number(ciclo),
        NOMBRE_DOCENTE: elegido.NOMBRE_DOCENTE,
        CAP: capacidadPorParalelo,
        ASIGNADOS: 0,
        DIA: diaSel,
        HORA: horaSel,
        Modalidad: elegido.Modalidad || "PRESENCIAL",
        Paralelo: String.fromCharCode(65 + i), // A,B,C,...
        DEDICACI√ìN: elegido.DEDICACI√ìN || "",
        "HORAS TE√ìRICAS": Number(info?.["HORAS TE√ìRICAS"]||0),
        "HORAS PR√ÅCTICAS": Number(info?.["HORAS PR√ÅCTICAS"]||0),
        "HORAS AUT√ìNOMAS": Number(info?.["HORAS AUT√ìNOMAS"]||0),
        CREDITOS: Number(info?.CREDITOS||0),
        "CAMPO DE FORMACI√ìN": info?.["CAMPO DE FORMACI√ìN"] || "0",
        MALLA: mallaStr,
        "N¬∫ ORDEN EN LA MALLA": Number(info?.["N¬∫ ORDEN EN LA MALLA"]||0),
        "PRE-REQUISITO": info?.["PRE-REQUISITO"] || "0",
        "CARRERAS QUE COMPARTEN": carStr
      });
    }
  }
  return secciones;
}

// Asignaci√≥n garantizando: sin choques, m√°x 2 por d√≠a, sin repetir misma materia
function asignarEstudiantes(secciones, estudiantes, mallas) {
  const idxPorMateria = new Map(); // (CICLO¬¶MATERIA) -> secciones[]
  for (const s of secciones) {
    const k = `${s.CICLO}¬¶${s.MATERIA}`;
    if (!idxPorMateria.has(k)) idxPorMateria.set(k, []);
    idxPorMateria.get(k).push(s);
  }

  // Materias requeridas por estudiante
  const materiasPorEst = new Map();
  for (const e of estudiantes) {
    const set = new Set();
    for (const m of mallas) {
      if (String(m.MALLA)===String(e.MALLA) && Number(m.CICLO)===Number(e.CICLO)) {
        const comp = __splitList(m["CARRERAS QUE COMPARTEN"]).map(__norm);
        const valido = comp.length ? comp.includes(__norm(e.CARRERA)) : __norm(m.CARRERA)===__norm(e.CARRERA);
        if (valido) set.add(m.MATERIA);
      }
    }
    materiasPorEst.set(e.ESTUDIANTE, Array.from(set));
  }

  const asignaciones = [];
  const noAsig = [];
  const maxMaterias = parseInt(document.getElementById('maxMaterias').value) || 6;

  // Control estudiante: 2 por d√≠a y no repetir mismo d√≠a+hora
  const estDayCount = new Map(); // Map<est, Map<dia,count>>
  const estSlots = new Map();    // Map<est, Set('DIA¬¶HORA')>
  const canPlace = (est,dia,hora)=>{
    const cnt = estDayCount.get(est)?.get(dia) || 0;
    const slots = estSlots.get(est) || new Set();
    return cnt < 2 && !slots.has(`${dia}¬¶${hora}`);
  };
  const markPlace = (est,dia,hora)=>{
    const m = estDayCount.get(est) || new Map(); m.set(dia,(m.get(dia)||0)+1); estDayCount.set(est,m);
    const s = estSlots.get(est) || new Set(); s.add(`${dia}¬¶${hora}`); estSlots.set(est,s);
  };

  for (const e of estudiantes) {
    const materias = materiasPorEst.get(e.ESTUDIANTE) || [];
    let count = 0;
    const yaAsignadas = new Set();
    for (const mat of materias) {
      if (count >= maxMaterias) break;
      if (yaAsignadas.has(mat)) continue; // no repetir misma materia
      const k = `${e.CICLO}¬¶${mat}`;
      const bucket = (idxPorMateria.get(k) || []).slice().sort((a,b)=>{
        const fa=(a.CAP||0)-(a.ASIGNADOS||0), fb=(b.CAP||0)-(b.ASIGNADOS||0);
        return fb-fa; // m√°s cupo primero
      });
      let placed = false;
      for (const s of bucket) {
        const free = (s.CAP||0) - (s.ASIGNADOS||0);
        if (free <= 0) continue;
        if (!canPlace(e.ESTUDIANTE, s.DIA, s.HORA)) continue;

        s.ASIGNADOS = (s.ASIGNADOS||0) + 1;
        count++; yaAsignadas.add(mat); placed = true; markPlace(e.ESTUDIANTE, s.DIA, s.HORA);

        asignaciones.push({
          ESTUDIANTE: e.ESTUDIANTE,
          "CARRERA DEL ESTUDIANTE": e.CARRERA || "",
          "CICLO DEL ESTUDIANTE": Number(e.CICLO)||0,
          "NIVEL INGLES": e["NIVEL INGLES"] || "0",
          NOMBRE_DOCENTE: s.NOMBRE_DOCENTE || "",
          DEDICACI√ìN: s.DEDICACI√ìN || "0",
          MATERIA: s.MATERIA,
          "CANTIDAD DE ALUMNOS ESPERADOS": s.CAP || 0,
          DIA: s.DIA, HORA: s.HORA, Modalidad: s.Modalidad || "0", Paralelo: s.Paralelo || "0",
          "C√ìDIGO ANTHOLOGY": s.CODIGO || "0",
          "CARRERAS QUE COMPARTEN": s["CARRERAS QUE COMPARTEN"] || "0",
          "PRE-REQUISITO": s["PRE-REQUISITO"] || "0",
          CODIGO: s.CODIGO || "0",
          "HORAS TE√ìRICAS": Number(s["HORAS TE√ìRICAS"]||0),
          "HORAS PR√ÅCTICAS": Number(s["HORAS PR√ÅCTICAS"]||0),
          "HORAS AUT√ìNOMAS": Number(s["HORAS AUT√ìNOMAS"]||0),
          CREDITOS: Number(s.CREDITOS||0),
          "CAMPO DE FORMACI√ìN": s["CAMPO DE FORMACI√ìN"] || "0",
          MALLA: s.MALLA || "0",
          "N¬∫ ORDEN EN LA MALLA": Number(s["N¬∫ ORDEN EN LA MALLA"]||0),
          "Nro. HORAS": Number(s["HORAS TE√ìRICAS"]||0) + Number(s["HORAS PR√ÅCTICAS"]||0),
          CICLO: Number(s.CICLO)||0,
          OBSERVACIONES: "0"
        });
        break;
      }
      if (!placed) {
        noAsig.push({ 
          ESTUDIANTE: e.ESTUDIANTE, 
          MATERIA: mat, 
          MOTIVO: "Sin cupo/horario compatible", 
          CICLO: Number(e.CICLO)||0,
          "CARRERA DEL ESTUDIANTE": e.CARRERA||""
        });
      }
    }
  }

  // Res√∫menes
  const cargaDocente = Array.from(secciones).map(s=>({
    DOCENTE: s.NOMBRE_DOCENTE||"",
    MATERIA: s.MATERIA, Paralelo: s.Paralelo||"A", DIA: s.DIA, HORA: s.HORA,
    ASIGNADOS: Number(s.ASIGNADOS||0), CAP: Number(s.CAP||0)
  })).sort((a,b)=>a.DOCENTE.localeCompare(b.DOCENTE)||a.MATERIA.localeCompare(b.MATERIA)||String(a.Paralelo).localeCompare(String(b.Paralelo)));

  const resumenMateria = (() => {
    const map = new Map();
    for (const s of secciones) {
      const k = `${s.MATERIA}¬¶${s.Paralelo||''}`;
      if (!map.has(k)) map.set(k, { MATERIA: s.MATERIA, Paralelo: s.Paralelo||"", ASIGNADOS: 0, CAP: 0, OCUPACION: "0%" });
      const o = map.get(k); o.CAP += (s.CAP||0); o.ASIGNADOS += (s.ASIGNADOS||0);
    }
    return Array.from(map.values()).map(r=>{
      const cap=r.CAP||0, asg=r.ASIGNADOS||0;
      return {...r, OCUPACION: cap?Math.round((asg/cap)*100)+"%":"0%"};
    }).sort((a,b)=>a.MATERIA.localeCompare(b.MATERIA)||String(a.Paralelo).localeCompare(String(b.Paralelo)));
  })();

  return { asignaciones, noAsig, cargaDocente, resumenMateria, secciones };
}

// ===================== Interfaz =====================
let OUT_SECC = [], OUT_COMB = [], OUT_CARGA = [], OUT_RES_MAT = [], OUT_NO = [];

document.addEventListener('DOMContentLoaded', function() {
  updateFileStatus('fileDoc', 'statusDoc');
  updateFileStatus('fileEst', 'statusEst');
  updateFileStatus('fileMal', 'statusMal');
  
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const tabId = tab.getAttribute('data-tab');
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(tc => tc.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tabId).classList.add('active');
    });
  });
  
  document.getElementById('btnRun').addEventListener('click', async () => {
    const fD = document.getElementById('fileDoc').files[0];
    const fE = document.getElementById('fileEst').files[0];
    const fM = document.getElementById('fileMal').files[0];
    if (!fD || !fE || !fM) { showError('Debe cargar los archivos de DOCENTES, ESTUDIANTES y MALLA.'); return; }
    document.body.classList.add('loading');
    updateProgress(10);
    try {
      const [rowsD, rowsE, rowsM] = await Promise.all([
        readSheet(fD, "DOCENTES"),
        readSheet(fE, "ESTUDIANTES"),
        readSheet(fM, "MALLA")
      ]);
      updateProgress(40);
      const DOC = normalizeDocentes(rowsD);
      const EST = normalizeEstudiantes(rowsE);
      const MAL = normalizeMallas(rowsM);
      if (DOC.length === 0 || EST.length === 0 || MAL.length === 0) {
        throw new Error("Datos insuficientes para procesar. Verifique el formato de los archivos.");
      }
      updateProgress(60);
      const secciones = construirSecciones(DOC, MAL, EST);
      updateProgress(80);
      const { asignaciones, noAsig, cargaDocente, resumenMateria, secciones: seccFinal } = asignarEstudiantes(secciones, EST, MAL);
      OUT_SECC = seccFinal.map(s => ({
        "NOMBRE_DOCENTE": s.NOMBRE_DOCENTE || "",
        "MATERIA": s.MATERIA,
        "CANTIDAD DE ALUMNOS ESPERADOS": s.CAP || 0,
        "DIA": s.DIA || "0",
        "HORA": s.HORA || "0",
        "Modalidad": s.Modalidad || "0",
        "Paralelo": s.Paralelo || "A"
      }));
      OUT_COMB = asignaciones.map(a => ({
        "NOMBRE_DOCENTE": a.NOMBRE_DOCENTE,
        "MATERIA": a.MATERIA,
        "CANTIDAD DE ALUMNOS ESPERADOS": a["CANTIDAD DE ALUMNOS ESPERADOS"]||0,
        "DIA": a.DIA||"0",
        "HORA": a.HORA||"0",
        "Modalidad": a.Modalidad||"0",
        "Paralelo": a.Paralelo||"A",
        "ESTUDIANTE": a.ESTUDIANTE,
        "CICLO": a.CICLO||0
      }));
      OUT_NO = noAsig;
      OUT_CARGA = cargaDocente;
      OUT_RES_MAT = resumenMateria;

      updateProgress(90);
      renderTable(document.getElementById('tblCombo'), COMBO9, OUT_COMB, 200);
      renderTable(document.getElementById('tblCarga'), 
                 ["DOCENTE", "MATERIA", "Paralelo", "DIA", "HORA", "ASIGNADOS", "CAP"], 
                 OUT_CARGA, 200);
      renderTable(document.getElementById('tblResumenMateria'), 
                 ["MATERIA", "Paralelo", "ASIGNADOS", "CAP", "OCUPACION"], 
                 OUT_RES_MAT, 200);
      renderTable(document.getElementById('tblNo'), 
                 ["ESTUDIANTE", "MATERIA", "CICLO", "MOTIVO"], 
                 OUT_NO, 200);
      renderMatrizTable(asignaciones);
      updateStats(OUT_SECC, OUT_COMB, OUT_NO, OUT_RES_MAT);
      document.getElementById('btnDown').classList.remove('hidden');
      updateProgress(100);
      setTimeout(() => {
        document.getElementById('progressContainer').style.display = 'none';
        document.body.classList.remove('loading');
        showSuccess(`Procesamiento completado. Se realizaron ${OUT_COMB.length} asignaciones.`);
      }, 800);
    } catch (error) {
      console.error("Error procesando archivos:", error);
      showError(error.message);
      document.body.classList.remove('loading');
      document.getElementById('progressContainer').style.display = 'none';
    }
  });
  
  document.getElementById('btnDown').addEventListener('click', () => {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_SECC), 'MATRIZ_SECCIONES');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_COMB), 'COMBINACION');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_CARGA), 'RESUMEN_CARGA');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_RES_MAT), 'RESUMEN_MATERIA');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_NO), 'NO_ASIGNADOS');
    XLSX.writeFile(wb, 'Planificacion_Asignacion_Docente.xlsx');
    showSuccess('Archivo descargado correctamente.');
  });
});
</script>
</body>
</html>
