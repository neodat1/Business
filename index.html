<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Planificación Académica — UIDE</title>

<!-- Lectura de Excel con “fallback” (si falla cdn.jsdelivr, prueba unpkg) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"
        onerror="(function(){var s=document.createElement('script');s.src='https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js';s.onerror=function(){alert('No pudo cargarse la librería XLSX. Si necesita trabajar sin Internet, indíqueme y le entrego la versión 100% offline.');};document.head.appendChild(s);})();"></script>

<style>
  :root{
    --azul:#04136C; --mostaza:#DE912E; --vino:#862B39; --celeste:#9CBEE3; --verde:#8A9520;
    --bg:#f8fafc; --ink:#0f172a; --muted:#475569; --card:#ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{display:flex;align-items:center;gap:16px;padding:16px 20px;border-bottom:4px solid var(--azul);background:linear-gradient(90deg,var(--azul),#0b1f9a)}
  header img{height:64px;object-fit:contain}
  header h1{margin:0;color:#fff;font-weight:800;letter-spacing:.2px}
  header .tag{margin-left:auto;background:rgba(255,255,255,.16);color:#fff;padding:6px 10px;border-radius:999px;font-size:.85rem}
  main{max-width:1400px;margin:24px auto;padding:0 20px 40px}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 6px 18px rgba(2,6,23,.06);margin-bottom:20px}
  .card header{background:linear-gradient(90deg,var(--azul),var(--vino));padding:12px 16px;border:0;border-top-left-radius:16px;border-top-right-radius:16px}
  .card header h2{margin:0;color:#fff;font-size:1.05rem}
  .card .body{padding:16px}
  .grid{display:grid;gap:14px}
  @media (min-width:900px){ .grid.cols-3{grid-template-columns:repeat(3,1fr)} .grid.cols-2{grid-template-columns:1fr 1fr} }
  label{font-size:.9rem;color:var(--muted)}
  input[type="file"], select, input[type="text"], input[type="number"]{
    width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff
  }
  .btn{display:inline-flex;align-items:center;gap:8px;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--mostaza);color:#1f2937}
  .btn.outline{background:#fff;border:2px solid var(--azul);color:var(--azul)}
  .btn.warn{background:var(--vino);color:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.75rem}
  .pill.ok{background:#dcfce7;color:#166534}
  .pill.bad{background:#fee2e2;color:#991b1b}
  .note{font-size:.85rem;color:var(--muted)}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
  thead th{position:sticky;top:0;background:#f1f5f9;border-bottom:2px solid #e2e8f0;padding:10px;text-align:left;font-size:.85rem;color:#1f2937;z-index:1}
  tbody td{border-bottom:1px dashed #e5e7eb;padding:8px;font-size:.9rem}
  tbody tr:hover{background:#f8fafc}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .legend{display:flex;gap:8px;flex-wrap:wrap}
  .legend .item{display:flex;align-items:center;gap:6px;font-size:.85rem;color:var(--muted)}
  .warning{background:#fff7ed;border-left:4px solid var(--mostaza);padding:8px 10px;border-radius:8px;color:#7c2d12}
  .success{background:#ecfeff;border-left:4px solid var(--celeste);padding:8px 10px;border-radius:8px;color:#0e7490}
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.4);display:none;align-items:center;justify-content:center;padding:20px}
  .modal .panel{background:#fff;border-radius:16px;max-width:760px;width:100%;box-shadow:0 20px 60px rgba(2,6,23,.3)}
  .modal header{background:var(--azul);border-radius:16px 16px 0 0}
  .modal header h3{color:#fff;margin:0;padding:12px 16px}
  .modal .content{padding:16px}
  .hl{background:linear-gradient(transparent 60%, rgba(222,145,46,.35) 0)}
</style>
</head>
<body>
<header>
  <img src="UIDE-Ecuador.png" alt="UIDE Ecuador" onerror="this.style.display='none'"/>
  <h1>Planificación Académica — UIDE</h1>
  <span class="tag">Colores institucionales • Azul #04136C · Mostaza #DE912E · Vino #862B39 · Celeste #9CBEE3 · Verde #8A9520</span>
</header>

<main>
  <!-- CARGA DE ARCHIVOS -->
  <section class="card">
    <header><h2>1) Cargar Excel</h2></header>
    <div class="body grid cols-3">
      <div>
        <label>Archivo <b>Malla.xlsx</b></label>
        <input id="fileMalla" type="file" accept=".xlsx,.xls"/>
        <div class="note">Debe contener: carrera, malla/plan, ciclo, materia, códigos, horas T/P/A, créditos, campo, orden, “compartida con”, prerrequisitos.</div>
      </div>
      <div>
        <label>Archivo <b>Docente.xlsx</b></label>
        <input id="fileDocente" type="file" accept=".xlsx,.xls"/>
        <div class="note">Debe contener: docente, título, dedicación, <span class="hl">disponibilidad (días/horas)</span>, modalidad y/o materias que dicta (opcional).</div>
      </div>
      <div>
        <label>Archivo <b>Estudiante.xlsx</b></label>
        <input id="fileEst" type="file" accept=".xlsx,.xls"/>
        <div class="note">Debe contener: carrera, estudiante, ciclo, malla, nivel de inglés, observaciones.</div>
      </div>
    </div>
    <div class="body">
      <div class="toolbar">
        <button id="btnPreviewHeaders" class="btn outline">2) Previsualizar y mapear columnas</button>
        <button id="btnPlanificar" class="btn primary" disabled>3) Ejecutar asignación profesional</button>
        <button id="btnExportar" class="btn warn" disabled>Exportar a Excel</button>
      </div>
      <div id="msgLoad" class="note" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- RESTRICCIONES -->
  <section class="card">
    <header><h2>Restricciones (Inglés y Prácticas comunitarias)</h2></header>
    <div class="body grid cols-3">
      <div>
        <label>Bloqueos por Inglés (por <b>estudiante</b>)</label>
        <input id="inpBloqIngles" type="text" placeholder='Ej.: "Juan Pérez|Martes 10-13; Jueves 16-19", "Ana Vega|Lunes 19-22"'/>
        <div class="note">Formato: <i>Nombre|Día Franja; Día Franja</i>. Opcional.</div>
      </div>
      <div>
        <label>Bloqueo por Prácticas comunitarias (por <b>semestre</b>)</label>
        <input id="inpBloqPracticas" type="text" placeholder='Ej.: "2|Miércoles 13-16", "5|Viernes 07-10"'/>
        <div class="note">Formato: <i>Ciclo|Día Franja</i> (aplica a todo ese ciclo).</div>
      </div>
      <div>
        <label>Capacidad por paralelo (opcional)</label>
        <input id="inpCapParalelo" type="number" min="10" max="100" placeholder="p. ej., 35"/>
        <div class="note">Si se define y se supera, se crean B, C, …</div>
      </div>
    </div>
    <div class="body">
      <div class="legend">
        <div class="item"><span class="pill ok">Regla</span> Máx. <b>2 materias/día</b> por docente y por estudiante</div>
        <div class="item"><span class="pill ok">Regla</span> Evitar choques entre ciclos <b>adyacentes</b> de la misma carrera</div>
        <div class="item"><span class="pill ok">Regla</span> Materias <b>no compartidas</b> entre carreras pueden coincidir en hora y día</div>
      </div>
    </div>
  </section>

  <!-- RESULTADOS -->
  <section class="card">
    <header><h2>Planificación docente</h2></header>
    <div class="body">
      <div class="toolbar">
        <input id="filtroDocente" type="text" placeholder="Filtrar por docente/materia/carrera…"/>
      </div>
      <div id="wrapDocente"></div>
    </div>
  </section>

  <section class="card">
    <header><h2>Planificación estudiante</h2></header>
    <div class="body">
      <div class="toolbar">
        <input id="filtroEst" type="text" placeholder="Filtrar por estudiante/carrera/materia…"/>
      </div>
      <div id="wrapEst"></div>
      <div class="note" style="margin-top:8px">Edición habilitada <b>solo</b> para estudiantes (reasignación de materia/franja con validación de choques).</div>
    </div>
  </section>

  <section class="card">
    <header><h2>Materias</h2></header>
    <div class="body">
      <div class="toolbar">
        <input id="filtroMat" type="text" placeholder="Filtrar por malla/carrera/materia…"/>
      </div>
      <div id="wrapMat"></div>
    </div>
  </section>

  <section class="card">
    <header><h2>Validaciones y avisos</h2></header>
    <div class="body">
      <div id="avisos" class="warning">Pendiente de ejecución.</div>
    </div>
  </section>
</main>

<!-- MODALES -->
<div id="modalMapeo" class="modal" role="dialog" aria-modal="true">
  <div class="panel">
    <header><h3>Mapeo de columnas</h3></header>
    <div class="content">
      <p class="note">Seleccione qué columna de su Excel corresponde a cada campo requerido. El sistema no asume nombres.</p>
      <div id="mapeos" class="grid cols-3"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn outline" onclick="closeModal('modalMapeo')">Cancelar</button>
        <button class="btn primary" id="btnGuardarMapeo">Guardar mapeos</button>
      </div>
    </div>
  </div>
</div>

<div id="modalEditar" class="modal" role="dialog" aria-modal="true">
  <div class="panel">
    <header><h3>Editar asignación de estudiante</h3></header>
    <div class="content" id="editarContenido"></div>
  </div>
</div>

<script>
/* Manejo de error genérico (carga de XLSX u otros) */
window.addEventListener('error', e=>{
  const m = String(e?.message||'');
  if(m.toLowerCase().includes('xlsx')) {
    const av = document.querySelector('#avisos');
    if(av){ av.className='warning'; av.textContent='Error cargando XLSX. Verifique su conexión o solicite la versión 100% offline.'; }
  }
});

/* ==========================
   Utilidades y constantes
========================== */
const FRANJAS = [
  {id:"07-10", start:7, end:10},
  {id:"10-13", start:10, end:13},
  {id:"13-16", start:13, end:16},
  {id:"16-19", start:16, end:19},
  {id:"19-22", start:19, end:22},
];
const DIAS = ["Lunes","Martes","Miércoles","Jueves","Viernes"];
const DIA_ALIASES = {
  "lu":"Lunes","lun":"Lunes","lunes":"Lunes","mon":"Lunes",
  "ma":"Martes","mar":"Martes","martes":"Martes","tue":"Martes",
  "mi":"Miércoles","mie":"Miércoles","mié":"Miércoles","miercoles":"Miércoles","miércoles":"Miércoles","wed":"Miércoles",
  "ju":"Jueves","jue":"Jueves","jueves":"Jueves","thu":"Jueves",
  "vi":"Viernes","vie":"Viernes","viernes":"Viernes","fri":"Viernes"
};
const SLOT_RX = /(0?\d{1,2})(?::?\d{0,2})?\s*[-–a]\s*(0?\d{1,2})(?::?\d{0,2})?/i;

let datos = { malla:[], docente:[], estudiante:[] };
let headers = { malla:[], docente:[], estudiante:[] };
let map = { malla:{}, docente:{}, estudiante:{} };
let resultados = { planDocente:[], planEstudiante:[], materias:[] };
let relaciones = { dispDocente:{}, bloquesIngles:{}, bloquesPracticas:{} };
let paraleloCap = null;

const el = s => document.querySelector(s);
const msg = (t, ok=false)=>{ el('#avisos').className = ok?'success':'warning'; el('#avisos').textContent = t; };

function normDia(raw){
  if(!raw) return null;
  const t = String(raw).trim().toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");
  return DIA_ALIASES[t] || (DIAS.includes(capitalize(raw)) ? capitalize(raw) : null);
}
function normSlot(raw){
  if(!raw) return null;
  const m = String(raw).replace(/\s/g,'').replace('–','-').match(SLOT_RX);
  if(!m) return null;
  const a = parseInt(m[1],10), b = parseInt(m[2],10);
  const id = `${pad(a)}-${pad(b)}`;
  return FRANJAS.some(f=>f.id===id) ? id : null;
}
function pad(n){ return (n<10?'0':'') + n; }
function capitalize(s){ return s? s[0].toUpperCase()+s.slice(1).toLowerCase() : s; }

async function leerExcel(file){
  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, {type:"array"});
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const arr = XLSX.utils.sheet_to_json(sheet, {defval:""});
  return { arr, headers: arr.length? Object.keys(arr[0]) : [] };
}

function renderTabla(containerId, rows, cols, editableCb=null, filterInputId=null){
  const cont = el(containerId);
  if(!rows.length){ cont.innerHTML = '<div class="note">Sin datos.</div>'; return; }
  const filtro = filterInputId? el(filterInputId).value.trim().toLowerCase() : "";
  const vis = filtro? rows.filter(r=> Object.values(r).some(v=> String(v).toLowerCase().includes(filtro))) : rows;
  const thead = '<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
  const tbody = '<tbody>'+vis.map((r,i)=>'<tr>'+
    cols.map(c=>{
      if(c==="_acciones" && editableCb){
        return `<td><button class="btn outline" data-idx="${r._idx||i}" data-action="edit">Editar</button></td>`;
      }
      return `<td>${r[c]??""}</td>`;
    }).join('')+'</tr>').join('')+'</tbody>';
  cont.innerHTML = `<div style="overflow:auto;max-height:520px;border:1px solid #e5e7eb;border-radius:12px">${'<table>'+thead+tbody+'</table>'}</div>`;
  if(editableCb){
    cont.querySelectorAll('button[data-action="edit"]').forEach(b=>b.onclick = ()=> editableCb(parseInt(b.dataset.idx,10)));
  }
}

function openModal(id){ el('#'+id).style.display='flex'; }
function closeModal(id){ el('#'+id).style.display='none'; }

function buildMapUI(){
  const wrap = el('#mapeos');
  wrap.innerHTML = "";

  const campos = {
    malla: [
      ["CARRERA","CARRERA"],["MALLA","MALLA"],["CICLO_MALLA","CICLO / SEMESTRE"],
      ["MATERIA","MATERIA"],["CODIGO_ANTHOLOGY","CÓDIGO ANTHOLOGY"],["CODIGO","CÓDIGO (INTERNO)"],
      ["PRE_REQUISITO","PRE-REQUISITO(S)"],["HORAS_T","HORAS TEÓRICAS"],["HORAS_P","HORAS PRÁCTICAS"],["HORAS_A","HORAS AUTÓNOMAS"],
      ["CREDITOS","CRÉDITOS"],["CAMPO_FORMACION","CAMPO DE FORMACIÓN"],["NRO_ORDEN_MALLA","Nº ORDEN EN LA MALLA"],
      ["COMPARTIDA_CON","COMPARTIDA CON CARRERA (separe por /)"]
    ],
    docente: [
      ["DOCENTE","DOCENTE"],["TITULO_ACADEMICO","TÍTULO ACADÉMICO"],["DEDICACION","DEDICACIÓN"],
      ["DISPONIBILIDAD","DISPONIBILIDAD (texto por días/horas)"],["LUNES","Lunes (columna opcional)"],["MARTES","Martes"],["MIERCOLES","Miércoles"],
      ["JUEVES","Jueves"],["VIERNES","Viernes"],["MODALIDAD","MODALIDAD (opcional)"],["MATERIAS_DICTA","MATERIAS QUE DICTA (opcional)"]
    ],
    estudiante: [
      ["CARRERA","CARRERA"],["ESTUDIANTE","ESTUDIANTE"],["CICLO_ESTUDIANTE","CICLO DEL ESTUDIANTE"],
      ["MALLA","MALLA"],["NIVEL_INGLES","NIVEL INGLÉS"],["OBSERVACIONES","OBSERVACIONES"]
    ]
  };

  const bloques = [
    ["malla","Malla.xlsx", headers.malla],
    ["docente","Docente.xlsx", headers.docente],
    ["estudiante","Estudiante.xlsx", headers.estudiante],
  ];

  bloques.forEach(([key,titulo,heads])=>{
    campos[key].forEach(([id,label])=>{
      const sel = document.createElement("div");
      sel.innerHTML = `
        <label><b>${titulo}</b> — ${label}</label>
        <select data-map="${key}:${id}">
          <option value="">— Sin asignar —</option>
          ${heads.map(h=>`<option value="${h}">${h}</option>`).join('')}
        </select>
      `;
      wrap.appendChild(sel);
      const select = sel.querySelector('select');
      const guess = heads.find(h => normalizarHeader(h).includes(normalizarHeader(id)));
      if(guess) select.value = guess;
    });
  });
  openModal('modalMapeo');
}
function normalizarHeader(h){
  return String(h).toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/\s|_|-/g,'');
}
function guardarMapeo(){
  const selects = [...el('#mapeos').querySelectorAll('select[data-map]')];
  map = { malla:{}, docente:{}, estudiante:{} };
  selects.forEach(s=>{
    const [tabla,campo] = s.dataset.map.split(':');
    if(s.value) map[tabla][campo] = s.value;
  });
  closeModal('modalMapeo');
  el('#btnPlanificar').disabled = false;
  msg("Mapeos guardados. Puede ejecutar la asignación.", true);
}

/* ==========================
   Disponibilidad docente
========================== */
function parseDisponibilidadDocente(rowD){
  const slots = [];
  const add = (diaTxt, horasTxt)=>{
    const d = normDia(diaTxt);
    if(!d) return;
    const piezas = String(horasTxt||"").split(/[,;/]+/);
    piezas.forEach(p=>{
      const s = normSlot(p);
      if(s) slots.push(`${d}|${s}`);
    });
  };
  if(map.docente["DISPONIBILIDAD"]){
    const texto = rowD[ map.docente["DISPONIBILIDAD"] ];
    if(texto){
      const lower = String(texto).toLowerCase();
      const candidatos = [
        ["Lunes",/(lu[n]?\b|lunes|mon)/gi],
        ["Martes",/(ma[r]?\b|martes|tue)/gi],
        ["Miércoles",/(mi[eé]?|miercoles|miércoles|wed)/gi],
        ["Jueves",/(ju[e]?\b|jueves|thu)/gi],
        ["Viernes",/(vi[e]?\b|viernes|fri)/gi],
      ];
      let tmp = lower;
      candidatos.forEach(([dia,rex])=>{ tmp = tmp.replace(rex, `|${dia}|`); });
      const partes = tmp.split('|').map(s=>s.trim()).filter(Boolean);
      for(let i=0;i<partes.length;i++){
        if(DIAS.includes(capitalize(partes[i]))){
          const dia = partes[i];
          const horas = (partes[i+1]||"").split(/[,;]+/).filter(Boolean).join(',');
          add(dia, horas);
        }
      }
    }
  }
  [["LUNES","Lunes"],["MARTES","Martes"],["MIERCOLES","Miércoles"],["JUEVES","Jueves"],["VIERNES","Viernes"]].forEach(([mKey,dia]){
    if(map.docente[mKey]){
      add(dia, rowD[ map.docente[mKey] ]);
    }
  });
  return Array.from(new Set(slots));
}

/* ==========================
   Motor de asignación
========================== */
function planificar(){
  paraleloCap = parseInt(el('#inpCapParalelo').value||"0",10) || null;

  // Bloqueos por Inglés (estudiante)
  relaciones.bloquesIngles = {};
  String(el('#inpBloqIngles').value||"").split(/"\s*,\s*"|, */).forEach(item=>{
    item = item.replace(/^"+|"+$/g,'').trim();
    if(!item) return;
    const [nom,rest] = item.split('|');
    if(!nom || !rest) return;
    const key = nom.trim();
    rest.split(/; */).forEach(tok=>{
      const [dRaw, sRaw] = tok.trim().split(/\s+/);
      const d = normDia(dRaw);
      const s = normSlot(sRaw);
      if(d && s){
        if(!relaciones.bloquesIngles[key]) relaciones.bloquesIngles[key] = new Set();
        relaciones.bloquesIngles[key].add(`${d}|${s}`);
      }
    });
  });

  // Bloqueos por Prácticas (por ciclo)
  relaciones.bloquesPracticas = {};
  String(el('#inpBloqPracticas').value||"").split(/"\s*,\s*"|, */).forEach(item=>{
    item = item.replace(/^"+|"+$/g,'').trim();
    if(!item) return;
    const [cicloRaw, tok] = item.split('|');
    const ciclo = parseInt(cicloRaw,10);
    if(!ciclo || !tok) return;
    const [dRaw, sRaw] = tok.trim().split(/\s+/);
    const d = normDia(dRaw);
    const s = normSlot(sRaw);
    if(d && s){
      if(!relaciones.bloquesPracticas[ciclo]) relaciones.bloquesPracticas[ciclo] = new Set();
      relaciones.bloquesPracticas[ciclo].add(`${d}|${s}`);
    }
  });

  // Docentes
  const docentes = datos.docente.map((row,idx)=>({
    idx,
    DOCENTE: val(row, map.docente["DOCENTE"]),
    TITULO_ACADEMICO: val(row, map.docente["TITULO_ACADEMICO"]),
    DEDICACION: val(row, map.docente["DEDICACION"]),
    MODALIDAD: map.docente["MODALIDAD"]? val(row,map.docente["MODALIDAD"]) : "Presencial",
    MATERIAS_DICTA: map.docente["MATERIAS_DICTA"]? String(val(row,map.docente["MATERIAS_DICTA"])).split(/[;,/]+/).map(s=>s.trim()).filter(Boolean) : [],
    DISP: parseDisponibilidadDocente(row),
    cargaDia: {}
  })).filter(d=>d.DOCENTE);

  // Estudiantes
  const estudiantes = datos.estudiante.map((row,idx)=>({
    idx,
    CARRERA: val(row, map.estudiante["CARRERA"]),
    ESTUDIANTE: val(row, map.estudiante["ESTUDIANTE"]),
    CICLO: parseInt(val(row, map.estudiante["CICLO_ESTUDIANTE"])) || null,
    MALLA: val(row, map.estudiante["MALLA"]),
    NIVEL_INGLES: val(row, map.estudiante["NIVEL_INGLES"]),
    OBSERVACIONES: val(row, map.estudiante["OBSERVACIONES"]),
  })).filter(e=>e.CARRERA && e.ESTUDIANTE && e.CICLO);

  const gruposEst = {};
  estudiantes.forEach(e=>{
    const key = `${e.CARRERA}|${e.CICLO}|${e.MALLA}`;
    if(!gruposEst[key]) gruposEst[key] = [];
    gruposEst[key].push(e);
  });

  // Materias
  const materiasRaw = datos.malla.map(row=>({
    CARRERA: val(row, map.malla["CARRERA"]),
    MALLA: val(row, map.malla["MALLA"]),
    CICLO_MALLA: parseInt(val(row, map.malla["CICLO_MALLA"])) || null,
    MATERIA: val(row, map.malla["MATERIA"]),
    CODIGO_ANTHOLOGY: val(row, map.malla["CODIGO_ANTHOLOGY"]),
    CODIGO: val(row, map.malla["CODIGO"]),
    PRE_REQUISITO: val(row, map.malla["PRE_REQUISITO"]),
    HORAS_T: num(val(row, map.malla["HORAS_T"])),
    HORAS_P: num(val(row, map.malla["HORAS_P"])),
    HORAS_A: num(val(row, map.malla["HORAS_A"])),
    CREDITOS: num(val(row, map.malla["CREDITOS"])),
    CAMPO_FORMACION: val(row, map.malla["CAMPO_FORMACION"]),
    NRO_ORDEN_MALLA: val(row, map.malla["NRO_ORDEN_MALLA"]),
    COMPARTIDA_CON: (val(row, map.malla["COMPARTIDA_CON"])||"").split(/[;/]+/).map(s=>s.trim()).filter(Boolean)
  })).filter(m=>m.CARRERA && m.CICLO_MALLA && m.MATERIA);

  const usadoCiclo = {};
  function cicloKey(carrera,ciclo){ return `${carrera}|${ciclo}`; }

  const planDoc = [];
  const planEst = [];
  const planMat = [];

  Object.entries(gruposEst).forEach(([key,listaEst])=>{
    const [CARRERA, CICLO, MALLA] = key.split('|'); const cicloNum = parseInt(CICLO);
    const materiasCiclo = materiasRaw.filter(m=> m.CARRERA===CARRERA && m.MALLA===MALLA && m.CICLO_MALLA===cicloNum);

    let paralelos = ["A"];
    if(paraleloCap){
      const n = listaEst.length;
      const cuantos = Math.ceil(n / paraleloCap);
      paralelos = Array.from({length:cuantos}, (_,i)=> String.fromCharCode(65+i));
    }

    materiasCiclo.forEach(mat=>{
      const horasContacto = (mat.HORAS_T||0) + (mat.HORAS_P||0);
      const slotsNecesarios = Math.max(1, Math.ceil(horasContacto / 3));

      paralelos.forEach((PARA, pIdx)=>{
        const asignaciones = escogerSlotsYDocente(CARRERA, cicloNum, mat, slotsNecesarios, docentes, usadoCiclo);

        planMat.push({
          "MALLA": MALLA,
          "CICLO DE LA MATERIA EN LA MALLA": cicloNum,
          "COMPARTIDA CON CARRERA": mat.COMPARTIDA_CON.join(' / '),
          "MATERIA": mat.MATERIA,
          "PARALELO": PARA,
          "DIA": asignaciones.map(a=>a.dia).join(' / '),
          "HORA": asignaciones.map(a=>a.slot).join(' / '),
          "Número de estudiantes": Math.ceil(listaEst.length / paralelos.length)
        });

        asignaciones.forEach(asg=>{
          planDoc.push({
            "DOCENTE": asg.docente.DOCENTE,
            "TITULO ACADÉMICO": asg.docente.TITULO_ACADEMICO,
            "DEDICACIÓN": asg.docente.DEDICACION,
            "MATERIA": mat.MATERIA,
            "CÓDIGO ANTHOLOGY": mat.CODIGO_ANTHOLOGY,
            "CARRERAS QUE COMPARTEN": [mat.CARRERA, ...(mat.COMPARTIDA_CON||[])].filter(Boolean).join(' / '),
            "PRE-REQUISITO": mat.PRE_REQUISITO,
            "CODIGO": mat.CODIGO,
            "HORAS TEÓRICAS": mat.HORAS_T||0,
            "HORAS PRÁCTICAS": mat.HORAS_P||0,
            "HORAS AUTÓNOMAS": mat.HORAS_A||0,
            "CREDITOS": mat.CREDITOS||0,
            "CAMPO DE FORMACIÓN": mat.CAMPO_FORMACION,
            "CICLO MALLA": mat.CICLO_MALLA,
            "Nº ORDEN EN LA MALLA": mat.NRO_ORDEN_MALLA||"",
            "PARALELO": PARA,
            "DIA": asg.dia,
            "HORA": asg.slot,
            "MODALIDAD": asg.docente.MODALIDAD,
            "Nro. HORAS": 3
          });
        });

        listaEst.forEach((est, idxEst)=>{
          const asignadoAEsteParalelo = (idxEst % paralelos.length) === pIdx;
          if(!asignadoAEsteParalelo) return;
          const yaAsignadas = planEst.filter(r => r.ESTUDIANTE===est.ESTUDIANTE).length;
          if(yaAsignadas >= 6) return;

          asignaciones.forEach(asg=>{
            const keyIng = `${est.ESTUDIANTE}`;
            const bloqueEst = relaciones.bloquesIngles[keyIng];
            const bloqueCiclo = relaciones.bloquesPracticas[est.CICLO];
            if( (bloqueEst && bloqueEst.has(`${asg.dia}|${asg.slot}`)) || (bloqueCiclo && bloqueCiclo.has(`${asg.dia}|${asg.slot}`)) ){
              return;
            }
            const countDay = planEst.filter(r=> r.ESTUDIANTE===est.ESTUDIANTE && r.DIA===asg.dia).length;
            if(countDay >= 2) return;

            planEst.push({
              "CARRERA": est.CARRERA,
              "ESTUDIANTE": est.ESTUDIANTE,
              "CICLO DEL ESTUDIANTE": est.CICLO,
              "MALLA": est.MALLA,
              "CICLO DE LA MATERIA EN LA MALLA": mat.CICLO_MALLA,
              "COMPARTIDA CON\tCARRERA": mat.COMPARTIDA_CON.join(' / '),
              "MATERIA": mat.MATERIA,
              "PARALELO": PARA,
              "DIA": asg.dia,
              "HORA": asg.slot,
              "MODALIDAD": "Presencial",
              "NIVEL INGLES": est.NIVEL_INGLES||"",
              "OBSERVACIONES": est.OBSERVACIONES||"",
              "DOCENTE": asg.docente.DOCENTE,
              "_idx": planEst.length
            });
          });
        });

      });
    });
  });

  resultados.planDocente = compactarHorasDocente(planDoc);
  resultados.planEstudiante = planEst;
  resultados.materias = planMat;

  renderTodo();

  const avisos = validarCruces(resultados);
  msg(avisos.length? `Revisiones: ${avisos.length} hallazgos` : "Sin choques detectados. Asignación completada.", !avisos.length);
}

function escogerSlotsYDocente(CARRERA, cicloNum, mat, slotsNecesarios, docentes, usadoCiclo){
  const asignaciones = [];
  const keyCiclo = (c)=> `${CARRERA}|${c}`;

  for(let n=0; n<slotsNecesarios; n++){
    let elegido = null;

    for(const dia of DIAS){
      const ady = [cicloNum-1,cicloNum,cicloNum+1].filter(x=>x>0);
      const ocupadosAdy = new Set([].concat(...ady.map(c=> Array.from((usadoCiclo[keyCiclo(c)]||new Set())) )));
      for(const fr of FRANJAS){
        const marca = `${dia}|${fr.id}`;
        if(ocupadosAdy.has(marca)) continue;

        const candidatos = docentes.filter(d=>{
          if(!d.DISP.includes(marca)) return false;
          const carga = d.cargaDia[dia]||0;
          if(carga>=2) return false;
          if(d.MATERIAS_DICTA.length){
            return d.MATERIAS_DICTA.some(x=> normalizarHeader(x)===normalizarHeader(mat.MATERIA));
          }
          return true;
        });

        if(candidatos.length){
          candidatos.sort((a,b)=> ( (a.cargaDia[dia]||0) - (b.cargaDia[dia]||0) ));
          const dsel = candidatos[0];
          elegido = { dia, slot: fr.id, docente: dsel };
          dsel.cargaDia[dia] = (dsel.cargaDia[dia]||0)+1;
          if(!usadoCiclo[keyCiclo(cicloNum)]) usadoCiclo[keyCiclo(cicloNum)] = new Set();
          usadoCiclo[keyCiclo(cicloNum)].add(marca);
          break;
        }
      }
      if(elegido) break;
    }

    if(!elegido){
      outer:
      for(const dia of DIAS){
        for(const fr of FRANJAS){
          const marca = `${dia}|${fr.id}`;
          const cand = docentes.find(d=> d.DISP.includes(marca) && (d.cargaDia[dia]||0) < 2 );
          if(cand){
            elegido = { dia, slot: fr.id, docente: cand };
            cand.cargaDia[dia] = (cand.cargaDia[dia]||0)+1;
            break outer;
          }
        }
      }
    }

    if(elegido) asignaciones.push(elegido);
  }
  return asignaciones;
}

function compactarHorasDocente(rows){
  const keyOf = r => [r.DOCENTE,r.MATERIA,r.PARALELO].join("|");
  const mapA = {};
  rows.forEach(r=>{
    const k = keyOf(r);
    if(!mapA[k]){
      mapA[k] = {...r};
    }else{
      mapA[k].DIA += ` / ${r.DIA}`;
      mapA[k].HORA += ` / ${r.HORA}`;
      mapA[k]["Nro. HORAS"] += r["Nro. HORAS"];
    }
  });
  return Object.values(mapA);
}

function validarCruces(rs){
  const avisos = [];

  const porDocDia = {};
  rs.planDocente.forEach(r=>{
    const k = `${r.DOCENTE}|${r.DIA}`;
    porDocDia[k] = (porDocDia[k]||0) + r["Nro. HORAS"]/3;
  });
  Object.entries(porDocDia).forEach(([k,v])=>{
    if(v>2) avisos.push(`Docente con más de 2 materias en un día: ${k}`);
  });

  const porEstDia = {};
  const porEstTot = {};
  rs.planEstudiante.forEach(r=>{
    const kd = `${r.ESTUDIANTE}|${r.DIA}`;
    porEstDia[kd] = (porEstDia[kd]||0) + 1;
    porEstTot[r.ESTUDIANTE] = (porEstTot[r.ESTUDIANTE]||0) + 1;
  });
  Object.entries(porEstDia).forEach(([k,v])=>{
    if(v>2) avisos.push(`Estudiante con más de 2 materias en un día: ${k}`);
  });
  Object.entries(porEstTot).forEach(([k,v])=>{
    if(v>6) avisos.push(`Estudiante con más de 6 materias: ${k} (${v})`);
  });

  return avisos;
}

function renderTodo(){
  const colsDoc = ["DOCENTE","TITULO ACADÉMICO","DEDICACIÓN","MATERIA","CÓDIGO ANTHOLOGY","CARRERAS QUE COMPARTEN","PRE-REQUISITO","CODIGO","HORAS TEÓRICAS","HORAS PRÁCTICAS","HORAS AUTÓNOMAS","CREDITOS","CAMPO DE FORMACIÓN","CICLO MALLA","Nº ORDEN EN LA MALLA","PARALELO","DIA","HORA","MODALIDAD","Nro. HORAS"];
  renderTabla("#wrapDocente", resultados.planDocente, colsDoc, null, "#filtroDocente");

  const colsEst = ["CARRERA","ESTUDIANTE","CICLO DEL ESTUDIANTE","MALLA","CICLO DE LA MATERIA EN LA MALLA","COMPARTIDA CON\tCARRERA","MATERIA","PARALELO","DIA","HORA","MODALIDAD","NIVEL INGLES","OBSERVACIONES","DOCENTE","_acciones"];
  renderTabla("#wrapEst", resultados.planEstudiante, colsEst, editarEstudiante, "#filtroEst");

  const colsMat = ["MALLA","CICLO DE LA MATERIA EN LA MALLA","COMPARTIDA CON CARRERA","MATERIA","PARALELO","DIA","HORA","Número de estudiantes"];
  renderTabla("#wrapMat", resultados.materias, colsMat, null, "#filtroMat");

  el('#btnExportar').disabled = false;
}

function editarEstudiante(idx){
  const fila = resultados.planEstudiante[idx];
  if(!fila) return;
  const contenido = el('#editarContenido');
  const opcionesMateria = resultados.materias
    .filter(m => m["CICLO DE LA MATERIA EN LA MALLA"]===fila["CICLO DE LA MATERIA EN LA MALLA"] && m["MALLA"]===fila["MALLA"])
    .map(m => ({ materia:m["MATERIA"], paralelo:m["PARALELO"], dia:m["DIA"], hora:m["HORA"] }));
  const optsMat = [...new Set(opcionesMateria.map(o=>`${o.materia} | Paralelo ${o.paralelo}`))];

  const optsDia = DIAS;
  const optsSlot = FRANJAS.map(f=>f.id);

  contenido.innerHTML = `
    <div class="grid cols-2">
      <div><label>Estudiante</label><input type="text" value="${fila.ESTUDIANTE}" disabled/></div>
      <div><label>Carrera</label><input type="text" value="${fila.CARRERA}" disabled/></div>
      <div><label>Materia</label>
        <select id="edMateria">${optsMat.map(x=>`<option ${x.startsWith(fila.MATERIA)?'selected':''}>${x}</option>`).join('')}</select>
      </div>
      <div><label>Día</label>
        <select id="edDia">${optsDia.map(d=>`<option ${d===fila.DIA?'selected':''}>${d}</option>`).join('')}</select>
      </div>
      <div><label>Hora</label>
        <select id="edHora">${optsSlot.map(s=>`<option ${s===fila.HORA?'selected':''}>${s}</option>`).join('')}</select>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn outline" onclick="closeModal('modalEditar')">Cerrar</button>
      <button class="btn primary" onclick="guardarEdicion(${idx})">Guardar cambios</button>
    </div>
    <div class="note" style="margin-top:8px">Se validará si hay cruce de horarios (máx. 2 materias/día para el estudiante). Para docentes no se edita desde aquí.</div>
  `;
  openModal('modalEditar');
}
function guardarEdicion(idx){
  const fila = resultados.planEstudiante[idx];
  const dia = el('#edDia').value;
  const hora = el('#edHora').value;
  const matSel = el('#edMateria').value.split(' | ')[0];

  const ya = resultados.planEstudiante.filter((r,i)=> i!==idx && r.ESTUDIANTE===fila.ESTUDIANTE && r.DIA===dia);
  if(ya.length >= 2){
    alert("No es posible: el estudiante ya tiene 2 materias ese día.");
    return;
  }
  fila.DIA = dia; fila.HORA = hora; fila.MATERIA = matSel;
  renderTodo();
  closeModal('modalEditar');
}

function val(row, col){ return col? row[col] : ""; }
function num(v){ const n = parseFloat(String(v).replace(',','.')); return isNaN(n)? 0 : n; }

function exportar(){
  const wb = XLSX.utils.book_new();
  const toSheet = (arr)=>XLSX.utils.json_to_sheet(arr);
  XLSX.utils.book_append_sheet(wb, toSheet(resultados.planDocente), "Planificación docente");
  XLSX.utils.book_append_sheet(wb, toSheet(resultados.planEstudiante), "Planificación estudiante");
  XLSX.utils.book_append_sheet(wb, toSheet(resultados.materias), "Materias");
  XLSX.writeFile(wb, "Planificacion_UIDE.xlsx");
}

/* Eventos UI */
el('#btnPreviewHeaders').onclick = async ()=>{
  const mallaF = el('#fileMalla').files[0];
  const docF = el('#fileDocente').files[0];
  const estF = el('#fileEst').files[0];
  if(!mallaF || !docF || !estF){ msg("Cargue los tres archivos Excel (Malla, Docente, Estudiante)."); return; }

  el('#msgLoad').textContent = "Leyendo Excel…";
  try{
    const [mres, dres, eres] = await Promise.all([leerExcel(mallaF), leerExcel(docF), leerExcel(estF)]);
    datos.malla = mres.arr; headers.malla = mres.headers;
    datos.docente = dres.arr; headers.docente = dres.headers;
    datos.estudiante = eres.arr; headers.estudiante = eres.headers;
    el('#msgLoad').textContent = `Hojas leídas. Encabezados detectados — Malla: ${headers.malla.length} • Docente: ${headers.docente.length} • Estudiante: ${headers.estudiante.length}`;
    buildMapUI();
  }catch(e){
    console.error(e);
    msg("No fue posible leer los archivos. Verifique que cada Excel tenga encabezados en la primera fila.");
  }
};
el('#btnGuardarMapeo').onclick = guardarMapeo;
el('#btnPlanificar').onclick = ()=>{
  try{ planificar(); }
  catch(e){ console.error(e); msg("Error en la asignación. Revise mapeos y datos (disponibilidad, ciclos y materias)."); }
};
el('#btnExportar').onclick = exportar;
el('#filtroDocente').oninput = ()=> renderTodo();
el('#filtroEst').oninput = ()=> renderTodo();
el('#filtroMat').oninput = ()=> renderTodo();
</script>
</body>
</html>
