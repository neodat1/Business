<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Malla a Filas (2019/2023)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f7f7f9;margin:0}
    .wrap{max-width:1200px;margin:28px auto;background:#fff;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.08);padding:28px}
    h1{margin:0 0 12px;color:#8a1f2d}
    .note{background:#e9effa;border-radius:8px;padding:12px 14px;margin:8px 0 18px}
    label{font-weight:600;margin-right:10px}
    select{padding:6px 10px;margin-right:18px}
    .btn{background:#244a8a;color:#fff;border:0;border-radius:8px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#173b74}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{border:1px solid #d6d6d6;padding:8px 10px}
    th{background:#8a1f2d;color:#fff;position:sticky;top:0}
    tr:nth-child(even){background:#fafafa}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Malla a Filas (2019 y 2023)</h1>
  <div class="note">
    <b>1.</b> Elige Carrera y Año. <b>2.</b> Sube tu malla Excel (2019 o 2023).<br/>
    <b>3.</b> Se extraen materias reales con sus horas (los vacíos se vuelven <b>0</b>).<br/>
    <b>4.</b> Completa PRERREQUISITO manualmente según flechas y descarga.
  </div>

  <label>Carrera:
    <select id="carrera">
      <option>Administración</option>
      <option>Negocios Internacionales</option>
      <option>Marketing</option>
    </select>
  </label>

  <label>Año de malla:
    <select id="anio">
      <option>2019</option>
      <option>2023</option>
    </select>
  </label>

  <input type="file" id="file" accept=".xlsx" class="btn" />
  <button class="btn" id="btnExcel">Descargar como Excel</button>

  <div id="out"></div>
</div>

<script>
let filas = [];
const HEADERS = ["CARRERA","AÑO","CICLO","MATERIA","CÓDIGO","HORAS TEÓRICAS","HORAS PRÁCTICAS","HORAS AUTÓNOMAS","PRERREQUISITO"];

function codigoValido(c) {
  if (!c) return false;
  return /^[A-Z]{2,4}-\d{2,}-[A-Z0-9]+$/.test(c) ||
         /^PP-\d{2,}-[A-Z0-9]+$/.test(c) ||
         /^CH-[A-Z0-9-]+$/.test(c) ||
         /^FT-[A-Z0-9-]+$/.test(c) ||
         /^CSC-[A-Z0-9-]+$/.test(c);
}

function materiaValida(nombre, codigo) {
  if (!nombre || !codigo) return false;
  const t = String(nombre).toLowerCase();
  return !(
    t.includes("total") || t.includes("componente") || t.includes("carga horaria") ||
    t.includes("requisito titulación") || t.includes("prácticas") || t.includes("practicas") ||
    t.includes("servicio comunitario") || t.includes("num. asignaturas") || t.includes("nº orden")
  ) && codigoValido(codigo);
}

function numOrZero(v) {
  if (v === undefined || v === null || v === "") return 0;
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

document.getElementById('file').addEventListener('change', (e) => {
  filas = [];
  const file = e.target.files?.[0];
  if (!file) return;

  const carrera = document.getElementById('carrera').value;
  const anio = document.getElementById('anio').value;

  const reader = new FileReader();
  reader.onload = (evt) => {
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, { type: 'array' });

    wb.SheetNames.forEach((name) => {
      const sheet = wb.Sheets[name];
      const A = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      const ciclosFila = A.find(row => row.some(cell => typeof cell === 'string' && cell.toLowerCase().includes('ciclo'))) ?? A[0];
      const ciclos = ciclosFila;

      for (let col = 0; col < ciclos.length; col++) {
        const ciclo = (ciclos[col] ?? "").toString().trim();

        for (let row = 0; row < A.length - 4; row++) {
          const nombre = A[row]?.[col]?.toString().trim() ?? "";
          const codigo = A[row + 1]?.[col]?.toString().trim() ?? "";
          const ht = numOrZero(A[row + 2]?.[col]);
          const hp = numOrZero(A[row + 3]?.[col]);
          const ha = numOrZero(A[row + 4]?.[col]);

          if (!materiaValida(nombre, codigo)) continue;

          filas.push({
            "CARRERA": carrera,
            "AÑO": anio,
            "CICLO": ciclo,
            "MATERIA": nombre,
            "CÓDIGO": codigo,
            "HORAS TEÓRICAS": ht,
            "HORAS PRÁCTICAS": hp,
            "HORAS AUTÓNOMAS": ha,
            "PRERREQUISITO": ""
          });
        }
      }
    });

    renderTabla();
  };
  reader.readAsArrayBuffer(file);
});

function renderTabla() {
  if (!filas.length) {
    document.getElementById('out').innerHTML = "<p style='color:#c00'><b>No se encontraron materias válidas.</b></p>";
    return;
  }
  let html = "<table><thead><tr>";
  html += HEADERS.map(h => `<th>${h}</th>`).join("");
  html += "</tr></thead><tbody>";

  for (const f of filas) {
    html += "<tr>";
    for (const h of HEADERS) {
      html += `<td>${f[h] ?? ""}</td>`;
    }
    html += "</tr>";
  }
  html += "</tbody></table>";
  document.getElementById('out').innerHTML = html;
}

document.getElementById('btnExcel').addEventListener('click', () => {
  if (!filas.length) return;

  const data = [HEADERS];
  for (const f of filas) {
    data.push(HEADERS.map(h => (f[h] ?? "")));
  }
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Malla");
  XLSX.writeFile(wb, "malla_filas.xlsx");
});
</script>
</body>
</html>
