<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Sistema de Planificaci√≥n Acad√©mica</title>
<meta name="viewport" 
content="width=device-width,initial-scale=1"/>
<script 
src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root {
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --primary-light: #dbeafe;
    --secondary: #64748b;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #0f172a;
    --light: #f8fafc;
    --border: #e2e8f0;
    --radius: 12px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 
0, 0, 0.06);
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    background: #f1f5f9;
    color: var(--dark);
    line-height: 1.6;
    padding: 0;
  }
  
  .app-container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 20px;
  }
  
  /* Header Styles */
  .app-header {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 24px;
    margin-bottom: 24px;
    border-left: 4px solid var(--primary);
  }
  
  .app-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .app-subtitle {
    color: var(--secondary);
    font-size: 16px;
    margin-bottom: 20px;
  }
  
  /* Card Styles */
  .card {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 24px;
    margin-bottom: 24px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px 
rgba(0, 0, 0, 0.05);
  }
  
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  
  .card-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--dark);
  }
  
  /* File Upload Styles */
  .file-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  .file-input-container {
    position: relative;
  }
  
  .file-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--dark);
  }
  
  .file-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    background: var(--light);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .file-input:hover {
    border-color: var(--primary);
    background: #f0f7ff;
  }
  
  .file-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    font-size: 14px;
  }
  
  .status-icon {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  
  .status-pending {
    background-color: var(--warning);
  }
  
  .status-success {
    background-color: var(--success);
  }
  
  /* Button Styles */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: var(--radius);
    border: none;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--primary-dark);
  }
  
  .btn-secondary {
    background: white;
    color: var(--dark);
    border: 1px solid var(--border);
  }
  
  .btn-secondary:hover {
    background: var(--light);
  }
  
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .btn-group {
    display: flex;
    gap: 12px;
    margin: 20px 0;
  }
  
  /* Progress Bar */
  .progress-container {
    width: 100%;
    height: 8px;
    background-color: var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin: 16px 0;
    display: none;
  }
  
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), 
var(--primary-light));
    width: 0%;
    transition: width 0.4s ease;
    border-radius: 4px;
  }
  
  /* Stats Cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }
  
  .stat-card {
    background: var(--light);
    border-radius: var(--radius);
    padding: 16px;
    text-align: center;
    border-left: 4px solid var(--primary);
  }
  
  .stat-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
  }
  
  .stat-label {
    font-size: 14px;
    color: var(--secondary);
  }
  
  /* Configuration Panel */
  .config-panel {
    background: var(--light);
    border-radius: var(--radius);
    padding: 20px;
    margin: 20px 0;
  }
  
  .config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
  }
  
  .config-item {
    margin-bottom: 12px;
  }
  
  .config-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--dark);
  }
  
  .config-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s ease;
  }
  
  .config-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }
  
  .time-slots {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }
  
  .time-slot {
    padding: 6px 12px;
    background: var(--primary-light);
    color: var(--primary);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
  }
  
  /* Table Styles */
  .table-container {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin: 16px 0;
    max-height: 400px;
    overflow: auto;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  
  th {
    background: #f8fafc;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: var(--dark);
    position: sticky;
    top: 0;
    border-bottom: 2px solid var(--border);
  }
  
  td {
    padding: 12px;
    border-bottom: 1px solid var(--border);
  }
  
  tr:hover {
    background: #f1f5f9;
  }
  
  /* Alert Styles */
  .alert {
    padding: 16px;
    border-radius: var(--radius);
    margin: 16px 0;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  
  .alert-error {
    background: #fef2f2;
    color: var(--danger);
    border-left: 4px solid var(--danger);
  }
  
  .alert-info {
    background: #eff6ff;
    color: var(--primary);
    border-left: 4px solid var(--primary);
  }
  
  .alert-success {
    background: #f0fdf4;
    color: var(--success);
    border-left: 4px solid var(--success);
  }
  
  .alert-icon {
    font-size: 20px;
    flex-shrink: 0;
  }
  
  /* Badges */
  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .badge-primary {
    background: var(--primary-light);
    color: var(--primary);
  }
  
  .badge-success {
    background: #d1fae5;
    color: var(--success);
  }
  
  .badge-warning {
    background: #fef3c7;
    color: var(--warning);
  }
  
  .badge-danger {
    background: #fee2e2;
    color: var(--danger);
  }
  
  /* Grid Layout */
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
  }
  
  @media (min-width: 992px) {
    .grid-2 {
      grid-template-columns: 1fr 1fr;
    }
  }
  
  /* Utilities */
  .text-muted {
    color: var(--secondary);
    font-size: 14px;
  }
  
  .text-center {
    text-align: center;
  }
  
  .hidden {
    display: none;
  }
  
  .loading {
    opacity: 0.7;
    pointer-events: none;
  }
  
  .mt-2 {
    margin-top: 16px;
  }
  
  .mb-2 {
    margin-bottom: 16px;
  }
  
  /* Animation */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .fade-in {
    animation: fadeIn 0.3s ease;
  }
  
  /* Tabs */
  .tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    margin-bottom: 16px;
  }
  
  .tab {
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
  }
  
  .tab.active {
    border-bottom-color: var(--primary);
    color: var(--primary);
    font-weight: 600;
  }
  
  .tab-content {
    display: none;
  }
  
  .tab-content.active {
    display: block;
  }
  
  /* Instructions */
  .instructions {
    background: #f0f9ff;
    border-left: 4px solid var(--primary);
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  
  .instructions h3 {
    margin-bottom: 10px;
    color: var(--primary);
  }
  
  .instructions ul {
    padding-left: 20px;
  }
  
  .instructions li {
    margin-bottom: 8px;
  }
  
  /* Matrix table */
  .matrix-container {
    overflow: auto;
    max-height: 600px;
    margin: 20px 0;
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }
  
  .matrix-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 2200px;
  }
  
  .matrix-table th {
    background: #e0f2fe;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .matrix-table th:nth-child(1),
  .matrix-table th:nth-child(2) {
    background: #bae6fd;
  }
  
  .matrix-table th:nth-child(-n+5) {
    background: #7dd3fc;
  }
  
  .matrix-table th:nth-child(-n+10) {
    background: #38bdf8;
  }
  
  .matrix-table th:nth-child(-n+15) {
    background: #0ea5e9;
  }
  
  .section-header {
    background: #f8fafc;
    font-weight: 600;
    color: var(--primary);
  }
</style>
</head>
<body>
<div class="app-container">
  <header class="app-header">
    <h1 class="app-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 
2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="13" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      Sistema de Planificaci√≥n Acad√©mica
    </h1>
    <p class="app-subtitle">Asignaci√≥n automatizada de estudiantes
 a materias y docentes</p>
  </header>

  <div class="instructions">
    <h3>Instrucciones de uso:</h3>
    <ul>
      <li>Cargue los archivos Excel con los formatos 
especificados</li>
      <li>El sistema asignar√° las materias seg√∫n el 
<strong>ciclo al que va</strong> cada estudiante</li>
      <li>Se respetar√° la disponibilidad de d√≠as y horas de los 
docentes</li>
      <li>M√°ximo de materias por estudiante: 6</li>
      <li>M√°ximo de estudiantes por paralelo: 25</li>
      <li>Horarios disponibles: 7:00-10:00, 10:00-13:00, 
13:00-16:00, 16:00-19:00, 19:00-22:00</li>
    </ul>
  </div>

  <div class="card">
    <div class="alert alert-info">
      <span class="alert-icon">üí°</span>
      <div>
        <strong>Nota:</strong> El sistema organizar√° 
autom√°ticamente los horarios evitando cruces entre materias del mismo 
ciclo.
        Las materias se asignar√°n seg√∫n el ciclo al que va cada 
estudiante y la disponibilidad de los docentes.
      </div>
    </div>

    <div class="alert alert-error hidden" id="errorBox">
      <span class="alert-icon">‚ö†Ô∏è</span>
      <div>
        <strong>Error:</strong> <span 
id="errorMessage"></span>
      </div>
    </div>

    <div class="config-panel">
      <h3 class="card-title">Configuraci√≥n del Sistema</h3>
      <div class="config-grid">
        <div class="config-item">
          <label class="config-label">Bloques de Horario 
Disponibles</label>
          <div class="time-slots">
            <span class="time-slot">07:00-10:00</span>
            <span class="time-slot">10:00-13:00</span>
            <span class="time-slot">13:00-16:00</span>
            <span class="time-slot">16:00-19:00</span>
            <span class="time-slot">19:00-22:00</span>
          </div>
        </div>
        
        <div class="config-item">
          <label class="config-label" for="maxMaterias">M√°ximo de 
materias por estudiante</label>
          <input type="number" id="maxMaterias" class="config-input" 
value="6" min="1" max="10">
        </div>
        
        <div class="config-item">
          <label class="config-label" 
for="capacidadParalelo">Capacidad m√°xima por paralelo</label>
          <input type="number" id="capacidadParalelo" 
class="config-input" value="25" min="10" max="25">
        </div>
      </div>
    </div>

    <div class="file-section">
      <div class="file-input-container">
        <label class="file-label">DOCENTES.xlsx</label>
        <input id="fileDoc" type="file" accept=".xlsx,.xls" 
class="file-input">
        <div class="file-status" id="statusDoc">
          <span class="status-icon status-pending"></span>
          <span>Esperando archivo...</span>
        </div>
      </div>
      
      <div class="file-input-container">
        <label class="file-label">ESTUDIANTES.xlsx</label>
        <input id="fileEst" type="file" accept=".xlsx,.xls" 
class="file-input">
        <div class="file-status" id="statusEst">
          <span class="status-icon status-pending"></span>
          <span>Esperando archivo...</span>
        </div>
      </div>
      
      <div class="file-input-container">
        <label class="file-label">MALLA.xlsx</label>
        <input id="fileMal" type="file" accept=".xlsx,.xls" 
class="file-input">
        <div class="file-status" id="statusMal">
          <span class="status-icon status-pending"></span>
          <span>Esperando archivo...</span>
        </div>
      </div>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="btn-group">
      <button id="btnRun" class="btn btn-primary" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" 
height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" 
stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 
1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Procesar Asignaci√≥n
      </button>
      <button id="btnDown" class="btn btn-secondary hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" 
height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" 
stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 
1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Descargar Planificaci√≥n
      </button>
    </div>

    <div class="stats-grid" id="statsContainer" style="display: 
none;">
      <div class="stat-card">
        <div class="stat-value" id="statSecciones">0</div>
        <div class="stat-label">Secciones creadas</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" 
id="statAsignaciones">0</div>
        <div class="stat-label">Asignaciones 
realizadas</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statNoAsignados">0</div>
        <div class="stat-label">Estudiantes no 
asignados</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statOcupacion">0%</div>
        <div class="stat-label">Ocupaci√≥n promedio</div>
      </div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" 
data-tab="asignaciones">Asignaciones</div>
    <div class="tab" data-tab="carga-docente">Carga 
Docente</div>
    <div class="tab" data-tab="resumen-materia">Resumen por 
Materia</div>
    <div class="tab" data-tab="no-asignados">No 
Asignados</div>
    <div class="tab" data-tab="matriz-completa">Matriz 
Completa</div>
  </div>

  <div class="tab-content active" id="asignaciones">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Asignaciones Realizadas</h3>
        <span class="badge badge-primary" 
id="asignacionesCount">0</span>
      </div>
      <div class="table-container">
        <div id="tblCombo"></div>
      </div>
    </div>
  </div>
  
  <div class="tab-content" id="carga-docente">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Carga por Docente</h3>
        <span class="badge badge-primary" 
id="docentesCount">0</span>
      </div>
      <div class="table-container">
        <div id="tblCarga"></div>
      </div>
    </div>
  </div>
  
  <div class="tab-content" id="resumen-materia">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Resumen por Materia</h3>
        <span class="badge badge-primary" 
id="materiasCount">0</span>
      </div>
      <div class="table-container">
        <div id="tblResumenMateria"></div>
      </div>
    </div>
  </div>
  
  <div class="tab-content" id="no-asignados">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">No Asignados</h3>
        <span class="badge badge-danger" 
id="noAsignadosCount">0</span>
      </div>
      <div class="table-container">
        <div id="tblNo"></div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="matriz-completa">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Matriz Completa de 
Asignaci√≥n</h3>
        <span class="badge badge-primary" 
id="matrizCount">0</span>
      </div>
      <div class="matrix-container">
        <table class="matrix-table" id="tblMatriz">
          <thead>
            <tr>
              <th>DOCENTE</th>
              <th>DEDICACI√ìN</th>
              <th>MATERIA</th>
              <th>C√ìDIGO ANTHOLOGY</th>
              <th>CARRERAS QUE COMPARTEN</th>
              <th>PRE-REQUISITO</th>
              <th>CODIGO</th>
              <th>HORAS TE√ìRICAS</th>
              <th>HORAS PR√ÅCTICAS</th>
              <th>HORAS AUT√ìNOMAS</th>
              <th>CREDITOS</th>
              <th>CAMPO DE FORMACI√ìN</th>
              <th>CICLO</th>
              <th>MALLA</th>
              <th>N¬∫ ORDEN EN LA MALLA</th>
              <th>PARALELO</th>
              <th>DIA</th>
              <th>HORA</th>
              <th>Modalidad</th>
              <th>Nro. HORAS</th>
              <th>NOMBRE DEL ESTUDIANTE</th>
              <th>CARRERA DEL ESTUDIANTE</th>
              <th>CICLO DEL ESTUDIANTE</th>
              <th>NIVEL INGLES</th>
              <th>OBSERVACIONES</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="25" style="text-align: center; padding: 
20px; color: var(--secondary);">
                Cargue los archivos y procese la asignaci√≥n para ver la 
matriz completa
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// ===================== Constantes y Utilidades =====================
let __DOCENTE_SLOTS__ = new Map();
const TARGET7 = ["NOMBRE_DOCENTE","MATERIA","CANTIDAD DE ALUMNOS 
ESPERADOS","DIA","HORA","Modalidad","Paralelo"];
const COMBO9  = [...TARGET7,"ESTUDIANTE","CICLO"];
const DAY_MAP = new Map(Object.entries({
  "lun":"LUNES","lunes":"LUNES","lun.":"LUNES",
  "mar":"MARTES","martes":"MARTES","mar.":"MARTES",
  "mie":"MIERCOLES","mi√©":"MIERCOLES","miercoles":"MIERCOLES","mi√©rcoles":"MIERCOLES","mie.":"MIERCOLES","mi√©.":"MIERCOLES",
  "jue":"JUEVES","jueves":"JUEVES","jue.":"JUEVES",
  "vie":"VIERNES","viernes":"VIERNES","vie.":"VIERNES",
  "sab":"SABADO","s√°b":"SABADO","sabado":"SABADO","s√°bado":"SABADO","sab.":"SABADO",
  "dom":"DOMINGO","domingo":"DOMINGO","dom.":"DOMINGO"
}));

const HORARIOS = [
  "07:00-10:00", "10:00-13:00", "13:00-16:00", 
  "16:00-19:00", "19:00-22:00"
];

function normalizarHorario(horario) {
  if (!horario) return HORARIOS[0];
  const horarioStr = String(horario).toUpperCase().trim();
  if (HORARIOS.includes(horarioStr)) {
    return horarioStr;
  }
  const match = 
horarioStr.match(/(\d{1,2}):(\d{2})\s*[-‚Äìa]+\s*(\d{1,2}):(\d{2})/);
  if (match) {
    const horaInicio = parseInt(match[1],10);
    for (const bloque of HORARIOS) {
      const bloqueMatch = 
bloque.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
      if (bloqueMatch && parseInt(bloqueMatch[1],10) === horaInicio) 
return bloque;
    }
  }
  return HORARIOS[0];
}

const canonDay = s => {
  if (!s) return "";
  const t = String(s).toLowerCase().trim();
  if (DAY_MAP.has(t)) return DAY_MAP.get(t);
  for (const [k, v] of DAY_MAP.entries()) {
    if (t.includes(k)) return v;
  }
  return t.toUpperCase();
};

const esc = s => {
  if (s === null || s === undefined) return "";
  return String(s).replace(/&/g, '&amp;').replace(/</g, 
'&lt;').replace(/>/g, '&gt;');
};

function showError(message) {
  const errorBox = document.getElementById('errorBox');
  const errorMessage = document.getElementById('errorMessage');
  errorMessage.textContent = message;
  errorBox.classList.remove('hidden');
  setTimeout(() => { errorBox.classList.add('hidden'); }, 8000);
}

function showSuccess(message) {
  const alertBox = document.createElement('div');
  alertBox.className = 'alert alert-success fade-in';
  alertBox.innerHTML = `
    <span class="alert-icon">‚úÖ</span>
    <div>${message}</div>
  `;
  document.querySelector('.card').prepend(alertBox);
  setTimeout(() => { alertBox.remove(); }, 5000);
}

function updateProgress(percent) {
  const progressBar = document.getElementById('progressBar');
  const progressContainer = 
document.getElementById('progressContainer');
  progressBar.style.width = percent + '%';
  progressContainer.style.display = 'block';
}

function updateStats(secciones, asignaciones, noAsig, resumenMateria) {
  document.getElementById('statsContainer').style.display = 'grid';
  document.getElementById('statSecciones').textContent = 
secciones.length;
  document.getElementById('statAsignaciones').textContent = 
asignaciones.length;
  document.getElementById('statNoAsignados').textContent = 
noAsig.length;
  
  document.getElementById('asignacionesCount').textContent = 
asignaciones.length;
  document.getElementById('docentesCount').textContent = new 
Set(asignaciones.map(a => a.NOMBRE_DOCENTE)).size;
  document.getElementById('materiasCount').textContent = new 
Set(asignaciones.map(a => a.MATERIA)).size;
  document.getElementById('noAsignadosCount').textContent = 
noAsig.length;
  document.getElementById('matrizCount').textContent = 
asignaciones.length;
  
  let totalCap = 0;
  let totalAsig = 0;
  resumenMateria.forEach(m => { totalCap += m.CAP; totalAsig += 
m.ASIGNADOS; });
  const ocupacionPromedio = totalCap > 0 ? Math.round((totalAsig / 
totalCap) * 100) : 0;
  document.getElementById('statOcupacion').textContent = 
ocupacionPromedio + '%';
}

function validateFiles() {
  const fD = document.getElementById('fileDoc').files[0];
  const fE = document.getElementById('fileEst').files[0];
  const fM = document.getElementById('fileMal').files[0];
  const btnRun = document.getElementById('btnRun');
  btnRun.disabled = !(fD && fE && fM);
}

function updateFileStatus(inputId, statusId, isRequired) {
  const input = document.getElementById(inputId);
  const status = document.getElementById(statusId);
  const icon = status.querySelector('.status-icon');
  input.addEventListener('change', function() {
    if (this.files.length > 0) {
      icon.className = 'status-icon status-success';
      status.querySelector('span:last-child').textContent = 
this.files[0].name;
    } else {
      icon.className = 'status-icon status-pending';
      status.querySelector('span:last-child').textContent = 
isRequired ? 'Esperando archivo...' : 'Opcional - Esperando archivo...';
    }
    validateFiles();
  });
}

function renderTable(el, headers, rows, maxRows = 100) {
  if (!rows || !rows.length) {
    el.innerHTML = '<p class="text-muted text-center">No hay datos
 para mostrar.</p>';
    return;
  }
  const displayRows = rows.slice(0, maxRows);
  const hasMore = rows.length > maxRows;
  let html = `
    <table>
      <thead>
        <tr>${headers.map(h => 
`<th>${esc(h)}</th>`).join('')}</tr>
      </thead>
      <tbody>
  `;
  for (const r of displayRows) {
    html += `<tr>${headers.map(h => `<td>${esc(r[h] ?? 
'')}</td>`).join('')}</tr>`;
  }
  html += `</tbody></table>`;
  if (hasMore) {
    html += `<p class="text-muted text-center">Mostrando 
${maxRows} de ${rows.length} registros. Descargue el archivo para ver 
todos.</p>`;
  }
  el.innerHTML = html;
}

function renderMatrizTable(asignaciones) {
  const el = document.getElementById('tblMatriz');
  const tbody = el.querySelector('tbody');
  if (!asignaciones || !asignaciones.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="25" style="text-align: center; padding: 20px; 
color: var(--secondary);">
          No hay datos para mostrar
        </td>
      </tr>
    `;
    return;
  }
  let html = '';
  for (const r of asignaciones) {
    html += `
      <tr>
        <td>${esc(r.NOMBRE_DOCENTE || '')}</td>
        <td>${esc(r.DEDICACI√ìN || '')}</td>
        <td>${esc(r.MATERIA || '')}</td>
        <td>${esc(r['C√ìDIGO ANTHOLOGY'] || '')}</td>
        <td>${esc(r['CARRERAS QUE COMPARTEN'] || '')}</td>
        <td>${esc(r['PRE-REQUISITO'] || '')}</td>
        <td>${esc(r.CODIGO || '')}</td>
        <td>${esc(r['HORAS TE√ìRICAS'] || '')}</td>
        <td>${esc(r['HORAS PR√ÅCTICAS'] || '')}</td>
        <td>${esc(r['HORAS AUT√ìNOMAS'] || '')}</td>
        <td>${esc(r.CREDITOS || '')}</td>
        <td>${esc(r['CAMPO DE FORMACI√ìN'] || '')}</td>
        <td>${esc(r.CICLO || '')}</td>
        <td>${esc(r.MALLA || '')}</td>
        <td>${esc(r['N¬∫ ORDEN EN LA MALLA'] || '')}</td>
        <td>${esc(r.Paralelo || '')}</td>
        <td>${esc(r.DIA || '')}</td>
        <td>${esc(r.HORA || '')}</td>
        <td>${esc(r.Modalidad || '')}</td>
        <td>${esc(r['Nro. HORAS'] || '')}</td>
        <td>${esc(r.ESTUDIANTE || '')}</td>
        <td>${esc(r['CARRERA DEL ESTUDIANTE'] || '')}</td>
        <td>${esc(r['CICLO DEL ESTUDIANTE'] || '')}</td>
        <td>${esc(r['NIVEL INGLES'] || '')}</td>
        <td>${esc(r.OBSERVACIONES || '')}</td>
      </tr>
    `;
  }
  tbody.innerHTML = html;
}

const readSheet = (file, fileName) => new Promise((resolve, reject) 
=> {
  if (!file) { resolve([]); return; }
  const fr = new FileReader();
  fr.onload = e => {
    try {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      if (!wb.SheetNames || wb.SheetNames.length === 0) {
        reject(new Error(`El archivo ${fileName} no contiene hojas 
v√°lidas.`));
        return;
      }
      const ws = wb.Sheets[wb.SheetNames[0]];
      if (!ws || !ws['!ref']) {
        reject(new Error(`La hoja del archivo ${fileName} est√° 
vac√≠a.`));
        return;
      }
      const jsonData = XLSX.utils.sheet_to_json(ws, { defval: "" });
      if (!jsonData || jsonData.length === 0) {
        reject(new Error(`No se pudieron extraer datos del archivo 
${fileName}. Verifique el formato.`));
        return;
      }
      console.log(`Datos le√≠dos de ${fileName}:`, jsonData);
      resolve(jsonData);
    } catch (error) {
      console.error(`Error leyendo archivo ${fileName}:`, error);
      reject(new Error(`Error al leer el archivo ${fileName}: 
${error.message}`));
    }
  };
  fr.onerror = () => { reject(new Error(`Error al leer el archivo 
${fileName}.`)); };
  fr.readAsArrayBuffer(file);
});

function normalizeDocentes(rows) {
  console.log("Normalizando docentes:", rows);
  if (!rows || !rows.length) {
    showError("El archivo de docentes est√° vac√≠o o no tiene el formato 
correcto.");
    return [];
  }
  const result = rows.map(r => {
    let diasDisponibles = [];
    let horasDisponibles = [];
    if (r["DIA DISPONIBLE"] || r["DIA"]) {
      const textoDias = String(r["DIA DISPONIBLE"] || r["DIA"] || 
"").toUpperCase();
      if (textoDias.includes("LUNES")) diasDisponibles.push("LUNES");
      if (textoDias.includes("MARTES")) diasDisponibles.push("MARTES");
      if (textoDias.includes("MIERCOLES") || 
textoDias.includes("MI√âRCOLES")) diasDisponibles.push("MIERCOLES");
      if (textoDias.includes("JUEVES")) diasDisponibles.push("JUEVES");
      if (textoDias.includes("VIERNES")) 
diasDisponibles.push("VIERNES");
      if (textoDias.includes("SABADO") || textoDias.includes("S√ÅBADO")) 
diasDisponibles.push("SABADO");
    }
    if (r["HORA DISPONIBLE"] || r["HORA"]) {
      const textoHoras = String(r["HORA DISPONIBLE"] || r["HORA"] || 
"").toUpperCase();
      const horaMatch = 
textoHoras.match(/(\d{1,2}):(\d{2})\s*[-‚Äìa]+\s*(\d{1,2}):(\d{2})/);
      if (horaMatch) {
        const rango = 
`${horaMatch[1].padStart(2,'0')}:${horaMatch[2]}-${horaMatch[3].padStart(2,'0')}:${horaMatch[4]}`;
        horasDisponibles.push(normalizarHorario(rango));
      } else if (textoHoras.includes("07:00") && 
textoHoras.includes("22:00")) {
        horasDisponibles = [...HORARIOS];
      } else {
        horasDisponibles = [...HORARIOS];
      }
    }
    if (diasDisponibles.length === 0) diasDisponibles = ["LUNES", 
"MARTES", "MIERCOLES", "JUEVES", "VIERNES"];
    return {
      "NOMBRE_DOCENTE": r["NOMBRE_DOCENTE"] || r["DOCENTE"] || "",
      "MATERIA": r["MATERIA"] || r["MATERIAS"] || "",
      "CANTIDAD DE ALUMNOS ESPERADOS": Number(r["CANTIDAD DE ALUMNOS 
ESPERADOS"] || r["CAPACIDAD"] || r["CUPOS"] || 25) || 25,
      "DIA_DISPONIBLE": diasDisponibles,
      "HORA_DISPONIBLE": horasDisponibles,
      "Modalidad": r["Modalidad"] || "PRESENCIAL",
      "Paralelo": String(r["Paralelo"] || "").toUpperCase().trim() || 
"A",
      "DEDICACI√ìN": r["DEDICACI√ìN"] || ""
    };
  }).filter(x => x.MATERIA && x.NOMBRE_DOCENTE);
  console.log("Docentes normalizados:", result);
  if (result.length === 0) showError("No se encontraron datos v√°lidos en
 el archivo de docentes.");
  return result;
}

function normalizeEstudiantes(rows) {
  console.log("Normalizando estudiantes:", rows);
  if (!rows || !rows.length) {
    showError("El archivo de estudiantes est√° vac√≠o o no tiene el 
formato correcto.");
    return [];
  }
  const result = rows.map(r => {
    const ciclo = Number(r["CICLO AL QUE VA"] || r["CICLO ACTUAL"] || 
r["CICLO"] || 1);
    return {
      "ESTUDIANTE": r["ESTUDIANTE"] || r["NOMBRE"] || r["NOMBRE DEL 
ESTUDIANTE"] || "",
      "CICLO": isNaN(ciclo) ? 1 : Math.max(1, Math.min(8, ciclo)),
      "CARRERA": r["CARRERA"] || r["CARRERA DEL ESTUDIANTE"] || "",
      "MALLA": r["MALLA"] || "",
      "NIVEL INGLES": r["NIVEL INGLES"] || ""
    };
  }).filter(x => x.ESTUDIANTE && x.CICLO);
  console.log("Estudiantes normalizados:", result);
  if (result.length === 0) showError("No se encontraron datos v√°lidos en
 el archivo de estudiantes.");
  return result;
}

function normalizeMalla(rows) {
  console.log("Normalizando malla:", rows);
  if (!rows || !rows.length) {
    showError("El archivo de malla est√° vac√≠o o no tiene el formato 
correcto.");
    return [];
  }
  const result = rows.map(r => {
    const ciclo = Number(r["CICLO"] || r["NIVEL"] || 1);
    return {
      "MATERIA": r["MATERIA"] || r["ASIGNATURA"] || "",
      "CICLO": isNaN(ciclo) ? 1 : Math.max(1, Math.min(8, ciclo)),
      "C√ìDIGO ANTHOLOGY": r["C√ìDIGO ANTHOLOGY"] || r["CODIGO ANTHOLOGY"] 
|| "",
      "CARRERAS QUE COMPARTEN": r["CARRERAS QUE COMPARTEN"] || "",
      "PRE-REQUISITO": r["PRE-REQUISITO"] || "",
      "CODIGO": r["CODIGO"] || "",
      "HORAS TE√ìRICAS": Number(r["HORAS TE√ìRICAS"]) || 0,
      "HORAS PR√ÅCTICAS": Number(r["HORAS PR√ÅCTICAS"]) || 0,
      "HORAS AUT√ìNOMAS": Number(r["HORAS AUT√ìNOMAS"]) || 0,
      "CREDITOS": Number(r["CREDITOS"]) || 0,
      "CAMPO DE FORMACI√ìN": r["CAMPO DE FORMACI√ìN"] || "",
      "MALLA": r["MALLA"] || "",
      "N¬∫ ORDEN EN LA MALLA": r["N¬∫ ORDEN EN LA MALLA"] || ""
    };
  }).filter(x => x.MATERIA && x.CICLO);
  console.log("Malla normalizada:", result);
  if (result.length === 0) showError("No se encontraron datos v√°lidos en
 el archivo de malla.");
  return result;
}

// ===================== L√≥gica de Asignaci√≥n (NUEVA) =====================
function asignar(docentes, estudiantes, malla) {
  updateProgress(10);
  console.log("Iniciando proceso de asignaci√≥n...");
  
  const MAX_MATERIAS_ESTUDIANTE = Number(document.getElementById("maxMaterias").value);
  const CAPACIDAD_PARALELO = Number(document.getElementById("capacidadParalelo").value);

  // 1. Estructuras de datos para la planificaci√≥n
  const secciones = [];
  const asignacionesFinales = [];
  const estudiantesAsignados = new Set();
  const noAsignados = [];

  // Agrupar estudiantes por ciclo al que van
  const estudiantesPorCiclo = estudiantes.reduce((acc, est) => {
    if (!acc[est.CICLO]) acc[est.CICLO] = [];
    acc[est.CICLO].push(est);
    return acc;
  }, {});
  
  // Agrupar materias de la malla por ciclo
  const materiasPorCiclo = malla.reduce((acc, mat) => {
    if (!acc[mat.CICLO]) acc[mat.CICLO] = [];
    acc[mat.CICLO].push(mat);
    return acc;
  }, {});

  // Agrupar docentes por materia y crear un mapa para la disponibilidad
  const docentesPorMateria = docentes.reduce((acc, doc) => {
    if (!acc[doc.MATERIA]) acc[doc.MATERIA] = [];
    acc[doc.MATERIA].push(doc);
    return acc;
  }, {});
  
  const docenteDisponibilidad = new Map();
  docentes.forEach(doc => {
    docenteDisponibilidad.set(doc.NOMBRE_DOCENTE, new Map());
    doc.DIA_DISPONIBLE.forEach(dia => {
      docenteDisponibilidad.get(doc.NOMBRE_DOCENTE).set(dia, new 
Set(doc.HORA_DISPONIBLE));
    });
  });

  updateProgress(30);

  // 2. Crear las secciones (paralelos) para cada materia y asignar docentes
  console.log("Creando secciones y asignando docentes...");
  const seccionesPorMateria = {};
  let paraleloCounter = 1;

  for (const ciclo in materiasPorCiclo) {
    const materiasDelCiclo = materiasPorCiclo[ciclo];
    let horariosOcupadosCiclo = new Set(); // Para evitar cruces en el mismo ciclo
    let docenteHorariosOcupados = new Map();

    for (const materia of materiasDelCiclo) {
      // Buscar un docente disponible
      const docentesCandidatos = docentesPorMateria[materia.MATERIA] || [];
      
      let seccionCreada = false;
      for (const docente of docentesCandidatos) {
        let docenteNombre = docente.NOMBRE_DOCENTE;
        
        // Inicializar horarios ocupados del docente si no existe
        if (!docenteHorariosOcupados.has(docenteNombre)) {
          docenteHorariosOcupados.set(docenteNombre, new Set());
        }

        // Encontrar un d√≠a y hora disponibles
        let horarioAsignado = null;
        for (const dia of docente.DIA_DISPONIBLE) {
          for (const hora of docente.HORA_DISPONIBLE) {
            const slot = `${dia}-${hora}`;
            
            // Verificar si el slot no est√° ocupado por otra materia del mismo ciclo
            // y si el docente est√° disponible en ese slot
            if (!horariosOcupadosCiclo.has(slot) && 
                !docenteHorariosOcupados.get(docenteNombre).has(slot)) {
              horarioAsignado = { dia, hora };
              break;
            }
          }
          if (horarioAsignado) break;
        }

        if (horarioAsignado) {
          const seccion = {
            ...materia,
            NOMBRE_DOCENTE: docente.NOMBRE_DOCENTE,
            DEDICACI√ìN: docente.DEDICACI√ìN,
            Modalidad: docente.Modalidad,
            Paralelo: `P${paraleloCounter++}`,
            DIA: horarioAsignado.dia,
            HORA: horarioAsignado.hora,
            'Nro. HORAS': materia['HORAS TE√ìRICAS'] + 
materia['HORAS PR√ÅCTICAS'],
            'ESTUDIANTES_ASIGNADOS': [],
            CAPACIDAD_MAXIMA: CAPACIDAD_PARALELO
          };
          secciones.push(seccion);
          if (!seccionesPorMateria[materia.MATERIA]) {
            seccionesPorMateria[materia.MATERIA] = [];
          }
          seccionesPorMateria[materia.MATERIA].push(seccion);
          
          horariosOcupadosCiclo.add(`${horarioAsignado.dia}-${horarioAsignado.hora}`);
          docenteHorariosOcupados.get(docente.NOMBRE_DOCENTE).add(`${horarioAsignado.dia}-${horarioAsignado.hora}`);
          seccionCreada = true;
          break; // Salir del bucle de docentes
        }
      }
      if (!seccionCreada) {
        console.warn(`No se pudo crear una secci√≥n para la materia 
${materia.MATERIA}.`);
      }
    }
  }

  updateProgress(60);

  // 3. Asignar estudiantes a las secciones
  console.log("Asignando estudiantes a las secciones...");
  for (const ciclo in estudiantesPorCiclo) {
    const estudiantesDelCiclo = estudiantesPorCiclo[ciclo];
    const materiasDelCiclo = secciones.filter(s => s.CICLO == ciclo);
    
    for (const estudiante of estudiantesDelCiclo) {
      if (estudiantesAsignados.has(estudiante.ESTUDIANTE)) continue;
      
      const materiasAsignadas = [];
      const estudianteHorario = new Set();
      
      for (const materia of materiasDelCiclo) {
        if (materiasAsignadas.length >= MAX_MATERIAS_ESTUDIANTE) break;
        
        // Verificar si el estudiante ya tiene una materia en ese horario
        const slot = `${materia.DIA}-${materia.HORA}`;
        if (estudianteHorario.has(slot)) continue;
        
        // Encontrar una secci√≥n disponible para la materia
        let seccionDisponible = seccionesPorMateria[materia.MATERIA]?.find(
          s => s.ESTUDIANTES_ASIGNADOS.length < s.CAPACIDAD_MAXIMA
        );
        
        if (seccionDisponible) {
          seccionDisponible.ESTUDIANTES_ASIGNADOS.push(estudiante);
          materiasAsignadas.push(materia);
          estudianteHorario.add(slot);
        }
      }

      if (materiasAsignadas.length > 0) {
        estudiantesAsignados.add(estudiante.ESTUDIANTE);
        for (const materia of materiasAsignadas) {
          asignacionesFinales.push({
            ...materia,
            ESTUDIANTE: estudiante.ESTUDIANTE,
            'CARRERA DEL ESTUDIANTE': estudiante.CARRERA,
            'CICLO DEL ESTUDIANTE': estudiante.CICLO,
            'NIVEL INGLES': estudiante['NIVEL INGLES']
          });
        }
      } else {
        noAsignados.push({
          ESTUDIANTE: estudiante.ESTUDIANTE,
          'CARRERA DEL ESTUDIANTE': estudiante.CARRERA,
          'CICLO DEL ESTUDIANTE': estudiante.CICLO,
          'OBSERVACIONES': 'No se encontraron secciones disponibles.'
        });
      }
    }
  }

  // Estudiantes que no fueron asignados
  const estudiantesSinAsignacion = estudiantes.filter(e => 
!estudiantesAsignados.has(e.ESTUDIANTE));
  estudiantesSinAsignacion.forEach(e => {
    noAsignados.push({
      ESTUDIANTE: e.ESTUDIANTE,
      'CARRERA DEL ESTUDIANTE': e.CARRERA,
      'CICLO DEL ESTUDIANTE': e.CICLO,
      'OBSERVACIONES': 'No se encontraron materias disponibles para su ciclo.'
    });
  });

  updateProgress(80);

  // 4. Generar reportes
  const resumenMateria = secciones.map(s => ({
    "MATERIA": s.MATERIA,
    "DOCENTE": s.NOMBRE_DOCENTE,
    "CICLO": s.CICLO,
    "PARALELO": s.Paralelo,
    "CAP": s.CAPACIDAD_MAXIMA,
    "ASIGNADOS": s.ESTUDIANTES_ASIGNADOS.length,
    "DIA": s.DIA,
    "HORA": s.HORA
  }));
  
  const cargaDocente = docentes.map(doc => {
    const materiasAsignadas = asignacionesFinales.filter(a => 
a.NOMBRE_DOCENTE === doc.NOMBRE_DOCENTE);
    const numMaterias = new Set(materiasAsignadas.map(a => 
a.MATERIA)).size;
    const numAlumnos = new Set(materiasAsignadas.map(a => 
a.ESTUDIANTE)).size;
    return {
      "NOMBRE_DOCENTE": doc.NOMBRE_DOCENTE,
      "DEDICACI√ìN": doc.DEDICACI√ìN,
      "MATERIAS ASIGNADAS": numMaterias,
      "ALUMNOS ASIGNADOS": numAlumnos
    };
  });

  updateProgress(100);
  
  return {
    secciones,
    asignacionesFinales,
    resumenMateria,
    cargaDocente,
    noAsignados
  };
}

// ===================== Manejadores de Eventos =====================
let dataDocentes = [];
let dataEstudiantes = [];
let dataMalla = [];
let processedData = null;

async function handleRun() {
  const btnRun = document.getElementById('btnRun');
  const btnDown = document.getElementById('btnDown');
  const mainCard = document.querySelector('.card');

  btnRun.disabled = true;
  btnRun.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
stroke-linecap="round" stroke-linejoin="round" class="animate-spin">
      <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
    </svg>
    Procesando...
  `;
  mainCard.classList.add('loading');
  document.getElementById('progressContainer').style.display = 'block';

  try {
    const fileDoc = document.getElementById('fileDoc').files[0];
    const fileEst = document.getElementById('fileEst').files[0];
    const fileMal = document.getElementById('fileMal').files[0];

    dataDocentes = await readSheet(fileDoc, 'DOCENTES.xlsx');
    dataEstudiantes = await readSheet(fileEst, 'ESTUDIANTES.xlsx');
    dataMalla = await readSheet(fileMal, 'MALLA.xlsx');

    const normalizedDocentes = normalizeDocentes(dataDocentes);
    const normalizedEstudiantes = normalizeEstudiantes(dataEstudiantes);
    const normalizedMalla = normalizeMalla(dataMalla);

    if (normalizedDocentes.length === 0 || 
        normalizedEstudiantes.length === 0 || 
        normalizedMalla.length === 0) {
      throw new Error("No se pudieron procesar los archivos. Verifique 
los datos y reintente.");
    }
    
    processedData = asignar(normalizedDocentes, normalizedEstudiantes, 
normalizedMalla);
    
    if (processedData.asignacionesFinales.length > 0) {
      showSuccess('¬°Asignaci√≥n completada exitosamente!');
    } else {
      showError('El proceso de asignaci√≥n finaliz√≥, pero no se pudo asignar a ning√∫n estudiante.');
    }
    
    renderResults(processedData);
    
    btnDown.classList.remove('hidden');
    updateProgress(100);
  } catch (error) {
    console.error(error);
    showError(`Ha ocurrido un error durante el procesamiento: ${error.message}`);
    updateProgress(0);
  } finally {
    btnRun.disabled = false;
    btnRun.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
      Procesar Asignaci√≥n
    `;
    mainCard.classList.remove('loading');
  }
}

function renderResults(data) {
  const { asignacionesFinales, resumenMateria, cargaDocente, 
noAsignados, secciones } = data;
  
  // Render tables
  const asignacionHeaders = ["ESTUDIANTE", "MATERIA", "CICLO", 
"NOMBRE_DOCENTE", "Paralelo", "DIA", "HORA"];
  renderTable(document.getElementById('tblCombo'), asignacionHeaders, 
asignacionesFinales);
  
  const cargaHeaders = ["NOMBRE_DOCENTE", "DEDICACI√ìN", "MATERIAS 
ASIGNADAS", "ALUMNOS ASIGNADOS"];
  renderTable(document.getElementById('tblCarga'), cargaHeaders, 
cargaDocente);
  
  const resumenHeaders = ["MATERIA", "DOCENTE", "CICLO", "PARALELO", 
"CAP", "ASIGNADOS", "DIA", "HORA"];
  renderTable(document.getElementById('tblResumenMateria'), 
resumenHeaders, resumenMateria);
  
  const noAsignadosHeaders = ["ESTUDIANTE", "CARRERA DEL ESTUDIANTE", 
"CICLO DEL ESTUDIANTE", "OBSERVACIONES"];
  renderTable(document.getElementById('tblNo'), noAsignadosHeaders, 
noAsignados);
  
  renderMatrizTable(asignacionesFinales);
  
  updateStats(secciones, asignacionesFinales, noAsignados, 
resumenMateria);
}

function handleDownload() {
  if (!processedData) {
    showError("No hay datos para descargar. Por favor, procese la asignaci√≥n 
primero.");
    return;
  }

  const wb = XLSX.utils.book_new();

  // Hoja de Asignaciones
  const wsAsignaciones = XLSX.utils.json_to_sheet(processedData.asignacionesFinales);
  XLSX.utils.book_append_sheet(wb, wsAsignaciones, "Asignaciones");

  // Hoja de Resumen por Materia
  const wsResumen = XLSX.utils.json_to_sheet(processedData.resumenMateria);
  XLSX.utils.book_append_sheet(wb, wsResumen, "Resumen por Materia");

  // Hoja de Carga Docente
  const wsCarga = XLSX.utils.json_to_sheet(processedData.cargaDocente);
  XLSX.utils.book_append_sheet(wb, wsCarga, "Carga Docente");

  // Hoja de No Asignados
  const wsNoAsignados = XLSX.utils.json_to_sheet(processedData.noAsignados);
  XLSX.utils.book_append_sheet(wb, wsNoAsignados, "No Asignados");
  
  // Guardar el archivo
  XLSX.writeFile(wb, "Planificacion_Academica.xlsx");
}

function handleTabs() {
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });
}

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', () => {
  updateFileStatus('fileDoc', 'statusDoc', true);
  updateFileStatus('fileEst', 'statusEst', true);
  updateFileStatus('fileMal', 'statusMal', true);
  document.getElementById('btnRun').addEventListener('click', handleRun);
  document.getElementById('btnDown').addEventListener('click', handleDownload);
  handleTabs();
});
</script>
</body>
</html>
