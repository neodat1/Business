<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matriz UIDE</title>

<!-- XLSX: estable, sin SRI -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

<style>
:root{
  --azul:#04136C; --mostaza:#DE912E; --vino:#862B39; --celeste:#9CBEE3; --verde:#8A9520;
}
*{box-sizing:border-box}
body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:#f6f7fb; color:#17223b}
header{display:flex; align-items:center; gap:14px; padding:12px 16px; background:var(--azul); border-bottom:4px solid var(--mostaza)}
.logo{background:#fff; border-radius:12px; padding:6px 10px; box-shadow:0 2px 10px rgba(0,0,0,.2)}
.logo img{height:46px}
.h1{color:#fff; font-weight:700; font-size:1.1rem; letter-spacing:.2px}

.container{padding:14px 16px}
.card{background:#fff; border:1px solid #e7e9f0; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,.05); padding:14px 14px; margin-bottom:14px}

.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
input[type=file]{padding:10px; border:1px dashed var(--azul); border-radius:10px; background:#f1f5ff}
.btn{border:0; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer}
.btn-primary{background:var(--vino); color:#fff}
.btn-alt{background:var(--verde); color:#fff}
.btn-ghost{background:#eef3ff; color:var(--azul); font-weight:700}
.badge{display:inline-block; background:#eef4ff; color:#0b2b8e; padding:3px 8px; border-radius:999px; font-weight:700; font-size:.8rem}

table{width:100%; border-collapse:separate; border-spacing:0}
thead th{position:sticky; top:0; background:var(--azul); color:#fff; padding:10px; font-size:.9rem}
thead th:first-child{border-top-left-radius:10px}
thead th:last-child{border-top-right-radius:10px}
tbody td{padding:9px 10px; border-bottom:1px solid #eef1f6; background:#fff; font-size:.94rem}
tbody tr:nth-child(even) td{background:#fbfcff}
tbody tr.assigned td{border-left:4px solid var(--verde)}
tbody tr.conflict td{border-left:4px solid var(--vino); background:#fff5f5}

.footer{padding:10px 2px; color:#6a7996; font-size:.85rem; text-align:center}

.toast{position:fixed; right:16px; bottom:16px; min-width:280px; max-width:360px; background:#1f2937; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.25); display:none}
.toast.ok{background:#0f5132}
.toast.warn{background:#664d03}
.toast.err{background:#842029}
.toast .title{font-weight:800; margin-bottom:4px}
.toast.show{display:block; animation:fade .2s ease}
@keyframes fade{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}
</style>
</head>
<body>

<header>
  <div class="logo"><img src="UIDE-Ecuador.png" alt="UIDE"></div>
  <div class="h1">Planificador de Horarios – UIDE</div>
</header>

<div class="container">

  <div class="card">
    <div class="row">
      <input id="fileInput" type="file" accept=".xlsx,.xls" multiple />
      <button id="btnRun" class="btn btn-primary">Asignar</button>
      <button id="btnExport" class="btn btn-alt" disabled>Exportar</button>
      <span id="info" class="badge">0 filas</span>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between; margin-bottom:8px">
      <div class="badge">DOCENTE · MATERIA · ESTUDIANTES · PARALELO · DÍA · HORA</div>
      <div class="row" style="gap:6px">
        <span class="badge" style="background:#e6f6ee; color:#0f5132" id="kOk">OK: 0</span>
        <span class="badge" style="background:#fff3cd; color:#664d03" id="kWarn">Paralelos: 0</span>
        <span class="badge" style="background:#fde2e1; color:#842029" id="kErr">Conflictos: 0</span>
      </div>
    </div>
    <div style="overflow:auto">
      <table id="tabla">
        <thead>
          <tr>
            <th>DOCENTE</th><th>MATERIA</th><th>ESTUDIANTES</th>
            <th>PARALELO</th><th>DÍA</th><th>HORA</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="footer">Paleta: Azul #04136C · Mostaza #DE912E · Vino #862B39 · Celeste #9CBEE3 · Verde #8A9520</div>
</div>

<div id="toast" class="toast"><div class="title"></div><div class="msg"></div></div>

<script>
/* ======= Helpers UI ======= */
const toast = (type, title, msg) => {
  const t = document.getElementById('toast');
  t.className = `toast ${type} show`;
  t.querySelector('.title').textContent = title || '';
  t.querySelector('.msg').textContent = msg || '';
  setTimeout(()=>{ t.classList.remove('show'); }, 4500);
};
const setCounts = (ok, par, err) => {
  document.getElementById('kOk').textContent = `OK: ${ok}`;
  document.getElementById('kWarn').textContent = `Paralelos: ${par}`;
  document.getElementById('kErr').textContent = `Conflictos: ${err}`;
};

/* ======= Normalización ======= */
const normalize = (s='') => (s||'').toString()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
  .replace(/\s+/g,' ').trim().toUpperCase();
const parseIntSafe = v => {
  const n = parseInt(String(v).replace(/[^\d]/g,''),10);
  return Number.isFinite(n) ? n : null;
};

/* ======= Dominio ======= */
const DAYS = ["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES"];
const TIME_SLOTS = ["07:00-10:00","10:00-13:00","13:00-16:00","16:00-19:00","19:00-22:00"];

/* Horas: soporta “a-b”, “a A b” y “solo HH:MM” */
function slotsFromRange(raw){
  if(!raw) return [];
  const txt = normalize(raw).replace(/\s*A\s*/g,'-');
  // Caso único "HH:MM"
  const only = txt.match(/^(\d{2}:\d{2})$/);
  if(only){
    const t = only[1];
    return TIME_SLOTS.filter(s=>{
      const [a,b]=s.split('-'); return (t>=a && t<=b);
    });
  }
  // Rango "HH:MM-HH:MM"
  const m = txt.match(/(\d{2}:\d{2})-(\d{2}:\d{2})/);
  if(!m) return [];
  const [_,a,b] = m;
  const slots=[];
  for(const slot of TIME_SLOTS){
    const [s,e]=slot.split('-');
    if(s>=a && e<=b) slots.push(slot);
  }
  return slots.length ? slots : [...TIME_SLOTS];
}

/* Días: “LUNES A VIERNES”, “MARTES Y MIERCOLES”, “VIERNES” */
function expandDays(txt){
  const t = normalize(txt);
  if(!t) return [];
  if(t.includes("A VIERNES")){
    const m = t.match(/(LUNES|MARTES|MIERCOLES|JUEVES|VIERNES)/);
    const start = m ? DAYS.indexOf(m[1]) : 0;
    return DAYS.slice(start);
  }
  if(t.includes("A ")){
    const m = t.match(/(LUNES|MARTES|MIERCOLES|JUEVES|VIERNES)\s*A\s*(LUNES|MARTES|MIERCOLES|JUEVES|VIERNES)/);
    if(m){
      const a=DAYS.indexOf(m[1]), b=DAYS.indexOf(m[2]);
      if(a>=0 && b>=a) return DAYS.slice(a,b+1);
    }
  }
  const parts = t.split(/[,/]| Y /g).map(s=>s.trim()).filter(Boolean);
  const out=[]; for(const d of parts){ if(DAYS.includes(d)) out.push(d); }
  return out.length ? out : DAYS;
}
function daysRestrictions(txt){
  if(!txt) return new Set();
  const t = normalize(txt), set = new Set();
  for(const d of DAYS){ if(t.includes(d)) set.add(d); }
  return set;
}

/* ======= Lectura Excel (robusta: varias hojas) ======= */
async function readAll(files){
  const all=[];
  for(const f of files){
    try{
      const buf = await f.arrayBuffer();
      const wb = XLSX.read(buf,{type:'array'});
      for(const name of wb.SheetNames){
        const ws = wb.Sheets[name];
        const json = XLSX.utils.sheet_to_json(ws,{defval:""});
        all.push(...json);
      }
    }catch(e){
      console.error('Error leyendo', f.name, e);
      toast('err','Archivo inválido', `No se pudo leer: ${f.name}`);
    }
  }
  return all;
}

/* ======= Normalización de columnas ======= */
function mapRow(r){
  const dict={}; for(const [k,v] of Object.entries(r)){ dict[normalize(k)] = v; }
  const get=(...keys)=>{ for(const k of keys){ const kk=normalize(k); if(kk in dict) return dict[kk]; } return ""; };
  const docente = String(get('DOCENTE')).trim();
  const materia = String(get('MATERIA')).trim();
  const diaDisp = String(get('DIA DISPONIBLE','DIAS DISPONIBLES','DIA')).trim();
  const horaDisp = String(get('HORA DISPONIBLE','HORARIO DISPONIBLE','HORA')).trim();
  const est = parseIntSafe(get('ESTUDIANTES','N ESTUDIANTES','NUM ESTUDIANTES')) ?? 0;

  const restr = get('RESTRICCIONES','DIAS RESTRINGIDOS','DIA RESTRICCION');
  const cicloA = get('CICLO DEL ESTUDIANTE','CICLO ESTUDIANTE','CICLO');
  const cicloM = get('CICLO DE LA MATERIA EN LA MALLA','CICLO MATERIA');

  return {
    docente, materia, estudiantes: est,
    diasDisponibles: expandDays(diaDisp),
    slotsDisponibles: slotsFromRange(horaDisp),
    restrDias: daysRestrictions(restr),
    ciclo: (()=>{ const c=parseIntSafe(cicloM)||parseIntSafe(cicloA); return Number.isFinite(c)?c:null; })()
  };
}

/* ======= Asignación ======= */
function planificar(items){
  const usoDocente = new Map();           // docente -> (dia -> count) (max 2)
  const ocupacion = new Set();            // "docente|dia|slot"
  const ocupacionMateria = new Set();     // "materia|dia|slot"
  const ciclosSlot = new Map();           // "dia|slot" -> Set(ciclos)
  const out=[];

  const puede = (docente, matKey, dia, slot, ciclo) => {
    const m = usoDocente.get(docente) || new Map();
    if((m.get(dia)||0) >= 2) return false;
    if(ocupacion.has(`${docente}|${dia}|${slot}`)) return false;
    if(ocupacionMateria.has(`${matKey}|${dia}|${slot}`)) return false;
    if(ciclo!=null){
      const set = ciclosSlot.get(`${dia}|${slot}`) || new Set();
      for(const c of set){ if(Math.abs(c - ciclo) === 1) return false; }
    }
    return true;
  };
  const colocar = (docente, matKey, dia, slot, ciclo) => {
    const m = usoDocente.get(docente) || new Map();
    m.set(dia,(m.get(dia)||0)+1); usoDocente.set(docente,m);
    ocupacion.add(`${docente}|${dia}|${slot}`);
    ocupacionMateria.add(`${matKey}|${dia}|${slot}`);
    if(ciclo!=null){
      const key=`${dia}|${slot}`, set=ciclosSlot.get(key)||new Set(); set.add(ciclo); ciclosSlot.set(key,set);
    }
  };

  // Heurística: menos opciones primero
  items.sort((a,b)=>{
    const A=(a.diasDisponibles.length||5)*(a.slotsDisponibles.length||5);
    const B=(b.diasDisponibles.length||5)*(b.slotsDisponibles.length||5);
    return A-B;
  });

  let creadosParalelos=0, conflictos=0, ok=0;

  for(const it of items){
    const matKey = normalize(it.materia||"(SIN MATERIA)");
    const total = Math.max(1, Math.ceil((it.estudiantes||0)/26));
    if(total>1) creadosParalelos += (total-1);
    const sizes=[]; let rest=it.estudiantes||0;
    for(let i=0;i<total;i++){ const s=Math.min(26,Math.max(0,rest)); sizes.push(s||(i===0?0:s)); rest=Math.max(0,rest-26); }

    const dias = (it.diasDisponibles||[]).filter(d=>!it.restrDias.has(d));
    const slots = (it.slotsDisponibles&&it.slotsDisponibles.length)? it.slotsDisponibles : [...TIME_SLOTS];
    const diasTry = dias.length? dias : [...DAYS];

    for(let p=0;p<total;p++){
      let asignado=false;
      outer:
      for(const d of diasTry){
        for(const s of slots){
          if(puede(it.docente,matKey,d,s,it.ciclo)){
            colocar(it.docente,matKey,d,s,it.ciclo);
            out.push({docente:it.docente, materia:it.materia, estudiantes:sizes[p]||it.estudiantes||0,
              paralelo:String(p+1).padStart(2,'0'), dia:d, hora:s, assigned:true});
            ok++; asignado=true; break outer;
          }
        }
      }
      if(!asignado){
        out.push({docente:it.docente, materia:it.materia, estudiantes:sizes[p]||it.estudiantes||0,
          paralelo:String(p+1).padStart(2,'0'), dia:"SIN ESPACIO", hora:"—", assigned:false});
        conflictos++;
      }
    }
  }
  setCounts(ok, creadosParalelos, conflictos);
  return out;
}

/* ======= Render ======= */
function render(rows){
  const tb=document.querySelector('#tabla tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr'); tr.className = r.assigned?'assigned':'conflict';
    const td=v=>{const x=document.createElement('td'); x.textContent=v; return x;};
    tr.append(td(r.docente||''), td(r.materia||''), td(r.estudiantes??0),
             td(r.paralelo||''), td(r.dia||''), td(r.hora||''));
    tb.appendChild(tr);
  });
  document.getElementById('info').textContent = `${rows.length} filas`;
  document.getElementById('btnExport').disabled = rows.length===0;
}

/* ======= Exportar ======= */
function exportXLSX(rows){
  const ws = XLSX.utils.json_to_sheet(rows.map(r=>({
    DOCENTE:r.docente, MATERIA:r.materia, ESTUDIANTES:r.estudiantes,
    PARALELO:r.paralelo, DIA:r.dia, HORA:r.hora
  })));
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Matriz');
  XLSX.writeFile(wb, 'Matriz_UIDE.xlsx');
}

/* ======= Flujo ======= */
document.getElementById('btnRun').addEventListener('click', async ()=>{
  const fi = document.getElementById('fileInput');
  if(!fi.files.length){ toast('warn','Falta archivo','Seleccione al menos un Excel.'); return; }
  const raw = await readAll(fi.files);
  if(!raw.length){ toast('err','Sin datos','No se encontraron filas. Verifique las hojas.'); return; }

  // Verificación rápida de columnas obligatorias
  const keys = Object.keys(raw[0]||{}).map(k=>normalize(k));
  const need = ['DOCENTE','MATERIA','DIA DISPONIBLE','HORA DISPONIBLE','ESTUDIANTES'];
  const hasSome = (aliases)=>aliases.some(a=>keys.includes(normalize(a)));
  if(!hasSome(['DOCENTE']) || !hasSome(['MATERIA']) || !hasSome(['DIA DISPONIBLE','DIAS DISPONIBLES','DIA'])
     || !hasSome(['HORA DISPONIBLE','HORARIO DISPONIBLE','HORA']) || !hasSome(['ESTUDIANTES','N ESTUDIANTES','NUM ESTUDIANTES'])){
    toast('err','Encabezados inválidos','Revise nombres de columnas requeridas.');
    return;
  }

  try{
    const items = raw.map(mapRow).filter(r=>r.docente && r.materia);
    const out = planificar(items);
    render(out);
    toast('ok','Listo','Asignación generada.');
  }catch(e){
    console.error(e);
    toast('err','Error','No se pudo procesar. Revise la consola.');
  }
});

document.getElementById('btnExport').addEventListener('click', ()=>{
  const rows=[];
  document.querySelectorAll('#tabla tbody tr').forEach(tr=>{
    const c=t=>tr.children[t].textContent;
    rows.push({docente:c(0), materia:c(1), estudiantes:+c(2)||0, paralelo:c(3), dia:c(4), hora:c(5)});
  });
  if(!rows.length){ toast('warn','Sin datos','Nada que exportar.'); return; }
  exportXLSX(rows);
});
</script>
</body>
</html>
