<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Extractor Universal Académico (Excel)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial; margin: 30px;}
    .btn { background: #35558a; color: #fff; padding: 8px 18px; border: none; border-radius: 8px; cursor: pointer;}
    .container { background: #fafafa; border-radius: 8px; padding: 18px 28px; box-shadow: 0 0 8px #bbb; max-width: 1100px; margin: auto;}
    h2 { color: #932432; }
    table { border-collapse: collapse; width: 100%; margin: 22px 0;}
    th, td { border: 1px solid #ccc; padding: 6px;}
    th { background: #932432; color: #fff;}
    tr:nth-child(even) { background: #f7f7f7;}
    .block { margin-top: 32px;}
  </style>
</head>
<body>
<div class="container">
  <h2>Extractor Universal Académico (Mallas, Docentes, Estudiantes, Créditos)</h2>
  <p>Sube <b>uno o varios archivos Excel</b> de mallas, planificación, docentes o estudiantes. El sistema detecta los datos y los muestra por separado.</p>
  <input type="file" id="fileInput" accept=".xlsx" multiple class="btn">
  <button class="btn" onclick="descargarTodo()">Descargar todo (Excel consolidado)</button>
  
  <div id="resultados"></div>
</div>

<script>
let materias=[], docentes=[], estudiantes=[], creditos=[];

document.getElementById('fileInput').addEventListener('change', function(e){
  materias=[]; docentes=[]; estudiantes=[]; creditos=[];
  document.getElementById('resultados').innerHTML = "Procesando...";
  const files = e.target.files;
  let filesProcessed = 0;

  for(let file of files){
    const reader = new FileReader();
    reader.onload = function(evt){
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      workbook.SheetNames.forEach(sheetName => {
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, {header:1});
        if(json.length<2) return;

        // Detecta encabezados:
        let header = json[0].map(col => (col||"").toString().toLowerCase());
        // Detecta materias
        if(header.some(h => h.includes('materia') || h.includes('asignatura'))) {
          let idxMat = header.findIndex(h => h.includes('materia') || h.includes('asignatura'));
          let idxCod = header.findIndex(h => h.includes('código') || h.includes('codigo'));
          let idxCred = header.findIndex(h => h.includes('crédito') || h.includes('creditos'));
          let idxPer = header.findIndex(h => h.includes('periodo') || h.includes('semestre') || h.includes('nivel'));
          for(let i=1; i<json.length; i++){
            let row = json[i];
            if(!row[idxMat]) continue;
            materias.push({
              materia: row[idxMat], 
              codigo: idxCod>=0? row[idxCod]:"", 
              creditos: idxCred>=0? row[idxCred]:"",
              periodo: idxPer>=0? row[idxPer]:""
            });
          }
        }
        // Detecta docentes
        if(header.some(h => h.includes('docente'))) {
          let idxDoc = header.findIndex(h => h.includes('docente'));
          for(let i=1; i<json.length; i++){
            let row = json[i];
            if(row[idxDoc]) docentes.push({docente: row[idxDoc]});
          }
        }
        // Detecta estudiantes
        if(header.some(h => h.includes('estudiante'))) {
          let idxEst = header.findIndex(h => h.includes('estudiante'));
          for(let i=1; i<json.length; i++){
            let row = json[i];
            if(row[idxEst]) estudiantes.push({estudiante: row[idxEst]});
          }
        }
        // Detecta créditos independientes
        if(header.some(h => h.includes('crédito') || h.includes('creditos'))) {
          let idxCred = header.findIndex(h => h.includes('crédito') || h.includes('creditos'));
          for(let i=1; i<json.length; i++){
            let row = json[i];
            if(row[idxCred]) creditos.push({credito: row[idxCred]});
          }
        }
      });
      filesProcessed++;
      if(filesProcessed === files.length) renderTablas();
    };
    reader.readAsArrayBuffer(file);
  }
});

function renderTablas(){
  let html = '';
  if(materias.length){
    html += '<div class="block"><h3>Materias detectadas</h3><table><tr><th>Materia</th><th>Código</th><th>Créditos</th><th>Periodo</th></tr>';
    materias.forEach(m=>{ html += `<tr><td>${m.materia||""}</td><td>${m.codigo||""}</td><td>${m.creditos||""}</td><td>${m.periodo||""}</td></tr>`; });
    html += '</table></div>';
  }
  if(docentes.length){
    html += '<div class="block"><h3>Docentes detectados</h3><table><tr><th>Docente</th></tr>';
    docentes.forEach(d=>{ html += `<tr><td>${d.docente||""}</td></tr>`; });
    html += '</table></div>';
  }
  if(estudiantes.length){
    html += '<div class="block"><h3>Estudiantes detectados</h3><table><tr><th>Estudiante</th></tr>';
    estudiantes.forEach(d=>{ html += `<tr><td>${d.estudiante||""}</td></tr>`; });
    html += '</table></div>';
  }
  if(creditos.length){
    html += '<div class="block"><h3>Créditos detectados</h3><table><tr><th>Crédito</th></tr>';
    creditos.forEach(c=>{ html += `<tr><td>${c.credito||""}</td></tr>`; });
    html += '</table></div>';
  }
  if(!materias.length && !docentes.length && !estudiantes.length && !creditos.length)
    html = "<div style='color:crimson'><b>No se detectaron datos relevantes. ¿Subiste archivos correctos?</b></div>";
  document.getElementById('resultados').innerHTML = html;
}

function descargarTodo(){
  let sheets = {};
  if(materias.length) sheets['Materias'] = XLSX.utils.json_to_sheet(materias);
  if(docentes.length) sheets['Docentes'] = XLSX.utils.json_to_sheet(docentes);
  if(estudiantes.length) sheets['Estudiantes'] = XLSX.utils.json_to_sheet(estudiantes);
  if(creditos.length) sheets['Creditos'] = XLSX.utils.json_to_sheet(creditos);
  if(Object.keys(sheets).length === 0) return alert("No hay datos para descargar.");
  let wb = XLSX.utils.book_new();
  for(let name in sheets) XLSX.utils.book_append_sheet(wb, sheets[name], name);
  XLSX.writeFile(wb, "consolidado_academico.xlsx");
}
</script>
</body>
</html>
