<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planificador Académico (HTML único)</title>

<!-- Librería para leer Excel en el navegador (sin servidor) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#0f172a;          /* slate-900 */
  --panel:#111827;       /* gray-900 */
  --muted:#334155;       /* slate-600 */
  --card:#111827;
  --accent:#f59e0b;      /* amber-500 */
  --accent-2:#2563eb;    /* blue-600 */
  --ok:#16a34a;          /* green-600 */
  --danger:#dc2626;      /* red-600 */
  --text:#e5e7eb;        /* gray-200 */
  --text-dim:#cbd5e1;    /* slate-300 */
  --chip:#1f2937;        /* gray-800 */
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Ubuntu", "Cantarell", "Helvetica Neue", sans-serif;
  background:linear-gradient(180deg, #0b1023 0%, #0f172a 60%, #0b1023 100%);
  color:var(--text);
}
header{
  padding:26px 20px 10px;
  display:flex; flex-wrap:wrap; align-items:center; gap:14px; justify-content:space-between;
}
h1{margin:0; font-size:20px; letter-spacing:.5px; font-weight:700}
.badge{padding:4px 10px; border-radius:999px; background:var(--chip); color:var(--text-dim); font-size:12px}
.container{padding:16px; max-width:1300px; margin:0 auto}
.card{
  background:rgba(17,24,39,.75);
  border:1px solid rgba(148,163,184,.15);
  backdrop-filter: blur(6px);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}
.row{display:grid; grid-template-columns:1.2fr .8fr; gap:16px}
.section{padding:16px}
.section h2{margin:0 0 12px 0; font-size:16px}
hr.sep{border:none; border-top:1px dashed rgba(148,163,184,.18); margin:12px 0}

.uploads{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px}
.upl{padding:12px; background:#0b1224; border:1px dashed rgba(148,163,184,.3); border-radius:12px}
.upl label{display:block; font-size:12px; color:var(--text-dim); margin-bottom:6px}
.upl input[type=file]{width:100%; color:var(--text-dim)}

.controls{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
button{
  background:var(--accent-2); border:none; color:white; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;
}
button.secondary{ background:transparent; border:1px solid rgba(148,163,184,.25); color:var(--text) }
button.warn{ background:var(--danger) }
button.ok{ background:var(--ok) }
button:disabled{opacity:.55; cursor:not-allowed}
.small{font-size:12px; color:var(--text-dim)}

.tabs{display:flex; gap:8px; margin:10px 0}
.tab{padding:8px 12px; border-radius:999px; background:var(--chip); color:var(--text-dim); cursor:pointer; border:1px solid transparent}
.tab.active{background:#0b1224; color:var(--text); border-color:rgba(148,163,184,.25)}

.grid{
  display:grid; grid-template-columns: 130px repeat(5, 1fr);
  border:1px solid rgba(148,163,184,.2); border-radius:12px; overflow:hidden;
}
.grid .cell{
  border-bottom:1px solid rgba(148,163,184,.12);
  border-right:1px dashed rgba(148,163,184,.12);
  padding:8px; min-height:64px; font-size:12px;
}
.grid .header{background:#0b1224; font-weight:700}
.grid .slot{background:rgba(2,6,23,.35)}
.tag{
  display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:rgba(37,99,235,.12); color:#93c5fd; margin:2px 2px 0 0; border:1px solid rgba(37,99,235,.25)
}
.tag small{opacity:.8}
.legend{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
.legend .chip{background:var(--chip); padding:6px 10px; border-radius:999px; border:1px solid rgba(148,163,184,.25); font-size:12px}
.kpi{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
.kpi .box{background:#0b1224; border:1px solid rgba(148,163,184,.2); border-radius:10px; padding:10px 12px; font-size:12px}

.table{width:100%; border-collapse: collapse; margin-top:6px}
.table th,.table td{border-bottom:1px solid rgba(148,163,184,.18); padding:8px; text-align:left; font-size:13px}
.table tr:hover{background:rgba(148,163,184,.08)}

aside .pills{display:flex; flex-wrap:wrap; gap:6px}
.pill{background:var(--chip); padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(148,163,184,.25)}
fieldset{border:1px solid rgba(148,163,184,.25); padding:10px; border-radius:10px}
legend{font-size:12px; color:var(--text-dim); padding:0 6px}

.bad{color:#fecaca}
.good{color:#bbf7d0}
.warnText{color:#fde68a}

footer{padding:16px; text-align:center; color:var(--text-dim); font-size:12px}

.modal{
  position:fixed; inset:0; background:rgba(2,6,23,.6); display:none; align-items:center; justify-content:center; z-index:40;
}
.modal .dialog{
  width:min(680px, 92vw); background:#0b1224; border:1px solid rgba(148,163,184,.35); border-radius:16px; padding:16px; box-shadow:var(--shadow)
}
.modal .dialog h3{margin:0 0 8px 0; font-size:16px}
.modal .dialog .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.checkbox { display:flex; align-items:center; gap:8px; margin:6px 0; }
.select{width:100%; background:#0f172a; color:var(--text); border:1px solid rgba(148,163,184,.3); padding:8px; border-radius:8px}
.input{width:100%; background:#0f172a; color:var(--text); border:1px solid rgba(148,163,184,.3); padding:8px; border-radius:8px}
.hr{height:1px; background:rgba(148,163,184,.2); margin:10px 0}
.note{font-size:12px; color:var(--text-dim)}
.mini{font-size:11px; opacity:.85}
</style>
</head>
<body>
<header class="container">
  <div style="display:flex; align-items:center; gap:10px">
    <h1>Planificador Académico</h1>
    <span class="badge">HTML único • Sin servidor</span>
  </div>
  <div class="legend">
    <span class="chip">Días: L–V</span>
    <span class="chip">Franjas: 7–10 · 10–13 · 13–16 · 16–19 · 19–22</span>
    <span class="chip">Máx. 2 materias/día (docente y estudiante)</span>
    <span class="chip">Máx. 6 materias/estudiante</span>
    <span class="chip">Ciclos adyacentes sin choque</span>
  </div>
</header>

<div class="container row">
  <!-- IZQUIERDA: CARGA + VISTAS -->
  <section class="card section">
    <h2>Entradas (Excel) y ejecución</h2>
    <div class="uploads">
      <div class="upl">
        <label for="fileMalla">Malla (obligatorio)</label>
        <input id="fileMalla" type="file" accept=".xlsx,.xls" />
        <div class="small">Requiere columnas mínimas: <b>CARRERA</b>, <b>CICLO</b>, <b>MATERIA</b>. Opcionales: <i>PARALELOS</i>, <i>COMPARTIDA CON</i>.</div>
      </div>
      <div class="upl">
        <label for="fileDocentes">Docentes (obligatorio)</label>
        <input id="fileDocentes" type="file" accept=".xlsx,.xls" />
        <div class="small">Mínimas: <b>DOCENTE</b>, <b>CARRERA</b>, <b>MATERIA</b>. Opcional: <i>PARALELO</i>.</div>
      </div>
      <div class="upl">
        <label for="fileEstudiantes">Estudiantes (obligatorio)</label>
        <input id="fileEstudiantes" type="file" accept=".xlsx,.xls" />
        <div class="small">Mínimas: <b>ESTUDIANTE</b>, <b>CARRERA</b>, <b>CICLO</b>. Opcionales: <i>NIVEL INGLES</i>, <i>PRACTICAS</i>.</div>
      </div>
    </div>

    <div class="controls">
      <button id="btnAnalizar">Validar & Leer 100 %</button>
      <button id="btnConfig" class="secondary" disabled>Configurar bloqueos</button>
      <button id="btnAsignar" class="ok" disabled>Generar planificación</button>
      <button id="btnLimpiar" class="secondary">Reiniciar</button>
      <span id="status" class="small"></span>
    </div>

    <hr class="sep"/>

    <div class="tabs">
      <div class="tab active" data-tab="estudiantes">Planificación de estudiantes</div>
      <div class="tab" data-tab="docentes">Planificación docente</div>
    </div>

    <!-- VISTA ESTUDIANTES -->
    <div id="view-estudiantes">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:6px 0 12px">
        <select id="selEstudiante" class="select" disabled>
          <option value="">— Seleccione estudiante —</option>
        </select>
        <button id="btnEditar" class="secondary" disabled>Editar asignación (estudiante)</button>
        <span class="small">Edición válida únicamente a nivel de estudiante. Los choques o violaciones se bloquean con aviso.</span>
      </div>

      <div id="kpiEst" class="kpi" style="display:none">
        <div class="box">Total materias: <b id="kTotal">0</b>/6</div>
        <div class="box">Choques detectados: <b id="kChoques">0</b></div>
        <div class="box">Bloqueos activos: <b id="kBlocks">0</b></div>
      </div>

      <div class="grid" id="gridEstudiante" style="margin-top:10px">
        <!-- se completa por JS -->
      </div>

      <table class="table" id="tablaEst" style="display:none">
        <thead>
          <tr>
            <th>Materia</th><th>Paralelo</th><th>Día</th><th>Franja</th><th>Docente</th><th>Carrera</th><th>Ciclo</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- VISTA DOCENTES -->
    <div id="view-docentes" style="display:none">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:6px 0 12px">
        <select id="selDocente" class="select" disabled>
          <option value="">— Seleccione docente —</option>
        </select>
      </div>
      <div class="grid" id="gridDocente">
        <!-- se completa por JS -->
      </div>
      <table class="table" id="tablaDoc" style="display:none">
        <thead>
          <tr>
            <th>Día</th><th>Franja</th><th>Materia</th><th>Paralelo</th><th>Carrera</th><th>Ciclo</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- DERECHA: REGLAS y BLOQUEOS -->
  <aside class="card section">
    <h2>Reglas y estado</h2>

    <fieldset>
      <legend>Calendario</legend>
      <div class="pills">
        <span class="pill">Lunes–Viernes</span>
        <span class="pill">7–10</span>
        <span class="pill">10–13</span>
        <span class="pill">13–16</span>
        <span class="pill">16–19</span>
        <span class="pill">19–22</span>
      </div>
      <div class="pills" style="margin-top:8px">
        <span class="pill">Máx. 2 materias por día (docente y estudiante)</span>
        <span class="pill">Máx. 6 materias por estudiante</span>
        <span class="pill">Ciclos adyacentes sin choque en misma carrera</span>
        <span class="pill">Asignación solo por carrera de estudiante</span>
        <span class="pill">Coincidencias entre carreras permitidas</span>
      </div>
    </fieldset>

    <div style="height:10px"></div>

    <fieldset>
      <legend>Restricciones</legend>
      <div class="small">Prioridad de asignación: malla del estudiante → nivel de inglés → bloqueos de prácticas.</div>
      <div class="hr"></div>
      <div class="checkbox"><input type="checkbox" id="chkIngles" disabled/> <label for="chkIngles">Aplicar bloqueos de Inglés si no hay datos en Excel</label></div>
      <div class="checkbox"><input type="checkbox" id="chkPracticas" disabled/> <label for="chkPracticas">Aplicar bloqueos de “Prácticas comunitarias” si no hay datos en Excel</label></div>
      <div class="note mini">Use “Configurar bloqueos” para definir franjas por semestre.</div>
    </fieldset>

    <div style="height:10px"></div>

    <fieldset>
      <legend>Mensajes</legend>
      <div id="log" class="small" style="max-height:230px; overflow:auto; white-space:pre-wrap"></div>
    </fieldset>
  </aside>
</div>

<footer>
  Cumplimiento estricto de reglas; edición exclusivamente por estudiante con bloqueo de choques. ©
</footer>

<!-- MODAL: CONFIGURAR BLOQUEOS -->
<div id="modalCfg" class="modal">
  <div class="dialog">
    <h3>Configuración de bloqueos</h3>
    <div class="note">Defina bloqueos por semestre (ciclo del estudiante) para evitar choques con “Prácticas comunitarias” u otros compromisos. También puede definir un bloqueo general de Inglés.</div>
    <div class="hr"></div>
    <div class="row2">
      <div>
        <h4 style="margin:0 0 6px">Bloqueos por semestre</h4>
        <div style="display:flex; gap:6px; align-items:center; margin-bottom:8px">
          <input id="inCicloBloq" class="input" type="number" min="1" placeholder="Ciclo (ej. 2)" />
          <select id="inDiaBloq" class="select">
            <option value="">Día</option>
          </select>
          <select id="inSlotBloq" class="select">
            <option value="">Franja</option>
          </select>
          <button id="btnAddBloq" class="secondary">Agregar</button>
        </div>
        <div id="listBloq" class="small"></div>
      </div>
      <div>
        <h4 style="margin:0 0 6px">Bloqueo general de Inglés</h4>
        <div class="checkbox"><input type="checkbox" id="inInglesAct" /> <label for="inInglesAct">Activar bloqueo general</label></div>
        <div style="display:flex; gap:6px; align-items:center; margin:6px 0">
          <select id="inDiaIng" class="select"><option value="">Día</option></select>
          <select id="inSlotIng" class="select"><option value="">Franja</option></select>
          <button id="btnAddIng" class="secondary">Agregar</button>
        </div>
        <div id="listIng" class="small"></div>
      </div>
    </div>
    <div class="hr"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end">
      <button id="btnCloseCfg" class="secondary">Cerrar</button>
      <button id="btnSaveCfg" class="ok">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: EDICIÓN ESTUDIANTE -->
<div id="modalEdit" class="modal">
  <div class="dialog">
    <h3>Edición de asignación (por estudiante)</h3>
    <div id="editInfo" class="note"></div>
    <div class="hr"></div>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <select id="editMateria" class="select"></select>
      <select id="editDestino" class="select"></select>
      <button id="btnAplicarEdicion" class="ok">Aplicar cambio</button>
      <button id="btnCerrarEdicion" class="secondary">Cerrar</button>
    </div>
    <div class="hr"></div>
    <div id="editMsg" class="small"></div>
  </div>
</div>

<script>
/* ==========================
   Utilidades y constantes
========================== */
const DAYS = ["Lunes","Martes","Miércoles","Jueves","Viernes"];
const SLOTS = ["7-10","10-13","13-16","16-19","19-22"];

const state = {
  raw:{ malla:null, docentes:null, estudiantes:null }, // lectura completa
  data:{ malla:[], docentes:[], estudiantes:[] },      // normalizados mínimos
  loaded:false,
  config:{
    bloqueosPorSemestre:[], // { ciclo: number, dia: string, slot: string }
    ingles:{ activo:false, items:[] } // [{dia, slot}]
  },
  sections:[],   // secciones/Paralelos planificados por (carrera, ciclo, materia, paralelo, dia, slot, docente)
  assign:{       // asignaciones por estudiante
    byStudent: new Map() // key: estudianteId, value: array de { materia, paralelo, dia, slot, docente, carrera, ciclo }
  },
  index:{
    docentes:[], estudiantes:[]
  },
  ui:{
    currentStudent:null,
    currentDocente:null
  }
};

const $ = sel => document.querySelector(sel);
const $c = (tag, cls) => { const el = document.createElement(tag); if(cls) el.className = cls; return el; };
function log(msg, type="info"){
  const el=$("#log"); if(!el) return;
  const stamp = new Date().toLocaleTimeString();
  const color = type==="error" ? "bad" : type==="warn" ? "warnText" : "good";
  el.innerHTML = `[${stamp}] <span class="${color}">${msg}</span>\n` + el.innerHTML;
}
function toKey(s){ return String(s||"").trim(); }
function upperKeys(row){
  const o={}; Object.keys(row).forEach(k=> o[toKey(k).toUpperCase()] = row[k]); return o;
}
function ensureHeaders(rows, req){
  if(!rows || !rows.length) return false;
  const h = Object.keys(upperKeys(rows[0]));
  return req.every(x => h.includes(x));
}
function readExcel(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload = e=>{
      try{
        const wb=XLSX.read(new Uint8Array(e.target.result), {type:"array"});
        const allSheets={};
        wb.SheetNames.forEach(name=>{
          const ws=wb.Sheets[name];
          const arr = XLSX.utils.sheet_to_json(ws, {defval:""});
          allSheets[name]=arr;
        });
        resolve(allSheets);
      }catch(err){ reject(err); }
    };
    fr.onerror = reject;
    fr.readAsArrayBuffer(file);
  });
}

/* ==========================
   Lectura de archivos (100%)
========================== */
async function handleAnalizar(){
  $("#status").textContent="Leyendo archivos…";
  state.raw={ malla:null, docentes:null, estudiantes:null };
  state.data={ malla:[], docentes:[], estudiantes:[] };
  state.sections=[]; state.assign.byStudent.clear();
  state.ui.currentStudent=null; state.ui.currentDocente=null;

  const fM = $("#fileMalla").files[0];
  const fD = $("#fileDocentes").files[0];
  const fE = $("#fileEstudiantes").files[0];
  if(!fM || !fD || !fE){
    log("Faltan archivos obligatorios (Malla, Docentes, Estudiantes).", "error");
    $("#status").textContent="Faltan archivos.";
    return;
  }

  try{
    const [wbM, wbD, wbE] = await Promise.all([readExcel(fM), readExcel(fD), readExcel(fE)]);
    state.raw.malla=wbM; state.raw.docentes=wbD; state.raw.estudiantes=wbE;

    // Tomar primera hoja de cada libro (se lee el 100%, pero normalizamos desde la primera o “Malla/Docentes/Estudiantes” si existen)
    const pickSheet = (wb, pref) => {
      const names = Object.keys(wb);
      const byName = names.find(n => n.trim().toUpperCase().includes(pref));
      return wb[ byName || names[0] ] || [];
    };
    const rowsM = pickSheet(wbM, "MALLA").map(upperKeys);
    const rowsD = pickSheet(wbD, "DOCENTE").map(upperKeys);
    const rowsE = pickSheet(wbE, "ESTUDIANT").map(upperKeys);

    // Validación mínima de encabezados requeridos
    if(!ensureHeaders(rowsM, ["CARRERA","CICLO","MATERIA"])){
      log("Malla: encabezados requeridos: CARRERA, CICLO, MATERIA.", "error");
      $("#status").textContent="Encabezados inválidos en Malla.";
      return;
    }
    if(!ensureHeaders(rowsD, ["DOCENTE","CARRERA","MATERIA"])){
      log("Docentes: encabezados requeridos: DOCENTE, CARRERA, MATERIA.", "error");
      $("#status").textContent="Encabezados inválidos en Docentes.";
      return;
    }
    if(!ensureHeaders(rowsE, ["ESTUDIANTE","CARRERA","CICLO"])){
      log("Estudiantes: encabezados requeridos: ESTUDIANTE, CARRERA, CICLO.", "error");
      $("#status").textContent="Encabezados inválidos en Estudiantes.";
      return;
    }

    // Normalización mínima (el resto de columnas quedan disponibles en state.raw)
    state.data.malla = rowsM.map((r,i)=>({
      id:`m_${i+1}`,
      carrera: toKey(r["CARRERA"]),
      ciclo: Number(r["CICLO"])||0,
      materia: toKey(r["MATERIA"]),
      paralelos: Number(r["PARALELOS"]||1),
      compartidaCon: toKey(r["COMPARTIDA CON"]||"")
    }));

    state.data.docentes = rowsD.map((r,i)=>({
      id:`d_${i+1}`,
      docente: toKey(r["DOCENTE"]),
      carrera: toKey(r["CARRERA"]),
      materia: toKey(r["MATERIA"]),
      paralelo: toKey(r["PARALELO"]||"")
    }));

    state.data.estudiantes = rowsE.map((r,i)=>({
      id:`e_${i+1}`,
      estudiante: toKey(r["ESTUDIANTE"]),
      carrera: toKey(r["CARRERA"]),
      ciclo: Number(r["CICLO"])||0,
      nivelIngles: toKey(r["NIVEL INGLES"]||r["NIVEL_INGLES"]||""),
      practicas: toKey(r["PRACTICAS"]||"")
    }));

    // Habilitar controles de configuración y asignación
    $("#btnConfig").disabled=false;
    $("#btnAsignar").disabled=false;
    $("#chkIngles").disabled=false;
    $("#chkPracticas").disabled=false;
    $("#status").textContent="Archivos leídos (100%). Listo para configurar bloqueos o asignar.";
    log("Lectura completa de los tres Excel. Puede configurar bloqueos o generar la planificación.", "ok");

    // Poblar selects básicos
    fillDaySlotSelects();
  }catch(err){
    console.error(err);
    log("Error leyendo archivos: " + err.message, "error");
    $("#status").textContent="Error al leer.";
  }
}

function fillDaySlotSelects(){
  const d1=$("#inDiaBloq"), s1=$("#inSlotBloq");
  const d2=$("#inDiaIng"), s2=$("#inSlotIng");
  [d1,d2].forEach(s=>{
    s.innerHTML='<option value="">Día</option>' + DAYS.map(d=>`<option>${d}</option>`).join("");
  });
  [s1,s2].forEach(s=>{
    s.innerHTML='<option value="">Franja</option>' + SLOTS.map(d=>`<option>${d}</option>`).join("");
  });
}

/* ==========================
   Configuración de bloqueos
========================== */
function openCfg(){
  $("#modalCfg").style.display="flex";
  // Pintar listas existentes
  renderBloqLists();
}
function closeCfg(){
  $("#modalCfg").style.display="none";
}
function renderBloqLists(){
  const list=$("#listBloq");
  if(!state.config.bloqueosPorSemestre.length){
    list.innerHTML='<span class="mini">Sin bloqueos por semestre.</span>';
  }else{
    list.innerHTML = state.config.bloqueosPorSemestre
      .map((b,i)=>`• Semestre ${b.ciclo}: ${b.dia} ${b.slot} <button data-rm-b="${i}" class="secondary miniBtn" style="margin-left:6px; padding:2px 6px; font-size:11px">Quitar</button>`)
      .join("<br>");
  }

  const listIng=$("#listIng");
  if(!state.config.ingles.items.length){
    listIng.innerHTML='<span class="mini">Sin bloqueos definidos.</span>';
  }else{
    listIng.innerHTML = state.config.ingles.items
      .map((b,i)=>`• ${b.dia} ${b.slot} <button data-rm-i="${i}" class="secondary miniBtn" style="margin-left:6px; padding:2px 6px; font-size:11px">Quitar</button>`)
      .join("<br>");
  }
}
function saveCfg(){
  state.config.ingles.activo = $("#inInglesAct").checked;
  closeCfg();
  log("Bloqueos guardados.", "ok");
}
function addBloq(){
  const ciclo = Number($("#inCicloBloq").value||0);
  const dia = $("#inDiaBloq").value;
  const slot = $("#inSlotBloq").value;
  if(!ciclo || !dia || !slot){ log("Complete ciclo, día y franja para agregar bloqueo por semestre.", "warn"); return; }
  state.config.bloqueosPorSemestre.push({ciclo, dia, slot});
  $("#inCicloBloq").value=""; $("#inDiaBloq").value=""; $("#inSlotBloq").value="";
  renderBloqLists();
}
function addIng(){
  const dia=$("#inDiaIng").value;
  const slot=$("#inSlotIng").value;
  if(!dia || !slot){ log("Complete día y franja para agregar bloqueo de Inglés.", "warn"); return; }
  state.config.ingles.items.push({dia, slot});
  $("#inDiaIng").value=""; $("#inSlotIng").value="";
  renderBloqLists();
}
document.addEventListener("click", (ev)=>{
  if(ev.target && ev.target.dataset && ev.target.dataset.rmB!==undefined){
    const i = Number(ev.target.dataset.rmB);
    state.config.bloqueosPorSemestre.splice(i,1); renderBloqLists();
  }
  if(ev.target && ev.target.dataset && ev.target.dataset.rmI!==undefined){
    const i = Number(ev.target.dataset.rmI);
    state.config.ingles.items.splice(i,1); renderBloqLists();
  }
});

/* ==========================
   Planificación (generación)
========================== */
function docenteDailyCount(map, docente, dia){
  const key = `${docente}__${dia}`;
  return map.get(key)||0;
}
function incDocenteDaily(map, docente, dia){
  const key = `${docente}__${dia}`;
  map.set(key, (map.get(key)||0)+1);
}
function slotBusyForAdjacency(adjIndex, carrera, ciclo, dia, slot){
  // Revisa si en la misma carrera existe una sección en ciclo adyacente (c-1 o c+1) en el mismo día+franja
  const neighbor = state.sections.find(s =>
    s.carrera===carrera &&
    Math.abs(s.ciclo - ciclo)===1 &&
    s.dia===dia && s.slot===slot
  );
  return !!neighbor;
}
function findDocentesFor(carrera, materia){
  return state.data.docentes.filter(d => d.carrera===carrera && d.materia===materia);
}

function generarPlanificacion(){
  state.sections=[]; state.assign.byStudent.clear();

  // Construir secciones/Paralelos por materia
  // Ordenar por carrera y ciclo para mejorar distribución
  const items = [...state.data.malla].sort((a,b)=>{
    if(a.carrera!==b.carrera) return a.carrera.localeCompare(b.carrera);
    return a.ciclo - b.ciclo;
  });

  const docenteDayMap = new Map(); // conteo por día para cada docente
  for(const item of items){
    const docentes = findDocentesFor(item.carrera, item.materia);
    const nPar = Math.max(1, Number(item.paralelos||1));
    for(let p=1; p<=nPar; p++){
      // Asignar docente (si hay varios, alternar); si no existe, "Por asignar"
      const docente = docentes.length ? docentes[(p-1)%docentes.length].docente : "Por asignar";
      // Buscar día+franja cumpliendo: ciclos adyacentes sin choque + docente máx. 2/día y sin solapes
      let placed=false;
      for(const dia of DAYS){
        // Límite por día del docente
        if(docente!=="Por asignar" && docenteDailyCount(docenteDayMap, docente, dia)>=2) continue;

        for(const slot of SLOTS){
          // No ubicar si existe choque por adyacencia
          if(slotBusyForAdjacency(true, item.carrera, item.ciclo, dia, slot)) continue;

          // No ubicar si el mismo docente ya tiene clase en ese día+franja
          const docBusy = state.sections.find(s => s.docente===docente && s.dia===dia && s.slot===slot);
          if(docente!=="Por asignar" && docBusy) continue;

          // Aceptado
          state.sections.push({
            carrera:item.carrera, ciclo:item.ciclo, materia:item.materia,
            paralelo:p, dia, slot, docente
          });
          if(docente!=="Por asignar") incDocenteDaily(docenteDayMap, docente, dia);
          placed=true; break;
        }
        if(placed) break;
      }
      if(!placed){
        // Si no encontró hueco, forzar primer hueco libre ignorando adyacencia (último recurso)
        outer: for(const dia of DAYS){
          if(docente!=="Por asignar" && docenteDailyCount(docenteDayMap, docente, dia)>=2) continue;
          for(const slot of SLOTS){
            const docBusy = state.sections.find(s => s.docente===docente && s.dia===dia && s.slot===slot);
            if(docente!=="Por asignar" && docBusy) continue;
            state.sections.push({
              carrera:item.carrera, ciclo:item.ciclo, materia:item.materia,
              paralelo:p, dia, slot, docente
            });
            if(docente!=="Por asignar") incDocenteDaily(docenteDayMap, docente, dia);
            break outer;
          }
        }
      }
    }
  }

  // Índices para selects
  state.index.docentes = Array.from(new Set(state.sections.map(s=>s.docente))).filter(x=>x && x!=="Por asignar").sort();
  state.index.estudiantes = state.data.estudiantes.map(e => ({id:e.id, label:`${e.estudiante} — ${e.carrera} (C${e.ciclo})`}));

  // Asignar a estudiantes (máx. 6, 2 por día, respetando bloqueos)
  for(const est of state.data.estudiantes){
    const wanted = state.data.malla.filter(m => m.carrera===est.carrera && m.ciclo===est.ciclo);
    const plan=[];
    const dailyCount = new Map(); // día -> count
    // bloqueos por semestre
    const blocksSem = state.config.bloqueosPorSemestre.filter(b => Number(b.ciclo)===Number(est.ciclo));
    // bloqueos de inglés
    const hasInglesData = !!toKey(est.nivelIngles);
    const applyInglesGlobal = state.config.ingles.activo && !hasInglesData && $("#chkIngles").checked;
    const inglesBlocks = applyInglesGlobal ? state.config.ingles.items : [];

    const blocked = (dia,slot)=>{
      if($("#chkPracticas").checked){
        for(const b of blocksSem){ if(b.dia===dia && b.slot===slot) return true; }
      }
      if(applyInglesGlobal){
        for(const b of inglesBlocks){ if(b.dia===dia && b.slot===slot) return true; }
      }
      return false;
    };

    for(const wm of wanted){
      if(plan.length>=6) break; // máximo por estudiante
      // buscar sección compatible
      const secs = state.sections.filter(s => s.carrera===wm.carrera && s.ciclo===wm.ciclo && s.materia===wm.materia);
      let placed=false;
      for(const sec of secs){
        if(blocked(sec.dia, sec.slot)) continue;
        // 2 por día
        const cnt = dailyCount.get(sec.dia)||0;
        if(cnt>=2) continue;
        // sin choque de horas en el mismo día y franja
        const has = plan.find(p => p.dia===sec.dia && p.slot===sec.slot);
        if(has) continue;

        plan.push({...sec});
        dailyCount.set(sec.dia, cnt+1);
        placed=true; break;
      }
      // si no se pudo ubicar esa materia, se omite (quedará sin asignar)
    }
    state.assign.byStudent.set(est.id, plan);
  }

  // Activar UI
  fillUIAfterPlan();
  log("Planificación generada.", "ok");
  $("#status").textContent="Planificación generada. Revise las vistas.";
}

/* ==========================
   UI posterior a planificación
========================== */
function fillUIAfterPlan(){
  // Estudiantes
  const selEst=$("#selEstudiante");
  selEst.innerHTML = '<option value="">— Seleccione estudiante —</option>' +
    state.data.estudiantes.map(e => `<option value="${e.id}">${e.estudiante} — ${e.carrera} (C${e.ciclo})</option>`).join("");
  selEst.disabled=false;

  // Docentes
  const selDoc=$("#selDocente");
  selDoc.innerHTML = '<option value="">— Seleccione docente —</option>' +
    state.index.docentes.map(d => `<option>${d}</option>`).join("");
  selDoc.disabled=false;

  // Grids vacíos iniciales
  renderGrid("#gridEstudiante", null, "estudiante");
  renderGrid("#gridDocente", null, "docente");

  $("#tablaEst").style.display="none";
  $("#tablaDoc").style.display="none";

  $("#btnEditar").disabled=true;
}

/* ==========================
   Render de grillas
========================== */
function baseGrid(){
  const frag=document.createDocumentFragment();
  // encabezados
  const head0=$c("div","cell header"); head0.textContent="Franja / Día"; frag.appendChild(head0);
  for(const d of DAYS){ const h=$c("div","cell header"); h.textContent=d; frag.appendChild(h); }
  // filas
  for(const sl of SLOTS){
    const l=$c("div","cell slot"); l.textContent=sl; frag.appendChild(l);
    for(const d of DAYS){
      const cell=$c("div","cell"); cell.dataset.day=d; cell.dataset.slot=sl; frag.appendChild(cell);
    }
  }
  return frag;
}
function renderGrid(selector, entries, mode, contextInfo){
  const root = $(selector);
  root.innerHTML="";
  root.appendChild(baseGrid());
  if(!entries) return;

  // entries: array de objetos con { materia, paralelo, dia, slot, docente, carrera, ciclo }
  // Para vista docente, entries son del docente; para estudiante, del estudiante
  const cells = root.querySelectorAll(".cell");
  for(const it of entries){
    const cell=[...cells].find(c => c.dataset && c.dataset.day===it.dia && c.dataset.slot===it.slot);
    if(!cell) continue;
    const tag=$c("div","tag");
    tag.innerHTML = `<b>${it.materia}</b> <small>Par. ${it.paralelo}</small><small>• C${it.ciclo} • ${it.carrera}</small>${mode==="docente"?"":`<small>• ${it.docente||"Doc."}</small>`}`;
    cell.appendChild(tag);
  }

  // pintar bloqueos si el contexto es estudiante
  if(mode==="estudiante" && contextInfo){
    const blocks = contextInfo.blocks||[];
    for(const b of blocks){
      const cell=[...cells].find(c => c.dataset && c.dataset.day===b.dia && c.dataset.slot===b.slot);
      if(cell){
        const tag=$c("div","tag"); tag.style.borderColor="rgba(220,38,38,.35)";
        tag.style.background="rgba(220,38,38,.12)"; tag.style.color="#fecaca";
        tag.innerHTML = `<b>Bloqueado</b> <small>${b.motivo||""}</small>`;
        cell.appendChild(tag);
      }
    }
  }
}

/* ==========================
   Selecciones y tablas
========================== */
function currentStudentBlocks(est){
  const blocks=[];
  // por semestre
  const sem = state.config.bloqueosPorSemestre.filter(b => Number(b.ciclo)===Number(est.ciclo));
  for(const b of sem){ blocks.push({dia:b.dia, slot:b.slot, motivo:"Prácticas / Semestre"}); }
  // inglés
  const hasInglesData = !!toKey(est.nivelIngles);
  const applyInglesGlobal = state.config.ingles.activo && !hasInglesData && $("#chkIngles").checked;
  if(applyInglesGlobal){
    for(const b of state.config.ingles.items){ blocks.push({dia:b.dia, slot:b.slot, motivo:"Inglés (global)"}); }
  }
  return blocks;
}
function onPickStudent(){
  const id=$("#selEstudiante").value;
  $("#btnEditar").disabled = !id;
  if(!id){
    renderGrid("#gridEstudiante", null, "estudiante");
    $("#tablaEst").style.display="none";
    $("#kpiEst").style.display="none";
    return;
  }
  state.ui.currentStudent = id;
  const est = state.data.estudiantes.find(e=>e.id===id);
  const plan = state.assign.byStudent.get(id)||[];
  renderGrid("#gridEstudiante", plan, "estudiante", { blocks: currentStudentBlocks(est) });

  // KPIs
  $("#kpiEst").style.display="";
  $("#kTotal").textContent = String(plan.length);
  $("#kBlocks").textContent = String(currentStudentBlocks(est).length);
  // choques (no deberían existir con el algoritmo)
  $("#kChoques").textContent = "0";

  // Tabla detalle
  const tb=$("#tablaEst tbody"); tb.innerHTML="";
  for(const p of plan){
    const tr=$c("tr");
    tr.innerHTML = `<td>${p.materia}</td><td>${p.paralelo}</td><td>${p.dia}</td><td>${p.slot}</td><td>${p.docente||""}</td><td>${p.carrera}</td><td>${p.ciclo}</td>`;
    tb.appendChild(tr);
  }
  $("#tablaEst").style.display="";
}

function onPickDocente(){
  const name=$("#selDocente").value;
  if(!name){
    renderGrid("#gridDocente", null, "docente");
    $("#tablaDoc").style.display="none";
    return;
  }
  state.ui.currentDocente = name;
  const entries = state.sections.filter(s => s.docente===name);
  renderGrid("#gridDocente", entries, "docente");

  const tb=$("#tablaDoc tbody"); tb.innerHTML="";
  for(const e of entries){
    const tr=$c("tr");
    tr.innerHTML = `<td>${e.dia}</td><td>${e.slot}</td><td>${e.materia}</td><td>${e.paralelo}</td><td>${e.carrera}</td><td>${e.ciclo}</td>`;
    tb.appendChild(tr);
  }
  $("#tablaDoc").style.display="";
}

/* ==========================
   Edición por estudiante
========================== */
function openEdit(){
  const id = state.ui.currentStudent;
  if(!id) return;
  const est = state.data.estudiantes.find(e=>e.id===id);
  const plan = state.assign.byStudent.get(id)||[];
  const selMat=$("#editMateria");
  selMat.innerHTML = plan.map(p => `<option value="${p.materia}__${p.paralelo}">${p.materia} — Par. ${p.paralelo} (${p.dia} ${p.slot})</option>`).join("");
  $("#editDestino").innerHTML = '<option value="">— Seleccione destino —</option>';
  $("#editMsg").innerHTML="";
  $("#editInfo").textContent = `${est.estudiante} — ${est.carrera} (C${est.ciclo})`;
  $("#modalEdit").style.display="flex";
}
function closeEdit(){ $("#modalEdit").style.display="none"; }

$("#editMateria").addEventListener("change", ()=>{
  const id = state.ui.currentStudent;
  if(!id) return;
  const est = state.data.estudiantes.find(e=>e.id===id);
  const [materia, paralelo] = $("#editMateria").value.split("__");
  // destinos: todas las secciones de esa materia en su carrera/ciclo
  const dests = state.sections.filter(s =>
    s.materia===materia && s.carrera===est.carrera && s.ciclo===est.ciclo
  );
  $("#editDestino").innerHTML = dests.map(d => `<option value="${d.dia}__${d.slot}__${d.paralelo}">${d.dia} • ${d.slot} • Par. ${d.paralelo} • Doc. ${d.docente||""}</option>`).join("");
});

function aplicarEdicion(){
  const id = state.ui.currentStudent;
  if(!id) return;
  const est = state.data.estudiantes.find(e=>e.id===id);
  const plan = state.assign.byStudent.get(id)||[];
  if(!plan.length){ $("#editMsg").innerHTML='<span class="bad">No hay asignaciones.</span>'; return; }

  const sel = $("#editMateria").value;
  const dst = $("#editDestino").value;
  if(!sel || !dst){ $("#editMsg").innerHTML='<span class="warnText">Seleccione materia y destino.</span>'; return; }

  const [materia, parOrig] = sel.split("__");
  const [diaN, slotN, parN] = dst.split("__");

  // Buscar entrada original
  const idx = plan.findIndex(p => p.materia===materia && String(p.paralelo)===String(parOrig));
  if(idx<0){ $("#editMsg").innerHTML='<span class="bad">No se encontró la asignación original.</span>'; return; }

  const nuevo = state.sections.find(s =>
    s.materia===materia && s.carrera===est.carrera && s.ciclo===est.ciclo &&
    s.dia===diaN && s.slot===slotN && String(s.paralelo)===String(parN)
  );
  if(!nuevo){ $("#editMsg").innerHTML='<span class="bad">Destino no válido.</span>'; return; }

  // Validaciones: 2 por día, choques de franja, máx. 6
  const provisional = [...plan];
  provisional[idx] = {...nuevo};

  // 2 por día
  const dayCount = new Map();
  for(const p of provisional){
    dayCount.set(p.dia, (dayCount.get(p.dia)||0) + 1);
    if(dayCount.get(p.dia)>2){
      $("#editMsg").innerHTML='<span class="bad">No se permite más de 2 materias el mismo día.</span>';
      return;
    }
  }
  // choques de franja
  for(let i=0;i<provisional.length;i++){
    for(let j=i+1;j<provisional.length;j++){
      const a=provisional[i], b=provisional[j];
      if(a.dia===b.dia && a.slot===b.slot){
        $("#editMsg").innerHTML='<span class="bad">Choque de horario detectado en la misma franja.</span>';
        return;
      }
    }
  }
  // bloqueos (semestre / inglés global)
  const blocks = currentStudentBlocks(est);
  const isBlocked = blocks.some(b => b.dia===nuevo.dia && b.slot===nuevo.slot);
  if(isBlocked){
    $("#editMsg").innerHTML='<span class="bad">El destino está bloqueado (Inglés/Prácticas). Cambio no aplicado.</span>';
    return;
  }

  // OK: aplicar
  state.assign.byStudent.set(id, provisional);
  $("#editMsg").innerHTML='<span class="good">Cambio aplicado correctamente.</span>';
  // refrescar vista estudiante
  onPickStudent();
}

/* ==========================
   Eventos generales de UI
========================== */
function switchTab(tab){
  const est = $("#view-estudiantes");
  const doc = $("#view-docentes");
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelector(`.tab[data-tab="${tab}"]`).classList.add("active");
  if(tab==="estudiantes"){ est.style.display=""; doc.style.display="none"; }
  else { est.style.display="none"; doc.style.display=""; }
}

function resetAll(){
  ["fileMalla","fileDocentes","fileEstudiantes"].forEach(id => { const el=$("#"+id); el.value=""; });
  $("#status").textContent="";
  $("#log").textContent="";
  $("#btnConfig").disabled=true;
  $("#btnAsignar").disabled=true;
  $("#chkIngles").checked=false; $("#chkIngles").disabled=true;
  $("#chkPracticas").checked=false; $("#chkPracticas").disabled=true;
  state.raw={malla:null, docentes:null, estudiantes:null};
  state.data={malla:[], docentes:[], estudiantes:[]};
  state.sections=[]; state.assign.byStudent.clear();
  state.config={ bloqueosPorSemestre:[], ingles:{activo:false, items:[]} };
  fillDaySlotSelects();
  // limpiar vistas
  renderGrid("#gridEstudiante", null, "estudiante");
  renderGrid("#gridDocente", null, "docente");
  $("#selEstudiante").innerHTML='<option value="">— Seleccione estudiante —</option>'; $("#selEstudiante").disabled=true;
  $("#selDocente").innerHTML='<option value="">— Seleccione docente —</option>'; $("#selDocente").disabled=true;
  $("#tablaEst").style.display="none"; $("#tablaDoc").style.display="none";
  $("#kpiEst").style.display="none";
  $("#btnEditar").disabled=true;
}

/* ==========================
   Listeners
========================== */
$("#btnAnalizar").addEventListener("click", handleAnalizar);
$("#btnConfig").addEventListener("click", openCfg);
$("#btnCloseCfg").addEventListener("click", closeCfg);
$("#btnSaveCfg").addEventListener("click", saveCfg);
$("#btnAddBloq").addEventListener("click", addBloq);
$("#btnAddIng").addEventListener("click", addIng);

$("#btnAsignar").addEventListener("click", generarPlanificacion);
$("#btnLimpiar").addEventListener("click", resetAll);

document.querySelectorAll(".tab").forEach(t => t.addEventListener("click", ()=> switchTab(t.dataset.tab)));
$("#selEstudiante").addEventListener("change", onPickStudent);
$("#selDocente").addEventListener("change", onPickDocente);

$("#btnEditar").addEventListener("click", openEdit);
$("#btnCerrarEdicion").addEventListener("click", closeEdit);
$("#btnAplicarEdicion").addEventListener("click", aplicarEdicion);

// Cerrar modales al hacer click fuera del cuadro
document.querySelectorAll(".modal").forEach(m=>{
  m.addEventListener("click", (e)=>{ if(e.target===m) m.style.display="none"; });
});

// Inicial
fillDaySlotSelects();
renderGrid("#gridEstudiante", null, "estudiante");
renderGrid("#gridDocente", null, "docente");
</script>
</body>
</html>
