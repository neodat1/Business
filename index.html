<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Malla a Filas — Estándar 2019/2023 (sin pérdida)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f7f7f9;margin:0}
    .wrap{max-width:1200px;margin:28px auto;background:#fff;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.08);padding:28px}
    h1{margin:0 0 12px;color:#8a1f2d}
    .note{background:#e9effa;border-radius:8px;padding:12px 14px;margin:8px 0 18px}
    label{font-weight:600;margin-right:10px}
    select{padding:6px 10px;margin-right:18px}
    .btn{background:#244a8a;color:#fff;border:0;border-radius:8px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#173b74}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{border:1px solid #d6d6d6;padding:8px 10px}
    th{background:#8a1f2d;color:#fff;position:sticky;top:0}
    tr:nth-child(even){background:#fafafa}
    td[contenteditable="true"]{background:#fffbe6}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Malla a Filas (2019/2023 — sin eliminar materias)</h1>
  <div class="note">
    <b>1.</b> Elige Carrera y Año. <b>2.</b> Sube tu malla Excel (2019 o 2023).<br/>
    <b>3.</b> Se extraen TODAS las materias; si faltan horas se ponen <b>0</b>.<br/>
    <b>4.</b> Completa <i>PRERREQUISITO</i> (editable) y descarga.
  </div>

  <label>Carrera:
    <select id="carrera">
      <option>Administración</option>
      <option>Negocios Internacionales</option>
      <option>Marketing</option>
    </select>
  </label>

  <label>Año de malla:
    <select id="anio">
      <option>2019</option>
      <option>2023</option>
    </select>
  </label>

  <input type="file" id="file" accept=".xlsx" class="btn" />
  <button class="btn" id="btnExcel">Descargar como Excel</button>

  <div id="out"></div>
</div>

<script>
let filas = [];
const HEADERS = ["CARRERA","AÑO","CICLO","MATERIA","CÓDIGO","HORAS TEÓRICAS","HORAS PRÁCTICAS","HORAS AUTÓNOMAS","PRERREQUISITO"];

// Utilidades
const CYCLE_WORDS = ["PRIMERO","SEGUNDO","TERCERO","CUARTO","QUINTO","SEXTO","SÉPTIMO","SEPTIMO","OCTAVO","NOVENO","DÉCIMO","DECIMO"];
function up(s){ return String(s??"").trim().toUpperCase(); }
function hasNum(v){ return v!==undefined && v!==null && String(v).trim()!=="" && !isNaN(Number(String(v).replace(/[^0-9.-]/g,""))); }
function n0(v){ return hasNum(v) ? Number(String(v).replace(/[^0-9.-]/g,"")) : 0; }
function isCycleText(x){ return CYCLE_WORDS.includes(up(x)); }
function isTotal(x){ return up(x)==="TOTAL"; }

// Patrones de código (muy inclusivos)
const RE_2019     = /^[A-Z]{2,4}-\d{2,3}-[A-Z0-9]{2,}$/;  // FT-02-MATFIN
const RE_2023_A   = /^[A-Z]{3}\s?\d{3}$/;                 // MKT397 | MKT 397 | ECN211
const RE_2023_B   = /^[A-Z]{3}-\d{3}$/;                   // TMC-110
const RE_2023_C   = /^[A-Z]{2,4}\s?\d{3}$/;               // DIR400 | DIR 400
const RE_INTERNAL = /^[A-Z]{1,6}_[A-Z0-9_]{2,}$/;         // FCA_..., NI_..., BS_...
const RE_FALLBACK = /^(?=.*\d)[A-Z0-9 -]{3,}$/;           // letras/números/espacios/guiones (sin _), con dígito

function looksLikeCode(s){
  const S = up(s);
  if (!S || isTotal(S)) return false;
  return RE_2019.test(S) || RE_2023_A.test(S) || RE_2023_B.test(S) || RE_2023_C.test(S) || RE_INTERNAL.test(S) || RE_FALLBACK.test(S);
}

// Busca la fila de ciclos (encabezados)
function findCyclesRow(A){
  for (let r=0; r<Math.min(12, A.length); r++){
    const row = A[r] || [];
    let m = 0;
    for (const c of row) if (isCycleText(c)) m++;
    if (m >= 2) return r;
  }
  return 0; // fallback
}

function collectCycleCols(A, cyclesRow){
  const header = A[cyclesRow] || [];
  const cols = [];
  for (let j=0; j<header.length; j++){
    if (isCycleText(header[j])) cols.push({ col:j, ciclo: up(header[j]) });
  }
  if (!cols.length){
    // fallback cada 5 columnas
    const width = A[0]?.length || 0;
    for (let j=0; j<width; j+=5) cols.push({ col:j, ciclo: "" });
  }
  return cols;
}

// Selecciona la mejor fila de código después del nombre (1..4 filas hacia abajo)
function pickCodeRow(A, startRow, col){
  let candidateWithHours = null;
  let candidateNonInternal = null;
  let anyCandidate = null;

  for (let k=1; k<=4 && (startRow+k)<A.length; k++){
    const codeRaw = A[startRow+k]?.[col];
    if (codeRaw===undefined || codeRaw===null || String(codeRaw).trim()==="") continue;
    const codeUp = up(codeRaw);
    if (isTotal(codeUp)) continue;

    const ht = A[startRow+k]?.[col+1];
    const hp = A[startRow+k]?.[col+2];
    const ha = A[startRow+k]?.[col+3];
    const hasHours = hasNum(ht) || hasNum(hp) || hasNum(ha);

    if (looksLikeCode(codeUp)){
      if (hasHours && !RE_INTERNAL.test(codeUp)){
        // mejor caso: código oficial + horas
        return { row: startRow+k, code: String(codeRaw).trim(), ht, hp, ha };
      }
      if (hasHours && !candidateWithHours){
        candidateWithHours = { row: startRow+k, code: String(codeRaw).trim(), ht, hp, ha };
      }
      if (!RE_INTERNAL.test(codeUp) && !candidateNonInternal){
        candidateNonInternal = { row: startRow+k, code: String(codeRaw).trim(), ht, hp, ha };
      }
      if (!anyCandidate){
        anyCandidate = { row: startRow+k, code: String(codeRaw).trim(), ht, hp, ha };
      }
    }
  }
  return candidateWithHours || candidateNonInternal || anyCandidate; // puede ser interno o sin horas
}

document.getElementById('file').addEventListener('change', (e) => {
  filas = [];
  const file = e.target.files?.[0];
  if (!file) return;

  const carrera = document.getElementById('carrera').value;
  const anio = document.getElementById('anio').value;

  const reader = new FileReader();
  reader.onload = (evt) => {
    const wb = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });

    wb.SheetNames.forEach((name) => {
      const A = XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1, raw: true });
      if (!A?.length) return;

      const cyclesRow = findCyclesRow(A);
      const cycleCols = collectCycleCols(A, cyclesRow);
      const header = A[cyclesRow] || [];

      for (const {col, ciclo} of cycleCols){
        let r = cyclesRow + 1;
        while (r < A.length){
          const nombreRaw = A[r]?.[col];
          const nombreUp  = up(nombreRaw);
          if (!nombreUp || isTotal(nombreUp)){ r++; continue; }

          // Buscar la fila de código asociada
          const pick = pickCodeRow(A, r, col);

          if (pick){
            filas.push({
              "CARRERA": carrera,
              "AÑO": anio,
              "CICLO": ciclo || up(header[col] ?? ""),
              "MATERIA": String(nombreRaw).trim(),
              "CÓDIGO": pick.code,
              "HORAS TEÓRICAS": n0(pick.ht),
              "HORAS PRÁCTICAS": n0(pick.hp),
              "HORAS AUTÓNOMAS": n0(pick.ha),
              "PRERREQUISITO": ""
            });
            // avanzar justo después de la fila de código; saltar líneas "TOTAL" consecutivas
            r = pick.row + 1;
            while (r < A.length && isTotal(A[r]?.[col])) r++;
          } else {
            // No se encontró código (igual no eliminamos la materia)
            filas.push({
              "CARRERA": carrera,
              "AÑO": anio,
              "CICLO": ciclo || up(header[col] ?? ""),
              "MATERIA": String(nombreRaw).trim(),
              "CÓDIGO": "",                      // sin código visible
              "HORAS TEÓRICAS": 0,
              "HORAS PRÁCTICAS": 0,
              "HORAS AUTÓNOMAS": 0,
              "PRERREQUISITO": ""
            });
            r++; // continuar con la siguiente fila
          }
        }
      }
    });

    renderTabla();
  };
  reader.readAsArrayBuffer(file);
});

function renderTabla(){
  const out = document.getElementById('out');
  if (!filas.length){
    out.innerHTML = "<p style='color:#c00'><b>No se encontraron materias.</b></p>";
    return;
  }
  let html = "<table><thead><tr>"+HEADERS.map(h=>`<th>${h}</th>`).join("")+"</tr></thead><tbody>";
  for (let i=0;i<filas.length;i++){
    html += "<tr>";
    for (const h of HEADERS){
      if (h==="PRERREQUISITO"){
        html += `<td contenteditable="true" data-row="${i}" data-key="${h}">${filas[i][h]??""}</td>`;
      }else{
        html += `<td>${filas[i][h]??""}</td>`;
      }
    }
    html += "</tr>";
  }
  html += "</tbody></table>";
  out.innerHTML = html;
}

function syncPrereqsFromDOM(){
  const tds = document.querySelectorAll('td[contenteditable="true"][data-key="PRERREQUISITO"]');
  tds.forEach(td=>{
    const idx = Number(td.getAttribute('data-row'));
    filas[idx]["PRERREQUISITO"] = td.innerText.trim();
  });
}

document.getElementById('btnExcel').addEventListener('click', () => {
  if (!filas.length) return;
  syncPrereqsFromDOM();
  const data = [HEADERS, ...filas.map(f => HEADERS.map(h => (f[h] ?? "")))];
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Malla");
  XLSX.writeFile(wb, "malla_filas.xlsx");
});
</script>
</body>
</html>
