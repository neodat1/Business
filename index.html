<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planificación Académica UIDE — Generador desde Excel</title>
  <!-- Colores institucionales -->
  <style>
    :root{
      --azul: #04136C;
      --mostaza: #DE912E;
      --vino: #862B39;
      --celeste: #9CBEE3;
      --verde: #8A9520;
      --bg: #F7F8FC;
      --txt: #1F2937;
      --muted: #6B7280;
      --card: #FFFFFF;
      --ok: #16a34a;
      --warn: #d97706;
      --err: #b91c1c;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    header{display:flex;align-items:center;gap:16px;padding:16px 24px;background:var(--card);border-bottom:4px solid var(--azul);position:sticky;top:0;z-index:20}
    header img{height:52px}
    header h1{font-size:20px;margin:0;color:var(--azul);}
    header .tag{margin-left:auto;background:var(--celeste);color:#0b1b4d;padding:6px 10px;border-radius:999px;font-weight:600}

    main{max-width:1200px;margin:24px auto;padding:0 16px 64px}
    .panel{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px 16px;margin-bottom:16px;border:1px solid #e5e7eb}
    .panel h2{margin:0 0 8px 0;font-size:18px;color:var(--vino)}
    .sub{font-size:12px;color:var(--muted);margin-top:4px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}

    label{font-size:12px;color:var(--muted);display:block;margin:4px 0}
    input[type="file"], select, input[type="text"], input[type="number"], button{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff}
    button{cursor:pointer;border:0}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--azul);color:#fff;font-weight:600}
    .btn.secondary{background:var(--mostaza);color:#3a2200}
    .btn.ghost{background:#fff;color:var(--azul);border:2px solid var(--azul)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}

    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{font-size:11px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe}

    .lists{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width: 1000px){.lists{grid-template-columns:1fr 1fr}}

    .list{background:var(--card);border-radius:16px;border:1px solid #e5e7eb}
    .list header{position:relative;border-bottom:1px solid #e5e7eb}
    .list header h3{font-size:16px;color:var(--azul)}
    .list ol{margin:0;padding:0;list-style:none;max-height:580px;overflow:auto}

    .item{padding:12px 16px;border-bottom:1px dashed #e5e7eb}
    .item:last-child{border-bottom:0}
    .k{font-size:11px;color:#555;font-weight:700}
    .v{font-size:13px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}

    .badge-ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;padding:2px 8px;border-radius:999px;font-size:11px}
    .badge-warn{background:#fffbeb;color:#92400e;border:1px solid #fde68a;padding:2px 8px;border-radius:999px;font-size:11px}
    .badge-err{background:#fef2f2;color:#991b1b;border:1px solid #fecaca;padding:2px 8px;border-radius:999px;font-size:11px}

    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .legend .sw{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:6px}

    .muted{color:var(--muted)}
    .hr{height:1px;background:#e5e7eb;margin:10px 0}

    dialog{border:0;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.2);padding:0}
    dialog .dlg{padding:18px 18px 16px 18px;min-width:340px}
    dialog .dlg h4{margin:0 0 10px 0;color:var(--azul)}
  </style>
  <!-- SheetJS (lectura Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <img src="UIDE-Ecuador.png" alt="UIDE Ecuador" />
    <h1>Planificación Académica — Generador desde Excel</h1>
    <span class="tag">v1.0</span>
  </header>

  <main>
    <!-- Carga de archivos -->
    <section class="panel">
      <h2>1) Cargar archivos Excel</h2>
      <div class="grid">
        <div class="col-4">
          <label>Archivo de Mallas (*.xlsx)</label>
          <input type="file" id="fileMalla" accept=".xlsx,.xls" />
          <div class="sub">Debe incluir columnas mínimas: <em>CARRERA, MALLA, MATERIA, CÓDIGO ANTHOLOGY, CÓDIGO, PRE-REQUISITO, HORAS TEÓRICAS, HORAS PRÁCTICAS, HORAS AUTÓNOMAS, CRÉDITOS, CAMPO DE FORMACIÓN, CICLO MALLA, Nº ORDEN EN LA MALLA, COMPARTIDA CON</em>.</div>
        </div>
        <div class="col-4">
          <label>Archivo de Docentes (*.xlsx)</label>
          <input type="file" id="fileDocente" accept=".xlsx,.xls" />
          <div class="sub">Columnas mínimas: <em>DOCENTE, TÍTULO ACADÉMICO, DEDICACIÓN, MATERIA (una o varias, sep. por /), DISPONIBILIDAD (ej.: "Lunes 7-10 / Martes 10-13"), PARALELO (opcional)</em>.</div>
        </div>
        <div class="col-4">
          <label>Archivo de Estudiantes (*.xlsx)</label>
          <input type="file" id="fileEstudiante" accept=".xlsx,.xls" />
          <div class="sub">Columnas mínimas: <em>CARRERA, ESTUDIANTE, CICLO DEL ESTUDIANTE, MALLA, NIVEL INGLÉS, OBSERVACIONES</em>. Puede incluir: <em>INGLÉS (horario), PRÁCTICAS (horario)</em>.</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="grid">
        <div class="col-6">
          <h3 style="color:var(--azul);margin:4px 0 6px 0">Restricciones programáticas</h3>
          <div class="grid">
            <div class="col-6">
              <label>Carrera (para bloqueo de Prácticas comunitarias)</label>
              <input id="rcCarrera" type="text" placeholder="p.ej., Administración" />
            </div>
            <div class="col-6">
              <label>Ciclo (semestre) a bloquear</label>
              <input id="rcCiclo" type="number" min="1" step="1" placeholder="p.ej., 2" />
            </div>
            <div class="col-6">
              <label>Día a bloquear</label>
              <select id="rcDia"></select>
            </div>
            <div class="col-6">
              <label>Franja a bloquear</label>
              <select id="rcSlot"></select>
            </div>
          </div>
          <div class="actions" style="margin-top:8px">
            <button class="btn ghost" id="btnAgregarBloqueo">Agregar restricción</button>
            <span class="sub" id="restrResume">Sin restricciones añadidas.</span>
          </div>
        </div>
        <div class="col-6">
          <h3 style="color:var(--azul);margin:4px 0 6px 0">Parámetros de asignación</h3>
          <div class="chips">
            <span class="chip">Lunes–Viernes</span>
            <span class="chip">Franjas: 7-10 / 10-13 / 13-16 / 16-19 / 19-22</span>
            <span class="chip">Máximo 2 materias por día (docente y estudiante)</span>
            <span class="chip">Evitar choques entre ciclos adyacentes</span>
          </div>
        </div>
      </div>
      <div class="actions" style="margin-top:12px">
        <button class="btn" id="btnProcesar">Procesar y asignar</button>
        <button class="btn secondary" id="btnLimpiar">Limpiar todo</button>
        <span id="status" class="sub"></span>
      </div>
      <div class="legend">
        <span><span class="sw" style="background:var(--azul)"></span>Encabezados</span>
        <span><span class="sw" style="background:var(--mostaza)"></span>Acciones</span>
        <span><span class="sw" style="background:var(--vino)"></span>Secciones</span>
        <span><span class="sw" style="background:var(--celeste)"></span>Etiquetas</span>
        <span><span class="sw" style="background:var(--verde)"></span>Indicadores</span>
      </div>
    </section>

    <!-- Listas -->
    <section class="lists">
      <div class="list">
        <header>
          <h3 style="padding:12px 16px">Planificación docente</h3>
        </header>
        <ol id="listDocente"></ol>
      </div>
      <div class="list">
        <header>
          <h3 style="padding:12px 16px">Planificación estudiante</h3>
        </header>
        <ol id="listEstudiante"></ol>
      </div>
      <div class="list" style="grid-column:1/-1">
        <header>
          <h3 style="padding:12px 16px">Materias ofertadas</h3>
        </header>
        <ol id="listMaterias"></ol>
      </div>
    </section>

    <!-- Edición de estudiantes -->
    <section class="panel">
      <h2>2) Modificación de asignación (solo estudiantes)</h2>
      <div class="grid">
        <div class="col-6">
          <label>Buscar estudiante</label>
          <input id="buscarEst" type="text" placeholder="Escriba el nombre para editar" />
        </div>
        <div class="col-6" style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn" id="btnEditarEst">Abrir editor</button>
          <span class="sub">Si hay cruce de horarios, se le notificará y podrá reasignar otra materia.</span>
        </div>
      </div>
    </section>
  </main>

  <!-- Diálogo de edición -->
  <dialog id="dlgEdit">
    <div class="dlg">
      <h4>Editar asignación del estudiante</h4>
      <div id="dlgBody" class="sub">Cargando…</div>
      <div class="actions" style="margin-top:12px">
        <button class="btn" id="dlgGuardar">Guardar cambios</button>
        <button class="btn ghost" id="dlgCerrar">Cerrar</button>
      </div>
    </div>
  </dialog>

<script>
(function(){
  'use strict';
  // Días y franjas institucionales
  const DIAS = ["Lunes","Martes","Miércoles","Jueves","Viernes"];
  const SLOTS = ["7-10","10-13","13-16","16-19","19-22"]; // 3h por franja

  // Estado en memoria
  let datosMalla = [];     // filas de malla
  let datosDocentes = [];  // filas de docente
  let datosEstudiantes = [];// filas de estudiante

  let ofertas = [];        // materias ofertadas (con horario y docente)
  let planDocente = [];    // lista final para docentes
  let planEst = [];        // lista final para estudiantes

  // Restricciones: { carrera, ciclo, dia, slot }
  let restricciones = [];

  // Helpers UI
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const listDocente = $('#listDocente');
  const listEstudiante = $('#listEstudiante');
  const listMaterias = $('#listMaterias');
  const status = $('#status');

  // Llenar selects de día/slot
  const selDia = $('#rcDia');
  const selSlot = $('#rcSlot');
  DIAS.forEach(d => selDia.append(new Option(d,d)));
  SLOTS.forEach(s => selSlot.append(new Option(s,s)));

  // Lectura Excel → arrays de objetos
  async function leerExcel(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const sheets = wb.SheetNames;
        // Preferir hoja por nombre; si no existe, tomar la primera
        const elegida = (file.name.toLowerCase().includes('malla') && sheets.find(s=>/malla/i.test(s)))
                      || (file.name.toLowerCase().includes('docente') && sheets.find(s=>/docente/i.test(s)))
                      || (file.name.toLowerCase().includes('estudiante') && sheets.find(s=>/estudiante/i.test(s)))
                      || sheets[0];
        const ws = wb.Sheets[elegida];
        const json = XLSX.utils.sheet_to_json(ws, {defval:""});
        resolve(json);
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  // Normalización de texto (claves)
  const norm = s => String(s||'').trim();

/* ==== Normalización de encabezados desde Excel (admite sinónimos) ==== */
const keyClean = k => String(k||'').toLowerCase().replace(/\s+/g,'').replace(/[^a-z0-9]/g,'');

const MAP_MALLA_EQ = {
  carrera: ['carrera','carreras','programa'],
  malla: ['malla','planestudios','pensum'],
  materia: ['materia','asignatura'],
  codigoanthology: ['codigoanthology','códigoanthology','idanthology','anthology','codigo anthology'],
  codigo: ['codigo','código','id'],
  prereq: ['pre-requisito','prerequisito','pre requisito','prerrequisito','pre req','preq'],
  ht: ['horas teoricas','horasteoricas','ht'],
  hp: ['horas practicas','horaspracticas','hp'],
  ha: ['horas autonomas','horasautonomas','ha'],
  creditos: ['creditos','créditos','cr'],
  campo: ['campodeformacion','campo','areaformacion','area'],
  ciclo: ['ciclomalla','ciclo','semestre'],
  norden: ['nº orden en la malla','n° orden en la malla','nordenenlamalla','nordenmalla','numorden','orden'],
  compartida: ['compartida con','compartidacon','compartidaconcarrera','compartidas']
};
const MAP_DOC_EQ = {
  docente:['docente','profesor','catedratico'],
  titulo:['título académico','titulo academico','titulo','título'],
  dedicacion:['dedicacion','dedicación','jornadalaboral'],
  materia:['materia','materias','asignatura','asignaturas'],
  disp:['disponibilidad','disponibilidadhoraria','horario'],
  paralelo:['paralelo','par']
};
const MAP_EST_EQ = {
  carrera:['carrera','programa'],
  estudiante:['estudiante','alumno'],
  cicloEst:['ciclo del estudiante','cicloestudiante','ciclodelestudiante','ciclo','semestre'],
  malla:['malla','planestudios','pensum'],
  nivelIng:['nivel inglés','nivel ingles','nivelingles'],
  obs:['observaciones','obs','comentarios'],
  ingles:['inglés','ingles','horarioingles'],
  pract:['prácticas','practicas','practicascomunitarias']
};

function pick(obj, variants){
  const keys = Object.keys(obj);
  for(const v of variants){
    const k = keys.find(x => keyClean(x) === keyClean(v));
    if (k) return obj[k];
  }
  return '';
}

function normalizeMallaRows(rows){
  return rows.map(r=>({
    'CARRERA': pick(r, MAP_MALLA_EQ.carrera),
    'MALLA': pick(r, MAP_MALLA_EQ.malla),
    'MATERIA': pick(r, MAP_MALLA_EQ.materia),
    'CÓDIGO ANTHOLOGY': pick(r, MAP_MALLA_EQ.codigoanthology),
    'CÓDIGO': pick(r, MAP_MALLA_EQ.codigo),
    'PRE-REQUISITO': pick(r, MAP_MALLA_EQ.prereq),
    'HORAS TEÓRICAS': pick(r, MAP_MALLA_EQ.ht),
    'HORAS PRÁCTICAS': pick(r, MAP_MALLA_EQ.hp),
    'HORAS AUTÓNOMAS': pick(r, MAP_MALLA_EQ.ha),
    'CREDITOS': pick(r, MAP_MALLA_EQ.creditos),
    'CAMPO DE FORMACIÓN': pick(r, MAP_MALLA_EQ.campo),
    'CICLO MALLA': pick(r, MAP_MALLA_EQ.ciclo),
    'Nº ORDEN EN LA MALLA': pick(r, MAP_MALLA_EQ.norden),
    'COMPARTIDA CON': pick(r, MAP_MALLA_EQ.compartida)
  }));
}
function normalizeDocRows(rows){
  return rows.map(r=>({
    'DOCENTE': pick(r, MAP_DOC_EQ.docente),
    'TÍTULO ACADÉMICO': pick(r, MAP_DOC_EQ.titulo),
    'DEDICACIÓN': pick(r, MAP_DOC_EQ.dedicacion),
    'MATERIA': pick(r, MAP_DOC_EQ.materia),
    'DISPONIBILIDAD': pick(r, MAP_DOC_EQ.disp),
    'PARALELO': pick(r, MAP_DOC_EQ.paralelo)
  }));
}
function normalizeEstRows(rows){
  return rows.map(r=>({
    'CARRERA': pick(r, MAP_EST_EQ.carrera),
    'ESTUDIANTE': pick(r, MAP_EST_EQ.estudiante),
    'CICLO DEL ESTUDIANTE': pick(r, MAP_EST_EQ.cicloEst),
    'MALLA': pick(r, MAP_EST_EQ.malla),
    'NIVEL INGLÉS': pick(r, MAP_EST_EQ.nivelIng),
    'OBSERVACIONES': pick(r, MAP_EST_EQ.obs),
    'INGLÉS': pick(r, MAP_EST_EQ.ingles),
    'PRÁCTICAS': pick(r, MAP_EST_EQ.pract)
  }));
}
  
  // Parse disponibilidad: "Lunes 7-10 / Martes 10-13"
function parseDisponibilidad(s){
  const out = [];
  norm(s).split(/[\n,;|/]+/).forEach(tok=>{
    const t = tok.trim(); if(!t) return;
    const m = t.match(/(Lunes|Martes|Miércoles|Miercoles|Jueves|Viernes)\s+([0-9]{1,2})(?::?00)?\s*-\s*([0-9]{1,2})(?::?00)?/i);
    if(m){
      const dia = m[1].replace('Miercoles','Miércoles');
      const slot = `${m[2]}-${m[3]}`;
      if(['7-10','10-13','13-16','16-19','19-22'].includes(slot)) out.push({dia, slot});
    }
  });
  return out;
}


  // Agregar restricción (Prácticas comunitarias por carrera y ciclo)
  $('#btnAgregarBloqueo').addEventListener('click', () => {
    const carrera = norm($('#rcCarrera').value);
    const ciclo = parseInt($('#rcCiclo').value, 10);
    const dia = $('#rcDia').value;
    const slot = $('#rcSlot').value;
    if(!carrera || !ciclo){
      alert('Indique carrera y ciclo.');
      return;
    }
    restricciones.push({carrera, ciclo, dia, slot});
    $('#restrResume').textContent = restricciones.map(r=>`${r.carrera}·${r.ciclo}: ${r.dia} ${r.slot}`).join(' | ');
  });

  // Limpiar estado
  $('#btnLimpiar').addEventListener('click', () => {
    datosMalla = []; datosDocentes = []; datosEstudiantes = [];
    ofertas = []; planDocente = []; planEst = []; restricciones = [];
    listDocente.innerHTML = ''; listEstudiante.innerHTML=''; listMaterias.innerHTML='';
    $('#fileMalla').value=''; $('#fileDocente').value=''; $('#fileEstudiante').value='';
    $('#restrResume').textContent = 'Sin restricciones añadidas.';
    status.textContent = '';
  });

  // Procesar y asignar
  $('#btnProcesar').addEventListener('click', async () => {
    try{
      status.textContent = 'Leyendo archivos…';
      const fM = $('#fileMalla').files[0];
      const fD = $('#fileDocente').files[0];
      const fE = $('#fileEstudiante').files[0];
      if(!fM || !fD || !fE){
        alert('Cargue los tres archivos: Malla, Docente y Estudiante.');
        return;
      }
      [datosMalla, datosDocentes, datosEstudiantes] = await Promise.all([
        leerExcel(fM), leerExcel(fD), leerExcel(fE)
      ]);

      datosMalla = normalizeMallaRows(datosMalla);
datosDocentes = normalizeDocRows(datosDocentes);
datosEstudiantes = normalizeEstRows(datosEstudiantes);


      status.textContent = 'Preparando índices…';
      const idxMalla = indexarMalla(datosMalla);
      const docentesPorMateria = mapDocentesPorMateria(datosDocentes);

      status.textContent = 'Construyendo oferta (horarios y docentes)…';
      ofertas = construirOferta(idxMalla, docentesPorMateria);

      status.textContent = 'Asignando a docentes…';
      planDocente = construirPlanDocente(ofertas);

      status.textContent = 'Asignando a estudiantes…';
      planEst = construirPlanEstudiantes(ofertas, datosEstudiantes);

      status.textContent = 'Renderizando listas…';
      renderListas(planDocente, planEst, ofertas);
      status.textContent = 'Listo.';
    }catch(err){
      console.error(err);
      alert('Error: ' + err.message);
      status.textContent = 'Error.';
    }
  });

  // Indexar Malla por carrera y ciclo
  function indexarMalla(rows){
    const out = {};
    for(const r of rows){
      const carrera = norm(r['CARRERA']||r['Carrera']);
      const malla = norm(r['MALLA']||r['Malla']);
      const materia = norm(r['MATERIA']||r['Materia']);
      if(!carrera || !materia) continue;
      const ciclo = parseInt(r['CICLO MALLA']||r['Ciclo Malla']||r['CICLO']||r['Ciclo']||'0',10) || 0;
      const compartida = norm(r['COMPARTIDA CON']||r['Compartida con']);
      const carrerasComp = [carrera].concat(compartida? compartida.split(/[\/|,;]+/).map(s=>norm(s)).filter(Boolean): []);
      const key = carrera;
      out[key] = out[key] || {};
      out[key][ciclo] = out[key][ciclo] || [];
      out[key][ciclo].push({
        carreraBase: carrera,
        carreras: carrerasComp,
        malla,
        materia,
        codigoAnth: norm(r['CÓDIGO ANTHOLOGY']||r['Codigo Anthology']||r['CODIGO ANTHOLOGY']||r['Código Anthology']),
        codigo: norm(r['CÓDIGO']||r['Codigo']||r['Código']),
        prereq: norm(r['PRE-REQUISITO']||r['Prerrequisito']||r['PRE REQUISITO']||r['PRE REQ']),
        horasT: Number(r['HORAS TEÓRICAS']||r['HT']||0)||0,
        horasP: Number(r['HORAS PRÁCTICAS']||r['HP']||0)||0,
        horasA: Number(r['HORAS AUTÓNOMAS']||r['HA']||0)||0,
        creditos: Number(r['CREDITOS']||r['CRÉDITOS']||r['Créditos']||0)||0,
        campo: norm(r['CAMPO DE FORMACIÓN']||r['Campo de formación']||r['Campo']||''),
        cicloMalla: ciclo,
        numOrden: norm(r['Nº ORDEN EN LA MALLA']||r['No Orden']||r['N° ORDEN EN LA MALLA']||r['Orden']||''),
      });
    }
    return out;
  }

  // Mapear Docentes por materia
  function mapDocentesPorMateria(rows){
    const map = {};
    for(const r of rows){
      const docente = norm(r['DOCENTE']||r['Docente']);
      if(!docente) continue;
      const materiasStr = norm(r['MATERIA']||r['Materias']||'');
      const materias = materiasStr ? materiasStr.split(/[\/|,;]+/).map(s=>norm(s)).filter(Boolean) : [];
      const titulo = norm(r['TÍTULO ACADÉMICO']||r['TITULO ACADEMICO']||r['Título Académico']||'');
      const dedicacion = norm(r['DEDICACIÓN']||r['Dedicación']||r['DEDICACION']||'');
      const disponibilidad = parseDisponibilidad(r['DISPONIBILIDAD']||r['Disponibilidad']||'');
      const paralelo = norm(r['PARALELO']||r['Paralelo']||'');
      const base = {docente, titulo, dedicacion, disponibilidad, paralelo, carga:{}}; // carga["Lunes"] = count por día
      if(materias.length===0){
        // Si no hay materias especificadas, aceptar cualquier materia (perfil general)
        map['*'] = map['*'] || [];
        map['*'].push(base);
      } else {
        materias.forEach(m =>{
          map[m] = map[m] || [];
          map[m].push(base);
        });
      }
    }
    return map;
  }

  // Construir oferta (horarios y docente) respetando restricciones & disponibilidad
  function construirOferta(idxMalla, docentesPorMateria){
    const oferta = [];
    // Timetable por carrera y ciclo → set de {dia,slot}
    const usadoPorCarreraCiclo = {}; // key: carrera|ciclo → Map(dia|slot → true)

    function ocupado(carrera, ciclo, dia, slot){
      const key = `${carrera}|${ciclo}`;
      const m = usadoPorCarreraCiclo[key];
      return m && m.get(`${dia}|${slot}`);
    }
    function marcar(carrera, ciclo, dia, slot){
      const key = `${carrera}|${ciclo}`;
      if(!usadoPorCarreraCiclo[key]) usadoPorCarreraCiclo[key] = new Map();
      usadoPorCarreraCiclo[key].set(`${dia}|${slot}`, true);
    }

    // por carrera y ciclo
    for(const carrera of Object.keys(idxMalla)){
      const ciclos = Object.keys(idxMalla[carrera]).map(x=>parseInt(x,10)).sort((a,b)=>a-b);
      for(const ciclo of ciclos){
        const materias = idxMalla[carrera][ciclo];
        for(const mat of materias){
          // Seleccionar un docente disponible
          const pool = (docentesPorMateria[mat.materia]||[]).concat(docentesPorMateria['*']||[]);
          // Heurística: docente con menor carga total y con disponibilidad libre
          let elegido = null, elegidoScore = Infinity, elegidoDia=null, elegidoSlot=null;

          for(const d of pool){
            for(const {dia,slot} of d.disponibilidad){
              // No más de 2 materias por día (docente)
              const cargaDia = d.carga[dia]||0;
              if(cargaDia >= 2) continue;
              // Evitar choques entre ciclos adyacentes dentro de la misma carrera
              const ady = [ciclo-1, ciclo, ciclo+1];
              let choqueAdy = false;
              for(const c2 of ady){
                if(c2<=0) continue;
                if(ocupado(carrera, c2, dia, slot)){ choqueAdy = true; break; }
              }
              if(choqueAdy) continue;
              // Restricción de prácticas
              const tieneRestr = restricciones.some(r => r.carrera.toLowerCase()===carrera.toLowerCase() && r.ciclo===ciclo && r.dia===dia && r.slot===slot);
              if(tieneRestr) continue;

              // Score: preferir franjas tempranas y días al inicio de la semana, y menor carga acumulada
              const score = DIAS.indexOf(dia)*10 + SLOTS.indexOf(slot) + (d.carga.total||0);
              if(score < elegidoScore){
                elegido = d; elegidoScore = score; elegidoDia = dia; elegidoSlot = slot;
              }
            }
          }

          if(elegido){
            // Marcar ocupación y carga docente
            elegido.carga[elegidoDia] = (elegido.carga[elegidoDia]||0) + 1;
            elegido.carga.total = (elegido.carga.total||0) + 1;
            marcar(carrera, ciclo, elegidoDia, elegidoSlot);

            // Armar string de Nº ORDEN por carrera si compartida
            const ordenPorCarrera = mat.carreras.map(ca => {
              // Buscar entre filas originales de esa carrera para extraer su número de orden
              const fila = (idxMalla[ca] && idxMalla[ca][mat.cicloMalla]||[]).find(f=>f.materia===mat.materia);
              const ord = fila ? norm(fila.numOrden||'') : '';
              return (ord? `${ca}: ${ord}` : `${ca}: -`);
            }).join(' / ');

            oferta.push({
              carreraBase: mat.carreraBase,
              carreras: mat.carreras,
              malla: mat.malla,
              materia: mat.materia,
              codigoAnth: mat.codigoAnth,
              codigo: mat.codigo,
              prereq: mat.prereq,
              horasT: mat.horasT,
              horasP: mat.horasP,
              horasA: mat.horasA,
              creditos: mat.creditos,
              campo: mat.campo,
              cicloMalla: mat.cicloMalla,
              numOrdenPorCarrera: ordenPorCarrera,
              paralelo: elegido.paralelo || 'A',
              docente: elegido.docente,
              titulo: elegido.titulo,
              dedicacion: elegido.dedicacion,
              dia: elegidoDia,
              slot: elegidoSlot,
              modalidad: 'Presencial', // por defecto; ajustar si existiera columna
              horasAsignadas: 3 // cada franja = 3 horas
            });
          }
        }
      }
    }

    return oferta;
  }

  // Construir lista para docentes (una entrada por oferta)
  function construirPlanDocente(ofertas){
    return ofertas.map(o => ({
      DOCENTE: o.docente,
      'TITULO ACADÉMICO': o.titulo,
      'DEDICACIÓN': o.dedicacion,
      'MATERIA': o.materia,
      'CÓDIGO ANTHOLOGY': o.codigoAnth,
      'CARRERAS QUE COMPARTEN': o.carreras.join(' / '),
      'PRE-REQUISITO': o.prereq,
      'CODIGO': o.codigo,
      'HORAS TEÓRICAS': o.horasT,
      'HORAS PRÁCTICAS': o.horasP,
      'HORAS AUTÓNOMAS': o.horasA,
      'CREDITOS': o.creditos,
      'CAMPO DE FORMACIÓN': o.campo,
      'CICLO MALLA': o.cicloMalla,
      'Nº ORDEN EN LA MALLA': o.numOrdenPorCarrera,
      'PARALELO': o.paralelo,
      'DIA': o.dia,
      'HORA': o.slot,
      'MODALIDAD': o.modalidad,
      'Nro. HORAS': o.horasAsignadas
    }));
  }

  // Asignar estudiantes respetando máximo 2 materias por día y hasta 6 materias
  function construirPlanEstudiantes(ofertas, estudiantes){
    // Índice de oferta por carrera & ciclo & materia
    const idxOferta = {};
    for(const o of ofertas){
      for(const car of o.carreras){
        const k = `${car}|${o.cicloMalla}|${o.materia}`;
        idxOferta[k] = idxOferta[k] || [];
        idxOferta[k].push(o);
      }
    }

    const resultado = [];

    for(const e of estudiantes){
      const carrera = norm(e['CARRERA']||e['Carrera']);
      const estudiante = norm(e['ESTUDIANTE']||e['Estudiante']);
      if(!carrera || !estudiante) continue;
      const cicloEst = parseInt(e['CICLO DEL ESTUDIANTE']||e['Ciclo del estudiante']||'0',10)||0;
      const malla = norm(e['MALLA']||e['Malla']);
      const nivelIngles = norm(e['NIVEL INGLÉS']||e['Nivel Inglés']||e['Nivel Ingles']||'');
      const obs = norm(e['OBSERVACIONES']||e['Observaciones']||'');
      const inglesBloq = norm(e['INGLÉS']||e['INGLES']||'');
      const practBloq = norm(e['PRÁCTICAS']||e['PRACTICAS']||'');

      const bloqueosEst = [...parseDisponibilidad(inglesBloq), ...parseDisponibilidad(practBloq)];

      // Buscar materias de su ciclo (por carrera)
      const materiasPosibles = ofertas.filter(o => o.carreras.map(c=>c.toLowerCase()).includes(carrera.toLowerCase()) && o.cicloMalla===cicloEst);

      // Control de choques por día y franja (máx 2 por día)
      const cargaDia = {};
      let count = 0;
      for(const o of materiasPosibles){
        if(count >= 6) break; // máximo de 6 materias
        // Evitar choques propios (misma franja)
        const ya = resultado.find(r => r.ESTUDIANTE===estudiante && r.DIA===o.dia && r.HORA===o.slot);
        if(ya) continue;
        // Máx 2 por día
        const cDia = cargaDia[o.dia]||0;
        if(cDia >= 2) continue;
        // Evitar bloqueos individuales (inglés / prácticas)
        const ch = bloqueosEst.some(b => b.dia===o.dia && b.slot===o.slot);
        if(ch) continue;

        resultado.push({
          'CARRERA': carrera,
          'ESTUDIANTE': estudiante,
          'CICLO DEL ESTUDIANTE': cicloEst,
          'MALLA': malla,
          'CICLO DE LA MATERIA EN LA MALLA': o.cicloMalla,
          'COMPARTIDA CON\tCARRERA': o.carreras.join(' / '),
          'MATERIA': o.materia,
          'PARALELO': o.paralelo,
          'DIA': o.dia,
          'HORA': o.slot,
          'MODALIDAD': o.modalidad,
          'NIVEL INGLES': nivelIngles,
          'OBSERVACIONES': obs,
          'DOCENTE': o.docente
        });
        cargaDia[o.dia] = cDia + 1;
        count++;
      }
    }

    return resultado;
  }

  // Renderizado de listas (como <ol> con ítems y campos solicitados)
  function renderListas(planDoc, planEst, mats){
    function liDoc(d){
      return `<li class="item">
        <div class="row"><div><span class="k">DOCENTE</span><div class="v">${esc(d['DOCENTE'])}</div></div>
             <div><span class="k">TITULO ACADÉMICO</span><div class="v">${esc(d['TITULO ACADÉMICO']||d['TÍTULO ACADÉMICO']||'')}</div></div></div>
        <div class="row"><div><span class="k">DEDICACIÓN</span><div class="v">${esc(d['DEDICACIÓN']||d['Dedicación']||'')}</div></div>
             <div><span class="k">MATERIA</span><div class="v">${esc(d['MATERIA'])}</div></div></div>
        <div class="row"><div><span class="k">CÓDIGO ANTHOLOGY</span><div class="v">${esc(d['CÓDIGO ANTHOLOGY']||'')}</div></div>
             <div><span class="k">CARRERAS QUE COMPARTEN</span><div class="v">${esc(d['CARRERAS QUE COMPARTEN']||'')}</div></div></div>
        <div class="row"><div><span class="k">PRE-REQUISITO</span><div class="v">${esc(d['PRE-REQUISITO']||'')}</div></div>
             <div><span class="k">CODIGO</span><div class="v">${esc(d['CODIGO']||'')}</div></div></div>
        <div class="row"><div><span class="k">HORAS TEÓRICAS</span><div class="v">${esc(d['HORAS TEÓRICAS'])}</div></div>
             <div><span class="k">HORAS PRÁCTICAS</span><div class="v">${esc(d['HORAS PRÁCTICAS'])}</div></div></div>
        <div class="row"><div><span class="k">HORAS AUTÓNOMAS</span><div class="v">${esc(d['HORAS AUTÓNOMAS'])}</div></div>
             <div><span class="k">CREDITOS</span><div class="v">${esc(d['CREDITOS'])}</div></div></div>
        <div class="row"><div><span class="k">CAMPO DE FORMACIÓN</span><div class="v">${esc(d['CAMPO DE FORMACIÓN'])}</div></div>
             <div><span class="k">CICLO MALLA</span><div class="v">${esc(d['CICLO MALLA'])}</div></div></div>
        <div class="row"><div><span class="k">Nº ORDEN EN LA MALLA</span><div class="v">${esc(d['Nº ORDEN EN LA MALLA']||'')}</div></div>
             <div><span class="k">PARALELO</span><div class="v">${esc(d['PARALELO']||'')}</div></div></div>
        <div class="row"><div><span class="k">DIA</span><div class="v">${esc(d['DIA'])}</div></div>
             <div><span class="k">HORA</span><div class="v">${esc(d['HORA'])}</div></div></div>
        <div class="row"><div><span class="k">MODALIDAD</span><div class="v">${esc(d['MODALIDAD'])}</div></div>
             <div><span class="k">Nro. HORAS</span><div class="v">${esc(d['Nro. HORAS'])}</div></div></div>
      </li>`;
    }

    function liEst(d){
      return `<li class="item">
        <div class="row"><div><span class="k">CARRERA</span><div class="v">${esc(d['CARRERA'])}</div></div>
             <div><span class="k">ESTUDIANTE</span><div class="v">${esc(d['ESTUDIANTE'])}</div></div></div>
        <div class="row"><div><span class="k">CICLO DEL ESTUDIANTE</span><div class="v">${esc(d['CICLO DEL ESTUDIANTE'])}</div></div>
             <div><span class="k">MALLA</span><div class="v">${esc(d['MALLA'])}</div></div></div>
        <div class="row"><div><span class="k">CICLO DE LA MATERIA EN LA MALLA</span><div class="v">${esc(d['CICLO DE LA MATERIA EN LA MALLA'])}</div></div>
             <div><span class="k">COMPARTIDA CON CARRERA</span><div class="v">${esc(d['COMPARTIDA CON\tCARRERA'])}</div></div></div>
        <div class="row"><div><span class="k">MATERIA</span><div class="v">${esc(d['MATERIA'])}</div></div>
             <div><span class="k">PARALELO</span><div class="v">${esc(d['PARALELO'])}</div></div></div>
        <div class="row"><div><span class="k">DIA</span><div class="v">${esc(d['DIA'])}</div></div>
             <div><span class="k">HORA</span><div class="v">${esc(d['HORA'])}</div></div></div>
        <div class="row"><div><span class="k">MODALIDAD</span><div class="v">${esc(d['MODALIDAD'])}</div></div>
             <div><span class="k">NIVEL INGLÉS</span><div class="v">${esc(d['NIVEL INGLES'])}</div></div></div>
        <div class="row"><div><span class="k">OBSERVACIONES</span><div class="v">${esc(d['OBSERVACIONES'])}</div></div>
             <div><span class="k">DOCENTE</span><div class="v">${esc(d['DOCENTE'])}</div></div></div>
      </li>`;
    }

    function liMat(o){
      return `<li class="item">
        <div class="row"><div><span class="k">MALLA</span><div class="v">${esc(o.malla)}</div></div>
             <div><span class="k">CICLO DE LA MATERIA EN LA MALLA</span><div class="v">${esc(o.cicloMalla)}</div></div></div>
        <div class="row"><div><span class="k">COMPARTIDA CON CARRERA</span><div class="v">${esc(o.carreras.join(' / '))}</div></div>
             <div><span class="k">MATERIA</span><div class="v">${esc(o.materia)}</div></div></div>
        <div class="row"><div><span class="k">PARALELO</span><div class="v">${esc(o.paralelo)}</div></div>
             <div><span class="k">DIA</span><div class="v">${esc(o.dia)}</div></div></div>
        <div class="row"><div><span class="k">HORA</span><div class="v">${esc(o.slot)}</div></div>
             <div><span class="k">Número de estudiantes</span><div class="v">${contarEstudiantesMat(planEst, o)}</div></div></div>
      </li>`;
    }

    listDocente.innerHTML = planDoc.map(liDoc).join('');
    listEstudiante.innerHTML = planEst.map(liEst).join('');
    listMaterias.innerHTML = mats.map(liMat).join('');
  }

  function contarEstudiantesMat(planEst, of){
    return planEst.filter(e => e['MATERIA']===of.materia && e['PARALELO']===of.paralelo && e['DIA']===of.dia && e['HORA']===of.slot).length;
  }

  // Utilidad de escape HTML
  function esc(s){
    return String(s==null? '': s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }

  // ===== Edición (solo estudiantes) =====
  const dlg = $('#dlgEdit');
  const dlgBody = $('#dlgBody');
  let edEstActual = null; // nombre del estudiante en edición
  $('#btnEditarEst').addEventListener('click', () => {
    const q = norm($('#buscarEst').value);
    if(!q){ alert('Indique el nombre del estudiante.'); return; }
    const tiene = planEst.filter(p => p['ESTUDIANTE'].toLowerCase().includes(q.toLowerCase()));
    if(tiene.length===0){ alert('No se encontró el estudiante.'); return; }
    edEstActual = tiene[0]['ESTUDIANTE'];
    abrirEditorEstudiante(edEstActual);
  });

  function abrirEditorEstudiante(nombre){
    const asign = planEst.filter(p => p['ESTUDIANTE']===nombre);
    const carrera = asign[0]?.['CARRERA']||'';
    const ciclo = asign[0]?.['CICLO DEL ESTUDIANTE']||0;
    // Ofertas alternativas (misma carrera & ciclo)
    const alts = ofertas.filter(o => o.carreras.map(c=>c.toLowerCase()).includes((carrera||'').toLowerCase()) && o.cicloMalla===ciclo);

    const rows = asign.map((p,i)=>{
      // Opciones: misma materia otro horario (si existe), u otra materia del mismo ciclo
      const mismas = alts.filter(o => o.materia===p['MATERIA']);
      const otras = alts.filter(o => o.materia!==p['MATERIA']);
      const opts = [...mismas, ...otras].map(o=>`<option value="${i}|${esc(o.materia)}|${esc(o.paralelo)}|${esc(o.dia)}|${esc(o.slot)}">${esc(o.materia)} — ${esc(o.dia)} ${esc(o.slot)} (Par. ${esc(o.paralelo)})</option>`).join('');
      return `<div class="panel" style="padding:10px;margin:6px 0">
        <div class="row">
          <div><span class="k">Actual</span><div class="v">${esc(p['MATERIA'])} — ${esc(p['DIA'])} ${esc(p['HORA'])} (Par. ${esc(p['PARALELO'])})</div></div>
          <div>
            <label>Reasignar a:</label>
            <select class="selAlt">${opts}</select>
          </div>
        </div>
      </div>`
    }).join('');

    dlgBody.innerHTML = rows || '<div class="muted">Este estudiante no tiene materias asignadas.</div>';
    dlg.showModal();
  }

  $('#dlgCerrar').addEventListener('click', ()=> dlg.close());

  // Guardar cambios de edición (verifica cruces)
  $('#dlgGuardar').addEventListener('click', () => {
    if(!edEstActual){ dlg.close(); return; }
    const asign = planEst.filter(p => p['ESTUDIANTE']===edEstActual);
    const selects = $$('#dlgEdit .selAlt');
    const nuevas = [];
    // Proyectar cambios temporalmente para validar
    for(let i=0;i<selects.length;i++){
      const v = selects[i].value; // idx|materia|paralelo|dia|slot
      const [idx, materia, paralelo, dia, slot] = v.split('|');
      const orig = asign[i];
      nuevas.push({...orig, 'MATERIA': materia, 'PARALELO': paralelo, 'DIA': dia, 'HORA': slot});
    }
    // Validar: no más de 2 por día y sin cruces
    const cargaDia = {};
    for(const r of nuevas){
      const key = r['DIA'];
      cargaDia[key] = (cargaDia[key]||0)+1;
      if(cargaDia[key] > 2){ alert('Cruce: más de 2 materias el ' + key); return; }
    }
    for(let i=0;i<nuevas.length;i++){
      for(let j=i+1;j<nuevas.length;j++){
        if(nuevas[i]['DIA']===nuevas[j]['DIA'] && nuevas[i]['HORA']===nuevas[j]['HORA']){
          alert('Cruce: dos materias en la misma franja.');
          return;
        }
      }
    }
    // Aplicar cambios
    let k = 0;
    for(let p=0;p<planEst.length;p++){
      if(planEst[p]['ESTUDIANTE']===edEstActual){
        planEst[p] = nuevas[k++];
      }
    }
    renderListas(planDocente, planEst, ofertas);
    dlg.close();
  });

})();
</script>
</body>
</html>
