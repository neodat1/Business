<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matriz Académica UIDE</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --azul: #04136C;
      --mostaza: #DE912E;
      --vino: #862B39;
      --celeste: #9CBEE3;
      --verde: #8A9520;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
      color: #111;
    }
    header {
      background: var(--azul);
      color: white;
      padding: 10px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    header img {
      height: 60px;
    }
    h1 {
      font-size: 20px;
      margin: 0;
    }
    .container {
      padding: 20px;
    }
    input[type="file"] {
      margin: 10px 0;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #999;
      padding: 4px;
      text-align: left;
    }
    th {
      background: var(--mostaza);
      color: #fff;
      position: sticky;
      top: 0;
    }
    .btn-procesar {
      background: var(--vino);
      color: white;
      padding: 10px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <img src="UIDE-Ecuador.png" alt="Logo UIDE">
    <h1>Matriz Académica - UIDE Ecuador</h1>
  </header>
  <div class="container">
    <p><strong>Cargue los archivos Excel:</strong></p>
    <input type="file" id="fileMallas" accept=".xlsx" />
    <input type="file" id="fileDocentes" accept=".xlsx" />
    <input type="file" id="fileRestricciones" accept=".xlsx" />
    <br>
    <button class="btn-procesar" onclick="procesarArchivos()">Procesar y Generar Matriz</button>
    <div id="output"></div>
  </div>
  <script>
    let mallasData = [], docentesData = [], restriccionesData = [];

    function leerExcel(file, callback) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, {defval: ''});
        callback(json);
      };
      reader.readAsArrayBuffer(file);
    }

    function procesarArchivos() {
      const fileM = document.getElementById('fileMallas').files[0];
      const fileD = document.getElementById('fileDocentes').files[0];
      const fileR = document.getElementById('fileRestricciones').files[0];

      if (!fileM || !fileD || !fileR) {
        alert('Debe cargar los tres archivos.');
        return;
      }

      leerExcel(fileM, function(mallas) {
        leerExcel(fileD, function(docentes) {
          leerExcel(fileR, function(restricciones) {
            mallasData = mallas;
            docentesData = docentes;
            restriccionesData = restricciones;
            generarMatriz();
          });
        });
      });
    }

    function generarMatriz() {
      const output = document.getElementById('output');
      const columnas = [
        'DOCENTE', 'TITULO ACADÉMICO', 'DEDICACIÓN', 'MATERIA', 'CÓDIGO ANTHOLOGY',
        'CARRERAS QUE COMPARTEN', 'MALLA', 'PRE-REQUISITO', 'CODIGO',
        'HORAS TEÓRICAS', 'HORAS PRÁCTICAS', 'HORAS AUTÓNOMAS', 'CREDITOS',
        'CAMPO DE FORMACIÓN', 'CICLO MALLA', 'Nº ORDEN EN LA MALLA',
        'ESTUDIANTES', 'PARALELO', 'DIA', 'HORA', 'MODALIDAD', 'Nro. HORAS'
      ];

      const franjas = ['7:00–10:00','10:00–13:00','13:00–16:00','16:00–19:00','19:00–22:00'];
      const dias = ['Lunes','Martes','Miércoles','Jueves','Viernes'];

      let asignadas = {}; // clave: docente-dia => contador
      let horariosOcupados = {}; // clave: carrera-ciclo-dia-franja => ocupado

      let html = '<table><thead><tr>';
      columnas.forEach(c => html += `<th>${c}</th>`);
      html += '</tr></thead><tbody>';

      for (let materia of mallasData) {
        const nEst = parseInt(materia['ESTUDIANTES']);
        if (!nEst || nEst <= 0) continue;

        const area = (materia['CAMPO DE FORMACIÓN'] || '').toUpperCase().trim();
        const docentes = docentesData.filter(d =>
          (d['ÁREA'] || d['AREA'] || '').toUpperCase().trim() === area
        );
        if (!docentes.length) continue;

        let docente = docentes[0];
        let diaAsignado = '', horaAsignada = '';
        let ciclo = (materia['CICLO'] || materia['CICLO MALLA'] || '').toString();
        let carrera = (materia['CARRERA'] || '').toString();
        let keyCiclo = `${carrera}-${ciclo}`;

        ciclo = parseInt(ciclo);
        for (let dia of dias) {
          const bloqueos = restriccionesData.filter(r => r['DOCENTE'] === docente['DOCENTE'] && r['DIA'] === dia);
          if (bloqueos.length) continue;

          let asignadasHoy = asignadas[docente['DOCENTE'] + '-' + dia] || 0;
          if (asignadasHoy >= 2) continue;

          for (let franja of franjas) {
            const claveHorario = `${keyCiclo}-${dia}-${franja}`;
            if (horariosOcupados[claveHorario]) continue;

            // evitar choque con ciclos adyacentes (1 con 2, 2 con 1 y 3, etc.)
            let choque = false;
            for (let offset of [-1, 1]) {
              let vecino = ciclo + offset;
              let keyVecino = `${carrera}-${vecino}-${dia}-${franja}`;
              if (horariosOcupados[keyVecino]) {
                choque = true;
                break;
              }
            }
            if (choque) continue;

            diaAsignado = dia;
            horaAsignada = franja;
            horariosOcupados[claveHorario] = true;
            asignadas[docente['DOCENTE'] + '-' + dia] = asignadasHoy + 1;
            break;
          }
          if (diaAsignado && horaAsignada) break;
        }

        html += '<tr>';
        columnas.forEach(c => {
          switch (c) {
            case 'DOCENTE': html += `<td>${docente['DOCENTE']}</td>`; break;
            case 'TITULO ACADÉMICO': html += `<td>${docente['TÍTULO ACADÉMICO'] || docente['TITULO ACADÉMICO']}</td>`; break;
            case 'DEDICACIÓN': html += `<td>${docente['DEDICACIÓN']}</td>`; break;
            case 'DIA': html += `<td>${diaAsignado}</td>`; break;
            case 'HORA': html += `<td>${horaAsignada}</td>`; break;
            case 'Nro. HORAS': html += `<td></td>`; break;
            case 'CARRERAS QUE COMPARTEN':
              html += `<td>${(materia[c] || '').toString().split(/[,;]/).join(' / ')}</td>`; break;
            case 'MALLA':
              html += `<td>${(materia[c] || '').toString().split(/[,;]/).join(' / ')}</td>`; break;
            default:
              html += `<td>${materia[c] || ''}</td>`; break;
          }
        });
        html += '</tr>';
      }

      html += '</tbody></table>';
      output.innerHTML = html;
    }
  </script>
</body>
</html>
