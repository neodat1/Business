<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matriz Académica – UIDE</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{--azul:#04136C;--mostaza:#DE912E;--vino:#862B39;--celeste:#9CBEE3;--verde:#8A9520}
body{margin:0;font-family:"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f6f7fb;color:#111}
header{display:flex;align-items:center;gap:16px;padding:16px;background:linear-gradient(135deg,var(--azul),#000a3d);color:#fff}
header img{height:50px}
header h1{margin:0;font-size:20px;font-weight:700}
.brandbar{height:5px;background:linear-gradient(90deg,var(--azul) 20%,var(--mostaza) 20% 40%,var(--vino) 40% 60%,var(--celeste) 60% 80%,var(--verde) 80%)}
.wrapper{max-width:1250px;margin:24px auto;padding:0 16px}
.card{background:#fff;border:1px solid #e2e5ef;border-radius:16px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin-bottom:20px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
label{font-size:13px;font-weight:700;color:#04136C;display:block;margin-bottom:6px}
input[type="file"]{width:100%;padding:10px;border:1px solid #ccd2e3;border-radius:12px;background:#fafbff}
button{border:0;padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer;transition:.2s}
button:hover{opacity:.9}
.primary{background:var(--azul);color:#fff}
.accent{background:var(--mostaza);color:#1b1200}
.muted{background:#fff;color:var(--azul);border:2px solid var(--azul)}
.scroll{overflow:auto;max-height:70vh;border:1px solid #e2e5ef;border-radius:14px}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px}
thead th{position:sticky;top:0;background:#fff;border-bottom:2px solid var(--celeste);padding:10px 8px;text-align:left;color:#06114a}
tbody td{border-bottom:1px solid #eef1f6;padding:8px}
tbody tr:nth-child(odd){background:#fbfdff}
#panelErrores strong{color:var(--vino)}
.errors{margin:8px 0 0;padding-left:20px;font-size:13px}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
#listaDocentes{font-size:14px;padding:0;margin:0;list-style:none}
#listaDocentes li{padding:2px 0;border-bottom:1px solid #eee}
</style>
</head>
<body>
<header>
  <img src="UIDE-Ecuador.png" alt="UIDE Ecuador">
  <h1>Matriz Académica – UIDE</h1>
</header>
<div class="brandbar"></div>

<div class="wrapper">
  <div class="card">
    <div class="row">
      <div><label>Malla</label><input id="fileMalla" type="file" accept=".xlsx,.xls"></div>
      <div><label>Docentes</label><input id="fileDocentes" type="file" accept=".xlsx,.xls"></div>
    </div>
    <div class="actions">
      <button id="btnProcesar" class="primary">Procesar</button>
      <button id="btnXLSX" class="accent" disabled>Descargar XLSX</button>
      <button id="btnCSV" class="accent" disabled>Descargar CSV</button>
      <button id="btnLimpiar" class="muted">Limpiar</button>
    </div>
  </div>

  <div id="panelErrores" class="card" style="display:none">
    <strong>Observaciones / Conflictos</strong>
    <ul id="errores" class="errors"></ul>
  </div>

  <div class="card">
    <div class="scroll">
      <table id="matriz">
        <thead>
          <tr>
            <th>DOCENTE</th><th>TITULO ACADÉMICO</th><th>DEDICACIÓN</th><th>MATERIA</th><th>CÓDIGO ANTHOLOGY</th>
            <th>CARRERAS QUE COMPARTEN</th><th>MALLA</th><th>PRE-REQUISITO</th><th>CODIGO</th>
            <th>HORAS TEÓRICAS</th><th>HORAS PRÁCTICAS</th><th>HORAS AUTÓNOMAS</th><th>CREDITOS</th>
            <th>CAMPO DE FORMACIÓN</th><th>CICLO MALLA</th><th>Nº ORDEN EN LA MALLA</th>
            <th>PARALELO</th><th>DIA</th><th>HORA</th><th>MODALIDAD</th><th>Nro. HORAS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3>Lista de docentes (orden alfabético)</h3>
    <ul id="listaDocentes"></ul>
  </div>
</div>

<script>
const DIAS=['LUNES','MARTES','MIÉRCOLES','JUEVES','VIERNES'];
const SLOTS=['07:00–10:00','10:00–13:00','13:00–16:00','16:00–19:00','19:00–22:00'];
const CYCLE_IDX={'PRIMERO':1,'SEGUNDO':2,'TERCERO':3,'CUARTO':4,'QUINTO':5,'SEXTO':6,'SÉPTIMO':7,'OCTAVO':8,'NOVENO':9,'DÉCIMO':10};
const ABC="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

function norm(v){return (v||"").toString().trim();}
function upper(v){return norm(v).toUpperCase();}
function cicloIdx(c){return CYCLE_IDX[upper(c)]||99;}
function slashJoin(arr){return [...new Set(arr.filter(x=>x))].join(" / ");}

async function readWB(file){const data=await file.arrayBuffer();return XLSX.read(data,{type:"array"});}
function sheetToJSON(wb,name){const ws=wb.Sheets[name];return ws?XLSX.utils.sheet_to_json(ws,{defval:""}):[];}

function clearTable(){document.querySelector("#matriz tbody").innerHTML="";}
function addRow(row){
  const tbody=document.querySelector("#matriz tbody");
  const tr=document.createElement("tr");
  [row.DOCENTE,row.TITULO_ACADEMICO,row.DEDICACION,row.MATERIA,row.CODIGO_ANTHOLOGY,
   row.CARRERAS_COMPARTEN,row.MALLA,row.PRE_REQUISITO,row.CODIGO,
   row.HORAS_TEORICAS,row.HORAS_PRACTICAS,row.HORAS_AUTONOMAS,row.CREDITOS,
   row.CAMPO_DE_FORMACION,row.CICLO_MALLA,row.N_ORDEN_MALLA,
   row.PARALELO,row.DIA,row.HORA,row.MODALIDAD,row.NRO_HORAS].forEach(v=>{
     const td=document.createElement("td");td.textContent=v||"";tr.appendChild(td);
   });
  tbody.appendChild(tr);
}
function addError(msg){
  const ul=document.getElementById("errores");
  const li=document.createElement("li");li.textContent=msg;ul.appendChild(li);
  document.getElementById("panelErrores").style.display="block";
}

document.getElementById("btnProcesar").addEventListener("click",async()=>{
  const fM=document.getElementById("fileMalla").files[0];
  const fD=document.getElementById("fileDocentes").files[0];
  if(!fM||!fD){alert("Cargue ambos archivos");return;}
  clearTable();document.getElementById("panelErrores").style.display="none";document.getElementById("errores").innerHTML="";

  const wbM=await readWB(fM);const wbD=await readWB(fD);
  const malla=sheetToJSON(wbM,"Malla");const docs=sheetToJSON(wbD,"Docentes");

  // índice docentes
  const dmap=new Map();
  docs.forEach(r=>{
    const mat=upper(norm(r.MATERIA));
    if(!dmap.has(mat))dmap.set(mat,[]);
    dmap.get(mat).push({DOCENTE:norm(r.DOCENTE),TITULO:norm(r["TITULO ACADÉMICO"]),DEDIC:norm(r.DEDICACION),MODALIDAD:norm(r.Modalidad),DIAS:DIAS,SLOTS:SLOTS});
  });

  // agrupar malla
  const agg=new Map();
  malla.forEach(r=>{
    const mat=norm(r.MATERIA);if(!mat)return;const k=upper(mat);
    if(!agg.has(k))agg.set(k,{MATERIA:mat,CARRERAS:new Set(),MALLAS:new Set(),PRER:new Set(),CODES:new Map(),HT:new Map(),HP:new Map(),HA:new Map(),CR:new Map(),CAM:new Map(),CIC:new Map(),ORD:new Map()});
    const a=agg.get(k);
    a.CARRERAS.add(norm(r.CARRERA));if(r.MALLA)a.MALLAS.add(norm(r.MALLA));
    if(r["PRERREQUISITO"]||r["PRE-REQUISITO"])a.PRER.add(norm(r["PRERREQUISITO"]||r["PRE-REQUISITO"]));
    const c=norm(r.CARRERA);
    a.CODES.set(c,norm(r["CÓDIGO"]||r.CODIGO));
    a.HT.set(c,norm(r["HORAS TEÓRICAS"]));
    a.HP.set(c,norm(r["HORAS PRÁCTICAS"]));
    a.HA.set(c,norm(r["HORAS AUTÓNOMAS"]));
    a.CR.set(c,norm(r.CREDITOS||r["CRÉDITOS"]));
    a.CAM.set(c,norm(r["CAMPO DE FORMACIÓN"]));
    a.CIC.set(c,norm(r.CICLO));
    a.ORD.set(c,norm(r["NUMERO DE ORDEN EN LA MALLA"]||r["Nº ORDEN EN LA MALLA"]));
  });

  // filas
  const filas=[];
  agg.forEach((a,k)=>{
    const docsFor=dmap.get(k)||[];
    if(!docsFor.length){addError("Materia sin docente: "+a.MATERIA);return;}
    const carreras=[...a.CARRERAS];
    docsFor.forEach((d,j)=>{
      filas.push({
        DOCENTE:d.DOCENTE,TITULO_ACADEMICO:d.TITULO,DEDICACION:d.DEDIC,MATERIA:a.MATERIA,CODIGO_ANTHOLOGY:"",
        CARRERAS_COMPARTEN:slashJoin(carreras),MALLA:slashJoin([...a.MALLAS]),PRE_REQUISITO:slashJoin([...a.PRER]),
        CODIGO:carreras.map(c=>a.CODES.get(c)||"").join(" / "),
        HORAS_TEORICAS:carreras.map(c=>a.HT.get(c)||"").join(" / "),
        HORAS_PRACTICAS:carreras.map(c=>a.HP.get(c)||"").join(" / "),
        HORAS_AUTONOMAS:carreras.map(c=>a.HA.get(c)||"").join(" / "),
        CREDITOS:carreras.map(c=>a.CR.get(c)||"").join(" / "),
        CAMPO_DE_FORMACION:carreras.map(c=>a.CAM.get(c)||"").join(" / "),
        CICLO_MALLA:carreras.map(c=>a.CIC.get(c)||"").join(" / "),
        N_ORDEN_MALLA:carreras.map(c=>a.ORD.get(c)||"").join(" / "),
        PARALELO:ABC[j],DIA:"",HORA:"",MODALIDAD:d.MODALIDAD,NRO_HORAS:"",_ciclos:carreras.map(c=>a.CIC.get(c)||"")
      });
    });
  });

  // asignación horarios
  const ocupacionDoc=new Map();
  const ocupacionCar=new Map();
  function canPlace(row,dia,slot){
    const doc=row.DOCENTE;if(!ocupacionDoc.has(doc))ocupacionDoc.set(doc,{});
    const rec=ocupacionDoc.get(doc)[dia]||{count:0,slots:new Set()};
    if(rec.count>=2)return false;
    if(rec.slots.has(slot))return false;
    const slotKey=dia+" "+slot;
    for(const c of row._ciclos){
      const idx=cicloIdx(c);
      if(!ocupacionCar.has(c))ocupacionCar.set(c,new Map());
      const m=ocupacionCar.get(c);
      if(!m.has(slotKey))m.set(slotKey,new Set());
      const usados=m.get(slotKey);
      for(const u of usados){if(Math.abs(u-idx)<=1)return false;}
    }
    return true;
  }
  function place(row){
    for(const d of DIAS){
      for(const s of SLOTS){
        if(canPlace(row,d,s)){
          const doc=row.DOCENTE;
          const rec=ocupacionDoc.get(doc)[d]||{count:0,slots:new Set()};
          rec.count++;rec.slots.add(s);ocupacionDoc.get(doc)[d]=rec;
          const slotKey=d+" "+s;
          for(const c of row._ciclos){
            const idx=cicloIdx(c);
            const m=ocupacionCar.get(c)||new Map();
            if(!m.has(slotKey))m.set(slotKey,new Set());
            m.get(slotKey).add(idx);
            ocupacionCar.set(c,m);
          }
          row.DIA=d;row.HORA=s;return true;
        }
      }
    }
    return false;
  }
  filas.sort((a,b)=>Math.min(...a._ciclos.map(c=>cicloIdx(c)))-Math.min(...b._ciclos.map(c=>cicloIdx(c))));
  filas.forEach(r=>{if(!place(r))addError("No se pudo asignar horario: "+r.MATERIA+" ("+r.DOCENTE+")");addRow(r);});

  // lista docentes ordenada
  const docentesUnicos=[...new Set(filas.map(f=>f.DOCENTE))].sort((a,b)=>a.localeCompare(b,'es'));
  const ul=document.getElementById("listaDocentes");ul.innerHTML="";
  docentesUnicos.forEach(d=>{const li=document.createElement("li");li.textContent=d;ul.appendChild(li);});

  document.getElementById("btnXLSX").disabled=false;
  document.getElementById("btnCSV").disabled=false;
});

function tableToSheet(){
  const headers=[...document.querySelectorAll("#matriz thead th")].map(th=>th.textContent);
  const rows=[...document.querySelectorAll("#matriz tbody tr")].map(tr=>[...tr.children].map(td=>td.textContent));
  return XLSX.utils.aoa_to_sheet([headers,...rows]);
}
document.getElementById("btnXLSX").addEventListener("click",()=>{
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,tableToSheet(),"Matriz");
  XLSX.writeFile(wb,"Planificacion_UIDE.xlsx");
});
document.getElementById("btnCSV").addEventListener("click",()=>{
  const csv=XLSX.utils.sheet_to_csv(tableToSheet());
  const blob=new Blob([csv],{type:"text/csv"});const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);a.download="Planificacion_UIDE.csv";a.click();
});
document.getElementById("btnLimpiar").addEventListener("click",()=>{
  clearTable();document.getElementById("panelErrores").style.display="none";document.getElementById("errores").innerHTML="";
  document.getElementById("listaDocentes").innerHTML="";
  document.getElementById("btnXLSX").disabled=true;document.getElementById("btnCSV").disabled=true;
});
</script>
</body>
</html>
