<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planificación académica – Mallas & Docentes</title>
  <style>
    :root {
      --bg: #0f172a;          /* slate-900 */
      --card: #111827;        /* gray-900 */
      --muted: #94a3b8;       /* slate-400 */
      --text: #e5e7eb;        /* gray-200 */
      --accent: #2563eb;      /* blue-600 */
      --ok: #16a34a;          /* green-600 */
      --warn: #f59e0b;        /* amber-500 */
      --err: #ef4444;         /* red-500 */
      --tableStripe: #0b1226; /* very dark */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }

    header { padding: 20px 24px; border-bottom: 1px solid #1f2937; position: sticky; top: 0; background: linear-gradient(0deg, rgba(15,23,42,0.75), rgba(15,23,42,0.95)); backdrop-filter: blur(8px); z-index: 8; }
    header h1 { margin: 0; font-weight: 700; font-size: 20px; letter-spacing: 0.2px; }
    header p { margin: 6px 0 0; color: var(--muted); font-size: 13px; }

    .container { padding: 18px 24px 28px; display: grid; grid-template-columns: 340px 1fr; gap: 18px; }

    .card { background: var(--card); border: 1px solid #1f2937; border-radius: 14px; padding: 16px; }
    .card h2 { margin: 0 0 12px; font-size: 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 10px; }

    label { font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="file"], select, button { width: 100%; border-radius: 10px; border: 1px solid #223049; background: #0b1220; color: var(--text); padding: 10px 12px; font-size: 14px; }
    input[type="checkbox"] { transform: translateY(1px); }
    button.primary { background: linear-gradient(180deg, #1d4ed8, #1e40af); border-color: #1d4ed8; cursor: pointer; }
    button.primary:disabled { opacity: .6; cursor: not-allowed; }
    button.ghost { background: #0b1220; }
    .hint { font-size: 12px; color: var(--muted); line-height: 1.2; }

    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; }
    .stat { background: #0b1226; border: 1px solid #1f2937; border-radius: 10px; padding: 8px 10px; font-size: 12px; color: var(--muted); }

    .tableWrap { background: var(--card); border: 1px solid #1f2937; border-radius: 14px; overflow: hidden; }
    .tableTop { display: flex; gap: 8px; align-items: center; padding: 12px; border-bottom: 1px solid #1f2937; }
    .tableTop .spacer { flex: 1; }

    table { width: 100%; border-collapse: collapse; }
    thead { position: sticky; top: 69px; z-index: 5; box-shadow: 0 2px 0 #1f2937; }
    thead th { background: #0c1429; color: #cbd5e1; font-size: 12px; text-transform: uppercase; letter-spacing: 0.04em; padding: 10px 8px; text-align: left; white-space: nowrap; }
    tbody td { padding: 9px 8px; border-top: 1px solid #1f2937; vertical-align: middle; font-size: 14px; }
    tbody tr:nth-child(odd) { background: var(--tableStripe); }
    tbody tr:hover { background: #101a34; }

    .num { text-align: center; font-variant-numeric: tabular-nums; }
    .center { text-align: center; }
    .chip { display: inline-block; padding: 2px 8px; border-radius: 100px; background: #0b1220; border: 1px solid #1f2937; font-size: 12px; }
    .ok { color: #bbf7d0; }
    .warn { color: #fde68a; }
    .err { color: #fecaca; }

    .stickyX { overflow: auto; max-height: calc(100vh - 140px); }

    .legend { font-size: 12px; color: var(--muted); display: flex; gap: 8px; align-items: center; }
    .legend span { display: inline-flex; align-items: center; gap: 6px; }
    .badge { width: 10px; height: 10px; border-radius: 3px; display: inline-block; }
    .b-free { background: var(--ok); }
    .b-adj { background: var(--warn); }
    .b-max2 { background: var(--err); }

    .small { font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>Planificación académica</h1>
    <p>Lea <em>Mallas.xlsx</em> y <em>Docentes.xlsx</em>, integre y asigne franjas horarias sin cruces (L–V, 7–10, 10–13, 13–16, 16–19, 19–22). Máximo 2 asignaturas por día por ciclo; evite choques entre ciclos adyacentes.</p>
  </header>

  <div class="container">
    <section class="card">
      <h2>Entrada</h2>
      <div class="row">
        <div>
          <label for="fileMallas">Mallas.xlsx</label>
          <input id="fileMallas" type="file" accept=\".xlsx,.xls,.csv\" />
          <div class="hint">Debe contener: Carrera, Malla, Ciclo, Materia, Código Anthology (opcional), Código, Horas (T/P/A), Créditos, Campo de formación, Nº orden, Pre‑requisito.</div>
        </div>
        <div>
          <label for="fileDocentes">Docentes.xlsx</label>
          <input id="fileDocentes" type="file" accept=\".xlsx,.xls,.csv\" />
          <div class="hint">Debe contener: Docente, Título académico, Dedicación. (La asignación del docente se selecciona por fila.)</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Parámetros de asignación</label>
          <div class="small">
            • Evitar choques entre ciclos consecutivos (1↔2, 2↔1&3, 3↔2&4, ...).<br/>
            • Máx. 2 materias por día <b>por ciclo</b>.<br/>
            • Se escoge <b>una</b> franja por materia; las demás quedan en suspenso.
          </div>
        </div>
      </div>

      <div class="row">
        <button id="btnProcesar" class="primary">Procesar</button>
        <button id="btnLimpiar" class="ghost">Limpiar</button>
      </div>

      <div class="stats">
        <div class="stat" id="stMallas">Mallas: —</div>
        <div class="stat" id="stDoc">Docentes: —</div>
        <div class="stat" id="stOut">Salidas: —</div>
      </div>

      <div style="margin-top:10px;" class="legend">
        <span><i class="badge b-free"></i> asignación válida</span>
        <span><i class="badge b-adj"></i> descartado por adyacencia</span>
        <span><i class="badge b-max2"></i> descartado por límite máximo (2)</span>
      </div>
    </section>

    <section class="tableWrap">
      <div class="tableTop">
        <strong>Resultados</strong>
        <span class="spacer"></span>
        <span id="resume" class="small">—</span>
      </div>
      <div class="stickyX">
        <table id="tbl">
          <thead>
            <tr id="thead"></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js" integrity="sha256-lCPMSx8kzeSeY9hUNjQz5YWR12dAnAnbGqM6qLuZegE=" crossorigin="anonymous"></script>
  <script>
    // ===== Utiles =====
    const SLOTS = [
      { dia: 'Lunes', rango: '07:00–10:00', h: 3 },
      { dia: 'Lunes', rango: '10:00–13:00', h: 3 },
      { dia: 'Lunes', rango: '13:00–16:00', h: 3 },
      { dia: 'Lunes', rango: '16:00–19:00', h: 3 },
      { dia: 'Lunes', rango: '19:00–22:00', h: 3 },
      { dia: 'Martes', rango: '07:00–10:00', h: 3 },
      { dia: 'Martes', rango: '10:00–13:00', h: 3 },
      { dia: 'Martes', rango: '13:00–16:00', h: 3 },
      { dia: 'Martes', rango: '16:00–19:00', h: 3 },
      { dia: 'Martes', rango: '19:00–22:00', h: 3 },
      { dia: 'Miércoles', rango: '07:00–10:00', h: 3 },
      { dia: 'Miércoles', rango: '10:00–13:00', h: 3 },
      { dia: 'Miércoles', rango: '13:00–16:00', h: 3 },
      { dia: 'Miércoles', rango: '16:00–19:00', h: 3 },
      { dia: 'Miércoles', rango: '19:00–22:00', h: 3 },
      { dia: 'Jueves', rango: '07:00–10:00', h: 3 },
      { dia: 'Jueves', rango: '10:00–13:00', h: 3 },
      { dia: 'Jueves', rango: '13:00–16:00', h: 3 },
      { dia: 'Jueves', rango: '16:00–19:00', h: 3 },
      { dia: 'Jueves', rango: '19:00–22:00', h: 3 },
      { dia: 'Viernes', rango: '07:00–10:00', h: 3 },
      { dia: 'Viernes', rango: '10:00–13:00', h: 3 },
      { dia: 'Viernes', rango: '13:00–16:00', h: 3 },
      { dia: 'Viernes', rango: '16:00–19:00', h: 3 },
      { dia: 'Viernes', rango: '19:00–22:00', h: 3 },
    ];

    const HEADERS = [
      'DOCENTE', 'TITULO ACADÉMICO', 'DEDICACIÓN', 'MATERIA', 'CÓDIGO ANTHOLOGY',
      'CARRERAS QUE COMPARTEN', 'MALLA', 'PRE-REQUISITO', 'CODIGO',
      'HORAS TEÓRICAS', 'HORAS PRÁCTICAS', 'HORAS AUTÓNOMAS', 'CREDITOS',
      'CAMPO DE FORMACIÓN', 'CICLO MALLA', 'Nº ORDEN EN LA MALLA',
      'PARALELO', 'DIA', 'HORA', 'MODALIDAD', 'Nro. HORAS'
    ];

    const NUMERIC_HEADERS = new Set([
      'HORAS TEÓRICAS','HORAS PRÁCTICAS','HORAS AUTÓNOMAS','CREDITOS','CICLO MALLA','Nº ORDEN EN LA MALLA','Nro. HORAS'
    ]);

    function norm(s){
      if(s==null) return '';
      return String(s)
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^A-Za-z0-9]+/g,'')
        .toLowerCase();
    }

    function detectColumn(row, candidates){
      const keys = Object.keys(row||{});
      let bestKey = null;
      for(const k of keys){
        const nk = norm(k);
        for(const c of candidates){ if(nk.includes(c)) { bestKey = k; break; } }
        if(bestKey) break;
      }
      return bestKey; // puede ser null
    }

    function uniq(arr){ return [...new Set(arr.filter(x=>x!=null && x!==''))]; }

    function groupBy(arr, keyFn){
      const m = new Map();
      for(const x of arr){
        const k = keyFn(x);
        if(!m.has(k)) m.set(k, []);
        m.get(k).push(x);
      }
      return m;
    }

    // ===== Lectura de Excel (TODAS LAS HOJAS) =====
    async function readExcelAllSheets(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = (e)=>{
          try{
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const all = [];
            const meta = [];
            for(const sheetName of wb.SheetNames){
              const ws = wb.Sheets[sheetName];
              if(!ws) continue;
              const json = XLSX.utils.sheet_to_json(ws, { defval: '', raw: true });
              json.forEach(r=>{ r.__sheet = sheetName; });
              if(json.length){ all.push(...json); meta.push({ sheet: sheetName, rows: json.length }); }
            }
            resolve({ rows: all, meta });
          }catch(err){ reject(err); }
        };
        fr.onerror = reject;
        fr.readAsArrayBuffer(file);
      });
    }

    // ===== Lector CSV sencillo (una "hoja") =====
    function parseCSV(text){
      const rows = [];
      let headers = null;
      const lines = text.split(/
?
/).filter(l=>l.trim().length>0);
      for(let i=0;i<lines.length;i++){
        // Split CSV básico (soporta comillas dobles)
        const cols = [];
        let cur = '';
        let inQ = false;
        const line = lines[i];
        for(let j=0;j<line.length;j++){
          const ch = line[j];
          if(ch==='"'){
            if(inQ && line[j+1]==='"'){ cur+='"'; j++; }
            else inQ = !inQ;
          } else if(ch===',' && !inQ){ cols.push(cur); cur=''; }
          else cur+=ch;
        }
        cols.push(cur);
        if(!headers){ headers = cols; continue; }
        const obj = {};
        for(let k=0;k<headers.length;k++) obj[headers[k]] = cols[k]??'';
        rows.push(obj);
      }
      return { rows, meta: [{ sheet: 'CSV', rows: rows.length }] };
    }

    // ===== Lector universal (XLSX o CSV) =====
    async function readAnyAllSheets(file){
      const name = (file.name||'').toLowerCase();
      if(name.endsWith('.csv')){
        const txt = await file.text();
        return parseCSV(txt);
      }
      if(typeof XLSX === 'undefined'){
        throw new Error('No se pudo cargar SheetJS (XLSX). Use CSV como alternativa.');
      }
      return readExcelAllSheets(file);
    }

    // ===== Mapeos flexibles =====
    function mapMallas(rows){
      if(!rows || !rows.length) return [];
      // Detectar columnas por patrones robustos
      const sample = rows[0];
      const colCarrera = detectColumn(sample, ['carrera','programa','escuela']);
      const colMalla = detectColumn(sample, ['malla','plan']);
      const colCiclo = detectColumn(sample, ['ciclo','semestre','nivel']);
      const colMateria = detectColumn(sample, ['materia','asignatura','unidadcurricular','nombre']);
      const colCodAnth = detectColumn(sample, ['codigoanthology','anthology','codigounico','codigoglobal']);
      const colCodigo = detectColumn(sample, ['codigo','codigomateria','cod']);
      const colHT = detectColumn(sample, ['horasteoricas','teoricas','ht']);
      const colHP = detectColumn(sample, ['horaspracticas','practicas','hp']);
      const colHA = detectColumn(sample, ['horasautonomas','autonomas','ha']);
      const colCred = detectColumn(sample, ['creditos','ects','cr']);
      const colCampo = detectColumn(sample, ['campodeformacion','campodeformacion','areadeformacion','componente']);
      const colOrden = detectColumn(sample, ['orden','norden','nroorden','noorden']);
      const colPre = detectColumn(sample, ['prerequisito','prerrequisito','requisito']);

      const mapped = rows.map(r=>({
        Carrera: String(r[colCarrera]||'').trim(),
        Malla: String(r[colMalla]||'').trim(),
        Ciclo: String(r[colCiclo]||'').toString().trim(),
        Materia: String(r[colMateria]||'').trim(),
        CodigoAnth: String(r[colCodAnth]||'').trim(),
        Codigo: String(r[colCodigo]||'').trim(),
        HT: Number(String(r[colHT]||'').toString().replace(/,/g,'.')) || 0,
        HP: Number(String(r[colHP]||'').toString().replace(/,/g,'.')) || 0,
        HA: Number(String(r[colHA]||'').toString().replace(/,/g,'.')) || 0,
        Creditos: Number(String(r[colCred]||'').toString().replace(/,/g,'.')) || 0,
        Campo: String(r[colCampo]||'').trim(),
        Orden: Number(String(r[colOrden]||'').toString().replace(/,/g,'.')) || 0,
        Pre: String(r[colPre]||'').trim(),
      })).filter(x=>x.Materia);

      return mapped;
    }

    function mapDocentes(rows){
      if(!rows || !rows.length) return [];
      const sample = rows[0];
      const colDoc = detectColumn(sample, ['docente','profesor','nombre','nombresapellidos','nombres']);
      const colTit = detectColumn(sample, ['tituloacademico','titulo','gradoacademico']);
      const colDed = detectColumn(sample, ['dedicacion','jornada','tiempo']);

      return rows.map(r=>({
        Docente: String(r[colDoc]||'').trim(),
        Titulo: String(r[colTit]||'').trim(),
        Dedicacion: String(r[colDed]||'').trim(),
      })).filter(x=>x.Docente);
    }

    // ===== Integración por Código Anthology / Materia =====
    function integrarPorMateria(items){
      // Clave: preferir CodigoAnth si existe; si no, Materia normalizada
      const keyFn = (x)=> x.CodigoAnth ? 'A:'+norm(x.CodigoAnth) : 'M:'+norm(x.Materia);
      const g = groupBy(items, keyFn);

      const out = [];
      for(const [, arr] of g.entries()){
        // Ordenar carreras alfabéticamente para consistencia al concatenar con '/'
        const carreras = uniq(arr.map(x=>x.Carrera)).sort((a,b)=>a.localeCompare(b));
        // Mapear por carrera para campos dependientes
        const porCarrera = carreras.map(car=> arr.find(x=>x.Carrera===car));

        out.push({
          Materia: arr[0].Materia,
          CodigoAnth: uniq(arr.map(x=>x.CodigoAnth)).filter(Boolean).join('/'),
          CarrerasComparten: carreras.join('/'),
          Malla: uniq(arr.map(x=>x.Malla)).join('/'),
          Pre: uniq(arr.map(x=>x.Pre)).join('/'),
          Codigo: porCarrera.map(x=>x?.Codigo||'').join('/'),
          HT: porCarrera.map(x=> (x? x.HT:0)).join('/'),
          HP: porCarrera.map(x=> (x? x.HP:0)).join('/'),
          HA: porCarrera.map(x=> (x? x.HA:0)).join('/'),
          Creditos: porCarrera.map(x=> (x? x.Creditos:0)).join('/'),
          Campo: porCarrera.map(x=> (x? x.Campo:'')).join('/'),
          Ciclo: porCarrera.map(x=> (x? x.Ciclo:'')).join('/'),
          Orden: porCarrera.map(x=> (x? x.Orden:'')).join('/'),
          // Metadatos para planificación por ciclos (usaremos el primer ciclo por carrera cuando sea posible)
          _ciclosCarrera: porCarrera.map(x=> ({ Carrera: x?.Carrera||'', Malla: x?.Malla||'', Ciclo: x?.Ciclo||'' })),
        });
      }
      // Orden sugerido: Carrera, Malla, Ciclo (usando primer registro disponible), Materia
      out.sort((a,b)=>{
        const aC = (a._ciclosCarrera[0]?.Carrera||'')+ (a._ciclosCarrera[0]?.Malla||'');
        const bC = (b._ciclosCarrera[0]?.Carrera||'')+ (b._ciclosCarrera[0]?.Malla||'');
        if(aC!==bC) return aC.localeCompare(bC);
        const ac = parseInt((a._ciclosCarrera[0]?.Ciclo||'').toString().match(/\d+/)?.[0]||'999',10);
        const bc = parseInt((b._ciclosCarrera[0]?.Ciclo||'').toString().match(/\d+/)?.[0]||'999',10);
        if(ac!==bc) return ac-bc;
        return a.Materia.localeCompare(b.Materia);
      });

      return out;
    }

    // ===== Asignación de franjas (greedy con restricciones) =====
    function asignarFranjas(rowsIntegrados){
      // Ocupación por (Carrera+Malla -> Ciclo -> día -> conteo), y por (Carrera+Malla -> Ciclo -> dia+rango -> bool)
      const occCount = new Map();
      const occSlot = new Map();

      function keyCM(cm){ return `${cm.Carrera}::${cm.Malla}`; }

      function ensure(cm){
        const k = keyCM(cm);
        if(!occCount.has(k)) occCount.set(k, new Map());
        if(!occSlot.has(k)) occSlot.set(k, new Map());
      }

      function incCount(cm, ciclo, dia){
        ensure(cm);
        const m = occCount.get(keyCM(cm));
        if(!m.has(ciclo)) m.set(ciclo, new Map());
        const mc = m.get(ciclo);
        mc.set(dia, (mc.get(dia)||0)+1);
      }

      function setSlot(cm, ciclo, dia, rango){
        ensure(cm);
        const m = occSlot.get(keyCM(cm));
        const k = `${ciclo}@@${dia}@@${rango}`;
        m.set(k, true);
      }

      function hasSlot(cm, ciclo, dia, rango){
        const m = occSlot.get(keyCM(cm));
        if(!m) return false;
        return !!m.get(`${ciclo}@@${dia}@@${rango}`);
      }

      function countDay(cm, ciclo, dia){
        const m = occCount.get(keyCM(cm));
        if(!m) return 0;
        const mc = m.get(ciclo); if(!mc) return 0; return mc.get(dia)||0;
      }

      const resultados = rowsIntegrados.map(item=>{
        // Tomar primer par Carrera/Malla/Ciclo disponible para reglas (si hay varios, usamos el primero como referencia principal)
        const cm0 = item._ciclosCarrera.find(x=>x.Carrera && x.Malla) || {Carrera:'', Malla:'', Ciclo:''};
        const cicloNum = parseInt(String(cm0.Ciclo).match(/\d+/)?.[0]||'0',10);

        let asignado = null; let motivo = '';

        // Intentar slots en orden determinista
        for(const s of SLOTS){
          // Regla 1: no exceder 2 materias por día (por ciclo)
          if(countDay(cm0, cicloNum, s.dia) >= 2) { motivo = 'max2'; continue; }

          // Regla 2: evitar choque con el propio ciclo (misma franja ya tomada)
          if(hasSlot(cm0, cicloNum, s.dia, s.rango)) { motivo = 'self'; continue; }

          // Regla 3: evitar adyacencia (ciclo-1 y ciclo+1 no deben coincidir en la misma franja)
          const adjCycles = [cicloNum-1, cicloNum+1].filter(x=>x>0);
          let adjConflict = false;
          for(const cAdj of adjCycles){ if(hasSlot(cm0, cAdj, s.dia, s.rango)) { adjConflict = true; break; } }
          if(adjConflict) { motivo = 'adj'; continue; }

          // Si pasa, asignar y registrar
          asignado = { DIA: s.dia, HORA: s.rango, HORAS: s.h };
          incCount(cm0, cicloNum, s.dia);
          setSlot(cm0, cicloNum, s.dia, s.rango);
          break;
        }

        return { item, asignado, motivo };
      });

      return resultados;
    }

    // ===== Render =====
    function renderTable(rowsAsignados, docentes){
      const thead = document.getElementById('thead');
      const tbody = document.getElementById('tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';

      // Cabeceras
      for(const h of HEADERS){
        const th = document.createElement('th');
        th.textContent = h;
        thead.appendChild(th);
      }

      // Opciones docentes (select)
      const docenteOpts = [{Docente:'', Titulo:'', Dedicacion:''}, ...docentes];

      let ok=0, warn=0, lim=0;

      for(const {item, asignado, motivo} of rowsAsignados){
        const tr = document.createElement('tr');

        // Columnas base
        const col = {
          DOCENTE: '',
          'TITULO ACADÉMICO': '',
          'DEDICACIÓN': '',
          'MATERIA': item.Materia,
          'CÓDIGO ANTHOLOGY': item.CodigoAnth,
          'CARRERAS QUE COMPARTEN': item.CarrerasComparten,
          'MALLA': item.Malla,
          'PRE-REQUISITO': item.Pre,
          'CODIGO': item.Codigo,
          'HORAS TEÓRICAS': String(item.HT),
          'HORAS PRÁCTICAS': String(item.HP),
          'HORAS AUTÓNOMAS': String(item.HA),
          'CREDITOS': String(item.Creditos),
          'CAMPO DE FORMACIÓN': item.Campo,
          'CICLO MALLA': String(item.Ciclo),
          'Nº ORDEN EN LA MALLA': String(item.Orden),
          'PARALELO': 'A',
          'DIA': asignado? asignado.DIA: '',
          'HORA': asignado? asignado.HORA: '',
          'MODALIDAD': '',
          'Nro. HORAS': String(asignado? asignado.HORAS: 0)
        };

        // DOCENTE como <select>
        const tdSel = document.createElement('td');
        const sel = document.createElement('select');
        docenteOpts.forEach(d=>{
          const opt = document.createElement('option');
          opt.value = d.Docente;
          opt.textContent = d.Docente;
          sel.appendChild(opt);
        });
        sel.addEventListener('change', (e)=>{
          const doc = docentes.find(d=>d.Docente===sel.value);
          // Buscar celdas hermanas (título y dedicación)
          const tdTitulo = sel.closest('tr').querySelector('[data-col="TITULO ACADÉMICO"]');
          const tdDed = sel.closest('tr').querySelector('[data-col="DEDICACIÓN"]');
          tdTitulo.textContent = doc? doc.Titulo: '';
          tdDed.textContent = doc? doc.Dedicacion: '';
        });
        tdSel.appendChild(sel);
        tr.appendChild(tdSel);

        // TITULO ACADÉMICO, DEDICACIÓN
        const tdTit = document.createElement('td'); tdTit.setAttribute('data-col','TITULO ACADÉMICO'); tr.appendChild(tdTit);
        const tdDed = document.createElement('td'); tdDed.setAttribute('data-col','DEDICACIÓN'); tr.appendChild(tdDed);

        // Resto
        for(const h of HEADERS.slice(3)){
          const td = document.createElement('td');
          td.textContent = col[h] ?? '';
          td.setAttribute('data-col', h);
          if(NUMERIC_HEADERS.has(h)) td.classList.add('num');
          tr.appendChild(td);
        }

        // Color de estado (no intrusivo). Añadimos un pequeño indicador en la celda DIA.
        const tdDia = tr.querySelector('[data-col="DIA"]');
        const chip = document.createElement('span');
        chip.className = 'chip ' + (asignado? 'ok': (motivo==='adj'?'warn':'err'));
        chip.textContent = asignado? 'OK' : (motivo==='adj'?'Adyacente':'Límite');
        if(tdDia){ tdDia.appendChild(document.createTextNode(' ')); tdDia.appendChild(chip); }

        if(asignado) ok++; else if(motivo==='adj') warn++; else lim++;
        tbody.appendChild(tr);
      }

      document.getElementById('resume').textContent = `Asignadas: ${ok} · En suspenso (adyacencia): ${warn} · En suspenso (límite): ${lim}`;
    }

    // ===== Evento principal =====
    const $m = document.getElementById('fileMallas');
    const $d = document.getElementById('fileDocentes');
    const $btn = document.getElementById('btnProcesar');
    const $clr = document.getElementById('btnLimpiar');

    async function procesar(){
      const mFile = $m.files[0];
      const dFile = $d.files[0];
      if(!mFile || !dFile){
        alert('Cargue Mallas.xlsx y Docentes.xlsx.');
        return;
      }
      $btn.disabled = true; $btn.textContent = 'Procesando…';
      try{
        const [{rows: mallasRaw, meta: metaM}, {rows: docentesRaw, meta: metaD}] = await Promise.all([ readAnyAllSheets(mFile), readAnyAllSheets(dFile) ]);
        const mallas = mapMallas(mallasRaw);
        const docentes = mapDocentes(docentesRaw);
        document.getElementById('stMallas').textContent = `Mallas: ${mallas.length} filas · ${metaM.length} hojas`;
        document.getElementById('stDoc').textContent = `Docentes: ${docentes.length} filas · ${metaD.length} hojas`;

        const integrados = integrarPorMateria(mallas);
        const asignados = asignarFranjas(integrados);
        renderTable(asignados, docentes);
        document.getElementById('stOut').textContent = `Salidas: ${asignados.length}`;
      } catch(err){
        console.error(err);
        alert('No se pudo procesar. Si está ejecutando el archivo sin internet o el CDN está bloqueado, cargue las planillas en formato CSV (desde Excel: Guardar como → CSV) y vuelva a intentar. El lector ahora acepta .xlsx/.xls (todas las hojas) o .csv.');
      } finally {
        $btn.disabled = false; $btn.textContent = 'Procesar';
      }
    }

    $btn.addEventListener('click', procesar);
    $clr.addEventListener('click', ()=>{
      document.getElementById('thead').innerHTML='';
      document.getElementById('tbody').innerHTML='';
      document.getElementById('stMallas').textContent='Mallas: —';
      document.getElementById('stDoc').textContent='Docentes: —';
      document.getElementById('stOut').textContent='Salidas: —';
      document.getElementById('resume').textContent='—';
      $m.value='';
      $d.value='';
    });
  </script>
</body>
</html>
