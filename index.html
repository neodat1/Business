<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Sistema de Planificación Académica – UIDE</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  /* ===== Base + Paleta UIDE ===== */
  :root{
    --uide-blue:#04136C; --uide-mustard:#DE912E; --uide-wine:#A62939; --uide-sky:#9CBEE3; --uide-green:#8A952D;
    --primary: var(--uide-blue); --primary-dark:#021048; --primary-light: #eef3ff;
    --secondary:#475569; --success:var(--uide-green); --warning:var(--uide-mustard); --danger:var(--uide-wine);
    --dark:#0f172a; --light:#f7fafc; --border:#e2e8f0; --radius:14px;
    --shadow:0 10px 25px rgba(4,19,108,.08), 0 2px 6px rgba(0,0,0,.04);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter,Segoe UI,system-ui,sans-serif;background:#f3f6fb;color:var(--dark);line-height:1.55}

  .app-container{max-width:1600px;margin:0 auto;padding:24px}
  header.app-header{background:white;border-radius:24px;box-shadow:var(--shadow);padding:28px 28px 22px;position:relative;overflow:hidden}
  header.app-header::before{content:"";position:absolute;left:0;top:0;width:100%;height:6px;
    background:linear-gradient(90deg,var(--uide-wine),var(--uide-mustard),var(--uide-green),var(--uide-blue))}
  .brand{display:flex;align-items:center;gap:14px}
  .brand img{height:46px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.08))}
  .app-title{font-size:26px;font-weight:800;color:var(--primary);letter-spacing:.2px}
  .app-subtitle{color:#5b6b86;font-size:14px;margin-top:4px}

  .card{background:white;border-radius:20px;box-shadow:var(--shadow);padding:22px;margin:18px 0}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .card-title{font-weight:700;color:#122143}

  .file-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .file{border:2px dashed var(--border);border-radius:16px;padding:14px;background:#fcfdff}
  .file label{font-weight:700;color:#1f2a44;font-size:13px;margin-bottom:8px;display:block}
  input[type="file"]{width:100%;padding:10px;border:none}

  .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:12px;padding:12px 18px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--primary);color:white}
  .btn-primary:hover{background:var(--primary-dark)}
  .btn-secondary{background:white;border:1px solid var(--border);color:#0f172a}
  .btn-secondary:hover{background:#f8fafc}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .progress{height:8px;background:#e9eef9;border-radius:6px;overflow:hidden;margin-top:12px;display:none}
  .progress>div{height:100%;width:0;background:linear-gradient(90deg,var(--uide-wine),var(--uide-blue));transition:width .35s}

  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin:10px 0}
  .kpi{background:linear-gradient(180deg,#fff,rgba(4,19,108,.04));border-radius:16px;padding:16px;border-left:6px solid var(--uide-mustard)}
  .kpi .v{font-size:28px;font-weight:800;color:var(--uide-blue)}
  .kpi .l{font-size:12px;color:#5b6b86}

  .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:10px 0}
  .select{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:white;min-width:220px}
  .pill{background:rgba(4,19,108,.06);color:var(--uide-blue);border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}

  .table-wrap{border:1px solid var(--border);border-radius:16px;overflow:hidden}
  table{width:100%;border-collapse:collapse;font-size:13px}
  thead th{position:sticky;top:0;background:#f2f6ff;color:#0f172a;border-bottom:1px solid #e5ecff;padding:10px;text-align:left}
  tbody td{padding:10px;border-bottom:1px solid #eef2f8}
  tr:hover td{background:#fafcff}

  .tabs{display:flex;gap:6px;border-bottom:1px solid #e6ebf5;margin:10px 0 14px}
  .tab{padding:10px 14px;border-bottom:2px solid transparent;cursor:pointer;font-weight:700;color:#475569}
  .tab.active{border-bottom-color:var(--uide-wine);color:var(--uide-wine)}
  .tab-content{display:none}
  .tab-content.active{display:block}

  .hidden{display:none}
  .text-center{text-align:center}
  .muted{color:#6b7a95}
  /* Tipografía compacta para tablas densas */
  body,table,th,td{font-size:12px}
</style>
</head>
<body>
<div class="app-container">
  <header class="app-header">
    <div class="brand">
      <img src="UIDE-Ecuador.png" alt="UIDE">
      <div>
        <div class="app-title">Sistema de Planificación Académica</div>
        <div class="app-subtitle">Asignación automatizada de estudiantes y docentes</div>
      </div>
    </div>
  </header>

  <!-- ==== BLOQUE DE CARGA (solo antes de procesar) ==== -->
  <div id="preUI" class="card">
    <div class="card-header">
      <div class="card-title">Cargar archivos</div>
    </div>
    <div class="file-grid">
      <div class="file">
        <label>DOCENTES.xlsx</label>
        <input id="fileDoc" type="file" accept=".xlsx,.xls">
      </div>
      <div class="file">
        <label>ESTUDIANTES.xlsx</label>
        <input id="fileEst" type="file" accept=".xlsx,.xls">
      </div>
      <div class="file">
        <label>MALLA.xlsx</label>
        <input id="fileMal" type="file" accept=".xlsx,.xls">
      </div>
    </div>
    <div class="toolbar">
      <button id="btnRun" class="btn btn-primary" disabled>Procesar asignación</button>
      <button id="btnDown" class="btn btn-secondary hidden">Descargar planificación</button>
      <span class="pill">Asignación sin pendientes</span>
    </div>
    <div class="progress" id="progress"><div id="pbar"></div></div>
  </div>

  <!-- ==== DASHBOARD (solo después de procesar) ==== -->
  <div id="postUI" class="hidden">
    <div class="kpis">
      <div class="kpi"><div class="v" id="kSecciones">0</div><div class="l">Secciones creadas</div></div>
      <div class="kpi"><div class="v" id="kAsignaciones">0</div><div class="l">Asignaciones realizadas</div></div>
      <div class="kpi"><div class="v" id="kOcupacion">0%</div><div class="l">Ocupación promedio</div></div>
      <div class="kpi"><div class="v" id="kNo">0</div><div class="l">No asignados</div></div>
    </div>

    <div class="toolbar">
      <select id="careerFilter" class="select">
        <option value="__ALL__">Todas las carreras</option>
      </select>
      <span class="pill" id="activeFilter">Sin filtros</span>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="resumen">Resumen / Proyección</div>
      <div class="tab" data-tab="carga">Carga Docente</div>
      <div class="tab" data-tab="asig">Asignaciones</div>
      <div class="tab" data-tab="matriz">Matriz Completa</div>
    </div>

    <div id="resumen" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Proyección de estudiantes por materia</div>
        </div>
        <div class="table-wrap"><div id="tblProy"></div></div>
      </div>
    </div>

    <div id="carga" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Carga por docente</div>
        </div>
        <div class="table-wrap"><div id="tblCarga"></div></div>
      </div>
    </div>

    <div id="asig" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Asignaciones (filtrables por carrera)</div>
        </div>
        <div class="table-wrap"><div id="tblCombo"></div></div>
      </div>
    </div>

    <div id="matriz" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Matriz completa</div>
        </div>
        <div class="table-wrap" style="max-height:560px;overflow:auto">
          <table id="tblMatriz" style="min-width:2200px">
            <thead>
              <tr>
                <th>DOCENTE</th><th>DEDICACIÓN</th><th>MATERIA</th><th>CÓDIGO ANTHOLOGY</th>
                <th>CARRERAS QUE COMPARTEN</th><th>PRE-REQUISITO</th><th>CODIGO</th>
                <th>HORAS TEÓRICAS</th><th>HORAS PRÁCTICAS</th><th>HORAS AUTÓNOMAS</th><th>CREDITOS</th>
                <th>CAMPO DE FORMACIÓN</th><th>CICLO</th><th>MALLA</th><th>Nº ORDEN EN LA MALLA</th>
                <th>PARALELO</th><th>DIA</th><th>HORA</th><th>Modalidad</th><th>Nro. HORAS</th>
                <th>NOMBRE DEL ESTUDIANTE</th><th>CARRERA DEL ESTUDIANTE</th><th>CICLO DEL ESTUDIANTE</th>
                <th>NIVEL INGLES</th><th>OBSERVACIONES</th>
              </tr>
            </thead>
            <tbody id="bodyMatriz">
              <tr><td colspan="25" class="text-center muted" style="padding:20px">Cargue y procese archivos</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="toolbar" style="justify-content:flex-end;margin-top:4px">
      <button id="btnDown2" class="btn btn-secondary">Descargar planificación</button>
    </div>
  </div>
</div>

<script>
/* =================== Utilidades =================== */
const HORARIOS = ["07:00-10:00","10:00-13:00","13:00-16:00","16:00-19:00","19:00-22:00"];
const DIAS_DEFAULT = ["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES","SABADO"];

const esc = s => (s===null||s===undefined) ? "" : String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
const val = s => (s===null||s===undefined||s==="") ? "0" : s;
const __norm = s => String(s ?? "").toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();

function renderTable(el, headers, rows, limit = 200){
  if(!rows.length){ el.innerHTML = '<p class="text-center muted" style="padding:16px">Sin datos que mostrar</p>'; return;}
  const slice = rows.slice(0,limit);
  let html = '<table><thead><tr>'+headers.map(h=>`<th>${esc(h)}</th>`).join('')+'</tr></thead><tbody>';
  for(const r of slice){ html += '<tr>'+headers.map(h=>`<td>${esc(val(r[h]))}</td>`).join('')+'</tr>'; }
  html += '</tbody></table>';
  if(rows.length>limit) html += `<div class="text-center muted" style="padding:8px">Mostrando ${limit} de ${rows.length}</div>`;
  el.innerHTML = html;
}
function updateProgress(p){ const c=document.getElementById('progress'); c.style.display='block'; document.getElementById('pbar').style.width=p+'%';}

/* ============ Lectura Excel ============ */
const readSheet = (file, name) => new Promise((resolve, reject)=>{
  if(!file){ resolve([]); return; }
  const fr = new FileReader();
  fr.onload = e => {
    try{
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws,{defval:""});
      resolve(data);
    }catch(err){ reject(new Error('Error leyendo '+name+': '+err.message)); }
  };
  fr.onerror = ()=>reject(new Error('No se pudo leer '+name));
  fr.readAsArrayBuffer(file);
});

/* ============ Normalización ============ */
function normalizeDocentes(rows){
  return rows.map(r=>{
    const d = String(r["DIA DISPONIBLE"]||r["DIA"]||"").toUpperCase();
    const h = String(r["HORA DISPONIBLE"]||r["HORA"]||"").toUpperCase();
    // Días
    let dias = [];
    if(/LUNES A VIERNES/.test(d)) dias = DIAS_DEFAULT.slice(0,5);
    else DIAS_DEFAULT.forEach(D=>{ if(d.includes(D)) dias.push(D); });
    if(!dias.length) dias = [...DIAS_DEFAULT]; // fallback obligatorio
    // Horas
    let horas = [];
    for(const blk of HORARIOS){ if(h.includes(blk.substring(0,2))) horas.push(blk); }
    if(!horas.length) horas = [...HORARIOS]; // fallback obligatorio

    return{
      NOMBRE_DOCENTE: r["NOMBRE_DOCENTE"]||r["DOCENTE"]||"",
      MATERIA: r["MATERIA"]||r["MATERIAS"]||"",
      "CANTIDAD DE ALUMNOS ESPERADOS": Number(r["CANTIDAD DE ALUMNOS ESPERADOS"]||r["CAPACIDAD"]||25)||25,
      DIA_DISPONIBLE: Array.from(new Set(dias)),
      HORA_DISPONIBLE: Array.from(new Set(horas)),
      Modalidad: r["Modalidad"]||r["MODALIDAD"]||"PRESENCIAL",
      Paralelo: String(r["Paralelo"]||r["PARALELO"]||"").toUpperCase().trim()||"A",
      DEDICACIÓN: r["DEDICACIÓN"]||r["DEDICACION"]||""
    };
  }).filter(x=>x.NOMBRE_DOCENTE && x.MATERIA);
}

function normalizeEstudiantes(rows){
  return rows.map(r=>{
    const ciclo = Number(r["CICLO AL QUE VA"]||r["CICLO ACTUAL"]||r["CICLO"]||1);
    return{
      ESTUDIANTE: r["ESTUDIANTE"]||r["NOMBRE"]||"",
      CICLO: isNaN(ciclo)?1:Math.max(1,Math.min(12,ciclo)),
      CARRERA: r["CARRERA"]||r["CARRERA DEL ESTUDIANTE"]||"",
      MALLA: r["MALLA"]||"",
      "NIVEL INGLES": r["NIVEL INGLES"]||""
    };
  }).filter(x=>x.ESTUDIANTE && Number(x.CICLO)!==9);
}

function normalizeMallas(rows){
  const WORD2NUM={"PRIMERO":1,"SEGUNDO":2,"TERCERO":3,"CUARTO":4,"QUINTO":5,"SEXTO":6,"SEPTIMO":7,"SÉPTIMO":7,"OCTAVO":8,"NOVENO":9,"DECIMO":10,"DÉCIMO":10,"ONCE":11,"DOCE":12};
  const toCycle=v=>{const t=String(v??"").toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(); if(/^\d+$/.test(t)) return Number(t); return WORD2NUM[t]||NaN;};
  return rows.map(r=>{
    let ciclo = toCycle(r["CICLO"]); if(isNaN(ciclo)) ciclo = Number(r["CICLO"]||1);
    return{
      CARRERA: r["CARRERA"]||"",
      MATERIA: r["MATERIA"]||"",
      CODIGO: String(r["CÓDIGO"]||r["CODIGO"]||r["CÓDIGO ANTHOLOGY"]||"").trim(),
      CICLO: Math.max(1,Math.min(12,Number(ciclo)||1)),
      "HORAS TEÓRICAS": Number(r["HORAS TEÓRICAS"]||0)||0,
      "HORAS PRÁCTICAS": Number(r["HORAS PRÁCTICAS"]||0)||0,
      "HORAS AUTÓNOMAS": Number(r["HORAS AUTÓNOMAS"]||0)||0,
      CREDITOS: Number(r["CREDITOS"]||0)||0,
      "CAMPO DE FORMACIÓN": r["CAMPO DE FORMACIÓN"]||"",
      MALLA: r["MALLA"]||"",
      "Nº ORDEN EN LA MALLA": r["Nº ORDEN EN LA MALLA"]||0,
      "PRE-REQUISITO": r["PRE-REQUISITO"]||"",
      "CARRERAS QUE COMPARTEN": r["CARRERAS QUE COMPARTEN"]||""
    };
  }).filter(x=>x.MATERIA);
}

/* ============ Construcción de secciones ============ */
let __DOC_SLOTS = new Map(); // Map<Docente, Map<DIA, Set<HORA>>>
let __DOC_DAYCNT = new Map(); // Map<Docente, Map<DIA,count>>

const getCnt=(d,day)=> (__DOC_DAYCNT.get(d)?.get(day))||0;
const incCnt=(d,day)=>{const m=__DOC_DAYCNT.get(d)||new Map();m.set(day,(m.get(day)||0)+1);__DOC_DAYCNT.set(d,m);};

function findSlot(horariosCiclo, docente, relax=false){
  const name = docente.NOMBRE_DOCENTE;
  const slots = __DOC_SLOTS.get(name)||new Map();
  const dias = docente.DIA_DISPONIBLE?.length?docente.DIA_DISPONIBLE:[...DIAS_DEFAULT];
  const horas = docente.HORA_DISPONIBLE?.length?docente.HORA_DISPONIBLE:[...HORARIOS];

  for(const dia of dias){
    if(!relax && getCnt(name,dia)>=2) continue;
    const usedCiclo = horariosCiclo.get(dia)||new Set();
    const usedDoc = slots.get(dia)||new Set();
    for(const h of horas){
      if(usedCiclo.has(h) || usedDoc.has(h)) continue;
      usedCiclo.add(h); horariosCiclo.set(dia,usedCiclo);
      usedDoc.add(h); slots.set(dia,usedDoc); __DOC_SLOTS.set(name,slots);
      incCnt(name,dia);
      return {dia,hora:h};
    }
  }
  return null;
}

function construirSecciones(docentes, mallas, estudiantes){
  __DOC_SLOTS = new Map(); __DOC_DAYCNT = new Map();
  const horariosOcupados = new Map(); for(let c=1;c<=12;c++) horariosOcupados.set(c,new Map());
  const capacidadParalelo = 25;

  // meta agregada
  const meta = new Map(); // key ciclo¦materia
  for(const m of mallas){
    const k = `${m.CICLO}¦${m.MATERIA}`;
    const o = meta.get(k)||{COD:new Set(),CAR:new Set(),MAL:new Set(),HT:0,HP:0,HA:0,CR:0,CAMPO:"",ORD:0,PRE:""};
    if(m.CODIGO) o.COD.add(String(m.CODIGO));
    if(m.CARRERA) o.CAR.add(__norm(m.CARRERA));
    (String(m["CARRERAS QUE COMPARTEN"]||"").split(/[\/,;]/).map(x=>x.trim()).filter(Boolean)).forEach(c=>o.CAR.add(__norm(c)));
    if(m.MALLA) o.MAL.add(m.MALLA);
    o.HT=Math.max(o.HT,Number(m["HORAS TEÓRICAS"]||0));
    o.HP=Math.max(o.HP,Number(m["HORAS PRÁCTICAS"]||0));
    o.HA=Math.max(o.HA,Number(m["HORAS AUTÓNOMAS"]||0));
    o.CR=Math.max(o.CR,Number(m.CREDITOS||0));
    o.CAMPO=o.CAMPO||m["CAMPO DE FORMACIÓN"]||"";
    o.ORD=m["Nº ORDEN EN LA MALLA"]||o.ORD;
    o.PRE=o.PRE||m["PRE-REQUISITO"]||"";
    meta.set(k,o);
  }

  // Estudiantes por ciclo
  const estPorCiclo = new Map(); for(const e of estudiantes){ if(!estPorCiclo.has(e.CICLO)) estPorCiclo.set(e.CICLO,[]); estPorCiclo.get(e.CICLO).push(e); }

  const secciones=[]; const parIndex=new Map(); const loadDoc=new Map();
  for(const m of mallas){
    const ciclo = m.CICLO;
    const alumnos = estPorCiclo.get(ciclo)||[];
    if(!alumnos.length) continue;

    const profs = docentes.filter(d=>__norm(d.MATERIA)===__norm(m.MATERIA));
    if(!profs.length) continue;

    const nPar = Math.max(1, Math.ceil(alumnos.length/25));
    const info = meta.get(`${ciclo}¦${m.MATERIA}`)||{};
    const codStr = Array.from(info.COD||[]).join('/')||m.CODIGO||"0";
    const carStr = Array.from(info.CAR||[]).join('/')||m["CARRERAS QUE COMPARTEN"]||"0";
    const mallaStr = Array.from(info.MAL||[]).join('/')||m.MALLA||"0";

    const base = parIndex.get(`${m.MATERIA}¦${ciclo}`)||0;

    for(let i=0;i<nPar;i++){
      // Ordenar docentes por menor carga
      profs.sort((a,b)=>(loadDoc.get(a.NOMBRE_DOCENTE)||0)-(loadDoc.get(b.NOMBRE_DOCENTE)||0));
      let elegido=null, slot=null;
      for(const d of profs){
        slot = findSlot(horariosOcupados.get(ciclo), d, false) || findSlot(horariosOcupados.get(ciclo), d, true);
        if(slot){ elegido=d; break; }
      }
      if(!elegido) { // si aún no hay, escanear cualquiera (garantía de asignación)
        for(const d of profs){ slot = findSlot(horariosOcupados.get(ciclo), d, true); if(slot){ elegido=d; break; } }
      }
      if(!elegido) continue;

      const paralelo = String.fromCharCode(65 + base + i);
      secciones.push({
        MATERIA:m.MATERIA, CICLO:ciclo, NOMBRE_DOCENTE:elegido.NOMBRE_DOCENTE, CAP:25, ASIGNADOS:0,
        DIA:slot.dia, HORA:slot.hora, Modalidad:elegido.Modalidad, Paralelo:paralelo, DEDICACIÓN:elegido.DEDICACIÓN||"",
        "CÓDIGO ANTHOLOGY":codStr, CODIGO:codStr, "CARRERAS QUE COMPARTEN":carStr, MALLA:mallaStr,
        "HORAS TEÓRICAS":info.HT||0, "HORAS PRÁCTICAS":info.HP||0, "HORAS AUTÓNOMAS":info.HA||0,
        CREDITOS:info.CR||0, "CAMPO DE FORMACIÓN":info.CAMPO||"", "Nº ORDEN EN LA MALLA":info.ORD||0, "PRE-REQUISITO":info.PRE||""
      });
      loadDoc.set(elegido.NOMBRE_DOCENTE,(loadDoc.get(elegido.NOMBRE_DOCENTE)||0)+1);
    }
    parIndex.set(`${m.MATERIA}¦${ciclo}`, base+nPar);
  }
  return secciones;
}

/* ============ Asignación estudiantes ============ */
function agruparPorMateria(secciones){ const map=new Map(); for(const s of secciones){ const k=`${s.CICLO}¦${s.MATERIA}`; if(!map.has(k)) map.set(k,[]); map.get(k).push(s);} return map; }

function ensureExtraSection(ciclo, materia, docentes, mallas, secciones){
  const candidatos = docentes.filter(d=>__norm(d.MATERIA)===__norm(materia));
  if(!candidatos.length) return null;
  // info de malla
  let hT=0,hP=0,hA=0,cred=0,campo="",orden=0,prereq="",codigos=new Set(),carr=new Set(),mallas=new Set();
  for(const mm of mallas){
    if(Number(mm.CICLO)===Number(ciclo)&&__norm(mm.MATERIA)===__norm(materia)){
      if(mm.CODIGO) codigos.add(String(mm.CODIGO));
      if(mm.CARRERA) carr.add(__norm(mm.CARRERA));
      String(mm["CARRERAS QUE COMPARTEN"]||"").split(/[\/,;]/).forEach(x=>x&&carr.add(__norm(x)));
      if(mm.MALLA) mallas.add(mm.MALLA);
      hT=Math.max(hT,Number(mm["HORAS TEÓRICAS"]||0)); hP=Math.max(hP,Number(mm["HORAS PRÁCTICAS"]||0)); hA=Math.max(hA,Number(mm["HORAS AUTÓNOMAS"]||0));
      cred=Math.max(cred,Number(mm.CREDITOS||0)); campo=campo||mm["CAMPO DE FORMACIÓN"]||""; orden=mm["Nº ORDEN EN LA MALLA"]||orden; prereq=prereq||mm["PRE-REQUISITO"]||"";
    }
  }
  for(const d of candidatos){
    const slot = findSlot(new Map(), d, true) || {dia:DIAS_DEFAULT[0],hora:HORARIOS[0]};
    const paralelo = String.fromCharCode(65 + (secciones.filter(s=>s.MATERIA===materia && s.CICLO===Number(ciclo)).length));
    const nueva = {
      MATERIA:materia, CICLO:Number(ciclo), NOMBRE_DOCENTE:d.NOMBRE_DOCENTE, CAP:25, ASIGNADOS:0,
      DIA:slot.dia, HORA:slot.hora, Modalidad:d.Modalidad||"PRESENCIAL", Paralelo:paralelo, DEDICACIÓN:d.DEDICACIÓN||"",
      "CÓDIGO ANTHOLOGY":Array.from(codigos).join('/')||"0", CODIGO:Array.from(codigos).join('/')||"0",
      "CARRERAS QUE COMPARTEN":Array.from(carr).join('/')||"0", MALLA:Array.from(mallas).join('/')||"0",
      "HORAS TEÓRICAS":hT, "HORAS PRÁCTICAS":hP, "HORAS AUTÓNOMAS":hA, CREDITOS:cred, "CAMPO DE FORMACIÓN":campo,
      "Nº ORDEN EN LA MALLA":orden||0, "PRE-REQUISITO":prereq||""
    };
    secciones.push(nueva);
    return nueva;
  }
  return null;
}

function asignar(secciones, estudiantes, mallas, docentes){
  const idx = agruparPorMateria(secciones);
  const asignaciones=[]; const noAsig=[]; const maxMaterias=6;

  const estSlots = new Map(); // evita choques
  const dayCount = new Map(); // máx 2 por día
  const can = (e,d,h)=>{ const s=estSlots.get(e)||new Set(); const m=dayCount.get(e)||new Map(); return !s.has(`${d}¦${h}`) && ( (m.get(d)||0) < 2 ); };
  const mark = (e,d,h)=>{ const s=estSlots.get(e)||new Set(); s.add(`${d}¦${h}`); estSlots.set(e,s); const m=dayCount.get(e)||new Map(); m.set(d,(m.get(d)||0)+1); dayCount.set(e,m); };

  // Materias por ciclo
  const matsPorCiclo = new Map(); for(const m of mallas){ if(!matsPorCiclo.has(m.CICLO)) matsPorCiclo.set(m.CICLO,new Set()); matsPorCiclo.get(m.CICLO).add(m.MATERIA); }

  for(const e of estudiantes){
    let count=0; const mats = Array.from(matsPorCiclo.get(e.CICLO)||[]);
    for(const mat of mats){
      if(count>=maxMaterias) break;
      const key = `${e.CICLO}¦${mat}`;
      let bucket = (idx.get(key)||[]).slice().sort((a,b)=>((a.CAP-a.ASIGNADOS)-(b.CAP-b.ASIGNADOS)));
      let placed=false;

      for(const s of bucket){
        const free=(s.CAP||0)-(s.ASIGNADOS||0); if(free<=0) continue;
        if(!can(e.ESTUDIANTE,s.DIA,s.HORA)) continue;
        s.ASIGNADOS=(s.ASIGNADOS||0)+1; placed=true; count++; mark(e.ESTUDIANTE,s.DIA,s.HORA);
        asignaciones.push(packAsignacion(e,s)); break;
      }
      if(!placed){
        const extra = ensureExtraSection(e.CICLO, mat, docentes, mallas, secciones);
        if(extra){ (idx.get(key)||idx.set(key,[]).get(key)).push(extra);
          if(can(e.ESTUDIANTE,extra.DIA,extra.HORA)){ extra.ASIGNADOS=(extra.ASIGNADOS||0)+1; count++; mark(e.ESTUDIANTE,extra.DIA,extra.HORA); asignaciones.push(packAsignacion(e,extra)); placed=true; }
        }
      }
      if(!placed){ noAsig.push({ESTUDIANTE:e.ESTUDIANTE,MATERIA:mat,CICLO:e.CICLO,MOTIVO:"Sin cupo/horario"}); }
    }
  }

  // Última pasada: obligación de 0 no asignados
  if(noAsig.length){
    for(const p of [...noAsig]){ // iterar copia
      const key = `${p.CICLO}¦${p.MATERIA}`;
      let sList = idx.get(key)||[];
      if(!sList.length){ const ex=ensureExtraSection(p.CICLO,p.MATERIA,docentes,mallas,secciones); if(ex){ sList=[ex]; idx.set(key,sList);} }
      let placed=false;
      const e = estudiantes.find(z=>z.ESTUDIANTE===p.ESTUDIANTE);
      for(const s of sList){
        if((s.CAP||0)-(s.ASIGNADOS||0)<=0) continue;
        if(!can(e.ESTUDIANTE,s.DIA,s.HORA)) continue;
        s.ASIGNADOS=(s.ASIGNADOS||0)+1; asignaciones.push(packAsignacion(e,s)); mark(e.ESTUDIANTE,s.DIA,s.HORA); placed=true; break;
      }
      if(placed){ const i=noAsig.indexOf(p); if(i>-1) noAsig.splice(i,1); }
    }
  }

  // Carga docente
  const carga = secciones.map(s=>({
    DOCENTE:s.NOMBRE_DOCENTE, DEDICACIÓN:s.DEDICACIÓN, MATERIA:s.MATERIA, Paralelo:s.Paralelo, DIA:s.DIA, HORA:s.HORA,
    ASIGNADOS:Number(s.ASIGNADOS||0), CAP:Number(s.CAP||0)
  })).sort((a,b)=>a.DOCENTE.localeCompare(b.DOCENTE)||a.MATERIA.localeCompare(b.MATERIA)||String(a.Paralelo).localeCompare(String(b.Paralelo)));

  // Proyección
  const projMap=new Map();
  const seccIdx=new Map();
  for(const s of secciones){ const k=`${s.MATERIA}¦${s.CICLO}`; const o=seccIdx.get(k)||{PAR:0,CAP:0,DOC:new Set()}; o.PAR++; o.CAP+=(s.CAP||0); o.DOC.add(s.NOMBRE_DOCENTE||""); seccIdx.set(k,o); }
  for(const a of asignaciones){
    const k=`${a.MATERIA}¦${a.CICLO}`; const o=projMap.get(k)||{MATERIA:a.MATERIA,CICLO:a.CICLO,TOTAL:0,CARR:new Map()}; o.TOTAL++; const c=(a["CARRERA DEL ESTUDIANTE"]||"0").trim(); o.CARR.set(c,(o.CARR.get(c)||0)+1); projMap.set(k,o);
  }
  const proy = Array.from(projMap.values()).map(o=>{
    const det=Array.from(o.CARR.entries()).map(([c,n])=>`${c}: ${n}`).join(" / ");
    const idx=seccIdx.get(`${o.MATERIA}¦${o.CICLO}`)||{PAR:0,CAP:0,DOC:new Set()};
    return{"MATERIA":o.MATERIA,"CICLO":o.CICLO,"TOTAL ESTUDIANTES":o.TOTAL,"PARALELOS":idx.PAR,"CAPACIDAD TOTAL":idx.CAP,"DOCENTES":Array.from(idx.DOC).join(" / ")||"0","DETALLE POR CARRERA":det||"0"};
  }).sort((a,b)=>a.MATERIA.localeCompare(b.MATERIA)||a.CICLO-b.CICLO));

  return {asignaciones,noAsig,carga,proy,secciones};
}

function packAsignacion(e,s){
  return {
    ESTUDIANTE:e.ESTUDIANTE, "CARRERA DEL ESTUDIANTE":e.CARRERA, "CICLO DEL ESTUDIANTE":e.CICLO, "NIVEL INGLES":e["NIVEL INGLES"],
    CICLO:s.CICLO, NOMBRE_DOCENTE:s.NOMBRE_DOCENTE, MATERIA:s.MATERIA, "CANTIDAD DE ALUMNOS ESPERADOS":s.CAP,
    DIA:s.DIA, HORA:s.HORA, Modalidad:s.Modalidad, Paralelo:s.Paralelo, DEDICACIÓN:s.DEDICACIÓN,
    "CÓDIGO ANTHOLOGY":s.CODIGO, "CARRERAS QUE COMPARTEN":s["CARRERAS QUE COMPARTEN"], "PRE-REQUISITO":s["PRE-REQUISITO"],
    CODIGO:s.CODIGO, "HORAS TEÓRICAS":s["HORAS TEÓRICAS"], "HORAS PRÁCTICAS":s["HORAS PRÁCTICAS"], "HORAS AUTÓNOMAS":s["HORAS AUTÓNOMAS"],
    CREDITOS:s.CREDITOS, "CAMPO DE FORMACIÓN":s["CAMPO DE FORMACIÓN"], MALLA:s.MALLA, "Nº ORDEN EN LA MALLA":s["Nº ORDEN EN LA MALLA"],
    "Nro. HORAS": Number(s["HORAS TEÓRICAS"]||0)+Number(s["HORAS PRÁCTICAS"]||0), OBSERVACIONES:"0"
  };
}

/* =================== Estado global =================== */
let MASTER_ASIG=[], MASTER_SECC=[], MASTER_CARGA=[], MASTER_PROY=[], MASTER_NO=[];
let OUT_SECC=[], OUT_COMB=[], OUT_CARGA=[], OUT_RES_MAT=[], OUT_NO=[], OUT_PLAN_DOC=[], OUT_PROY=[];
let CAREERS=[];

/* =================== UI =================== */
function validateFiles(){ const ok = document.getElementById('fileDoc').files[0] && document.getElementById('fileEst').files[0] && document.getElementById('fileMal').files[0]; document.getElementById('btnRun').disabled=!ok; }
function kpis(secc,asig,noasig,proy){ 
  document.getElementById('kSecciones').textContent=secc.length;
  document.getElementById('kAsignaciones').textContent=asig.length;
  let cap=0,asg=0; const map=new Map(); for(const r of proy){ cap+=Number(r["CAPACIDAD TOTAL"]||0); asg+=Number(r["TOTAL ESTUDIANTES"]||0); }
  document.getElementById('kOcupacion').textContent = cap? Math.round((asg/cap)*100)+'%':'0%';
  document.getElementById('kNo').textContent=noasig.length;
}

function fillCareerFilter(list){
  const sel=document.getElementById('careerFilter');
  sel.innerHTML='<option value="__ALL__">Todas las carreras</option>';
  Array.from(new Set(list.filter(Boolean))).sort().forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
}

function applyFilter(){
  const v=document.getElementById('careerFilter').value;
  document.getElementById('activeFilter').textContent = v==="__ALL__" ? "Sin filtros" : `Carrera: ${v}`;
  const asig = v==="__ALL__" ? MASTER_ASIG : MASTER_ASIG.filter(x=>(__norm(x["CARRERA DEL ESTUDIANTE"])===__norm(v)));
  const headersAsig=["NOMBRE_DOCENTE","DEDICACIÓN","MATERIA","Paralelo","DIA","HORA","Modalidad","ESTUDIANTE","CICLO","CARRERA DEL ESTUDIANTE"];
  const rowsAsig = asig.map(a=>({"NOMBRE_DOCENTE":a.NOMBRE_DOCENTE,"DEDICACIÓN":a.DEDICACIÓN||"0","MATERIA":a.MATERIA,"Paralelo":a.Paralelo,"DIA":a.DIA,"HORA":a.HORA,"Modalidad":a.Modalidad,"ESTUDIANTE":a.ESTUDIANTE,"CICLO":a.CICLO,"CARRERA DEL ESTUDIANTE":a["CARRERA DEL ESTUDIANTE"]}));
  renderTable(document.getElementById('tblCombo'), headersAsig, rowsAsig, 300);

  // Matriz completa filtrada
  const mat = v==="__ALL__" ? MASTER_ASIG : asig;
  const tbody=document.getElementById('bodyMatriz'); let html='';
  for(const r of mat){
    html += `<tr>
      <td>${esc(val(r.NOMBRE_DOCENTE))}</td><td>${esc(val(r.DEDICACIÓN))}</td><td>${esc(val(r.MATERIA))}</td>
      <td>${esc(val(r["CÓDIGO ANTHOLOGY"]))}</td><td>${esc(val(r["CARRERAS QUE COMPARTEN"]))}</td><td>${esc(val(r["PRE-REQUISITO"]))}</td>
      <td>${esc(val(r.CODIGO))}</td><td>${esc(val(r["HORAS TEÓRICAS"]))}</td><td>${esc(val(r["HORAS PRÁCTICAS"]))}</td><td>${esc(val(r["HORAS AUTÓNOMAS"]))}</td>
      <td>${esc(val(r.CREDITOS))}</td><td>${esc(val(r["CAMPO DE FORMACIÓN"]))}</td><td>${esc(val(r.CICLO))}</td><td>${esc(val(r.MALLA))}</td>
      <td>${esc(val(r["Nº ORDEN EN LA MALLA"]))}</td><td>${esc(val(r.Paralelo))}</td><td>${esc(val(r.DIA))}</td><td>${esc(val(r.HORA))}</td>
      <td>${esc(val(r.Modalidad))}</td><td>${esc(val(r["Nro. HORAS"]))}</td><td>${esc(val(r.ESTUDIANTE))}</td>
      <td>${esc(val(r["CARRERA DEL ESTUDIANTE"]))}</td><td>${esc(val(r["CICLO DEL ESTUDIANTE"]))}</td><td>${esc(val(r["NIVEL INGLES"]))}</td><td>${esc(val(r.OBSERVACIONES))}</td>
    </tr>`;
  }
  tbody.innerHTML = html || '<tr><td colspan="25" class="text-center muted" style="padding:20px">Sin datos</td></tr>';
}

/* =================== Bootstrap =================== */
document.getElementById('fileDoc').addEventListener('change',validateFiles);
document.getElementById('fileEst').addEventListener('change',validateFiles);
document.getElementById('fileMal').addEventListener('change',validateFiles);

document.getElementById('btnRun').addEventListener('click', async ()=>{
  const fD=document.getElementById('fileDoc').files[0];
  const fE=document.getElementById('fileEst').files[0];
  const fM=document.getElementById('fileMal').files[0];
  updateProgress(8);
  try{
    const [rowsD,rowsE,rowsM]=await Promise.all([readSheet(fD,"DOCENTES"),readSheet(fE,"ESTUDIANTES"),readSheet(fM,"MALLA")]);
    updateProgress(30);
    const DOC=normalizeDocentes(rowsD), EST=normalizeEstudiantes(rowsE), MAL=normalizeMallas(rowsM);
    updateProgress(55);
    const secciones = construirSecciones(DOC,MAL,EST);
    updateProgress(75);
    const {asignaciones,noAsig,carga,proy} = asignar(secciones,EST,MAL,DOC);
    updateProgress(95);

    // Garantía: no asignados debe ser 0 (por diseño)
    if(noAsig.length){ console.warn("Reasignaciones finales requeridas", noAsig); }

    MASTER_ASIG=asignaciones; MASTER_SECC=secciones; MASTER_CARGA=carga; MASTER_PROY=proy; MASTER_NO=noAsig;

    // preparar tablas base
    const cargaHeaders=["DOCENTE","DEDICACIÓN","MATERIA","Paralelo","DIA","HORA","ASIGNADOS","CAP"];
    renderTable(document.getElementById('tblCarga'), cargaHeaders, carga, 300);
    renderTable(document.getElementById('tblProy'),
      ["MATERIA","CICLO","TOTAL ESTUDIANTES","PARALELOS","CAPACIDAD TOTAL","DOCENTES","DETALLE POR CARRERA"], proy, 300);

    // KPI y filtro
    kpis(secciones, asignaciones, noAsig, proy);
    CAREERS = Array.from(new Set(asignaciones.map(a=>a["CARRERA DEL ESTUDIANTE"]).filter(Boolean)));
    fillCareerFilter(CAREERS);
    applyFilter();

    // esconder pre-ui y mostrar dashboard
    document.getElementById('preUI').classList.add('hidden');
    document.getElementById('postUI').classList.remove('hidden');

    // preparar datos de exportación
    OUT_SECC = secciones.map(s=>({"NOMBRE_DOCENTE":s.NOMBRE_DOCENTE,"DEDICACIÓN":s.DEDICACIÓN,"MATERIA":s.MATERIA,"CANTIDAD DE ALUMNOS ESPERADOS":s.CAP,"DIA":s.DIA,"HORA":s.HORA,"Modalidad":s.Modalidad,"Paralelo":s.Paralelo}));
    OUT_COMB = asignaciones.map(a=>({"NOMBRE_DOCENTE":a.NOMBRE_DOCENTE,"DEDICACIÓN":a.DEDICACIÓN||"0","MATERIA":a.MATERIA,"CANTIDAD DE ALUMNOS ESPERADOS":a["CANTIDAD DE ALUMNOS ESPERADOS"],"DIA":a.DIA,"HORA":a.HORA,"Modalidad":a.Modalidad,"Paralelo":a.Paralelo,"ESTUDIANTE":a.ESTUDIANTE,"CICLO":a.CICLO,"CARRERA DEL ESTUDIANTE":a["CARRERA DEL ESTUDIANTE"]}));
    OUT_CARGA = carga;
    OUT_RES_MAT = proy.map(r=>({"MATERIA":r.MATERIA,"Paralelo":"","ASIGNADOS":r["TOTAL ESTUDIANTES"],"CAP":r["CAPACIDAD TOTAL"],"OCUPACION": (r["CAPACIDAD TOTAL"]?Math.round(r["TOTAL ESTUDIANTES"]/r["CAPACIDAD TOTAL"]*100):0)+"%"}));
    OUT_NO = noAsig;

    OUT_PLAN_DOC = asignaciones.map(a=>({
      "DOCENTE": a.NOMBRE_DOCENTE, "DEDICACIÓN": a.DEDICACIÓN||"0", "MATERIA": a.MATERIA,
      "CÓDIGO ANTHOLOGY": a["CÓDIGO ANTHOLOGY"]||a.CODIGO||"0", "CARRERAS QUE COMPARTEN": a["CARRERAS QUE COMPARTEN"]||"0",
      "PRE-REQUISITO": a["PRE-REQUISITO"]||"0", "CODIGO": a.CODIGO||"0", "HORAS TEÓRICAS": a["HORAS TEÓRICAS"]||0,
      "HORAS PRÁCTICAS": a["HORAS PRÁCTICAS"]||0, "HORAS AUTÓNOMAS": a["HORAS AUTÓNOMAS"]||0, "CREDITOS": a.CREDITOS||0,
      "CAMPO DE FORMACIÓN": a["CAMPO DE FORMACIÓN"]||"0", "CICLO": a.CICLO||0, "MALLA": a.MALLA||"0",
      "Nº ORDEN EN LA MALLA": a["Nº ORDEN EN LA MALLA"]||0, "PARALELO": a.Paralelo||"0", "DIA": a.DIA||"0",
      "HORA": a.HORA||"0", "Modalidad": a.Modalidad||"0", "Nro. HORAS": a["Nro. HORAS"]||0, "NOMBRE DEL ESTUDIANTE": a.ESTUDIANTE||"0",
      "CARRERA DEL ESTUDIANTE": a["CARRERA DEL ESTUDIANTE"]||"0", "CICLO DEL ESTUDIANTE": a["CICLO DEL ESTUDIANTE"]||0,
      "NIVEL INGLES": a["NIVEL INGLES"]||"0", "OBSERVACIONES": a.OBSERVACIONES||"0"
    }));
    OUT_PROY = proy;

    document.getElementById('btnDown').classList.remove('hidden');
  }catch(err){
    alert(err.message);
  }
});

document.getElementById('careerFilter').addEventListener('change',applyFilter);

// Tabs
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
    t.classList.add('active'); document.getElementById(t.dataset.tab).classList.add('active');
  });
});

// Descarga
function exportar(){
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(OUT_SECC),'MATRIZ_SECCIONES');
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(OUT_COMB),'COMBINACION');
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(OUT_CARGA),'RESUMEN_CARGA');
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(OUT_RES_MAT),'RESUMEN_MATERIA');
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(OUT_NO),'NO_ASIGNADOS');
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(OUT_PLAN_DOC),'PLANIFICACION_DOCENTES');
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(OUT_PROY),'PROYECCION_POR_MATERIA');
  XLSX.writeFile(wb,'Planificacion_Asignacion_Docente.xlsx');
}
document.getElementById('btnDown').addEventListener('click',exportar);
document.getElementById('btnDown2').addEventListener('click',exportar);
</script>
</body>
</html>
