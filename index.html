<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Malla a Filas (ceros garantizados + prerrequisito)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f7f7f9;margin:0}
    .wrap{max-width:1200px;margin:28px auto;background:#fff;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.08);padding:28px}
    h1{margin:0 0 12px;color:#8a1f2d}
    .note{background:#e9effa;border-radius:8px;padding:12px 14px;margin:8px 0 18px}
    label{font-weight:600;margin-right:10px}
    select{padding:6px 10px;margin-right:18px}
    .btn{background:#244a8a;color:#fff;border:0;border-radius:8px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#173b74}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{border:1px solid #d6d6d6;padding:8px 10px}
    th{background:#8a1f2d;color:#fff;position:sticky;top:0}
    tr:nth-child(even){background:#fafafa}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Malla a Filas (ceros garantizados + prerrequisito)</h1>
    <div class="note">
      <b>1.</b> Elige <i>Carrera</i> y <i>Año</i>. <b>2.</b> Sube tu malla Excel (2019/2023).<br/>
      <b>3.</b> Se extraen materias reales con sus horas (los vacíos se vuelven <b>0</b>).<br/>
      <b>4.</b> Completa <i>PRERREQUISITO</i> manualmente según flechas, luego descarga.
    </div>

    <label>Carrera:
      <select id="carrera">
        <option>Administración</option>
        <option>Negocios Internacionales</option>
        <option>Marketing</option>
      </select>
    </label>

    <label>Año de malla:
      <select id="anio">
        <option>2019</option>
        <option>2023</option>
      </select>
    </label>

    <input type="file" id="file" accept=".xlsx" class="btn" />
    <button class="btn" id="btnExcel">Descargar como Excel</button>

    <div id="out"></div>
  </div>

<script>
let filas = [];
const HEADERS = ["CARRERA","AÑO","CICLO","MATERIA","CÓDIGO","HORAS TEÓRICAS","HORAS PRÁCTICAS","HORAS AUTÓNOMAS","PRERREQUISITO"];

// patrón de códigos típicos (PP-, FT-, CH-, CSC-, etc.)
function codigoValido(c) {
  if (!c) return false;
  return (
    /^[A-Z]{2,4}-\d{2,}-[A-Z0-9]+$/.test(c) ||
    /^PP-\d{2,}-[A-Z0-9]+$/.test(c) ||
    /^CH-[A-Z0-9-]+$/.test(c) ||
    /^FT-[A-Z0-9-]+$/.test(c) ||
    /^CSC-[A-Z0-9-]+$/.test(c)
  );
}

function materiaValida(n, c) {
  if (!n || !c) return false;
  const t = String(n).toLowerCase();
  if (
    t.includes("total") ||
    t.includes("componente") ||
    t.includes("carga horaria") ||
    t.includes("requisito titulación") ||
    t.includes("prácticas") ||
    t.includes("practicas") ||
    t.includes("servicio comunitario") ||
    t.includes("num. asignaturas") ||
    t.includes("nº orden en la malla")
  ) return false;
  return codigoValido(c);
}

// devuelve número; si está vacío o es NaN -> 0
function numOrZero(v) {
  if (v === undefined || v === null || v === "") return 0;
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

document.getElementById('file').addEventListener('change', (e) => {
  filas = [];
  const file = e.target.files?.[0];
  if (!file) return;

  const carrera = document.getElementById('carrera').value;
  const anio = document.getElementById('anio').value;

  const reader = new FileReader();
  reader.onload = (evt) => {
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, { type: 'array' });

    wb.SheetNames.forEach((name) => {
      const sheet = wb.Sheets[name];
      const A = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      const ciclos = A[0] ?? [];
      for (let col = 0; col < ciclos.length; col++) {
        const ciclo = (ciclos[col] ?? "").toString().trim();

        // Recorremos TODAS las filas — estructura flexible 2019/2023
        for (let row = 1; row < A.length - 1; row++) {
          const nombre = (A[row] && A[row][col]) ? String(A[row][col]).trim() : "";
          const codigo = (A[row+1] && A[row+1][col]) ? String(A[row+1][col]).trim() : "";

          if (!materiaValida(nombre, codigo)) continue;

          // Horas: en mallas trabajadas están a la DERECHA del código
          const ht = numOrZero(A[row+1]?.[col+1]);
          const hp = numOrZero(A[row+1]?.[col+2]);
          const ha = numOrZero(A[row+1]?.[col+3]);

          filas.push({
            "CARRERA": carrera,
            "AÑO": anio,
            "CICLO": ciclo,
            "MATERIA": nombre,
            "CÓDIGO": codigo,
            "HORAS TEÓRICAS": ht,
            "HORAS PRÁCTICAS": hp,
            "HORAS AUTÓNOMAS": ha,
            "PRERREQUISITO": "" // completar manualmente según flechas
          });
        }
      }
    });

    renderTabla();
  };
  reader.readAsArrayBuffer(file);
});

function renderTabla() {
  if (!filas.length) {
    document.getElementById('out').innerHTML = "<p style='color:#c00'><b>No se encontraron materias válidas.</b></p>";
    return;
  }
  let html = "<table><thead><tr>";
  html += HEADERS.map(h => `<th>${h}</th>`).join("");
  html += "</tr></thead><tbody>";

  for (const f of filas) {
    html += "<tr>";
    for (const h of HEADERS) {
      // usar nullish coalescing para NO borrar ceros
      html += `<td>${f[h] ?? ""}</td>`;
    }
    html += "</tr>";
  }
  html += "</tbody></table>";
  document.getElementById('out').innerHTML = html;
}

document.getElementById('btnExcel').addEventListener('click', () => {
  if (!filas.length) return;

  const data = [HEADERS];
  for (const f of filas) {
    // No usar "|| ''" para preservar 0
    data.push(HEADERS.map(h => (f[h] ?? "")));
  }
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Malla");
  XLSX.writeFile(wb, "malla_filas.xlsx");
});
</script>
</body>
</html>
