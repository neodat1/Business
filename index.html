<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matriz de planificación académica</title>
<style>
  :root{
    --azul:#04136C; --most:#DE912E; --vino:#862B39; --celes:#9CBEE3; --verde:#8A9520;
    --bg:#f7f9fc; --ink:#0c1021;
  }
  html, body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  header{display:flex;align-items:center;gap:16px;padding:16px 20px;background:var(--azul);color:#fff;border-bottom:4px solid var(--most)}
  header img{height:48px;width:auto;display:block}
  header h1{font-size:1.2rem;margin:0;font-weight:700;line-height:1.2}

  .card{background:#fff;border-radius:14px;padding:16px;margin:16px 20px;box-shadow:0 6px 20px rgba(4,19,108,.08);border:1px solid rgba(4,19,108,.08)}
  .inputs{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .inputs label{font-weight:600;color:var(--azul);font-size:.95rem}
  .inputs input[type=file]{padding:10px;background:#fff;border:1px solid #dfe3ee;border-radius:10px;width:300px}
  .btn{appearance:none;border:none;padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer;color:#fff;background:var(--verde)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .wrap{overflow:auto;max-height:70vh;border:1px solid #e6e9f3;border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;z-index:2;background:#0b1870;color:#fff;text-align:left;padding:10px;font-size:.88rem;border-bottom:2px solid var(--most)}
  tbody td{padding:8px 10px;border-bottom:1px solid #eef1f7;background:#fff;font-size:.9rem}
  tbody tr:nth-child(2n) td{background:#fbfcff}
  .muted{color:#6d738b;font-size:.9rem}
</style>
</head>
<body>
<header>
  <!-- Coloque el archivo del logo en la misma carpeta: UIDE-Ecuador.png -->
  <img src="UIDE-Ecuador.png" alt="UIDE" />
  <h1>Matriz de planificación académica</h1>
</header>

<div class="card">
  <div class="inputs">
    <label>0. Mallas.xlsx
      <input id="fileMalla" type="file" accept=".xlsx,.xls" />
    </label>
    <label>1. Docentes.xlsx
      <input id="fileDocentes" type="file" accept=".xlsx,.xls" />
    </label>
    <label>2. Restricciones.xlsx
      <input id="fileRest" type="file" accept=".xlsx,.xls" />
    </label>
    <button id="btnProcesar" class="btn" disabled>Procesar y Llenar Matriz</button>
  </div>
  <p class="muted" style="margin-top:10px;">
    Cargue exactamente los tres archivos y luego pulse “Procesar y Llenar Matriz”.
  </p>
</div>

<div class="card">
  <div class="wrap">
    <table id="tabla">
      <thead>
        <tr>
          <th>DOCENTE</th>
          <th>TITULO ACADÉMICO</th>
          <th>DEDICACIÓN</th>
          <th>MATERIA</th>
          <th>CÓDIGO ANTHOLOGY</th>
          <th>CARRERAS QUE COMPARTEN</th>
          <th>MALLA</th>
          <th>PRE-REQUISITO</th>
          <th>CODIGO</th>
          <th>HORAS TEÓRICAS</th>
          <th>HORAS PRÁCTICAS</th>
          <th>HORAS AUTÓNOMAS</th>
          <th>CREDITOS</th>
          <th>CAMPO DE FORMACIÓN</th>
          <th>CICLO MALLA</th>
          <th>Nº ORDEN EN LA MALLA</th>
          <th>ESTUDIANTES</th>
          <th>PARALELO</th>
          <th>DIA</th>
          <th>HORA</th>
          <th>MODALIDAD</th>
          <th>Nro. HORAS</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
/* ====== CARGA ROBUSTA DE SHEETJS (evita “XLSX is not defined”) ====== */
function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=()=>res();s.onerror=()=>rej(new Error("No se pudo cargar: "+src));document.head.appendChild(s);});}
async function ensureXLSX(){
  if(window.XLSX) return;
  const cdns=[
    "https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js",
    "https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js"
  ];
  let lastErr=null;
  for(const url of cdns){
    try{ await loadScript(url); if(window.XLSX) return; }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error("XLSX no disponible");
}

/* ====== utilidades ====== */
const ACCENT_MAP={'á':'a','é':'e','í':'i','ó':'o','ú':'u','Á':'A','É':'E','Í':'I','Ó':'O','Ú':'U','ñ':'n','Ñ':'N'};
const norm=s=>(s??"").toString().trim();
const normKey=s=>norm(s).toLowerCase().replace(/[áéíóúÁÉÍÓÚñÑ]/g,ch=>ACCENT_MAP[ch]||ch).replace(/\s+/g,' ').trim();
function pickCol(sample, aliases){ const m={}; Object.keys(sample).forEach(k=>m[normKey(k)]=k); for(const a of aliases){ const nk=normKey(a); if(m[nk]) return m[nk]; } return null; }

/* ====== lectura excel ====== */
async function readExcel(file){
  await ensureXLSX();
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data, { type:'array' });
  const ws = wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(ws, { defval:null });
}

/* ====== mapeos ====== */
const MAP_MALLA={
  carrera:["carrera","programa"],
  malla:["malla","plan","plan de estudios","plan estudios"],
  ciclo:["ciclo","semestre","nivel","periodo","periodo academico"],
  materia:["materia","asignatura","unidad curricular","curso","módulo","modulo"],
  codigo:["codigo","código","cod","id","clave"],
  codAnth:["codigo anthology","código anthology","anthology"],
  ht:["ht","horas teoricas","hrs teoricas","horas t","t teoricas","horas teoria","horas clase"],
  hp:["hp","horas practicas","hrs practicas","horas p","laboratorio","lab"],
  ha:["ha","horas autonomas","hrs autonomas","autoestudio"],
  creditos:["creditos","créditos","cr","ects"],
  prerreq:["prerrequisito","prerrequisitos","requisito","pre requisito","pre-requisito"],
  campoForm:["campo de formacion","campo formacion","campo formación"],
  cicloMalla:["ciclo malla"],
  ordenMalla:["nº orden en la malla","no orden en la malla","n orden en la malla","orden"],
  estudiantes:["estudiantes","n estudiantes","num estudiantes","alumnos"],
  paralelo:["paralelo","seccion","sección"],
  modalidad:["modalidad","tipo modalidad","presencial/virtual"],
  docente:["docente","profesor","profesora","nombres y apellidos","apellidos y nombres"]
};
const MAP_DOC={ docente:["docente","nombre","profesor","profesora","apellidos y nombres","nombres y apellidos","docente responsable"], titulo:["titulo academico","título académico","titulo","grado academico","titulacion"], dedic:["dedicacion","tipo dedicacion","jornada","contrato","tc/mt/tp","tipo"], modalidad:["modalidad","tipo modalidad","presencial/virtual"] };
const MAP_RES={ docente:["docente","profesor","nombre","apellidos y nombres"], dia:["dia","día","day"], hora:["hora","horario","time"] };

/* ====== normalización dedicación ====== */
function stdDedic(s){ const t=" "+normKey(s)+" "; if(t.includes(" tiempo completo ")||t.includes(" tc "))return "TC"; if(t.includes(" medio tiempo ")||t.includes(" mt "))return "MT"; if(t.includes(" tiempo parcial ")||t.includes(" tp ")||t.includes(" hora "))return "TP"; return norm(s); }

/* ====== días/slots y adyacencias ====== */
const DAYS=["Lunes","Martes","Miércoles","Jueves","Viernes"];
const SLOTS=["07:00–10:00","10:00–13:00","13:00–16:00","16:00–19:00","19:00–22:00"];
const ADJACENT={"PRIMERO":["SEGUNDO"],"SEGUNDO":["PRIMERO","TERCERO"],"TERCERO":["SEGUNDO","CUARTO"],"CUARTO":["TERCERO","QUINTO"],"QUINTO":["CUARTO","SEXTO"],"SEXTO":["QUINTO","SÉPTIMO","SEPTIMO"],"SÉPTIMO":["SEXTO","OCTAVO"],"SEPTIMO":["SEXTO","OCTAVO"],"OCTAVO":["SÉPTIMO","SEPTIMO"]};

/* ====== índices y scheduler ====== */
function buildIndex(rows,map){ if(!rows.length) return {data:[],cols:{}}; const sample=rows[0], resolved={}; for(const [k,al] of Object.entries(map)) resolved[k]=pickCol(sample,al); const data=rows.map(r=>{ const o={}; for(const [k,c] of Object.entries(resolved)) o[k]=c? r[c]:null; return o; }); return {data,cols:resolved}; }
function buildRestrictions(resRows){ const byDoc={}; for(const r of resRows){ const doc=norm(r.docente||""); if(!doc) continue; if(!byDoc[doc]) byDoc[doc]={days:new Set(),slots:new Set(),pairs:new Set()}; const d=norm(r.dia||""); const h=norm(r.hora||""); if(d&&!h) byDoc[doc].days.add(d.toLowerCase()); else if(!d&&h) byDoc[doc].slots.add(h.toLowerCase()); else if(d&&h) byDoc[doc].pairs.add((d+"|"+h).toLowerCase()); } return byDoc; }
function schedule(assignments,restrictions){ const perDocDayCount={}, perCycleSlotDay={}, out=[]; for(const a of assignments){ const doc=norm(a.docente); const r=restrictions[doc]||{days:new Set(),slots:new Set(),pairs:new Set()}; let placed=false; outer: for(const dia of DAYS){ if(r.days.has(dia.toLowerCase())) continue; const dcKey=`${doc}|${dia}`; if(perDocDayCount[dcKey]>=2) continue; for(const slot of SLOTS){ const pairKey=(dia+"|"+slot).toLowerCase(); if(r.slots.has(slot.toLowerCase())) continue; if(r.pairs.has(pairKey)) continue; const cyc=norm(a.ciclo||a.cicloMalla); const cycKey=`${cyc.toUpperCase()}|${dia}|${slot}`; if(perCycleSlotDay[cycKey]) continue; const adjs=ADJACENT[cyc.toUpperCase()]||[]; let conflict=false; for(const adj of adjs){ if(perCycleSlotDay[`${adj}|${dia}|${slot}`]){ conflict=true; break; } } if(conflict) continue; out.push({...a,dia,hora:slot}); perDocDayCount[dcKey]=(perDocDayCount[dcKey]||0)+1; perCycleSlotDay[cycKey]=true; placed=true; break outer; } } if(!placed) out.push({...a,dia:"",hora:""}); } return out; }
function uniqJoin(arr){ const seen=new Set(), out=[]; for(const v of arr){ const k=normKey(v); if(!k||seen.has(k)) continue; seen.add(k); out.push(norm(v)); } return out.join(" / "); }

/* ====== UI ====== */
const $malla=document.getElementById('fileMalla');
const $docs=document.getElementById('fileDocentes');
const $rest=document.getElementById('fileRest');
const $btn=document.getElementById('btnProcesar');
[$malla,$docs,$rest].forEach(i=>i.addEventListener('change',()=>{$btn.disabled=!( $malla.files[0] && $docs.files[0] && $rest.files[0] );}));

/* ====== ejecutar ====== */
$btn.addEventListener('click', async ()=>{
  try{
    const [mRows,dRows,rRows]=await Promise.all([ readExcel($malla.files[0]), readExcel($docs.files[0]), readExcel($rest.files[0]) ]);
    const {data:malla}=buildIndex(mRows,MAP_MALLA);
    const {data:docs}=buildIndex(dRows,MAP_DOC);
    const {data:rest}=buildIndex(rRows,MAP_RES);

    const docIndex={};
    for(const d of docs){ const nom=norm(d.docente); if(!nom) continue; docIndex[nom]={titulo:norm(d.titulo), dedic:stdDedic(d.dedic), modalidad:norm(d.modalidad)}; }
    const restIndex=buildRestrictions(rest);

    // materias con 0 estudiantes: fuera (si existe el dato)
    const filtered=malla.filter(r=>{
      const est=r.estudiantes;
      if(est===null||est===undefined||est==="") return true;
      const n=Number(est); if(Number.isNaN(n)) return true;
      return n>0;
    });

    // agrupar por materia+codigo+paralelo
    const keyOf=r=>[norm(r.materia),norm(r.codigo),norm(r.paralelo||"")].join("||");
    const groups={}; for(const r of filtered){ const k=keyOf(r); (groups[k]??=[]).push(r); }

    const base=[];
    for(const k of Object.keys(groups)){
      const items=groups[k];
      const take=f=>uniqJoin(items.map(it=>it[f]));
      const materia=norm(items[0].materia);
      const codigo=norm(items[0].codigo);
      const paralelo=norm(items[0].paralelo);
      const estudiantes=norm(items[0].estudiantes);
      const docente=norm(items[0].docente);
      const cicloRef=norm(items[0].ciclo||items[0].cicloMalla);
      const dInfo=docIndex[docente]||{titulo:"",dedic:"",modalidad:""};

      base.push({
        docente, titulo:dInfo.titulo, dedicacion:dInfo.dedic,
        materia, codAnth:take("codAnth"), carreras:take("carrera"), malla:take("malla"),
        prerreq:take("prerreq"), codigo, ht:take("ht"), hp:take("hp"), ha:take("ha"),
        creditos:take("creditos"), campoForm:take("campoForm"),
        ciclo:cicloRef, ordenMalla:take("ordenMalla"),
        estudiantes, paralelo, modalidad: (norm(items[0].modalidad)||dInfo.modalidad),
        dia:"", hora:"", nroHoras:""
      });
    }

    const planned=schedule(base,restIndex);

    const $tbody=document.getElementById('tbody'); $tbody.innerHTML="";
    for(const r of planned){
      const tr=document.createElement('tr');
      [ r.docente,r.titulo,r.dedicacion,r.materia,r.codAnth,r.carreras,r.malla,r.prerreq,r.codigo,
        r.ht,r.hp,r.ha,r.creditos,r.campoForm,r.ciclo,r.ordenMalla,r.estudiantes,r.paralelo,
        r.dia,r.hora,r.modalidad,r.nroHoras
      ].forEach(c=>{ const td=document.createElement('td'); td.textContent=c??""; tr.appendChild(td); });
      $tbody.appendChild(tr);
    }
  }catch(e){
    alert("No se pudo procesar: "+(e&&e.message?e.message:e));
    console.error(e);
  }
});
</script>
</body>
</html>
