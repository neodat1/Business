<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matriz Académica – UIDE</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
:root{--azul:#04136C;--mostaza:#DE912E;--vino:#862B39;--celeste:#9CBEE3;--verde:#8A9520}
*{box-sizing:border-box}
body{margin:0;font-family:"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f6f7fb;color:#111}
header{display:flex;align-items:center;gap:16px;padding:16px;background:linear-gradient(135deg,var(--azul),#000a3d);color:#fff}
header img{height:50px;width:auto}
header h1{margin:0;font-size:20px;font-weight:700}
.brandbar{height:5px;background:linear-gradient(90deg,var(--azul) 20%,var(--mostaza) 20% 40%,var(--vino) 40% 60%,var(--celeste) 60% 80%,var(--verde) 80%)}
.wrapper{max-width:1250px;margin:24px auto;padding:0 16px}
.card{background:#fff;border:1px solid #e2e5ef;border-radius:16px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin-bottom:20px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
label{font-size:13px;font-weight:700;color:#04136C;display:block;margin-bottom:6px}
input[type="file"]{width:100%;padding:10px;border:1px solid #ccd2e3;border-radius:12px;background:#fafbff}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
button{border:0;padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer;transition:.2s}
button:hover{opacity:.92}
.primary{background:var(--azul);color:#fff}
.accent{background:var(--mostaza);color:#1b1200}
.muted{background:#fff;color:var(--azul);border:2px solid var(--azul)}
#panelErrores strong{color:var(--vino)}
.errors{margin:8px 0 0;padding-left:20px;font-size:13px}
.scroll{overflow:auto;max-height:70vh;border:1px solid #e2e5ef;border-radius:14px}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px}
thead th{position:sticky;top:0;background:#fff;border-bottom:2px solid var(--celeste);padding:10px 8px;text-align:left;color:#06114a;z-index:1}
tbody td{border-bottom:1px solid #eef1f6;padding:8px;vertical-align:top}
tbody tr:nth-child(odd){background:#fbfdff}
h3{margin:0 0 8px 0;color:#04136C}
#docList{font-size:14px;margin:0;padding-left:18px}
#docList li{padding:2px 0;border-bottom:1px solid #eee}
</style>
</head>
<body>
<header>
  <img src="UIDE-Ecuador.png" alt="UIDE Ecuador">
  <h1>Matriz Académica – UIDE</h1>
</header>
<div class="brandbar"></div>

<div class="wrapper">
  <div class="card">
    <div class="row">
      <div><label>Archivo: 0. Mallas.xlsx (Hoja: Malla)</label><input id="fileMalla" type="file" accept=".xlsx,.xls" /></div>
      <div><label>Archivo: 1. Docentes.xlsx (Hoja: Docentes)</label><input id="fileDocentes" type="file" accept=".xlsx,.xls" /></div>
    </div>
    <div class="actions">
      <button id="btnProcesar" class="primary">Procesar</button>
      <button id="btnXLSX" class="accent" disabled>Descargar XLSX</button>
      <button id="btnCSV"  class="accent" disabled>Descargar CSV</button>
      <button id="btnLimpiar" class="muted">Limpiar</button>
    </div>
  </div>

  <div id="panelErrores" class="card" style="display:none">
    <strong>Observaciones / Conflictos</strong>
    <ul id="errores" class="errors"></ul>
  </div>

  <div class="card">
    <div class="scroll">
      <table id="matriz">
        <thead>
          <tr>
            <th>DOCENTE</th><th>TITULO ACADÉMICO</th><th>DEDICACIÓN</th><th>MATERIA</th><th>CÓDIGO ANTHOLOGY</th>
            <th>CARRERAS QUE COMPARTEN</th><th>MALLA</th><th>PRE-REQUISITO</th><th>CODIGO</th>
            <th>HORAS TEÓRICAS</th><th>HORAS PRÁCTICAS</th><th>HORAS AUTÓNOMAS</th><th>CREDITOS</th>
            <th>CAMPO DE FORMACIÓN</th><th>CICLO MALLA</th><th>Nº ORDEN EN LA MALLA</th>
            <th>PARALELO</th><th>DIA</th><th>HORA</th><th>MODALIDAD</th><th>Nro. HORAS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="cardDocentes" style="display:none">
    <h3>Lista de docentes (orden alfabético)</h3>
    <ul id="docList"></ul>
  </div>
</div>

<script>
/* ====== Parámetros ====== */
const DIAS = ['LUNES','MARTES','MIÉRCOLES','JUEVES','VIERNES'];
const SLOTS = ['07:00–10:00','10:00–13:00','13:00–16:00','16:00–19:00','19:00–22:00'];
const CYCLE_INDEX = {'PRIMERO':1,'SEGUNDO':2,'TERCERO':3,'CUARTO':4,'QUINTO':5,'SEXTO':6,'SÉPTIMO':7,'SEPTIMO':7,'OCTAVO':8,'NOVENO':9,'DÉCIMO':10,'DECIMO':10};
const ABC = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

/* ====== Utilidades ====== */
const nz = v => (v===undefined || v===null) ? '' : v;
const norm = v => nz(v).toString().replace(/\s+/g,' ').trim();
const upper = v => norm(v).toUpperCase();
const cicloIdx = c => CYCLE_INDEX[upper(c)] ?? 99;
const slashJoin = arr => Array.from(new Set(arr.map(x=>norm(x)).filter(Boolean))).join(' / ');

async function readWB(file){ const data = await file.arrayBuffer(); return XLSX.read(data,{type:'array'}); }
function sheetToJSON(wb, name){ const ws = wb.Sheets[name]; return ws ? XLSX.utils.sheet_to_json(ws,{defval:""}) : []; }

function clearTable(){ document.querySelector('#matriz tbody').innerHTML=''; }
function addRow(row){
  const tbody = document.querySelector('#matriz tbody');
  const tr = document.createElement('tr');
  [
    row.DOCENTE,row.TITULO_ACADEMICO,row.DEDICACION,row.MATERIA,row.CODIGO_ANTHOLOGY,
    row.CARRERAS_COMPARTEN,row.MALLA,row.PRE_REQUISITO,row.CODIGO,
    row.HORAS_TEORICAS,row.HORAS_PRACTICAS,row.HORAS_AUTONOMAS,row.CREDITOS,
    row.CAMPO_DE_FORMACION,row.CICLO_MALLA,row.N_ORDEN_MALLA,
    row.PARALELO,row.DIA,row.HORA,row.MODALIDAD,row.NRO_HORAS
  ].forEach(v=>{ const td=document.createElement('td'); td.textContent=nz(v); tr.appendChild(td); });
  tbody.appendChild(tr);
}
function addError(msg){
  const ul = document.getElementById('errores');
  const li = document.createElement('li'); li.textContent = msg; ul.appendChild(li);
  document.getElementById('panelErrores').style.display = 'block';
}

/* ====== Parse de disponibilidad ====== */
function normalizeDiacritics(s){ return upper(s).normalize('NFD').replace(/[\u0300-\u036f]/g,''); }

function parseDiasDisponibles(txt){
  if(!txt) return [...DIAS];
  let t = normalizeDiacritics(txt).replace(/,/g,' Y ').replace(/\s+/g,' ').trim(); // admite comas
  const canon = DIAS.map(d=>normalizeDiacritics(d));
  const idxOf = (name)=> canon.findIndex(d=>d===name);

  if(t.includes(' A ')){ // rango "LUNES A VIERNES"
    const [a,b] = t.split(' A ').map(s=>s.trim());
    const ia = idxOf(a), ib = idxOf(b);
    if(ia>=0 && ib>=0 && ib>=ia) return DIAS.slice(ia, ib+1);
  }
  if(t.includes(' Y ')){ // conjunto "MIERCOLES Y JUEVES"
    return t.split(' Y ').map(s=>s.trim()).map(s=> {
      const i=idxOf(s); return i>=0?DIAS[i]:'';
    }).filter(Boolean);
  }
  const i = idxOf(t);
  return i>=0 ? [DIAS[i]] : [...DIAS];
}

function parseHoraDisponible(txt){
  if(!txt) return [...SLOTS];
  let t = txt.toString().trim().toUpperCase().replace(/\s+/g,'').replace(/–/g,'-').replace('A','-');
  const toMin = hhmm=>{
    const m=/^(\d{1,2}):(\d{2})(?::\d{2})?$/.exec(hhmm); // soporta 13:00:00
    if(!m) return null; let h=parseInt(m[1],10), mi=parseInt(m[2],10); if(h<7) h+=12; return h*60+mi;
  };
  const parts = t.split('-').filter(Boolean);
  if(parts.length===2){
    const a=toMin(parts[0]), b=toMin(parts[1]); if(a!=null && b!=null && b>a){
      return SLOTS.filter(s=>{
        const [sa,sb]=s.replace('–','-').split('-');
        const sma=toMin(sa), smb=toMin(sb);
        return sma>=a && smb<=b;
      });
    }
  }
  return [...SLOTS]; // si no se entiende, habilite todos
}

/* ====== Construcción y combinación ====== */
function buildMallaAggregate(rows){
  const agg = new Map(); // materiaU -> agregado
  for(const r of rows){
    const materia = norm(r['MATERIA']); if(!materia) continue;
    const k = upper(materia);
    if(!agg.has(k)){
      agg.set(k,{materia,carreras:new Set(),mallas:new Set(),prereqs:new Set(),
        codigos:new Map(), hteor:new Map(), hprac:new Map(), hauton:new Map(),
        creditos:new Map(), campo:new Map(), ciclo:new Map(), norden:new Map()});
    }
    const a = agg.get(k);
    const carrera = norm(r['CARRERA']);
    a.carreras.add(carrera);
    const vMalla = norm(r['MALLA']); if(vMalla) a.mallas.add(vMalla);
    const vPre  = norm(r['PRERREQUISITO'] || r['PRE-REQUISITO']); if(vPre) a.prereqs.add(vPre);

    const put = (mp,val)=>{ if(val!=='' && val!==undefined && val!==null) mp.set(carrera, norm(val)); };
    put(a.codigos, r['CÓDIGO'] || r['CODIGO']);
    put(a.hteor,   r['HORAS TEÓRICAS'] || r['HORAS TEORICAS']);
    put(a.hprac,   r['HORAS PRÁCTICAS'] || r['HORAS PRACTICAS']);
    put(a.hauton,  r['HORAS AUTÓNOMAS'] || r['HORAS AUTONOMAS']);
    put(a.creditos,r['CRÉDITOS'] || r['CREDITOS']);
    put(a.campo,   r['CAMPO DE FORMACIÓN'] || r['CAMPO']);
    put(a.ciclo,   r['CICLO']);
    put(a.norden,  r['Nº ORDEN EN LA MALLA'] || r['NUMERO DE ORDEN EN LA MALLA'] || r['N ORDEN EN LA MALLA']);
  }
  return agg;
}

function buildDocentesIndex(rows){
  const idx = new Map(); // materiaU -> lista docentes
  for(const r of rows){
    const materia = norm(r['MATERIA']); if(!materia) continue;
    const k = upper(materia);
    const item = {
      DOCENTE:  norm(r['DOCENTE']),
      TITULO:   norm(r['TITULO ACADÉMICO'] || r['TÍTULO ACADÉMICO']),
      DEDIC:    norm(r['DEDICACION'] || r['DEDICACIÓN']),
      MODALIDAD:norm(r['Modalidad'] || r['MODALIDAD']),
      DIAS:     parseDiasDisponibles(r['DIA DISPONIBLE'] || r['DÍA DISPONIBLE'] || r['DIA']),
      SLOTS:    parseHoraDisponible(r['HORA DISPONIBLE'] || r['HORA'])
    };
    if(!idx.has(k)) idx.set(k, []);
    idx.get(k).push(item);
  }
  return idx;
}

function slashByCarrera(map, carreras){ return carreras.map(c=> map.get(c) ?? '').join(' / '); }

function assembleRows(aggMalla, idxDoc){
  const filas = [];
  for(const [matKey, info] of aggMalla.entries()){
    const docentes = idxDoc.get(matKey) || [];
    if(docentes.length===0){ addError(`Materia sin docente asignado: ${info.materia}`); continue; }

    const carreras = Array.from(info.carreras).sort((a,b)=>a.localeCompare(b,'es'));
    const pack = mp => slashByCarrera(mp, carreras);

    const base = {
      MATERIA: info.materia,
      CARRERAS_COMPARTEN: slashJoin(carreras),
      MALLA: slashJoin(Array.from(info.mallas)),
      PRE_REQUISITO: slashJoin(Array.from(info.prereqs)),
      CODIGO: pack(info.codigos),
      HORAS_TEORICAS: pack(info.hteor),
      HORAS_PRACTICAS: pack(info.hprac),
      HORAS_AUTONOMAS: pack(info.hauton),
      CREDITOS: pack(info.creditos),
      CAMPO_DE_FORMACION: pack(info.campo),
      CICLO_MALLA: pack(info.ciclo),
      N_ORDEN_MALLA: pack(info.norden),
      _carreras: carreras,
      _ciclos: carreras.map(c=> info.ciclo.get(c) ?? '')
    };

    docentes.forEach((d,j)=>{
      filas.push({
        DOCENTE: d.DOCENTE,
        TITULO_ACADEMICO: d.TITULO,
        DEDICACION: d.DEDIC,
        MATERIA: base.MATERIA,
        CODIGO_ANTHOLOGY: '',
        CARRERAS_COMPARTEN: base.CARRERAS_COMPARTEN,
        MALLA: base.MALLA,
        PRE_REQUISITO: base.PRE_REQUISITO,
        CODIGO: base.CODIGO,
        HORAS_TEORICAS: base.HORAS_TEORICAS,
        HORAS_PRACTICAS: base.HORAS_PRACTICAS,
        HORAS_AUTONOMAS: base.HORAS_AUTONOMAS,
        CREDITOS: base.CREDITOS,
        CAMPO_DE_FORMACION: base.CAMPO_DE_FORMACION,
        CICLO_MALLA: base.CICLO_MALLA,
        N_ORDEN_MALLA: base.N_ORDEN_MALLA,
        PARALELO: ABC[j] ?? `P${j+1}`,
        DIA: '', HORA: '',
        MODALIDAD: d.MODALIDAD,
        NRO_HORAS: '',
        _dias: d.DIAS, _slots: d.SLOTS,
        _carreras: base._carreras, _ciclos: base._ciclos
      });
    });
  }
  return filas;
}

/* ====== Asignación de horarios con reglas ====== */
function assignSchedules(filas){
  // Ocupación por docente (día -> count, slots) y por carrera (slotKey -> set de cycleIdx)
  const occDoc = new Map();
  const occCar = new Map();

  function canPlace(row, dia, slot){
    // Docente: máximo 2 por día, y no repetir el mismo slot
    if(!occDoc.has(row.DOCENTE)) occDoc.set(row.DOCENTE, {});
    const drec = occDoc.get(row.DOCENTE)[dia] ?? {count:0, slots:new Set()};
    if(drec.count >= 2) return false;
    if(drec.slots.has(slot)) return false;

    // Carrera: evitar ciclos adyacentes en mismo día/slot
    const slotKey = `${dia} ${slot}`;
    for(let i=0;i<row._carreras.length;i++){
      const car = row._carreras[i];
      const cIdx = cicloIdx(row._ciclos[i]);
      if(!occCar.has(car)) occCar.set(car, new Map());
      const mapSlot = occCar.get(car);
      if(!mapSlot.has(slotKey)) mapSlot.set(slotKey, new Set());
      const used = mapSlot.get(slotKey);
      for(const u of used){ if(Math.abs(u - cIdx) <= 1) return false; }
    }
    return true;
  }

  function place(row){
    // Respeta disponibilidad del docente
    const dias = row._dias.length ? row._dias : DIAS;
    const slots = row._slots.length ? row._slots : SLOTS;
    for(const d of DIAS.filter(x=>dias.includes(x))){
      for(const s of SLOTS.filter(x=>slots.includes(x))){
        if(canPlace(row,d,s)){
          // Aplicar ocupación
          const rec = occDoc.get(row.DOCENTE)[d] ?? {count:0, slots:new Set()};
          rec.count++; rec.slots.add(s);
          occDoc.get(row.DOCENTE)[d] = rec;

          const slotKey = `${d} ${s}`;
          for(let i=0;i<row._carreras.length;i++){
            const car = row._carreras[i];
            const idx = cicloIdx(row._ciclos[i]);
            if(!occCar.has(car)) occCar.set(car, new Map());
            const mapSlot = occCar.get(car);
            if(!mapSlot.has(slotKey)) mapSlot.set(slotKey, new Set());
            mapSlot.get(slotKey).add(idx);
          }
          row.DIA = d; row.HORA = s;
          return true;
        }
      }
    }
    return false;
  }

  // Orden: priorice ciclos más bajos primero ayuda a minimizar choques
  filas.sort((a,b)=>Math.min(...a._ciclos.map(c=>cicloIdx(c))) - Math.min(...b._ciclos.map(c=>cicloIdx(c))));
  let fallas = 0;
  for(const r of filas){
    if(!place(r)){ fallas++; addError(`No se pudo asignar horario sin choques: ${r.MATERIA} (${r.DOCENTE})`); }
  }
  return {filas, fallas};
}

/* ====== Export ====== */
function tableToSheet(){
  const headers=[...document.querySelectorAll('#matriz thead th')].map(th=>th.textContent);
  const rows=[...document.querySelectorAll('#matriz tbody tr')].map(tr=>[...tr.children].map(td=>td.textContent));
  return XLSX.utils.aoa_to_sheet([headers,...rows]);
}

/* ====== UI Events ====== */
document.getElementById('btnProcesar').addEventListener('click', async ()=>{
  const fM = document.getElementById('fileMalla').files[0];
  const fD = document.getElementById('fileDocentes').files[0];
  if(!fM || !fD){ alert('Cargue ambos archivos.'); return; }
  clearTable(); document.getElementById('panelErrores').style.display='none'; document.getElementById('errores').innerHTML='';

  const wbM = await readWB(fM); const wbD = await readWB(fD);
  const malla = sheetToJSON(wbM, 'Malla'); const docentes = sheetToJSON(wbD, 'Docentes');
  if(!malla.length || !docentes.length){ alert('Verifique nombres de hojas: Malla y Docentes.'); return; }

  const aggMalla = buildMallaAggregate(malla);
  const idxDoc   = buildDocentesIndex(docentes);
  let filas = assembleRows(aggMalla, idxDoc);

  const {filas: asignadas} = assignSchedules(filas);
  asignadas.forEach(addRow);

  // Lista de docentes en orden alfabético
  const lista = Array.from(new Set(asignadas.map(r=>r.DOCENTE))).filter(Boolean).sort((a,b)=>a.localeCompare(b,'es'));
  const ul = document.getElementById('docList'); ul.innerHTML='';
  lista.forEach(n=>{ const li=document.createElement('li'); li.textContent=n; ul.appendChild(li); });
  document.getElementById('cardDocentes').style.display = lista.length? 'block':'none';

  document.getElementById('btnXLSX').disabled=false;
  document.getElementById('btnCSV').disabled=false;
});

document.getElementById('btnXLSX').addEventListener('click', ()=>{
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, tableToSheet(), 'Matriz');
  XLSX.writeFile(wb, 'Planificacion_UIDE.xlsx');
});
document.getElementById('btnCSV').addEventListener('click', ()=>{
  const csv = XLSX.utils.sheet_to_csv(tableToSheet());
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Planificacion_UIDE.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
});
document.getElementById('btnLimpiar').addEventListener('click', ()=>{
  document.getElementById('fileMalla').value='';
  document.getElementById('fileDocentes').value='';
  clearTable();
  document.getElementById('panelErrores').style.display='none';
  document.getElementById('errores').innerHTML='';
  document.getElementById('btnXLSX').disabled=true;
  document.getElementById('btnCSV').disabled=true;
  document.getElementById('docList').innerHTML='';
  document.getElementById('cardDocentes').style.display='none';
});
</script>
</body>
</html>
