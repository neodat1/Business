<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Matriz de Planificación Académica — UIDE</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{--azul:#04136C;--mostaza:#DE912E;--vino:#862B39;--celeste:#9CBEE3;--verde:#8A9520;--gris:#f5f7fb;--borde:#e2e6ef;--texto:#1c2434}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--texto);background:#fff}
header{background:linear-gradient(90deg,var(--azul),var(--vino));color:#fff;padding:18px 22px;display:flex;align-items:center;gap:16px}
header img{height:46px;width:auto;border-radius:8px;background:#fff}
header h1{margin:0;font-size:20px}
.bar{display:flex;flex-wrap:wrap;gap:12px;padding:14px 18px;background:var(--gris);border-bottom:1px solid var(--borde)}
.card{background:#fff;border:1px solid var(--borde);border-radius:14px;padding:14px 16px}
button{background:var(--mostaza);color:#1a140b;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
button:hover{filter:brightness(.98)}
.wrap{padding:18px}
.status{margin:.25rem 0 1rem;font-size:13px}
.ok{color:var(--verde);font-weight:700}
.err{color:var(--vino);font-weight:700}
table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--borde);border-radius:14px}
thead th{position:sticky;top:0;background:linear-gradient(180deg,#fff,#f9fafc);border-bottom:1px solid var(--borde);padding:10px 8px;text-align:left;font-size:12.5px;color:#3a4661;white-space:nowrap}
tbody td{border-bottom:1px solid var(--borde);padding:9px 8px;font-size:13.5px;vertical-align:top}
tbody tr:nth-child(even){background:#fcfdff}
input[type="file"]{display:block}
</style>
</head>
<body>
<header>
  <img src="UIDE-Ecuador.png" alt="UIDE Ecuador">
  <div>
    <h1>Matriz de Planificación Académica</h1>
    <small>Emparejamiento ESTRICTO Materia↔Docente + disponibilidad, 2 máx/día, sin choques de ciclos adyacentes.</small>
  </div>
</header>

<div class="bar">
  <div class="card">
    <strong>Mallas (.xlsx)</strong>
    <div style="font-size:12px;color:#555">Hoja: <code>Malla</code></div>
    <input id="fileMallas" type="file" accept=".xls,.xlsx">
  </div>
  <div class="card">
    <strong>Docentes (.xlsx)</strong>
    <div style="font-size:12px;color:#555">Hoja: <code>Docentes</code></div>
    <input id="fileDocentes" type="file" accept=".xls,.xlsx">
  </div>
  <button id="btn">Procesar y Llenar Matriz</button>
</div>

<div class="wrap">
  <div id="status" class="status"></div>
  <div style="overflow:auto">
    <table id="tabla">
      <thead>
        <tr>
          <th>DOCENTE</th>
          <th>TITULO ACADÉMICO</th>
          <th>DEDICACIÓN</th>
          <th>MATERIA</th>
          <th>CÓDIGO ANTHOLOGY</th>
          <th>CARRERAS QUE COMPARTEN</th>
          <th>MALLA</th>
          <th>PRE-REQUISITO</th>
          <th>CODIGO</th>
          <th>HORAS TEÓRICAS</th>
          <th>HORAS PRÁCTICAS</th>
          <th>HORAS AUTÓNOMAS</th>
          <th>CREDITOS</th>
          <th>CAMPO DE FORMACIÓN</th>
          <th>CICLO MALLA</th>
          <th>Nº ORDEN EN LA MALLA</th>
          <th>PARALELO</th>
          <th>DIA</th>
          <th>HORA</th>
          <th>MODALIDAD</th>
          <th>Nro. HORAS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ========= Colores institucionales disponibles (en estilos) ========= */

/* =================== Utilidades =================== */
const SLOTS = [
  {label:"07:00-10:00", s:"07:00", e:"10:00"},
  {label:"10:00-13:00", s:"10:00", e:"13:00"},
  {label:"13:00-16:00", s:"13:00", e:"16:00"},
  {label:"16:00-19:00", s:"16:00", e:"19:00"},
  {label:"19:00-22:00", s:"19:00", e:"22:00"},
];
const DIAS = ["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES"];
const ORDEN_CICLOS = ["PRIMERO","SEGUNDO","TERCERO","CUARTO","QUINTO","SEXTO","SEPTIMO","SÉPTIMO","OCTAVO","NOVENO","DECIMO","DÉCIMO"];

const $status = document.getElementById('status');
const $tbody  = document.querySelector('#tabla tbody');

function norm(s){return (s ?? "").toString().trim();}
function normU(s){return norm(s).toUpperCase();}
function stripAccents(s){return s.normalize("NFD").replace(/[\u0300-\u036f]/g,"");}
function squashSpaces(s){return s.replace(/\s+/g," ").trim();}
function normalizeMateria(s){
  return stripAccents(normU(squashSpaces(s))); // EJ: "Herramientas   Informáticas" -> "HERRAMIENTAS INFORMATICAS"
}
function toMin(hhmm){
  const parts = hhmm.split(':').slice(0,2).map(Number);
  const h = parts[0] || 0, m = parts[1] || 0;
  return h*60 + m;
}
function slotIncluyeRango(slot, rango){
  if(!rango) return false;
  let r = rango.toUpperCase().replace(/\s+/g,'');
  r = r.replace('A','-'); // "07:00A22:00"
  if(!r.includes('-')){
    const hhmm = r.split(':').slice(0,2).join(':');
    const t = toMin(hhmm);
    return t>=toMin(slot.s) && t<=toMin(slot.e);
  }
  const [rs,re] = r.split('-');
  const s1 = toMin(slot.s), e1 = toMin(slot.e);
  const s2 = toMin(rs),      e2 = toMin(re);
  return s2<=s1 && e2>=e1;
}
function expandDias(txt){
  if(!txt) return [];
  let t = stripAccents(normU(txt)).replace("MIÉRCOLES","MIERCOLES");
  if(t.includes("LUNES A VIERNES")) return [...DIAS];
  return t.split(/,| Y /g).map(x=>x.trim()).filter(Boolean);
}
function leerHoja(file, sheet){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=e=>{
      try{
        const wb = XLSX.read(new Uint8Array(e.target.result),{type:'array'});
        const ws = wb.Sheets[sheet];
        if(!ws) return rej(new Error(`No se encontró la hoja "${sheet}".`));
        res(XLSX.utils.sheet_to_json(ws,{defval:""}));
      }catch(err){rej(err);}
    };
    fr.onerror=rej;
    fr.readAsArrayBuffer(file);
  });
}

/* =================== Disponibilidad Docentes e Índice Exacto =================== */
function esDocenteValido(nombre){
  const n = normU(nombre);
  if(!n) return false;
  if(n.includes("POWER SKILLS")) return false;
  if(n==="CONFIRMAR") return false;
  return true;
}
function construirIndiceDocentes(rows){
  // índice EXACTO por materia normalizada -> lista de docentes
  const idx = new Map();
  const meta = new Map(); // docente -> {dias,slots,modalidad,titulo,dedic}
  for(const r of rows){
    const d = normU(r["DOCENTE"]); if(!esDocenteValido(d)) continue;
    const mat = normalizeMateria(r["MATERIA"]);
    if(!mat) continue;

    const dias = new Set(expandDias(r["DIA DISPONIBLE"]));
    const horas = normU(r["HORA DISPONIBLE"]);
    const slots = new Set();
    for(const s of SLOTS) if(slotIncluyeRango(s, horas)) slots.add(s.label);
    if(slots.size===0) for(const s of SLOTS) slots.add(s.label);

    if(!meta.has(d)) meta.set(d,{dias:new Set(), slots:new Set(), modalidad:new Set(), titulo:new Set(), dedic:new Set()});
    const m = meta.get(d);
    dias.forEach(x=>m.dias.add(x));
    slots.forEach(x=>m.slots.add(x));
    if(r["Modalidad"]) m.modalidad.add(normU(r["Modalidad"]));
    if(r["TITULO ACADÉMICO"]) m.titulo.add(normU(r["TITULO ACADÉMICO"]));
    if(r["DEDICACION"] || r["DEDICACIÓN"]) m.dedic.add(normU(r["DEDICACION"]||r["DEDICACIÓN"]));

    if(!idx.has(mat)) idx.set(mat,[]);
    idx.get(mat).push(d);
  }
  return {idx, meta};
}

/* =================== Filas de Malla (una por carrera) =================== */
function construirFilasMalla(mallas){
  const out = mallas.map(r=>{
    const materia = squashSpaces(norm(r["MATERIA"]));
    const ciclo = stripAccents(normU(r["CICLO"]||r["CICLO MALLA"]));
    return {
      CARRERA: stripAccents(normU(r["CARRERA"])),
      MALLA: norm(r["MALLA"]),
      CICLO: ciclo,
      MATERIA: materia,
      _MAT_KEY: normalizeMateria(materia),
      "CÓDIGO ANTHOLOGY": norm(r["CÓDIGO ANTHOLOGY"]||""),
      "PRE-REQUISITO": norm(r["PRE-REQUISITO"]||r["PRERREQUISITO"]||r["PRE REQUISITO"]||""),
      CODIGO: norm(r["CÓDIGO"]||r["CODIGO"]),
      "HORAS TEÓRICAS": norm(r["HORAS TEÓRICAS"]),
      "HORAS PRÁCTICAS": norm(r["HORAS PRÁCTICAS"]),
      "HORAS AUTÓNOMAS": norm(r["HORAS AUTÓNOMAS"]),
      CREDITOS: norm(r["CRÉDITOS"]||r["CREDITOS"]),
      "CAMPO DE FORMACIÓN": norm(r["CAMPO DE FORMACIÓN"]),
      "Nº ORDEN EN LA MALLA": norm(r["Nº ORDEN EN LA MALLA"]||r["NRO ORDEN EN LA MALLA"]),
      MODALIDAD: "",
      DOCENTE: "",
      "TITULO ACADÉMICO": "",
      DEDICACIÓN: "",
      "CARRERAS QUE COMPARTEN": ""
    };
  });

  // CARRERAS QUE COMPARTEN por (materia,malla,ciclo)
  const key = r=>[r._MAT_KEY, r.MALLA, r.CICLO].join("|");
  const g = new Map();
  for(const r of out){ const k=key(r); if(!g.has(k)) g.set(k,[]); g.get(k).push(r); }
  for(const arr of g.values()){
    const lista = [...new Set(arr.map(x=>x.CARRERA))].join("/");
    arr.forEach(x=>x["CARRERAS QUE COMPARTEN"]=lista);
  }
  return out;
}

/* =================== Replicación por docentes (paralelos exactos) =================== */
function expandirPorDocentes(filasMalla, idxDoc){
  const out = [];
  const contParalelo = new Map(); // (CARRERA|MALLA|CICLO|MATERIA) -> n
  const kPar = r=>[r.CARRERA,r.MALLA,r.CICLO,r._MAT_KEY].join("|");

  for(const r of filasMalla){
    const lista = idxDoc.get(r._MAT_KEY) || [];
    if(lista.length===0){
      // sin docente conocido -> fila sin docente (no forzar emparejamientos erróneos)
      const cp = {...r, PARALELO:"A"}; // único placeholder
      out.push(cp);
      continue;
    }
    for(const d of lista){
      const cp = {...r};
      const n = (contParalelo.get(kPar(cp))||0)+1; contParalelo.set(kPar(cp),n);
      cp.PARALELO = String.fromCharCode(64+n); // A,B,C…
      cp.DOCENTE = d;
      out.push(cp);
    }
  }
  return out;
}

/* =================== Asignación día/hora (Backtracking sobre filas ya asignadas a un docente) =================== */
function vecinosCiclo(ciclo){
  const C = stripAccents(normU(ciclo));
  let idx = ORDEN_CICLOS.indexOf(C);
  if(idx<0){
    const map = {"SÉPTIMO":"SEPTIMO","DÉCIMO":"DECIMO"};
    idx = ORDEN_CICLOS.indexOf(map[C]||C);
  }
  const v=[]; if(idx>0) v.push(ORDEN_CICLOS[idx-1]); if(idx>=0 && idx<ORDEN_CICLOS.length-1) v.push(ORDEN_CICLOS[idx+1]);
  return v;
}
function planificar(filas, metaDoc){
  const ocupDocDia = new Map(); // docente -> { DIA -> {count, slots:Set} }
  const ocupCiclo  = new Map(); // key(carrera|malla|ciclo) -> Set("DIA|SLOT")

  function cicloKey(r){return `${r.CARRERA}|${r.MALLA}|${r.CICLO}`;}
  function puedeDoc(d, dia, slot){
    let reg = ocupDocDia.get(d) || {};
    let dd = reg[dia] || {count:0, slots:new Set()};
    if(dd.count>=2) return false;
    if(dd.slots.has(slot)) return false;
    return true;
  }
  function ocupaDoc(d, dia, slot, inc=true){
    let reg = ocupDocDia.get(d); if(!reg){reg={}; ocupDocDia.set(d,reg);}
    let dd = reg[dia]; if(!dd){dd={count:0,slots:new Set()}; reg[dia]=dd;}
    if(inc){dd.count++; dd.slots.add(slot);} else {dd.count--; dd.slots.delete(slot);}
  }
  function hayChoqueCiclo(r, dia, slot){
    for(const v of vecinosCiclo(r.CICLO)){
      const k = `${r.CARRERA}|${r.MALLA}|${v}`;
      const set = ocupCiclo.get(k);
      if(set && set.has(`${dia}|${slot}`)) return true;
    }
    return false;
  }
  function ocupaCiclo(r, dia, slot, inc=true){
    const k = cicloKey(r);
    let set = ocupCiclo.get(k); if(!set){set=new Set(); ocupCiclo.set(k,set);}
    if(inc) set.add(`${dia}|${slot}`); else set.delete(`${dia}|${slot}`);
  }
  function opciones(r, d){
    const info = metaDoc.get(d);
    if(!info) return []; // no hay disponibilidad declarada
    const dias = [...info.dias];
    const slots= [...info.slots];
    const out=[];
    for(const sl of slots) for(const di of dias){
      if(!puedeDoc(d,di,sl)) continue;
      if(hayChoqueCiclo(r,di,sl)) continue;
      out.push([di,sl]);
    }
    // priorizar por menor carga del día del docente
    out.sort((a,b)=>{
      const ra=(ocupDocDia.get(d)?.[a[0]]?.count)||0;
      const rb=(ocupDocDia.get(d)?.[b[0]]?.count)||0;
      return ra-rb;
    });
    return out;
  }

  // Orden: primero las filas con menos opciones (MRV)
  const trabajos = filas.map((r,i)=>{
    if(!r.DOCENTE) return {idx:i, fila:r, ops:[]}; // quedará sin asignar
    const ops = opciones(r, r.DOCENTE);
    return {idx:i, fila:r, ops};
  });
  trabajos.sort((a,b)=>a.ops.length - b.ops.length);

  function bt(k){
    if(k===trabajos.length) return true;
    const t = trabajos[k], r = t.fila;
    if(!r.DOCENTE || t.ops.length===0){
      r.DIA="[SIN ESPACIO]"; r.HORA="[SIN ESPACIO]";
      return bt(k+1);
    }
    for(const [dia,slot] of t.ops){
      ocupaDoc(r.DOCENTE,dia,slot,true);
      ocupaCiclo(r,dia,slot,true);
      r.DIA=dia; r.HORA=slot;
      if(bt(k+1)) return true;
      // deshacer
      ocupaCiclo(r,dia,slot,false);
      ocupaDoc(r.DOCENTE,dia,slot,false);
      r.DIA=""; r.HORA="";
    }
    r.DIA="[SIN ESPACIO]"; r.HORA="[SIN ESPACIO]";
    return bt(k+1);
  }
  bt(0);
  return filas;
}

/* =================== Render =================== */
function limpiar(){ $tbody.innerHTML=""; }
function cell(v){return (v===undefined||v===null)?"":String(v);}
function render(filas){
  limpiar();
  const frag=document.createDocumentFragment();
  for(const r of filas){
    const tr=document.createElement('tr');
    const cols=[
      r.DOCENTE, r["TITULO ACADÉMICO"], r.DEDICACIÓN, r.MATERIA, r["CÓDIGO ANTHOLOGY"],
      r["CARRERAS QUE COMPARTEN"], r.MALLA, r["PRE-REQUISITO"], r.CODIGO,
      r["HORAS TEÓRICAS"], r["HORAS PRÁCTICAS"], r["HORAS AUTÓNOMAS"], r.CREDITOS,
      r["CAMPO DE FORMACIÓN"], r.CICLO, r["Nº ORDEN EN LA MALLA"], r.PARALELO,
      r.DIA||"", r.HORA||"", r.MODALIDAD||"", ""
    ];
    for(const c of cols){const td=document.createElement('td'); td.textContent=cell(c); tr.appendChild(td);}
    frag.appendChild(tr);
  }
  $tbody.appendChild(frag);
}

/* =================== Flujo principal =================== */
document.getElementById('btn').addEventListener('click', async ()=>{
  try{
    $status.textContent="";
    const fM = document.getElementById('fileMallas').files[0];
    const fD = document.getElementById('fileDocentes').files[0];
    if(!fM || !fD){ $status.innerHTML = `<span class="err">Cargue ambos archivos: Mallas y Docentes.</span>`; return; }

    $status.textContent = "Leyendo archivos…";
    const [mallasRaw, docentesRaw] = await Promise.all([leerHoja(fM,"Malla"), leerHoja(fD,"Docentes")]);

    // Normalizaciones mínimas en Docentes
    for(const r of docentesRaw){
      r["DOCENTE"]=normU(squashSpaces(r["DOCENTE"]));
      r["DIA DISPONIBLE"]=normU(r["DIA DISPONIBLE"]).replace("MIÉRCOLES","MIERCOLES");
      r["HORA DISPONIBLE"]=normU(r["HORA DISPONIBLE"]);
      r["Modalidad"]=normU(r["Modalidad"]);
      r["TITULO ACADÉMICO"]=normU(r["TITULO ACADÉMICO"]);
      r["DEDICACION"]=normU(r["DEDICACION"]||r["DEDICACIÓN"]);
      r["MATERIA"]=squashSpaces(norm(r["MATERIA"]));
    }

    const {idx: idxMateriaDoc, meta: metaDoc} = construirIndiceDocentes(docentesRaw);
    const filasMalla = construirFilasMalla(mallasRaw);
    const filasExpand = expandirPorDocentes(filasMalla, idxMateriaDoc);

    // Completar metadatos de docente (título, dedicación y modalidad) en filas con docente asignado
    for(const r of filasExpand){
      if(r.DOCENTE && metaDoc.has(r.DOCENTE)){
        const info = metaDoc.get(r.DOCENTE);
        r["TITULO ACADÉMICO"] = info.titulo.size ? [...info.titulo][0] : r["TITULO ACADÉMICO"];
        r.DEDICACIÓN = info.dedic.size ? [...info.dedic][0] : r.DEDICACIÓN;
        r.MODALIDAD = info.modalidad.size ? [...info.modalidad][0] : r.MODALIDAD;
      }
    }

    // Asignación de día/hora SOLO para filas con docente asignado
    const filasPlan = planificar(filasExpand, metaDoc);

    render(filasPlan);
    const total = filasPlan.length;
    const sinEspacio = filasPlan.filter(x=>x.DIA==="[SIN ESPACIO]"||x.HORA==="[SIN ESPACIO]").length;
    const sinDoc = filasPlan.filter(x=>!x.DOCENTE).length;
    $status.innerHTML = `<span class="${sinEspacio? 'err':'ok'}">${sinEspacio? 'Atención':'OK'}:</span> `+
      `Se procesaron <b>${total}</b> registros. `+
      `${sinDoc? `<b>${sinDoc}</b> sin docente (materia no existe en Docentes). `:``}`+
      `${sinEspacio? `<b>${sinEspacio}</b> sin espacio disponible según restricciones.` : 'Sin choques.'}`;
  }catch(err){
    console.error(err);
    $status.innerHTML = `<span class="err">Error:</span> ${err.message||err}`;
  }
});
</script>
</body>
</html>
