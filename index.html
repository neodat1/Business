<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matriz Académica – UIDE (restricciones estrictas + adyacencias por horario)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
:root{--azul:#04136C;--mostaza:#DE912E;--vino:#862B39;--celeste:#9CBEE3;--verde:#8A9520;--bg:#f6f7fb;--ink:#111}
*{box-sizing:border-box}
body{margin:0;font-family:"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
header{display:flex;align-items:center;gap:16px;padding:16px;background:#fff;color:var(--azul);border-bottom:4px solid var(--mostaza);box-shadow:0 1px 6px rgba(0,0,0,.06)}
header img{height:56px;width:auto}
header h1{margin:0;font-size:20px;font-weight:700}
.wrapper{max-width:1250px;margin:24px auto;padding:0 16px}
.card{background:#fff;border:1px solid #e2e5ef;border-radius:16px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin-bottom:20px}
.row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
label{font-size:13px;font-weight:700;color:#04136C;display:block;margin-bottom:6px}
input[type="file"]{width:100%;padding:10px;border:1px solid #ccd2e3;border-radius:12px;background:#fafbff}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
button{border:0;padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer;transition:.2s}
button:hover{opacity:.92}
.primary{background:var(--azul);color:#fff}
.accent{background:var(--mostaza);color:#1b1200}
.muted{background:#fff;color:var(--azul);border:2px solid var(--azul)}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#fff3f3;color:#7a0d18;border:1px solid #f2c9cf;font-size:12px}
.scroll{overflow:auto;max-height:70vh;border:1px solid #e2e5ef;border-radius:14px}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px}
thead th{position:sticky;top:0;background:#fff;border-bottom:2px solid var(--celeste);padding:10px 8px;text-align:left;color:#06114a;z-index:1;cursor:pointer;user-select:none}
thead th .arrow{font-size:11px;opacity:.65;margin-left:6px}
tbody td{border-bottom:1px solid #eef1f6;padding:8px;vertical-align:top}
tbody tr:nth-child(odd){background:#fbfdff}
/* chips coloreadas (solo valor) */
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{display:inline-flex;align-items:center;border-radius:999px;padding:2px 10px;border:1px solid rgba(0,0,0,.05);font-weight:700;font-size:12px}
</style>
</head>
<body>
<header>
  <img src="UIDE-Ecuador.png" alt="UIDE Ecuador">
  <h1>Matriz de planificación académica</h1>
</header>

<div class="wrapper">
  <div class="card">
    <div class="row">
      <div><label>0. Mallas.xlsx</label><input id="fileMalla" type="file" accept=".xlsx,.xls" /></div>
      <div><label>1. Docentes.xlsx</label><input id="fileDocentes" type="file" accept=".xlsx,.xls" /></div>
      <div><label>2. Restricciones.xlsx</label><input id="fileRest" type="file" accept=".xlsx,.xls" /></div>
    </div>
    <div class="actions">
      <button id="btnProcesar" class="primary">Procesar</button>
      <button id="btnXLSX" class="accent" disabled>Descargar XLSX</button>
      <button id="btnCSV"  class="accent" disabled>Descargar CSV</button>
      <button id="btnLimpiar" class="muted">Limpiar</button>
      <span id="resumen" class="badge" style="display:none"></span>
    </div>
  </div>

  <div class="card">
    <div class="scroll">
      <table id="matriz">
        <thead>
          <tr>
            <th>DOCENTE <span class="arrow">↕</span></th>
            <th>TITULO ACADÉMICO <span class="arrow">↕</span></th>
            <th>DEDICACIÓN <span class="arrow">↕</span></th>
            <th>MATERIA <span class="arrow">↕</span></th>
            <th>CÓDIGO ANTHOLOGY <span class="arrow">↕</span></th>
            <th>CARRERAS QUE COMPARTEN <span class="arrow">↕</span></th>
            <th>MALLA <span class="arrow">↕</span></th>
            <th>PRE-REQUISITO <span class="arrow">↕</span></th>
            <th>CODIGO <span class="arrow">↕</span></th>
            <th>HORAS TEÓRICAS <span class="arrow">↕</span></th>
            <th>HORAS PRÁCTICAS <span class="arrow">↕</span></th>
            <th>HORAS AUTÓNOMAS <span class="arrow">↕</span></th>
            <th>CREDITOS <span class="arrow">↕</span></th>
            <th>CAMPO DE FORMACIÓN <span class="arrow">↕</span></th>
            <th>CICLO MALLA <span class="arrow">↕</span></th>
            <th>Nº ORDEN EN LA MALLA <span class="arrow">↕</span></th>
            <th>ESTUDIANTES <span class="arrow">↕</span></th>
            <th>PARALELO <span class="arrow">↕</span></th>
            <th>DIA <span class="arrow">↕</span></th>
            <th>HORA <span class="arrow">↕</span></th>
            <th>MODALIDAD <span class="arrow">↕</span></th>
            <th>Nro. HORAS <span class="arrow">↕</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ===== Parámetros ===== */
const DIAS=['LUNES','MARTES','MIÉRCOLES','MIERCOLES','JUEVES','VIERNES'];
const SLOTS=['07:00–10:00','10:00–13:00','13:00–16:00','16:00–19:00','19:00–22:00'];
const CYCLE_INDEX={'PRIMERO':1,'SEGUNDO':2,'TERCERO':3,'CUARTO':4,'QUINTO':5,'SEXTO':6,'SÉPTIMO':7,'SEPTIMO':7,'OCTAVO':8,'NOVENO':9,'DÉCIMO':10,'DECIMO':10};
const ABC="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
const STOP=new Set(['DE','DEL','LA','LOS','LAS','EN','PARA','CON','Y','E','EL','AL','A','II','III','IV','VI','VII','VIII','IX','X']);
const PALETA=['#04136C','#DE912E','#862B39','#9CBEE3','#8A9520'];
const carreraColor=new Map();

/* Abreviaturas de carreras */
function abrevCarrera(name){
  const s=rmDiac(upper(name));
  if(/ADMINISTR/.test(s)) return 'ADM';
  if(/MARKETING/.test(s)) return 'MKT';
  if(/NEGOCIOS\s*INTERNACIONALES/.test(s)) return 'NNII';
  return s;
}

/* ===== Utilidades ===== */
const nz=v=>(v===undefined||v===null)?'':v;
const norm=v=>nz(v).toString().replace(/\s+/g,' ').trim();
const upper=v=>norm(v).toUpperCase();
const cicloIdx=c=>CYCLE_INDEX[upper(c)]??99;
const rmDiac=s=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
function colorDe(carrera){
  const k=upper(carrera);
  if(carreraColor.has(k)) return carreraColor.get(k);
  const col=PALETA[carreraColor.size % PALETA.length];
  carreraColor.set(k,col);
  return col;
}
function readWB(file){return file.arrayBuffer().then(buf=>XLSX.read(buf,{type:'array'}));}
function sheetToJSONAuto(wb, prefer=[""]){
  let target=null, lc=s=>s.toLowerCase();
  for(const name of wb.SheetNames){const ln=lc(name); if(prefer.some(k=>ln.includes(lc(k)))){target=name;break;}}
  if(!target){
    let max=0;
    for(const name of wb.SheetNames){
      const ws=wb.Sheets[name]; const ref=ws['!ref']; if(!ref) continue;
      const r=XLSX.utils.decode_range(ref); const rows=r.e.r-r.s.r+1;
      if(rows>max){max=rows; target=name;}
    }
  }
  const ws=wb.Sheets[target];
  return ws?XLSX.utils.sheet_to_json(ws,{defval:""}):[];
}
function clearTable(){document.querySelector('#matriz tbody').innerHTML='';}

/* chips por carrera (solo valor) */
function chipsHTML(pares){
  const esc = s => String(s).replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
  return `<div class="chips">` + pares.map(p=>{
    const col=colorDe(p.car);
    const style=`background:${col}10;border:1px solid ${col}33;color:${col};`;
    const val = (p.val && String(p.val).trim()!=='') ? p.val : '—';
    return `<span class="chip" style="${style}">${esc(val)}</span>`;
  }).join('') + `</div>`;
}
function addRow(row){
  const tb=document.querySelector('#matriz tbody'); const tr=document.createElement('tr');
  const simple = (v)=>{const td=document.createElement('td'); td.textContent=nz(v); return td;};
  tr.appendChild(simple(row.DOCENTE));
  tr.appendChild(simple(row.TITULO_ACADEMICO));
  tr.appendChild(simple(row.DEDICACION));
  tr.appendChild(simple(row.MATERIA));
  tr.appendChild(simple(row.CODIGO_ANTHOLOGY));
  const tdCarr=document.createElement('td'); tdCarr.innerHTML = chipsHTML(row._chipsCarreras); tr.appendChild(tdCarr);
  const tdMalla=document.createElement('td'); tdMalla.innerHTML = chipsHTML(row._chipsMalla); tr.appendChild(tdMalla);
  const tdPre=document.createElement('td'); tdPre.innerHTML   = chipsHTML(row._chipsPrereq); tr.appendChild(tdPre);
  const tdCod=document.createElement('td'); tdCod.innerHTML   = chipsHTML(row._chipsCodigo); tr.appendChild(tdCod);
  const tdHT=document.createElement('td'); tdHT.innerHTML     = chipsHTML(row._chipsHT); tr.appendChild(tdHT);
  const tdHP=document.createElement('td'); tdHP.innerHTML     = chipsHTML(row._chipsHP); tr.appendChild(tdHP);
  const tdHA=document.createElement('td'); tdHA.innerHTML     = chipsHTML(row._chipsHA); tr.appendChild(tdHA);
  const tdCR=document.createElement('td'); tdCR.innerHTML     = chipsHTML(row._chipsCred); tr.appendChild(tdCR);
  const tdCF=document.createElement('td'); tdCF.innerHTML     = chipsHTML(row._chipsCampo); tr.appendChild(tdCF);
  const tdCiclo=document.createElement('td'); tdCiclo.innerHTML = chipsHTML(row._chipsCiclo); tr.appendChild(tdCiclo);
  const tdOrd=document.createElement('td'); tdOrd.innerHTML     = chipsHTML(row._chipsOrden); tr.appendChild(tdOrd);
  tr.appendChild(simple(row.ESTUDIANTES));
  tr.appendChild(simple(row.PARALELO));
  tr.appendChild(simple(row.DIA));
  tr.appendChild(simple(row.HORA));
  tr.appendChild(simple(row.MODALIDAD));
  tr.appendChild(simple(row.NRO_HORAS));
  tb.appendChild(tr);
}

/* ===== Canon materias + similitud ===== */
function romanToInt(w){const m={I:1,V:5,X:10,L:50,C:100,D:500,M:1000};let s=w.toUpperCase();if(!/^[IVXLCDM]+$/.test(s))return null;let n=0;for(let i=0;i<s.length;i++){const v=m[s[i]],u=m[s[i+1]]||0;n+=v<u?-v:v;}return n;}
function canonMateria(s){
  let t=upper(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  t=t.replace(/&/g,' Y ').replace(/[_\-.,()]/g,' ').replace(/\s+/g,' ').trim();
  t=t.replace(/\bMATEMATICAS?\b/g,'MATEMATICA');
  t=t.split(' ').map(w=>{const n=romanToInt(w);return (n&&n<=20)?String(n):w;}).join(' ');
  const toks=t.split(' ').filter(w=>w&&!STOP.has(w)); return toks.join(' ').trim();
}
function tokens(str){return new Set(canonMateria(str).split(' ').filter(Boolean));}
function jaccard(aSet,bSet){let inter=0;const small=aSet.size<bSet.size?aSet:bSet,big=aSet.size<bSet.size?bSet:aSet;small.forEach(x=>{if(big.has(x))inter++;});const uni=aSet.size+bSet.size-inter;return uni?inter/uni:0;}

/* ===== Índices ===== */
function buildMallaAggregate(rows){
  const agg=new Map();
  const firstVal = (...keys) => r => {for(const k of keys){if(r[k]!==undefined&&r[k]!==null&&String(r[k]).trim()!=="")return String(r[k]);}return "";}
  const getEst   = firstVal('ESTUDIANTES','N ESTUDIANTES','NUM ESTUDIANTES','NRO ESTUDIANTES','# ESTUDIANTES');
  const getMat   = firstVal('MATERIA','ASIGNATURA');
  const getCar   = firstVal('CARRERA');
  const getMalla = firstVal('MALLA','PLAN','PLAN/MALLA','PLAN DE ESTUDIOS');
  const getPre   = firstVal('PRERREQUISITO','PRE-REQUISITO','PRE REQUISITO','PRERREQUISITOS','PRE');
  const getCod   = firstVal('CÓDIGO','CODIGO','COD','COD ASIG');
  const getAnth  = firstVal('CÓDIGO ANTHOLOGY','CODIGO ANTHOLOGY','ANTHOLOGY','COD ANTHOLOGY');
  const getHT    = firstVal('HORAS TEÓRICAS','HORAS TEORICAS','HT','H.TEORICAS');
  const getHP    = firstVal('HORAS PRÁCTICAS','HORAS PRACTICAS','HP','H.PRACTICAS');
  const getHA    = firstVal('HORAS AUTÓNOMAS','HORAS AUTONOMAS','HA','H.AUTONOMAS');
  const getCred  = firstVal('CRÉDITOS','CREDITOS','CR','CR.','CRÉDITO');
  const getCampo = firstVal('CAMPO DE FORMACIÓN','CAMPO','CAMPO FORMACION');
  const getCiclo = firstVal('CICLO','CICLO MALLA','NIVEL','SEMESTRE');
  const getOrden = firstVal('Nº ORDEN EN LA MALLA','NUMERO DE ORDEN EN LA MALLA','N ORDEN EN LA MALLA','ORDEN','NRO ORDEN');

  for(const r of rows){
    const estRaw = getEst(r);
    if(estRaw!=="" && !Number.isNaN(Number(estRaw)) && Number(estRaw)<=0) continue;

    const materia=norm(getMat(r)); if(!materia) continue;
    const k=canonMateria(materia);
    if(!agg.has(k)){
      agg.set(k,{key:k,materiaOrig:materia,carreras:new Set(),mallas:new Set(),mallaByCar:new Map(),
        prereqs:new Map(),codigos:new Map(),anth:new Map(),hteor:new Map(),hprac:new Map(),hauton:new Map(),
        creditos:new Map(),campo:new Map(),ciclo:new Map(),norden:new Map(),estudiantes:new Map()});
    }
    const a=agg.get(k), car=norm(getCar(r));
    a.carreras.add(car);
    const put=(mp,val)=>{if(val!==''&&val!==undefined&&val!==null) mp.set(car,norm(val));};
    const vMalla=norm(getMalla(r)); if(vMalla){ a.mallas.add(vMalla); a.mallaByCar.set(car,vMalla); }
    put(a.prereqs, getPre(r));  put(a.codigos, getCod(r)); put(a.anth, getAnth(r));
    put(a.hteor, getHT(r));     put(a.hprac, getHP(r));    put(a.hauton, getHA(r));
    put(a.creditos,getCred(r)); put(a.campo, getCampo(r));  put(a.ciclo, getCiclo(r));
    put(a.norden, getOrden(r)); put(a.estudiantes, estRaw);
  }
  return agg;
}
function sumEstudiantes(mp){ let s=0; mp.forEach(v=>{const n=Number(v); if(!Number.isNaN(n)) s+=n;}); return s; }
function firstNonEmptyFrom(mp){ for(const v of mp.values()){ if(String(v).trim()!=='') return String(v); } return ''; }
function perCarFill(mp,carreras){ const def=firstNonEmptyFrom(mp); return carreras.map(c=>({car:c,val:(mp.get(c)??def)||''})); }

function parseDiasDisponibles(txt){
  if(!txt) return DIAS.includes('MIÉRCOLES')?['LUNES','MARTES','MIÉRCOLES','JUEVES','VIERNES']:['LUNES','MARTES','MIERCOLES','JUEVES','VIERNES'];
  const canon=s=>rmDiac(upper(s));
  let t=canon(txt).replace(/,/g,' Y ').replace(/\s+/g,' ').trim();
  const D=DIAS.map(canon),find=s=>{const i=D.indexOf(s);return i>=0?DIAS[i]:null;};
  if(t.includes(' A ')){const [a,b]=t.split(' A ').map(s=>s.trim());const A=find(a),B=find(b);if(A&&B){const ia=DIAS.indexOf(A),ib=DIAS.indexOf(B);if(ib>=ia) return DIAS.slice(ia,ib+1);}}
  if(t.includes(' Y ')){return t.split(' Y ').map(s=>find(s.trim())).filter(Boolean);}
  const u=find(t);return u?[u]:DIAS.slice();
}
function parseHoraDisponible(txt){
  if(!txt) return SLOTS.slice();
  let t=txt.toString().trim().toUpperCase().replace(/\s+/g,'').replace(/–/g,'-').replace('A','-');
  const toMin=hhmm=>{const m=/^(\d{1,2}):(\d{2})(?::\d{2})?$/.exec(hhmm);if(!m)return null;let h=parseInt(m[1],10),mi=parseInt(m[2],10);if(h<7)h+=12;return h*60+mi;};
  const parts=t.split('-').filter(Boolean);
  if(parts.length===2){const a=toMin(parts[0]),b=toMin(parts[1]);if(a!=null&&b!=null&&b>a){
    return SLOTS.filter(s=>{const [sa,sb]=s.replace('–','-').split('-');const sma=toMin(sa),smb=toMin(sb);return sma>=a&&smb<=b;});
  }}
  return SLOTS.slice();
}
function buildDocentesIndex(rows){
  const idx=new Map(); const all=[];
  for(const r of rows){
    const materia=norm(r['MATERIA']); if(!materia) continue;
    const k=canonMateria(materia);
    const item={MATERIA_ORIG:materia,CANON:k,TOKENS:tokens(materia),
      DOCENTE:norm(r['DOCENTE']),
      TITULO:norm(r['TITULO ACADÉMICO']||r['TÍTULO ACADÉMICO']),
      DEDIC:norm(r['DEDICACION']||r['DEDICACIÓN']),
      MODALIDAD:norm(r['Modalidad']||r['MODALIDAD']),
      DIAS:parseDiasDisponibles(r['DIA DISPONIBLE']||r['DÍA DISPONIBLE']||r['DIA']),
      SLOTS:parseHoraDisponible(r['HORA DISPONIBLE']||r['HORA'])
    };
    if(!idx.has(k)) idx.set(k,[]); idx.get(k).push(item); all.push(item);
  }
  return {byCanon:idx,all};
}

/* ===== Restricciones (estrictas)
   - DOCENTE vacío => restricción GLOBAL (aplica a todos)
   - DIA sin HORA => bloquea el día completo
   - HORA sin DIA => bloquea esa franja todos los días
   - DIA + HORA   => bloquea esa combinación exacta
*/
function buildRestriccionesIndex(rows){
  const byDoc=new Map();
  const global={dias:new Set(),slots:new Set(),pairs:new Set()};
  for(const r of rows){
    const d = norm(r['DOCENTE']||r['Profesor']||r['Nombre']||'');
    const dia = upper(r['DIA']||r['DÍA']||'');
    const hora= upper(r['HORA']||r['HORARIO']||'');
    const target = d ? (byDoc.get(d) || byDoc.set(d,{dias:new Set(),slots:new Set(),pairs:new Set()}).get(d))
                     : global;
    if(dia && !hora) target.dias.add(dia);
    else if(!dia && hora) target.slots.add(hora);
    else if(dia && hora) target.pairs.add(`${dia}|${hora}`);
  }
  return {byDoc,global};
}

/* ===== Matching ===== */
function matchDocentesForMateria(canonKey, tokenSet, docentesIdx){
  if(docentesIdx.byCanon.has(canonKey)) return docentesIdx.byCanon.get(canonKey);
  let best=[],score=0; for(const it of docentesIdx.all){const s=jaccard(tokenSet,it.TOKENS); if(s>score){score=s; best=[it];} else if(s===score && s>0){best.push(it);} }
  return score>=0.60 ? best : [];
}
function dedupeByDocente(candidates, targetTokens){
  const keyDoc = n => rmDiac(upper(n));
  const bestByDoc = new Map();
  for(const it of candidates){
    const score = jaccard(targetTokens, it.TOKENS);
    const k = keyDoc(it.DOCENTE);
    if(!bestByDoc.has(k) || score > bestByDoc.get(k).score){
      bestByDoc.set(k, {item: it, score});
    }
  }
  return Array.from(bestByDoc.values()).map(x=>x.item);
}

/* ===== Ensamble + paralelos (>28) ===== */
function assembleRows(aggMalla, idxDoc){
  const filas=[];
  for(const [k,info] of aggMalla.entries()){
    const totalEst = sumEstudiantes(info.estudiantes);
    let cand = matchDocentesForMateria(k, tokens(info.materiaOrig), idxDoc);
    cand = dedupeByDocente(cand, tokens(info.materiaOrig));
    const requeridos = (totalEst>28) ? 2 : 1;
    if(cand.length===0){
      cand = Array.from({length:requeridos},()=>({DOCENTE:'',TITULO:'',DEDIC:'',MODALIDAD:'',DIAS:DIAS.slice(),SLOTS:SLOTS.slice()}));
    } else {
      if(cand.length>requeridos) cand = cand.slice(0,requeridos);
      while(cand.length<requeridos) cand.push(cand[0]);
    }
    const carreras=[...info.carreras].sort((a,b)=>a.localeCompare(b,'es'));
    const base={
      KEY:info.key,MATERIA:info.materiaOrig,
      _per:{
        carreras: carreras.map(c=>({car:c,val:abrevCarrera(c)})),
        malla:    carreras.map(c=>({car:c,val:info.mallaByCar.get(c)??''})),
        prereq:   perCarFill(info.prereqs, carreras),
        codigo:   perCarFill(info.codigos, carreras),
        anth:     perCarFill(info.anth, carreras),
        ht:       perCarFill(info.hteor, carreras),
        hp:       perCarFill(info.hprac, carreras),
        ha:       perCarFill(info.hauton, carreras),
        cred:     perCarFill(info.creditos, carreras),
        campo:    perCarFill(info.campo, carreras),
        ciclo:    perCarFill(info.ciclo, carreras),
        orden:    perCarFill(info.norden, carreras)
      },
      ESTUDIANTES:String(totalEst),
      _carreras:carreras,_ciclos:carreras.map(c=>info.ciclo.get(c)??'')
    };
    cand.forEach((d,j)=>{
      filas.push({
        DOCENTE:d.DOCENTE||'',TITULO_ACADEMICO:d.TITULO||'',DEDICACION:d.DEDIC||'',
        MATERIA:base.MATERIA,CODIGO_ANTHOLOGY: base._per.anth.map(p=>p.val).filter(Boolean).join(' / '),
        CARRERAS_COMPARTEN:'',MALLA:'',PRE_REQUISITO:'',CODIGO:'',HORAS_TEORICAS:'',HORAS_PRACTICAS:'',HORAS_AUTONOMAS:'',CREDITOS:'',
        CAMPO_DE_FORMACION:'',CICLO_MALLA:'',N_ORDEN_MALLA:'',
        ESTUDIANTES:base.ESTUDIANTES,PARALELO:ABC[j]??`P${j+1}`,DIA:'',HORA:'',MODALIDAD:d.MODALIDAD||'',NRO_HORAS:'',
        _dias:d.DIAS,_slots:d.SLOTS,_carreras:base._carreras,_ciclos:base._ciclos,_key:base.KEY,
        _chipsCarreras: base._per.carreras,_chipsMalla:base._per.malla,_chipsPrereq:base._per.prereq,_chipsCodigo:base._per.codigo,
        _chipsHT:base._per.ht,_chipsHP:base._per.hp,_chipsHA:base._per.ha,_chipsCred:base._per.cred,_chipsCampo:base._per.campo,
        _chipsCiclo:base._per.ciclo,_chipsOrden:base._per.orden
      });
    });
  }
  return {filas};
}

/* ===== Asignación
   - Respeta de forma ESTRICTA Restricciones.xlsx (globales y por docente)
   - Máx 2 asignaturas por día por docente y sin repetir franja el mismo día
   - Paralelos de una misma materia no comparten día+franja
   - *** Regla solicitada: ciclos CONTIGUOS (1-2, 2-3, ..., 7-8) no pueden compartir el MISMO HORARIO (día+franja) en una misma carrera ***
*/
function assignSchedules100(filas, restIdx){
  const {byDoc,global} = restIdx;

  const occDoc=new Map();           // por docente -> { [dia]: {count, slots:Set} }
  const occParallel=new Set();      // clave materia|dia|slot
  const occCarSlot=new Map();       // clave carrera|dia|slot -> Set(ciclos) para prohibir adyacencias

  const keyPar   = (row,dia,slot)=>`${row._key}|${dia}|${slot}`;
  const keyCarSl = (car,dia,slot)=>`${car}|${dia}|${slot}`;

  function canPlace(row,dia,slot,{maxPerDay=2}){
    const d=row.DOCENTE||`__SIN_DOCENTE__${row.MATERIA}`;
    if(!occDoc.has(d)) occDoc.set(d,{});
    const rec=occDoc.get(d)[dia]??{count:0,slots:new Set()};
    if(rec.count>=maxPerDay) return false;
    if(rec.slots.has(slot))  return false;

    if(occParallel.has(keyPar(row,dia,slot))) return false;

    // Adyacencias por HORARIO exacto (día+slot) dentro de cada carrera
    for(let i=0;i<row._carreras.length;i++){
      const car=row._carreras[i], idx=cicloIdx(row._ciclos[i]);
      const k=keyCarSl(car,dia,slot);
      const set=occCarSlot.get(k);
      if(set){ for(const u of set){ if(Math.abs(u-idx)===1) return false; } }
    }
    return true;
  }

  function apply(row,dia,slot){
    const d=row.DOCENTE||`__SIN_DOCENTE__${row.MATERIA}`;
    const rec=occDoc.get(d)[dia]??{count:0,slots:new Set()};
    rec.count++; rec.slots.add(slot); occDoc.get(d)[dia]=rec;

    for(let i=0;i<row._carreras.length;i++){
      const car=row._carreras[i], idx=cicloIdx(row._ciclos[i]);
      const k=keyCarSl(car,dia,slot);
      if(!occCarSlot.has(k)) occCarSlot.set(k,new Set());
      occCarSlot.get(k).add(idx);
    }
    occParallel.add(keyPar(row,dia,slot));
    row.DIA=dia; row.HORA=slot;
  }

  // orden por ciclo mínimo (ayuda a espaciar)
  filas.sort((a,b)=>Math.min(...a._ciclos.map(c=>cicloIdx(c)))-Math.min(...b._ciclos.map(c=>cicloIdx(c))));
  const conteo={asignadas:0,sin_horario:0};

  for(const r of filas){
    const rd = byDoc.get(r.DOCENTE||'') || {dias:new Set(),slots:new Set(),pairs:new Set()};

    // candidatos de días y franjas respetando SIEMPRE restricciones globales y por docente
    const dias = DIAS.filter(d=>!global.dias.has(d) && !rd.dias.has(d))
                     .filter(d=>!r._dias.length || r._dias.includes(d)); // disponibilidad del docente si la hay
    const slots = SLOTS.filter(s=>!global.slots.has(upper(s)) && !rd.slots.has(upper(s)))
                       .filter(s=>!r._slots.length || r._slots.includes(s));

    let placed=false;
    for(const d of dias){
      for(const s of slots){
        const pair=`${d}|${upper(s)}`;
        if(global.pairs.has(pair) || rd.pairs.has(pair)) continue; // estrictas
        if(canPlace(r,d,s,{maxPerDay:2})){ apply(r,d,s); conteo.asignadas++; placed=true; break; }
      }
      if(placed) break;
    }
    if(!placed){ conteo.sin_horario++; } // no se fuerza
  }
  return {filas,conteo};
}

/* ===== Ordenación por encabezado ===== */
(function enableSortableMatrix(){
  const table=document.getElementById('matriz'); if(!table) return;
  const collator=new Intl.Collator('es',{sensitivity:'base',numeric:true});
  const thead=table.tHead, tbody=table.tBodies[0];
  const ths=Array.from(thead.rows[0].cells);
  const arrows=Array.from(table.querySelectorAll('thead th .arrow'));
  ths.forEach((th, colIndex)=>{
    let asc=true;
    th.addEventListener('click',()=>{
      const rows=Array.from(tbody.rows);
      rows.sort((ra,rb)=>{
        const a=(ra.cells[colIndex]?.textContent||'').trim();
        const b=(rb.cells[colIndex]?.textContent||'').trim();
        const res=collator.compare(a,b);
        return asc?res:-res;
      });
      const frag=document.createDocumentFragment(); rows.forEach(r=>frag.appendChild(r));
      tbody.innerHTML=''; tbody.appendChild(frag);
      arrows.forEach(s=>s.textContent='↕'); th.querySelector('.arrow').textContent=asc?'↑':'↓'; asc=!asc;
    });
  });
})();

/* ===== Flujo principal ===== */
document.getElementById('btnProcesar').addEventListener('click', async ()=>{
  const fM=document.getElementById('fileMalla').files[0];
  const fD=document.getElementById('fileDocentes').files[0];
  const fR=document.getElementById('fileRest').files[0];
  if(!fM||!fD||!fR){alert('Cargue los tres archivos: Malla, Docentes y Restricciones.');return;}

  clearTable(); carreraColor.clear();
  document.getElementById('resumen').style.display='none';

  const wbM=await readWB(fM), wbD=await readWB(fD), wbR=await readWB(fR);
  const malla=sheetToJSONAuto(wbM, ['malla','plan']);
  const docentes=sheetToJSONAuto(wbD, ['docente']);
  const rest=sheetToJSONAuto(wbR, ['restric','dispon','bloqueo']);
  if(!malla.length||!docentes.length){alert('No se pudo leer Malla o Docentes.');return;}

  const aggMalla=buildMallaAggregate(malla);
  const idxDoc=buildDocentesIndex(docentes);
  const idxRest=buildRestriccionesIndex(rest);

  const {filas}=assembleRows(aggMalla, idxDoc);
  const {filas:asignadas,conteo}=assignSchedules100(filas, idxRest);

  asignadas.forEach(addRow);

  const badge=document.getElementById('resumen');
  const total=asignadas.length;
  badge.textContent=`TOTAL: ${total} | Sin horario (por restricciones/conflictos): ${conteo.sin_horario}`;
  badge.style.display='inline-block';

  document.getElementById('btnXLSX').disabled=false;
  document.getElementById('btnCSV').disabled=false;
});

/* Exportar y limpiar */
function tableToSheet(){
  const headers=[...document.querySelectorAll('#matriz thead th')].map(th=>th.childNodes[0].textContent.trim());
  const rows=[...document.querySelectorAll('#matriz tbody tr')].map(tr=>[...tr.children].map(td=>td.textContent));
  return XLSX.utils.aoa_to_sheet([headers,...rows]);
}
document.getElementById('btnXLSX').addEventListener('click',()=>{
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, tableToSheet(), 'Matriz');
  XLSX.writeFile(wb,'Planificacion_UIDE.xlsx');
});
document.getElementById('btnCSV').addEventListener('click',()=>{
  const csv=XLSX.utils.sheet_to_csv(tableToSheet());
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='Planificacion_UIDE.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
});
document.getElementById('btnLimpiar').addEventListener('click',()=>{
  document.getElementById('fileMalla').value=''; document.getElementById('fileDocentes').value=''; document.getElementById('fileRest').value='';
  clearTable(); carreraColor.clear();
  document.getElementById('btnXLSX').disabled=true; document.getElementById('btnCSV').disabled=true;
  document.getElementById('resumen').style.display='none';
});
</script>
</body>
</html>
