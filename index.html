<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planificador Académico (HTML único)</title>

<!-- Librería para leer Excel en el navegador (sin servidor) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  /* Tema claro y accesible */
  --bg:#f8fafc;           /* slate-50 */
  --panel:#ffffff;        /* white */
  --muted:#64748b;        /* slate-500 */
  --card:#ffffff;
  --accent:#ea580c;       /* orange-600 */
  --accent-2:#2563eb;     /* blue-600 */
  --ok:#16a34a;           /* green-600 */
  --danger:#dc2626;       /* red-600 */
  --text:#0f172a;         /* slate-900 */
  --text-dim:#334155;     /* slate-700 */
  --chip:#e2e8f0;         /* slate-200 */
  --shadow:0 10px 30px rgba(2,6,23,.08);
  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Ubuntu", "Cantarell", "Helvetica Neue", sans-serif;
  background:var(--bg);
  color:var(--text);
}
header{
  padding:26px 20px 10px;
  display:flex; flex-wrap:wrap; align-items:center; gap:14px; justify-content:space-between;
}
h1{margin:0; font-size:20px; letter-spacing:.3px; font-weight:800}
.badge{padding:4px 10px; border-radius:999px; background:var(--chip); color:var(--text-dim); font-size:12px}
.container{padding:16px; max-width:1300px; margin:0 auto}
.card{
  background:var(--card);
  border:1px solid rgba(2,6,23,.08);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}
.row{display:grid; grid-template-columns:1.2fr .8fr; gap:16px}
.section{padding:16px}
.section h2{margin:0 0 12px 0; font-size:16px}
hr.sep{border:none; border-top:1px dashed rgba(2,6,23,.15); margin:12px 0}

.uploads{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px}
.upl{padding:12px; background:#f1f5f9; border:1px dashed rgba(2,6,23,.25); border-radius:12px}
.upl label{display:block; font-size:12px; color:var(--text-dim); margin-bottom:6px}
.upl input[type=file]{width:100%; color:var(--text-dim)}

.controls{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
button{
  background:var(--accent-2); border:none; color:white; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer;
}
button.secondary{ background:#ffffff; border:1px solid rgba(2,6,23,.15); color:var(--text) }
button.warn{ background:var(--danger) }
button.ok{ background:var(--ok) }
button:disabled{opacity:.55; cursor:not-allowed}
.small{font-size:12px; color:var(--text-dim)}

.tabs{display:flex; gap:8px; margin:10px 0}
.tab{padding:8px 12px; border-radius:999px; background:#e5e7eb; color:#111827; cursor:pointer; border:1px solid transparent; font-weight:600}
.tab.active{background:#ffffff; color:var(--text); border-color:rgba(2,6,23,.2)}

.grid{
  display:grid; grid-template-columns: 140px repeat(5, 1fr);
  border:1px solid rgba(2,6,23,.15); border-radius:12px; overflow:hidden;
}
.grid .cell{
  border-bottom:1px solid rgba(2,6,23,.08);
  border-right:1px dashed rgba(2,6,23,.08);
  padding:8px; min-height:64px; font-size:12px; background:#fff;
}
.grid .header{background:#eef2ff; font-weight:800}
.grid .slot{background:#f8fafc; font-weight:700}
.tag{
  display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#eff6ff; color:#1d4ed8; margin:2px 2px 0 0; border:1px solid #bfdbfe
}
.tag small{opacity:.8}
.legend{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
.legend .chip{background:#f1f5f9; padding:6px 10px; border-radius:999px; border:1px solid rgba(2,6,23,.1); font-size:12px}
.kpi{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
.kpi .box{background:#f8fafc; border:1px solid rgba(2,6,23,.12); border-radius:10px; padding:10px 12px; font-size:12px}

.table{width:100%; border-collapse: collapse; margin-top:6px; background:#fff}
.table th,.table td{border-bottom:1px solid rgba(2,6,23,.12); padding:8px; text-align:left; font-size:13px}
.table tr:hover{background:#f8fafc}

aside .pills{display:flex; flex-wrap:wrap; gap:6px}
.pill{background:#f1f5f9; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(2,6,23,.1)}
fieldset{border:1px solid rgba(2,6,23,.15); padding:10px; border-radius:10px; background:#fff}
legend{font-size:12px; color:var(--text-dim); padding:0 6px; font-weight:700}

.bad{color:#b91c1c}
.good{color:#065f46}
.warnText{color:#92400e}

footer{padding:16px; text-align:center; color:var(--text-dim); font-size:12px}

.modal{
  position:fixed; inset:0; background:rgba(2,6,23,.35); display:none; align-items:center; justify-content:center; z-index:40;
}
.modal .dialog{
  width:min(680px, 92vw); background:#ffffff; border:1px solid rgba(2,6,23,.2); border-radius:16px; padding:16px; box-shadow:var(--shadow); color:var(--text)
}
.modal .dialog h3{margin:0 0 8px 0; font-size:16px}
.modal .dialog .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.checkbox { display:flex; align-items:center; gap:8px; margin:6px 0; }
.select{width:100%; background:#ffffff; color:var(--text); border:1px solid rgba(2,6,23,.2); padding:8px; border-radius:8px}
.input{width:100%; background:#ffffff; color:var(--text); border:1px solid rgba(2,6,23,.2); padding:8px; border-radius:8px}
.hr{height:1px; background:rgba(2,6,23,.12); margin:10px 0}
.note{font-size:12px; color:var(--text-dim)}
.mini{font-size:11px; opacity:.85}
</style>
</head>
<body>
<header class="container">
  <div style="display:flex; align-items:center; gap:10px">
    <h1>Planificador Académico</h1>
    <span class="badge">HTML único • Sin servidor</span>
  </div>
  <div class="legend">
    <span class="chip">Días: L–V</span>
    <span class="chip">Franjas: 7–10 · 10–13 · 13–16 · 16–19 · 19–22</span>
    <span class="chip">Máx. 2 materias/día (docente y estudiante)</span>
    <span class="chip">Máx. 6 materias/estudiante</span>
    <span class="chip">Ciclos adyacentes sin choque</span>
  </div>
</header>

<div class="container row">
  <!-- IZQUIERDA: CARGA + VISTAS -->
  <section class="card section">
    <h2>Entradas (Excel) y ejecución</h2>
    <div class="uploads">
      <div class="upl">
        <label for="fileMalla">Malla (obligatorio)</label>
        <input id="fileMalla" type="file" accept=".xlsx,.xls" />
        <div class="small">Mínimas: <b>CARRERA</b>, <b>CICLO</b>, <b>MATERIA</b>. Opcionales: <i>PARALELOS</i>, <i>COMPARTIDA CON</i>.</div>
      </div>
      <div class="upl">
        <label for="fileDocentes">Docentes (obligatorio)</label>
        <input id="fileDocentes" type="file" accept=".xlsx,.xls" />
        <div class="small">Mínimas: <b>DOCENTE</b>, <b>CARRERA</b>, <b>MATERIA</b>. Opcional: <i>PARALELO</i>.</div>
      </div>
      <div class="upl">
        <label for="fileEstudiantes">Estudiantes (obligatorio)</label>
        <input id="fileEstudiantes" type="file" accept=".xlsx,.xls" />
        <div class="small">Mínimas: <b>ESTUDIANTE</b>, <b>CARRERA</b>, <b>CICLO</b>. Opcionales: <i>NIVEL INGLES</i>, <i>PRACTICAS</i>.</div>
      </div>
    </div>

    <div class="controls">
      <button id="btnAnalizar">Validar & Leer 100 %</button>
      <button id="btnConfig" class="secondary" disabled>Configurar bloqueos</button>
      <button id="btnAsignar" class="ok" disabled>Generar planificación</button>
      <button id="btnLimpiar" class="secondary">Reiniciar</button>
      <span id="status" class="small"></span>
    </div>

    <hr class="sep"/>

    <div class="tabs">
      <div class="tab active" data-tab="estudiantes">Planificación de estudiantes</div>
      <div class="tab" data-tab="docentes">Planificación docente</div>
    </div>

    <!-- VISTA ESTUDIANTES -->
    <div id="view-estudiantes">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:6px 0 12px">
        <select id="selEstudiante" class="select" disabled>
          <option value="">— Seleccione estudiante —</option>
        </select>
        <button id="btnEditar" class="secondary" disabled>Editar asignación (estudiante)</button>
        <span class="small">Edición válida únicamente a nivel de estudiante. Los choques o violaciones se bloquean con aviso.</span>
      </div>

      <div id="kpiEst" class="kpi" style="display:none">
        <div class="box">Total materias: <b id="kTotal">0</b>/6</div>
        <div class="box">Choques detectados: <b id="kChoques">0</b></div>
        <div class="box">Bloqueos activos: <b id="kBlocks">0</b></div>
      </div>

      <div class="grid" id="gridEstudiante" style="margin-top:10px"></div>

      <table class="table" id="tablaEst" style="display:none">
        <thead>
          <tr>
            <th>Materia</th><th>Paralelo</th><th>Día</th><th>Franja</th><th>Docente</th><th>Carrera</th><th>Ciclo</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- VISTA DOCENTES -->
    <div id="view-docentes" style="display:none">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:6px 0 12px">
        <select id="selDocente" class="select" disabled>
          <option value="">— Seleccione docente —</option>
        </select>
      </div>
      <div class="grid" id="gridDocente"></div>
      <table class="table" id="tablaDoc" style="display:none">
        <thead>
          <tr>
            <th>Día</th><th>Franja</th><th>Materia</th><th>Paralelo</th><th>Carrera</th><th>Ciclo</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- DERECHA: REGLAS y BLOQUEOS -->
  <aside class="card section">
    <h2>Reglas y estado</h2>

    <fieldset>
      <legend>Calendario</legend>
      <div class="pills">
        <span class="pill">Lunes–Viernes</span>
        <span class="pill">7–10</span>
        <span class="pill">10–13</span>
        <span class="pill">13–16</span>
        <span class="pill">16–19</span>
        <span class="pill">19–22</span>
      </div>
      <div class="pills" style="margin-top:8px">
        <span class="pill">Máx. 2 materias por día (docente y estudiante)</span>
        <span class="pill">Máx. 6 materias por estudiante</span>
        <span class="pill">Ciclos adyacentes sin choque en misma carrera</span>
        <span class="pill">Asignación solo por carrera de estudiante</span>
        <span class="pill">Coincidencias entre carreras permitidas</span>
      </div>
    </fieldset>

    <div style="height:10px"></div>

    <fieldset>
      <legend>Restricciones</legend>
      <div class="small">Prioridad de asignación: malla del estudiante → nivel de inglés → bloqueos de prácticas.</div>
      <div class="hr"></div>
      <div class="checkbox"><input type="checkbox" id="chkIngles" disabled/> <label for="chkIngles">Aplicar bloqueos de Inglés si no hay datos en Excel</label></div>
      <div class="checkbox"><input type="checkbox" id="chkPracticas" disabled/> <label for="chkPracticas">Aplicar bloqueos de “Prácticas comunitarias” si no hay datos en Excel</label></div>
      <div class="note mini">Use “Configurar bloqueos” para definir franjas por semestre.</div>
    </fieldset>

    <div style="height:10px"></div>

    <fieldset>
      <legend>Mensajes</legend>
      <div id="log" class="small" style="max-height:260px; overflow:auto; white-space:pre-wrap"></div>
    </fieldset>
  </aside>
</div>

<footer>
  Cumplimiento estricto de reglas; edición exclusivamente por estudiante con bloqueo de choques. ©
</footer>

<!-- MODAL: CONFIGURAR BLOQUEOS -->
<div id="modalCfg" class="modal">
  <div class="dialog">
    <h3>Configuración de bloqueos</h3>
    <div class="note">Defina bloqueos por semestre (ciclo del estudiante) para evitar choques con “Prácticas comunitarias” u otros compromisos. También puede definir un bloqueo general de Inglés.</div>
    <div class="hr"></div>
    <div class="row2">
      <div>
        <h4 style="margin:0 0 6px">Bloqueos por semestre</h4>
        <div style="display:flex; gap:6px; align-items:center; margin-bottom:8px">
          <input id="inCicloBloq" class="input" type="number" min="1" placeholder="Ciclo (ej. 2)" />
          <select id="inDiaBloq" class="select">
            <option value="">Día</option>
          </select>
          <select id="inSlotBloq" class="select">
            <option value="">Franja</option>
          </select>
          <button id="btnAddBloq" class="secondary">Agregar</button>
        </div>
        <div id="listBloq" class="small"></div>
      </div>
      <div>
        <h4 style="margin:0 0 6px">Bloqueo general de Inglés</h4>
        <div class="checkbox"><input type="checkbox" id="inInglesAct" /> <label for="inInglesAct">Activar bloqueo general</label></div>
        <div style="display:flex; gap:6px; align-items:center; margin:6px 0">
          <select id="inDiaIng" class="select"><option value="">Día</option></select>
          <select id="inSlotIng" class="select"><option value="">Franja</option></select>
          <button id="btnAddIng" class="secondary">Agregar</button>
        </div>
        <div id="listIng" class="small"></div>
      </div>
    </div>
    <div class="hr"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end">
      <button id="btnCloseCfg" class="secondary">Cerrar</button>
      <button id="btnSaveCfg" class="ok">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: EDICIÓN ESTUDIANTE -->
<div id="modalEdit" class="modal">
  <div class="dialog">
    <h3>Edición de asignación (por estudiante)</h3>
    <div id="editInfo" class="note"></div>
    <div class="hr"></div>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <select id="editMateria" class="select"></select>
      <select id="editDestino" class="select"></select>
      <button id="btnAplicarEdicion" class="ok">Aplicar cambio</button>
      <button id="btnCerrarEdicion" class="secondary">Cerrar</button>
    </div>
    <div class="hr"></div>
    <div id="editMsg" class="small"></div>
  </div>
</div>

<script>
/* ==========================
   Utilidades y constantes
========================== */
const DAYS = ["Lunes","Martes","Miércoles","Jueves","Viernes"];
const SLOTS = ["7-10","10-13","13-16","16-19","19-22"];

const state = {
  raw:{ malla:null, docentes:null, estudiantes:null }, // lectura completa
  data:{ malla:[], docentes:[], estudiantes:[] },      // normalizados mínimos
  loaded:false,
  config:{
    bloqueosPorSemestre:[], // { ciclo: number, dia: string, slot: string }
    ingles:{ activo:false, items:[] } // [{dia, slot}]
  },
  sections:[],   // secciones planificadas
  assign:{ byStudent: new Map() },
  index:{ docentes:[], estudiantes:[] },
  ui:{ currentStudent:null, currentDocente:null }
};

const $ = sel => document.querySelector(sel);
const $c = (tag, cls) => { const el = document.createElement(tag); if(cls) el.className = cls; return el; };
function log(msg, type="info"){
  const el=$("#log"); if(!el) return;
  const stamp = new Date().toLocaleTimeString();
  const color = type==="error" ? "bad" : type==="warn" ? "warnText" : "good";
  el.innerHTML = `[${stamp}] <span class="${color}">${msg}</span>\n` + el.innerHTML;
}
function toKey(s){ return String(s??"").trim(); }
function norm(s){
  return toKey(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'')
           .toUpperCase().replace(/[^A-Z0-9]+/g,' ').replace(/\s+/g,' ').trim();
}
function upperKeys(row){
  const o={}; Object.keys(row).forEach(k=> o[norm(k)] = row[k]); return o;
}

/* ==========================
   Sinónimos de encabezados
========================== */
const SYN = {
  malla: {
    "CARRERA": ["CARRERA","PROGRAMA","CARRERAS"],
    "CICLO": ["CICLO","SEMESTRE","NIVEL","CICLO DE LA MATERIA","CICLO_MATERIA"],
    "MATERIA": ["MATERIA","ASIGNATURA","CURSO","NOMBRE MATERIA","NOMBRE ASIGNATURA"],
    "PARALELOS": ["PARALELOS","PARALELO","SECCIONES","GRUPOS"],
    "COMPARTIDA CON": ["COMPARTIDA CON","COMPARTIDACON","COMPARTIDA","COMPARTIDA CON CARRERAS","COMPARTIDA ENTRE CARRERAS"]
  },
  docentes: {
    "DOCENTE": ["DOCENTE","DOCENTES","PROFESOR","PROFESORA","NOMBRE DOCENTE","NOMBRE DEL DOCENTE","NOMBRE"],
    "CARRERA": ["CARRERA","PROGRAMA"],
    "MATERIA": ["MATERIA","ASIGNATURA","CURSO"],
    "PARALELO": ["PARALELO","SECCION","SECCIÓN","GRUPO"]
  },
  estudiantes: {
    "ESTUDIANTE": ["ESTUDIANTE","ALUMNO","ALUMNA","NOMBRE","NOMBRE ESTUDIANTE","APELLIDOS Y NOMBRES","NOMBRES Y APELLIDOS"],
    "CARRERA": ["CARRERA","PROGRAMA"],
    "CICLO": ["CICLO","SEMESTRE","NIVEL","CICLO DEL ESTUDIANTE"],
    "NIVEL INGLES": ["NIVEL INGLES","NIVEL DE INGLES","INGLES","CURSO DE INGLES","ENGLISH LEVEL","INGLES NIVEL"],
    "PRACTICAS": ["PRACTICAS","PRACTICAS COMUNITARIAS","PRACTICA COMUNITARIA","PRACTICAS COM","PRACTICAS COMUNIT","PRACTICAS- COMUNITARIAS","PRÁCTICAS","PRÁCTICAS COMUNITARIAS"]
  }
};

/* ==================================================
   Lectura robusta: detecta fila de encabezados y mapea
   Recorre TODAS las hojas y concatena resultados
================================================== */
function readExcel(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload = e=>{
      try{
        const wb=XLSX.read(new Uint8Array(e.target.result), {type:"array"});
        resolve(wb);
      }catch(err){ reject(err); }
    };
    fr.onerror = reject;
    fr.readAsArrayBuffer(file);
  });
}

function parseWorkbookAll(wb, kind){
  const syn = SYN[kind];
  const out = [];
  const mapReports = []; // para log

  for(const name of wb.SheetNames){
    const ws = wb.Sheets[name];
    if(!ws) continue;

    // 1) como matriz para encontrar encabezados
    const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
    if(!rows || !rows.length) continue;

    // 2) buscar fila de encabezados: que contenga >=2 coincidencias de sinónimos requeridos (>=3 para Malla)
    const reqCount = kind==="malla" ? 3 : 2;
    let hdrIdx = -1;
    let chosenMap = null;

    for(let i=0;i<Math.min(rows.length, 30);i++){
      const r = rows[i].map(norm);
      const mapIdxToCanon = {};
      let hits = 0;

      r.forEach((cell,ci)=>{
        for(const canon in syn){
          if(syn[canon].some(label => label===cell)){
            if(!Object.values(mapIdxToCanon).includes(canon)){ // evitar duplicados
              mapIdxToCanon[ci]=canon; hits++;
            }
          }
        }
      });

      if(hits>=reqCount){
        hdrIdx=i; chosenMap=mapIdxToCanon; break;
      }
    }

    if(hdrIdx===-1){
      // fallback: usar primera fila como encabezados normalizados
      const heads = (rows[0]||[]).map(norm);
      const tmpMap={};
      heads.forEach((h,ci)=>{
        for(const canon in syn){
          if(syn[canon].some(label => label===h)) tmpMap[ci]=canon;
        }
      });
      if(Object.keys(tmpMap).length===0){
        log(`Hoja “${name}”: no se identificaron encabezados para ${kind}.`, "warn");
        continue;
      }
      hdrIdx=0; chosenMap=tmpMap;
    }

    // 3) construir objetos desde hdrIdx+1
    const headerLine = rows[hdrIdx].map(norm);
    const usedCanon = new Set(Object.values(chosenMap));
    const mappedNames = [];
    Object.entries(chosenMap).forEach(([ci,canon])=>{
      mappedNames.push(`${headerLine[ci]||"(vacío)"} → ${canon}`);
    });
    mapReports.push(`• ${name}: ${mappedNames.join(", ")}`);

    for(let r=hdrIdx+1; r<rows.length; r++){
      const row = rows[r];
      if(!row || row.every(v => String(v).trim()==="")) continue;
      const obj = {};
      Object.entries(chosenMap).forEach(([ci,canon])=>{
        obj[canon] = row[Number(ci)];
      });
      out.push(obj);
    }
  }

  if(mapReports.length){
    log(`Columnas detectadas en ${kind}:\n${mapReports.join("\n")}`,"info");
  }
  return out;
}

/* Validación “requeridos” sobre objetos ya canónicos */
function ensureCanonical(rows, req){
  if(!rows || !rows.length) return false;
  return req.every(k => Object.prototype.hasOwnProperty.call(rows[0], k));
}

/* ==========================
   Configuración de bloqueos
========================== */
function fillDaySlotSelects(){
  const d1=$("#inDiaBloq"), s1=$("#inSlotBloq");
  const d2=$("#inDiaIng"), s2=$("#inSlotIng");
  [d1,d2].forEach(s=>{
    s.innerHTML='<option value="">Día</option>' + DAYS.map(d=>`<option>${d}</option>`).join("");
  });
  [s1,s2].forEach(s=>{
    s.innerHTML='<option value="">Franja</option>' + SLOTS.map(d=>`<option>${d}</option>`).join("");
  });
}

function openCfg(){ $("#modalCfg").style.display="flex"; renderBloqLists(); }
function closeCfg(){ $("#modalCfg").style.display="none"; }
function renderBloqLists(){
  const list=$("#listBloq");
  if(!state.config.bloqueosPorSemestre.length){
    list.innerHTML='<span class="mini">Sin bloqueos por semestre.</span>';
  }else{
    list.innerHTML = state.config.bloqueosPorSemestre
      .map((b,i)=>`• Semestre ${b.ciclo}: ${b.dia} ${b.slot} <button data-rm-b="${i}" class="secondary miniBtn" style="margin-left:6px; padding:2px 6px; font-size:11px">Quitar</button>`)
      .join("<br>");
  }
  const listIng=$("#listIng");
  if(!state.config.ingles.items.length){
    listIng.innerHTML='<span class="mini">Sin bloqueos definidos.</span>';
  }else{
    listIng.innerHTML = state.config.ingles.items
      .map((b,i)=>`• ${b.dia} ${b.slot} <button data-rm-i="${i}" class="secondary miniBtn" style="margin-left:6px; padding:2px 6px; font-size:11px">Quitar</button>`)
      .join("<br>");
  }
}
function saveCfg(){
  state.config.ingles.activo = $("#inInglesAct").checked;
  closeCfg();
  log("Bloqueos guardados.", "ok");
}
function addBloq(){
  const ciclo = Number($("#inCicloBloq").value||0);
  const dia = $("#inDiaBloq").value;
  const slot = $("#inSlotBloq").value;
  if(!ciclo || !dia || !slot){ log("Complete ciclo, día y franja para agregar bloqueo por semestre.", "warn"); return; }
  state.config.bloqueosPorSemestre.push({ciclo, dia, slot});
  $("#inCicloBloq").value=""; $("#inDiaBloq").value=""; $("#inSlotBloq").value="";
  renderBloqLists();
}
function addIng(){
  const dia=$("#inDiaIng").value;
  const slot=$("#inSlotIng").value;
  if(!dia || !slot){ log("Complete día y franja para agregar bloqueo de Inglés.", "warn"); return; }
  state.config.ingles.items.push({dia, slot});
  $("#inDiaIng").value=""; $("#inSlotIng").value="";
  renderBloqLists();
}
document.addEventListener("click", (ev)=>{
  if(ev.target && ev.target.dataset && ev.target.dataset.rmB!==undefined){
    const i = Number(ev.target.dataset.rmB);
    state.config.bloqueosPorSemestre.splice(i,1); renderBloqLists();
  }
  if(ev.target && ev.target.dataset && ev.target.dataset.rmI!==undefined){
    const i = Number(ev.target.dataset.rmI);
    state.config.ingles.items.splice(i,1); renderBloqLists();
  }
});

/* ==========================
   Lectura de archivos (100%)
========================== */
async function handleAnalizar(){
  $("#status").textContent="Leyendo archivos…";
  state.raw={ malla:null, docentes:null, estudiantes:null };
  state.data={ malla:[], docentes:[], estudiantes:[] };
  state.sections=[]; state.assign.byStudent.clear();
  state.ui.currentStudent=null; state.ui.currentDocente=null;

  const fM = $("#fileMalla").files[0];
  const fD = $("#fileDocentes").files[0];
  const fE = $("#fileEstudiantes").files[0];
  if(!fM || !fD || !fE){
    log("Faltan archivos obligatorios (Malla, Docentes, Estudiantes).", "error");
    $("#status").textContent="Faltan archivos.";
    return;
  }

  try{
    const [wbM, wbD, wbE] = await Promise.all([readExcel(fM), readExcel(fD), readExcel(fE)]);
    state.raw.malla=wbM; state.raw.docentes=wbD; state.raw.estudiantes=wbE;

    const rowsM = parseWorkbookAll(wbM, "malla");
    const rowsD = parseWorkbookAll(wbD, "docentes");
    const rowsE = parseWorkbookAll(wbE, "estudiantes");

    // Validación mínima de encabezados requeridos (canónicos)
    if(!ensureCanonical(rowsM, ["CARRERA","CICLO","MATERIA"])){
      log("Malla: no se encontraron columnas mínimas (CARRERA, CICLO, MATERIA).", "error");
      $("#status").textContent="Encabezados inválidos en Malla.";
      return;
    }
    if(!ensureCanonical(rowsD, ["DOCENTE","CARRERA","MATERIA"])){
      log("Docentes: no se encontraron columnas mínimas (DOCENTE, CARRERA, MATERIA).", "error");
      $("#status").textContent="Encabezados inválidos en Docentes.";
      return;
    }
    if(!ensureCanonical(rowsE, ["ESTUDIANTE","CARRERA","CICLO"])){
      log("Estudiantes: no se encontraron columnas mínimas (ESTUDIANTE, CARRERA, CICLO).", "error");
      $("#status").textContent="Encabezados inválidos en Estudiantes.";
      return;
    }

    // Normalización mínima (el resto de columnas quedan disponibles en state.raw)
    state.data.malla = rowsM.map((r,i)=>({
      id:`m_${i+1}`,
      carrera: toKey(r["CARRERA"]),
      ciclo: Number(r["CICLO"])||0,
      materia: toKey(r["MATERIA"]),
      paralelos: Number(r["PARALELOS"]||1),
      compartidaCon: toKey(r["COMPARTIDA CON"]||"")
    }));

    state.data.docentes = rowsD.map((r,i)=>({
      id:`d_${i+1}`,
      docente: toKey(r["DOCENTE"]),
      carrera: toKey(r["CARRERA"]),
      materia: toKey(r["MATERIA"]),
      paralelo: toKey(r["PARALELO"]||"")
    }));

    state.data.estudiantes = rowsE.map((r,i)=>({
      id:`e_${i+1}`,
      estudiante: toKey(r["ESTUDIANTE"]),
      carrera: toKey(r["CARRERA"]),
      ciclo: Number(r["CICLO"])||0,
      nivelIngles: toKey(r["NIVEL INGLES"]||""),
      practicas: toKey(r["PRACTICAS"]||"")
    }));

    // Habilitar controles
    $("#btnConfig").disabled=false;
    $("#btnAsignar").disabled=false;
    $("#chkIngles").disabled=false;
    $("#chkPracticas").disabled=false;
    $("#status").textContent="Archivos leídos (100 %). Listo para configurar bloqueos o asignar.";
    log("Lectura completa de los tres Excel (todas las hojas).", "ok");

    fillDaySlotSelects();
  }catch(err){
    console.error(err);
    log("Error leyendo archivos: " + err.message, "error");
    $("#status").textContent="Error al leer.";
  }
}

/* ==========================
   Planificación (generación)
========================== */
function docenteDailyCount(map, docente, dia){
  const key = `${docente}__${dia}`;
  return map.get(key)||0;
}
function incDocenteDaily(map, docente, dia){
  const key = `${docente}__${dia}`;
  map.set(key, (map.get(key)||0)+1);
}
function slotBusyForAdjacency(carrera, ciclo, dia, slot){
  const neighbor = state.sections.find(s =>
    s.carrera===carrera && Math.abs(s.ciclo - ciclo)===1 && s.dia===dia && s.slot===slot
  );
  return !!neighbor;
}
function findDocentesFor(carrera, materia){
  return state.data.docentes.filter(d => d.carrera===carrera && d.materia===materia);
}

function generarPlanificacion(){
  state.sections=[]; state.assign.byStudent.clear();

  const items = [...state.data.malla].sort((a,b)=>{
    if(a.carrera!==b.carrera) return a.carrera.localeCompare(b.carrera);
    return a.ciclo - b.ciclo;
  });

  const docenteDayMap = new Map();
  for(const item of items){
    const docentes = findDocentesFor(item.carrera, item.materia);
    const nPar = Math.max(1, Number(item.paralelos||1));
    for(let p=1; p<=nPar; p++){
      const docente = docentes.length ? docentes[(p-1)%docentes.length].docente : "Por asignar";
      let placed=false;
      for(const dia of DAYS){
        if(docente!=="Por asignar" && docenteDailyCount(docenteDayMap, docente, dia)>=2) continue;
        for(const slot of SLOTS){
          if(slotBusyForAdjacency(item.carrera, item.ciclo, dia, slot)) continue;
          const docBusy = state.sections.find(s => s.docente===docente && s.dia===dia && s.slot===slot);
          if(docente!=="Por asignar" && docBusy) continue;

          state.sections.push({ carrera:item.carrera, ciclo:item.ciclo, materia:item.materia, paralelo:p, dia, slot, docente });
          if(docente!=="Por asignar") incDocenteDaily(docenteDayMap, docente, dia);
          placed=true; break;
        }
        if(placed) break;
      }
      if(!placed){
        // Último recurso
        outer: for(const dia of DAYS){
          if(docente!=="Por asignar" && docenteDailyCount(docenteDayMap, docente, dia)>=2) continue;
          for(const slot of SLOTS){
            const docBusy = state.sections.find(s => s.docente===docente && s.dia===dia && s.slot===slot);
            if(docente!=="Por asignar" && docBusy) continue;
            state.sections.push({ carrera:item.carrera, ciclo:item.ciclo, materia:item.materia, paralelo:p, dia, slot, docente });
            if(docente!=="Por asignar") incDocenteDaily(docenteDayMap, docente, dia);
            break outer;
          }
        }
      }
    }
  }

  state.index.docentes = Array.from(new Set(state.sections.map(s=>s.docente))).filter(x=>x && x!=="Por asignar").sort();
  state.index.estudiantes = state.data.estudiantes.map(e => ({id:e.id, label:`${e.estudiante} — ${e.carrera} (C${e.ciclo})`}));

  // Asignación a estudiantes
  for(const est of state.data.estudiantes){
    const wanted = state.data.malla.filter(m => m.carrera===est.carrera && m.ciclo===est.ciclo);
    const plan=[];
    const dailyCount = new Map();

    const blocksSem = state.config.bloqueosPorSemestre.filter(b => Number(b.ciclo)===Number(est.ciclo));
    const hasInglesData = !!toKey(est.nivelIngles);
    const applyInglesGlobal = state.config.ingles.activo && !hasInglesData && $("#chkIngles").checked;
    const inglesBlocks = applyInglesGlobal ? state.config.ingles.items : [];

    const blocked = (dia,slot)=>{
      if($("#chkPracticas").checked){
        for(const b of blocksSem){ if(b.dia===dia && b.slot===slot) return true; }
      }
      if(applyInglesGlobal){
        for(const b of inglesBlocks){ if(b.dia===dia && b.slot===slot) return true; }
      }
      return false;
    };

    for(const wm of wanted){
      if(plan.length>=6) break;
      const secs = state.sections.filter(s => s.carrera===wm.carrera && s.ciclo===wm.ciclo && s.materia===wm.materia);
      for(const sec of secs){
        if(blocked(sec.dia, sec.slot)) continue;
        const cnt = dailyCount.get(sec.dia)||0;
        if(cnt>=2) continue;
        const has = plan.find(p => p.dia===sec.dia && p.slot===sec.slot);
        if(has) continue;
        plan.push({...sec});
        dailyCount.set(sec.dia, cnt+1);
        break;
      }
    }
    state.assign.byStudent.set(est.id, plan);
  }

  fillUIAfterPlan();
  log("Planificación generada.", "ok");
  $("#status").textContent="Planificación generada. Revise las vistas.";
}

/* ==========================
   UI posterior a planificación
========================== */
function fillUIAfterPlan(){
  const selEst=$("#selEstudiante");
  selEst.innerHTML = '<option value="">— Seleccione estudiante —</option>' +
    state.data.estudiantes.map(e => `<option value="${e.id}">${e.estudiante} — ${e.carrera} (C${e.ciclo})</option>`).join("");
  selEst.disabled=false;

  const selDoc=$("#selDocente");
  selDoc.innerHTML = '<option value="">— Seleccione docente —</option>' +
    state.index.docentes.map(d => `<option>${d}</option>`).join("");
  selDoc.disabled=false;

  renderGrid("#gridEstudiante", null, "estudiante");
  renderGrid("#gridDocente", null, "docente");

  $("#tablaEst").style.display="none";
  $("#tablaDoc").style.display="none";
  $("#btnEditar").disabled=true;
}

/* ==========================
   Render de grillas
========================== */
function baseGrid(){
  const frag=document.createDocumentFragment();
  const head0=$c("div","cell header"); head0.textContent="Franja / Día"; frag.appendChild(head0);
  for(const d of DAYS){ const h=$c("div","cell header"); h.textContent=d; frag.appendChild(h); }
  for(const sl of SLOTS){
    const l=$c("div","cell slot"); l.textContent=sl; frag.appendChild(l);
    for(const d of DAYS){
      const cell=$c("div","cell"); cell.dataset.day=d; cell.dataset.slot=sl; frag.appendChild(cell);
    }
  }
  return frag;
}
function renderGrid(selector, entries, mode, contextInfo){
  const root = $(selector);
  root.innerHTML="";
  root.appendChild(baseGrid());
  if(!entries) return;

  const cells = root.querySelectorAll(".cell");
  for(const it of entries){
    const cell=[...cells].find(c => c.dataset && c.dataset.day===it.dia && c.dataset.slot===it.slot);
    if(!cell) continue;
    const tag=$c("div","tag");
    tag.innerHTML = `<b>${it.materia}</b> <small>Par. ${it.paralelo}</small><small>• C${it.ciclo} • ${it.carrera}</small>${mode==="docente"?"":`<small>• ${it.docente||"Doc."}</small>`}`;
    cell.appendChild(tag);
  }

  if(mode==="estudiante" && contextInfo){
    const blocks = contextInfo.blocks||[];
    for(const b of blocks){
      const cell=[...cells].find(c => c.dataset && c.dataset.day===b.dia && c.dataset.slot===b.slot);
      if(cell){
        const tag=$c("div","tag");
        tag.style.borderColor="#fecaca"; tag.style.background="#fff1f2"; tag.style.color="#b91c1c";
        tag.innerHTML = `<b>Bloqueado</b> <small>${b.motivo||""}</small>`;
        cell.appendChild(tag);
      }
    }
  }
}

/* ==========================
   Selecciones y tablas
========================== */
function currentStudentBlocks(est){
  const blocks=[];
  const sem = state.config.bloqueosPorSemestre.filter(b => Number(b.ciclo)===Number(est.ciclo));
  for(const b of sem){ blocks.push({dia:b.dia, slot:b.slot, motivo:"Prácticas / Semestre"}); }
  const hasInglesData = !!toKey(est.nivelIngles);
  const applyInglesGlobal = state.config.ingles.activo && !hasInglesData && $("#chkIngles").checked;
  if(applyInglesGlobal){
    for(const b of state.config.ingles.items){ blocks.push({dia:b.dia, slot:b.slot, motivo:"Inglés (global)"}); }
  }
  return blocks;
}
function onPickStudent(){
  const id=$("#selEstudiante").value;
  $("#btnEditar").disabled = !id;
  if(!id){
    renderGrid("#gridEstudiante", null, "estudiante");
    $("#tablaEst").style.display="none";
    $("#kpiEst").style.display="none";
    return;
  }
  state.ui.currentStudent = id;
  const est = state.data.estudiantes.find(e=>e.id===id);
  const plan = state.assign.byStudent.get(id)||[];
  renderGrid("#gridEstudiante", plan, "estudiante", { blocks: currentStudentBlocks(est) });

  $("#kpiEst").style.display="";
  $("#kTotal").textContent = String(plan.length);
  $("#kBlocks").textContent = String(currentStudentBlocks(est).length);
  $("#kChoques").textContent = "0";

  const tb=$("#tablaEst tbody"); tb.innerHTML="";
  for(const p of plan){
    const tr=$c("tr");
    tr.innerHTML = `<td>${p.materia}</td><td>${p.paralelo}</td><td>${p.dia}</td><td>${p.slot}</td><td>${p.docente||""}</td><td>${p.carrera}</td><td>${p.ciclo}</td>`;
    tb.appendChild(tr);
  }
  $("#tablaEst").style.display="";
}

function onPickDocente(){
  const name=$("#selDocente").value;
  if(!name){
    renderGrid("#gridDocente", null, "docente");
    $("#tablaDoc").style.display="none";
    return;
  }
  state.ui.currentDocente = name;
  const entries = state.sections.filter(s => s.docente===name);
  renderGrid("#gridDocente", entries, "docente");

  const tb=$("#tablaDoc tbody"); tb.innerHTML="";
  for(const e of entries){
    const tr=$c("tr");
    tr.innerHTML = `<td>${e.dia}</td><td>${e.slot}</td><td>${e.materia}</td><td>${e.paralelo}</td><td>${e.carrera}</td><td>${e.ciclo}</td>`;
    tb.appendChild(tr);
  }
  $("#tablaDoc").style.display="";
}

/* ==========================
   Edición por estudiante
========================== */
function openEdit(){
  const id = state.ui.currentStudent;
  if(!id) return;
  const est = state.data.estudiantes.find(e=>e.id===id);
  const plan = state.assign.byStudent.get(id)||[];
  const selMat=$("#editMateria");
  selMat.innerHTML = plan.map(p => `<option value="${p.materia}__${p.paralelo}">${p.materia} — Par. ${p.paralelo} (${p.dia} ${p.slot})</option>`).join("");
  $("#editDestino").innerHTML = '<option value="">— Seleccione destino —</option>';
  $("#editMsg").innerHTML="";
  $("#editInfo").textContent = `${est.estudiante} — ${est.carrera} (C${est.ciclo})`;
  $("#modalEdit").style.display="flex";
}
function closeEdit(){ $("#modalEdit").style.display="none"; }

$("#editMateria").addEventListener("change", ()=>{
  const id = state.ui.currentStudent;
  if(!id) return;
  const est = state.data.estudiantes.find(e=>e.id===id);
  const [materia, paralelo] = $("#editMateria").value.split("__");
  const dests = state.sections.filter(s =>
    s.materia===materia && s.carrera===est.carrera && s.ciclo===est.ciclo
  );
  $("#editDestino").innerHTML = dests.map(d => `<option value="${d.dia}__${d.slot}__${d.paralelo}">${d.dia} • ${d.slot} • Par. ${d.paralelo} • Doc. ${d.docente||""}</option>`).join("");
});

function aplicarEdicion(){
  const id = state.ui.currentStudent;
  if(!id) return;
  const est = state.data.estudiantes.find(e=>e.id===id);
  const plan = state.assign.byStudent.get(id)||[];
  if(!plan.length){ $("#editMsg").innerHTML='<span class="bad">No hay asignaciones.</span>'; return; }

  const sel = $("#editMateria").value;
  const dst = $("#editDestino").value;
  if(!sel || !dst){ $("#editMsg").innerHTML='<span class="warnText">Seleccione materia y destino.</span>'; return; }

  const [materia, parOrig] = sel.split("__");
  const [diaN, slotN, parN] = dst.split("__");

  const idx = plan.findIndex(p => p.materia===materia && String(p.paralelo)===String(parOrig));
  if(idx<0){ $("#editMsg").innerHTML='<span class="bad">No se encontró la asignación original.</span>'; return; }

  const nuevo = state.sections.find(s =>
    s.materia===materia && s.carrera===est.carrera && s.ciclo===est.ciclo &&
    s.dia===diaN && s.slot===slotN && String(s.paralelo)===String(parN)
  );
  if(!nuevo){ $("#editMsg").innerHTML='<span class="bad">Destino no válido.</span>'; return; }

  const provisional = [...plan];
  provisional[idx] = {...nuevo};

  const dayCount = new Map();
  for(const p of provisional){
    dayCount.set(p.dia, (dayCount.get(p.dia)||0) + 1);
    if(dayCount.get(p.dia)>2){
      $("#editMsg").innerHTML='<span class="bad">No se permite más de 2 materias el mismo día.</span>';
      return;
    }
  }
  for(let i=0;i<provisional.length;i++){
    for(let j=i+1;j<provisional.length;j++){
      const a=provisional[i], b=provisional[j];
      if(a.dia===b.dia && a.slot===b.slot){
        $("#editMsg").innerHTML='<span class="bad">Choque de horario detectado en la misma franja.</span>';
        return;
      }
    }
  }
  const blocks = currentStudentBlocks(est);
  const isBlocked = blocks.some(b => b.dia===nuevo.dia && b.slot===nuevo.slot);
  if(isBlocked){
    $("#editMsg").innerHTML='<span class="bad">El destino está bloqueado (Inglés/Prácticas). Cambio no aplicado.</span>';
    return;
  }

  state.assign.byStudent.set(id, provisional);
  $("#editMsg").innerHTML='<span class="good">Cambio aplicado correctamente.</span>';
  onPickStudent();
}

/* ==========================
   Eventos generales de UI
========================== */
function switchTab(tab){
  const est = $("#view-estudiantes");
  const doc = $("#view-docentes");
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelector(`.tab[data-tab="${tab}"]`).classList.add("active");
  if(tab==="estudiantes"){ est.style.display=""; doc.style.display="none"; }
  else { est.style.display="none"; doc.style.display=""; }
}

function resetAll(){
  ["fileMalla","fileDocentes","fileEstudiantes"].forEach(id => { const el=$("#"+id); el.value=""; });
  $("#status").textContent="";
  $("#log").textContent="";
  $("#btnConfig").disabled=true;
  $("#btnAsignar").disabled=true;
  $("#chkIngles").checked=false; $("#chkIngles").disabled=true;
  $("#chkPracticas").checked=false; $("#chkPracticas").disabled=true;
  state.raw={malla:null, docentes:null, estudiantes:null};
  state.data={malla:[], docentes:[], estudiantes:[]};
  state.sections=[]; state.assign.byStudent.clear();
  state.config={ bloqueosPorSemestre:[], ingles:{activo:false, items:[]} };
  fillDaySlotSelects();
  renderGrid("#gridEstudiante", null, "estudiante");
  renderGrid("#gridDocente", null, "docente");
  $("#selEstudiante").innerHTML='<option value="">— Seleccione estudiante —</option>'; $("#selEstudiante").disabled=true;
  $("#selDocente").innerHTML='<option value="">— Seleccione docente —</option>'; $("#selDocente").disabled=true;
  $("#tablaEst").style.display="none"; $("#tablaDoc").style.display="none";
  $("#kpiEst").style.display="none";
  $("#btnEditar").disabled=true;
}

/* ==========================
   Listeners
========================== */
$("#btnAnalizar").addEventListener("click", handleAnalizar);
$("#btnConfig").addEventListener("click", openCfg);
$("#btnCloseCfg").addEventListener("click", closeCfg);
$("#btnSaveCfg").addEventListener("click", saveCfg);
$("#btnAddBloq").addEventListener("click", addBloq);
$("#btnAddIng").addEventListener("click", addIng);

$("#btnAsignar").addEventListener("click", generarPlanificacion);
$("#btnLimpiar").addEventListener("click", resetAll);

document.querySelectorAll(".tab").forEach(t => t.addEventListener("click", ()=> switchTab(t.dataset.tab)));
$("#selEstudiante").addEventListener("change", onPickStudent);
$("#selDocente").addEventListener("change", onPickDocente);

$("#btnEditar").addEventListener("click", openEdit);
$("#btnCerrarEdicion").addEventListener("click", closeEdit);
$("#btnAplicarEdicion").addEventListener("click", aplicarEdicion);

// Cerrar modales al hacer click fuera del cuadro
document.querySelectorAll(".modal").forEach(m=>{
  m.addEventListener("click", (e)=>{ if(e.target===m) m.style.display="none"; });
});

// Inicial
fillDaySlotSelects();
renderGrid("#gridEstudiante", null, "estudiante");
renderGrid("#gridDocente", null, "docente");
</script>
</body>
</html>
