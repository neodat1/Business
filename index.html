<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planificación Académica — Matriz UIDE</title>

<!-- SheetJS (XLSX) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --azul:#04136C;
    --mostaza:#DE912E;
    --vino:#862B39;
    --celeste:#9CBEE3;
    --verde:#8A9520;
    --gris:#f4f6fa;
    --negro:#1b1f3b;
  }
  *{box-sizing:border-box}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    background:#fff; color:#111; margin:0; padding:0;
  }
  header{
    display:flex; align-items:center; gap:16px;
    border-bottom:4px solid var(--azul); padding:14px 18px;
    background:linear-gradient(90deg,var(--azul) 0%, #0a1f8d 40%, var(--celeste) 100%);
    color:#fff;
  }
  header img{height:56px; width:auto}
  header h1{font-size:20px; margin:0; line-height:1.2; font-weight:700}
  header small{opacity:.9; display:block; font-weight:500}

  .toolbar{
    display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    padding:12px 18px; background:var(--gris); border-bottom:1px solid #e6e9f2;
  }
  .card{
    background:#fff; border:1px solid #e6e9f2; border-radius:14px;
    padding:14px; box-shadow:0 2px 14px rgba(4,19,108,.06);
  }
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .grow{flex:1 1 320px}
  label{font-size:13px; font-weight:700; color:var(--azul); display:block; margin-bottom:6px}
  input[type="file"]{
    display:block; width:100%; padding:10px;
    border:1px dashed var(--celeste); border-radius:10px; background:#fafcff;
  }
  button{
    appearance:none; border:none; cursor:pointer; font-weight:700;
    padding:10px 14px; border-radius:12px; transition:transform .04s ease;
  }
  .btn-prim{background:var(--mostaza); color:#281400}
  .btn-sec{background:var(--azul); color:#fff}
  .btn-ghost{background:#fff; color:var(--azul); border:1px solid var(--azul)}
  button:active{transform:translateY(1px)}

  table{
    width:100%; border-collapse:separate; border-spacing:0; font-size:13px;
    border:1px solid #e6e9f2; border-radius:14px; overflow:hidden;
  }
  thead th{
    position:sticky; top:0; z-index:1; background:var(--azul); color:#fff;
    text-align:left; padding:10px 8px; font-size:12px; letter-spacing:.02em;
  }
  tbody td{border-top:1px solid #eff2f7; padding:8px}
  tbody tr:nth-child(odd){background:#fbfcff}
  .chip{display:inline-block; padding:.25em .55em; border-radius:999px; font-size:12px; font-weight:700}
  .chip-azul{background:var(--celeste)}
  .chip-vino{background:#f5e9eb; color:var(--vino)}
  .chip-mostaza{background:#fff3e6; color:#5b360b}
  .badge{background:var(--verde); color:#fff; border-radius:8px; padding:.1rem .45rem; font-size:11px; font-weight:800}

  .legend{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .legend span{display:inline-flex; align-items:center; gap:6px; font-size:12px}
  .sw{width:14px; height:10px; border-radius:3px; display:inline-block}
  .sw1{background:var(--celeste)} .sw2{background:#f5e9eb} .sw3{background:#fff3e6}

  .footer{
    padding:20px 18px; color:#4b4f67; font-size:12px;
    border-top:1px solid #e6e9f2; background:#fafbff;
  }

  /* Colores por ciclo para ayudar a visualizar colisiones */
  .ciclo-odd{background:#f7fbff}
  .ciclo-even{background:#fffdf7}
</style>
</head>
<body>
  <header>
    <img src="UIDE-Ecuador.png" alt="UIDE Ecuador" />
    <div>
      <h1>Matriz de Planificación Académica</h1>
      <small>Universidad Internacional del Ecuador — Matemáticas para el análisis de los negocios — Darío Hurtado</small>
    </div>
  </header>

  <section class="toolbar">
    <div class="row grow">
      <div class="card grow">
        <label>1) Cargue <u>Mallas.xlsx</u></label>
        <input id="mallasFile" type="file" accept=".xlsx,.xls" />
      </div>
      <div class="card grow">
        <label>2) Cargue <u>Docentes.xlsx</u></label>
        <input id="docentesFile" type="file" accept=".xlsx,.xls" />
      </div>
      <div class="card" style="min-width:260px">
        <label>Acciones</label>
        <div class="row">
          <button class="btn-prim" id="btnProcesar">Procesar y Llenar Matriz</button>
          <button class="btn-sec" id="btnDescargarCSV" title="Descarga la matriz actual como CSV">Descargar CSV</button>
          <button class="btn-ghost" id="btnLimpiar">Limpiar</button>
        </div>
        <div class="legend" style="margin-top:10px">
          <span><i class="sw sw1"></i> Paralelos</span>
          <span><i class="sw sw2"></i> Ciclos impares</span>
          <span><i class="sw sw3"></i> Ciclos pares</span>
          <span class="badge" title="Regla operativa">Máx. 2 asignaturas por día</span>
        </div>
      </div>
    </div>
  </section>

  <main style="padding:16px 18px">
    <div class="card" style="overflow:auto">
      <table id="matriz">
        <thead>
          <tr>
            <th>DOCENTE</th>
            <th>TITULO ACADÉMICO</th>
            <th>DEDICACIÓN</th>
            <th>MATERIA</th>
            <th>CÓDIGO ANTHOLOGY</th>
            <th>CARRERAS QUE COMPARTEN</th>
            <th>MALLA</th>
            <th>PRE-REQUISITO</th>
            <th>CODIGO</th>
            <th>HORAS TEÓRICAS</th>
            <th>HORAS PRÁCTICAS</th>
            <th>HORAS AUTÓNOMAS</th>
            <th>CREDITOS</th>
            <th>CAMPO DE FORMACIÓN</th>
            <th>CICLO MALLA</th>
            <th>Nº ORDEN EN LA MALLA</th>
            <th>PARALELO</th>
            <th>DIA</th>
            <th>HORA</th>
            <th>MODALIDAD</th>
            <th>Nro. HORAS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <div class="footer">
    Reglas automáticas aplicadas: (i) Lunes–Viernes; franjas: 07–10, 10–13, 13–16, 16–19, 19–22. (ii) Máximo dos asignaturas por día (por ciclo y por docente). (iii) No se cruzan horarios entre ciclos adyacentes de la misma carrera (p.ej., 1.º con 2.º, 2.º con 1.º y 3.º, etc.). (iv) Materias con el mismo nombre se separan por paralelo.
  </div>

<script>
/* ==============================
   Configuración institucional
   ============================== */
const COLORES = {
  azul: "#04136C",
  mostaza: "#DE912E",
  vino: "#862B39",
  celeste: "#9CBEE3",
  verde: "#8A9520"
};

/* ==============================
   Ranuras de horario y días
   ============================== */
const DIAS = ["Lunes","Martes","Miércoles","Jueves","Viernes"];
const FRANJAS = [
  "07:00–10:00","10:00–13:00","13:00–16:00","16:00–19:00","19:00–22:00"
];

/* ==========================================================
   Utilitarios
   ========================================================== */
const by = f => (a,b)=> f(a) < f(b) ? -1 : f(a) > f(b) ? 1 : 0;
const norm = v => (v==null ? "" : String(v).trim());
const toInt = v => {
  const n = parseInt((v ?? "").toString().replace(/[^0-9-]/g,""),10);
  return Number.isFinite(n) ? n : 0;
};
const safeJoinSlash = arr => [...new Set(arr.filter(Boolean).map(s=>norm(s)))].join(" / ");
const csvEscape = s => `"${String(s??"").replaceAll(`"`,`""`)}"`;

/* ==========================================================
   Lectura de archivos Excel (Mallas.xlsx, Docentes.xlsx)
   ========================================================== */
let mallasRows = [];     // filas de la(s) hoja(s) de mallas
let docentesRows = [];   // filas de la(s) hoja(s) de docentes

async function readWorkbook(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:"array"});
        resolve(wb);
      }catch(err){ reject(err); }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

function wbToRows(wb){
  const out = [];
  wb.SheetNames.forEach(name=>{
    const ws = wb.Sheets[name];
    const json = XLSX.utils.sheet_to_json(ws, {defval:""});
    out.push(...json);
  });
  return out;
}

/* ==========================================================
   Normalización de campos esperados
   (los nombres pueden variar; aquí se intentan alias comunes)
   ========================================================== */
function mapMallaRow(r){
  // Ajuste de alias de columnas esperadas en Mallas.xlsx
  const carrera     = norm(r.CARRERA || r.Carrera || r.carrera);
  const malla       = norm(r.MALLA || r.Malla || r["Plan/Malla"] || r.Plan || r.MALLAS);
  const materia     = norm(r.MATERIA || r.Materia || r.Asignatura || r["NOMBRE DE LA MATERIA"]);
  const codigo      = norm(r.CODIGO || r.Código || r["CÓDIGO"] || r["CÓDIGO MATERIA"] || r["CODIGO MATERIA"]);
  const prereq      = norm(r["PRE-REQUISITO"] || r.PREREQUISITO || r.PreRequisito || r["PRE REQUISITO"] || r["PRE-REQUISITOS"]);
  const ciclo       = norm(r["CICLO MALLA"] || r.Ciclo || r.CICLO || r.Nivel);
  const ordenMalla  = norm(r["Nº ORDEN EN LA MALLA"] || r.ORDEN || r["ORDEN MALLA"] || r["No ORDEN"] || r["No. ORDEN"]);
  const campoForm   = norm(r["CAMPO DE FORMACIÓN"] || r["CAMPO FORMACION"] || r["CAMPO"] || r.Campo);
  const horasT      = toInt(r["HORAS TEÓRICAS"] || r["Horas Teóricas"] || r.Teoricas || r["HT"]);
  const horasP      = toInt(r["HORAS PRÁCTICAS"] || r["Horas Prácticas"] || r.Practicas || r["HP"]);
  const horasA      = toInt(r["HORAS AUTÓNOMAS"] || r["Horas Autónomas"] || r.Autonomas || r["HA"]);
  const creditos    = toInt(r.CREDITOS || r["CRÉDITOS"] || r.Créditos || r["Nº CRÉDITOS"] || r["NRO CRÉDITOS"]);
  const codAnth     = norm(r["CÓDIGO ANTHOLOGY"] || r["CODIGO ANTHOLOGY"] || r.ANTHOLOGY || r.COD_ANTHOLOGY);
  const comparte    = norm(r["CARRERAS QUE COMPARTEN"] || r["CARRERAS COMPARTEN"] || r.COMPARTEN || r["COMPARTIDA CON"]);
  const modalidad   = norm(r.MODALIDAD || r.Modalidad || r["Tipo de Clase"]);
  return {
    carrera, malla, materia, codigo, prereq, ciclo, ordenMalla, campoForm,
    horasT, horasP, horasA, creditos, codAnth, comparte, modalidad
  };
}

function mapDocenteRow(r){
  const docente   = norm(r.DOCENTE || r.Docente || r.Profesor || r["NOMBRE DOCENTE"]);
  const titulo    = norm(r["TITULO ACADÉMICO"] || r["TÍTULO ACADÉMICO"] || r.Titulo || r["TÍTULO"]);
  const dedic     = norm(r.DEDICACIÓN || r.Dedicacion || r["Tipo Dedicación"] || r["DEDICACION"]);
  // Disponibilidad opcional: columnas por día/franja, o campos "DIA", "HORA"
  const dia       = norm(r.DIA || r.Dia || r.Días);
  const hora      = norm(r.HORA || r.Horario || r.Horas);
  return {docente, titulo, dedic, dia, hora, raw:r};
}

/* ==========================================================
   Preparación de asignaturas (agrupación y paralelos)
   ========================================================== */
function prepararAsignaturas(mallas){
  // Agrupar por clave de materia + ciclo + carrera para administrar paralelos
  const key = (x)=>[
    x.materia.toUpperCase(),
    (x.carrera||"").toUpperCase(),
    (x.ciclo||"").toUpperCase()
  ].join("||");

  const grupos = new Map();
  mallas.forEach(row=>{
    const k = key(row);
    if(!grupos.has(k)) grupos.set(k, []);
    grupos.get(k).push(row);
  });

  const asignaturas = [];
  grupos.forEach((items, k)=>{
    // Orden estable por malla/orden
    items.sort(by(x=>x.ordenMalla || ""));
    // Si hay duplicados con mismo nombre: asignar paralelos A, B, C...
    items.forEach((it, idx)=>{
      const paralelo = String.fromCharCode("A".charCodeAt(0)+idx);
      asignaturas.push({...it, paralelo});
    });
  });
  return asignaturas;
}

/* ==========================================================
   Algoritmo de asignación de horarios
   Reglas:
   - Días: L-V; Franjas definidas.
   - Máx. 2 asignaturas por día (por ciclo y por docente).
   - No colisión entre ciclos adyacentes dentro de la misma carrera.
   - Intento de respetar disponibilidad de Docentes.xlsx si está presente.
   ========================================================== */
function asignarHorarios(asignaturas, docentes){
  // Índices auxiliares
  const porDocentePrefer = new Map(); // {docente -> Set(dia|franja) preferidos si vienen en Docentes.xlsx}
  docentes.forEach(d=>{
    if(d.dia && d.hora){
      const key = `${d.dia}@@${d.hora}`;
      if(!porDocentePrefer.has(d.docente)) porDocentePrefer.set(d.docente, new Set());
      porDocentePrefer.get(d.docente).add(key);
    }
  });

  // Contadores para la restricción "máx. 2 por día"
  const cupoDiaCiclo = new Map();     // key: carrera||ciclo||dia  -> count
  const cupoDiaDocente = new Map();   // key: docente||dia        -> count

  // Ocupación para evitar colisiones: (dia||franja) -> Set of keys {carrera||ciclo}, y adyacentes
  const ocupado = new Map(); // key: dia||franja -> { docentes:Set, ciclos:Set }

  const adyacentes = ciclo => {
    const n = parseInt(ciclo,10);
    if(!Number.isFinite(n)) return [];
    return [String(n-1), String(n+1)];
  };

  // Intento de asignación greedy con preferencia: disponibilidad -> huecos libres
  for(const asg of asignaturas){
    // Se puede asignar un docente luego; por defecto se queda vacío y se llena al cruzar con Docentes.xlsx
    // Si Docentes.xlsx incluye una columna "DOCENTE" en la malla, úsela; de lo contrario se asigna vacío.
    // (Mantiene su instrucción de no eliminar nada; aquí no inventamos docentes.)
    const docente = norm(asg.docente || "");

    // Orden de búsqueda de slots: preferidos del docente, si existen; si no, todos los slots
    const prefer = docente && porDocentePrefer.get(docente) ? Array.from(porDocentePrefer.get(docente)) : [];
    const universo = [];
    if(prefer.length){
      for(const p of prefer){
        const [d,h] = p.split("@@");
        if(DIAS.includes(d) && FRANJAS.includes(h)) universo.push({dia:d, franja:h});
      }
    }
    // Completar con el resto de slots
    for(const d of DIAS){
      for(const f of FRANJAS){
        if(!universo.find(u=>u.dia===d && u.franja===f)) universo.push({dia:d, franja:f});
      }
    }

    // Intentar colocar respetando reglas
    let colocado = false;
    for(const slot of universo){
      const keyOF = `${slot.dia}||${slot.franja}`;
      if(!ocupado.has(keyOF)) ocupado.set(keyOF, {docentes:new Set(), ciclos:new Set(), pares:new Set()});

      // Regla: cupos por día (ciclo y docente)
      const kCupoCiclo = `${asg.carrera}||${asg.ciclo}||${slot.dia}`;
      const kCupoDoc = `${docente}||${slot.dia}`;

      if( (cupoDiaCiclo.get(kCupoCiclo)||0) >= 2 ) continue;
      if( docente && (cupoDiaDocente.get(kCupoDoc)||0) >= 2 ) continue;

      // Regla: no cruzar ciclos adyacentes de la misma carrera
      const ciclosOcupados = ocupado.get(keyOF).ciclos;
      const yaOcupadoPorAdj = [...ciclosOcupados].some(tag=>{
        // tag es "carrera||ciclo"
        const [car, cic] = tag.split("||");
        if(car !== asg.carrera) return false;
        return adyacentes(asg.ciclo).includes(cic) || cic === asg.ciclo;
      });
      if(yaOcupadoPorAdj) continue;

      // Regla: evitar chocar docentes en el mismo slot
      if(docente && ocupado.get(keyOF).docentes.has(docente)) continue;

      // Aprobado: fijar
      asg._dia = slot.dia;
      asg._hora = slot.franja;

      cupoDiaCiclo.set(kCupoCiclo, (cupoDiaCiclo.get(kCupoCiclo)||0)+1);
      if(docente) cupoDiaDocente.set(kCupoDoc, (cupoDiaDocente.get(kCupoDoc)||0)+1);

      ocupado.get(keyOF).ciclos.add(`${asg.carrera}||${asg.ciclo}`);
      if(docente) ocupado.get(keyOF).docentes.add(docente);

      colocado = true;
      break;
    }

    // Si no se pudo colocar con reglas, dejar en blanco para que se visualice pendiente
    if(!colocado){
      asg._dia = "";
      asg._hora = "";
    }
  }

  return asignaturas;
}

/* ==========================================================
   Construcción de la matriz final (una fila por asignación)
   Reglas de unión:
   - Campos de códigos/horas/créditos/campo de formación: si una misma MATERIA aparece en varias carreras,
     se arma string por carrera separado por " / ".
   - "CARRERAS QUE COMPARTEN" y "MALLA" también con " / ".
   - Nro. HORAS queda vacío.
   ========================================================== */
function construirMatriz(asignaturas, docentes){
  // Index docente por nombre para traer título/dedicación si procede
  const idxDoc = new Map();
  docentes.forEach(d=>{
    if(d.docente) idxDoc.set(d.docente.toUpperCase(), d);
  });

  // Agrupar por identificador único (materia + carrera + ciclo + paralelo) — cada uno es una “sección”
  const key = (x)=>[
    x.materia.toUpperCase(),
    (x.carrera||"").toUpperCase(),
    (x.ciclo||"").toUpperCase(),
    (x.paralelo||"").toUpperCase()
  ].join("|");

  const filas = [];
  for(const a of asignaturas){
    const docenteName = norm(a.docente||""); // no inventar
    const docInfo = idxDoc.get(docenteName.toUpperCase()) || {};
    const fila = {
      DOCENTE: docenteName,
      "TITULO ACADÉMICO": docInfo.titulo || "",
      "DEDICACIÓN": docInfo.dedic || "",
      "MATERIA": a.materia,
      "CÓDIGO ANTHOLOGY": a.codAnth,
      "CARRERAS QUE COMPARTEN": safeJoinSlash([a.comparte || a.carrera]),
      "MALLA": safeJoinSlash([a.malla]),
      "PRE-REQUISITO": a.prereq,
      "CODIGO": safeJoinSlash([a.codigo]),
      "HORAS TEÓRICAS": safeJoinSlash([String(a.horasT||0)]),
      "HORAS PRÁCTICAS": safeJoinSlash([String(a.horasP||0)]),
      "HORAS AUTÓNOMAS": safeJoinSlash([String(a.horasA||0)]),
      "CREDITOS": safeJoinSlash([String(a.creditos||0)]),
      "CAMPO DE FORMACIÓN": safeJoinSlash([a.campoForm]),
      "CICLO MALLA": a.ciclo,
      "Nº ORDEN EN LA MALLA": a.ordenMalla,
      "PARALELO": a.paralelo,
      "DIA": a._dia||"",
      "HORA": a._hora||"",
      "MODALIDAD": a.modalidad || "",
      "Nro. HORAS": "" // vacío
    };
    filas.push(fila);
  }

  return filas;
}

/* ==========================================================
   Renderizado en tabla
   ========================================================== */
function pintarTabla(filas){
  const tbody = document.querySelector("#matriz tbody");
  tbody.innerHTML = "";

  const parseCicloNum = v => {
    const n = parseInt((v||"").toString().replace(/[^0-9-]/g,""),10);
    return Number.isFinite(n) ? n : 0;
  };

  // Ordenar por Carrera, Ciclo, Orden en Malla, Materia, Paralelo
  filas.sort((a,b)=>{
    const ka = [a["CARRERAS QUE COMPARTEN"], parseCicloNum(a["CICLO MALLA"]), a["Nº ORDEN EN LA MALLA"], a.MATERIA, a.PARALELO].join("|");
    const kb = [b["CARRERAS QUE COMPARTEN"], parseCicloNum(b["CICLO MALLA"]), b["Nº ORDEN EN LA MALLA"], b.MATERIA, b.PARALELO].join("|");
    return ka.localeCompare(kb, "es");
  });

  for(const f of filas){
    const tr = document.createElement("tr");
    const cicloN = parseInt(f["CICLO MALLA"],10);
    tr.className = Number.isFinite(cicloN) ? (cicloN % 2 ? "ciclo-odd" : "ciclo-even") : "";

    const cells = [
      f.DOCENTE,
      f["TITULO ACADÉMICO"],
      f["DEDICACIÓN"],
      f.MATERIA,
      f["CÓDIGO ANTHOLOGY"],
      f["CARRERAS QUE COMPARTEN"],
      f["MALLA"],
      f["PRE-REQUISITO"],
      f["CODIGO"],
      f["HORAS TEÓRICAS"],
      f["HORAS PRÁCTICAS"],
      f["HORAS AUTÓNOMAS"],
      f["CREDITOS"],
      f["CAMPO DE FORMACIÓN"],
      f["CICLO MALLA"],
      f["Nº ORDEN EN LA MALLA"],
      f["PARALELO"],
      f["DIA"],
      f["HORA"],
      f["MODALIDAD"],
      f["Nro. HORAS"]
    ];

    cells.forEach((val, idx)=>{
      const td = document.createElement("td");
      if(idx === 16){ // Paralelo
        td.innerHTML = `<span class="chip chip-azul">${val||"—"}</span>`;
      }else if(idx === 3){ // Materia
        td.innerHTML = `<strong>${val}</strong>`;
      }else{
        td.textContent = val;
      }
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  }
}

/* ==========================================================
   Exportación CSV
   ========================================================== */
function descargarCSV(){
  const ths = Array.from(document.querySelectorAll("#matriz thead th")).map(th=>th.textContent.trim());
  const rows = Array.from(document.querySelectorAll("#matriz tbody tr")).map(tr=>{
    return Array.from(tr.children).map(td=>td.textContent.trim());
  });
  const csv = [ths.map(csvEscape).join(",")].concat(rows.map(r=>r.map(csvEscape).join(","))).join("\r\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Matriz_Planificacion_UIDE.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ==========================================================
   Flujo principal
   ========================================================== */
document.getElementById("btnProcesar").addEventListener("click", async ()=>{
  const fM = document.getElementById("mallasFile").files[0];
  const fD = document.getElementById("docentesFile").files[0];
  if(!fM || !fD){
    alert("Cargue ambos archivos: Mallas.xlsx y Docentes.xlsx.");
    return;
  }
  try{
    const [wbM, wbD] = await Promise.all([readWorkbook(fM), readWorkbook(fD)]);
    mallasRows = wbToRows(wbM).map(mapMallaRow).filter(x=>x.materia);
    docentesRows = wbToRows(wbD).map(mapDocenteRow).filter(x=>x.docente);

    // Preparar asignaturas (paralelos)
    const asignaturas = prepararAsignaturas(mallasRows);

    // Intentar anexar docente si la malla trae columna "DOCENTE"
    // (si su Mallas.xlsx incluye DOCENTE, esta línea lo reconocerá)
    asignaturas.forEach(a=>{
      if(!a.docente && a.raw && a.raw.DOCENTE) a.docente = norm(a.raw.DOCENTE);
    });

    // Asignación de horarios con reglas
    const asignadas = asignarHorarios(asignaturas, docentesRows);

    // Construir y pintar matriz
    const matriz = construirMatriz(asignadas, docentesRows);
    pintarTabla(matriz);

  }catch(err){
    console.error(err);
    alert("Ocurrió un error procesando los archivos. Verifique el formato de las columnas.");
  }
});

document.getElementById("btnDescargarCSV").addEventListener("click", descargarCSV);

document.getElementById("btnLimpiar").addEventListener("click", ()=>{
  document.querySelector("#matriz tbody").innerHTML = "";
  document.getElementById("mallasFile").value = "";
  document.getElementById("docentesFile").value = "";
  mallasRows = []; docentesRows = [];
});
</script>
</body>
</html>
