<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planificación Académica – Matriz</title>
<style>
  :root{
    --azul:#04136C; --mostaza:#DE912E; --vino:#862B39; --celeste:#9CBEE3; --verde:#8A9520;
    --bg:#f8f9fb; --ink:#1d2630; --muted:#6b7785; --bord:#e5e7eb;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif}
  header{padding:14px 20px;background:white;border-bottom:2px solid var(--azul);position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:20px;color:var(--azul)}
  .wrap{max-width:1300px;margin:0 auto;padding:18px}
  .card{background:white;border:1px solid var(--bord);border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{font-weight:600;font-size:14px}
  input[type="file"]{display:block;font-size:14px}
  button{appearance:none;border:1px solid var(--azul);background:var(--azul);color:white;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  button.ghost{background:white;color:var(--azul)}
  button:disabled{opacity:.5;cursor:not-allowed}
  .hint{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#f3f4f6;z-index:5;border-bottom:2px solid var(--vino);color:var(--azul)}
  th,td{border-bottom:1px solid var(--bord);padding:8px 10px;font-size:13px;text-align:left;vertical-align:top}
  tbody tr:nth-child(odd){background:#fafbfc}
  .log{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#374151;background:#f9fafb;border:1px dashed var(--celeste);border-radius:10px;padding:10px;max-height:220px;overflow:auto}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between">
    <h1>Planificación Académica — Generador de Matriz</h1>
    <div class="controls">
      <button id="btnGenerar" disabled>Generar planificación</button>
      <button id="btnLimpiar" class="ghost">Limpiar</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <label for="fileMallas">Mallas.xlsx</label>
        <input type="file" id="fileMallas" accept=".xlsx,.xls" />
        <div class="hint">CARRERA, MALLA (si existe), MATERIA, CÓDIGO / CÓDIGO ANTHOLOGY, PRE-REQUISITO, HT/HP/HA, CRÉDITOS, CAMPO FORMACIÓN, CICLO, Nº ORDEN, PARALELO, MODALIDAD…</div>
      </div>
      <div>
        <label for="fileDocentes">Docentes.xlsx</label>
        <input type="file" id="fileDocentes" accept=".xlsx,.xls" />
        <div class="hint">DOCENTE, TÍTULO ACADÉMICO, DEDICACIÓN, MATERIA/CÓDIGO/ANTHOLOGY, CARRERA, disponibilidad por columnas (p. ej., “Lunes 7:10”, “Mié 10:13”, “Jue 13:16”…).</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="hint">
      Slots fijos: Lunes–Viernes en <b>7:10, 10:13, 13:16, 16:19, 19:22</b>. Máximo <b>2 asignaturas por día</b> (por docente). No se cruzan ciclos adyacentes dentro de la misma carrera (1↔2, 2↔1/3, 3↔2/4, …). Se separa por <b>paralelo</b>. “Nro. HORAS” se deja <b>vacío</b>.
    </div>
  </div>

  <div class="card">
    <div style="overflow:auto;border:1px solid #e5e7eb;border-radius:10px;max-height:60vh">
      <table id="tbl">
        <thead>
          <tr>
            <th>DOCENTE</th>
            <th>TITULO ACADÉMICO</th>
            <th>DEDICACIÓN</th>
            <th>MATERIA</th>
            <th>CÓDIGO ANTHOLOGY</th>
            <th>CARRERAS QUE COMPARTEN</th>
            <th>MALLA</th>
            <th>PRE-REQUISITO</th>
            <th>CODIGO</th>
            <th>HORAS TEÓRICAS</th>
            <th>HORAS PRÁCTICAS</th>
            <th>HORAS AUTÓNOMAS</th>
            <th>CREDITOS</th>
            <th>CAMPO DE FORMACIÓN</th>
            <th>CICLO MALLA</th>
            <th>Nº ORDEN EN LA MALLA</th>
            <th>PARALELO</th>
            <th>DIA</th>
            <th>HORA</th>
            <th>MODALIDAD</th>
            <th>Nro. HORAS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="margin-top:10px">
      <div style="font-weight:700;margin-bottom:6px;color:#862B39">Registro</div>
      <div id="log" class="log"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
(() => {
  const btnGenerar = document.getElementById('btnGenerar');
  const btnLimpiar = document.getElementById('btnLimpiar');
  const fileMallas = document.getElementById('fileMallas');
  const fileDocentes = document.getElementById('fileDocentes');
  const tblBody = document.querySelector('#tbl tbody');
  const logEl = document.getElementById('log');

  // Slots con dos puntos (7:10, 10:13, 13:16, 16:19, 19:22)
  const TIMESLOTS = [
    {day:'Lunes',range:'7:10',hours:3},{day:'Lunes',range:'10:13',hours:3},{day:'Lunes',range:'13:16',hours:3},{day:'Lunes',range:'16:19',hours:3},{day:'Lunes',range:'19:22',hours:3},
    {day:'Martes',range:'7:10',hours:3},{day:'Martes',range:'10:13',hours:3},{day:'Martes',range:'13:16',hours:3},{day:'Martes',range:'16:19',hours:3},{day:'Martes',range:'19:22',hours:3},
    {day:'Miércoles',range:'7:10',hours:3},{day:'Miércoles',range:'10:13',hours:3},{day:'Miércoles',range:'13:16',hours:3},{day:'Miércoles',range:'16:19',hours:3},{day:'Miércoles',range:'19:22',hours:3},
    {day:'Jueves',range:'7:10',hours:3},{day:'Jueves',range:'10:13',hours:3},{day:'Jueves',range:'13:16',hours:3},{day:'Jueves',range:'16:19',hours:3},{day:'Jueves',range:'19:22',hours:3},
    {day:'Viernes',range:'7:10',hours:3},{day:'Viernes',range:'10:13',hours:3},{day:'Viernes',range:'13:16',hours:3},{day:'Viernes',range:'16:19',hours:3},{day:'Viernes',range:'19:22',hours:3},
  ];
  const VALID_RANGES = new Set(TIMESLOTS.map(s=>s.range));

  const FIELD_MAP = {
    carrera:['CARRERA','CARRERAS','PROGRAMA','CARRERA/PROGRAMA'],
    malla:['MALLA','MALLA CURRICULAR','PENSUM','PLAN'],
    materia:['MATERIA','ASIGNATURA','NOMBRE ASIGNATURA','NOMBRE MATERIA'],
    codigo:['CODIGO','CÓDIGO','CÓDIGO MATERIA','COD MATERIA','CODIGO MATERIA'],
    codigoAnth:['CÓDIGO ANTHOLOGY','CODIGO ANTHOLOGY','ANTHOLOGY'],
    prereq:['PRE-REQUISITO','PRERREQUISITO','PRERREQUISITOS','REQUISITOS'],
    horasTeo:['HORAS TEÓRICAS','HORAS TEORICAS','H TEORICAS','HT'],
    horasPra:['HORAS PRÁCTICAS','HORAS PRACTICAS','H PRACTICAS','HP'],
    horasAut:['HORAS AUTÓNOMAS','HORAS AUTONOMAS','H AUTONOMAS','HA'],
    creditos:['CREDITOS','CRÉDITOS','CR'],
    campoForm:['CAMPO DE FORMACIÓN','CAMPO FORMACION','CAMPO'],
    ciclo:['CICLO MALLA','CICLO','SEMESTRE','NIVEL'],
    ordenMalla:['Nº ORDEN EN LA MALLA','N ORDEN','ORDEN','N° ORDEN','NO. ORDEN'],
    paralelo:['PARALELO','PAR','SECCION','SECCIÓN'],
    modalidad:['MODALIDAD','MOD']
  };

  const DFIELD_MAP = {
    docente:['DOCENTE','PROFESOR','NOMBRE','NOMBRES','APELLIDOS Y NOMBRES'],
    titulo:['TITULO ACADÉMICO','TÍTULO ACADÉMICO','TITULO','TÍTULO'],
    dedicacion:['DEDICACIÓN','DEDICACION','JORNADA','TIPO DEDICACION','TIPO DEDICACIÓN'],
    materia:['MATERIA','ASIGNATURA','NOMBRE MATERIA','ASIGNATURA ASIGNADA','ASIG'],
    codigo:['CÓDIGO','CODIGO','CODIGO MATERIA','CÓDIGO MATERIA'],
    codigoAnth:['CÓDIGO ANTHOLOGY','CODIGO ANTHOLOGY','ANTHOLOGY'],
    carrera:['CARRERA','PROGRAMA']
  };

  const DAY_ALIASES = {'lunes':'Lunes','lun':'Lunes','martes':'Martes','mar':'Martes','miercoles':'Miércoles','miércoles':'Miércoles','mie':'Miércoles','mié':'Miércoles','jueves':'Jueves','jue':'Jueves','viernes':'Viernes','vie':'Viernes'};

  function log(msg){ logEl.textContent += (msg + "\n"); }
  function normStr(v){ return (v==null? '': String(v)).trim(); }
  function strip(s){ return normStr(s).normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase(); }
  function cleanCode(s){ return strip(s).replace(/[^a-z0-9]/g,''); }
  function num(v){ const n = parseFloat(String(v).replace(',','.')); return isNaN(n)?0:n; }

  async function readWorkbook(file){
    const buf = await file.arrayBuffer();
    return XLSX.read(new Uint8Array(buf), {type:'array'});
  }
  function sheetToJSONAllSheets(wb){
    const rows=[]; wb.SheetNames.forEach(n=>{ const ws=wb.Sheets[n]; if(!ws) return; const json=XLSX.utils.sheet_to_json(ws,{defval:'',raw:false}); json.forEach(r=>{ r.__sheet=n; rows.push(r); });}); return rows;
  }
  function findCol(obj, keys){
    const cols=Object.keys(obj);
    for(const k of keys){ for(const c of cols){ if(strip(c)===strip(k)) return c; } }
    for(const k of keys){ for(const c of cols){ if(strip(c).includes(strip(k))) return c; } }
    return null;
  }
  function getField(obj,key){ const col = findCol(obj, FIELD_MAP[key]); return col? obj[col]:''; }
  function getDField(obj,key){ const col = findCol(obj, DFIELD_MAP[key]); return col? obj[col]:''; }

  function parseCycle(v){
    const s=strip(v), map={'primero':1,'segundo':2,'tercero':3,'cuarto':4,'quinto':5,'sexto':6,'septimo':7,'octavo':8,'noveno':9,'decimo':10};
    if(map[s]) return map[s]; const n=parseInt(s,10); return isNaN(n)?0:n;
  }

  function normalizeRange(text){
    const t = strip(text).replace(/\s+/g,' ');
    // Soportar "7:10" o "7-10" -> devolver con dos puntos
    if(t.includes('7:10') || t.includes('7-10')) return '7:10';
    if(t.includes('10:13')|| t.includes('10-13'))return '10:13';
    if(t.includes('13:16')|| t.includes('13-16'))return '13:16';
    if(t.includes('16:19')|| t.includes('16-19'))return '16:19';
    if(t.includes('19:22')|| t.includes('19-22'))return '19:22';
    // patrones "7 a 10"
    if(/(^|[^0-9])7\s*a\s*10([^0-9]|$)/.test(t))  return '7:10';
    if(/(^|[^0-9])10\s*a\s*13([^0-9]|$)/.test(t)) return '10:13';
    if(/(^|[^0-9])13\s*a\s*16([^0-9]|$)/.test(t)) return '13:16';
    if(/(^|[^0-9])16\s*a\s*19([^0-9]|$)/.test(t)) return '16:19';
    if(/(^|[^0-9])19\s*a\s*22([^0-9]|$)/.test(t)) return '19:22';
    return null;
  }
  function detectAvailabilityHeaders(sampleRow){
    const headers=Object.keys(sampleRow||{}), out=[];
    headers.forEach(h=>{
      const hs=strip(h); let day=null;
      for(const k in DAY_ALIASES){ if(hs.includes(strip(k))){ day=DAY_ALIASES[k]; break; } }
      if(!day) return;
      const rng=normalizeRange(h); if(rng && VALID_RANGES.has(rng)){ out.push({header:h,day,range:rng}); }
    });
    const seen=new Set(); return out.filter(x=>{ const key=x.day+'|'+x.range; if(seen.has(key)) return false; seen.add(key); return true; });
  }

  function buildDocentes(rawDocRows){
    if(!rawDocRows.length) return {list:[], index:{}};
    const availHeaders = detectAvailabilityHeaders(rawDocRows[0]);
    const docentes=[]; const idxAnth={}, idxCode={}, idxMateria={};

    rawDocRows.forEach(r=>{
      const nombre=normStr(getDField(r,'docente')); if(!nombre) return;
      const d={
        docente:nombre,
        titulo:normStr(getDField(r,'titulo')),
        dedicacion:normStr(getDField(r,'dedicacion')),
        materia:normStr(getDField(r,'materia')),
        codigo:normStr(getDField(r,'codigo')),
        codigoAnth:normStr(getDField(r,'codigoAnth')),
        carrera:normStr(getDField(r,'carrera')),
        disponibilidad:new Set()
      };
      availHeaders.forEach(h=>{ const v=r[h.header]; if(v && String(v).trim()!==''){ d.disponibilidad.add(h.day+'|'+h.range); } });
      docentes.push(d);
      if(d.codigoAnth) idxAnth[cleanCode(d.codigoAnth)]=d;
      if(d.codigo)     idxCode[cleanCode(d.codigo)]=d;
      if(d.materia)    idxMateria[strip(d.materia)]=d;
    });
    return {list:docentes, availHeaders, index:{idxAnth, idxCode, idxMateria}};
  }

  function keySubject(m){
    const k1=cleanCode(m.codigoAnth), k2=cleanCode(m.codigo), k3=strip(m.materia);
    return k1 || k2 || k3 || '';
  }

  function buildMaterias(rawMallas){
    const materias=[];
    rawMallas.forEach(r=>{
      const nombre=normStr(getField(r,'materia'));
      const carrera=normStr(getField(r,'carrera'));
      if(!nombre && !carrera) return;
      const m={
        carrera,
        malla: normStr(getField(r,'malla')),
        materia:nombre,
        codigoAnth:normStr(getField(r,'codigoAnth')),
        codigo:normStr(getField(r,'codigo')),
        prereq:normStr(getField(r,'prereq')),
        horasTeo:num(getField(r,'horasTeo')),
        horasPra:num(getField(r,'horasPra')),
        horasAut:num(getField(r,'horasAut')),
        creditos:num(getField(r,'creditos')),
        campoForm:normStr(getField(r,'campoForm')),
        ciclo:parseCycle(getField(r,'ciclo')),
        cicloRaw:normStr(getField(r,'ciclo')),
        ordenMalla:normStr(getField(r,'ordenMalla')),
        paralelo:normStr(getField(r,'paralelo')),
        modalidad:normStr(getField(r,'modalidad'))
      };
      m.totalContacto = Math.max(0,(m.horasTeo||0)+(m.horasPra||0));
      materias.push(m);
    });

    // Agrupar para "carreras comparten", "malla" y "orden por carrera"
    const byKey={};
    materias.forEach(m=>{ const k=keySubject(m); if(!k) return; (byKey[k]??=[]).push(m); });
    materias.forEach(m=>{
      const k=keySubject(m), group=byKey[k]||[m];
      const carreras=[...new Set(group.map(x=>x.carrera).filter(Boolean))];
      const mallas=[...new Set(group.map(x=>x.malla||x.carrera).filter(Boolean))];
      const ordenes=[...new Set(group.map(x=>x.ordenMalla).filter(Boolean))];
      m.carrerasComparten = carreras.join(' / ');
      m.mallaJoined = mallas.join(' / ');
      m.ordenJoined = ordenes.join(' / ');
    });
    return materias;
  }

  function matchDocenteParaMateria(m, docentes){
    const {idxAnth, idxCode, idxMateria}=docentes.index;
    const a=cleanCode(m.codigoAnth); if(a && idxAnth[a]) return idxAnth[a];
    const c=cleanCode(m.codigo);     if(c && idxCode[c]) return idxCode[c];
    const nm=strip(m.materia);       if(nm && idxMateria[nm]) return idxMateria[nm];
    // fallback por carrera
    const cand = docentes.list.filter(d=> d.carrera && strip(d.carrera)===strip(m.carrera));
    return cand.find(d=>d.disponibilidad.size>0) || cand[0] || null;
  }

  // Programar evitando choques; máx 2 asignaturas por día (por docente); evitar adyacentes por ciclo en misma carrera; separar por paralelo
  function scheduleAggregate(materias, docentes){
    const ocupacionDoc={}, ocupacionCiclo={}, perDayDocCount={};
    function cicloKey(carrera,ciclo){ return strip(carrera)+'|'+String(ciclo||0); }
    function docDayKey(doc,day){ return doc+'|'+day; }
    function markDocente(doc,day,range){ (ocupacionDoc[doc]??={}); (ocupacionDoc[doc][day]??=new Set()).add(range); }
    function docenteLibre(doc,day,range){ if(!ocupacionDoc[doc]||!ocupacionDoc[doc][day]) return true; return !ocupacionDoc[doc][day].has(range); }
    function topeDocDia(doc,day){ return (perDayDocCount[docDayKey(doc,day)]||0) >= 2; }
    function incDocDia(doc,day){ perDayDocCount[docDayKey(doc,day)] = (perDayDocCount[docDayKey(doc,day)]||0)+1; }
    function vecinoChoca(carrera,ciclo,day,range){
      const k1=cicloKey(carrera,(ciclo||0)-1), k2=cicloKey(carrera,(ciclo||0)+1);
      for(const k of [k1,k2]){ const set=ocupacionCiclo[k]; if(set && set.has(day+'|'+range)) return true; }
      return false;
    }
    function marcarCiclo(carrera,ciclo,day,range){ const k=cicloKey(carrera,ciclo); (ocupacionCiclo[k]??=new Set()).add(day+'|'+range); }

    // clave única por asignatura + paralelo + docente
    function rowKey(m,d){ return [strip(m.carrera), strip(m.malla||''), cleanCode(m.codigoAnth)||cleanCode(m.codigo)||strip(m.materia), strip(m.paralelo), d?strip(d.docente):''].join('|'); }

    // ordenar por carrera, ciclo, paralelo, materia
    materias.sort((a,b)=> (a.carrera||'').localeCompare(b.carrera||'') || (a.ciclo||0)-(b.ciclo||0) || (a.paralelo||'').localeCompare(b.paralelo||'') || (a.materia||'').localeCompare(b.materia||''));

    const agregadas = new Map();

    materias.forEach(m=>{
      if((m.horasTeo+m.horasPra)<=0){ log(`Sin horas de contacto: ${m.carrera} – ${m.materia}.`); return; }
      const d = matchDocenteParaMateria(m, docentes);
      if(!d){ log(`⚠️ Sin docente: ${m.carrera} – ${m.materia} (${m.paralelo}). No se programa.`); return; }

      let horasPend = m.horasTeo + m.horasPra;
      const slots = TIMESLOTS.slice();
      if(d.disponibilidad && d.disponibilidad.size){
        const pref=slots.filter(s=>d.disponibilidad.has(s.day+'|'+s.range));
        const resto=slots.filter(s=>!d.disponibilidad.has(s.day+'|'+s.range));
        slots.length=0; slots.push(...pref,...resto);
      }

      const k = rowKey(m,d);
      if(!agregadas.has(k)){
        agregadas.set(k,{
          docente:d.docente, titulo:d.titulo, dedicacion:d.dedicacion, materia:m.materia, codigoAnth:m.codigoAnth,
          carrerasComparten:m.carrerasComparten||m.carrera||'', malla:m.mallaJoined||m.malla||m.carrera||'',
          prereq:m.prereq, codigo:m.codigo, horasTeo:m.horasTeo, horasPra:m.horasPra, horasAut:m.horasAut,
          creditos:m.creditos, campoForm:m.campoForm, ciclo:m.cicloRaw||m.ciclo, ordenMalla:m.ordenJoined||m.ordenMalla,
          paralelo:m.paralelo, modalidad:m.modalidad, dias:[], horas:[]
        });
      }
      const agg = agregadas.get(k);

      for(const s of slots){
        if(horasPend<=0) break;
        if(topeDocDia(d.docente, s.day)) continue;
        if(!docenteLibre(d.docente, s.day, s.range)) continue;
        if(vecinoChoca(m.carrera, m.ciclo, s.day, s.range)) continue;
        // asignar bloque (3h, pero "Nro. HORAS" se deja vacío; solo acumulamos DÍA/HORA)
        agg.dias.push(s.day);
        agg.horas.push(s.range);
        markDocente(d.docente, s.day, s.range);
        incDocDia(d.docente, s.day);
        marcarCiclo(m.carrera, m.ciclo, s.day, s.range);
        horasPend -= 3;
      }
      if(horasPend>0){ log(`⚠️ Quedaron ${horasPend} h sin asignar: ${m.carrera} – ${m.materia} (${m.paralelo}).`); }
    });

    // a filas finales, sin duplicados en DÍA/HORA
    const rows = Array.from(agregadas.values()).map(r=>({
      docente:r.docente, titulo:r.titulo, dedicacion:r.dedicacion, materia:r.materia, codigoAnth:r.codigoAnth,
      carrerasComparten:r.carrerasComparten, malla:r.malla, prereq:r.prereq, codigo:r.codigo,
      horasTeo:r.horasTeo, horasPra:r.horasPra, horasAut:r.horasAut, creditos:r.creditos, campoForm:r.campoForm,
      ciclo:r.ciclo, ordenMalla:r.ordenMalla, paralelo:r.paralelo,
      dia:[...new Set(r.dias)].join(' / '), hora:[...new Set(r.horas)].join(' / '),
      modalidad:r.modalidad, nroHoras:''   // solicitado: dejar vacío
    }));
    // ordenar para salida estable
    rows.sort((a,b)=> (a.campoForm||'').localeCompare(b.campoForm||'') || (a.ciclo||'').toString().localeCompare((b.ciclo||'').toString()) || (a.paralelo||'').localeCompare(b.paralelo||'') || (a.materia||'').localeCompare(b.materia||''));
    return rows;
  }

  function render(rows){
    tblBody.innerHTML='';
    const frag=document.createDocumentFragment();
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      const cells=[
        r.docente,r.titulo,r.dedicacion,r.materia,r.codigoAnth,r.carrerasComparten,r.malla,r.prereq,r.codigo,
        r.horasTeo,r.horasPra,r.horasAut,r.creditos,r.campoForm,r.ciclo,r.ordenMalla,r.paralelo,r.dia,r.hora,r.modalidad,r.nroHoras
      ];
      cells.forEach(v=>{ const td=document.createElement('td'); td.textContent=(v==null)?'':String(v); tr.appendChild(td); });
      frag.appendChild(tr);
    });
    tblBody.appendChild(frag);
  }

  // UI
  fileMallas.addEventListener('change', ()=>{ btnGenerar.disabled = !(fileMallas.files[0] && fileDocentes.files[0]); });
  fileDocentes.addEventListener('change', ()=>{ btnGenerar.disabled = !(fileMallas.files[0] && fileDocentes.files[0]); });

  btnLimpiar.addEventListener('click', ()=>{
    tblBody.innerHTML=''; logEl.textContent=''; fileMallas.value=''; fileDocentes.value=''; btnGenerar.disabled=true;
  });

  btnGenerar.addEventListener('click', async ()=>{
    try{
      tblBody.innerHTML=''; logEl.textContent='Procesando archivos…\n';
      const [wb1, wb2] = await Promise.all([ readWorkbook(fileMallas.files[0]), readWorkbook(fileDocentes.files[0]) ]);
      log('Archivos leídos. Extrayendo datos…');

      const rawMallas = sheetToJSONAllSheets(wb1);
      const rawDocentes = sheetToJSONAllSheets(wb2);

      if(!rawMallas.length){ log('No se encontraron filas en Mallas.'); return; }
      if(!rawDocentes.length){ log('No se encontraron filas en Docentes.'); }

      const materias = buildMaterias(rawMallas);
      const docentes = buildDocentes(rawDocentes);

      log(`Materias detectadas: ${materias.length}`);
      log(`Docentes detectados: ${docentes.list.length}`);

      const rows = scheduleAggregate(materias, docentes);
      log(`Asignaturas programadas: ${rows.length}`);
      render(rows);
      log('Listo.');
    }catch(err){
      console.error(err);
      log('Error: ' + (err && err.message? err.message : String(err)));
    }
  });

  // habilitar botón
  btnGenerar.disabled = !(fileMallas.files[0] && fileDocentes.files[0]);
})();
</script>
</body>
</html>
