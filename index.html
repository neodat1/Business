<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matriz de Asignación – UIDE</title>

<!-- XLSX: corregido (sin SRI que bloqueaba la carga) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --azul:#04136C; --mostaza:#DE912E; --vino:#862B39; --celeste:#9CBEE3; --verde:#8A9520;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; margin:0; background:#f7f8fb; color:#222}
  header{
    background:linear-gradient(135deg,var(--azul),#0b2b8e 65%);
    color:#fff; padding:14px 20px; display:flex; align-items:center; gap:14px;
    border-bottom:6px solid var(--mostaza);
  }
  /* Marco blanco para que el logo siempre se vea */
  .logo-wrap{
    background:#fff; border-radius:12px; padding:6px 10px; box-shadow:0 4px 12px rgba(0,0,0,.15);
    display:flex; align-items:center; justify-content:center;
  }
  .logo-wrap img{height:48px; width:auto; display:block}
  header h1{font-size:1.35rem; margin:0; line-height:1.2}
  header small{display:block; opacity:.95; font-weight:500}

  .panel{
    background:#fff; margin:16px; padding:16px; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.08);
    border:1px solid #e7e9f0;
  }
  .panel h2{margin:0 0 10px 0; font-size:1.05rem; color:var(--azul)}
  .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  .controls .hint{font-size:.9rem; opacity:.9}
  input[type=file]{padding:8px; border:1px dashed var(--azul); border-radius:10px; background:#f3f6ff}
  button{
    background:var(--vino); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600
  }
  button.secondary{background:var(--verde)}
  button:disabled{opacity:.6; cursor:not-allowed}

  .legend{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
  .tag{padding:6px 10px; border-radius:999px; font-size:.85rem; color:#fff; font-weight:600}
  .t-azul{background:var(--azul)} .t-mostaza{background:var(--mostaza)} .t-vino{background:var(--vino)}
  .t-celeste{background:var(--celeste); color:#0c2d55} .t-verde{background:var(--verde)}

  table{width:100%; border-collapse:separate; border-spacing:0; margin-top:10px}
  thead th{
    position:sticky; top:0; background:var(--azul); color:#fff; padding:10px; text-align:left; font-size:.92rem;
  }
  thead th:first-child{border-top-left-radius:10px}
  thead th:last-child{border-top-right-radius:10px}
  tbody td{background:#fff; padding:9px 10px; border-bottom:1px solid #eef1f6; font-size:.94rem}
  tbody tr:nth-child(even) td{background:#fbfcff}
  tbody tr.assigned td{border-left:4px solid var(--verde)}
  tbody tr.conflict td{border-left:4px solid var(--vino); background:#fff5f5}
  .chip{display:inline-block; padding:3px 8px; border-radius:999px; background:#eef4ff; color:#0a257a; font-weight:600; font-size:.8rem; margin-left:6px}

  .footer{margin:10px 16px 40px; color:#53607b; font-size:.9rem}
  .notice{background:#fff3cd; border:1px solid #ffe58f; padding:8px 10px; border-radius:10px; margin-top:10px; color:#664d03}
</style>
</head>
<body>
  <header>
    <div class="logo-wrap">
      <img src="UIDE-Ecuador.png" alt="UIDE">
    </div>
    <div>
      <h1>Planificador de Horarios – Facultad de Negocios <small>Generación automática de la matriz (sin cruces)</small></h1>
    </div>
  </header>

  <section class="panel">
    <h2>Cargar Excel</h2>
    <div class="controls">
      <input id="fileInput" type="file" accept=".xlsx,.xls" multiple />
      <button id="btnProcesar">Procesar y asignar</button>
      <span class="hint">Formato esperado: <strong>DOCENTE, MATERIA, DIA DISPONIBLE, HORA DISPONIBLE, Modalidad, Estudiantes</strong>. 
        Columnas opcionales: <em>RESTRICCIONES, CICLO DEL ESTUDIANTE, CICLO DE LA MATERIA EN LA MALLA</em>.</span>
    </div>

    <div class="legend">
      <span class="tag t-azul">Encabezado institucional</span>
      <span class="tag t-mostaza">Acento</span>
      <span class="tag t-vino">Conflictos</span>
      <span class="tag t-celeste">Información</span>
      <span class="tag t-verde">Asignado</span>
    </div>

    <div class="notice">
      Reglas: L-V en franjas fijas (07–10, 10–13, 13–16, 16–19, 19–22). Máx. <b>2</b> materias por día por docente.
      Si una materia supera <b>26</b> estudiantes, se divide en paralelos (sin solaparse). Se respetan restricciones de días y, si hay columna de ciclo, se evita solapar ciclos adyacentes.
    </div>
  </section>

  <section class="panel">
    <h2>Matriz resultante <span id="resumen" class="chip">0 filas</span></h2>
    <div style="overflow:auto">
      <table id="tabla">
        <thead>
          <tr>
            <th>DOCENTE</th>
            <th>MATERIA</th>
            <th>ESTUDIANTES</th>
            <th>PARALELO</th>
            <th>DÍA</th>
            <th>HORA</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <div class="footer">
    © UIDE — Matriz automática de asignación de horarios. Paleta: Azul #04136C · Mostaza #DE912E · Vino #862B39 · Celeste #9CBEE3 · Verde #8A9520
  </div>

<script>
if(typeof XLSX === "undefined"){
  alert("No se pudo cargar la librería XLSX. Verifique su conexión o el bloqueador de scripts.");
}

/* ========== Utilidades ========== */
const normalize = (s='') =>
  (s||'').toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,' ').trim().toUpperCase();

const parseIntSafe = v => {
  const n = parseInt(String(v).replace(/[^\d]/g,''),10);
  return Number.isFinite(n) ? n : null;
};

/* ========== Parámetros ========== */
const DAYS = ["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES"];
const TIME_SLOTS = [
  "07:00-10:00","10:00-13:00","13:00-16:00","16:00-19:00","19:00-22:00"
];

/* ========== Parseos ========== */
function slotsFromRange(rango){
  if(!rango) return [];
  const rx = normalize(rango).replace(/\s*A\s*/g,'-');
  const m = rx.match(/(\d{2}:\d{2})-(\d{2}:\d{2})/);
  if(!m) return [];
  const [_,a,b] = m;
  const slots=[];
  for(const slot of TIME_SLOTS){
    const [s,e]=slot.split('-');
    if(s>=a && e<=b) slots.push(slot);
  }
  return slots.length ? slots : [...TIME_SLOTS];
}
function expandDays(txt){
  const t = normalize(txt);
  if(!t) return [];
  if(t.includes("A VIERNES")){
    const m = t.match(/(LUNES|MARTES|MIERCOLES|JUEVES|VIERNES)/);
    const start = m ? DAYS.indexOf(m[1]) : 0;
    return DAYS.slice(start);
  }
  if(t.includes("A ")){
    const m = t.match(/(LUNES|MARTES|MIERCOLES|JUEVES|VIERNES)\s*A\s*(LUNES|MARTES|MIERCOLES|JUEVES|VIERNES)/);
    if(m){
      const a=DAYS.indexOf(m[1]), b=DAYS.indexOf(m[2]);
      if(a>=0 && b>=a) return DAYS.slice(a,b+1);
    }
  }
  const list = t.split(/[,/]| Y /g).map(s=>s.trim()).filter(Boolean);
  const out=[];
  for(const d of list){ if(DAYS.includes(d)) out.push(d); }
  return out.length? out : DAYS;
}
function daysRestrictions(txt){
  if(!txt) return new Set();
  const t = normalize(txt), set=new Set();
  for(const d of DAYS){ if(t.includes(d)) set.add(d); }
  return set;
}

/* ========== Lectura XLSX ========== */
async function readAllFiles(files){
  const rows=[];
  for(const file of files){
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data,{type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws,{defval:""});
    rows.push(...json);
  }
  return rows;
}

/* ========== Normalización filas ========== */
function mapRow(r){
  const dict={}; for(const [k,v] of Object.entries(r)){ dict[normalize(k)] = v; }
  const get = (...keys) => { for(const k of keys){ const kn=normalize(k); if(kn in dict) return dict[kn]; } return ""; };

  const docente = String(get('DOCENTE')).trim();
  const materia = String(get('MATERIA')).trim();
  const diaDisp = String(get('DIA DISPONIBLE','DIAS DISPONIBLES','DIA')).trim();
  const horaDisp = String(get('HORA DISPONIBLE','HORARIO DISPONIBLE','HORA')).trim();
  const est = parseIntSafe(get('ESTUDIANTES','N ESTUDIANTES','NUM ESTUDIANTES')) ?? 0;
  const restr = get('RESTRICCIONES','DIAS RESTRINGIDOS','DIA RESTRICCION');
  const cicloA = get('CICLO DEL ESTUDIANTE','CICLO ESTUDIANTE','CICLO');
  const cicloM = get('CICLO DE LA MATERIA EN LA MALLA','CICLO MATERIA');

  return {
    docente, materia,
    estudiantes: est,
    diasDisponibles: expandDays(diaDisp),
    slotsDisponibles: slotsFromRange(horaDisp),
    restrDias: daysRestrictions(restr),
    ciclo: (() => {
      const c = parseIntSafe(cicloM)||parseIntSafe(cicloA);
      return Number.isFinite(c) ? c : null;
    })()
  };
}

/* ========== Motor de asignación ========== */
function planificar(items){
  const usoDocente = new Map(); // docente -> dia -> count
  const ocupacion = new Set(); // "docente|dia|slot"
  const ocupacionGlobal = new Set(); // "materia|dia|slot"
  const porCiclo = new Map(); // "dia|slot" -> Set(ciclos)

  const resultados=[];

  const puede = (docente, materiaClave, dia, slot, ciclo) => {
    const mapDia = usoDocente.get(docente) || new Map();
    if((mapDia.get(dia)||0) >= 2) return false;
    if(ocupacion.has(`${docente}|${dia}|${slot}`)) return false;
    if(ocupacionGlobal.has(`${materiaClave}|${dia}|${slot}`)) return false;
    if(ciclo!=null){
      const set = porCiclo.get(`${dia}|${slot}`) || new Set();
      for(const c of set){ if(Math.abs(c - ciclo) === 1) return false; }
    }
    return true;
  };
  const colocar = (docente, materiaClave, dia, slot, ciclo) => {
    const mapDia = usoDocente.get(docente) || new Map();
    mapDia.set(dia,(mapDia.get(dia)||0)+1); usoDocente.set(docente,mapDia);
    ocupacion.add(`${docente}|${dia}|${slot}`);
    ocupacionGlobal.add(`${materiaClave}|${dia}|${slot}`);
    if(ciclo!=null){
      const key = `${dia}|${slot}`;
      const set = porCiclo.get(key) || new Set(); set.add(ciclo); porCiclo.set(key,set);
    }
  };

  // heurística: menos opciones primero
  items.sort((a,b)=>{
    const asz = (a.diasDisponibles.length||5)*(a.slotsDisponibles.length||5);
    const bsz = (b.diasDisponibles.length||5)*(b.slotsDisponibles.length||5);
    return asz - bsz;
  });

  for(const it of items){
    const materiaClave = normalize(it.materia||"(SIN MATERIA)");

    const totalParalelos = Math.max(1, Math.ceil((it.estudiantes||0)/26));
    const tamanios = [];
    let rest = it.estudiantes||0;
    for(let p=0;p<totalParalelos;p++){
      const size = Math.min(26, Math.max(0, rest));
      tamanios.push(size || (p===0?0:size));
      rest = Math.max(0, rest-26);
    }

    const diasValidos = (it.diasDisponibles||[]).filter(d => !it.restrDias.has(d));
    const slotsValidos = (it.slotsDisponibles && it.slotsDisponibles.length) ? it.slotsDisponibles : [...TIME_SLOTS];

    for(let idx=0; idx<totalParalelos; idx++){
      let asignado=false;
      outer:
      for(const d of diasValidos.length?diasValidos:[...DAYS]){
        for(const s of slotsValidos){
          if(puede(it.docente, materiaClave, d, s, it.ciclo)){
            colocar(it.docente, materiaClave, d, s, it.ciclo);
            resultados.push({docente:it.docente, materia:it.materia, estudiantes:tamanios[idx]||it.estudiantes||0,
              paralelo:(idx+1).toString().padStart(2,'0'), dia:d, hora:s, assigned:true});
            asignado=true; break outer;
          }
        }
      }
      if(!asignado){
        resultados.push({docente:it.docente, materia:it.materia, estudiantes:tamanios[idx]||it.estudiantes||0,
          paralelo:(idx+1).toString().padStart(2,'0'), dia:"SIN ESPACIO", hora:"—", assigned:false});
      }
    }
  }
  return resultados;
}

/* ========== Render ========== */
function renderTabla(rows){
  const tbody = document.querySelector("#tabla tbody"); tbody.innerHTML="";
  let count=0;
  for(const r of rows){
    const tr=document.createElement("tr"); tr.className = r.assigned ? "assigned" : "conflict";
    const td = v => { const x=document.createElement("td"); x.textContent = v; return x; };
    tr.append(td(r.docente||""), td(r.materia||""), td(r.estudiantes??0), td(r.paralelo||""), td(r.dia||""), td(r.hora||""));
    tbody.appendChild(tr); count++;
  }
  document.getElementById("resumen").textContent = `${count} filas`;
}

/* ========== Flujo ========== */
document.getElementById("btnProcesar").addEventListener("click", async ()=>{
  try{
    const input = document.getElementById("fileInput");
    if(!input.files.length){ alert("Seleccione al menos un archivo Excel."); return; }
    const raw = await readAllFiles(input.files);
    if(!raw.length){ alert("No se encontraron filas en los archivos."); return; }
    const items = raw.map(mapRow).filter(r => r.docente && r.materia);
    if(!items.length){ alert("Las columnas requeridas no se encontraron. Verifique encabezados."); return; }
    const resultado = planificar(items);
    renderTabla(resultado);
  }catch(err){
    console.error(err);
    alert("Ocurrió un error al procesar el archivo. Revise la consola para más detalles.");
  }
});
</script>
</body>
</html>
