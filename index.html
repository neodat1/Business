<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Sistema de Planificación Académica</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{
  --brand:#04136C; --brand-2:#021048; --sky:#9CBEE3;
  --ink:#0f172a; --muted:#475569; --line:#e2e8f0; --bg:#f1f5f9; --ok:#10b981; --warn:#de912e; --err:#a62939;
  --r:14px; --shadow:0 8px 30px rgba(2,8,23,.08);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.header{position:sticky;top:0;z-index:9;background:#fff;border-bottom:1px solid var(--line)}
.header .inner{max-width:1200px;margin:auto;padding:16px 20px;display:flex;gap:14px;align-items:center}
.logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 210deg,#93c5fd,var(--brand),#60a5fa)}
.brand{font-weight:800;margin:0}.brand small{display:block;color:var(--muted);font-weight:600}
.wrap{max-width:1200px;margin:auto;padding:22px}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:18px;margin-bottom:16px}
.card h2{margin:0 0 10px;font-weight:800}
.grid-2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
@media(max-width:980px){.grid-2{grid-template-columns:1fr}}

label{display:block;font-size:12px;font-weight:700;color:var(--muted);margin-bottom:6px}
.input,select.input{width:100%;height:42px;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
.input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(4,19,108,.12)}
.btn{appearance:none;border:none;border-radius:12px;padding:11px 16px;font-weight:800;font-size:14px;cursor:pointer;display:inline-flex;gap:10px;align-items:center}
.btn:disabled{opacity:.5;cursor:not-allowed}
.primary{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff}
.ghost{background:#fff;border:1px solid var(--line)}
.actions{display:flex;gap:12px;flex-wrap:wrap}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
@media(max-width:980px){.kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:14px;text-align:center}
.kpi .v{font-size:26px;font-weight:900;color:var(--brand)}.kpi .l{font-size:12px;color:var(--muted)}
.uploads{display:grid;gap:12px;grid-template-columns:repeat(5,1fr)}
@media(max-width:1200px){.uploads{grid-template-columns:repeat(3,1fr)}}
@media(max-width:980px){.uploads{grid-template-columns:1fr}}
.up{border:1px dashed var(--line);border-radius:12px;padding:14px;background:#fafcff}
.up h4{margin:0 0 8px;font-size:13px;font-weight:800;color:var(--ink)}
.row{display:flex;gap:8px;align-items:center;margin-top:6px;color:var(--muted);font-size:12px}
.dot{width:9px;height:9px;border-radius:50%;background:#cbd5e1}.dot.ok{background:var(--ok)}
.progress{height:8px;background:#edf2f7;border-radius:999px;overflow:hidden;margin-top:10px;display:none}
.bar{height:100%;width:0%;background:linear-gradient(90deg,#93c5fd,var(--brand))}
.toolbar{display:grid;grid-template-columns:260px 1fr auto auto;gap:12px;align-items:end;margin:8px 0 12px}
@media(max-width:980px){.toolbar{grid-template-columns:1fr}}
.badge{display:inline-flex;gap:10px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:800;color:var(--muted);font-size:12px}
.table-wrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
.table-scroll{max-height:460px;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{position:sticky;top:0;z-index:1;background:#f8fafc;color:var(--ink);font-weight:800;text-align:left;padding:12px;border-bottom:1px solid var(--line)}
tbody td{padding:10px 12px;border-bottom:1px solid var(--line);color:var(--ink)}
tbody tr:hover{background:#f8fafc}
.alert{padding:12px;border-radius:10px;margin-top:10px;border:1px solid var(--line)}
.alert.ok{background:#f0fdf4;color:#065f46}.alert.err{background:#fef2f2;color:#991b1b}
.modal-bg{position:fixed;inset:0;background:rgba(2,8,23,.45);display:none;align-items:center;justify-content:center;z-index:50}
.modal{width:min(560px,92vw);background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px}
.modal h3{margin:0 0 12px;font-weight:800}
.modal .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
.modal .actions{justify-content:flex-end;margin-top:6px}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="header">
  <div class="inner">
    <div class="logo"></div>
    <div>
      <p class="brand">Sistema de Planificación Académica
        <small>Asignación inteligente — interfaz profesional</small>
      </p>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="grid-2">
    <section class="card">
      <h2>Parámetros</h2>
      <div class="grid-2">
        <div>
          <label for="maxMaterias">Máximo de materias por estudiante</label>
          <input id="maxMaterias" class="input" type="number" value="6" min="1" max="10">
        </div>
        <div>
          <label for="capacidadParalelo">Capacidad máxima por paralelo</label>
          <input id="capacidadParalelo" class="input" type="number" value="30" min="10" max="100">
        </div>
      </div>
      <p class="small">Se respetan: (1) sin choques día/hora por estudiante y docente; (2) máx. 2 materias por día; (3) <b>no choques entre ciclos adyacentes</b>.</p>
    </section>

    <section class="card">
      <h2>Acciones</h2>
      <div class="actions">
        <button id="btnRun" class="btn primary" disabled>Procesar Asignación</button>
        <button id="btnDown" class="btn ghost" disabled>Descargar Planificación</button>
      </div>
      <div id="progress" class="progress"><div id="bar" class="bar"></div></div>
      <div id="msgError" class="alert err" style="display:none"></div>
      <div id="msgOk" class="alert ok" style="display:none"></div>
    </section>
  </div>

  <section class="card">
    <h2>Carga de archivos</h2>
    <div class="uploads">
      <div class="up"><h4>DOCENTES.xlsx</h4><input id="fileDoc" class="input" type="file" accept=".xlsx,.xls"><div class="row"><span id="dotDoc" class="dot"></span><span id="nameDoc">Esperando archivo…</span></div></div>
      <div class="up"><h4>ESTUDIANTES.xlsx</h4><input id="fileEst" class="input" type="file" accept=".xlsx,.xls"><div class="row"><span id="dotEst" class="dot"></span><span id="nameEst">Esperando archivo…</span></div></div>
      <div class="up"><h4>MALLA.xlsx</h4><input id="fileMal" class="input" type="file" accept=".xlsx,.xls"><div class="row"><span id="dotMal" class="dot"></span><span id="nameMal">Esperando archivo…</span></div></div>
      <div class="up"><h4>INGLÉS.xlsx (opcional)</h4><input id="fileIng" class="input" type="file" accept=".xlsx,.xls"><div class="row"><span id="dotIng" class="dot"></span><span id="nameIng">No cargado</span></div><p class="small">Columnas: ESTUDIANTE, DIA, HORA</p></div>
      <div class="up"><h4>PRÁCTICAS.xlsx (opcional)</h4><input id="filePra" class="input" type="file" accept=".xlsx,.xls"><div class="row"><span id="dotPra" class="dot"></span><span id="namePra">No cargado</span></div><p class="small">Columnas: ESTUDIANTE, DIA, HORA</p></div>
    </div>

    <div id="kpis" class="kpis" style="display:none">
      <div class="kpi"><div id="kSecc" class="v">0</div><div class="l">Secciones</div></div>
      <div class="kpi"><div id="kAsig" class="v">0</div><div class="l">Asignaciones</div></div>
      <div class="kpi"><div id="kNo" class="v">0</div><div class="l">No asignados</div></div>
      <div class="kpi"><div id="kOcc" class="v">0%</div><div class="l">Ocupación</div></div>
    </div>
  </section>

  <section class="card">
    <h2 style="display:flex;justify-content:space-between;align-items:center">
      <span>Asignaciones realizadas</span>
      <span class="badge"><b id="chipCount">0</b> registros</span>
    </h2>

    <div id="filterBar" class="toolbar" style="display:none">
      <div>
        <label for="careerFilter">Carrera</label>
        <select id="careerFilter" class="input"><option value="__ALL__">Todas las carreras</option></select>
      </div>
      <div>
        <label for="quickSearch">Buscar</label>
        <input id="quickSearch" class="input" placeholder="Estudiante, docente, materia, día, hora…">
      </div>
      <div><label>&nbsp;</label><span id="filterState" class="badge">Sin filtro</span></div>
      <div style="justify-self:end"><label>&nbsp;</label><button id="clearFilters" class="btn ghost">Limpiar</button></div>
    </div>

    <div class="table-wrap">
      <div class="table-scroll">
        <table id="tblAsign">
          <thead><tr>
            <th>Editar</th><th>NOMBRE_DOCENTE</th><th>MATERIA</th><th>CANT. ESP.</th>
            <th>DIA</th><th>HORA</th><th>Modalidad</th><th>Paralelo</th><th>ESTUDIANTE</th><th>CICLO</th><th>CARRERA</th>
          </tr></thead>
          <tbody id="asigBody"><tr><td colspan="11" style="text-align:center;color:#94a3b8;padding:22px">Sin datos</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <div class="modal-bg" id="modalBg">
    <div class="modal">
      <h3>Modificar asignación</h3>
      <p class="small" id="modalInfo"></p>
      <div class="grid">
        <div><label for="editDia">Día</label><select id="editDia" class="input"></select></div>
        <div><label for="editHora">Hora</label><select id="editHora" class="input"></select></div>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnCancel">Cancelar</button>
        <button class="btn primary" id="btnSave">Guardar cambios</button>
      </div>
    </div>
  </div>

</div>

<script>
/* ================== Utilidades generales ================== */
const $ = s => document.querySelector(s);
const show = el => el.style.display = '';
const hide = el => el.style.display = 'none';
const msgOk = t => { const el=$('#msgOk'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',3000); };
const msgErr= t => { const el=$('#msgError'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',6000); };
const setProgress = p => { $('#progress').style.display='block'; $('#bar').style.width=p+'%'; };
const esc = s => (s==null?'':String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'));
const __norm = s => String(s ?? "").toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
const splitList = s => String(s ?? "").split(/[,;/]/).map(x=>x.trim()).filter(Boolean);

/* ================== Constantes de horario ================== */
const HORARIOS = ["07:00-10:00","10:00-13:00","13:00-16:00","16:00-19:00","19:00-22:00"];
const DIAS = ["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES","SABADO"];
const DAY_MAP = new Map(Object.entries({
  "lun":"LUNES","lunes":"LUNES","lun.":"LUNES","mar":"MARTES","martes":"MARTES","mar.":"MARTES","mie":"MIERCOLES","mié":"MIERCOLES","miercoles":"MIERCOLES","miércoles":"MIERCOLES","mie.":"MIERCOLES",
  "jue":"JUEVES","jueves":"JUEVES","jue.":"JUEVES","vie":"VIERNES","viernes":"VIERNES","vie.":"VIERNES","sab":"SABADO","sáb":"SABADO","sabado":"SABADO","sábado":"SABADO","sab.":"SABADO"
}));
function canonDay(s){ const t=String(s||"").toLowerCase().trim(); return DAY_MAP.get(t)||String(s||"").toUpperCase(); }
function normalizarHorario(txt){
  if(!txt) return null;
  const raw=String(txt).toUpperCase().trim();
  if(HORARIOS.includes(raw)) return raw;
  const m=raw.match(/(\d{1,2})(?::(\d{2}))?\s*(?:-|–|—|A|AL|A LAS|A LOS|TO)\s*(\d{1,2})(?::(\d{2}))?/i);
  if(!m) return null;
  const h=m[1].padStart(2,'0'), mi=(m[2]??'00').padStart(2,'0');
  const start=`${h}:${mi}`;
  return HORARIOS.find(b=>b.startsWith(start))||null;
}

/* ================== Lectura XLSX ================== */
const readSheet = (file,name)=>new Promise((resolve,reject)=>{
  if(!file){ resolve([]); return; }
  const fr=new FileReader();
  fr.onload=e=>{ try{
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{defval:""});
      resolve(rows||[]);
    }catch(ex){ reject(new Error(`Error leyendo ${name}: ${ex.message}`)); }
  };
  fr.onerror=()=>reject(new Error(`No se pudo abrir ${name}`));
  fr.readAsArrayBuffer(file);
});

/* ================== Normalización ================== */
function normalizeDocentes(rows){
  return (rows||[]).map(r=>{
    const dtxt=String(r["DIA DISPONIBLE"]||r["DIA"]||"").toUpperCase();
    const dias=[]; DIAS.forEach(x=>{ if(dtxt.includes(x)) dias.push(x); });
    if(dtxt.includes("LUNES A VIERNES")) ["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES"].forEach(d=>dias.push(d));
    const htxt=String(r["HORA DISPONIBLE"]||r["HORA"]||"").toUpperCase();
    const rangos=htxt.match(/\d{1,2}(?::\d{2})?\s*(?:-|–|—|a|A|AL|A LAS|A LOS|TO)\s*\d{1,2}(?::\d{2})?/gi)||[];
    let horas=Array.from(new Set(rangos.map(normalizarHorario).filter(Boolean)));
    if(!horas.length && (/\b07:00\b.*\b22:00\b/i.test(htxt) || /\b7\b.*\b22\b/.test(htxt))) horas=[...HORARIOS];
    return {
      NOMBRE_DOCENTE:r["NOMBRE_DOCENTE"]||r["DOCENTE"]||"",
      MATERIA:r["MATERIA"]||r["MATERIAS"]||"",
      CAP: Number(r["CANTIDAD DE ALUMNOS ESPERADOS"]||r["CAPACIDAD"]||r["CUPOS"]||25)||25,
      DIA_DISPONIBLE:Array.from(new Set(dias)), HORA_DISPONIBLE:horas,
      Modalidad:r["MODALIDAD"]||r["Modalidad"]||"PRESENCIAL",
      Paralelo:String(r["PARALELO"]||r["Paralelo"]||"").toUpperCase()||"A",
      DEDICACION:r["DEDICACIÓN"]||r["DEDICACION"]||""
    };
  }).filter(x=>x.MATERIA && x.NOMBRE_DOCENTE);
}
function normalizeEstudiantes(rows){
  return (rows||[]).map(r=>{
    const ciclo=Number(r["CICLO AL QUE VA"]||r["CICLO ACTUAL"]||r["CICLO"]||1);
    return {
      ESTUDIANTE:r["ESTUDIANTE"]||r["NOMBRE"]||"",
      CICLO:isNaN(ciclo)?1:Math.max(1,Math.min(12,ciclo)),
      CARRERA:r["CARRERA"]||r["CARRERA DEL ESTUDIANTE"]||"",
      MALLA:r["MALLA"]||"",
      NIVEL_INGLES:r["NIVEL INGLES"]||""
    };
  }).filter(x=>x.ESTUDIANTE && Number(x.CICLO)!==9);
}
function normalizeMallas(rows){
  const WORD2NUM={"PRIMERO":1,"SEGUNDO":2,"TERCERO":3,"CUARTO":4,"QUINTO":5,"SEXTO":6,"SEPTIMO":7,"SÉPTIMO":7,"OCTAVO":8,"NOVENO":9,"DECIMO":10,"DÉCIMO":10,"ONCE":11,"DOCE":12};
  const toCycle=v=>{ if(v==null||v==="") return NaN; const t=String(v).toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(); if(/^\d+$/.test(t)) return Number(t); return WORD2NUM[t]||NaN; };
  return (rows||[]).map(r=>{
    let ciclo=toCycle(r["CICLO"]); if(isNaN(ciclo)) ciclo=Number(r["CICLO"]||1);
    return {
      CARRERA:r["CARRERA"]||"",
      MATERIA:r["MATERIA"]||"",
      CODIGO:String(r["CÓDIGO"]||r["CODIGO"]||r["CÓDIGO ANTHOLOGY"]||"").trim(),
      CICLO:Math.max(1,Math.min(12,Number(ciclo)||1)),
      "CARRERAS QUE COMPARTEN":r["CARRERAS QUE COMPARTEN"]||r["CARRERAS_COMPARTEN"]||"",
      "HORAS TEÓRICAS":Number(r["HORAS TEÓRICAS"]||0)||0,"HORAS PRÁCTICAS":Number(r["HORAS PRÁCTICAS"]||0)||0,"HORAS AUTÓNOMAS":Number(r["HORAS AUTÓNOMAS"]||0)||0,
      CREDITOS:Number(r["CREDITOS"]||0)||0,"CAMPO DE FORMACIÓN":r["CAMPO DE FORMACIÓN"]||"","Nº ORDEN EN LA MALLA":r["Nº ORDEN EN LA MALLA"]||0,"PRE-REQUISITO":r["PRE-REQUISITO"]||"",MALLA:r["MALLA"]||""
    };
  }).filter(x=>x.MATERIA);
}
function normalizeBloqueos(rows){ // para Inglés/Prácticas
  return (rows||[]).map(r=>({ESTUDIANTE:String(r["ESTUDIANTE"]||"").trim(), DIA:canonDay(r["DIA"]||""), HORA:normalizarHorario(r["HORA"]||"")}))
    .filter(x=>x.ESTUDIANTE && x.DIA && x.HORA);
}

/* ================== Estructuras globales ================== */
let OUT_SECC=[], OUT_COMB=[], OUT_CARGA=[], OUT_RES_MAT=[], OUT_NO=[];
let OUT_PLAN_DOC=[], OUT_PROY=[], GLOBAL_ASIGNACIONES=[];
let __DOCENTE_SLOTS__=new Map(), __DOC_DAY_COUNT__=new Map();
let BLOQUEOS=new Map(); // Map<estudiante, Set('DIA|HORA')>

function addBloqueos(rows){ BLOQUEOS.clear(); for(const r of rows){ const k=r.ESTUDIANTE; const s=BLOQUEOS.get(k)||new Set(); s.add(r.DIA+'|'+r.HORA); BLOQUEOS.set(k,s);} }
const getDocDayCount=(doc,dia)=>(__DOC_DAY_COUNT__.get(doc)?.get(dia))||0;
const incDocDayCount=(doc,dia)=>{const m=__DOC_DAY_COUNT__.get(doc)||new Map(); m.set(dia,(m.get(dia)||0)+1); __DOC_DAY_COUNT__.set(doc,m)};

/* ================== Construcción de secciones ==================
   Reglas clave:
   - No chocar día/hora dentro del mismo ciclo
   - Tampoco chocar con ciclos adyacentes (c-1 y c+1)
*/
function construirSecciones(docentes,mallas,estudiantes){
  __DOCENTE_SLOTS__=new Map(); __DOC_DAY_COUNT__=new Map();
  const secciones=[]; const capacidad=parseInt($('#capacidadParalelo').value)||30;

  // usoPorCiclo: Map<ciclo, Map<dia, Set<hora>>>
  const usoPorCiclo=new Map(); for(let c=1;c<=12;c++) usoPorCiclo.set(c,new Map());

  // meta por (ciclo,materia) para unir códigos/carreras/mallas
  const meta=new Map();
  for(const m of mallas){
    const k=`${m.CICLO}¦${m.MATERIA}`;
    const o=meta.get(k)||{CODIGOS:new Set(),CARRERAS:new Set(),MALLAS:new Set(),"HORAS TEÓRICAS":0,"HORAS PRÁCTICAS":0,"HORAS AUTÓNOMAS":0,CREDITOS:0,"CAMPO DE FORMACIÓN":m["CAMPO DE FORMACIÓN"]||"","Nº ORDEN EN LA MALLA":m["Nº ORDEN EN LA MALLA"]||0,"PRE-REQUISITO":m["PRE-REQUISITO"]||""};
    if(m.CODIGO) o.CODIGOS.add(String(m.CODIGO));
    if(m.CARRERA) o.CARRERAS.add(__norm(m.CARRERA));
    splitList(m["CARRERAS QUE COMPARTEN"]).forEach(c=>o.CARRERAS.add(__norm(c)));
    if(m.MALLA) o.MALLAS.add(String(m.MALLA));
    o["HORAS TEÓRICAS"]=Math.max(o["HORAS TEÓRICAS"],Number(m["HORAS TEÓRICAS"]||0));
    o["HORAS PRÁCTICAS"]=Math.max(o["HORAS PRÁCTICAS"],Number(m["HORAS PRÁCTICAS"]||0));
    o["HORAS AUTÓNOMAS"]=Math.max(o["HORAS AUTÓNOMAS"],Number(m["HORAS AUTÓNOMAS"]||0));
    o.CREDITOS=Math.max(o.CREDITOS,Number(m.CREDITOS||0));
    meta.set(k,o);
  }

  function horarioLibreParaCiclo(ciclo,dia,hora){
    const chk=(cy)=>{ const m=usoPorCiclo.get(cy)||new Map(); const set=m.get(dia)||new Set(); return !set.has(hora); };
    return chk(ciclo) && chk(ciclo-1) && chk(ciclo+1);
  }
  function marcarUso(ciclo,dia,hora){ [ciclo,ciclo-1,ciclo+1].forEach(cy=>{ const m=usoPorCiclo.get(cy); if(!m) return; const set=m.get(dia)||new Set(); set.add(hora); m.set(dia,set); }); }

  const seccionesPorDoc=new Map();
  for(const m of mallas){
    const ciclo=m.CICLO;
    const docentesMateria=docentes.filter(d=>__norm(d.MATERIA)===__norm(m.MATERIA));
    if(!docentesMateria.length) continue;

    docentesMateria.sort((a,b)=>(seccionesPorDoc.get(a.NOMBRE_DOCENTE)||0)-(seccionesPorDoc.get(b.NOMBRE_DOCENTE)||0));
    let elegido=null, slot=null;
    for(const d of docentesMateria){
      const slots=__DOCENTE_SLOTS__.get(d.NOMBRE_DOCENTE)||new Map();
      for(const dia of d.DIA_DISPONIBLE){
        if(getDocDayCount(d.NOMBRE_DOCENTE,dia)>=2) continue;
        const usados=slots.get(dia)||new Set();
        for(const hora of d.HORA_DISPONIBLE){
          if(usados.has(hora)) continue;
          if(!horarioLibreParaCiclo(ciclo,dia,hora)) continue;     // <<<<<< ciclo adyacente
          elegido=d; slot={dia,hora}; break;
        }
        if(slot) break;
      }
      if(slot) break;
    }
    if(!slot) continue;

    marcarUso(ciclo,slot.dia,slot.hora);
    const slots=__DOCENTE_SLOTS__.get(elegido.NOMBRE_DOCENTE)||new Map();
    const sset=slots.get(slot.dia)||new Set(); sset.add(slot.hora); slots.set(slot.dia,sset); __DOCENTE_SLOTS__.set(elegido.NOMBRE_DOCENTE,slots); incDocDayCount(elegido.NOMBRE_DOCENTE,slot.dia);

    const info=meta.get(`${ciclo}¦${m.MATERIA}`)||{};
    const codStr=Array.from(info.CODIGOS||[]).join('/')||String(m.CODIGO||"0");
    const carStr=Array.from(info.CARRERAS||[]).join('/')||String(m["CARRERAS QUE COMPARTEN"]||"0");
    const mallaStr=Array.from(info.MALLAS||[]).join('/')||String(m.MALLA||"0");

    secciones.push({
      MATERIA:m.MATERIA, CODIGO:codStr, "CÓDIGO ANTHOLOGY":codStr, CICLO:ciclo,
      NOMBRE_DOCENTE:elegido.NOMBRE_DOCENTE, CAP:parseInt($('#capacidadParalelo').value)||30, ASIGNADOS:0,
      DIA:slot.dia,HORA:slot.hora,Modalidad:elegido.Modalidad,Paralelo:"A",DEDICACION:elegido.DEDICACION||"",
      "HORAS TEÓRICAS":info["HORAS TEÓRICAS"]||0,"HORAS PRÁCTICAS":info["HORAS PRÁCTICAS"]||0,"HORAS AUTÓNOMAS":info["HORAS AUTÓNOMAS"]||0,
      CREDITOS:info.CREDITOS||0,"CAMPO DE FORMACIÓN":info["CAMPO DE FORMACIÓN"]||"0",MALLA:mallaStr,"Nº ORDEN EN LA MALLA":info["Nº ORDEN EN LA MALLA"]||0,"PRE-REQUISITO":info["PRE-REQUISITO"]||"0","CARRERAS QUE COMPARTEN":carStr
    });
    seccionesPorDoc.set(elegido.NOMBRE_DOCENTE,(seccionesPorDoc.get(elegido.NOMBRE_DOCENTE)||0)+1);
  }
  return {secciones,usoPorCiclo};
}

/* ================== Asignación (con carrera, bloqueos y edición) ================== */
function materiasPorCicloYCarrera(mallas){
  const map=new Map(); // Map<ciclo, Map<carreraNorm, Set<materia>>>
  for(const m of mallas){
    const ciclo=m.CICLO; const base=(map.get(ciclo)||new Map()); map.set(ciclo,base);
    const carreras=new Set([__norm(m.CARRERA), ...splitList(m["CARRERAS QUE COMPARTEN"]).map(__norm)]);
    for(const car of carreras){ if(!car) continue; const set=base.get(car)||new Set(); set.add(m.MATERIA); base.set(car,set); }
  }
  return map;
}
function asignarEstudiantes(secciones, estudiantes, mallas){
  const idx=new Map(); // `${ciclo}¦${materia}` -> [secciones]
  for(const s of secciones){ const k=`${s.CICLO}¦${s.MATERIA}`; const arr=idx.get(k)||[]; arr.push(s); idx.set(k,arr); }
  const porCicloCarr=materiasPorCicloYCarrera(mallas);

  const asig=[], noAsig=[];
  const max=parseInt($('#maxMaterias').value)||6;

  const estDay=new Map(); const estSlots=new Map();
  const canPlace=(e,d,h)=>{
    const b=BLOQUEOS.get(e)||new Set(); if(b.has(d+'|'+h)) return false;      // inglés/prácticas
    const cnt=estDay.get(e)?.get(d)||0; const s=estSlots.get(e)||new Set(); return cnt<2 && !s.has(`${d}|${h}`);
  };
  const mark=(e,d,h)=>{ const m=estDay.get(e)||new Map(); m.set(d,(m.get(d)||0)+1); estDay.set(e,m); const s=estSlots.get(e)||new Set(); s.add(`${d}|${h}`); estSlots.set(e,s); };

  for(const e of estudiantes){
    const carreraNorm=__norm(e.CARRERA);
    const matsSet=(porCicloCarr.get(e.CICLO)||new Map()).get(carreraNorm)||new Set();
    const materias=Array.from(matsSet);

    let cnt=0; const ya=new Set();
    for(const mat of materias){
      if(cnt>=max) break; if(ya.has(mat)) continue;
      const k=`${e.CICLO}¦${mat}`; const bucket=(idx.get(k)||[]).slice().sort((a,b)=>((b.CAP-b.ASIGNADOS)-(a.CAP-a.ASIGNADOS)));
      let placed=false;
      for(const s of bucket){
        if((s.CAP-s.ASIGNADOS)<=0) continue;
        if(!canPlace(e.ESTUDIANTE,s.DIA,s.HORA)) continue;
        s.ASIGNADOS++; cnt++; ya.add(mat); mark(e.ESTUDIANTE,s.DIA,s.HORA);
        asig.push(rowFromSecStudent(s,e));
        placed=true; break;
      }
      if(!placed) noAsig.push({ESTUDIANTE:e.ESTUDIANTE,MATERIA:mat,CICLO:e.CICLO,MOTIVO:"Sin cupo/horario compatible", "CARRERA DEL ESTUDIANTE":e.CARRERA});
    }
  }
  return {asig,noAsig};
}
function rowFromSecStudent(s,e){
  return {
    ESTUDIANTE:e.ESTUDIANTE, CICLO:e.CICLO, "CARRERA DEL ESTUDIANTE":e.CARRERA,
    NOMBRE_DOCENTE:s.NOMBRE_DOCENTE, MATERIA:s.MATERIA, "CANTIDAD DE ALUMNOS ESPERADOS":s.CAP,
    DIA:s.DIA, HORA:s.HORA, Modalidad:s.Modalidad, Paralelo:s.Paralelo,
    "CÓDIGO ANTHOLOGY":s.CODIGO||"0","CARRERAS QUE COMPARTEN":s["CARRERAS QUE COMPARTEN"]||"0","PRE-REQUISITO":s["PRE-REQUISITO"]||"0",
    CODIGO:s.CODIGO||"0","HORAS TEÓRICAS":s["HORAS TEÓRICAS"]||0,"HORAS PRÁCTICAS":s["HORAS PRÁCTICAS"]||0,"HORAS AUTÓNOMAS":s["HORAS AUTÓNOMAS"]||0,
    CREDITOS:s.CREDITOS||0,"CAMPO DE FORMACIÓN":s["CAMPO DE FORMACIÓN"]||"0",MALLA:s.MALLA||"0","Nº ORDEN EN LA MALLA":s["Nº ORDEN EN LA MALLA"]||0,
    "Nro. HORAS":(s["HORAS TEÓRICAS"]||0)+(s["HORAS PRÁCTICAS"]||0)
  };
}

/* ================== Render y filtros ================== */
function buildCareerFilter(careers){
  const sel=$('#careerFilter'); sel.innerHTML='<option value="__ALL__">Todas las carreras</option>'+careers.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('');
  show($('#filterBar')); $('#filterState').textContent='Sin filtro';
}
function applyFilters(){
  const v=$('#careerFilter').value; const q=($('#quickSearch').value||'').trim().toLowerCase();
  let filtered=(v==='__ALL__')?GLOBAL_ASIGNACIONES.slice():GLOBAL_ASIGNACIONES.filter(a=>__norm(a["CARRERA DEL ESTUDIANTE"])===__norm(v));
  if(q){ filtered=filtered.filter(a=>[a.ESTUDIANTE,a.MATERIA,a.NOMBRE_DOCENTE,a.Paralelo,a.DIA,a.HORA].map(x=>String(x||'').toLowerCase()).some(x=>x.includes(q))); }
  $('#chipCount').textContent=filtered.length;
  $('#filterState').textContent=(v==='__ALL__'&&!q)?'Sin filtro':`Carrera: ${v}${q?` • búsqueda: “${q}”`:""}`;
  renderAsignacionesTable(filtered);
}

/* ========== Tabla “Asignaciones” con botón Editar ========== */
let EDIT_INDEX=-1; // índice en GLOBAL_ASIGNACIONES
function renderAsignacionesTable(rows){
  const tb=$('#asigBody'); if(!rows.length){ tb.innerHTML='<tr><td colspan="11" style="text-align:center;color:#94a3b8;padding:22px">Sin datos</td></tr>'; return; }
  tb.innerHTML = rows.map((r,i)=>`
    <tr data-idx="${i}">
      <td><button class="btn ghost btnEdit" data-id="${r.__globalIndex}">Editar</button></td>
      <td>${esc(r.NOMBRE_DOCENTE)}</td>
      <td>${esc(r.MATERIA)}</td>
      <td>${esc(r["CANTIDAD DE ALUMNOS ESPERADOS"])}</td>
      <td>${esc(r.DIA)}</td>
      <td>${esc(r.HORA)}</td>
      <td>${esc(r.Modalidad)}</td>
      <td>${esc(r.Paralelo)}</td>
      <td>${esc(r.ESTUDIANTE)}</td>
      <td>${esc(r.CICLO)}</td>
      <td>${esc(r["CARRERA DEL ESTUDIANTE"])}</td>
    </tr>`).join('');
  tb.querySelectorAll('.btnEdit').forEach(b=>b.onclick=openEditModal);
}

/* Modal edición */
function openEditModal(ev){
  const gid=Number(ev.currentTarget.dataset.id);
  EDIT_INDEX = GLOBAL_ASIGNACIONES.findIndex(x=>x.__globalIndex===gid);
  const r = GLOBAL_ASIGNACIONES[EDIT_INDEX]; if(!r) return;
  $('#modalInfo').textContent=`${r.ESTUDIANTE} • ${r.MATERIA} • Docente: ${r.NOMBRE_DOCENTE}`;
  const dSel=$('#editDia'), hSel=$('#editHora'); dSel.innerHTML=''; hSel.innerHTML='';
  DIAS.forEach(d=>{ const opt=document.createElement('option'); opt.value=d; opt.textContent=d; if(d===r.DIA) opt.selected=true; dSel.appendChild(opt); });
  HORARIOS.forEach(h=>{ const opt=document.createElement('option'); opt.value=h; opt.textContent=h; if(h===r.HORA) opt.selected=true; hSel.appendChild(opt); });
  $('#modalBg').style.display='flex';
}
$('#btnCancel').onclick=()=>$('#modalBg').style.display='none';
$('#btnSave').onclick=()=>{
  if(EDIT_INDEX<0) return;
  const d=$('#editDia').value, h=$('#editHora').value;
  const row=GLOBAL_ASIGNACIONES[EDIT_INDEX];
  // Validar bloqueos/choques (conservando reglas)
  const key=row.ESTUDIANTE; const bl=BLOQUEOS.get(key)||new Set();
  if(bl.has(d+'|'+h)){ msgErr('El estudiante tiene bloqueo (Inglés/Prácticas) en ese horario.'); return; }
  // Chequeo simple de duplicación con su propio set (no tenemos historial por estudiante en UI, así que validamos contra filas visibles del mismo estudiante)
  const choque = GLOBAL_ASIGNACIONES.some((x,idx)=> idx!==EDIT_INDEX && x.ESTUDIANTE===row.ESTUDIANTE && x.DIA===d && x.HORA===h);
  if(choque){ msgErr('El estudiante ya tiene otra materia en ese día y hora.'); return; }
  // Actualizar
  row.DIA=d; row.HORA=h;
  $('#modalBg').style.display='none';
  applyFilters();
  msgOk('Asignación actualizada.');
};

/* ================== Calcular KPIs y tablas secundarias ================== */
function updateKpis(secciones, asignaciones, noAsig, resumen){
  $('#kSecc').textContent=secciones.length; $('#kAsig').textContent=asignaciones.length; $('#kNo').textContent=noAsig.length;
  let cap=0, as=0; resumen.forEach(m=>{cap+=(m.CAP||0); as+=(m.ASIGNADOS||0);});
  $('#kOcc').textContent=cap?Math.round((as/cap)*100)+'%':'0%'; show($('#kpis'));
}

/* ================== UI: uploads y acciones ================== */
function bindUpload(id,dotId,nameId,optional=false){
  const f=$(id), dot=$(dotId), name=$(nameId);
  f.addEventListener('change', ()=>{ if(f.files?.length){ dot.classList.add('ok'); name.textContent=f.files[0].name; }else{ dot.classList.remove('ok'); name.textContent=optional?'No cargado':'Esperando archivo…'; } validateReady(); });
}
function validateReady(){ $('#btnRun').disabled = !($('#fileDoc').files.length && $('#fileEst').files.length && $('#fileMal').files.length); }
bindUpload('#fileDoc','#dotDoc','#nameDoc'); bindUpload('#fileEst','#dotEst','#nameEst'); bindUpload('#fileMal','#dotMal','#nameMal');
bindUpload('#fileIng','#dotIng','#nameIng',true); bindUpload('#filePra','#dotPra','#namePra',true);

$('#careerFilter').addEventListener('change',applyFilters);
let __deb; $('#quickSearch').addEventListener('input',()=>{clearTimeout(__deb); __deb=setTimeout(applyFilters,160);});
$('#clearFilters').addEventListener('click',()=>{$('#careerFilter').value='__ALL__'; $('#quickSearch').value=''; applyFilters();});

/* ================== Acciones principales ================== */
$('#btnRun').addEventListener('click', async ()=>{
  const fD=$('#fileDoc').files[0], fE=$('#fileEst').files[0], fM=$('#fileMal').files[0];
  const fI=$('#fileIng').files[0], fP=$('#filePra').files[0];
  try{
    setProgress(5);
    const [rowsD,rowsE,rowsM,rowsI,rowsP]=await Promise.all([readSheet(fD,'DOCENTES'),readSheet(fE,'ESTUDIANTES'),readSheet(fM,'MALLA'),readSheet(fI,'INGLÉS'),readSheet(fP,'PRÁCTICAS')]);
    setProgress(30);
    const DOC=normalizeDocentes(rowsD), EST=normalizeEstudiantes(rowsE), MAL=normalizeMallas(rowsM);
    const BLOQ_ING=normalizeBloqueos(rowsI), BLOQ_PRA=normalizeBloqueos(rowsP);
    addBloqueos([...BLOQ_ING, ...BLOQ_PRA]); // pueden estar vacíos
    if(!(DOC.length && EST.length && MAL.length)) throw new Error('Datos insuficientes.');
    setProgress(55);
    const {secciones,usoPorCiclo}=construirSecciones(DOC,MAL,EST);
    setProgress(75);
    const {asig,noAsig}=asignarEstudiantes(secciones,EST,MAL);

    // OUTPUTS
    OUT_SECC=secciones.map(s=>({NOMBRE_DOCENTE:s.NOMBRE_DOCENTE, MATERIA:s.MATERIA, "CANTIDAD DE ALUMNOS ESPERADOS":s.CAP, DIA:s.DIA, HORA:s.HORA, Modalidad:s.Modalidad, Paralelo:s.Paralelo}));
    OUT_COMB=asig.map(a=>({NOMBRE_DOCENTE:a.NOMBRE_DOCENTE, MATERIA:a.MATERIA, "CANTIDAD DE ALUMNOS ESPERADOS":a["CANTIDAD DE ALUMNOS ESPERADOS"], DIA:a.DIA, HORA:a.HORA, Modalidad:a.Modalidad, Paralelo:a.Paralelo, ESTUDIANTE:a.ESTUDIANTE, CICLO:a.CICLO, "CARRERA DEL ESTUDIANTE":a["CARRERA DEL ESTUDIANTE"]}));
    OUT_NO=noAsig;

    // carga docente
    OUT_CARGA=secciones.map(s=>({DOCENTE:s.NOMBRE_DOCENTE,MATERIA:s.MATERIA,Paralelo:s.Paralelo,DIA:s.DIA,HORA:s.HORA,ASIGNADOS:s.ASIGNADOS,CAP:s.CAP}));
    // resumen materia
    const rm=new Map(); for(const s of secciones){ const k=`${s.MATERIA}¦${s.Paralelo}`; const o=rm.get(k)||{MATERIA:s.MATERIA,Paralelo:s.Paralelo,ASIGNADOS:0,CAP:0,OCUPACION:'0%'}; o.ASIGNADOS+=s.ASIGNADOS; o.CAP+=s.CAP; rm.set(k,o); }
    OUT_RES_MAT=Array.from(rm.values()).map(o=>({...o,OCUPACION:o.CAP?Math.round(o.ASIGNADOS/o.CAP*100)+'%':'0%'}));

    // plan-docentes y proyección
    OUT_PLAN_DOC=asig.map(a=>({"DOCENTE":a.NOMBRE_DOCENTE,"MATERIA":a.MATERIA,"CÓDIGO ANTHOLOGY":a["CÓDIGO ANTHOLOGY"],"CARRERAS QUE COMPARTEN":a["CARRERAS QUE COMPARTEN"],"PRE-REQUISITO":a["PRE-REQUISITO"],"CODIGO":a.CODIGO,"HORAS TEÓRICAS":a["HORAS TEÓRICAS"],"HORAS PRÁCTICAS":a["HORAS PRÁCTICAS"],"HORAS AUTÓNOMAS":a["HORAS AUTÓNOMAS"],"CREDITOS":a.CREDITOS,"CAMPO DE FORMACIÓN":a["CAMPO DE FORMACIÓN"],"CICLO":a.CICLO,"MALLA":a.MALLA,"Nº ORDEN EN LA MALLA":a["Nº ORDEN EN LA MALLA"],"PARALELO":a.Paralelo,"DIA":a.DIA,"HORA":a.HORA,"Modalidad":a.Modalidad,"Nro. HORAS":a["Nro. HORAS"],"NOMBRE DEL ESTUDIANTE":a.ESTUDIANTE,"CARRERA DEL ESTUDIANTE":a["CARRERA DEL ESTUDIANTE"],"CICLO DEL ESTUDIANTE":a.CICLO,"NIVEL INGLES":a.NIVEL_INGLES||"0","OBSERVACIONES":"0"}));
    const mp=new Map(); const idx=new Map();
    for(const s of secciones){ const k=`${s.MATERIA}¦${s.CICLO}`; const o=idx.get(k)||{PAR:0,CAP:0,DOC:new Set()}; o.PAR++;o.CAP+=s.CAP;o.DOC.add(s.NOMBRE_DOCENTE); idx.set(k,o);}
    for(const a of OUT_PLAN_DOC){ const k=`${a.MATERIA}¦${a.CICLO}`; const o=mp.get(k)||{MATERIA:a.MATERIA,CICLO:a.CICLO,TOTAL:0,CARR:new Map()}; o.TOTAL++; o.CARR.set(a["CARRERA DEL ESTUDIANTE"],(o.CARR.get(a["CARRERA DEL ESTUDIANTE"])||0)+1); mp.set(k,o);}
    OUT_PROY=Array.from(mp.values()).map(o=>{ const k=`${o.MATERIA}¦${o.CICLO}`; const z=idx.get(k)||{PAR:0,CAP:0,DOC:new Set()}; return {"MATERIA":o.MATERIA,"CICLO":o.CICLO,"TOTAL ESTUDIANTES":o.TOTAL,"PARALELOS":z.PAR,"CAPACIDAD TOTAL":z.CAP,"DOCENTES":Array.from(z.DOC).join(' / '),"DETALLE POR CARRERA":Array.from(o.CARR.entries()).map(([c,n])=>`${c}: ${n}`).join(' / ')}; });

    // pintar tabla asignaciones con “Editar”
    GLOBAL_ASIGNACIONES = OUT_COMB.map((r,idx)=>({...r, __globalIndex: idx}));
    const careers = Array.from(new Set(GLOBAL_ASIGNACIONES.map(a=>a["CARRERA DEL ESTUDIANTE"]).filter(Boolean))).sort();
    buildCareerFilter(careers); applyFilters();

    updateKpis(OUT_SECC, OUT_COMB, OUT_NO, OUT_RES_MAT);
    $('#btnDown').disabled=false;
    setProgress(100); msgOk('Procesamiento completado.');
  }catch(e){ msgErr(e.message); }
  finally{ setTimeout(()=>$('#progress').style.display='none',800); }
});

$('#btnDown').addEventListener('click', ()=>{
  try{
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_SECC), 'MATRIZ_SECCIONES');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_COMB), 'COMBINACION');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_CARGA), 'RESUMEN_CARGA');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_RES_MAT), 'RESUMEN_MATERIA');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_NO), 'NO_ASIGNADOS');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_PLAN_DOC), 'PLANIFICACION_DOCENTES');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_PROY), 'PROYECCION_POR_MATERIA');
    XLSX.writeFile(wb, 'Planificacion_Asignacion_Docente.xlsx');
    msgOk('Archivo exportado.');
  }catch(e){ msgErr(e.message); }
});
</script>
</body>
</html>
