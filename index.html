<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lector de Mallas 2019/2023</title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table, th, td { border: 1px solid #888; border-collapse: collapse; padding: 5px; }
    th { background-color: #a52a2a; color: white; }
    select, input[type=file], button { margin: 10px; padding: 5px; }
    .error { color: red; }
  </style>
</head>
<body>
  <h2>Malla a Filas (con ceros garantizados + prerrequisito editable)</h2>

  <label>Carrera:
    <select id="carrera">
      <option>Administración</option>
      <option>Negocios Internacionales</option>
      <option>Marketing</option>
    </select>
  </label>

  <label>Año de malla:
    <select id="anio">
      <option>2019</option>
      <option>2023</option>
    </select>
  </label>

  <label>Formato:
    <select id="formato">
      <option value="2019">Vertical (2019)</option>
      <option value="2023">Horizontal (2023)</option>
    </select>
  </label>

  <input type="file" id="file" accept=".xlsx">
  <button onclick="descargarExcel()">Descargar como Excel</button>

  <p class="error" id="msg"></p>

  <table id="tabla">
    <thead>
      <tr>
        <th>CARRERA</th><th>AÑO</th><th>CICLO</th><th>MATERIA</th><th>CÓDIGO</th>
        <th>HORAS TEÓRICAS</th><th>HORAS PRÁCTICAS</th><th>HORAS AUTÓNOMAS</th><th>PRERREQUISITO</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
let materias = [];

function num(val) {
  return (val === undefined || val === null || val === "") ? 0 : Number(val);
}

function procesarDatosVertical(json, carrera, anio) {
  materias = [];
  for (let col = 1; col < json[0].length; col++) {
    const ciclo = json[0][col];
    for (let row = 1; row < json.length - 3; row += 4) {
      const nombre = json[row]?.[col];
      const codigo = json[row+1]?.[col];
      const ht = num(json[row+1]?.[col+1]);
      const hp = num(json[row+1]?.[col+2]);
      const ha = num(json[row+1]?.[col+3]);
      if (nombre && codigo && !nombre.includes("TOTAL") && !codigo.includes("TOTAL")) {
        materias.push({ CARRERA: carrera, AÑO: anio, CICLO: ciclo, MATERIA: nombre, CÓDIGO: codigo, "HORAS TEÓRICAS": ht, "HORAS PRÁCTICAS": hp, "HORAS AUTÓNOMAS": ha, PRERREQUISITO: "" });
      }
    }
  }
}

function procesarDatosHorizontal(json, carrera, anio) {
  materias = [];
  const ciclos = json[0];
  for (let col = 0; col < ciclos.length; col++) {
    if (!ciclos[col]) continue;
    const ciclo = ciclos[col];
    for (let row = 3; row < json.length; row += 5) {
      const nombre = json[row]?.[col];
      const codigo = json[row+1]?.[col];
      const ht = num(json[row+1]?.[col+1]);
      const hp = num(json[row+1]?.[col+2]);
      const ha = num(json[row+1]?.[col+3]);
      if (nombre && codigo && !nombre.includes("TOTAL") && !codigo.includes("TOTAL")) {
        materias.push({ CARRERA: carrera, AÑO: anio, CICLO: ciclo, MATERIA: nombre, CÓDIGO: codigo, "HORAS TEÓRICAS": ht, "HORAS PRÁCTICAS": hp, "HORAS AUTÓNOMAS": ha, PRERREQUISITO: "" });
      }
    }
  }
}

document.getElementById('file').addEventListener('change', (e) => {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = (ev) => {
    const data = new Uint8Array(ev.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const hoja = workbook.SheetNames[0];
    const json = XLSX.utils.sheet_to_json(workbook.Sheets[hoja], { header: 1 });
    const carrera = document.getElementById('carrera').value;
    const anio = document.getElementById('anio').value;
    const formato = document.getElementById('formato').value;
    if (formato === "2019") {
      procesarDatosVertical(json, carrera, anio);
    } else {
      procesarDatosHorizontal(json, carrera, anio);
    }
    mostrarTabla();
  };
  reader.readAsArrayBuffer(file);
});

function mostrarTabla() {
  const tbody = document.querySelector("#tabla tbody");
  tbody.innerHTML = "";
  if (materias.length === 0) {
    document.getElementById('msg').textContent = "No se encontraron materias válidas.";
    return;
  }
  document.getElementById('msg').textContent = "";
  materias.forEach(m => {
    const tr = document.createElement("tr");
    Object.values(m).forEach(v => {
      const td = document.createElement("td");
      td.contentEditable = true;
      td.textContent = v;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function descargarExcel() {
  if (materias.length === 0) return;
  const ws = XLSX.utils.json_to_sheet(materias);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Planificacion");
  XLSX.writeFile(wb, "planificacion_materias.xlsx");
}
</script>
</body>
</html>
