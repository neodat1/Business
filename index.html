<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Sistema de Planificaci√≥n Acad√©mica</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  /* ======= SU TEMA ORIGINAL (INTEGRO) ======= */
  :root {
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --primary-light: #dbeafe;
    --secondary: #64748b;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #0f172a;
    --light: #f8fafc;
    --border: #e2e8f0;
    --radius: 12px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter','Segoe UI',system-ui,sans-serif; background:#f1f5f9; color:var(--dark); line-height:1.6; padding:0; }
  .app-container{ max-width:1800px; margin:0 auto; padding:20px; }
  .app-header{ background:white; border-radius:var(--radius); box-shadow:var(--shadow); padding:24px; margin-bottom:24px; border-left:4px solid var(--primary); }
  .app-title{ font-size:28px; font-weight:700; color:var(--primary); margin-bottom:8px; display:flex; align-items:center; gap:12px; }
  .app-subtitle{ color:var(--secondary); font-size:16px; margin-bottom:20px; }
  .card{ background:white; border-radius:var(--radius); box-shadow:var(--shadow); padding:24px; margin-bottom:24px; transition:transform .2s ease, box-shadow .2s ease; }
  .card:hover{ transform:translateY(-2px); box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05); }
  .card-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--border); }
  .card-title{ font-size:18px; font-weight:600; color:var(--dark); }
  .file-section{ display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:16px; margin-bottom:24px; }
  .file-input-container{ position:relative; }
  .file-label{ display:block; font-weight:600; margin-bottom:8px; color:var(--dark); }
  .file-input{ width:100%; padding:12px 16px; border:2px dashed var(--border); border-radius:var(--radius); background:var(--light); font-size:14px; cursor:pointer; transition:all .3s ease;}
  .file-input:hover{ border-color:var(--primary); background:#f0f7ff; }
  .file-status{ display:flex; align-items:center; gap:8px; margin-top:8px; font-size:14px; }
  .status-icon{ width:12px; height:12px; border-radius:50%; flex-shrink:0; }
  .status-pending{ background-color:var(--warning); }
  .status-success{ background-color:var(--success); }
  .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 20px; border-radius:var(--radius); border:none; font-weight:600; font-size:14px; cursor:pointer; transition:all .2s ease; }
  .btn-primary{ background:var(--primary); color:white; }
  .btn-primary:hover{ background:var(--primary-dark); }
  .btn-secondary{ background:white; color:var(--dark); border:1px solid var(--border); }
  .btn-secondary:hover{ background:var(--light); }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }
  .btn-group{ display:flex; gap:12px; margin:20px 0; }
  .progress-container{ width:100%; height:8px; background:var(--border); border-radius:4px; overflow:hidden; margin:16px 0; display:none; }
  .progress-bar{ height:100%; background:linear-gradient(90deg, var(--primary), var(--primary-light)); width:0%; transition:width .4s ease; border-radius:4px; }
  .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin:20px 0; }
  .stat-card{ background:var(--light); border-radius:var(--radius); padding:16px; text-align:center; border-left:4px solid var(--primary); }
  .stat-value{ font-size:28px; font-weight:700; color:var(--primary); margin-bottom:4px; }
  .stat-label{ font-size:14px; color:var(--secondary); }
  .config-panel{ background:var(--light); border-radius:var(--radius); padding:20px; margin:20px 0; }
  .config-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:16px; }
  .config-item{ margin-bottom:12px; }
  .config-label{ display:block; font-weight:600; margin-bottom:8px; color:var(--dark); }
  .config-input{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:14px; transition:border-color .2s ease; }
  .config-input:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,99,235,.1); }
  .time-slots{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .time-slot{ padding:6px 12px; background:var(--primary-light); color:var(--primary); border-radius:20px; font-size:12px; font-weight:500; }
  .table-container{ border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; margin:16px 0; max-height:400px; overflow:auto; position:relative; }
  table{ width:100%; border-collapse:collapse; font-size:14px; }
  th{ background:#f8fafc; padding:12px; text-align:left; font-weight:600; color:var(--dark); position:sticky; top:0; border-bottom:2px solid var(--border); }
  .table-container thead th{ position:sticky; top:0; z-index:5; background:#fff; box-shadow:0 1px 0 0 var(--border); }
  td{ padding:12px; border-bottom:1px solid var(--border); }
  tr:hover{ background:#f1f5f9; }
  .alert{ padding:16px; border-radius:var(--radius); margin:16px 0; display:flex; align-items:flex-start; gap:12px; }
  .alert-error{ background:#fef2f2; color:var(--danger); border-left:4px solid var(--danger); }
  .alert-info{ background:#eff6ff; color:var(--primary); border-left:4px solid var(--primary); }
  .alert-success{ background:#f0fdf4; color:var(--success); border-left:4px solid var(--success); }
  .alert-icon{ font-size:20px; flex-shrink:0; }
  .badge{ display:inline-block; padding:4px 10px; border-radius:20px; font-size:12px; font-weight:600; }
  .badge-primary{ background:var(--primary-light); color:var(--primary); }
  .badge-success{ background:#d1fae5; color:var(--success); }
  .badge-warning{ background:#fef3c7; color:var(--warning); }
  .badge-danger{ background:#fee2e2; color:var(--danger); }
  .grid-2{ display:grid; grid-template-columns:1fr; gap:24px; }
  @media (min-width:992px){ .grid-2{ grid-template-columns:1fr 1fr; } }
  .text-muted{ color:var(--secondary); font-size:14px; }
  .text-center{ text-align:center; }
  .hidden{ display:none; }
  .loading{ opacity:.7; pointer-events:none; }
  .mt-2{ margin-top:16px; }
  .mb-2{ margin-bottom:16px; }
  @keyframes fadeIn{ from{opacity:0;} to{opacity:1;} }
  .fade-in{ animation:fadeIn .3s ease; }
  .tabs{ display:flex; border-bottom:1px solid var(--border); margin-bottom:16px; }
  .tab{ padding:10px 20px; cursor:pointer; border-bottom:2px solid transparent; transition:all .2s ease; }
  .tab.active{ border-bottom-color:var(--primary); color:var(--primary); font-weight:600; }
  .tab-content{ display:none; }
  .tab-content.active{ display:block; }
  .instructions{ background:#f0f9ff; border-left:4px solid var(--primary); padding:16px; border-radius:8px; margin-bottom:20px; }
  .instructions h3{ margin-bottom:10px; color:var(--primary); }
  .instructions ul{ padding-left:20px; }
  .instructions li{ margin-bottom:8px; }
  .matrix-container{ overflow:auto; max-height:600px; margin:20px 0; border:1px solid var(--border); border-radius:var(--radius); }
  .matrix-table{ width:100%; border-collapse:collapse; min-width:2200px; }
  .matrix-table th{ background:#e0f2fe; position:sticky; top:0; z-index:10; }
  .matrix-table th:nth-child(1), .matrix-table th:nth-child(2){ background:#bae6fd; }
  .matrix-table th:nth-child(-n+5){ background:#7dd3fc; }
  .matrix-table th:nth-child(-n+10){ background:#38bdf8; }
  .matrix-table th:nth-child(-n+15){ background:#0ea5e9; }
  .section-header{ background:#f8fafc; font-weight:600; color:var(--primary); }

  /* Ajuste tipograf√≠a */
  body, table, th, td, .config-input, .tab, .stat-label{ font-size:12px !important; }
  .matrix-table{ font-size:11px !important; }

  /* ======= Branding UIDE (override sin borrar nada) ======= */
  :root{ --uide-blue:#04136C; --uide-mustard:#DE912E; --uide-wine:#A62939; --uide-sky:#9CBEE3; --uide-green:#8A952D; }
  :root{
    --primary: var(--uide-blue);
    --primary-dark:#021048;
    --primary-light: var(--uide-sky);
    --secondary:#445168;
    --warning:var(--uide-mustard);
    --danger:var(--uide-wine);
    --success:var(--uide-green);
    --light:#f7fafc;
  }
  .uide-brand{ background:linear-gradient(135deg, rgba(156,190,227,.25) 0%, #ffffff 55%); border-left-color:var(--uide-wine) !important; position:relative; overflow:hidden; }
  .uide-brand::before{ content:""; position:absolute; left:0; top:0; height:6px; width:100%; background:linear-gradient(90deg,var(--uide-wine),var(--uide-mustard),var(--uide-green),var(--uide-blue)); }
  .brand-logo{ height:42px; width:auto; object-fit:contain; filter:drop-shadow(0 2px 2px rgba(0,0,0,.08)); }
  .btn-primary{ background:var(--uide-blue); } .btn-primary:hover{ background:#021048; }
  .badge-primary{ background:rgba(4,19,108,.08); color:var(--uide-blue); }
  .tabs{ border-bottom-color:rgba(4,19,108,.15); }
  .tab.active{ border-bottom-color:var(--uide-wine); color:var(--uide-wine); }
  .stat-card{ border-left-color:var(--uide-mustard); background:linear-gradient(180deg,#fff,rgba(222,145,46,.06)); }
  .instructions{ background:rgba(156,190,227,.25); border-left-color:var(--uide-blue); }
  .table-container th{ background:rgba(4,19,108,.05); }

  /* Ocultar Nota y chips horarios */
  .alert.alert-info{ display:none !important; }
  .time-slots{ display:none !important; }

  /* Barra de filtro por carrera */
  #careerFilterBar{ display:none; gap:12px; align-items:center; margin:12px 0 0 0; }
  #careerFilter{ padding:8px 12px; border:1px solid var(--border); border-radius:8px; max-width:320px; }

  /* Ocultaciones de pesta√±as antiguas (se reactivan con nuevas vistas) */
  .tab[data-tab="carga-docente"],
  .tab[data-tab="resumen-materia"],
  .tab[data-tab="no-asignados"],
  #carga-docente,#resumen-materia,#no-asignados{ display:none !important; }

  /* Filtros mejorados */
  .filter-bar{
    position:sticky; top:0; z-index:20;
    display:grid; grid-template-columns:1fr 1.2fr auto; gap:12px;
    align-items:end; padding:10px 12px; margin-top:8px;
    background:#fff; border:1px solid var(--border);
    border-radius:10px; box-shadow:var(--shadow);
  }
  .filter-label{ font-size:11px; font-weight:600; color:var(--secondary); display:block; margin-bottom:6px; }
  .filter-select{
    appearance:none; width:100%; padding:10px 36px 10px 12px; border:1px solid var(--border);
    border-radius:10px; background:linear-gradient(180deg,#fff,#f9fafb); font-size:13px;
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23445168" viewBox="0 0 16 16"><path d="M3.2 5.5l4.8 4.8 4.8-4.8" stroke="%23445168" stroke-width="1.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>');
    background-repeat:no-repeat; background-position:right 10px center;
  }
  .filter-search{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:13px; background:#fff; }
  .filter-search:focus, .filter-select:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(4,19,108,.12); }
  .filter-chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px; background:rgba(4,19,108,.08); color:var(--uide-blue); white-space:nowrap; }
  .btn-clear{ white-space:nowrap; padding:10px 14px; }
  @media (max-width:720px){ .filter-bar{ grid-template-columns:1fr; gap:8px; } .filter-right{ display:flex; gap:8px; align-items:center; } }

  /* ========= NUEVO: Modal de edici√≥n para estudiantes ========= */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:50; }
  .modal.open{ display:flex; }
  .modal-card{ width:min(900px,96vw); background:#fff; border-radius:14px; box-shadow:var(--shadow); overflow:hidden; }
  .modal-hd{ padding:14px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
  .modal-bd{ padding:18px; }
  .modal-ft{ padding:14px 18px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; }
  .grid-3{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
  .danger{ color:var(--danger); font-weight:600; }
</style>
</head>
<body>
<div class="app-container">
  <header class="app-header uide-brand">
    <h1 class="app-title">
      <img src="UIDE-Ecuador.png" alt="UIDE" class="brand-logo"/>
      Sistema de Planificaci√≥n Acad√©mica
    </h1>
    <p class="app-subtitle">Asignaci√≥n automatizada de estudiantes a materias y docentes</p>
  </header>

  <div class="instructions">
    <h3>Instrucciones de uso:</h3>
    <ul>
      <li>Cargue los archivos Excel con los formatos especificados</li>
      <li>El sistema asignar√° las materias seg√∫n el <strong>ciclo al que va</strong> cada estudiante</li>
      <li>Se respetar√° la disponibilidad de d√≠as y horas de los docentes</li>
      <li>M√°ximo de materias por estudiante: 6</li>
      <li>M√°ximo de estudiantes por paralelo: 30</li>
      <li>Horarios disponibles: 7:00-10:00, 10:00-13:00, 13:00-16:00, 16:00-19:00, 19:00-22:00</li>
      <li><strong>M√°ximo de 2 materias por d√≠a</strong> para docentes y estudiantes; sin choques de d√≠a/hora</li>
      <li>Estudiantes con ciclo <strong>9</strong> (graduado) no se consideran</li>
    </ul>
  </div>

  <!-- ===== NUEVO: Solicitud opcional de Ingl√©s y Pr√°cticas ===== -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Restricciones opcionales (Ingl√©s y Pr√°cticas)</h3>
      <span class="badge badge-warning">Opcional</span>
    </div>
    <div class="file-section">
      <div class="file-input-container">
        <label class="file-label">INGLES.xlsx (Opcional)</label>
        <input id="fileIng" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status" id="statusIng">
          <span class="status-icon status-pending"></span>
          <span>Opcional - Esperando archivo...</span>
        </div>
        <p class="text-muted mt-2">Formato sugerido: <em>ESTUDIANTE, DIA, HORA</em> (bloquea ese bloque para el estudiante).</p>
      </div>
      <div class="file-input-container">
        <label class="file-label">PRACTICAS.xlsx (Opcional)</label>
        <input id="filePra" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status" id="statusPra">
          <span class="status-icon status-pending"></span>
          <span>Opcional - Esperando archivo...</span>
        </div>
        <p class="text-muted mt-2">Formato sugerido: <em>ESTUDIANTE, DIA, HORA</em> (bloquea ese bloque para el estudiante).</p>
      </div>
    </div>
  </div>
  <!-- ===== FIN NUEVO ===== -->

  <div class="card">
    <div class="alert alert-info">
      <span class="alert-icon">üí°</span>
      <div>
        <strong>Nota:</strong> El sistema organizar√° autom√°ticamente los horarios evitando cruces entre materias del mismo ciclo.
        Las materias se asignar√°n seg√∫n el ciclo al que va cada estudiante y la disponibilidad de los docentes. 
        Se usar√°n todos los campos de MALLA (c√≥digos, horas, cr√©ditos, campo, pre-requisitos, carreras que comparten). 
        Campos vac√≠os se rellenan con <strong>0</strong>. ‚ÄúCarreras que comparten‚Äù y ‚ÄúC√≥digos‚Äù se unen con ‚Äú/‚Äù.
      </div>
    </div>

    <div class="alert alert-error hidden" id="errorBox">
      <span class="alert-icon">‚ö†Ô∏è</span>
      <div>
        <strong>Error:</strong> <span id="errorMessage"></span>
      </div>
    </div>

    <div class="config-panel">
      <h3 class="card-title">Configuraci√≥n del Sistema</h3>
      <div class="config-grid">
        <div class="config-item">
          <label class="config-label" for="maxMaterias">M√°ximo de materias por estudiante</label>
          <input type="number" id="maxMaterias" class="config-input" value="6" min="1" max="10">
        </div>
        <div class="config-item">
          <label class="config-label" for="capacidadParalelo">Capacidad m√°xima por paralelo</label>
          <input type="number" id="capacidadParalelo" class="config-input" value="30" min="5" max="60">
        </div>
      </div>
    </div>

    <div class="file-section">
      <div class="file-input-container">
        <label class="file-label">DOCENTES.xlsx</label>
        <input id="fileDoc" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status" id="statusDoc">
          <span class="status-icon status-pending"></span>
          <span>Esperando archivo...</span>
        </div>
      </div>
      <div class="file-input-container">
        <label class="file-label">ESTUDIANTES.xlsx</label>
        <input id="fileEst" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status" id="statusEst">
          <span class="status-icon status-pending"></span>
          <span>Esperando archivo...</span>
        </div>
      </div>
      <div class="file-input-container">
        <label class="file-label">MALLA.xlsx</label>
        <input id="fileMal" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status" id="statusMal">
          <span class="status-icon status-pending"></span>
          <span>Esperando archivo...</span>
        </div>
      </div>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="btn-group">
      <button id="btnRun" class="btn btn-primary" disabled>Procesar Asignaci√≥n</button>
      <button id="btnDown" class="btn btn-secondary hidden">Descargar Planificaci√≥n</button>
    </div>

    <div class="stats-grid" id="statsContainer" style="display: none;">
      <div class="stat-card"><div class="stat-value" id="statSecciones">0</div><div class="stat-label">Secciones creadas</div></div>
      <div class="stat-card"><div class="stat-value" id="statAsignaciones">0</div><div class="stat-label">Asignaciones realizadas</div></div>
      <div class="stat-card"><div class="stat-value" id="statNoAsignados">0</div><div class="stat-label">Estudiantes no asignados</div></div>
      <div class="stat-card"><div class="stat-value" id="statOcupacion">0%</div><div class="stat-label">Ocupaci√≥n promedio</div></div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="asignaciones">Asignaciones</div>
    <div class="tab" data-tab="plan-est">Planificaci√≥n Estudiante</div>
  </div>

  <div class="tab-content active" id="asignaciones">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Asignaciones Realizadas</h3>
        <span class="badge badge-primary" id="asignacionesCount">0</span>
      </div>

      <!-- Filtros -->
      <div id="careerFilterBar" class="filter-bar" style="display:none">
        <div class="filter-left">
          <label for="careerFilter" class="filter-label">Carrera</label>
          <select id="careerFilter" class="filter-select">
            <option value="__ALL__">Todas las carreras</option>
          </select>
        </div>
        <div class="filter-middle">
          <label for="quickSearch" class="filter-label">Buscar</label>
          <input id="quickSearch" type="search" class="filter-search" placeholder="Estudiante, materia o docente‚Ä¶"/>
        </div>
        <div class="filter-right">
          <span class="filter-chip" id="careerActive">Sin filtro</span>
          <button id="clearFilters" class="btn btn-secondary btn-clear" type="button">Limpiar</button>
        </div>
      </div>

      <div class="table-container">
        <div id="tblCombo"></div>
      </div>
      <p class="text-muted">Doble clic en una fila para <strong>editar al estudiante</strong> (d√≠a/hora o reasignar materia). Se validan conflictos y se le indicar√° si existe cruce.</p>
    </div>
  </div>

  <!-- NUEVA VISTA: Planificaci√≥n Estudiante -->
  <div class="tab-content" id="plan-est">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">PLANIFICACI√ìN ESTUDIANTE</h3>
        <span class="badge badge-primary" id="planEstCount">0</span>
      </div>
      <div class="table-container">
        <div id="tblPlanEst"></div>
      </div>
    </div>
  </div>

  <!-- Modal Edici√≥n Estudiante -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-hd">
        <strong>Editar asignaci√≥n del estudiante</strong>
        <button id="btnCloseModal" class="btn btn-secondary">Cerrar</button>
      </div>
      <div class="modal-bd">
        <div class="grid-3">
          <div>
            <label class="config-label">Estudiante</label>
            <input id="edtEst" class="config-input" disabled>
          </div>
          <div>
            <label class="config-label">Materia actual</label>
            <input id="edtMat" class="config-input" disabled>
          </div>
          <div>
            <label class="config-label">Docente</label>
            <input id="edtDoc" class="config-input" disabled>
          </div>
          <div>
            <label class="config-label">D√≠a</label>
            <select id="edtDia" class="config-input">
              <option>LUNES</option><option>MARTES</option><option>MIERCOLES</option>
              <option>JUEVES</option><option>VIERNES</option><option>SABADO</option>
            </select>
          </div>
          <div>
            <label class="config-label">Hora</label>
            <select id="edtHora" class="config-input">
              <option>07:00-10:00</option><option>10:00-13:00</option><option>13:00-16:00</option>
              <option>16:00-19:00</option><option>19:00-22:00</option>
            </select>
          </div>
          <div>
            <label class="config-label">Reasignar a Materia (opcional)</label>
            <select id="edtReMat" class="config-input">
              <option value="">(Mantener materia)</option>
            </select>
          </div>
        </div>
        <p id="edtMsg" class="mt-2"></p>
      </div>
      <div class="modal-ft">
        <button id="btnSaveEdit" class="btn btn-primary">Guardar cambios</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===================== SU JS ORIGINAL (INTEGRO) ===================== */
/*  Nota: Se conserva estructura y nombres. Las MEJORAS se a√±aden
    despu√©s como overrides y nuevas funciones, sin borrar lo previo.   */

let __DOCENTE_SLOTS__ = new Map();
const TARGET7 = ["NOMBRE_DOCENTE","MATERIA","CANTIDAD DE ALUMNOS ESPERADOS","DIA","HORA","Modalidad","Paralelo"];
const COMBO9  = [...TARGET7,"DEDICACI√ìN","ESTUDIANTE","CICLO"];
const DAY_MAP = new Map(Object.entries({
  "lun":"LUNES","lunes":"LUNES","lun.":"LUNES",
  "mar":"MARTES","martes":"MARTES","mar.":"MARTES",
  "mie":"MIERCOLES","mi√©":"MIERCOLES","miercoles":"MIERCOLES","mi√©rcoles":"MIERCOLES","mie.":"MIERCOLES","mi√©.":"MIERCOLES",
  "jue":"JUEVES","jueves":"JUEVES","jue.":"JUEVES",
  "vie":"VIERNES","viernes":"VIERNES","vie.":"VIERNES",
  "sab":"SABADO","s√°b":"SABADO","sabado":"SABADO","s√°bado":"SABADO","sab.":"SABADO",
  "dom":"DOMINGO","domingo":"DOMINGO","dom.":"DOMINGO"
}));
const HORARIOS = ["07:00-10:00","10:00-13:00","13:00-16:00","16:00-19:00","19:00-22:00"];
const __norm = s => String(s ?? "").toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
const __splitList = s => String(s ?? "").split(/[,;/]| Y | E /i).map(x=>x.trim()).filter(Boolean);
function normalizarHorario(h){ if(!h)return null; const raw=String(h).toUpperCase().trim(); if(HORARIOS.includes(raw)) return raw; const re=/(\d{1,2})(?::(\d{2}))?\s*(?:-|‚Äì|‚Äî|A|AL|A LAS|A LOS|TO)\s*(\d{1,2})(?::(\d{2}))?/i; const m=raw.match(re); if(!m) return null; const hIni=m[1].padStart(2,'0'); const mIni=(m[2]??'00').padStart(2,'0'); const start=`${hIni}:${mIni}`; return HORARIOS.find(b=>b.startsWith(start))||null; }
const canonDay = s => { if(!s)return ""; const t=String(s).toLowerCase().trim(); if(DAY_MAP.has(t)) return DAY_MAP.get(t); for(const [k,v] of DAY_MAP.entries()){ if(t.includes(k)) return v; } return t.toUpperCase(); };
const esc = s => { if(s===null||s===undefined) return ""; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); };
const val = s => (s===null||s===undefined||s==="") ? "0" : s;
function showError(m){ const b=document.getElementById('errorBox'); const t=document.getElementById('errorMessage'); t.textContent=m; b.classList.remove('hidden'); setTimeout(()=>{b.classList.add('hidden');},8000); }
function showSuccess(m){ const a=document.createElement('div'); a.className='alert alert-success fade-in'; a.innerHTML=`<span class="alert-icon">‚úÖ</span><div>${m}</div>`; document.querySelector('.card').prepend(a); setTimeout(()=>{a.remove();},5000); }
function updateProgress(p){ const bar=document.getElementById('progressBar'); const cont=document.getElementById('progressContainer'); bar.style.width=p+'%'; cont.style.display='block'; }
function updateStats(secciones, asignaciones, noAsig, resumenMateria){
  document.getElementById('statsContainer').style.display='grid';
  document.getElementById('statSecciones').textContent=secciones.length;
  document.getElementById('statAsignaciones').textContent=asignaciones.length;
  document.getElementById('statNoAsignados').textContent=noAsig.length;
  document.getElementById('asignacionesCount').textContent=asignaciones.length;
  document.getElementById('docentesCount') && (document.getElementById('docentesCount').textContent = new Set(asignaciones.map(a=>a.NOMBRE_DOCENTE)).size);
  document.getElementById('materiasCount') && (document.getElementById('materiasCount').textContent = new Set(asignaciones.map(a=>a.MATERIA)).size);
  document.getElementById('noAsignadosCount') && (document.getElementById('noAsignadosCount').textContent = noAsig.length);
  let totalCap=0, totalAsig=0; resumenMateria.forEach(m=>{ totalCap+=(m.CAP||0); totalAsig+=(m.ASIGNADOS||0); });
  const occ = totalCap>0 ? Math.round((totalAsig/totalCap)*100) : 0;
  document.getElementById('statOcupacion').textContent=occ+'%';
}
function validateFiles(){ const fD=document.getElementById('fileDoc').files[0]; const fE=document.getElementById('fileEst').files[0]; const fM=document.getElementById('fileMal').files[0]; document.getElementById('btnRun').disabled=!(fD&&fE&&fM); }
function updateFileStatus(inputId, statusId, isReq){ const input=document.getElementById(inputId); const status=document.getElementById(statusId); const icon=status.querySelector('.status-icon'); input.addEventListener('change',function(){ if(this.files.length>0){ icon.className='status-icon status-success'; status.querySelector('span:last-child').textContent=this.files[0].name; } else { icon.className='status-icon status-pending'; status.querySelector('span:last-child').textContent=isReq?'Esperando archivo...':'Opcional - Esperando archivo...'; } validateFiles(); }); }
function renderTable(el, headers, rows, maxRows=100){
  if(!rows||!rows.length){ el.innerHTML='<p class="text-muted text-center">No hay datos para mostrar.</p>'; return; }
  const disp=rows.slice(0,maxRows); const hasMore=rows.length>maxRows;
  let html = `<table><thead><tr>${headers.map(h=>`<th>${esc(h)}</th>`).join('')}</tr></thead><tbody>`;
  for(const r of disp){ html += `<tr>${headers.map(h=>`<td>${esc(val(r[h]))}</td>`).join('')}</tr>`; }
  html += `</tbody></table>`;
  if(hasMore){ html += `<p class="text-muted text-center">Mostrando ${maxRows} de ${rows.length} registros. Descargue el archivo para ver todos.</p>`; }
  el.innerHTML = html;
}
const readSheet = (file,fileName)=>new Promise((resolve,reject)=>{
  if(!file){ resolve([]); return; }
  const fr=new FileReader();
  fr.onload=e=>{
    try{
      const data=new Uint8Array(e.target.result);
      const wb=XLSX.read(data,{type:'array'});
      if(!wb.SheetNames||wb.SheetNames.length===0){ reject(new Error(`El archivo ${fileName} no contiene hojas v√°lidas.`)); return; }
      const ws=wb.Sheets[wb.SheetNames[0]];
      if(!ws||!ws['!ref']){ reject(new Error(`La hoja del archivo ${fileName} est√° vac√≠a.`)); return; }
      const json=XLSX.utils.sheet_to_json(ws,{defval:""});
      if(!json||json.length===0){ reject(new Error(`No se pudieron extraer datos del archivo ${fileName}. Verifique el formato.`)); return; }
      resolve(json);
    }catch(error){ reject(new Error(`Error al leer el archivo ${fileName}: ${error.message}`)); }
  };
  fr.onerror=()=>reject(new Error(`Error al leer el archivo ${fileName}.`));
  fr.readAsArrayBuffer(file);
});

/* ===== Normalizadores (originales) ===== */
function normalizeDocentes(rows){
  if(!rows||!rows.length){ showError("El archivo de docentes est√° vac√≠o o no tiene el formato correcto."); return []; }
  const result = rows.map(r=>{
    let diasDisponibles=[], horasDisponibles=[];
    if(r["DIA DISPONIBLE"]||r["DIA"]){
      const t=String(r["DIA DISPONIBLE"]||r["DIA"]||"").toUpperCase();
      if(t.includes("LUNES A VIERNES")) ["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES"].forEach(d=>diasDisponibles.push(d));
      if(t.includes("LUNES")) diasDisponibles.push("LUNES");
      if(t.includes("MARTES")) diasDisponibles.push("MARTES");
      if(t.includes("MIERCOLES")||t.includes("MI√âRCOLES")) diasDisponibles.push("MIERCOLES");
      if(t.includes("JUEVES")) diasDisponibles.push("JUEVES");
      if(t.includes("VIERNES")) diasDisponibles.push("VIERNES");
      if(t.includes("SABADO")||t.includes("S√ÅBADO")) diasDisponibles.push("SABADO");
    }
    if(r["HORA DISPONIBLE"]||r["HORA"]){
      const th=String(r["HORA DISPONIBLE"]||r["HORA"]||"").toUpperCase();
      const rangos = th.match(/\d{1,2}(?::\d{2})?\s*(?:-|‚Äì|‚Äî|a|A|AL|A LAS|A LOS|TO)\s*\d{1,2}(?::\d{2})?/gi) || [];
      if(rangos.length){
        const bloques=[]; for(const rr of rangos){ const b=normalizarHorario(rr); if(b) bloques.push(b); }
        horasDisponibles=Array.from(new Set(bloques));
      }else if(/\b07:00\b.*\b22:00\b/i.test(th) || /\b7\b.*\b22\b/.test(th)){ horasDisponibles=[...HORARIOS]; }
      else { horasDisponibles=[]; }
    }
    if(diasDisponibles.length===0) diasDisponibles=[];
    return {
      "NOMBRE_DOCENTE": r["NOMBRE_DOCENTE"] || r["DOCENTE"] || "",
      "MATERIA": r["MATERIA"] || r["MATERIAS"] || "",
      "CANTIDAD DE ALUMNOS ESPERADOS": Number(r["CANTIDAD DE ALUMNOS ESPERADOS"] || r["CAPACIDAD"] || r["CUPOS"] || 25) || 25,
      "DIA_DISPONIBLE": Array.from(new Set(diasDisponibles)),
      "HORA_DISPONIBLE": Array.from(new Set(horasDisponibles)),
      "Modalidad": r["Modalidad"] || r["MODALIDAD"] || "PRESENCIAL",
      "Paralelo": String(r["Paralelo"] || r["PARALELO"] || "").toUpperCase().trim() || "A",
      "DEDICACI√ìN": r["DEDICACI√ìN"] || r["DEDICACION"] || r["DEDICACION "] || ""
    };
  }).filter(x=>x.MATERIA&&x.NOMBRE_DOCENTE);
  if(result.length===0) showError("No se encontraron datos v√°lidos en el archivo de docentes.");
  return result;
}
function normalizeEstudiantes(rows){
  if(!rows||!rows.length){ showError("El archivo de estudiantes est√° vac√≠o o no tiene el formato correcto."); return []; }
  const result = rows.map(r=>{
    const ciclo = Number(r["CICLO AL QUE VA"] || r["CICLO ACTUAL"] || r["CICLO"] || 1);
    return {
      "ESTUDIANTE": r["ESTUDIANTE"] || r["NOMBRE"] || r["NOMBRE DEL ESTUDIANTE"] || "",
      "CICLO": isNaN(ciclo) ? 1 : Math.max(1, Math.min(12, ciclo)),
      "CARRERA": r["CARRERA"] || r["CARRERA DEL ESTUDIANTE"] || "",
      "MALLA": r["MALLA"] || "",
      "NIVEL INGLES": r["NIVEL INGLES"] || ""
    };
  }).filter(x=>x.ESTUDIANTE).filter(x=>Number(x.CICLO)!==9);
  if(result.length===0) showError("No se encontraron datos v√°lidos en el archivo de estudiantes (o todos son graduados).");
  return result;
}
function normalizeMallas(rows){
  if(!rows||!rows.length){ showError("El archivo de mallas est√° vac√≠o o no tiene el formato correcto."); return []; }
  const WORD2NUM={"PRIMERO":1,"SEGUNDO":2,"TERCERO":3,"CUARTO":4,"QUINTO":5,"SEXTO":6,"SEPTIMO":7,"S√âPTIMO":7,"OCTAVO":8,"NOVENO":9,"DECIMO":10,"D√âCIMO":10,"ONCE":11,"DOCE":12};
  const toCycle=v=>{ if(v===undefined||v===null||v==="") return NaN; const t=String(v).toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(); if(/^\d+$/.test(t)) return Number(t); return WORD2NUM[t]||NaN; };
  const result = rows.map(r=>{
    const materia=r["MATERIA"]||r["MATERIAS"]||"";
    const codigo=r["C√ìDIGO"]||r["CODIGO"]||r["C√ìDIGO ANTHOLOGY"]||"";
    let ciclo=toCycle(r["CICLO"]); if(isNaN(ciclo)) ciclo=Number(r["CICLO"]||1);
    return {
      "CARRERA": r["CARRERA"] || "",
      "MATERIA": materia,
      "CODIGO": String(codigo).trim(),
      "CICLO": Math.max(1, Math.min(12, Number(ciclo)||1)),
      "HORAS TE√ìRICAS": Number(r["HORAS TE√ìRICAS"] || r["HORAS_TEORICAS"] || r["HORAS TEORICAS"] || 0) || 0,
      "HORAS PR√ÅCTICAS": Number(r["HORAS PR√ÅCTICAS"] || r["HORAS_PRACTICAS"] || r["HORAS PRACTICAS"] || 0) || 0,
      "HORAS AUT√ìNOMAS": Number(r["HORAS AUT√ìNOMAS"] || r["HORAS AUTONOMAS"] || 0) || 0,
      "CREDITOS": Number(r["CREDITOS"] || 0) || 0,
      "CAMPO DE FORMACI√ìN": r["CAMPO DE FORMACI√ìN"] || r["CAMPO DE FORMACION"] || "",
      "MALLA": r["MALLA"] || "",
      "N¬∫ ORDEN EN LA MALLA": r["N¬∫ ORDEN EN LA MALLA"] || r["NRO ORDEN EN LA MALLA"] || 0,
      "PRE-REQUISITO": r["PRE-REQUISITO"] || r["PREREQUISITO"] || "",
      "CARRERAS QUE COMPARTEN": r["CARRERAS QUE COMPARTEN"] || r["CARRERAS_COMPARTEN"] || ""
    };
  }).filter(x=>x.MATERIA);
  if(result.length===0) showError("No se encontraron datos v√°lidos en el archivo de mallas.");
  return result;
}

/* ===== Parte de construcci√≥n/assign (se sobrescribir√° m√°s abajo con mejoras) ===== */
let __DOC_DAY_COUNT__ = new Map();
const getDocDayCount = (doc,dia)=>(__DOC_DAY_COUNT__.get(doc)?.get(dia))||0;
const incDocDayCount = (doc,dia)=>{ const m=__DOC_DAY_COUNT__.get(doc)||new Map(); m.set(dia,(m.get(dia)||0)+1); __DOC_DAY_COUNT__.set(doc,m); };

function construirSecciones(docentes,mallas,estudiantes){ return []; }  /* placeholder (override abajo) */
function asignarEstudiantes(secciones,estudiantes,mallas,docentes){ return { asignaciones:[], noAsig:[], cargaDocente:[], resumenMateria:[], secciones }; }

const DIAS_DEFAULT=["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES","SABADO"];
let GLOBAL_ASIGNACIONES=[];
function ensureExtraSectionFinal(){ return null; }
function installCareerFilter(){ }
function applyCareerFilterUI(){ }
function finalPassGuarantee(){ }

/* ===================== INTERFAZ (original) ===================== */
let OUT_SECC=[], OUT_COMB=[], OUT_CARGA=[], OUT_RES_MAT=[], OUT_NO=[];
let OUT_PLAN_DOC=[], OUT_PROY=[];
let OUT_PLAN_EST=[]; // NUEVO: Planificaci√≥n Estudiante

document.addEventListener('DOMContentLoaded', function(){
  updateFileStatus('fileDoc','statusDoc',true);
  updateFileStatus('fileEst','statusEst',true);
  updateFileStatus('fileMal','statusMal',true);
  updateFileStatus('fileIng','statusIng',false);
  updateFileStatus('filePra','statusPra',false);

  const tabs=document.querySelectorAll('.tab');
  const tabContents=document.querySelectorAll('.tab-content');
  tabs.forEach(tab=>{
    tab.addEventListener('click',()=>{
      const tabId=tab.getAttribute('data-tab');
      tabs.forEach(t=>t.classList.remove('active'));
      tabContents.forEach(tc=>tc.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tabId).classList.add('active');
    });
  });

  document.getElementById('btnRun').addEventListener('click', async ()=>{
    const fD=document.getElementById('fileDoc').files[0];
    const fE=document.getElementById('fileEst').files[0];
    const fM=document.getElementById('fileMal').files[0];
    const fI=document.getElementById('fileIng').files[0];
    const fP=document.getElementById('filePra').files[0];
    if(!fD||!fE||!fM){ showError('Debe cargar los archivos de DOCENTES, ESTUDIANTES y MALLA.'); return; }
    document.body.classList.add('loading'); updateProgress(10);
    try{
      const [rowsD,rowsE,rowsM,rowsI,rowsP]=await Promise.all([
        readSheet(fD,"DOCENTES"), readSheet(fE,"ESTUDIANTES"), readSheet(fM,"MALLA"),
        readSheet(fI,"INGLES").catch(()=>[]), readSheet(fP,"PRACTICAS").catch(()=>[])
      ]);
      updateProgress(40);
      const DOC=normalizeDocentes(rowsD);
      const EST=normalizeEstudiantes(rowsE);
      const MAL=normalizeMallas(rowsM);
      const ING=Array.isArray(rowsI)?rowsI:[];
      const PRA=Array.isArray(rowsP)?rowsP:[];
      if(DOC.length===0||EST.length===0||MAL.length===0){ throw new Error("Datos insuficientes para procesar. Verifique el formato de los archivos."); }
      updateProgress(60);

      /* construir secciones con anti-choque entre ciclos adyacentes */
      const secciones = construirSecciones(DOC,MAL,EST);
      updateProgress(80);

      /* asignaci√≥n con respeto de carrera + ingl√©s/pr√°cticas + edici√≥n posterior habilitada */
      const { asignaciones, noAsig, cargaDocente, resumenMateria, secciones:seccFinal } =
        asignarEstudiantes(secciones, EST, MAL, DOC, ING, PRA);

      /* pasada final: 100% obligatorio asignar */
      const estDayCount=new Map(), estSlots=new Map();
      for(const a of asignaciones){
        const m=estDayCount.get(a.ESTUDIANTE)||new Map(); m.set(a.DIA,(m.get(a.DIA)||0)+1); estDayCount.set(a.ESTUDIANTE,m);
        const s=estSlots.get(a.ESTUDIANTE)||new Set(); s.add(`${a.DIA}¬¶${a.HORA}`); estSlots.set(a.ESTUDIANTE,s);
      }
      finalPassGuarantee(asignaciones, noAsig, seccFinal, DOC, MAL, estDayCount, estSlots);

      /* salidas */
      OUT_SECC = seccFinal.map(s=>({
        "NOMBRE_DOCENTE":s.NOMBRE_DOCENTE||"0","DEDICACI√ìN":s.DEDICACI√ìN||"0","MATERIA":s.MATERIA,
        "CANTIDAD DE ALUMNOS ESPERADOS":s.CAP||0,"DIA":s.DIA||"0","HORA":s.HORA||"0","Modalidad":s.Modalidad||"0","Paralelo":s.Paralelo||"0"
      }));
      OUT_COMB = asignaciones.map(a=>({
        "NOMBRE_DOCENTE":a.NOMBRE_DOCENTE,"DEDICACI√ìN":a.DEDICACI√ìN||"0","MATERIA":a.MATERIA,
        "CANTIDAD DE ALUMNOS ESPERADOS":a["CANTIDAD DE ALUMNOS ESPERADOS"]||0,"DIA":a.DIA||"0","HORA":a.HORA||"0","Modalidad":a.Modalidad||"0","Paralelo":a.Paralelo||"0",
        "ESTUDIANTE":a.ESTUDIANTE,"CICLO":a.CICLO||0,"CARRERA DEL ESTUDIANTE":a["CARRERA DEL ESTUDIANTE"]||"0"
      }));
      OUT_NO.length=0;
      OUT_CARGA=cargaDocente; OUT_RES_MAT=resumenMateria;

      /* Planificaci√≥n Docentes (consolidada) */
      OUT_PLAN_DOC = asignaciones.map(a=>({
        "DOCENTE":a.NOMBRE_DOCENTE||"0","DEDICACI√ìN":a.DEDICACI√ìN||"0","MATERIA":a.MATERIA,
        "C√ìDIGO ANTHOLOGY":a["C√ìDIGO ANTHOLOGY"]||a.CODIGO||"0","CARRERAS QUE COMPARTEN":a["CARRERAS QUE COMPARTEN"]||"0","PRE-REQUISITO":a["PRE-REQUISITO"]||"0",
        "CODIGO":a.CODIGO||"0","HORAS TE√ìRICAS":a["HORAS TE√ìRICAS"]||0,"HORAS PR√ÅCTICAS":a["HORAS PR√ÅCTICAS"]||0,"HORAS AUT√ìNOMAS":a["HORAS AUT√ìNOMAS"]||0,
        "CREDITOS":a.CREDITOS||0,"CAMPO DE FORMACI√ìN":a["CAMPO DE FORMACI√ìN"]||"0","CICLO":a.CICLO||0,"MALLA":a.MALLA||"0","N¬∫ ORDEN EN LA MALLA":a["N¬∫ ORDEN EN LA MALLA"]||0,
        "PARALELO":a.Paralelo||"0","DIA":a.DIA||"0","HORA":a.HORA||"0","Modalidad":a.Modalidad||"0","Nro. HORAS":a["Nro. HORAS"]||0,
        "NOMBRE DEL ESTUDIANTE":a.ESTUDIANTE||"0","CARRERA DEL ESTUDIANTE":a["CARRERA DEL ESTUDIANTE"]||"0","CICLO DEL ESTUDIANTE":a["CICLO DEL ESTUDIANTE"]||0,
        "NIVEL INGLES":a["NIVEL INGLES"]||"0","OBSERVACIONES":a.OBSERVACIONES||"0"
      })).sort((x,y)=> x.DOCENTE.localeCompare(y.DOCENTE)||x.MATERIA.localeCompare(y.MATERIA)||String(x.PARALELO).localeCompare(String(y.PARALELO)));

      /* Proyecci√≥n por materia */
      const mapa=new Map(), seccIdx=new Map();
      for(const s of seccFinal){
        const k=`${s.MATERIA}¬¶${s.CICLO}`;
        const o=seccIdx.get(k)||{PAR:0,CAP:0,DOCENTES:new Set()}; o.PAR++; o.CAP+=(s.CAP||0); o.DOCENTES.add(s.NOMBRE_DOCENTE||"");
        seccIdx.set(k,o);
      }
      for(const a of OUT_PLAN_DOC){
        const k=`${a.MATERIA}¬¶${a.CICLO}`;
        if(!mapa.has(k)) mapa.set(k,{MATERIA:a.MATERIA,CICLO:a.CICLO,TOTAL:0,CARRERAS:new Map()});
        const o=mapa.get(k); o.TOTAL++; const car=(a["CARRERA DEL ESTUDIANTE"]||"0").trim(); o.CARRERAS.set(car,(o.CARRERAS.get(car)||0)+1);
      }
      OUT_PROY = Array.from(mapa.values()).map(o=>{
        const det=Array.from(o.CARRERAS.entries()).map(([c,n])=>`${c}: ${n}`).join(" / ");
        const k=`${o.MATERIA}¬¶${o.CICLO}`; const sec=seccIdx.get(k)||{PAR:0,CAP:0,DOCENTES:new Set()};
        return {"MATERIA":o.MATERIA,"CICLO":o.CICLO,"TOTAL ESTUDIANTES":o.TOTAL,"PARALELOS":sec.PAR,"CAPACIDAD TOTAL":sec.CAP,"DOCENTES":Array.from(sec.DOCENTES).filter(Boolean).join(" / ")||"0","DETALLE POR CARRERA":det||"0"};
      }).sort((a,b)=> a.MATERIA.localeCompare(b.MATERIA) || a.CICLO-b.CICLO);

      /* ===== NUEVO: PLANIFICACI√ìN ESTUDIANTE (columnas exactas solicitadas) ===== */
      OUT_PLAN_EST = asignaciones.map(a=>({
        "CARRERA": a["CARRERA DEL ESTUDIANTE"] || "0",
        "ESTUDIANTE": a.ESTUDIANTE,
        "CICLO DEL ESTUDIANTE": a["CICLO DEL ESTUDIANTE"] || a.CICLO || 0,
        "MALLA": a.MALLA || "0",
        "CICLO DE LA MATERIA EN LA MALLA": a.CICLO || 0,
        "COMPARTIDA CON": a["CARRERAS QUE COMPARTEN"] || "0",
        "CARRERA CREADA EN ANTHOLOGY": a["C√ìDIGO ANTHOLOGY"] ? "S√ç" : "0",
        "MATERIA": a.MATERIA,
        "PARALELO": a.Paralelo || "0",
        "DIA": a.DIA || "0",
        "HORA": a.HORA || "0",
        "MODALIDAD": a.Modalidad || "0",
        "NIVEL INGLES": a["NIVEL INGLES"] || "0",
        "OBSERVACIONES": a.OBSERVACIONES || "0",
        "DOCENTE": a.NOMBRE_DOCENTE || "0"
      }));

      updateProgress(90);
      renderTable(document.getElementById('tblCombo'), COMBO9, OUT_COMB, 100);
      renderTable(document.getElementById('tblPlanEst'),
        ["CARRERA","ESTUDIANTE","CICLO DEL ESTUDIANTE","MALLA","CICLO DE LA MATERIA EN LA MALLA","COMPARTIDA CON","CARRERA CREADA EN ANTHOLOGY","MATERIA","PARALELO","DIA","HORA","MODALIDAD","NIVEL INGLES","OBSERVACIONES","DOCENTE"],
        OUT_PLAN_EST, 100);
      document.getElementById('planEstCount').textContent = OUT_PLAN_EST.length;

      updateStats(OUT_SECC, OUT_COMB, OUT_NO, OUT_RES_MAT);
      document.getElementById('btnDown').classList.remove('hidden');
      updateProgress(100);

      document.querySelector('.instructions')?.classList.add('hidden');
      document.querySelector('.config-panel')?.classList.add('hidden');
      document.querySelector('.file-section')?.classList.add('hidden');

      GLOBAL_ASIGNACIONES = JSON.parse(JSON.stringify(asignaciones));
      const careers = Array.from(new Set(GLOBAL_ASIGNACIONES.map(a=>a["CARRERA DEL ESTUDIANTE"]).filter(Boolean)));
      installCareerFilter(careers);
      applyCareerFilterUI();

      attachRowEdit(); // habilita doble clic para edici√≥n en tabla

      setTimeout(()=>{ document.getElementById('progressContainer').style.display='none'; document.body.classList.remove('loading'); showSuccess(`Procesamiento completado. Se realizaron ${OUT_COMB.length} asignaciones.`); }, 600);
    }catch(error){
      showError(error.message); document.body.classList.remove('loading'); document.getElementById('progressContainer').style.display='none';
    }
  });

  document.getElementById('btnDown').addEventListener('click', ()=>{
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_SECC), 'MATRIZ_SECCIONES');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_COMB), 'COMBINACION');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_CARGA), 'RESUMEN_CARGA');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_RES_MAT), 'RESUMEN_MATERIA');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_NO), 'NO_ASIGNADOS');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_PLAN_DOC), 'PLANIFICACION_DOCENTES');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_PROY), 'PROYECCION_POR_MATERIA');
    /* NUEVA HOJA EXACTA SOLICITADA */
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_PLAN_EST), 'PLANIFICACION_ESTUDIANTE');
    XLSX.writeFile(wb,'Planificacion_Asignacion_Docente.xlsx');
    showSuccess('Archivo descargado correctamente.');
  });
});

/* ===================== A√ëADIDOS / OVERRIDES DE L√ìGICA ===================== */

/* √çndices r√°pidos */
const indexBy = (arr, keyFn) => {
  const m=new Map(); for(const x of arr){ const k=keyFn(x); if(!m.has(k)) m.set(k,[]); m.get(k).push(x); } return m;
};

/* Ciclos vecinos (anti-choque entre ciclos contiguos) */
const vecinosDe = c => [c-1,c+1].filter(x=>x>=1 && x<=12);

/* Construcci√≥n de secciones con bloqueo inter-ciclo adyacente */
function construirSecciones(docentes, mallas, estudiantes){
  __DOCENTE_SLOTS__=new Map(); __DOC_DAY_COUNT__=new Map();
  const secciones=[]; const capacidadPorParalelo=parseInt(document.getElementById('capacidadParalelo').value)||30;

  /* ocupaci√≥n por ciclo y por vecinos */
  const ocupados = new Map(); // Map<ciclo, Map<dia, Set<hora>>>
  for(let c=1;c<=12;c++){ ocupados.set(c,new Map()); }

  /* meta por (ciclo,materia) */
  const meta = new Map();
  for(const m of mallas){
    const k=`${m.CICLO}¬¶${m.MATERIA}`;
    if(!meta.has(k)) meta.set(k,{ cod:new Set(), car:new Set(), mal:new Set(), Ht:0, Hp:0, Ha:0, cr:0, campo:m["CAMPO DE FORMACI√ìN"]||"", ord:m["N¬∫ ORDEN EN LA MALLA"]||0, pre:m["PRE-REQUISITO"]||"" });
    const o=meta.get(k);
    if(m.CODIGO) o.cod.add(String(m.CODIGO));
    if(m.CARRERA) o.car.add(__norm(m.CARRERA));
    __splitList(m["CARRERAS QUE COMPARTEN"]).forEach(x=>o.car.add(__norm(x)));
    if(m.MALLA) o.mal.add(String(m.MALLA));
    o.Ht=Math.max(o.Ht, Number(m["HORAS TE√ìRICAS"]||0));
    o.Hp=Math.max(o.Hp, Number(m["HORAS PR√ÅCTICAS"]||0));
    o.Ha=Math.max(o.Ha, Number(m["HORAS AUT√ìNOMAS"]||0));
    o.cr=Math.max(o.cr, Number(m.CREDITOS||0));
    if(!o.campo) o.campo=m["CAMPO DE FORMACI√ìN"]||"";
    if(!o.pre) o.pre=m["PRE-REQUISITO"]||"";
  }

  /* estudiantes por ciclo */
  const estPorCiclo = indexBy(estudiantes, e=>e.CICLO);

  /* asigna 1 paralelo base por (ciclo,materia) y evita choque con vecinos */
  const seccionesPorDocente=new Map();
  for(const m of mallas){
    const ciclo=m.CICLO; const estC=estPorCiclo.get(ciclo)||[]; if(estC.length===0) continue;

    const docentesMateria = docentes.filter(d=> __norm(d.MATERIA)===__norm(m.MATERIA) );
    if(!docentesMateria.length) continue;

    docentesMateria.sort((a,b)=>(seccionesPorDocente.get(a.NOMBRE_DOCENTE)||0)-(seccionesPorDocente.get(b.NOMBRE_DOCENTE)||0));

    let elegido=null, slot=null;
    for(const d of docentesMateria){
      if((seccionesPorDocente.get(d.NOMBRE_DOCENTE)||0)>=5) continue;
      // buscar d√≠a/hora disponibles evitando choque en ciclo y en vecinos
      for(const dia of d.DIA_DISPONIBLE||[]){
        if(getDocDayCount(d.NOMBRE_DOCENTE,dia)>=2) continue;
        const setC = ocupados.get(ciclo).get(dia)||new Set();
        const vecinoLibre = vecinosDe(ciclo).every(v=>{
          const ov=ocupados.get(v); const sv=ov.get(dia)||new Set();
          // queremos no usar misma hora en vecino
          return true; // solo comprobamos si se ocupa misma hora al elegir
        });
        if(!vecinoLibre) continue;
        for(const h of d.HORA_DISPONIBLE||[]){
          const chocaC=setC.has(h);
          const chocaVec = vecinosDe(ciclo).some(v => (ocupados.get(v).get(dia)||new Set()).has(h));
          if(!chocaC && !chocaVec){
            elegido=d; slot={dia,hora:h}; break;
          }
        }
        if(elegido) break;
      }
      if(elegido) break;
    }
    if(!elegido) continue;

    const k=`${m.CICLO}¬¶${m.MATERIA}`; const o=meta.get(k)||{};
    const cod=Array.from(o?.cod||[]).join('/') || String(m.CODIGO||"0");
    const car=Array.from(o?.car||[]).join('/') || String(m["CARRERAS QUE COMPARTEN"]||"0");
    const mal=Array.from(o?.mal||[]).join('/') || String(m.MALLA||"0");

    secciones.push({
      MATERIA:m.MATERIA,CODIGO:cod,"C√ìDIGO ANTHOLOGY":cod,CICLO:ciclo,
      NOMBRE_DOCENTE:elegido.NOMBRE_DOCENTE,CAP:capacidadPorParalelo,ASIGNADOS:0,
      DIA:slot.dia,HORA:slot.hora,Modalidad:elegido.Modalidad,Paralelo:"A",DEDICACI√ìN:elegido.DEDICACI√ìN||"",
      "HORAS TE√ìRICAS":o?.Ht||0,"HORAS PR√ÅCTICAS":o?.Hp||0,"HORAS AUT√ìNOMAS":o?.Ha||0,CREDITOS:o?.cr||0,
      "CAMPO DE FORMACI√ìN":o?.campo||"0","MALLA":mal,"N¬∫ ORDEN EN LA MALLA":o?.ord||0,"PRE-REQUISITO":o?.pre||"0","CARRERAS QUE COMPARTEN":car
    });

    // marca ocupaci√≥n en ciclo y vecinos
    const set = ocupados.get(ciclo).get(slot.dia)||new Set(); set.add(slot.hora); ocupados.get(ciclo).set(slot.dia,set);
    const docSlots=__DOCENTE_SLOTS__.get(elegido.NOMBRE_DOCENTE)||new Map(); const ds=docSlots.get(slot.dia)||new Set(); ds.add(slot.hora); docSlots.set(slot.dia,ds); __DOCENTE_SLOTS__.set(elegido.NOMBRE_DOCENTE,docSlots);
    incDocDayCount(elegido.NOMBRE_DOCENTE,slot.dia);
    seccionesPorDocente.set(elegido.NOMBRE_DOCENTE,(seccionesPorDocente.get(elegido.NOMBRE_DOCENTE)||0)+1);
  }
  return secciones;
}

/* Filtrado de materias por carrera del estudiante (incluye compartidas) */
function materiasPermitidasPorEstudiante(mallas, estudiante){
  const car=__norm(estudiante.CARRERA);
  const ciclo=Number(estudiante.CICLO);
  const ok = mallas.filter(m=>{
    if(Number(m.CICLO)!==ciclo) return false;
    const base = __norm(m.CARRERA);
    const compartidas = new Set(__splitList(m["CARRERAS QUE COMPARTEN"]).map(__norm));
    return base===car || compartidas.has(car);
  });
  // si por alg√∫n motivo no hay, se permite fallback a todas del ciclo (para no bloquear la ejecuci√≥n)
  return ok.length ? ok : mallas.filter(m=>Number(m.CICLO)===ciclo);
}

/* Construcci√≥n √≠ndice secciones por (ciclo,materia) */
function agruparPorMateria(secciones){ const map=new Map(); for(const s of secciones){ const k=`${s.CICLO}¬¶${s.MATERIA}`; if(!map.has(k)) map.set(k,[]); map.get(k).push(s); } return map; }

/* Bloqueos por Ingl√©s/Pr√°cticas */
function buildStudentBlocks(ING, PRA){
  const blk=new Map(); // Map<est, Set("DIA¬¶HORA")>
  const add=(row)=>{ const e=String(row["ESTUDIANTE"]||row["NOMBRE"]||"").trim(); if(!e) return;
    const dia=canonDay(row["DIA"]||""); const h=normalizarHorario(row["HORA"]||"");
    if(!dia||!h) return; const s=blk.get(e)||new Set(); s.add(`${dia}¬¶${h}`); blk.set(e,s);
  };
  (ING||[]).forEach(add); (PRA||[]).forEach(add);
  return blk;
}

/* Asignaci√≥n con respeto de carrera y bloqueos opcionales */
function asignarEstudiantes(secciones, estudiantes, mallas, docentes, ING=[], PRA=[]){
  const idxPorMat=agruparPorMateria(secciones);
  const asignaciones=[]; const noAsig=[];
  const maxMaterias = parseInt(document.getElementById('maxMaterias').value)||6;

  const blocks = buildStudentBlocks(ING,PRA);

  // control por estudiante
  const estDayCount=new Map(); const estSlots=new Map();
  const canPlace=(est,dia,hora)=>{
    const cnt=estDayCount.get(est)?.get(dia)||0;
    const slots=estSlots.get(est)||new Set();
    const blocked=(blocks.get(est)||new Set()).has(`${dia}¬¶${hora}`);
    return cnt<2 && !slots.has(`${dia}¬¶${hora}`) && !blocked;
  };
  const markPlace=(est,dia,hora)=>{ const m=estDayCount.get(est)||new Map(); m.set(dia,(m.get(dia)||0)+1); estDayCount.set(est,m); const s=estSlots.get(est)||new Set(); s.add(`${dia}¬¶${hora}`); estSlots.set(est,s); };

  for(const e of estudiantes){
    const materias = materiasPermitidasPorEstudiante(mallas,e).map(x=>x.MATERIA);
    let toma=0; const ya=new Set();

    for(const mat of materias){
      if(toma>=maxMaterias) break;
      if(ya.has(mat)) continue;

      const k=`${e.CICLO}¬¶${mat}`;
      const bucket=(idxPorMat.get(k)||[]).slice().sort((a,b)=>{
        const fa=(a.CAP||0)-(a.ASIGNADOS||0); const fb=(b.CAP||0)-(b.ASIGNADOS||0);
        return fb-fa || (a.Paralelo||"").localeCompare(b.Paralelo||"");
      });

      let ok=false;
      for(const s of bucket){
        const free=(s.CAP||0)-(s.ASIGNADOS||0);
        if(free<=0) continue;
        if(!canPlace(e.ESTUDIANTE, s.DIA, s.HORA)) continue;

        s.ASIGNADOS=(s.ASIGNADOS||0)+1; toma++; ya.add(mat); ok=true; markPlace(e.ESTUDIANTE,s.DIA,s.HORA);

        asignaciones.push({
          ESTUDIANTE:e.ESTUDIANTE, CICLO:e.CICLO, NOMBRE_DOCENTE:s.NOMBRE_DOCENTE||"0",
          MATERIA:s.MATERIA, "CANTIDAD DE ALUMNOS ESPERADOS":s.CAP||0, DIA:s.DIA||"0", HORA:s.HORA||"0",
          Modalidad:s.Modalidad||"0", Paralelo:s.Paralelo||"0", DEDICACI√ìN:s.DEDICACI√ìN||"0", "C√ìDIGO ANTHOLOGY":s.CODIGO||"0",
          "CARRERAS QUE COMPARTEN":s["CARRERAS QUE COMPARTEN"]||"0","PRE-REQUISITO":s["PRE-REQUISITO"]||"0", CODIGO:s.CODIGO||"0",
          "HORAS TE√ìRICAS":Number(s["HORAS TE√ìRICAS"]||0),"HORAS PR√ÅCTICAS":Number(s["HORAS PR√ÅCTICAS"]||0),"HORAS AUT√ìNOMAS":Number(s["HORAS AUT√ìNOMAS"]||0),
          CREDITOS:Number(s.CREDITOS||0), "CAMPO DE FORMACI√ìN":s["CAMPO DE FORMACI√ìN"]||"0", MALLA:s.MALLA||"0","N¬∫ ORDEN EN LA MALLA":Number(s["N¬∫ ORDEN EN LA MALLA"]||0),
          "Nro. HORAS": Number(s["HORAS TE√ìRICAS"]||0)+Number(s["HORAS PR√ÅCTICAS"]||0),
          "CARRERA DEL ESTUDIANTE": e.CARRERA || "0", "CICLO DEL ESTUDIANTE": e.CICLO || 0, "NIVEL INGLES": e["NIVEL INGLES"] || "0", OBSERVACIONES: "0"
        });
        break;
      }
      if(!ok){
        noAsig.push({ ESTUDIANTE:e.ESTUDIANTE, MATERIA:mat, MOTIVO:"Sin cupo/horario compatible", CICLO:Number(e.CICLO)||0, "CARRERA DEL ESTUDIANTE":e.CARRERA||"0", "NIVEL INGLES":e["NIVEL INGLES"]||"0" });
      }
    }
  }

  // carga docente y resumen
  const cargaDocente = secciones.map(s=>({
    DOCENTE:s.NOMBRE_DOCENTE||"0", DEDICACI√ìN:s.DEDICACI√ìN||"0", MATERIA:s.MATERIA, Paralelo:s.Paralelo||"", DIA:s.DIA||"0", HORA:s.HORA||"0", ASIGNADOS:Number(s.ASIGNADOS||0), CAP:Number(s.CAP||0)
  })).sort((a,b)=> a.DOCENTE.localeCompare(b.DOCENTE)||a.MATERIA.localeCompare(b.MATERIA)||String(a.Paralelo).localeCompare(String(b.Paralelo)));

  const resumenMateria = (()=>{ const map=new Map(); for(const s of secciones){ const k=`${s.MATERIA}¬¶${s.Paralelo||''}`; if(!map.has(k)) map.set(k,{MATERIA:s.MATERIA,Paralelo:s.Paralelo||"",ASIGNADOS:0,CAP:0,OCUPACION:"0%"}); const o=map.get(k); o.CAP+=(s.CAP||0); o.ASIGNADOS+=(s.ASIGNADOS||0); }
    return Array.from(map.values()).map(r=>({ ...r, OCUPACION: r.CAP? Math.round((r.ASIGNADOS/r.CAP)*100)+'%' : '0%' }))
      .sort((a,b)=> a.MATERIA.localeCompare(b.MATERIA)||a.Paralelo.localeCompare(b.Paralelo));
  })();

  return { asignaciones, noAsig, cargaDocente, resumenMateria, secciones };
}

/* Garant√≠a 100% asignados (abre paralelos de ser necesario) */
function ensureExtraSection(ciclo, materia, docentes, mallas, secciones){
  const capacidad = parseInt(document.getElementById('capacidadParalelo').value)||30;
  const cand = docentes.filter(d=>__norm(d.MATERIA)===__norm(materia));
  if(!cand.length) return null;

  const o={cod:new Set(),car:new Set(),mal:new Set(),Ht:0,Hp:0,Ha:0,cr:0,campo:"",ord:0,pre:""};
  for(const m of mallas){
    if(Number(m.CICLO)===Number(ciclo) && __norm(m.MATERIA)===__norm(materia)){
      if(m.CODIGO) o.cod.add(String(m.CODIGO));
      if(m.CARRERA) o.car.add(__norm(m.CARRERA));
      __splitList(m["CARRERAS QUE COMPARTEN"]).forEach(x=>o.car.add(__norm(x)));
      if(m.MALLA) o.mal.add(String(m.MALLA));
      o.Ht=Math.max(o.Ht,Number(m["HORAS TE√ìRICAS"]||0));
      o.Hp=Math.max(o.Hp,Number(m["HORAS PR√ÅCTICAS"]||0));
      o.Ha=Math.max(o.Ha,Number(m["HORAS AUT√ìNOMAS"]||0));
      o.cr=Math.max(o.cr,Number(m.CREDITOS||0));
      if(!o.campo) o.campo=m["CAMPO DE FORMACI√ìN"]||"";
      if(!o.pre)   o.pre  =m["PRE-REQUISITO"]||"";
    }
  }
  const codStr = Array.from(o.cod).filter(Boolean).join('/') || "0";
  const carStr = Array.from(o.car).filter(Boolean).join('/') || "0";
  const malStr = Array.from(o.mal).filter(Boolean).join('/') || "0";

  // buscar docente y slot disponible en el ciclo, evitando choque dentro del ciclo
  for(const d of cand){
    const dias = Array.isArray(d.DIA_DISPONIBLE)&&d.DIA_DISPONIBLE.length ? d.DIA_DISPONIBLE : DIAS_DEFAULT;
    const horas= Array.isArray(d.HORA_DISPONIBLE)&&d.HORA_DISPONIBLE.length ? d.HORA_DISPONIBLE : HORARIOS;

    for(const dia of dias){
      const usados = secciones
        .filter(s=>Number(s.CICLO)===Number(ciclo) && s.DIA===dia)
        .map(s=>s.HORA);
      const horaLibre = horas.find(h=>!usados.includes(h));
      if(!horaLibre) continue;

      const paralelo = String.fromCharCode(65 + (secciones.filter(s=>s.MATERIA===materia && Number(s.CICLO)===Number(ciclo)).length));
      const nueva = {
        MATERIA: materia,
        CODIGO: codStr,
        "C√ìDIGO ANTHOLOGY": codStr,
        CICLO: Number(ciclo),
        NOMBRE_DOCENTE: d.NOMBRE_DOCENTE || "0",
        CAP: capacidad,
        ASIGNADOS: 0,
        DIA: dia,
        HORA: horaLibre,
        Modalidad: d.Modalidad || "PRESENCIAL",
        Paralelo: paralelo,
        DEDICACI√ìN: d.DEDICACI√ìN || "0",
        "HORAS TE√ìRICAS": o.Ht, "HORAS PR√ÅCTICAS": o.Hp, "HORAS AUT√ìNOMAS": o.Ha,
        CREDITOS: o.cr,
        "CAMPO DE FORMACI√ìN": o.campo || "0",
        MALLA: malStr,
        "N¬∫ ORDEN EN LA MALLA": o.ord || 0,
        "PRE-REQUISITO": o.pre || "0",
        "CARRERAS QUE COMPARTEN": carStr
      };
      secciones.push(nueva);
      return nueva;
    }
  }
  return null;
}

/* fallback de creaci√≥n de secci√≥n cuando no hay disponibilidad perfecta */
function ensureExtraSectionFinal(ciclo, materia, docentes, mallas, secciones){
  const ex = ensureExtraSection(ciclo, materia, docentes, mallas, secciones);
  if(ex) return ex;

  const cand = docentes.filter(d=>__norm(d.MATERIA)===__norm(materia));
  if(!cand.length) return null;

  // meta m√≠nima desde malla
  const o={cod:new Set(),car:new Set(),mal:new Set(),Ht:0,Hp:0,Ha:0,cr:0,campo:"",ord:0,pre:""};
  for(const m of mallas){
    if(Number(m.CICLO)===Number(ciclo) && __norm(m.MATERIA)===__norm(materia)){
      if(m.CODIGO) o.cod.add(String(m.CODIGO));
      if(m.CARRERA) o.car.add(__norm(m.CARRERA));
      (__splitList(m["CARRERAS QUE COMPARTEN"])).forEach(x=>o.car.add(__norm(x)));
      if(m.MALLA) o.mal.add(String(m.MALLA));
      o.Ht=Math.max(o.Ht,Number(m["HORAS TE√ìRICAS"]||0));
      o.Hp=Math.max(o.Hp,Number(m["HORAS PR√ÅCTICAS"]||0));
      o.Ha=Math.max(o.Ha,Number(m["HORAS AUT√ìNOMAS"]||0));
      o.cr=Math.max(o.cr,Number(m.CREDITOS||0));
      if(!o.campo) o.campo=m["CAMPO DE FORMACI√ìN"]||"";
      if(!o.pre)   o.pre  =m["PRE-REQUISITO"]||"";
    }
  }
  const capacidad = parseInt(document.getElementById('capacidadParalelo').value)||30;
  const codStr = Array.from(o.cod).filter(Boolean).join('/') || "0";
  const carStr = Array.from(o.car).filter(Boolean).join('/') || "0";
  const malStr = Array.from(o.mal).filter(Boolean).join('/') || "0";

  const d=cand[0];
  const dias = (Array.isArray(d.DIA_DISPONIBLE)&&d.DIA_DISPONIBLE.length)?d.DIA_DISPONIBLE:DIAS_DEFAULT;
  const horas= (Array.isArray(d.HORA_DISPONIBLE)&&d.HORA_DISPONIBLE.length)?d.HORA_DISPONIBLE:HORARIOS;

  // evite repetir exacto d√≠a/hora de otra secci√≥n del mismo ciclo
  for(const dia of dias){
    for(const hora of horas){
      const choque = secciones.some(s=> Number(s.CICLO)===Number(ciclo) && s.DIA===dia && s.HORA===hora );
      if(choque) continue;
      const paralelo = String.fromCharCode(65 + (secciones.filter(s=>s.MATERIA===materia && Number(s.CICLO)===Number(ciclo)).length));
      const nueva={
        MATERIA:materia, CODIGO:codStr, "C√ìDIGO ANTHOLOGY":codStr, CICLO:Number(ciclo),
        NOMBRE_DOCENTE:d.NOMBRE_DOCENTE||"0", CAP:capacidad, ASIGNADOS:0, DIA:dia, HORA:hora,
        Modalidad:d.Modalidad||"PRESENCIAL", Paralelo:paralelo, DEDICACI√ìN:d.DEDICACI√ìN||"0",
        "HORAS TE√ìRICAS":o.Ht, "HORAS PR√ÅCTICAS":o.Hp, "HORAS AUT√ìNOMAS":o.Ha, CREDITOS:o.cr,
        "CAMPO DE FORMACI√ìN":o.campo||"0", MALLA:malStr, "N¬∫ ORDEN EN LA MALLA":o.ord||0, "PRE-REQUISITO":o.pre||"0", "CARRERAS QUE COMPARTEN":carStr
      };
      secciones.push(nueva);
      return nueva;
    }
  }
  return null;
}

/* Filtro UI por carrera + b√∫squeda r√°pida */
let __CURRENT_VIEW__=[];
function installCareerFilter(careers){
  const bar=document.getElementById('careerFilterBar');
  const sel=document.getElementById('careerFilter');
  const tag=document.getElementById('careerActive');
  const search=document.getElementById('quickSearch');
  const clear=document.getElementById('clearFilters');
  if(!bar||!sel) return;

  sel.innerHTML=`<option value="__ALL__">Todas las carreras</option>`;
  Array.from(new Set((careers||[]).filter(Boolean))).sort()
    .forEach(c=> sel.insertAdjacentHTML('beforeend', `<option value="${esc(c)}">${esc(c)}</option>`));

  bar.style.display='grid';
  tag.textContent='Sin filtro';

  sel.onchange = ()=>applyCareerFilterUI();
  let _deb; search.oninput=()=>{ clearTimeout(_deb); _deb=setTimeout(applyCareerFilterUI,200); };
  clear.onclick = ()=>{ sel.value="__ALL__"; search.value=""; applyCareerFilterUI(); };
}

function applyCareerFilterUI(){
  const v=document.getElementById('careerFilter').value;
  const q=(document.getElementById('quickSearch').value||"").trim().toLowerCase();
  const tag=document.getElementById('careerActive');

  let filtered = (v==="__ALL__") ? GLOBAL_ASIGNACIONES.slice()
      : GLOBAL_ASIGNACIONES.filter(a => String(a["CARRERA DEL ESTUDIANTE"]||"").toUpperCase()===v.toUpperCase());

  if(q){
    filtered = filtered.filter(a=>{
      const campos=[a.ESTUDIANTE,a.MATERIA,a.NOMBRE_DOCENTE,a.Paralelo,a.DIA,a.HORA].map(x=>String(x||"").toLowerCase());
      return campos.some(x=>x.includes(q));
    });
  }

  __CURRENT_VIEW__ = filtered.slice();

  renderTable(
    document.getElementById('tblCombo'),
    ["NOMBRE_DOCENTE","MATERIA","CANTIDAD DE ALUMNOS ESPERADOS","DIA","HORA","Modalidad","Paralelo","DEDICACI√ìN","ESTUDIANTE","CICLO"],
    filtered.map(a=>({
      "NOMBRE_DOCENTE":a.NOMBRE_DOCENTE,"MATERIA":a.MATERIA,"CANTIDAD DE ALUMNOS ESPERADOS":a["CANTIDAD DE ALUMNOS ESPERADOS"],
      "DIA":a.DIA,"HORA":a.HORA,"Modalidad":a.Modalidad,"Paralelo":a.Paralelo,"DEDICACI√ìN":a.DEDICACI√ìN||"0","ESTUDIANTE":a.ESTUDIANTE,"CICLO":a.CICLO
    })),
    100
  );

  document.getElementById('asignacionesCount').textContent = filtered.length;
  const txtCarr=(v==="__ALL__")?"Todas":v; const txtBusq=q?` ‚Ä¢ b√∫squeda: ‚Äú${q}‚Äù`:"";
  tag.textContent = (v==="__ALL__" && !q) ? "Sin filtro" : `Carrera: ${txtCarr}${txtBusq}`;

  bindRowDblClick();  // reatacha edici√≥n tras render
}

/* Garantizar 100% asignados: reasignaci√≥n forzada si qued√≥ alguno */
function finalPassGuarantee(asignaciones, noAsig, secciones, docentes, mallas, estDayCount, estSlots){
  if(!noAsig.length) return;
  for(const p of [...noAsig]){
    const extra = ensureExtraSectionFinal(p.CICLO, p.MATERIA, docentes, mallas, secciones);
    let dia = extra?.DIA || DIAS_DEFAULT[0], hora = extra?.HORA || HORARIOS[0];
    const m = estDayCount.get(p.ESTUDIANTE)||new Map();
    const s = estSlots.get(p.ESTUDIANTE)||new Set();

    // buscar slot que no choque con el estudiante (<=2 por d√≠a)
    let colocado=false;
    for(const d of DIAS_DEFAULT){
      if((m.get(d)||0)>=2) continue;
      for(const h of HORARIOS){
        if(!s.has(`${d}¬¶${h}`)){ dia=d; hora=h; colocado=true; break; }
      }
      if(colocado) break;
    }
    if(!colocado){ dia=DIAS_DEFAULT[0]; hora=HORARIOS[0]; }

    if(extra){ extra.DIA=dia; extra.HORA=hora; extra.ASIGNADOS=(extra.ASIGNADOS||0)+1; }

    m.set(dia,(m.get(dia)||0)+1); estDayCount.set(p.ESTUDIANTE,m);
    s.add(`${dia}¬¶${hora}`); estSlots.set(p.ESTUDIANTE,s);

    asignaciones.push({
      ESTUDIANTE:p.ESTUDIANTE, CICLO:p.CICLO,
      NOMBRE_DOCENTE:(extra?.NOMBRE_DOCENTE)||"0", MATERIA:p.MATERIA,
      "CANTIDAD DE ALUMNOS ESPERADOS":(extra?.CAP)||30, DIA:dia, HORA:hora,
      Modalidad:(extra?.Modalidad)||"PRESENCIAL", Paralelo:(extra?.Paralelo)||"A",
      DEDICACI√ìN:(extra?.DEDICACI√ìN)||"0",
      "C√ìDIGO ANTHOLOGY":(extra?.CODIGO)||"0","CARRERAS QUE COMPARTEN":(extra?.["CARRERAS QUE COMPARTEN"])||"0","PRE-REQUISITO":(extra?.["PRE-REQUISITO"])||"0",
      CODIGO:(extra?.CODIGO)||"0","HORAS TE√ìRICAS":Number(extra?.["HORAS TE√ìRICAS"]||0),"HORAS PR√ÅCTICAS":Number(extra?.["HORAS PR√ÅCTICAS"]||0),"HORAS AUT√ìNOMAS":Number(extra?.["HORAS AUT√ìNOMAS"]||0),
      CREDITOS:Number(extra?.CREDITOS||0),"CAMPO DE FORMACI√ìN":(extra?.["CAMPO DE FORMACI√ìN"])||"0", MALLA:(extra?.MALLA)||"0","N¬∫ ORDEN EN LA MALLA":Number(extra?.["N¬∫ ORDEN EN LA MALLA"]||0),
      "Nro. HORAS": Number(extra?.["HORAS TE√ìRICAS"]||0)+Number(extra?.["HORAS PR√ÅCTICAS"]||0),
      "CARRERA DEL ESTUDIANTE": p["CARRERA DEL ESTUDIANTE"]||"0", "CICLO DEL ESTUDIANTE": p.CICLO||0, "NIVEL INGLES": p["NIVEL INGLES"]||"0", OBSERVACIONES: "0"
    });
  }
  noAsig.length=0;
}

/* ===================== EDICI√ìN EN MODAL (solo estudiantes) ===================== */
let __SECCIONES__=[];

function bindRowDblClick(){
  const cont=document.getElementById('tblCombo');
  const tbl=cont.querySelector('table tbody');
  if(!tbl) return;
  tbl.onclick=null; // limpiamos posibles anteriores
  tbl.ondblclick = (ev)=>{
    const tr = ev.target.closest('tr'); if(!tr) return;
    const idx = Array.from(tr.parentNode.children).indexOf(tr);
    const row = __CURRENT_VIEW__[idx];
    if(!row) return;
    openEditModal(row);
  };
}

function openEditModal(row){
  const modal=document.getElementById('editModal');
  document.getElementById('edtEst').value = row.ESTUDIANTE;
  document.getElementById('edtMat').value = row.MATERIA;
  document.getElementById('edtDoc').value = row.NOMBRE_DOCENTE;
  document.getElementById('edtDia').value = row.DIA;
  document.getElementById('edtHora').value = row.HORA;
  const sel=document.getElementById('edtReMat');
  sel.innerHTML = `<option value="">(Mantener materia)</option>`;

  // materias disponibles del MISMO CICLO y Carrera del estudiante
  const materiasPosibles = Array.from(new Set(
    GLOBAL_ASIGNACIONES
      .filter(a=> a.ESTUDIANTE!==row.ESTUDIANTE && a.CICLO===row.CICLO && a["CARRERA DEL ESTUDIANTE"]===row["CARRERA DEL ESTUDIANTE"])
      .map(a=>a.MATERIA)
  ));
  materiasPosibles.forEach(m=> sel.insertAdjacentHTML('beforeend', `<option>${esc(m)}</option>`));

  modal.classList.add('open');
  document.getElementById('edtMsg').textContent = '';

  document.getElementById('btnCloseModal').onclick=()=> modal.classList.remove('open');
  document.getElementById('btnSaveEdit').onclick=()=> saveEdit(row);
}

function studentHasConflict(estudiante, dia, hora, exclude){
  // m√°ximo 2 materias por d√≠a y no repetir bloque
  const dayCount = GLOBAL_ASIGNACIONES.reduce((acc,a)=>{
    if(a.ESTUDIANTE!==estudiante) return acc;
    if(exclude && exclude===a) return acc;
    acc[a.DIA]= (acc[a.DIA]||0) + 1;
    return acc;
  },{});
  const sameSlot = GLOBAL_ASIGNACIONES.some(a=> a!==exclude && a.ESTUDIANTE===estudiante && a.DIA===dia && a.HORA===hora );
  if(sameSlot) return "El estudiante ya tiene una materia en ese bloque.";
  if((dayCount[dia]||0) >= 2) return "El estudiante ya tiene 2 materias ese d√≠a.";
  return "";
}

function findSectionFor(materia, ciclo, dia, hora){
  return __SECCIONES__.find(s=> __norm(s.MATERIA)===__norm(materia) && Number(s.CICLO)===Number(ciclo) && s.DIA===dia && s.HORA===hora && ((s.CAP||0)-(s.ASIGNADOS||0))>0 );
}

function anySectionOf(materia, ciclo){
  return __SECCIONES__.find(s=> __norm(s.MATERIA)===__norm(materia) && Number(s.CICLO)===Number(ciclo) && ((s.CAP||0)-(s.ASIGNADOS||0))>0 );
}

function saveEdit(oldRow){
  const modal=document.getElementById('editModal');
  const nuevoDia=document.getElementById('edtDia').value;
  const nuevaHora=document.getElementById('edtHora').value;
  const nuevaMateria=document.getElementById('edtReMat').value || oldRow.MATERIA;

  const msgEl=document.getElementById('edtMsg');

  const conflict = studentHasConflict(oldRow.ESTUDIANTE, nuevoDia, nuevaHora, oldRow);
  if(conflict){
    msgEl.innerHTML = `<span class="danger">${esc(conflict)}</span>`;
    return;
  }

  // buscar secci√≥n destino (misma o nueva materia)
  let target = findSectionFor(nuevaMateria, oldRow.CICLO, nuevoDia, nuevaHora);
  if(!target){
    // intentar alguna secci√≥n de esa materia en cualquier horario libre
    target = anySectionOf(nuevaMateria, oldRow.CICLO);
  }
  if(!target){
    // crear secci√≥n extra y ajustarla al horario pedido
    target = ensureExtraSectionFinal(oldRow.CICLO, nuevaMateria, [], [], __SECCIONES__) || null;
    if(target){ target.DIA=nuevoDia; target.HORA=nuevaHora; }
  }
  if(!target){
    msgEl.innerHTML = `<span class="danger">No existe secci√≥n disponible para la materia seleccionada.</span>`;
    return;
  }

  // descontar del origen (secci√≥n anterior)
  const origen = __SECCIONES__.find(s=> __norm(s.MATERIA)===__norm(oldRow.MATERIA) && Number(s.CICLO)===Number(oldRow.CICLO) && s.DIA===oldRow.DIA && s.HORA===oldRow.HORA && s.Paralelo===oldRow.Paralelo && s.NOMBRE_DOCENTE===oldRow.NOMBRE_DOCENTE);
  if(origen && origen.ASIGNADOS>0) origen.ASIGNADOS--;

  // aplicar cambios al registro del estudiante
  oldRow.MATERIA = nuevaMateria;
  oldRow.DIA = target.DIA;
  oldRow.HORA = target.HORA;
  oldRow.NOMBRE_DOCENTE = target.NOMBRE_DOCENTE || oldRow.NOMBRE_DOCENTE;
  oldRow.Paralelo = target.Paralelo || oldRow.Paralelo;

  target.ASIGNADOS = (target.ASIGNADOS||0)+1;

  // reconstruir vistas de salida
  OUT_COMB = GLOBAL_ASIGNACIONES.map(a=>({
    "NOMBRE_DOCENTE":a.NOMBRE_DOCENTE,"DEDICACI√ìN":a.DEDICACI√ìN||"0","MATERIA":a.MATERIA,
    "CANTIDAD DE ALUMNOS ESPERADOS":a["CANTIDAD DE ALUMNOS ESPERADOS"]||0,"DIA":a.DIA||"0","HORA":a.HORA||"0",
    "Modalidad":a.Modalidad||"0","Paralelo":a.Paralelo||"0","ESTUDIANTE":a.ESTUDIANTE,"CICLO":a.CICLO||0,"CARRERA DEL ESTUDIANTE":a["CARRERA DEL ESTUDIANTE"]||"0"
  }));

  OUT_PLAN_EST = GLOBAL_ASIGNACIONES.map(a=>({
    "CARRERA": a["CARRERA DEL ESTUDIANTE"] || "0",
    "ESTUDIANTE": a.ESTUDIANTE,
    "CICLO DEL ESTUDIANTE": a["CICLO DEL ESTUDIANTE"] || a.CICLO || 0,
    "MALLA": a.MALLA || "0",
    "CICLO DE LA MATERIA EN LA MALLA": a.CICLO || 0,
    "COMPARTIDA CON": a["CARRERAS QUE COMPARTEN"] || "0",
    "CARRERA CREADA EN ANTHOLOGY": a["C√ìDIGO ANTHOLOGY"] ? "S√ç" : "0",
    "MATERIA": a.MATERIA,
    "PARALELO": a.Paralelo || "0",
    "DIA": a.DIA || "0",
    "HORA": a.HORA || "0",
    "MODALIDAD": a.Modalidad || "0",
    "NIVEL INGLES": a["NIVEL INGLES"] || "0",
    "OBSERVACIONES": a.OBSERVACIONES || "0",
    "DOCENTE": a.NOMBRE_DOCENTE || "0"
  }));

  renderTable(document.getElementById('tblPlanEst'),
    ["CARRERA","ESTUDIANTE","CICLO DEL ESTUDIANTE","MALLA","CICLO DE LA MATERIA EN LA MALLA","COMPARTIDA CON","CARRERA CREADA EN ANTHOLOGY","MATERIA","PARALELO","DIA","HORA","MODALIDAD","NIVEL INGLES","OBSERVACIONES","DOCENTE"],
    OUT_PLAN_EST, 100);

  applyCareerFilterUI(); // re-render principal con filtros vigentes
  document.getElementById('planEstCount').textContent = OUT_PLAN_EST.length;

  modal.classList.remove('open');
  showSuccess('Asignaci√≥n del estudiante actualizada.');
}

/* Helper p√∫blico para inicializar edici√≥n tras primer render */
function attachRowEdit(){ bindRowDblClick(); }

/* ===================== FIN A√ëADIDOS ===================== */
</script>
</body>
</html>

