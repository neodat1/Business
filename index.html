<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Sistema de Planificación Académica</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root {
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --primary-light: #dbeafe;
    --secondary: #64748b;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #0f172a;
    --light: #f8fafc;
    --border: #e2e8f0;
    --radius: 12px;
    --shadow: 0 8px 30px rgba(2,6,23,.06);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f1f5f9;color:var(--dark)}
  .app-container{max-width:1800px;margin:0 auto;padding:20px}
  .app-header{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:24px;margin-bottom:24px;border-left:4px solid var(--primary)}
  .app-title{font-size:28px;font-weight:800;color:var(--primary);margin-bottom:6px}
  .app-subtitle{color:var(--secondary)}
  .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin-bottom:20px}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:8px}
  .card-title{font-size:18px;font-weight:700}
  .file-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:14px;margin-top:12px}
  .file-input{width:100%;padding:12px;border:2px dashed var(--border);border-radius:12px;background:#f8fafc}
  .file-status{display:flex;gap:8px;align-items:center;margin-top:6px;color:var(--secondary);font-size:13px}
  .status-icon{width:10px;height:10px;border-radius:50%;background:#fbbf24}
  .status-success{background:#10b981}
  .btn{appearance:none;border:none;border-radius:12px;padding:11px 16px;font-weight:800;display:inline-flex;gap:10px;align-items:center;cursor:pointer}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-primary:hover{background:var(--primary-dark)}
  .btn-secondary{background:#fff;border:1px solid var(--border)}
  .progress-container{display:none;width:100%;height:8px;background:#eef2f7;border-radius:999px;overflow:hidden;margin:14px 0}
  .progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#93c5fd,var(--primary))}
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
  .stat-card{background:#f8fafc;border-left:4px solid var(--primary);border-radius:12px;padding:16px;text-align:center}
  .stat-value{font-size:28px;font-weight:900;color:var(--primary)}
  .stat-label{font-size:13px;color:var(--secondary)}
  .config-panel{background:#f8fafc;border-radius:12px;padding:16px;margin-top:12px}
  .config-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px}
  .config-input{width:100%;height:42px;border:1px solid var(--border);border-radius:10px;padding:10px}
  .table-container{border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-top:12px}
  .table-container .table-scroll{max-height:440px;overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th{position:sticky;top:0;background:#f8fafc;padding:12px;border-bottom:1px solid var(--border);text-align:left;font-weight:800}
  td{padding:10px 12px;border-bottom:1px solid var(--border)}
  tr:hover{background:#f8fafc}
  .tabs{display:flex;border-bottom:1px solid var(--border);gap:6px;margin-top:4px}
  .tab{padding:10px 14px;border-radius:8px 8px 0 0;cursor:pointer;font-weight:700;color:var(--secondary)}
  .tab.active{background:#fff;color:var(--primary);border:1px solid var(--border);border-bottom-color:#fff}
  .tab-content{display:none}
  .tab-content.active{display:block}
  .alert{padding:12px;border-radius:12px;margin-top:12px}
  .alert-error{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
  .alert-success{background:#f0fdf4;color:#065f46;border:1px solid #bbf7d0}
  .filter-bar{display:none;grid-template-columns:260px 1fr auto auto;gap:12px;align-items:end;margin:8px 0}
  .filter-chip{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;color:#64748b;font-weight:800}
  /* modal edición */
  .modal-bg{position:fixed;inset:0;background:rgba(2,8,23,.45);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(560px,92vw);background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:18px}
  .modal h3{margin:0 0 12px;font-weight:800}
  .modal .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
</style>
</head>
<body>
<div class="app-container">

  <header class="app-header">
    <h1 class="app-title">Sistema de Planificación Académica</h1>
    <p class="app-subtitle">Asignación automatizada de estudiantes a materias y docentes</p>
  </header>

  <div class="card">
    <div class="config-panel">
      <h3 class="card-title">Configuración del Sistema</h3>
      <div class="config-grid">
        <div>
          <label class="config-label" for="maxMaterias">Máximo de materias por estudiante</label>
          <input type="number" id="maxMaterias" class="config-input" value="6" min="1" max="10">
        </div>
        <div>
          <label class="config-label" for="capacidadParalelo">Capacidad máxima por paralelo</label>
          <input type="number" id="capacidadParalelo" class="config-input" value="30" min="10" max="120">
        </div>
      </div>
    </div>

    <!-- === Carga de archivos (AGREGADOS: Inglés y Prácticas OPCIONALES) === -->
    <div class="file-section">
      <div>
        <label class="file-label">DOCENTES.xlsx</label>
        <input id="fileDoc" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status"><span id="dotDoc" class="status-icon"></span><span id="nameDoc">Esperando archivo...</span></div>
      </div>
      <div>
        <label class="file-label">ESTUDIANTES.xlsx</label>
        <input id="fileEst" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status"><span id="dotEst" class="status-icon"></span><span id="nameEst">Esperando archivo...</span></div>
      </div>
      <div>
        <label class="file-label">MALLA.xlsx</label>
        <input id="fileMal" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status"><span id="dotMal" class="status-icon"></span><span id="nameMal">Esperando archivo...</span></div>
      </div>
      <div>
        <label class="file-label">INGLÉS.xlsx (opcional)</label>
        <input id="fileIng" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status"><span id="dotIng" class="status-icon"></span><span id="nameIng">No cargado</span></div>
      </div>
      <div>
        <label class="file-label">PRÁCTICAS.xlsx (opcional)</label>
        <input id="filePra" type="file" accept=".xlsx,.xls" class="file-input">
        <div class="file-status"><span id="dotPra" class="status-icon"></span><span id="namePra">No cargado</span></div>
      </div>
    </div>

    <div class="progress-container" id="progressContainer"><div class="progress-bar" id="progressBar"></div></div>

    <div class="btn-group" style="display:flex;gap:12px;margin-top:6px">
      <button id="btnRun" class="btn btn-primary" disabled>Procesar Asignación</button>
      <button id="btnDown" class="btn btn-secondary" disabled>Descargar Planificación</button>
    </div>

    <div id="statsContainer" class="stats-grid" style="display:none">
      <div class="stat-card"><div class="stat-value" id="statSecciones">0</div><div class="stat-label">Secciones creadas</div></div>
      <div class="stat-card"><div class="stat-value" id="statAsignaciones">0</div><div class="stat-label">Asignaciones realizadas</div></div>
      <div class="stat-card"><div class="stat-value" id="statNoAsignados">0</div><div class="stat-label">Estudiantes no asignados</div></div>
      <div class="stat-card"><div class="stat-value" id="statOcupacion">0%</div><div class="stat-label">Ocupación promedio</div></div>
    </div>

    <div class="alert alert-error" id="errorBox" style="display:none"><strong>Error:</strong> <span id="errorMessage"></span></div>
    <div class="alert alert-success" id="okBox" style="display:none"><strong>Listo:</strong> <span id="okMessage"></span></div>
  </div>

  <!-- === Pestañas originales conservadas === -->
  <div class="tabs">
    <div class="tab active" data-tab="asignaciones">Asignaciones</div>
    <div class="tab" data-tab="carga-docente">Carga Docente</div>
    <div class="tab" data-tab="resumen-materia">Resumen por Materia</div>
    <div class="tab" data-tab="no-asignados">No Asignados</div>
  </div>

  <div class="tab-content active" id="asignaciones">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Asignaciones Realizadas</h3>
        <span class="filter-chip"><b id="asignacionesCount">0</b> registros</span>
      </div>

      <!-- Barra de filtros original (mostrada tras procesar) -->
      <div id="careerFilterBar" class="filter-bar">
        <div>
          <label for="careerFilter" class="config-label">Carrera</label>
          <select id="careerFilter" class="config-input"><option value="__ALL__">Todas las carreras</option></select>
        </div>
        <div>
          <label for="quickSearch" class="config-label">Buscar</label>
          <input id="quickSearch" type="search" class="config-input" placeholder="Estudiante, materia, docente, día, hora…"/>
        </div>
        <div><label class="config-label">&nbsp;</label><span class="filter-chip" id="careerActive">Sin filtro</span></div>
        <div style="justify-self:end"><label class="config-label">&nbsp;</label><button id="clearFilters" class="btn btn-secondary">Limpiar</button></div>
      </div>

      <div class="table-container">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Editar</th>
                <th>NOMBRE_DOCENTE</th><th>MATERIA</th><th>CANTIDAD DE ALUMNOS ESPERADOS</th>
                <th>DIA</th><th>HORA</th><th>Modalidad</th><th>Paralelo</th><th>ESTUDIANTE</th><th>CICLO</th>
              </tr>
            </thead>
            <tbody id="asigBody"><tr><td colspan="10" style="text-align:center;color:#94a3b8;padding:22px">Sin datos</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="carga-docente">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Carga por Docente</h3>
        <span class="filter-chip" id="docentesCount">0</span>
      </div>
      <div class="table-container">
        <div class="table-scroll">
          <table><thead><tr>
            <th>DOCENTE</th><th>DEDICACIÓN</th><th>MATERIA</th><th>Paralelo</th><th>DIA</th><th>HORA</th><th>ASIGNADOS</th><th>CAP</th>
          </tr></thead><tbody id="tblCargaBody"></tbody></table>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="resumen-materia">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Resumen por Materia</h3>
        <span class="filter-chip" id="materiasCount">0</span>
      </div>
      <div class="table-container">
        <div class="table-scroll">
          <table><thead><tr>
            <th>MATERIA</th><th>Paralelo</th><th>ASIGNADOS</th><th>CAP</th><th>OCUPACION</th>
          </tr></thead><tbody id="tblResMatBody"></tbody></table>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="no-asignados">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">No Asignados</h3>
        <span class="filter-chip" id="noAsignadosCount">0</span>
      </div>
      <div class="table-container">
        <div class="table-scroll">
          <table><thead><tr>
            <th>ESTUDIANTE</th><th>MATERIA</th><th>CICLO</th><th>MOTIVO</th>
          </tr></thead><tbody id="tblNoBody"></tbody></table>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ===== Modal edición día/hora ===== -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h3>Modificar asignación</h3>
    <p id="modalInfo" style="color:#475569;font-size:13px"></p>
    <div class="grid">
      <div>
        <label for="editDia" class="config-label">Día</label>
        <select id="editDia" class="config-input"></select>
      </div>
      <div>
        <label for="editHora" class="config-label">Hora</label>
        <select id="editHora" class="config-input"></select>
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-secondary" id="btnCancel">Cancelar</button>
      <button class="btn btn-primary" id="btnSave">Guardar</button>
    </div>
  </div>
</div>

<script>
/* ========================== CONSTANTES ORIGINALES + EXTENSIONES ========================== */
let __DOCENTE_SLOTS__ = new Map(); // Map<Docente, Map<DIA, Set<HORA>>>
const TARGET7 = ["NOMBRE_DOCENTE","MATERIA","CANTIDAD DE ALUMNOS ESPERADOS","DIA","HORA","Modalidad","Paralelo"];
const COMBO9  = [...TARGET7,"DEDICACIÓN","ESTUDIANTE","CICLO"];

const DAY_MAP = new Map(Object.entries({
  "lun":"LUNES","lunes":"LUNES","lun.":"LUNES",
  "mar":"MARTES","martes":"MARTES","mar.":"MARTES",
  "mie":"MIERCOLES","mié":"MIERCOLES","miercoles":"MIERCOLES","miércoles":"MIERCOLES","mie.":"MIERCOLES","mié.":"MIERCOLES",
  "jue":"JUEVES","jueves":"JUEVES","jue.":"JUEVES",
  "vie":"VIERNES","viernes":"VIERNES","vie.":"VIERNES",
  "sab":"SABADO","sáb":"SABADO","sabado":"SABADO","sábado":"SABADO","sab.":"SABADO"
}));

const HORARIOS = ["07:00-10:00", "10:00-13:00", "13:00-16:00","16:00-19:00", "19:00-22:00"];
const DIAS = ["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES","SABADO"];

const __norm = s => String(s ?? "").toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
const __splitList = s => String(s ?? "").split(/[,;/]| Y | E /i).map(x=>x.trim()).filter(Boolean);
const esc = s => (s==null?"":String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));
const val = s => (s === null || s === undefined || s === "") ? "0" : s;

function canonDay(s){ const t=String(s||"").toLowerCase().trim(); return DAY_MAP.get(t)||String(s||"").toUpperCase(); }
function normalizarHorario(horario){
  if (!horario) return null;
  const raw = String(horario).toUpperCase().trim();
  if (HORARIOS.includes(raw)) return raw;
  const re = /(\d{1,2})(?::(\d{2}))?\s*(?:-|–|—|A|AL|A LAS|A LOS|TO)\s*(\d{1,2})(?::(\d{2}))?/i;
  const m = raw.match(re);
  if (!m) return null;
  const hIni = m[1].padStart(2,'0');
  const mIni = (m[2] ?? '00').padStart(2,'0');
  const start = `${hIni}:${mIni}`;
  const bloque = HORARIOS.find(b => b.startsWith(start));
  return bloque || null;
}

/* ========================== ALERTAS & PROGRESO ========================== */
const showError=(t)=>{ const b=document.getElementById('errorBox'); document.getElementById('errorMessage').textContent=t; b.style.display='block'; setTimeout(()=>b.style.display='none',7000);};
const showOk=(t)=>{ const b=document.getElementById('okBox'); document.getElementById('okMessage').textContent=t; b.style.display='block'; setTimeout(()=>b.style.display='none',4000);};
const updateProgress=p=>{const c=document.getElementById('progressContainer'); const b=document.getElementById('progressBar'); c.style.display='block'; b.style.width=p+'%'; if(p>=100) setTimeout(()=>c.style.display='none',900);};

/* ========================== LECTURA DE ARCHIVOS ========================== */
const readSheet=(file,name)=>new Promise((resolve,reject)=>{
  if(!file){ resolve([]); return; }
  const fr=new FileReader();
  fr.onload=e=>{ try{
    const data=new Uint8Array(e.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const json=XLSX.utils.sheet_to_json(ws,{defval:""});
    resolve(json||[]);
  }catch(err){ reject(new Error(`Error al leer ${name}: ${err.message}`)); } };
  fr.onerror=()=>reject(new Error(`Error al leer ${name}`));
  fr.readAsArrayBuffer(file);
});

/* ========================== NORMALIZACIONES ORIGINALES (conservadas) ========================== */
function normalizeDocentes(rows){
  return (rows||[]).map(r=>{
    let dias=[];
    const td=String(r["DIA DISPONIBLE"]||r["DIA"]||"").toUpperCase();
    if(td.includes("LUNES A VIERNES")) ["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES"].forEach(d=>dias.push(d));
    DIAS.forEach(d=>{ if(td.includes(d)) dias.push(d); });
    let horas=[];
    const th=String(r["HORA DISPONIBLE"]||r["HORA"]||"").toUpperCase();
    const rangos=th.match(/\d{1,2}(?::\d{2})?\s*(?:-|–|—|a|A|AL|A LAS|A LOS|TO)\s*\d{1,2}(?::\d{2})?/gi)||[];
    if(rangos.length){ horas=Array.from(new Set(rangos.map(normalizarHorario).filter(Boolean))); }
    else if(/\b07:00\b.*\b22:00\b/i.test(th) || /\b7\b.*\b22\b/.test(th)){ horas=[...HORARIOS]; }
    return {
      "NOMBRE_DOCENTE": r["NOMBRE_DOCENTE"] || r["DOCENTE"] || "",
      "MATERIA": r["MATERIA"] || r["MATERIAS"] || "",
      "CANTIDAD DE ALUMNOS ESPERADOS": Number(r["CANTIDAD DE ALUMNOS ESPERADOS"] || r["CAPACIDAD"] || r["CUPOS"] || 25) || 25,
      "DIA_DISPONIBLE": Array.from(new Set(dias)),
      "HORA_DISPONIBLE": Array.from(new Set(horas)),
      "Modalidad": r["Modalidad"] || r["MODALIDAD"] || "PRESENCIAL",
      "Paralelo": String(r["Paralelo"] || r["PARALELO"] || "").toUpperCase().trim() || "A",
      "DEDICACIÓN": r["DEDICACIÓN"] || r["DEDICACION"] || r["DEDICACION "] || ""
    };
  }).filter(x=>x.MATERIA && x.NOMBRE_DOCENTE);
}
function normalizeEstudiantes(rows){
  return (rows||[]).map(r=>{
    const ciclo=Number(r["CICLO AL QUE VA"]||r["CICLO ACTUAL"]||r["CICLO"]||1);
    return {
      "ESTUDIANTE": r["ESTUDIANTE"] || r["NOMBRE"] || r["NOMBRE DEL ESTUDIANTE"] || "",
      "CICLO": isNaN(ciclo) ? 1 : Math.max(1, Math.min(12, ciclo)),
      "CARRERA": r["CARRERA"] || r["CARRERA DEL ESTUDIANTE"] || "",
      "MALLA": r["MALLA"] || "",
      "NIVEL INGLES": r["NIVEL INGLES"] || ""
    };
  }).filter(x=>x.ESTUDIANTE && Number(x.CICLO)!==9);
}
function normalizeMallas(rows){
  const WORD2NUM={"PRIMERO":1,"SEGUNDO":2,"TERCERO":3,"CUARTO":4,"QUINTO":5,"SEXTO":6,"SEPTIMO":7,"SÉPTIMO":7,"OCTAVO":8,"NOVENO":9,"DECIMO":10,"DÉCIMO":10,"ONCE":11,"DOCE":12};
  const toCycle=v=>{ if(v==null||v==="") return NaN; const t=String(v).toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(); if(/^\d+$/.test(t)) return Number(t); return WORD2NUM[t]||NaN; };
  return (rows||[]).map(r=>{
    const materia=r["MATERIA"]||r["MATERIAS"]||"";
    const codigo=r["CÓDIGO"]||r["CODIGO"]||r["CÓDIGO ANTHOLOGY"]||"";
    let ciclo=toCycle(r["CICLO"]); if(isNaN(ciclo)) ciclo=Number(r["CICLO"]||1);
    return {
      "CARRERA": r["CARRERA"] || "",
      "MATERIA": materia,
      "CODIGO": String(codigo).trim(),
      "CICLO": Math.max(1, Math.min(12, Number(ciclo)||1)),
      "HORAS TEÓRICAS": Number(r["HORAS TEÓRICAS"] || 0) || 0,
      "HORAS PRÁCTICAS": Number(r["HORAS PRÁCTICAS"] || 0) || 0,
      "HORAS AUTÓNOMAS": Number(r["HORAS AUTÓNOMAS"] || 0) || 0,
      "CREDITOS": Number(r["CREDITOS"] || 0) || 0,
      "CAMPO DE FORMACIÓN": r["CAMPO DE FORMACIÓN"] || "",
      "MALLA": r["MALLA"] || "",
      "Nº ORDEN EN LA MALLA": r["Nº ORDEN EN LA MALLA"] || 0,
      "PRE-REQUISITO": r["PRE-REQUISITO"] || "",
      "CARRERAS QUE COMPARTEN": r["CARRERAS QUE COMPARTEN"] || r["CARRERAS_COMPARTEN"] || ""
    };
  }).filter(x=>x.MATERIA);
}

/* === Bloqueos opcionales (INGLÉS / PRÁCTICAS) === */
function normalizeBloqueos(rows){
  return (rows||[]).map(r=>({ESTUDIANTE:String(r["ESTUDIANTE"]||"").trim(), DIA:canonDay(r["DIA"]||""), HORA:normalizarHorario(r["HORA"]||"")}))
                   .filter(x=>x.ESTUDIANTE && x.DIA && x.HORA);
}
let BLOQUEOS=new Map(); // Map<est, Set("DIA|HORA")>
function addBloqueos(list){ BLOQUEOS.clear(); for(const r of list){ const s=BLOQUEOS.get(r.ESTUDIANTE)||new Set(); s.add(r.DIA+"|"+r.HORA); BLOQUEOS.set(r.ESTUDIANTE,s); }}

/* ========================== SECCIONES SIN CHOQUES ENTRE CICLOS ADYACENTES ========================== */
let __DOC_DAY_COUNT__=new Map();
const getDocDayCount=(doc,dia)=>(__DOC_DAY_COUNT__.get(doc)?.get(dia))||0;
const incDocDayCount=(doc,dia)=>{const m=__DOC_DAY_COUNT__.get(doc)||new Map(); m.set(dia,(m.get(dia)||0)+1); __DOC_DAY_COUNT__.set(doc,m); };

function construirSecciones(docentes,mallas,estudiantes){
  __DOCENTE_SLOTS__=new Map(); __DOC_DAY_COUNT__=new Map();
  const secciones=[];
  const usoPorCiclo=new Map(); for(let c=1;c<=12;c++) usoPorCiclo.set(c,new Map());
  const capacidadPorParalelo=parseInt(document.getElementById('capacidadParalelo').value)||25;

  const metaMap=new Map();
  for(const m of mallas){
    const k=`${m.CICLO}¦${m.MATERIA}`;
    const o=metaMap.get(k)||{CODIGOS:new Set(),CARRERAS:new Set(),MALLAS:new Set(),"HORAS TEÓRICAS":0,"HORAS PRÁCTICAS":0,"HORAS AUTÓNOMAS":0,CREDITOS:0,"CAMPO DE FORMACIÓN":m["CAMPO DE FORMACIÓN"]||"","Nº ORDEN EN LA MALLA":m["Nº ORDEN EN LA MALLA"]||0,"PRE-REQUISITO":m["PRE-REQUISITO"]||""};
    if(m.CODIGO) o.CODIGOS.add(String(m.CODIGO));
    if(m.CARRERA) o.CARRERAS.add(__norm(m.CARRERA));
    __splitList(m["CARRERAS QUE COMPARTEN"]).forEach(c=>o.CARRERAS.add(__norm(c)));
    if(m.MALLA) o.MALLAS.add(String(m.MALLA));
    o["HORAS TEÓRICAS"]=Math.max(o["HORAS TEÓRICAS"],Number(m["HORAS TEÓRICAS"]||0));
    o["HORAS PRÁCTICAS"]=Math.max(o["HORAS PRÁCTICAS"],Number(m["HORAS PRÁCTICAS"]||0));
    o["HORAS AUTÓNOMAS"]=Math.max(o["HORAS AUTÓNOMAS"],Number(m["HORAS AUTÓNOMAS"]||0));
    o.CREDITOS=Math.max(o.CREDITOS,Number(m.CREDITOS||0));
    metaMap.set(k,o);
  }

  function libreEnCicloYAdyacentes(c,d,h){
    const chk=(cy)=>{ const m=usoPorCiclo.get(cy)||new Map(); const set=m.get(d)||new Set(); return !set.has(h); };
    return chk(c)&&chk(c-1)&&chk(c+1);
  }
  function marcar(c,d,h){ [c,c-1,c+1].forEach(cy=>{ const m=usoPorCiclo.get(cy); if(!m) return; const set=m.get(d)||new Set(); set.add(h); m.set(d,set);}); }

  const seccionesPorDoc=new Map();
  for(const m of mallas){
    const ciclo=m.CICLO;
    const docentesMateria=docentes.filter(d=>__norm(d.MATERIA)===__norm(m.MATERIA));
    if(!docentesMateria.length) continue;

    docentesMateria.sort((a,b)=>(seccionesPorDoc.get(a.NOMBRE_DOCENTE)||0)-(seccionesPorDoc.get(b.NOMBRE_DOCENTE)||0));
    let elegido=null, slot=null;
    for(const cand of docentesMateria){
      const slots=__DOCENTE_SLOTS__.get(cand.NOMBRE_DOCENTE)||new Map();
      for(const dia of cand.DIA_DISPONIBLE){
        if(getDocDayCount(cand.NOMBRE_DOCENTE,dia)>=2) continue;
        const set=slots.get(dia)||new Set();
        for(const hora of cand.HORA_DISPONIBLE){
          if(set.has(hora)) continue;
          if(!libreEnCicloYAdyacentes(ciclo,dia,hora)) continue; // << regla ciclos adyacentes
          elegido=cand; slot={dia,hora}; break;
        }
        if(slot) break;
      }
      if(slot) break;
    }
    if(!slot) continue;

    marcar(ciclo,slot.dia,slot.hora);
    const slots=__DOCENTE_SLOTS__.get(elegido.NOMBRE_DOCENTE)||new Map();
    const sset=slots.get(slot.dia)||new Set(); sset.add(slot.hora); slots.set(slot.dia,sset); __DOCENTE_SLOTS__.set(elegido.NOMBRE_DOCENTE,slots); incDocDayCount(elegido.NOMBRE_DOCENTE,slot.dia);

    const info=metaMap.get(`${ciclo}¦${m.MATERIA}`)||{};
    const codStr=Array.from(info.CODIGOS||[]).join('/')||String(m.CODIGO||"0");
    const carStr=Array.from(info.CARRERAS||[]).join('/')||String(m["CARRERAS QUE COMPARTEN"]||"0");
    const mallaStr=Array.from(info.MALLAS||[]).join('/')||String(m.MALLA||"0");

    secciones.push({
      MATERIA:m.MATERIA, CODIGO:codStr, "CÓDIGO ANTHOLOGY":codStr, CICLO:ciclo,
      NOMBRE_DOCENTE:elegido.NOMBRE_DOCENTE, CAP:capacidadPorParalelo, ASIGNADOS:0,
      DIA:slot.dia, HORA:slot.hora, Modalidad:elegido.Modalidad, Paralelo:"A", DEDICACIÓN:elegido.DEDICACIÓN||"",
      "HORAS TEÓRICAS":info["HORAS TEÓRICAS"]||0,"HORAS PRÁCTICAS":info["HORAS PRÁCTICAS"]||0,"HORAS AUTÓNOMAS":info["HORAS AUTÓNOMAS"]||0,
      CREDITOS:info.CREDITOS||0,"CAMPO DE FORMACIÓN":info["CAMPO DE FORMACIÓN"]||"0", MALLA:mallaStr, "Nº ORDEN EN LA MALLA":info["Nº ORDEN EN LA MALLA"]||0,"PRE-REQUISITO":info["PRE-REQUISITO"]||"0","CARRERAS QUE COMPARTEN":carStr
    });
    seccionesPorDoc.set(elegido.NOMBRE_DOCENTE,(seccionesPorDoc.get(elegido.NOMBRE_DOCENTE)||0)+1);
  }
  return secciones;
}

/* ========================== ASIGNACIÓN RESPETANDO CARRERA Y BLOQUEOS ========================== */
function materiasPorCicloYCarrera(mallas){
  const map=new Map(); // ciclo -> (carrera -> Set materias)
  for(const m of mallas){
    const base=(map.get(m.CICLO)||new Map()); map.set(m.CICLO,base);
    const carreras = new Set([__norm(m.CARRERA), ...__splitList(m["CARRERAS QUE COMPARTEN"]).map(__norm)]);
    for(const car of carreras){ if(!car) continue; const set=base.get(car)||new Set(); set.add(m.MATERIA); base.set(car,set); }
  }
  return map;
}
function asignarEstudiantes(secciones,estudiantes,mallas){
  const idx=new Map(); for(const s of secciones){ const k=`${s.CICLO}¦${s.MATERIA}`; const arr=idx.get(k)||[]; arr.push(s); idx.set(k,arr); }
  const porCicloCarr=materiasPorCicloYCarrera(mallas);

  const asignaciones=[], noAsig=[];
  const maxMaterias=parseInt(document.getElementById('maxMaterias').value)||6;

  const estDay=new Map(), estSlots=new Map();
  const canPlace=(e,d,h)=>{ const bl=BLOQUEOS.get(e)||new Set(); if(bl.has(d+"|"+h)) return false; const cnt=estDay.get(e)?.get(d)||0; const s=estSlots.get(e)||new Set(); return cnt<2 && !s.has(`${d}|${h}`); };
  const mark=(e,d,h)=>{ const m=estDay.get(e)||new Map(); m.set(d,(m.get(d)||0)+1); estDay.set(e,m); const s=estSlots.get(e)||new Set(); s.add(`${d}|${h}`); estSlots.set(e,s); };

  for(const e of estudiantes){
    const carrera=__norm(e.CARRERA);
    const mats=Array.from((porCicloCarr.get(e.CICLO)||new Map()).get(carrera)||[]);
    let count=0; const ya=new Set();
    for(const mat of mats){
      if(count>=maxMaterias) break;
      if(ya.has(mat)) continue;
      const k=`${e.CICLO}¦${mat}`;
      const bucket=(idx.get(k)||[]).slice().sort((a,b)=>((b.CAP-b.ASIGNADOS)-(a.CAP-a.ASIGNADOS)));
      let placed=false;
      for(const s of bucket){
        if((s.CAP-s.ASIGNADOS)<=0) continue;
        if(!canPlace(e.ESTUDIANTE,s.DIA,s.HORA)) continue;
        s.ASIGNADOS++; count++; ya.add(mat); mark(e.ESTUDIANTE,s.DIA,s.HORA);
        asignaciones.push({
          ESTUDIANTE:e.ESTUDIANTE,CICLO:e.CICLO,"CARRERA DEL ESTUDIANTE":e.CARRERA,
          NOMBRE_DOCENTE:s.NOMBRE_DOCENTE,MATERIA:s.MATERIA,"CANTIDAD DE ALUMNOS ESPERADOS":s.CAP,
          DIA:s.DIA,HORA:s.HORA,Modalidad:s.Modalidad,Paralelo:s.Paralelo,
          "CÓDIGO ANTHOLOGY":s.CODIGO||"0","CARRERAS QUE COMPARTEN":s["CARRERAS QUE COMPARTEN"]||"0","PRE-REQUISITO":s["PRE-REQUISITO"]||"0",
          CODIGO:s.CODIGO||"0","HORAS TEÓRICAS":s["HORAS TEÓRICAS"]||0,"HORAS PRÁCTICAS":s["HORAS PRÁCTICAS"]||0,"HORAS AUTÓNOMAS":s["HORAS AUTÓNOMAS"]||0,
          CREDITOS:s.CREDITOS||0,"CAMPO DE FORMACIÓN":s["CAMPO DE FORMACIÓN"]||"0",MALLA:s.MALLA||"0","Nº ORDEN EN LA MALLA":s["Nº ORDEN EN LA MALLA"]||0,
          "Nro. HORAS":(s["HORAS TEÓRICAS"]||0)+(s["HORAS PRÁCTICAS"]||0)
        });
        placed=true; break;
      }
      if(!placed){
        noAsig.push({ESTUDIANTE:e.ESTUDIANTE,MATERIA:mat,CICLO:e.CICLO,MOTIVO:"Sin cupo/horario compatible","CARRERA DEL ESTUDIANTE":e.CARRERA});
      }
    }
  }
  return {asignaciones,noAsig};
}

/* ========================== RENDER TABLAS (original) ========================== */
function renderTable(el, headers, rows, maxRows = 100) {
  if (!rows || !rows.length) {
    el.innerHTML = '<tr><td colspan="'+headers.length+'" style="text-align:center;color:#94a3b8;padding:22px">Sin datos</td></tr>';
    return;
  }
  const displayRows = rows.slice(0, maxRows);
  el.innerHTML = displayRows.map(r => `<tr>${headers.map(h => `<td>${esc(val(r[h]))}</td>`).join('')}</tr>`).join('');
}

/* ========================== UI: pestañas, filtros, edición ========================== */
const tabs=document.querySelectorAll('.tab'); const contents=document.querySelectorAll('.tab-content');
tabs.forEach(t=>t.onclick=()=>{ tabs.forEach(x=>x.classList.remove('active')); contents.forEach(x=>x.classList.remove('active')); t.classList.add('active'); document.getElementById(t.dataset.tab).classList.add('active'); });

function installCareerFilter(careers){
  const sel=document.getElementById('careerFilter');
  sel.innerHTML='<option value="__ALL__">Todas las carreras</option>'+Array.from(new Set(careers.filter(Boolean))).sort().map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('');
  document.getElementById('careerFilterBar').style.display='grid';
  document.getElementById('careerActive').textContent='Sin filtro';
}
let GLOBAL_ASIGNACIONES=[];
function applyCareerFilterUI(){
  const v=document.getElementById('careerFilter').value;
  const q=(document.getElementById('quickSearch').value||"").trim().toLowerCase();
  let filtered=(v==="__ALL__")?GLOBAL_ASIGNACIONES.slice():GLOBAL_ASIGNACIONES.filter(a => (String(a["CARRERA DEL ESTUDIANTE"]||"").toUpperCase() === v.toUpperCase()));
  if(q){ filtered = filtered.filter(a => [a.ESTUDIANTE,a.MATERIA,a.NOMBRE_DOCENTE,a.Paralelo,a.DIA,a.HORA].map(x=>String(x||"").toLowerCase()).some(x=>x.includes(q))); }
  document.getElementById('asignacionesCount').textContent = filtered.length;
  document.getElementById('careerActive').textContent = (v==="__ALL__" && !q) ? "Sin filtro" : `Carrera: ${v}${q?` • búsqueda: “${q}”`:""}`;
  // pintar cuerpo
  const tb=document.getElementById('asigBody');
  tb.innerHTML = filtered.map((r,i)=>`
    <tr>
      <td><button class="btn btn-secondary btnEdit" data-id="${r.__id}">Editar</button></td>
      ${[ "NOMBRE_DOCENTE","MATERIA","CANTIDAD DE ALUMNOS ESPERADOS","DIA","HORA","Modalidad","Paralelo","ESTUDIANTE","CICLO" ].map(h=>`<td>${esc(val(r[h]))}</td>`).join('')}
    </tr>`).join('');
  tb.querySelectorAll('.btnEdit').forEach(b=>b.onclick=openEditModal);
}
document.getElementById('careerFilter').onchange=applyCareerFilterUI;
let __deb; document.getElementById('quickSearch').oninput=()=>{clearTimeout(__deb); __deb=setTimeout(applyCareerFilterUI,180);};
document.getElementById('clearFilters').onclick=()=>{ document.getElementById('careerFilter').value="__ALL__"; document.getElementById('quickSearch').value=""; applyCareerFilterUI(); };

/* ===== Modal edición ===== */
let EDIT_IDX=-1;
function openEditModal(ev){
  const gid=Number(ev.currentTarget.dataset.id);
  EDIT_IDX = GLOBAL_ASIGNACIONES.findIndex(x=>x.__id===gid);
  const r=GLOBAL_ASIGNACIONES[EDIT_IDX]; if(!r) return;
  document.getElementById('modalInfo').textContent = `${r.ESTUDIANTE} • ${r.MATERIA} • ${r.NOMBRE_DOCENTE}`;
  const dSel=document.getElementById('editDia'), hSel=document.getElementById('editHora');
  dSel.innerHTML = DIAS.map(d=>`<option value="${d}" ${d===r.DIA?"selected":""}>${d}</option>`).join('');
  hSel.innerHTML = HORARIOS.map(h=>`<option value="${h}" ${h===r.HORA?"selected":""}>${h}</option>`).join('');
  document.getElementById('modalBg').style.display='flex';
}
document.getElementById('btnCancel').onclick=()=>document.getElementById('modalBg').style.display='none';
document.getElementById('btnSave').onclick=()=>{
  if(EDIT_IDX<0) return;
  const d=document.getElementById('editDia').value, h=document.getElementById('editHora').value;
  const row=GLOBAL_ASIGNACIONES[EDIT_IDX];
  // valida bloqueos y duplicidad del propio estudiante
  const bl=BLOQUEOS.get(row.ESTUDIANTE)||new Set();
  if(bl.has(d+"|"+h)){ showError("El estudiante tiene bloqueo (Inglés/Prácticas) en ese horario."); return; }
  const choque = GLOBAL_ASIGNACIONES.some((x,i)=>i!==EDIT_IDX && x.ESTUDIANTE===row.ESTUDIANTE && x.DIA===d && x.HORA===h);
  if(choque){ showError("El estudiante ya tiene otra materia en ese día/hora."); return; }
  row.DIA=d; row.HORA=h;
  document.getElementById('modalBg').style.display='none';
  applyCareerFilterUI();
  showOk("Asignación actualizada.");
};

/* ========================== MÉTRICAS Y DESCARGA ========================== */
function updateStats(secciones, asignaciones, noAsig, resumenMateria) {
  document.getElementById('statsContainer').style.display = 'grid';
  document.getElementById('statSecciones').textContent = secciones.length;
  document.getElementById('statAsignaciones').textContent = asignaciones.length;
  document.getElementById('statNoAsignados').textContent = noAsig.length;
  document.getElementById('asignacionesCount').textContent = asignaciones.length;
  document.getElementById('docentesCount').textContent = new Set(asignaciones.map(a => a.NOMBRE_DOCENTE)).size;
  document.getElementById('materiasCount').textContent = new Set(asignaciones.map(a => a.MATERIA)).size;
  document.getElementById('noAsignadosCount').textContent = noAsig.length;
  let totalCap=0,totalAsig=0; resumenMateria.forEach(m=>{totalCap+=m.CAP||0; totalAsig+=m.ASIGNADOS||0;});
  document.getElementById('statOcupacion').textContent = totalCap? Math.round((totalAsig/totalCap)*100)+'%' : '0%';
}
let OUT_SECC=[], OUT_COMB=[], OUT_CARGA=[], OUT_RES_MAT=[], OUT_NO=[], OUT_PLAN_DOC=[], OUT_PROY=[];
document.getElementById('btnDown').onclick=()=>{
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_SECC), 'MATRIZ_SECCIONES');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_COMB), 'COMBINACION');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_CARGA), 'RESUMEN_CARGA');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_RES_MAT), 'RESUMEN_MATERIA');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_NO), 'NO_ASIGNADOS');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_PLAN_DOC), 'PLANIFICACION_DOCENTES');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(OUT_PROY), 'PROYECCION_POR_MATERIA');
  XLSX.writeFile(wb, 'Planificacion_Asignacion_Docente.xlsx');
  showOk("Archivo exportado.");
};

/* ========================== FILE UI ========================== */
function bindFile(inputId,dotId,nameId,optional=false){
  const f=document.getElementById(inputId), dot=document.getElementById(dotId), name=document.getElementById(nameId);
  f.addEventListener('change',()=>{ if(f.files?.length){ dot.classList.add('status-success'); name.textContent=f.files[0].name; } else { dot.classList.remove('status-success'); name.textContent=optional?'No cargado':'Esperando archivo...'; } validateFiles(); });
}
function validateFiles(){
  const ok = document.getElementById('fileDoc').files.length && document.getElementById('fileEst').files.length && document.getElementById('fileMal').files.length;
  document.getElementById('btnRun').disabled = !ok;
}
bindFile('fileDoc','dotDoc','nameDoc'); bindFile('fileEst','dotEst','nameEst'); bindFile('fileMal','dotMal','nameMal');
bindFile('fileIng','dotIng','nameIng',true); bindFile('filePra','dotPra','namePra',true);

/* ========================== RUN ========================== */
document.getElementById('btnRun').onclick=async()=>{
  try{
    updateProgress(10);
    const [rowsD,rowsE,rowsM,rowsI,rowsP] = await Promise.all([
      readSheet(document.getElementById('fileDoc').files[0], 'DOCENTES'),
      readSheet(document.getElementById('fileEst').files[0], 'ESTUDIANTES'),
      readSheet(document.getElementById('fileMal').files[0], 'MALLA'),
      readSheet(document.getElementById('fileIng').files[0], 'INGLÉS'),
      readSheet(document.getElementById('filePra').files[0], 'PRÁCTICAS')
    ]);
    updateProgress(40);
    const DOC = normalizeDocentes(rowsD);
    const EST = normalizeEstudiantes(rowsE);
    const MAL = normalizeMallas(rowsM);
    const BLOQ = [...normalizeBloqueos(rowsI), ...normalizeBloqueos(rowsP)];
    addBloqueos(BLOQ);
    if(!(DOC.length&&EST.length&&MAL.length)){ showError("Datos insuficientes o vacíos."); return; }
    updateProgress(60);
    const secciones = construirSecciones(DOC,MAL,EST);
    updateProgress(80);
    const {asignaciones,noAsig} = asignarEstudiantes(secciones,EST,MAL);

    // salidas
    OUT_SECC = secciones.map(s=>({
      "NOMBRE_DOCENTE": s.NOMBRE_DOCENTE, "DEDICACIÓN": s.DEDICACIÓN||"0",
      "MATERIA": s.MATERIA, "CANTIDAD DE ALUMNOS ESPERADOS": s.CAP,
      "DIA": s.DIA, "HORA": s.HORA, "Modalidad": s.Modalidad, "Paralelo": s.Paralelo
    }));
    OUT_COMB = asignaciones.map(a=>({
      "NOMBRE_DOCENTE": a.NOMBRE_DOCENTE, "DEDICACIÓN": a.DEDICACIÓN||"0",
      "MATERIA": a.MATERIA, "CANTIDAD DE ALUMNOS ESPERADOS": a["CANTIDAD DE ALUMNOS ESPERADOS"],
      "DIA": a.DIA, "HORA": a.HORA, "Modalidad": a.Modalidad, "Paralelo": a.Paralelo,
      "ESTUDIANTE": a.ESTUDIANTE, "CICLO": a.CICLO, "CARRERA DEL ESTUDIANTE": a["CARRERA DEL ESTUDIANTE"]
    }));
    OUT_NO = noAsig;

    OUT_CARGA = secciones.map(s=>({DOCENTE:s.NOMBRE_DOCENTE, "DEDICACIÓN":s.DEDICACIÓN||"0", MATERIA:s.MATERIA, Paralelo:s.Paralelo, DIA:s.DIA, HORA:s.HORA, ASIGNADOS:s.ASIGNADOS, CAP:s.CAP}));
    const rm=new Map(); for(const s of secciones){ const k=`${s.MATERIA}¦${s.Paralelo}`; const o=rm.get(k)||{MATERIA:s.MATERIA,Paralelo:s.Paralelo,ASIGNADOS:0,CAP:0}; o.ASIGNADOS+=s.ASIGNADOS; o.CAP+=s.CAP; rm.set(k,o); }
    OUT_RES_MAT = Array.from(rm.values()).map(r=>({...r,OCUPACION:r.CAP?Math.round(r.ASIGNADOS/r.CAP*100)+'%':'0%'}));

    OUT_PLAN_DOC = asignaciones.map(a=>({
      "DOCENTE": a.NOMBRE_DOCENTE,"DEDICACIÓN": a.DEDICACIÓN||"0","MATERIA": a.MATERIA,"CÓDIGO ANTHOLOGY": a["CÓDIGO ANTHOLOGY"]||a.CODIGO||"0",
      "CARRERAS QUE COMPARTEN": a["CARRERAS QUE COMPARTEN"]||"0","PRE-REQUISITO": a["PRE-REQUISITO"]||"0","CODIGO": a.CODIGO||"0",
      "HORAS TEÓRICAS": a["HORAS TEÓRICAS"]||0,"HORAS PRÁCTICAS": a["HORAS PRÁCTICAS"]||0,"HORAS AUTÓNOMAS": a["HORAS AUTÓNOMAS"]||0,
      "CREDITOS": a.CREDITOS||0,"CAMPO DE FORMACIÓN": a["CAMPO DE FORMACIÓN"]||"0","CICLO": a.CICLO||0,"MALLA": a.MALLA||"0",
      "Nº ORDEN EN LA MALLA": a["Nº ORDEN EN LA MALLA"]||0,"PARALELO": a.Paralelo||"0","DIA": a.DIA||"0","HORA": a.HORA||"0",
      "Modalidad": a.Modalidad||"0","Nro. HORAS": a["Nro. HORAS"]||0,"NOMBRE DEL ESTUDIANTE": a.ESTUDIANTE||"0",
      "CARRERA DEL ESTUDIANTE": a["CARRERA DEL ESTUDIANTE"]||"0","CICLO DEL ESTUDIANTE": a["CICLO DEL ESTUDIANTE"]||a.CICLO||0,
      "NIVEL INGLES": a["NIVEL INGLES"]||"0","OBSERVACIONES": a.OBSERVACIONES||"0"
    }));
    const mp=new Map(), idxCap=new Map();
    for(const s of secciones){ const k=`${s.MATERIA}¦${s.CICLO}`; const o=idxCap.get(k)||{PAR:0,CAP:0,DOC:new Set()}; o.PAR++; o.CAP+=s.CAP; o.DOC.add(s.NOMBRE_DOCENTE); idxCap.set(k,o); }
    for(const a of OUT_PLAN_DOC){ const k=`${a.MATERIA}¦${a.CICLO}`; const o=mp.get(k)||{MATERIA:a.MATERIA,CICLO:a.CICLO,TOTAL:0,CARR:new Map()}; o.TOTAL++; o.CARR.set(a["CARRERA DEL ESTUDIANTE"],(o.CARR.get(a["CARRERA DEL ESTUDIANTE"])||0)+1); mp.set(k,o); }
    OUT_PROY = Array.from(mp.values()).map(o=>{ const k=`${o.MATERIA}¦${o.CICLO}`; const z=idxCap.get(k)||{PAR:0,CAP:0,DOC:new Set()}; return {"MATERIA":o.MATERIA,"CICLO":o.CICLO,"TOTAL ESTUDIANTES":o.TOTAL,"PARALELOS":z.PAR,"CAPACIDAD TOTAL":z.CAP,"DOCENTES":Array.from(z.DOC).join(" / "),"DETALLE POR CARRERA":Array.from(o.CARR.entries()).map(([c,n])=>`${c}: ${n}`).join(" / ")}; });

    // pintar tablas secundarias
    renderTable(document.getElementById('tblCargaBody'),["DOCENTE","DEDICACIÓN","MATERIA","Paralelo","DIA","HORA","ASIGNADOS","CAP"],OUT_CARGA,200);
    document.getElementById('docentesCount').textContent = new Set(OUT_CARGA.map(x=>x.DOCENTE)).size;
    renderTable(document.getElementById('tblResMatBody'),["MATERIA","Paralelo","ASIGNADOS","CAP","OCUPACION"],OUT_RES_MAT,200);
    renderTable(document.getElementById('tblNoBody'),["ESTUDIANTE","MATERIA","CICLO","MOTIVO"],OUT_NO,200);

    // métricas y filtros
    updateStats(OUT_SECC,OUT_COMB,OUT_NO,OUT_RES_MAT);
    GLOBAL_ASIGNACIONES = OUT_COMB.map((r,i)=>({...r,__id:i}));
    const careers = Array.from(new Set(GLOBAL_ASIGNACIONES.map(a=>a["CARRERA DEL ESTUDIANTE"]).filter(Boolean)));
    installCareerFilter(careers); applyCareerFilterUI();

    document.getElementById('btnDown').disabled=false;
    updateProgress(100); showOk("Procesamiento completado.");
  }catch(e){ showError(e.message); }
};
</script>
</body>
</html>
