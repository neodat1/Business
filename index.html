<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Matriz Académica UIDE – Integrador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Librerías Excel (SIN defer para que XLSX esté disponible antes del script principal) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{ --azul:#04136C; --mostaza:#DE912E; --vino:#862B39; --celeste:#9CBEE3; --verde:#8A9520; }
    body{ background:#f6f7fb; }
    .brand-bar{ background:linear-gradient(90deg,var(--azul),var(--vino)); }
    .btn{ background:var(--azul); color:#fff; }
    .btn:hover{ background:#020b45; }
    .card{ border:1px solid #e5e7eb; box-shadow:0 6px 20px rgba(0,0,0,.06); }
    th{ background:var(--celeste); color:#0b1a3c; position:sticky; top:0; z-index:1; }
    .pill{ background:var(--mostaza); color:#111827; }
    .accent-left{ border-left:8px solid var(--azul); }
    .small{ font-size:12px; line-height:16px; }
    .badge{ background:var(--verde); color:#fff; }
    .spinner{ border:3px solid #e5e7eb; border-top:3px solid var(--azul); border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg);} }
  </style>
</head>
<body class="min-h-screen">
  <!-- Encabezado -->
  <header class="brand-bar text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center gap-4">
      <img src="UIDE-Ecuador.png" alt="UIDE" class="h-10 w-auto rounded bg-white p-1" />
      <div>
        <h1 class="text-xl font-semibold tracking-wide">Integrador de Mallas / Docentes / Restricciones</h1>
        <p class="text-white/80 small">Lee los Excel, genera la matriz y propone horarios sin choques.</p>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
    <div id="status" class="hidden rounded-lg px-4 py-3 bg-red-50 text-red-700 border border-red-200"></div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="card bg-white rounded-2xl p-5 accent-left">
        <h2 class="font-semibold text-slate-800 mb-3">1) Cargar archivos</h2>
        <label class="block small text-slate-600">Malla (0. Mallas.xlsx)</label>
        <input type="file" id="fileMalla" accept=".xlsx,.xls" class="w-full border rounded-lg p-2 mb-3" />
        <label class="block small text-slate-600">Docentes (1. Docentes.xlsx)</label>
        <input type="file" id="fileDocentes" accept=".xlsx,.xls" class="w-full border rounded-lg p-2 mb-3" />
        <label class="block small text-slate-600">Restricciones (2. Restricciones.xlsx)</label>
        <input type="file" id="fileRestricciones" accept=".xlsx,.xls" class="w-full border rounded-lg p-2 mb-4" />
        <button id="btnProcesar" class="btn rounded-lg px-4 py-2 flex items-center gap-2">
          <span id="spin" class="spinner hidden"></span>
          Procesar y generar matriz
        </button>
        <p class="small text-slate-500 mt-3">Colores:
          <span class="inline-block rounded px-2 py-0.5" style="background:var(--azul);color:#fff;">Azul</span>
          <span class="inline-block rounded px-2 py-0.5" style="background:var(--mostaza);">Mostaza</span>
          <span class="inline-block rounded px-2 py-0.5" style="background:var(--vino);color:#fff;">Vino</span>
          <span class="inline-block rounded px-2 py-0.5" style="background:var(--celeste);">Celeste</span>
          <span class="inline-block rounded px-2 py-0.5" style="background:var(--verde);color:#fff;">Verde</span>
        </p>
      </section>

      <section class="card bg-white rounded-2xl p-5 accent-left">
        <h2 class="font-semibold text-slate-800 mb-3">2) Parámetros</h2>
        <ul class="space-y-2 small text-slate-700">
          <li><span class="pill rounded px-2 py-0.5">Franjas L–V</span> 07:00–10:00, 10:00–13:00, 13:00–16:00, 16:00–19:00, 19:00–22:00</li>
          <li><span class="pill rounded px-2 py-0.5">Regla</span> Máx. 2 asignaturas por día</li>
          <li><span class="pill rounded px-2 py-0.5">Regla</span> Evitar choques entre ciclos contiguos (1↔2, 2↔3, … 7↔8)</li>
          <li><span class="pill rounded px-2 py-0.5">Regla</span> Respetar restricciones (día/hora)</li>
          <li><span class="pill rounded px-2 py-0.5">Regla</span> Eliminar materias con 0 estudiantes</li>
        </ul>
        <div class="grid grid-cols-1 gap-3 mt-4">
          <div>
            <label class="block small text-slate-600">Hoja de Malla</label>
            <input id="sheetMalla" class="w-full border rounded-lg p-2" value="Malla" />
          </div>
          <div>
            <label class="block small text-slate-600">Hoja de Docentes</label>
            <input id="sheetDoc" class="w-full border rounded-lg p-2" value="Docentes" />
          </div>
          <div>
            <label class="block small text-slate-600">Hoja de Restricciones</label>
            <input id="sheetRes" class="w-full border rounded-lg p-2" value="Restricciones" />
          </div>
        </div>
      </section>

      <section class="card bg-white rounded-2xl p-5 accent-left">
        <h2 class="font-semibold text-slate-800 mb-3">3) Exportar</h2>
        <button id="btnExportXLSX" class="btn rounded-lg px-4 py-2">Descargar XLSX</button>
        <p class="small text-slate-600 mt-2">Exportación exclusiva a Excel (CSV eliminado).</p>
      </section>
    </div>

    <section class="card bg-white rounded-2xl p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold text-slate-800">Matriz generada</h2>
        <span id="badgeResumen" class="badge rounded px-3 py-1 small hidden"></span>
      </div>
      <div class="overflow-auto max-h-[60vh] border rounded-lg">
        <table id="tabla" class="min-w-full border-collapse">
          <thead>
            <tr>
              <th class="p-2">DOCENTE</th>
              <th class="p-2">TITULO ACADÉMICO</th>
              <th class="p-2">DEDICACIÓN</th>
              <th class="p-2">MATERIA</th>
              <th class="p-2">CÓDIGO ANTHOLOGY</th>
              <th class="p-2">CARRERAS QUE COMPARTEN</th>
              <th class="p-2">MALLA</th>
              <th class="p-2">PRE-REQUISITO</th>
              <th class="p-2">CODIGO</th>
              <th class="p-2">HORAS TEÓRICAS</th>
              <th class="p-2">HORAS PRÁCTICAS</th>
              <th class="p-2">HORAS AUTÓNOMAS</th>
              <th class="p-2">CREDITOS</th>
              <th class="p-2">CAMPO DE FORMACIÓN</th>
              <th class="p-2">CICLO MALLA</th>
              <th class="p-2">Nº ORDEN EN LA MALLA</th>
              <th class="p-2">ESTUDIANTES</th>
              <th class="p-2">PARALELO</th>
              <th class="p-2">DIA</th>
              <th class="p-2">HORA</th>
              <th class="p-2">MODALIDAD</th>
              <th class="p-2">Nro. HORAS</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- SCRIPT PRINCIPAL (se ejecuta cuando XLSX ya está cargado) -->
  <script>
    // Helpers UI
    const $ = s => document.querySelector(s);
    const showError = msg => { const el = $('#status'); el.textContent = msg; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'), 6000); };
    const startBusy = () => { $('#btnProcesar').disabled = true; $('#spin').classList.remove('hidden'); };
    const stopBusy  = () => { $('#btnProcesar').disabled = false; $('#spin').classList.add('hidden'); };

    // Normalización
    const unorm = s => (s==null? "" : String(s)).normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toLowerCase();

    // Sinónimos
    const MALLA_KEYS = {
      carrera:['carrera','programa','escuela'],
      malla:['malla','plan','plan de estudios'],
      ciclo:['ciclo','semestre','nivel','periodo'],
      materia:['materia','asignatura','unidad curricular','curso'],
      codigo:['codigo','código','cod','id','clave','codigo anthology'],
      ht:['ht','horas teoricas','horas t'],
      hp:['hp','horas practicas','horas p','laboratorio','horas lab'],
      ha:['ha','horas autonomas','horas autoestudio'],
      creditos:['creditos','créditos','cr','ects'],
      prerreq:['prerrequisito','prerrequisitos','pre requisito','pre-requisito'],
      campo:['campo de formacion','area formacion','campo'],
      cicloOrden:['n° orden en la malla','numero orden','orden malla','n orden'],
      estudiantes:['estudiantes','n estudiantes','matriculados'],
      paralelo:['paralelo','grupo','seccion'],
      modalidad:['modalidad','tipo modalidad','presencial/virtual']
    };
    const DOC_KEYS = {
      docente:['docente','nombre','profesor','apellidos y nombres','nombres y apellidos'],
      titulo:['titulo academico','titulo','grado academico'],
      dedicacion:['dedicacion','tipo dedicacion','jornada','contrato'],
      modalidad:['modalidad','tipo modalidad','presencial/virtual']
    };
    const RES_KEYS = { docente:['docente','profesor','nombre'], dia:['dia','día','day'], hora:['hora','horario','time'] };

    function pick(row, list, def=""){
      for(const k of list){ for(const c in row){ if(unorm(c)===unorm(k)) return row[c]; } }
      for(const k of list){ for(const c in row){ if(unorm(c).includes(unorm(k))) return row[c]; } }
      return def;
    }

    // Lectura XLSX
    async function readXLSX(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = e=>{
          try{
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            resolve(wb);
          }catch(err){ reject(err); }
        };
        fr.onerror = reject;
        fr.readAsArrayBuffer(file);
      });
    }
    function sheetToJSON(wb, name){ const use = (name && wb.Sheets[name]) ? name : wb.SheetNames[0]; return XLSX.utils.sheet_to_json(wb.Sheets[use], {defval:""}); }

    // Parámetros horarios
    const DIAS = ['Lunes','Martes','Miércoles','Jueves','Viernes'];
    const SLOTS = ['07:00–10:00','10:00–13:00','13:00–16:00','16:00–19:00','19:00–22:00'];
    const ADY = {'PRIMERO':['SEGUNDO'],'SEGUNDO':['PRIMERO','TERCERO'],'TERCERO':['SEGUNDO','CUARTO'],'CUARTO':['TERCERO','QUINTO'],'QUINTO':['CUARTO','SEXTO'],'SEXTO':['QUINTO','SÉPTIMO','SEPTIMO'],'SÉPTIMO':['SEXTO','OCTAVO'],'SEPTIMO':['SEXTO','OCTAVO'],'OCTAVO':['SÉPTIMO','SEPTIMO']};

    let MATRIZ = [];

    $('#btnProcesar').addEventListener('click', async ()=>{
      try{
        if(typeof XLSX === 'undefined'){ showError('La librería XLSX no cargó. Verifique su conexión.'); return; }
        $('#badgeResumen').classList.add('hidden'); startBusy();

        const fM = $('#fileMalla').files[0]; if(!fM){ stopBusy(); showError('Cargue el archivo de Malla.'); return; }
        const fD = $('#fileDocentes').files[0] || null, fR = $('#fileRestricciones').files[0] || null;
        const shM = $('#sheetMalla').value.trim(), shD = $('#sheetDoc').value.trim(), shR = $('#sheetRes').value.trim();

        const wbM = await readXLSX(fM);
        const wbD = fD ? await readXLSX(fD) : null;
        const wbR = fR ? await readXLSX(fR) : null;

        const rowsM = sheetToJSON(wbM, shM); if(!rowsM.length){ throw new Error('La hoja de Malla está vacía o el nombre no coincide.'); }

        const mCanon = rowsM.map(r=>{ const c = {...r}; const o={}; for(const k in MALLA_KEYS){ o[k]=pick(c,MALLA_KEYS[k]); } return o; })
                             .map(r=>{ for(const k in r){ if(typeof r[k]==='string') r[k]=r[k].trim(); } return r; });

        const mFiltrada = mCanon.filter(r=>{ const v=(r.estudiantes??"").toString().trim(); if(v==="") return true; const n=Number(v.replace(',','.')); return !(Number.isFinite(n)&&n===0); });
        mFiltrada.forEach(r=>{ const ht=Number((r.ht??"").toString().replace(',','.'))||0, hp=Number((r.hp??"").toString().replace(',','.'))||0, ha=Number((r.ha??"").toString().replace(',','.'))||0; r.horas_totales=ht+hp+ha; r.slots_req=Math.max(1, Math.round((r.horas_totales||0)/3)); });

        let docRows=[]; if(wbD){ const rowsD = sheetToJSON(wbD, shD); docRows = rowsD.map(r=>({docente:pick(r,DOC_KEYS.docente),titulo:pick(r,DOC_KEYS.titulo),dedicacion:pick(r,DOC_KEYS.dedicacion),modalidad:pick(r,DOC_KEYS.modalidad)})).filter(x=>(x.docente||"").trim()!==""); }

        let resByDoc={}; if(wbR){ sheetToJSON(wbR, shR).forEach(r=>{ const d=(pick(r,RES_KEYS.docente)||"").toString().trim(); if(!d) return; const dia=(pick(r,RES_KEYS.dia)||"").toString().trim(); const hora=(pick(r,RES_KEYS.hora)||"").toString().trim(); (resByDoc[d] ||= []).push({dia,hora}); }); }

        const gKey = r => `${unorm(r.materia)}|${unorm(r.codigo)}`;
        const groups = new Map();
        mFiltrada.forEach(r=>{
          const k=gKey(r);
          if(!groups.has(k)){ groups.set(k,{materia:r.materia,codigoAnth:r.codigo,carreras:new Set(),mallas:new Set(),prer:new Set(),campos:[],ciclos:[],codCarr:[],htCarr:[],hpCarr:[],haCarr:[],crCarr:[],ordCarr:[],estudiantes:r.estudiantes||"",paralelo:r.paralelo||"",modalidad:r.modalidad||"",regs:[]}); }
          const g=groups.get(k);
          g.carreras.add(r.carrera||""); g.mallas.add(r.malla||""); g.prer.add(r.prerreq||""); g.campos.push(r.campo||""); g.ciclos.push(r.ciclo||"");
          g.codCarr.push(`${r.carrera||""}:${r.codigo||""}`); g.htCarr.push(`${r.carrera||""}:${r.ht||""}`); g.hpCarr.push(`${r.carrera||""}:${r.hp||""}`);
          g.haCarr.push(`${r.carrera||""}:${r.ha||""}`); g.crCarr.push(`${r.carrera||""}:${r.creditos||""}`); g.ordCarr.push(`${r.carrera||""}:${r.cicloOrden||""}`);
          g.regs.push(r);
        });

        const findDoc = g => ({docente:"", titulo:"", dedicacion:"", modalidad:g.modalidad||""});

        const ocup={}, cnt={}, asign=new Map();
        const bloqueado=(doc,dia,slot)=>{ if(!doc||!resByDoc[doc]) return false; const s=SLOTS[slot]; return resByDoc[doc].some(x=>{ const okD=x.dia? unorm(x.dia)===unorm(dia):true; const okH=x.hora? unorm(x.hora)===unorm(s):true; return okD&&okH; }); };
        const vecinos=c=> ADY[(c||"").toString().toUpperCase()] || [];
        const puede=(ciclo,doc,dia,slot)=>{ const s=SLOTS[slot]; (ocup[dia]??={}); (ocup[dia][s]??={}); (cnt[dia]??={}); cnt[dia][ciclo]=cnt[dia][ciclo]||0; if(cnt[dia][ciclo]>=2) return false; for(const v of vecinos(ciclo)){ if(ocup[dia][s][v]) return false; } if(bloqueado(doc,dia,slot)) return false; return true; };
        const marcar=(ciclo,dia,slot)=>{ const s=SLOTS[slot]; (ocup[dia]??={}); (ocup[dia][s]??={}); ocup[dia][s][ciclo]=true; (cnt[dia]??={}); cnt[dia][ciclo]=(cnt[dia][ciclo]||0)+1; };

        for(const [k,g] of groups.entries()){
          const d=findDoc(g); const ciclo=(g.ciclos[0]||"").toString().trim().toUpperCase(); const need=Math.max(1,g.regs[0]?.slots_req||1);
          const arr=[]; outer: for(let t=0;t<need;t++){ for(const dia of DIAS){ for(let s=0;s<SLOTS.length;s++){ if(puede(ciclo,d.docente,dia,s)){ marcar(ciclo,dia,s); arr.push({dia,hora:SLOTS[s]}); continue outer; } } } break; }
          asign.set(k, arr);
        }

        MATRIZ=[];
        for(const [k,g] of groups.entries()){
          const d=findDoc(g);
          const carreras=[...g.carreras].filter(Boolean).join(' / '), mallas=[...g.mallas].filter(Boolean).join(' / '), prer=[...g.prer].filter(Boolean).join(' / ');
          const campos=g.campos.filter(Boolean).join(' / '), ciclos=g.ciclos.filter(Boolean).join(' / ');
          const codCarr=g.codCarr.filter(Boolean).join(' / '), htCarr=g.htCarr.filter(Boolean).join(' / '), hpCarr=g.hpCarr.filter(Boolean).join(' / ');
          const haCarr=g.haCarr.filter(Boolean).join(' / '), crCarr=g.crCarr.filter(Boolean).join(' / '), ordCarr=g.ordCarr.filter(Boolean).join(' / ');
          const slots = asign.get(k) || [{dia:"",hora:""}];
          for(const sl of slots){
            MATRIZ.push({"DOCENTE":d.docente,"TITULO ACADÉMICO":d.titulo,"DEDICACIÓN":d.dedicacion,"MATERIA":g.materia||"","CÓDIGO ANTHOLOGY":g.codigoAnth||"","CARRERAS QUE COMPARTEN":carreras,"MALLA":mallas,"PRE-REQUISITO":prer,"CODIGO":codCarr,"HORAS TEÓRICAS":htCarr,"HORAS PRÁCTICAS":hpCarr,"HORAS AUTÓNOMAS":haCarr,"CREDITOS":crCarr,"CAMPO DE FORMACIÓN":campos,"CICLO MALLA":ciclos,"Nº ORDEN EN LA MALLA":ordCarr,"ESTUDIANTES":g.estudiantes||"","PARALELO":g.paralelo||"","DIA":sl.dia||"","HORA":sl.hora||"","MODALIDAD":d.modalidad||g.modalidad||"","Nro. HORAS":""});
          }
        }
        MATRIZ.sort((a,b)=> unorm(a["CICLO MALLA"]).localeCompare(unorm(b["CICLO MALLA"])) || unorm(a["MATERIA"]).localeCompare(unorm(b["MATERIA"])));
        render(MATRIZ); stopBusy();
      }catch(e){ stopBusy(); showError(e.message||String(e)); console.error(e); }
    });

    function render(rows){
      const tbody = $('#tbody'); tbody.innerHTML="";
      const cols = ["DOCENTE","TITULO ACADÉMICO","DEDICACIÓN","MATERIA","CÓDIGO ANTHOLOGY","CARRERAS QUE COMPARTEN","MALLA","PRE-REQUISITO","CODIGO","HORAS TEÓRICAS","HORAS PRÁCTICAS","HORAS AUTÓNOMAS","CREDITOS","CAMPO DE FORMACIÓN","CICLO MALLA","Nº ORDEN EN LA MALLA","ESTUDIANTES","PARALELO","DIA","HORA","MODALIDAD","Nro. HORAS"];
      rows.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.className=i%2? "bg-slate-50":"bg-white"; cols.forEach(c=>{ const td=document.createElement('td'); td.className="p-2 border-b border-slate-200 align-top text-[13px]"; td.textContent=r[c]??""; tr.appendChild(td); }); tbody.appendChild(tr); });
      const badge = $('#badgeResumen'); badge.textContent = `${rows.length} fila(s)`; badge.classList.remove('hidden');
    }

    // Exportar XLSX
    $('#btnExportXLSX').addEventListener('click', ()=>{
      if(!MATRIZ.length){ showError('Genere la matriz antes de exportar.'); return; }
      const ws = XLSX.utils.json_to_sheet(MATRIZ);
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Matriz');
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      saveAs(new Blob([wbout], {type:'application/octet-stream'}), 'Matriz_UIDE.xlsx');
    });
  </script>
</body>
</html>
