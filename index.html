<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matriz de Planificación Académica – UIDE</title>

<!-- Librería para leer Excel en el navegador -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --azul:#04136C; --mostaza:#DE912E; --vino:#862B39; --celeste:#9CBEE3; --verde:#8A9520;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; background:#f7f9fc; color:#111}
  header{display:flex; align-items:center; gap:16px; padding:14px 16px; background:linear-gradient(135deg,var(--azul),#000a3d); color:#fff}
  header img{height:48px; width:auto}
  header h1{font-size:18px; margin:0; line-height:1.2}
  .wrapper{max-width:1200px; margin:18px auto; padding:0 14px}
  .card{background:#fff; border:1px solid #e6e9f2; border-radius:14px; padding:14px; box-shadow:0 2px 10px rgba(4,19,108,.06); margin-bottom:14px}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  label{font-size:12px; font-weight:700; color:#10205f; display:block; margin-bottom:6px}
  input[type="file"]{width:100%; padding:10px; border:1px solid #e2e6f0; border-radius:10px; background:#fbfcff}
  button{border:0; padding:10px 14px; border-radius:12px; font-weight:800; letter-spacing:.2px; cursor:pointer}
  .primary{background:var(--mostaza); color:#1b1200}
  .danger{background:var(--vino); color:#fff}
  .muted{background:#fff; color:var(--azul); border:2px solid var(--azul)}
  .hint{font-size:12px; color:#333}
  .errors{margin:0; padding-left:18px}
  table{width:100%; border-collapse:separate; border-spacing:0; font-size:13px}
  thead th{
    position:sticky; top:0; background:#fff; border-bottom:2px solid var(--celeste);
    padding:10px 8px; text-align:left; color:#06114a; z-index:2
  }
  tbody td{border-bottom:1px solid #eef2f8; padding:8px; vertical-align:top}
  tbody tr:nth-child(odd){background:#fbfdff}
  .scroll{overflow:auto; max-height:68vh; border:1px solid #e6e9f2; border-radius:10px}
  .pill{display:inline-block; padding:2px 8px; background:#eef2ff; color:#0c1a5a; border-radius:999px; font-size:12px; font-weight:800}
  .brandbar{height:4px; background:linear-gradient(90deg,var(--azul) 25%,var(--mostaza) 25% 40%,var(--vino) 40% 60%,var(--celeste) 60% 80%,var(--verde) 80%)}
</style>
</head>
<body>
<header>
  <!-- Debe existir el archivo en la misma carpeta -->
  <img src="UIDE-Ecuador.png" alt="UIDE Ecuador">
  <h1>Matriz de Planificación Académica – UIDE</h1>
</header>
<div class="brandbar"></div>

<div class="wrapper">
  <div class="card">
    <div class="row">
      <div>
        <label>Archivo de Malla <span class="pill">Hoja: Malla</span></label>
        <input id="fileMalla" type="file" accept=".xlsx,.xls" />
        <div class="hint">Columnas esperadas (nombres típicos): CARRERA, MALLA, CICLO, MATERIA, CÓDIGO, CAMPO DE FORMACIÓN, HORAS TEÓRICAS, HORAS PRÁCTICAS, HORAS AUTÓNOMAS, CRÉDITOS, (NÚMERO|NUMERO|Nº) DE ORDEN EN LA MALLA, (PRERREQUISITO|PRE-REQUISITO).</div>
      </div>
      <div>
        <label>Archivo de Docentes <span class="pill">Hoja: Docentes</span></label>
        <input id="fileDocentes" type="file" accept=".xlsx,.xls" />
        <div class="hint">Columnas esperadas: DOCENTE, TITULO ACADÉMICO, DEDICACION, MATERIA, DÍA/DIA DISPONIBLE, HORA DISPONIBLE, Modalidad.</div>
      </div>
    </div>
    <div style="display:flex; gap:10px; margin-top:12px">
      <button id="btnProcesar" class="primary">Procesar y llenar matriz</button>
      <button id="btnLimpiar" class="muted">Limpiar</button>
    </div>
  </div>

  <div id="panelErrores" class="card" style="display:none">
    <strong style="color:#5a0d14">Observaciones / Conflictos de asignación</strong>
    <ul id="errores" class="errors"></ul>
  </div>

  <div class="card">
    <div class="scroll">
      <table id="matriz">
        <thead>
          <tr>
            <th>DOCENTE</th>
            <th>TITULO ACADÉMICO</th>
            <th>DEDICACIÓN</th>
            <th>MATERIA</th>
            <th>CÓDIGO ANTHOLOGY</th>
            <th>CARRERAS QUE COMPARTEN</th>
            <th>MALLA</th>
            <th>PRE-REQUISITO</th>
            <th>CODIGO</th>
            <th>HORAS TEÓRICAS</th>
            <th>HORAS PRÁCTICAS</th>
            <th>HORAS AUTÓNOMAS</th>
            <th>CREDITOS</th>
            <th>CAMPO DE FORMACIÓN</th>
            <th>CICLO MALLA</th>
            <th>Nº ORDEN EN LA MALLA</th>
            <th>PARALELO</th>
            <th>DIA</th>
            <th>HORA</th>
            <th>MODALIDAD</th>
            <th>Nro. HORAS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* =========================
   Utilidades y normalización
   ========================= */
const DIA_CANON = ['LUNES','MARTES','MIÉRCOLES','JUEVES','VIERNES'];
const SLOTS = ['07:00–10:00','10:00–13:00','13:00–16:00','16:00–19:00','19:00–22:00'];
const CYCLE_INDEX = {
  'PRIMERO':1,'SEGUNDO':2,'TERCERO':3,'CUARTO':4,'QUINTO':5,'SEXTO':6,
  'SÉPTIMO':7,'SEPTIMO':7,'OCTAVO':8,'NOVENO':9,'DÉCIMO':10,'DECIMO':10
};
const ABC = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');

const nz = v => (v===undefined || v===null) ? '' : v;
const norm = v => nz(v).toString().replace(/\s+/g,' ').trim();
const upper = v => norm(v).toUpperCase();

/* Detección robusta de columna, admitiendo variantes de nombre */
function pick(obj, keys){
  for(const k of keys){ if(Object.prototype.hasOwnProperty.call(obj,k) && obj[k] !== undefined) return obj[k]; }
  return "";
}

/* Días disponibles: soporta “LUNES A VIERNES”, “MIÉRCOLES Y JUEVES”, “VIERNES”, etc. */
function parseDiasDisponibles(txt){
  txt = upper(txt).normalize("NFD").replace(/[\u0300-\u036f]/g,""); // quitar tildes
  txt = txt.replace('MIERCOLES','MIERCOLES'); // ya sin tildes
  if(txt.includes('A VIERNES')) return [...DIA_CANON];
  if(txt.includes(' A ')){
    const [ini, fin] = txt.split(' A ').map(s=>s.trim());
    const startIdx = DIA_CANON.findIndex(d=>upper(d).normalize("NFD").replace(/[\u0300-\u036f]/g,"")==ini);
    const endIdx = DIA_CANON.findIndex(d=>upper(d).normalize("NFD").replace(/[\u0300-\u036f]/g,"")==fin);
    if(startIdx>=0 && endIdx>=0 && endIdx>=startIdx){
      return DIA_CANON.slice(startIdx, endIdx+1);
    }
  }
  if(txt.includes(' Y ')){
    return txt.split(' Y ').map(s=>s.trim()).map(s=> {
      const match = DIA_CANON.find(d=>upper(d).normalize("NFD").replace(/[\u0300-\u036f]/g,"")==s);
      return match || '';
    }).filter(Boolean);
  }
  const solo = DIA_CANON.find(d=>upper(d).normalize("NFD").replace(/[\u0300-\u036f]/g,"")==txt);
  return solo ? [solo] : [...DIA_CANON];
}

/* Horario disponible -> subconjunto de SLOTS (si rango contiene completamente un slot) */
function parseHoraDisponible(txt){
  txt = norm(txt);
  if(!txt) return [...SLOTS];
  const clean = txt.replace(/\s+/g,'').replace(/–/g,'-').toUpperCase().replace('A','-');
  const parts = clean.split('-').filter(Boolean);
  const toMin = hhmm => {
    const m = /^(\d{1,2}):(\d{2})$/.exec(hhmm);
    if(!m) return null;
    let h = parseInt(m[1],10), mm = parseInt(m[2],10);
    if(h<7) h+=12; // robustez básica (evitar 01:00 como madrugada)
    return h*60+mm;
  };
  if(parts.length===2){
    const a = toMin(parts[0]), b = toMin(parts[1]);
    if(a!=null && b!=null && b>a){
      return SLOTS.filter(s=>{
        const [sa,sb] = s.replace('–','-').split('-');
        const sma = toMin(sa), smb = toMin(sb);
        return sma>=a && smb<=b;
      });
    }
  }
  // si no se puede interpretar, habilitar todos los slots
  return [...SLOTS];
}

/* Índice de ciclo */
const cicloIdx = c => CYCLE_INDEX[upper(c)] ?? 99;

/* Join único con “ / ” */
const slashJoin = arr => Array.from(new Set(arr.map(x=>norm(x)).filter(Boolean))).join(' / ');

/* =========================
   Lectura de Excel (SheetJS)
   ========================= */
async function readWorkbook(file){
  const data = await file.arrayBuffer();
  return XLSX.read(data, {type:'array'});
}
function sheetToJSON(wb, name){
  const ws = wb.Sheets[name];
  if(!ws) return [];
  return XLSX.utils.sheet_to_json(ws, {defval:""});
}

/* =========================
   Render de filas a la tabla
   ========================= */
function clearTable(){
  document.querySelector('#matriz tbody').innerHTML = '';
}
function addRow(row){
  const tbody = document.querySelector('#matriz tbody');
  const tr = document.createElement('tr');
  const cols = [
    row.DOCENTE,
    row.TITULO_ACADEMICO,
    row.DEDICACION,
    row.MATERIA,
    row.CODIGO_ANTHOLOGY,
    row.CARRERAS_COMPARTEN,
    row.MALLA,
    row.PRE_REQUISITO,
    row.CODIGO,
    row.HORAS_TEORICAS,
    row.HORAS_PRACTICAS,
    row.HORAS_AUTONOMAS,
    row.CREDITOS,
    row.CAMPO_DE_FORMACION,
    row.CICLO_MALLA,
    row.N_ORDEN_MALLA,
    row.PARALELO,
    row.DIA,
    row.HORA,
    row.MODALIDAD,
    row.NRO_HORAS
  ];
  cols.forEach(v=>{
    const td = document.createElement('td');
    td.textContent = nz(v);
    tr.appendChild(td);
  });
  tbody.appendChild(tr);
}

/* =========================
   Lógica de combinación y asignación
   ========================= */
function buildMallaAggregate(mallaRows){
  // Agrega info por MATERIA (case/space-insensitive) y por CARRERA
  const agg = new Map(); // key materiaUpper -> objeto agregado
  for(const r of mallaRows){
    const materia = norm(pick(r,['MATERIA']));
    if(!materia) continue;
    const k = upper(materia);
    const carrera = norm(pick(r,['CARRERA']));
    if(!agg.has(k)){
      agg.set(k,{
        materia, carreras:new Set(), mallas:new Set(), prereqs:new Set(),
        codigos:new Map(), hteor:new Map(), hprac:new Map(), hauton:new Map(),
        creditos:new Map(), campo:new Map(), ciclo:new Map(), norden:new Map()
      });
    }
    const o = agg.get(k);
    o.carreras.add(carrera);
    const mallaTxt = pick(r, ['MALLA']);
    if(mallaTxt) o.mallas.add(norm(mallaTxt));

    const pre = pick(r,['PRE-REQUISITO','PRERREQUISITO','PRERREQUISITO(S)']);
    if(pre) o.prereqs.add(norm(pre));

    const codigo = pick(r,['CÓDIGO','CODIGO']);
    const hteor = pick(r,['HORAS TEÓRICAS','HORAS TEORICAS','H. TEÓRICAS']);
    const hprac = pick(r,['HORAS PRÁCTICAS','HORAS PRACTICAS','H. PRÁCTICAS']);
    const hauton= pick(r,['HORAS AUTÓNOMAS','HORAS AUTONOMAS','H. AUTÓNOMAS']);
    const credit= pick(r,['CRÉDITOS','CREDITOS']);
    const campo  = pick(r,['CAMPO DE FORMACIÓN','CAMPO','CAMPO FORMACION']);
    const ciclo  = pick(r,['CICLO']);
    const norden = pick(r,['Nº ORDEN EN LA MALLA','NUMERO DE ORDEN EN LA MALLA','NÚMERO DE ORDEN EN LA MALLA','N ORDEN EN LA MALLA']);

    if(carrera){
      if(codigo!=='') o.codigos.set(carrera, norm(codigo));
      if(hteor!=='')  o.hteor.set(carrera, norm(hteor));
      if(hprac!=='')  o.hprac.set(carrera, norm(hprac));
      if(hauton!=='') o.hauton.set(carrera, norm(hauton));
      if(credit!=='') o.creditos.set(carrera, norm(credit));
      if(campo!=='')  o.campo.set(carrera, norm(campo));
      if(ciclo!=='')  o.ciclo.set(carrera, norm(ciclo));
      if(norden!=='') o.norden.set(carrera, norm(norden));
    }
  }
  return agg;
}

function buildDocentesIndex(docRows){
  const idx = new Map(); // key materiaUpper -> lista de docentes
  for(const r of docRows){
    const materia = norm(pick(r,['MATERIA']));
    if(!materia) continue;
    const k = upper(materia);
    const docente = norm(pick(r,['DOCENTE']));
    const titulo = norm(pick(r,['TITULO ACADÉMICO','TÍTULO ACADÉMICO']));
    const dedic  = norm(pick(r,['DEDICACION','DEDICACIÓN']));
    const diaTxt = norm(pick(r,['DIA DISPONIBLE','DÍA DISPONIBLE','DIA']));
    const horaTxt= norm(pick(r,['HORA DISPONIBLE','HORA']));
    const modalidad = norm(pick(r,['Modalidad','MODALIDAD']));

    const dias = parseDiasDisponibles(diaTxt);
    const slots = parseHoraDisponible(horaTxt);

    const item = {DOCENTE:docente, TITULO:titulo, DEDIC:dedic, MATERIA:materia, DIAS:dias, SLOTS:slots, MODALIDAD:modalidad};
    if(!idx.has(k)) idx.set(k, []);
    idx.get(k).push(item);
  }
  return idx;
}

function slashByCarrera(map, carreras){
  return carreras.map(c=> map.get(c) ?? '').join(' / ');
}

function assembleRows(aggMalla, idxDocentes){
  const filas = [];
  for(const [matKey, info] of aggMalla.entries()){
    const docentes = idxDocentes.get(matKey) || [];
    if(docentes.length===0){
      addError(`Materia sin docente asignado en "Docentes": ${info.materia}`);
      continue; // combinación estricta entre ambas bases
    }
    // orden alfabético de carreras => referencia para campos separados por "/"
    const carrerasOrd = Array.from(info.carreras).sort((a,b)=>a.localeCompare(b,'es'));
    const ciclosList  = carrerasOrd.map(c=> info.ciclo.get(c) ?? '');
    const pack = mp => slashByCarrera(mp, carrerasOrd);

    const rowBase = {
      MATERIA: info.materia,
      CARRERAS_COMPARTEN: slashJoin(carrerasOrd),
      MALLA: slashJoin(Array.from(info.mallas)),
      PRE_REQUISITO: slashJoin(Array.from(info.prereqs)),
      CODIGO: pack(info.codigos),
      HORAS_TEORICAS: pack(info.hteor),
      HORAS_PRACTICAS: pack(info.hprac),
      HORAS_AUTONOMAS: pack(info.hauton),
      CREDITOS: pack(info.creditos),
      CAMPO_DE_FORMACION: pack(info.campo),
      CICLO_MALLA: pack(info.ciclo),
      N_ORDEN_MALLA: pack(info.norden),
      _meta:{carreras:carrerasOrd, ciclos:ciclosList}
    };

    // por cada docente de la materia, crear una fila (los paralelos se asignarán luego)
    docentes.forEach(d=>{
      filas.push({
        DOCENTE: d.DOCENTE,
        TITULO_ACADEMICO: d.TITULO,
        DEDICACION: d.DEDIC,
        MATERIA: rowBase.MATERIA,
        CODIGO_ANTHOLOGY: '',
        CARRERAS_COMPARTEN: rowBase.CARRERAS_COMPARTEN,
        MALLA: rowBase.MALLA,
        PRE_REQUISITO: rowBase.PRE_REQUISITO,
        CODIGO: rowBase.CODIGO,
        HORAS_TEORICAS: rowBase.HORAS_TEORICAS,
        HORAS_PRACTICAS: rowBase.HORAS_PRACTICAS,
        HORAS_AUTONOMAS: rowBase.HORAS_AUTONOMAS,
        CREDITOS: rowBase.CREDITOS,
        CAMPO_DE_FORMACION: rowBase.CAMPO_DE_FORMACION,
        CICLO_MALLA: rowBase.CICLO_MALLA,
        N_ORDEN_MALLA: rowBase.N_ORDEN_MALLA,
        PARALELO: '',
        DIA: '',
        HORA: '',
        MODALIDAD: d.MODALIDAD,
        NRO_HORAS: '',
        _doc:d,
        _meta:rowBase._meta
      });
    });
  }
  // Asignar paralelos por combinación (materia + carreras)
  const groups = new Map();
  filas.forEach((r, i)=>{
    const key = upper(r.MATERIA)+'|'+upper(r.CARRERAS_COMPARTEN);
    if(!groups.has(key)) groups.set(key, []);
    groups.get(key).push(i);
  });
  for(const [, idxs] of groups){
    idxs.forEach((rowIdx, j)=>{ filas[rowIdx].PARALELO = ABC[j] ?? `P${j+1}`; });
  }
  return filas;
}

/* =========================
   Asignación de horarios
   ========================= */
const ocupacionDocente = new Map(); // docente -> { dia -> {count, slots:Set} }
const ocupacionCarrera = new Map(); // carrera -> { "DIA SLOT" -> Set(cycleIndex) }

function resetOcupaciones(){
  ocupacionDocente.clear();
  ocupacionCarrera.clear();
}
function addError(msg){
  const panel = document.getElementById('panelErrores');
  const ul = document.getElementById('errores');
  const li = document.createElement('li');
  li.textContent = msg;
  ul.appendChild(li);
  panel.style.display = 'block';
}
function canPlace(row, dia, slot){
  const dname = row.DOCENTE;
  if(!ocupacionDocente.has(dname)) ocupacionDocente.set(dname, {});
  const dayRec = ocupacionDocente.get(dname)[dia] ?? {count:0, slots:new Set()};
  if(dayRec.count >= 2) return false;       // Máximo 2 asignaturas por día
  if(dayRec.slots.has(slot)) return false;  // Evitar doble uso mismo slot por docente

  const slotKey = `${dia} ${slot}`;
  const carreras = row._meta.carreras;
  const ciclos = row._meta.ciclos;

  for(let i=0;i<carreras.length;i++){
    const car = carreras[i];
    const cIdx = cicloIdx(ciclos[i]);
    if(!ocupacionCarrera.has(car)) ocupacionCarrera.set(car, new Map());
    const mapSlot = ocupacionCarrera.get(car);
    if(!mapSlot.has(slotKey)) mapSlot.set(slotKey, new Set());
    const usados = mapSlot.get(slotKey);
    // Evitar choque con ciclos adyacentes en la MISMA carrera
    for(const u of usados){
      if(Math.abs(u - cIdx) <= 1) return false;
    }
  }
  return true;
}
function place(row){
  const dias = row._doc.DIAS;
  const slots = row._doc.SLOTS;
  // Orden determinista: Lunes->Viernes, slots de menor a mayor
  for(const d of DIA_CANON.filter(x=>dias.includes(x))){
    for(const s of SLOTS.filter(x=>slots.includes(x))){
      if(canPlace(row, d, s)){
        // Aplicar ocupación
        const dname = row.DOCENTE;
        const dayRec = ocupacionDocente.get(dname)[d] ?? {count:0, slots:new Set()};
        dayRec.count += 1;
        dayRec.slots.add(s);
        ocupacionDocente.get(dname)[d] = dayRec;

        const slotKey = `${d} ${s}`;
        const carreras = row._meta.carreras;
        const ciclos = row._meta.ciclos;
        for(let i=0;i<carreras.length;i++){
          const car = carreras[i];
          const idx = cicloIdx(ciclos[i]);
          if(!ocupacionCarrera.has(car)) ocupacionCarrera.set(car, new Map());
          const mapSlot = ocupacionCarrera.get(car);
          if(!mapSlot.has(slotKey)) mapSlot.set(slotKey, new Set());
          mapSlot.get(slotKey).add(idx);
        }
        row.DIA = d;
        row.HORA = s;
        return true;
      }
    }
  }
  return false;
}

/* =========================
   Flujo principal
   ========================= */
document.getElementById('btnProcesar').addEventListener('click', async ()=>{
  const fMalla = document.getElementById('fileMalla').files[0];
  const fDoc   = document.getElementById('fileDocentes').files[0];
  if(!fMalla || !fDoc){ alert('Cargue ambos archivos (Malla y Docentes).'); return; }

  // Reset visual y estructuras
  clearTable();
  document.getElementById('panelErrores').style.display='none';
  document.getElementById('errores').innerHTML='';
  resetOcupaciones();

  // Leer workbooks
  const wbMalla = await readWorkbook(fMalla);
  const wbDoc   = await readWorkbook(fDoc);
  const mallaRows = sheetToJSON(wbMalla, 'Malla');
  const docRows   = sheetToJSON(wbDoc, 'Docentes');

  if(!mallaRows.length){ alert('La hoja "Malla" no existe o está vacía.'); return; }
  if(!docRows.length){ alert('La hoja "Docentes" no existe o está vacía.'); return; }

  // Agregados y combinaciones
  const aggMalla = buildMallaAggregate(mallaRows);
  const idxDoc   = buildDocentesIndex(docRows);
  let filas = assembleRows(aggMalla, idxDoc);

  // Ordenar por ciclo mínimo (para facilitar asignación sin choques entre ciclos vecinos)
  filas.sort((a,b)=>{
    const amin = Math.min(...a._meta.ciclos.map(c=>cicloIdx(c)));
    const bmin = Math.min(...b._meta.ciclos.map(c=>cicloIdx(c)));
    return amin - bmin;
  });

  // Asignación de horarios
  let sinAsignar = 0;
  for(const r of filas){
    const ok = place(r);
    if(!ok){
      sinAsignar++;
      addError(`No se pudo asignar un horario sin choques para: ${r.MATERIA} (${r.DOCENTE}). Verifique disponibilidad o reglas.`);
    }
  }

  // Render
  filas.forEach(addRow);
});

document.getElementById('btnLimpiar').addEventListener('click', ()=>{
  document.getElementById('fileMalla').value = '';
  document.getElementById('fileDocentes').value = '';
  clearTable();
  document.getElementById('panelErrores').style.display='none';
  document.getElementById('errores').innerHTML='';
  resetOcupaciones();
});
</script>
</body>
</html>
